# Comparing `tmp/skypilot_nightly-1.0.0.dev20240527.tar.gz` & `tmp/skypilot_nightly-1.0.0.dev20240529.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot_nightly-1.0.0.dev20240527.tar", last modified: Mon May 27 10:38:27 2024, max compression
+gzip compressed data, was "skypilot_nightly-1.0.0.dev20240529.tar", last modified: Wed May 29 10:38:50 2024, max compression
```

## Comparing `skypilot_nightly-1.0.0.dev20240527.tar` & `skypilot_nightly-1.0.0.dev20240529.tar`

### file list

```diff
@@ -1,339 +1,339 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.792321 skypilot_nightly-1.0.0.dev20240527/
--rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    18142 2024-05-27 10:38:27.792321 skypilot_nightly-1.0.0.dev20240527/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-27 10:38:27.796321 skypilot_nightly-1.0.0.dev20240527/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    12056 2024-05-27 10:38:24.000000 skypilot_nightly-1.0.0.dev20240527/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.736320 skypilot_nightly-1.0.0.dev20240527/sky/
--rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.736320 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     7594 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/common.py
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/adaptors/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.740320 skypilot_nightly-1.0.0.dev20240527/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (127)   125856 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   230791 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.740320 skypilot_nightly-1.0.0.dev20240527/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.740320 skypilot_nightly-1.0.0.dev20240527/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9079 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (127)   194320 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.744320 skypilot_nightly-1.0.0.dev20240527/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    44519 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    30929 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (127)    31840 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/cloud_registry.py
--rw-r--r--   0 runner    (1001) docker     (127)    12344 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)    12477 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    47944 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)    20969 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (127)    20272 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/kubernetes.py
--rw-r--r--   0 runner    (1001) docker     (127)    11991 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    25136 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (127)    10391 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/paperspace.py
--rw-r--r--   0 runner    (1001) docker     (127)    11000 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/runpod.py
--rw-r--r--   0 runner    (1001) docker     (127)    15383 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.744320 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (127)    12771 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/cudo_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.748320 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4240 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/paperspace_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/runpod_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/vsphere_catalog.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.748320 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/gcp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/oci_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/scp_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    11802 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/clouds/vsphere.py
--rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.748320 skypilot_nightly-1.0.0.dev20240527/sky/data/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/global_user_state.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.748320 skypilot_nightly-1.0.0.dev20240527/sky/jobs/
--rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    13367 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/
--rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/state.py
--rw-r--r--   0 runner    (1001) docker     (127)    33067 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/jobs/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    56668 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/provision/azure/
--rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/azure/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.752320 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/
--rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/cudo_machine_type.py
--rw-r--r--   0 runner    (1001) docker     (127)     4086 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/cudo_wrapper.py
--rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    17540 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/docker_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.756320 skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/
--rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/fluidstack_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.756320 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    22367 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/instance_setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.756320 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    28319 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    32724 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.756320 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/manifests/
--rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
--rw-r--r--   0 runner    (1001) docker     (127)    10561 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/network.py
--rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/network_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    62091 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/logging.py
--rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/metadata_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.756320 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/config.py
--rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/provisioner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.760320 skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.760320 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/
--rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.760320 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/cls_api_client.py
--rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/cls_api_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/custom_script.py
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/id_generator.py
--rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/metadata_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/service_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/service_manager_factory.py
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/ssl_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/vapiconnect.py
--rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/vim_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/instance.py
--rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/vsphere_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.764320 skypilot_nightly-1.0.0.dev20240527/sky/serve/
--rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/autoscalers.py
--rw-r--r--   0 runner    (1001) docker     (127)     4415 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/controller.py
--rw-r--r--   0 runner    (1001) docker     (127)    28710 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/core.py
--rw-r--r--   0 runner    (1001) docker     (127)    11548 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/load_balancer.py
--rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/load_balancing_policies.py
--rw-r--r--   0 runner    (1001) docker     (127)    57216 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/replica_managers.py
--rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/serve_state.py
--rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/serve_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/service.py
--rw-r--r--   0 runner    (1001) docker     (127)    14469 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/serve/service_spec.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.764320 skypilot_nightly-1.0.0.dev20240527/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12056 2024-05-27 10:38:24.000000 skypilot_nightly-1.0.0.dev20240527/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.764320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2136 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (127)    11256 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    12303 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/log_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/log_lib.pyi
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.764320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/command_runner.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.768320 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/skypilot_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (127)    47807 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.772320 skypilot_nightly-1.0.0.dev20240527/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     9099 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/cudo-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/fluidstack-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     6669 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1408 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/jobs-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ingress.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-r--r--   0 runner    (1001) docker     (127)    15489 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5738 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     7032 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/paperspace-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/runpod-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     5608 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     1429 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/sky-serve-controller.yaml.j2
--rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/templates/vsphere-ray.yml.j2
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.772320 skypilot_nightly-1.0.0.dev20240527/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (127)    17807 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.776320 skypilot_nightly-1.0.0.dev20240527/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.776320 skypilot_nightly-1.0.0.dev20240527/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/cluster_yaml_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    23235 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (127)     5492 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/command_runner.pyi
--rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    34616 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/controller_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/env_options.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.780321 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/create_cluster.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/delete_cluster.sh
--rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/generate_kind_config.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/generate_static_kubeconfig.sh
--rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/gpu_labeler.py
--rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes_enums.py
--rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/resources_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/rich_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)    23359 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.780321 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    18142 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2272 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-27 10:38:27.000000 skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-27 10:38:27.780321 skypilot_nightly-1.0.0.dev20240527/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_api.py
--rw-r--r--   0 runner    (1001) docker     (127)     3579 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (127)    17649 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_jobs_and_serve.py
--rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_serve_autoscaler.py
--rw-r--r--   0 runner    (1001) docker     (127)   220048 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_wheels.py
--rw-r--r--   0 runner    (1001) docker     (127)     4279 2024-05-27 10:38:22.000000 skypilot_nightly-1.0.0.dev20240527/tests/test_yaml_parser.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.219923 skypilot_nightly-1.0.0.dev20240529/
+-rw-r--r--   0 runner    (1001) docker     (127)    12170 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    18142 2024-05-29 10:38:50.219923 skypilot_nightly-1.0.0.dev20240529/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    12079 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      640 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-29 10:38:50.219923 skypilot_nightly-1.0.0.dev20240529/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    12056 2024-05-29 10:38:47.000000 skypilot_nightly-1.0.0.dev20240529/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.159922 skypilot_nightly-1.0.0.dev20240529/sky/
+-rw-r--r--   0 runner    (1001) docker     (127)     5588 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.163922 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6863 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2291 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7594 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2354 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)      468 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3097 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4906 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4109 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1480 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)      225 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2129 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/adaptors/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21408 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.163922 skypilot_nightly-1.0.0.dev20240529/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (127)      536 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5932 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)   125856 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   231003 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8358 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16741 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.163922 skypilot_nightly-1.0.0.dev20240529/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     3450 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7297 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.163922 skypilot_nightly-1.0.0.dev20240529/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8723 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26446 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9079 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (127)   200458 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11806 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.167923 skypilot_nightly-1.0.0.dev20240529/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (127)     1310 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44519 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30929 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)    31840 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)      955 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/cloud_registry.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12344 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12477 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47944 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20969 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20272 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/kubernetes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11991 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25136 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10391 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/paperspace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11000 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/runpod.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15383 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.171923 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (127)    14546 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12550 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7289 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26837 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1793 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      411 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4335 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.171923 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22424 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11477 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5072 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3895 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22243 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4297 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21462 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5038 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24120 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4472 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7856 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5082 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7542 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3768 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4184 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5174 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4391 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.171923 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6968 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9991 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4482 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15781 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11802 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/clouds/vsphere.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34233 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2529 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7346 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21664 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8351 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118872 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6867 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8249 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25107 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28681 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/global_user_state.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/jobs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1398 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1350 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26607 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13426 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (127)     3050 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (127)    15086 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     9837 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (127)    25556 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23041 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35652 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/jobs/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    56668 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.175922 skypilot_nightly-1.0.0.dev20240529/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (127)     5951 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.179923 skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22092 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36307 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3238 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.179923 skypilot_nightly-1.0.0.dev20240529/sky/provision/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)      146 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4028 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/azure/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9339 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.179923 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/
+-rw-r--r--   0 runner    (1001) docker     (127)      676 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      327 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      696 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4086 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8307 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17540 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/docker_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.179923 skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/
+-rw-r--r--   0 runner    (1001) docker     (127)      592 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8262 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14974 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.179923 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (127)      528 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32964 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7234 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24215 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    59069 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22367 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/instance_setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.183923 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)      653 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28319 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32724 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.183923 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 runner    (1001) docker     (127)      229 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     1939 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)    10851 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/network.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9384 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    62585 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2103 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/logging.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4013 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/metadata_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.183923 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1541 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      802 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12045 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9428 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25103 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/provisioner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.183923 skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      321 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7905 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4648 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.183923 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/
+-rw-r--r--   0 runner    (1001) docker     (127)      788 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.187923 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4167 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14096 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      481 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 runner    (1001) docker     (127)      914 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1817 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)      544 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2932 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17877 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      504 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24488 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/instance.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15151 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    65346 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.187923 skypilot_nightly-1.0.0.dev20240529/sky/serve/
+-rw-r--r--   0 runner    (1001) docker     (127)     1661 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30136 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/autoscalers.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4415 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8022 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/controller.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28710 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/core.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11548 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/load_balancer.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2331 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 runner    (1001) docker     (127)    57216 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/replica_managers.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18830 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/serve_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37183 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/serve_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10931 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/service.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14469 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/serve/service_spec.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.187923 skypilot_nightly-1.0.0.dev20240529/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (127)      718 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12056 2024-05-29 10:38:47.000000 skypilot_nightly-1.0.0.dev20240529/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4000 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (127)    12381 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2136 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4478 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1887 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11411 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12303 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35198 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18824 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/log_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4295 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4344 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (127)     6342 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19215 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16355 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (127)       94 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38280 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1292 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34630 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (127)      112 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13971 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.191923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20492 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17202 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.195923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (127)       91 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4683 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22411 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.195923 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (127)     2761 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      349 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      224 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      531 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      658 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)      565 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (127)     1153 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1348 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5734 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/skypilot_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1457 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (127)    47807 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.199923 skypilot_nightly-1.0.0.dev20240529/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (127)     7477 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     9099 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3435 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3465 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     8880 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     6669 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1554 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1095 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)      376 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2547 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (127)    15489 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     2747 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5738 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1185 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     7032 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3898 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3496 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     5608 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     1575 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 runner    (1001) docker     (127)     3474 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.199923 skypilot_nightly-1.0.0.dev20240529/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      590 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17807 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.203923 skypilot_nightly-1.0.0.dev20240529/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3798 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.203923 skypilot_nightly-1.0.0.dev20240529/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11032 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      849 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23317 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5492 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/command_runner.pyi
+-rw-r--r--   0 runner    (1001) docker     (127)    23848 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34620 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/controller_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5731 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2786 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/env_options.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.203923 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9759 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)      927 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     3187 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/generate_kind_config.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4422 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/generate_static_kubeconfig.sh
+-rw-r--r--   0 runner    (1001) docker     (127)     6960 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1186 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     3812 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 runner    (1001) docker     (127)     6560 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1384 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8139 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5540 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/resources_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/rich_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23359 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6509 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3936 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3264 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)      701 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.207923 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    18142 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9353 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2272 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        4 2024-05-29 10:38:50.000000 skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-29 10:38:50.207923 skypilot_nightly-1.0.0.dev20240529/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      171 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_api.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3579 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9592 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)      267 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8789 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17649 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_jobs_and_serve.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3718 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27759 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6996 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1102 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_serve_autoscaler.py
+-rw-r--r--   0 runner    (1001) docker     (127)   220340 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4048 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1070 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_wheels.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4279 2024-05-29 10:38:45.000000 skypilot_nightly-1.0.0.dev20240529/tests/test_yaml_parser.py
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/LICENSE` & `skypilot_nightly-1.0.0.dev20240529/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240529/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240529/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240527
+Version: 1.0.0.dev20240529
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/README.md` & `skypilot_nightly-1.0.0.dev20240529/README.md`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/pyproject.toml` & `skypilot_nightly-1.0.0.dev20240529/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/setup.py` & `skypilot_nightly-1.0.0.dev20240529/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """The SkyPilot package."""
 import os
 import subprocess
 from typing import Optional
 import urllib.request
 
 # Replaced with the current commit when building the wheels.
-_SKYPILOT_COMMIT_SHA = '90f8e89014a517dcd370081d62e5655f229a3325'
+_SKYPILOT_COMMIT_SHA = 'f377809ae120aa717c6c8684bba368811e12bb8a'
 
 
 def _get_git_commit():
     if 'SKYPILOT_COMMIT_SHA' not in _SKYPILOT_COMMIT_SHA:
         # This is a release build, so we don't need to get the commit hash from
         # git, as it's already been set.
         return _SKYPILOT_COMMIT_SHA
@@ -31,15 +31,15 @@
             commit_hash += '-dirty'
         return commit_hash
     except Exception:  # pylint: disable=broad-except
         return _SKYPILOT_COMMIT_SHA
 
 
 __commit__ = _get_git_commit()
-__version__ = '1.0.0.dev20240527'
+__version__ = '1.0.0.dev20240529'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 
 # ---------------------- Proxy Configuration ---------------------- #
 def _set_http_proxy_env_vars() -> None:
     urllib_proxies = dict(urllib.request.getproxies())
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/aws.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/azure.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/cloudflare.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/common.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/gcp.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/ibm.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/oci.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/adaptors/vsphere.py` & `skypilot_nightly-1.0.0.dev20240529/sky/adaptors/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/authentication.py` & `skypilot_nightly-1.0.0.dev20240529/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/backend.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/backend_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/backend_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/cloud_vm_ray_backend.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/cloud_vm_ray_backend.py`

 * *Files 0% similar despite different names*

```diff
@@ -3171,19 +3171,19 @@
                                           f'setup-{runner.node_id}.log')
             returncode = runner.run(
                 f'{create_script_code} && {setup_cmd}',
                 log_path=setup_log_path,
                 process_stream=False,
                 # We do not source bashrc for setup, since bashrc is sourced
                 # in the script already.
-                # Skip two lines due to the /bin/bash -i and source ~/.bashrc
-                # in the setup_cmd.
+                # Skip an empty line and two lines due to the /bin/bash -i and
+                # source ~/.bashrc in the setup_cmd.
                 #   bash: cannot set terminal process group (7398): Inappropriate ioctl for device # pylint: disable=line-too-long
                 #   bash: no job control in this shell
-                skip_lines=2,
+                skip_lines=3,
             )
 
             def error_message() -> str:
                 # Use the function to avoid tailing the file in success case
                 try:
                     last_10_lines = subprocess.run(
                         ['tail', '-n10',
@@ -3664,14 +3664,22 @@
         return dict(zip(job_ids, local_log_dirs))
 
     def tail_logs(self,
                   handle: CloudVmRayResourceHandle,
                   job_id: Optional[int],
                   managed_job_id: Optional[int] = None,
                   follow: bool = True) -> int:
+        """Tail the logs of a job.
+
+        Args:
+            handle: The handle to the cluster.
+            job_id: The job ID to tail the logs of.
+            managed_job_id: The managed job ID for display purpose only.
+            follow: Whether to follow the logs.
+        """
         code = job_lib.JobLibCodeGen.tail_logs(job_id,
                                                managed_job_id=managed_job_id,
                                                follow=follow)
         if job_id is None and managed_job_id is None:
             logger.info(
                 'Job ID not provided. Streaming the logs of the latest job.')
 
@@ -3698,23 +3706,20 @@
             returncode = e.code
         return returncode
 
     def tail_managed_job_logs(self,
                               handle: CloudVmRayResourceHandle,
                               job_id: Optional[int] = None,
                               job_name: Optional[str] = None,
+                              controller: bool = False,
                               follow: bool = True) -> None:
         # if job_name is not None, job_id should be None
         assert job_name is None or job_id is None, (job_name, job_id)
-        if job_name is not None:
-            code = managed_jobs.ManagedJobCodeGen.stream_logs_by_name(
-                job_name, follow)
-        else:
-            code = managed_jobs.ManagedJobCodeGen.stream_logs_by_id(
-                job_id, follow)
+        code = managed_jobs.ManagedJobCodeGen.stream_logs(
+            job_name, job_id, follow, controller)
 
         # With the stdin=subprocess.DEVNULL, the ctrl-c will not directly
         # kill the process, so we need to handle it manually here.
         if threading.current_thread() is threading.main_thread():
             signal.signal(signal.SIGINT, backend_utils.interrupt_handler)
             signal.signal(signal.SIGTSTP, backend_utils.stop_handler)
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/local_docker_backend.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/backends/wheel_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/benchmark/benchmark_state.py` & `skypilot_nightly-1.0.0.dev20240529/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/benchmark/benchmark_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/check.py` & `skypilot_nightly-1.0.0.dev20240529/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/cli.py` & `skypilot_nightly-1.0.0.dev20240529/sky/cli.py`

 * *Files 1% similar despite different names*

```diff
@@ -2962,25 +2962,39 @@
 
     To show all accelerators, including less common ones and their detailed
     information, use ``sky show-gpus --all``.
 
     To show all regions for a specified accelerator, use
     ``sky show-gpus <accelerator> --all-regions``.
 
+    If ``--region`` or ``--all-regions`` is not specified, the price displayed
+    for each instance type is the lowest across all regions for both on-demand
+    and spot instances. There may be multiple regions with the same lowest
+    price.
+
+    If ``--cloud kubernetes`` is specified, it will show the maximum quantities
+    of the GPU available on a single node and the real-time availability of
+    the GPU across all nodes in the Kubernetes cluster.
+
     Definitions of certain fields:
 
     * ``DEVICE_MEM``: Memory of a single device; does not depend on the device
       count of the instance (VM).
 
     * ``HOST_MEM``: Memory of the host instance (VM).
 
-    If ``--region`` or ``--all-regions`` is not specified, the price displayed
-    for each instance type is the lowest across all regions for both on-demand
-    and spot instances. There may be multiple regions with the same lowest
-    price.
+    * ``QTY_PER_NODE`` (Kubernetes only): GPU quantities that can be requested
+      on a single node.
+
+    * ``TOTAL_GPUS`` (Kubernetes only): Total number of GPUs available in the
+      Kubernetes cluster.
+
+    * ``TOTAL_FREE_GPUS`` (Kubernetes only): Number of currently free GPUs
+      in the Kubernetes cluster. This is fetched in real-time and may change
+      when other users are using the cluster.
     """
     # validation for the --region flag
     if region is not None and cloud is None:
         raise click.UsageError(
             'The --region flag is only valid when the --cloud flag is set.')
 
     # validation for the --all-regions flag
@@ -2995,56 +3009,145 @@
     # This will validate 'cloud' and raise if not found.
     cloud_obj = sky_clouds.CLOUD_REGISTRY.from_str(cloud)
     service_catalog.validate_region_zone(region, None, clouds=cloud)
     show_all = all
     if show_all and accelerator_str is not None:
         raise click.UsageError('--all is only allowed without a GPU name.')
 
+    # Kubernetes specific bools
+    cloud_is_kubernetes = isinstance(cloud_obj, sky_clouds.Kubernetes)
+    kubernetes_autoscaling = kubernetes_utils.get_autoscaler_type() is not None
+    kubernetes_is_enabled = sky_clouds.cloud_in_iterable(
+        sky_clouds.Kubernetes(), global_user_state.get_cached_enabled_clouds())
+
+    if cloud_is_kubernetes and region is not None:
+        raise click.UsageError(
+            'The --region flag cannot be set with --cloud kubernetes.')
+
     def _list_to_str(lst):
         return ', '.join([str(e) for e in lst])
 
+    def _get_kubernetes_realtime_gpu_table(
+            name_filter: Optional[str] = None,
+            quantity_filter: Optional[int] = None):
+        if quantity_filter:
+            qty_header = 'QTY_FILTER'
+            free_header = 'FILTERED_FREE_GPUS'
+        else:
+            qty_header = 'QTY_PER_NODE'
+            free_header = 'TOTAL_FREE_GPUS'
+        realtime_gpu_table = log_utils.create_table(
+            ['GPU', qty_header, 'TOTAL_GPUS', free_header])
+        counts, capacity, available = service_catalog.list_accelerator_realtime(
+            gpus_only=True,
+            clouds='kubernetes',
+            name_filter=name_filter,
+            region_filter=region,
+            quantity_filter=quantity_filter,
+            case_sensitive=False)
+        assert (set(counts.keys()) == set(capacity.keys()) == set(
+            available.keys())), (f'Keys of counts ({list(counts.keys())}), '
+                                 f'capacity ({list(capacity.keys())}), '
+                                 f'and available ({list(available.keys())}) '
+                                 'must be same.')
+        if len(counts) == 0:
+            err_msg = 'No GPUs found in Kubernetes cluster. '
+            debug_msg = 'To further debug, run: sky check '
+            if name_filter is not None:
+                gpu_info_msg = f' {name_filter!r}'
+                if quantity_filter is not None:
+                    gpu_info_msg += (' with requested quantity'
+                                     f' {quantity_filter}')
+                err_msg = (f'Resources{gpu_info_msg} not found '
+                           'in Kubernetes cluster. ')
+                debug_msg = ('To show available accelerators on kubernetes,'
+                             ' run: sky show-gpus --cloud kubernetes ')
+            full_err_msg = (err_msg + kubernetes_utils.NO_GPU_HELP_MESSAGE +
+                            debug_msg)
+            raise ValueError(full_err_msg)
+        for gpu, _ in sorted(counts.items()):
+            realtime_gpu_table.add_row([
+                gpu,
+                _list_to_str(counts.pop(gpu)), capacity[gpu], available[gpu]
+            ])
+        return realtime_gpu_table
+
     def _output():
         gpu_table = log_utils.create_table(
             ['COMMON_GPU', 'AVAILABLE_QUANTITIES'])
         tpu_table = log_utils.create_table(
             ['GOOGLE_TPU', 'AVAILABLE_QUANTITIES'])
         other_table = log_utils.create_table(
             ['OTHER_GPU', 'AVAILABLE_QUANTITIES'])
 
         name, quantity = None, None
 
-        # Kubernetes specific bools
-        cloud_is_kubernetes = isinstance(cloud_obj, sky_clouds.Kubernetes)
-        kubernetes_autoscaling = kubernetes_utils.get_autoscaler_type(
-        ) is not None
+        # Optimization - do not poll for Kubernetes API for fetching
+        # common GPUs because that will be fetched later for the table after
+        # common GPUs.
+        clouds_to_list = cloud
+        if cloud is None:
+            clouds_to_list = [
+                c for c in service_catalog.ALL_CLOUDS if c != 'kubernetes'
+            ]
 
+        k8s_messages = ''
         if accelerator_str is None:
+            # Collect k8s related messages in k8s_messages and print them at end
+            print_section_titles = False
+            # If cloud is kubernetes, we want to show real-time capacity
+            if kubernetes_is_enabled and (cloud is None or cloud_is_kubernetes):
+                try:
+                    # If --cloud kubernetes is not specified, we want to catch
+                    # the case where no GPUs are available on the cluster and
+                    # print the warning at the end.
+                    k8s_realtime_table = _get_kubernetes_realtime_gpu_table()
+                except ValueError as e:
+                    if not cloud_is_kubernetes:
+                        # Make it a note if cloud is not kubernetes
+                        k8s_messages += 'Note: '
+                    k8s_messages += str(e)
+                else:
+                    print_section_titles = True
+                    yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                           f'Kubernetes GPUs{colorama.Style.RESET_ALL}\n')
+                    yield from k8s_realtime_table.get_string()
+                if kubernetes_autoscaling:
+                    k8s_messages += (
+                        '\n' + kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE)
+            if cloud_is_kubernetes:
+                # Do not show clouds if --cloud kubernetes is specified
+                if not kubernetes_is_enabled:
+                    yield ('Kubernetes is not enabled. To fix, run: '
+                           'sky check kubernetes ')
+                yield k8s_messages
+                return
+
+            # For show_all, show the k8s message at the start since output is
+            # long and the user may not scroll to the end.
+            if show_all and k8s_messages:
+                yield k8s_messages
+                yield '\n\n'
+
             result = service_catalog.list_accelerator_counts(
                 gpus_only=True,
-                clouds=cloud,
+                clouds=clouds_to_list,
                 region_filter=region,
             )
 
-            if len(result) == 0 and cloud_is_kubernetes:
-                yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
-                if kubernetes_autoscaling:
-                    yield '\n'
-                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
-                return
+            if print_section_titles:
+                # If section titles were printed above, print again here
+                yield '\n\n'
+                yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                       f'Cloud GPUs{colorama.Style.RESET_ALL}\n')
 
             # "Common" GPUs
-            # If cloud is kubernetes, we want to show all GPUs here, even if
-            # they are not listed as common in SkyPilot.
-            if cloud_is_kubernetes:
-                for gpu, _ in sorted(result.items()):
+            for gpu in service_catalog.get_common_gpus():
+                if gpu in result:
                     gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
-            else:
-                for gpu in service_catalog.get_common_gpus():
-                    if gpu in result:
-                        gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
             yield from gpu_table.get_string()
 
             # Google TPUs
             for tpu in service_catalog.get_tpus():
                 if tpu in result:
                     tpu_table.add_row([tpu, _list_to_str(result.pop(tpu))])
             if len(tpu_table.get_string()) > 0:
@@ -3054,24 +3157,20 @@
             # Other GPUs
             if show_all:
                 yield '\n\n'
                 for gpu, qty in sorted(result.items()):
                     other_table.add_row([gpu, _list_to_str(qty)])
                 yield from other_table.get_string()
                 yield '\n\n'
-                if (cloud_is_kubernetes or
-                        cloud is None) and kubernetes_autoscaling:
-                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
-                    yield '\n\n'
             else:
                 yield ('\n\nHint: use -a/--all to see all accelerators '
                        '(including non-common ones) and pricing.')
-                if (cloud_is_kubernetes or
-                        cloud is None) and kubernetes_autoscaling:
-                    yield kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE
+                if k8s_messages:
+                    yield '\n'
+                    yield k8s_messages
                 return
         else:
             # Parse accelerator string
             accelerator_split = accelerator_str.split(':')
             if len(accelerator_split) > 2:
                 raise click.UsageError(
                     f'Invalid accelerator string {accelerator_str}. '
@@ -3087,20 +3186,48 @@
                 except ValueError as invalid_quantity:
                     raise click.UsageError(
                         f'Invalid accelerator quantity {accelerator_split[1]}. '
                         'Expected a positive integer.') from invalid_quantity
             else:
                 name, quantity = accelerator_str, None
 
+        print_section_titles = False
+        if (kubernetes_is_enabled and (cloud is None or cloud_is_kubernetes) and
+                not show_all):
+            # Print section title if not showing all and instead a specific
+            # accelerator is requested
+            print_section_titles = True
+            yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                   f'Kubernetes GPUs{colorama.Style.RESET_ALL}\n')
+            try:
+                k8s_realtime_table = _get_kubernetes_realtime_gpu_table(
+                    name_filter=name, quantity_filter=quantity)
+                yield from k8s_realtime_table.get_string()
+            except ValueError as e:
+                # In the case of a specific accelerator, show the error message
+                # immediately (e.g., "Resources H100 not found ...")
+                yield str(e)
+            if kubernetes_autoscaling:
+                k8s_messages += ('\n' +
+                                 kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE)
+            yield k8s_messages
+        if cloud_is_kubernetes:
+            # Do not show clouds if --cloud kubernetes is specified
+            if not kubernetes_is_enabled:
+                yield ('Kubernetes is not enabled. To fix, run: '
+                       'sky check kubernetes ')
+            return
+
+        # For clouds other than Kubernetes, get the accelerator details
         # Case-sensitive
         result = service_catalog.list_accelerators(gpus_only=True,
                                                    name_filter=name,
                                                    quantity_filter=quantity,
                                                    region_filter=region,
-                                                   clouds=cloud,
+                                                   clouds=clouds_to_list,
                                                    case_sensitive=False,
                                                    all_regions=all_regions)
         # Import here to save module load speed.
         # pylint: disable=import-outside-toplevel,line-too-long
         from sky.clouds.service_catalog import common
 
         # For each gpu name (count not included):
@@ -3124,24 +3251,25 @@
             sorted_dataclasses = [
                 common.InstanceTypeInfo(*row)
                 for row in df.to_records(index=False)
             ]
             new_result[gpu] = sorted_dataclasses
         result = new_result
 
-        if len(result) == 0:
-            if cloud == 'kubernetes':
-                yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
-                return
+        if print_section_titles and not show_all:
+            yield '\n\n'
+            yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                   f'Cloud GPUs{colorama.Style.RESET_ALL}\n')
 
+        if len(result) == 0:
             quantity_str = (f' with requested quantity {quantity}'
                             if quantity else '')
-            yield f'Resources \'{name}\'{quantity_str} not found. '
-            yield 'Try \'sky show-gpus --all\' '
-            yield 'to show available accelerators.'
+            cloud_str = f' on {cloud_obj}.' if cloud else ' in cloud catalogs.'
+            yield f'Resources \'{name}\'{quantity_str} not found{cloud_str} '
+            yield 'To show available accelerators, run: sky show-gpus --all'
             return
 
         for i, (gpu, items) in enumerate(result.items()):
             accelerator_table_headers = [
                 'GPU',
                 'QTY',
                 'CLOUD',
@@ -3628,21 +3756,18 @@
           'launching/recoveries, etc.'))
 @click.argument('job_id', required=False, type=int)
 @usage_lib.entrypoint
 def jobs_logs(name: Optional[str], job_id: Optional[int], follow: bool,
               controller: bool):
     """Tail the log of a managed job."""
     try:
-        if controller:
-            core.tail_logs(
-                controller_utils.Controllers.JOBS_CONTROLLER.value.cluster_name,
-                job_id=job_id,
-                follow=follow)
-        else:
-            managed_jobs.tail_logs(name=name, job_id=job_id, follow=follow)
+        managed_jobs.tail_logs(name=name,
+                               job_id=job_id,
+                               follow=follow,
+                               controller=controller)
     except exceptions.ClusterNotUpError:
         with ux_utils.print_exception_no_traceback():
             raise
 
 
 @jobs.command('dashboard', cls=_DocumentedCodeCommand)
 @click.option(
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/cloud_stores.py` & `skypilot_nightly-1.0.0.dev20240529/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/aws.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/azure.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/cloud.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/cloud_registry.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/cudo.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/fluidstack.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/gcp.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/ibm.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/kubernetes.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/kubernetes.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/oci.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/paperspace.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/paperspace.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/runpod.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/runpod.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/scp.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/scp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/__init__.py`

 * *Files 10% similar despite different names*

```diff
@@ -113,14 +113,54 @@
                 accelerator_counts[gpu].add(item.accelerator_count)
     ret: Dict[str, List[int]] = {}
     for gpu, counts in accelerator_counts.items():
         ret[gpu] = sorted(counts)
     return ret
 
 
+def list_accelerator_realtime(
+    gpus_only: bool = True,
+    name_filter: Optional[str] = None,
+    region_filter: Optional[str] = None,
+    quantity_filter: Optional[int] = None,
+    clouds: CloudFilter = None,
+    case_sensitive: bool = True,
+) -> Tuple[Dict[str, List[int]], Dict[str, int], Dict[str, int]]:
+    """List all accelerators offered by Sky with their realtime availability.
+
+    Realtime availability is the total number of accelerators in the cluster
+    and number of accelerators available at the time of the call.
+
+    Used for fixed size cluster settings, such as Kubernetes.
+
+    Returns:
+        A tuple of three dictionaries mapping canonical accelerator names to:
+        - A list of available counts. (e.g., [1, 2, 4])
+        - Total number of accelerators in the cluster (capacity).
+        - Number of accelerators available at the time of call (availability).
+    """
+    qtys_map, total_accelerators_capacity, total_accelerators_available = (
+        _map_clouds_catalog(clouds,
+                            'list_accelerators_realtime',
+                            gpus_only,
+                            name_filter,
+                            region_filter,
+                            quantity_filter,
+                            case_sensitive=case_sensitive,
+                            all_regions=False,
+                            require_price=False))
+    accelerator_counts: Dict[str, List[int]] = collections.defaultdict(list)
+    for gpu, items in qtys_map.items():
+        for item in items:
+            accelerator_counts[gpu].append(item.accelerator_count)
+        accelerator_counts[gpu] = sorted(accelerator_counts[gpu])
+    return (accelerator_counts, total_accelerators_capacity,
+            total_accelerators_available)
+
+
 def instance_type_exists(instance_type: str,
                          clouds: CloudFilter = None) -> bool:
     """Check the existence of a instance type."""
     return _map_clouds_catalog(clouds, 'instance_type_exists', instance_type)
 
 
 def validate_region_zone(
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/aws_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/azure_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/common.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/oci_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/paperspace_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/paperspace_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/scp_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/gcp_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/gcp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/lambda_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/oci_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/utils/scp_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/clouds/vsphere.py` & `skypilot_nightly-1.0.0.dev20240529/sky/clouds/vsphere.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/core.py` & `skypilot_nightly-1.0.0.dev20240529/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/dag.py` & `skypilot_nightly-1.0.0.dev20240529/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/data/data_transfer.py` & `skypilot_nightly-1.0.0.dev20240529/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/data/data_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/data/mounting_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/data/storage.py` & `skypilot_nightly-1.0.0.dev20240529/sky/data/storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/data/storage_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/exceptions.py` & `skypilot_nightly-1.0.0.dev20240529/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/execution.py` & `skypilot_nightly-1.0.0.dev20240529/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/global_user_state.py` & `skypilot_nightly-1.0.0.dev20240529/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/controller.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/core.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/core.py`

 * *Files 2% similar despite different names*

```diff
@@ -274,15 +274,16 @@
     if 'Multiple jobs found with name' in stdout:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError(
                 'Please specify the job ID instead of the job name.')
 
 
 @usage_lib.entrypoint
-def tail_logs(name: Optional[str], job_id: Optional[int], follow: bool) -> None:
+def tail_logs(name: Optional[str], job_id: Optional[int], follow: bool,
+              controller: bool) -> None:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Tail logs of managed jobs.
 
     Please refer to sky.cli.job_logs for documentation.
 
     Raises:
         ValueError: invalid arguments.
@@ -296,19 +297,20 @@
             'Please restart the jobs controller with '
             f'`sky start {jobs_controller_type.value.cluster_name}`.'))
 
     if name is not None and job_id is not None:
         raise ValueError('Cannot specify both name and job_id.')
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend), backend
-    # Stream the realtime logs
+
     backend.tail_managed_job_logs(handle,
                                   job_id=job_id,
                                   job_name=name,
-                                  follow=follow)
+                                  follow=follow,
+                                  controller=controller)
 
 
 spot_launch = common_utils.deprecated_function(
     launch,
     name='sky.jobs.launch',
     deprecated_name='spot_launch',
     removing_version='0.8.0',
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/dashboard.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/static/favicon.ico` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/dashboard/templates/index.html` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/recovery_strategy.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/state.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/jobs/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/jobs/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 
 NOTE: whenever an API change is made in this file, we need to bump the
 jobs.constants.MANAGED_JOBS_VERSION and handle the API change in the
 ManagedJobCodeGen.
 """
 import collections
 import enum
+import inspect
 import os
 import pathlib
 import shlex
 import shutil
 import textwrap
 import time
 import typing
@@ -24,15 +25,15 @@
 from sky import global_user_state
 from sky import sky_logging
 from sky.backends import backend_utils
 from sky.jobs import constants as managed_job_constants
 from sky.jobs import state as managed_job_state
 from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.skylet.log_lib import run_bash_command_with_log
+from sky.skylet import log_lib
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 
 if typing.TYPE_CHECKING:
     import sky
@@ -180,15 +181,15 @@
         event_callback = event_callback.strip()
         cluster_name = generate_managed_job_cluster_name(
             task.name, job_id) if task.name else None
         logger.info(f'=== START: event callback for {status!r} ===')
         log_path = os.path.join(constants.SKY_LOGS_DIRECTORY,
                                 'managed_job_event',
                                 f'jobs-callback-{job_id}-{task_id}.log')
-        result = run_bash_command_with_log(
+        result = log_lib.run_bash_command_with_log(
             bash_command=event_callback,
             log_path=log_path,
             env_vars=dict(
                 SKYPILOT_TASK_ID=str(
                     task.envs.get(constants.TASK_ID_ENV_VAR, 'N.A.')),
                 SKYPILOT_TASK_IDS=str(
                     task.envs.get(constants.TASK_ID_LIST_ENV_VAR, 'N.A.')),
@@ -444,26 +445,63 @@
         assert managed_job_status is not None, job_id
 
     logger.info(f'Logs finished for job {job_id} '
                 f'(status: {managed_job_status.value}).')
     return ''
 
 
-def stream_logs_by_name(job_name: str, follow: bool = True) -> str:
-    """Stream logs by name."""
-    job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
-    if len(job_ids) == 0:
-        return (f'{colorama.Fore.RED}No job found with name {job_name!r}.'
-                f'{colorama.Style.RESET_ALL}')
-    if len(job_ids) > 1:
-        return (f'{colorama.Fore.RED}Multiple running jobs found '
-                f'with name {job_name!r}.\n'
-                f'Job IDs: {job_ids}{colorama.Style.RESET_ALL}')
-    stream_logs_by_id(job_ids[0], follow)
-    return ''
+def stream_logs(job_id: Optional[int],
+                job_name: Optional[str],
+                controller: bool = False,
+                follow: bool = True) -> str:
+    """Stream logs by job id or job name."""
+    if job_id is None and job_name is None:
+        job_id = managed_job_state.get_latest_job_id()
+        if job_id is None:
+            return 'No managed job found.'
+    if controller:
+        if job_id is None:
+            assert job_name is not None
+            managed_jobs = managed_job_state.get_managed_jobs()
+            # We manually filter the jobs by name, instead of using
+            # get_nonterminal_job_ids_by_name, as with `controller=True`, we
+            # should be able to show the logs for jobs in terminal states.
+            managed_jobs = list(
+                filter(lambda job: job['job_name'] == job_name, managed_jobs))
+            if len(managed_jobs) == 0:
+                return f'No managed job found with name {job_name!r}.'
+            if len(managed_jobs) > 1:
+                job_ids_str = ', '.join(job['job_id'] for job in managed_jobs)
+                raise ValueError(
+                    f'Multiple managed jobs found with name {job_name!r} (Job '
+                    f'IDs: {job_ids_str}). Please specify the job_id instead.')
+            job_id = managed_jobs[0]['job_id']
+        assert job_id is not None, (job_id, job_name)
+        # TODO: keep the following code sync with
+        # job_lib.JobLibCodeGen.tail_logs, we do not directly call that function
+        # as the following code need to be run in the current machine, instead
+        # of running remotely.
+        run_timestamp = job_lib.get_run_timestamp(job_id)
+        if run_timestamp is None:
+            return f'No managed job contrller log found with job_id {job_id}.'
+        log_dir = os.path.join(constants.SKY_LOGS_DIRECTORY, run_timestamp)
+        log_lib.tail_logs(job_id=job_id, log_dir=log_dir, follow=follow)
+        return ''
+
+    if job_id is None:
+        assert job_name is not None
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
+        if len(job_ids) == 0:
+            return f'No running managed job found with name {job_name!r}.'
+        if len(job_ids) > 1:
+            raise ValueError(
+                f'Multiple running jobs found with name {job_name!r}.')
+        job_id = job_ids[0]
+
+    return stream_logs_by_id(job_id, follow)
 
 
 def dump_managed_job_queue() -> str:
     jobs = managed_job_state.get_managed_jobs()
 
     for job in jobs:
         end_at = job['end_at']
@@ -709,21 +747,27 @@
 class ManagedJobCodeGen:
     """Code generator for managed job utility functions.
 
     Usage:
 
       >> codegen = ManagedJobCodeGen.show_jobs(...)
     """
+    # TODO: the try..except.. block is for backward compatibility. Remove it in
+    # v0.8.0.
     _PREFIX = textwrap.dedent("""\
         managed_job_version = 0
         try:
-            from sky.jobs import constants, state, utils
-            managed_job_version = constants.MANAGED_JOBS_VERSION
+            from sky.jobs import utils
+            from sky.jobs import constants as managed_job_constants
+            from sky.jobs import state as managed_job_state
+
+            managed_job_version = managed_job_constants.MANAGED_JOBS_VERSION
         except ImportError:
-            from sky.spot import spot_state as state, spot_utils as utils
+            from sky.spot import spot_state as managed_job_state
+            from sky.spot import spot_utils as utils
         """)
 
     @classmethod
     def get_job_table(cls) -> str:
         code = textwrap.dedent("""\
         if managed_job_version < 1:
             job_table = utils.dump_spot_job_queue()
@@ -746,44 +790,56 @@
         code = textwrap.dedent(f"""\
         msg = utils.cancel_job_by_name({job_name!r})
         print(msg, end="", flush=True)
         """)
         return cls._build(code)
 
     @classmethod
-    def stream_logs_by_name(cls, job_name: str, follow: bool = True) -> str:
-        code = textwrap.dedent(f"""\
-        msg = utils.stream_logs_by_name({job_name!r}, follow={follow})
-        print(msg, flush=True)
+    def stream_logs(cls,
+                    job_name: Optional[str],
+                    job_id: Optional[int],
+                    follow: bool = True,
+                    controller: bool = False) -> str:
+        # We inspect the source code of the function here for backward
+        # compatibility.
+        # TODO: change to utils.stream_logs(job_id, job_name, follow) in v0.8.0.
+        # Import libraries required by `stream_logs`. The try...except... block
+        # should be removed in v0.8.0.
+        code = textwrap.dedent("""\
+        import os
+
+        from sky.skylet import job_lib, log_lib
+        from sky.skylet import constants
+        try:
+            from sky.jobs.utils import stream_logs_by_id
+        except ImportError:
+            from sky.spot.spot_utils import stream_logs_by_id
+        from typing import Optional
         """)
-        return cls._build(code)
+        code += inspect.getsource(stream_logs)
+        code += textwrap.dedent(f"""\
 
-    @classmethod
-    def stream_logs_by_id(cls,
-                          job_id: Optional[int],
-                          follow: bool = True) -> str:
-        code = textwrap.dedent(f"""\
-        job_id = {job_id} if {job_id} is not None else state.get_latest_job_id()
-        msg = utils.stream_logs_by_id(job_id, follow={follow})
+        msg = stream_logs({job_id!r}, {job_name!r}, 
+                           follow={follow}, controller={controller})
         print(msg, flush=True)
         """)
         return cls._build(code)
 
     @classmethod
     def set_pending(cls, job_id: int, managed_job_dag: 'dag_lib.Dag') -> str:
         dag_name = managed_job_dag.name
         # Add the managed job to queue table.
         code = textwrap.dedent(f"""\
-            state.set_job_name({job_id}, {dag_name!r})
+            managed_job_state.set_job_name({job_id}, {dag_name!r})
             """)
         for task_id, task in enumerate(managed_job_dag.tasks):
             resources_str = backend_utils.get_task_resources_str(
                 task, is_managed_job=True)
             code += textwrap.dedent(f"""\
-                state.set_pending({job_id}, {task_id}, 
+                managed_job_state.set_pending({job_id}, {task_id}, 
                                   {task.name!r}, {resources_str!r})
                 """)
         return cls._build(code)
 
     @classmethod
     def _build(cls, code: str) -> str:
         generated_code = cls._PREFIX + '\n' + code
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/optimizer.py` & `skypilot_nightly-1.0.0.dev20240529/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/aws/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/azure/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/azure/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/common.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/common.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/cudo_machine_type.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/cudo_wrapper.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/cudo_wrapper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/cudo/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/cudo/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/docker_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/fluidstack/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/fluidstack/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/gcp/instance_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/gcp/instance_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/instance_setup.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/instance_setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/network.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/network.py`

 * *Files 2% similar despite different names*

```diff
@@ -4,16 +4,16 @@
 from sky.adaptors import kubernetes
 from sky.provision import common
 from sky.provision.kubernetes import network_utils
 from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.utils import kubernetes_enums
 from sky.utils.resources_utils import port_ranges_to_set
 
-_PATH_PREFIX = '/skypilot/{cluster_name_on_cloud}/{port}'
-_LOADBALANCER_SERVICE_NAME = '{cluster_name_on_cloud}-skypilot-loadbalancer'
+_PATH_PREFIX = '/skypilot/{namespace}/{cluster_name_on_cloud}/{port}'
+_LOADBALANCER_SERVICE_NAME = '{cluster_name_on_cloud}--skypilot-lb'
 
 
 def open_ports(
     cluster_name_on_cloud: str,
     ports: List[str],
     provider_config: Optional[Dict[str, Any]] = None,
 ) -> None:
@@ -69,21 +69,22 @@
     if not network_utils.ingress_controller_exists():
         raise Exception(
             'Ingress controller not found. '
             'Install Nginx ingress controller first: '
             'https://github.com/kubernetes/ingress-nginx/blob/main/docs/deploy/index.md.'  # pylint: disable=line-too-long
         )
 
-    # Prepare service names, ports, for template rendering
-    service_details = [
-        (f'{cluster_name_on_cloud}-skypilot-service--{port}', port,
-         _PATH_PREFIX.format(cluster_name_on_cloud=cluster_name_on_cloud,
-                             port=port).rstrip('/').lstrip('/'))
-        for port in ports
-    ]
+    # Prepare service names, ports,  for template rendering
+    service_details = [(f'{cluster_name_on_cloud}--skypilot-svc--{port}', port,
+                        _PATH_PREFIX.format(
+                            cluster_name_on_cloud=cluster_name_on_cloud,
+                            port=port,
+                            namespace=kubernetes_utils.
+                            get_current_kube_config_context_namespace()).rstrip(
+                                '/').lstrip('/')) for port in ports]
 
     # Generate ingress and services specs
     # We batch ingress rule creation because each rule triggers a hot reload of
     # the nginx controller. If the ingress rules are created sequentially,
     # it could lead to multiple reloads of the Nginx-Ingress-Controller within
     # a brief period. Consequently, the Nginx-Controller pod might spawn an
     # excessive number of sub-processes. This surge triggers Kubernetes to kill
@@ -156,15 +157,15 @@
 def _cleanup_ports_for_ingress(
     cluster_name_on_cloud: str,
     ports: List[int],
     provider_config: Dict[str, Any],
 ) -> None:
     # Delete services for each port
     for port in ports:
-        service_name = f'{cluster_name_on_cloud}-skypilot-service--{port}'
+        service_name = f'{cluster_name_on_cloud}--skypilot-svc--{port}'
         network_utils.delete_namespaced_service(
             namespace=provider_config.get('namespace', 'default'),
             service_name=service_name,
         )
 
     # Delete the single ingress used for all ports
     ingress_name = f'{cluster_name_on_cloud}-skypilot-ingress'
@@ -241,15 +242,18 @@
     external_ip, external_ports = ingress_details
     if external_ip is None:
         return {}
 
     result: Dict[int, List[common.Endpoint]] = {}
     for port in ports:
         path_prefix = _PATH_PREFIX.format(
-            cluster_name_on_cloud=cluster_name_on_cloud, port=port)
+            cluster_name_on_cloud=cluster_name_on_cloud,
+            port=port,
+            namespace=kubernetes_utils.
+            get_current_kube_config_context_namespace())
 
         http_port, https_port = external_ports \
             if external_ports is not None else (None, None)
         result[port] = [
             common.HTTPEndpoint(host=external_ip,
                                 port=http_port,
                                 path=path_prefix.lstrip('/')),
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/network_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/network_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/kubernetes/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/kubernetes/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -31,18 +31,18 @@
     'B': 1,
     'K': 2**10,
     'M': 2**20,
     'G': 2**30,
     'T': 2**40,
     'P': 2**50,
 }
-NO_GPU_ERROR_MESSAGE = 'No GPUs found in Kubernetes cluster. \
-If your cluster contains GPUs, make sure nvidia.com/gpu resource is available on the nodes and the node labels for identifying GPUs \
-(e.g., skypilot.co/accelerator) are setup correctly. \
-To further debug, run: sky check.'
+NO_GPU_HELP_MESSAGE = ('If your cluster contains GPUs, make sure '
+                       'nvidia.com/gpu resource is available on the nodes and '
+                       'the node labels for identifying GPUs '
+                       '(e.g., skypilot.co/accelerator) are setup correctly. ')
 
 KUBERNETES_AUTOSCALER_NOTE = (
     'Note: Kubernetes cluster autoscaling is enabled. '
     'All GPUs that can be provisioned may not be listed '
     'here. Refer to your autoscaler\'s node pool '
     'configuration to see the list of supported GPUs.')
 
@@ -276,14 +276,26 @@
     except kubernetes.max_retry_error():
         raise exceptions.ResourcesUnavailableError(
             'Timed out when trying to get node info from Kubernetes cluster. '
             'Please check if the cluster is healthy and retry.') from None
     return nodes
 
 
+def get_kubernetes_pods() -> List[Any]:
+    try:
+        ns = get_current_kube_config_context_namespace()
+        pods = kubernetes.core_api().list_namespaced_pod(
+            ns, _request_timeout=kubernetes.API_TIMEOUT).items
+    except kubernetes.max_retry_error():
+        raise exceptions.ResourcesUnavailableError(
+            'Timed out when trying to get pod info from Kubernetes cluster. '
+            'Please check if the cluster is healthy and retry.') from None
+    return pods
+
+
 def check_instance_fits(instance: str) -> Tuple[bool, Optional[str]]:
     """Checks if the instance fits on the Kubernetes cluster.
 
     If the instance has GPU requirements, checks if the GPU type is
     available on the cluster and if enough CPU/memory is available on any node
     with the GPU type.
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/logging.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/paperspace/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/paperspace/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/provisioner.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/provisioner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/runpod/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/runpod/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/cls_api_client.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/metadata_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/service_manager.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/ssl_helper.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/vapiconnect.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/common/vim_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/instance.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/instance.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/provision/vsphere/vsphere_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/resources.py` & `skypilot_nightly-1.0.0.dev20240529/sky/resources.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/autoscalers.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/autoscalers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/controller.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/controller.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/core.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/core.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/load_balancer.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/load_balancer.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/load_balancing_policies.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/load_balancing_policies.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/replica_managers.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/replica_managers.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/serve_state.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/serve_state.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/serve_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/serve_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/service.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/service.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/serve/service_spec.py` & `skypilot_nightly-1.0.0.dev20240529/sky/serve/service_spec.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/setup_files/MANIFEST.in` & `skypilot_nightly-1.0.0.dev20240529/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/setup_files/setup.py` & `skypilot_nightly-1.0.0.dev20240529/sky/setup_files/setup.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/sky_logging.py` & `skypilot_nightly-1.0.0.dev20240529/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/LICENSE` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/attempt_skylet.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/autostop_lib.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/configs.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/constants.py`

 * *Files 2% similar despite different names*

```diff
@@ -126,14 +126,17 @@
 _sky_version = str(version.parse(sky.__version__))
 RAY_STATUS = f'RAY_ADDRESS=127.0.0.1:{SKY_REMOTE_RAY_PORT} {SKY_RAY_CMD} status'
 # Install ray and skypilot on the remote cluster if they are not already
 # installed. {var} will be replaced with the actual value in
 # backend_utils.write_cluster_config.
 RAY_SKYPILOT_INSTALLATION_COMMANDS = (
     'mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;'
+    # Disable the pip version check to avoid the warning message, which makes
+    # the output hard to read.
+    'export PIP_DISABLE_PIP_VERSION_CHECK=1;'
     # Print the PATH in provision.log to help debug PATH issues.
     'echo PATH=$PATH; '
     # Backward compatibility for ray upgrade (#3248): do not upgrade ray if the
     # ray cluster is already running, to avoid the ray cluster being restarted.
     #
     # We do this guard to avoid any Ray client-server version mismatch.
     # Specifically: If existing ray cluster is an older version say 2.4, and we
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/events.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/job_lib.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/log_lib.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/log_lib.pyi` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/log_lib.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/azure-config-template.json` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/azure/node_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/command_runner.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/node_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/node_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/oci/query_helper.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/providers/scp/node_provider.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/__init__.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/ray_patches/worker.py.patch` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/skylet.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skylet/subprocess_daemon.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/skypilot_config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/status_lib.py` & `skypilot_nightly-1.0.0.dev20240529/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/task.py` & `skypilot_nightly-1.0.0.dev20240529/sky/task.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/aws-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/azure-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/cudo-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/cudo-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/fluidstack-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/fluidstack-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/gcp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/ibm-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/jobs-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/jobs-controller.yaml.j2`

 * *Files 7% similar despite different names*

```diff
@@ -7,14 +7,17 @@
   {{remote_user_config_path}}: skypilot:local_skypilot_config_path
   {%- for remote_catalog_path, local_catalog_path in modified_catalogs.items() %}
   {{remote_catalog_path}}: {{local_catalog_path}}
   {%- endfor %}
 
 setup: |
   {{ sky_activate_python_env }}
+  # Disable the pip version check to avoid the warning message, which makes the
+  # output hard to read.
+  export PIP_DISABLE_PIP_VERSION_CHECK=1
 
   {%- for cmd in cloud_dependencies_installation_commands %}
   {{cmd}}
   {%- endfor %}
 
   {% if is_dev %}
   # Internal: disable logging for manually logging into the jobs controller for debugging.
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ingress.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ingress.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/lambda-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/local-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/oci-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/paperspace-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/paperspace-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/runpod-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/runpod-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/scp-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/sky-serve-controller.yaml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/sky-serve-controller.yaml.j2`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,16 @@
 # The template for the sky serve controller
 
 name: {{service_name}}
 
 setup: |
   {{ sky_activate_python_env }}
+  # Disable the pip version check to avoid the warning message, which makes the
+  # output hard to read.
+  export PIP_DISABLE_PIP_VERSION_CHECK=1
 
   # Install all cloud dependencies.
   # This is for multicloud support. To allow controller launch on all clouds,
   # we need to install all cloud dependencies.
   {%- for cmd in cloud_dependencies_installation_commands %}
   {{cmd}}
   {%- endfor %}
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/templates/vsphere-ray.yml.j2` & `skypilot_nightly-1.0.0.dev20240529/sky/templates/vsphere-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/usage/constants.py` & `skypilot_nightly-1.0.0.dev20240529/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/usage/usage_lib.py` & `skypilot_nightly-1.0.0.dev20240529/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/accelerator_registry.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/cli_utils/status_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/cluster_yaml_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/cluster_yaml_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/command_runner.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/command_runner.py`

 * *Files 0% similar despite different names*

```diff
@@ -444,21 +444,19 @@
             connect_timeout=connect_timeout)
         if ssh_mode == SshMode.LOGIN:
             assert isinstance(cmd, list), 'cmd must be a list for login mode.'
             command = base_ssh_command + cmd
             proc = subprocess_utils.run(command, shell=False, check=False)
             return proc.returncode, '', ''
 
-        command_str = self._get_command_to_run(
-            cmd,
-            process_stream,
-            separate_stderr,
-            # +1 to skip first new line.
-            skip_lines=skip_lines + 1,
-            source_bashrc=source_bashrc)
+        command_str = self._get_command_to_run(cmd,
+                                               process_stream,
+                                               separate_stderr,
+                                               skip_lines=skip_lines,
+                                               source_bashrc=source_bashrc)
         command = base_ssh_command + [shlex.quote(command_str)]
 
         log_dir = os.path.expanduser(os.path.dirname(log_path))
         os.makedirs(log_dir, exist_ok=True)
 
         executable = None
         if not process_stream:
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/command_runner.pyi` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/command_runner.pyi`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/common_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/common_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/controller_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/controller_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -203,15 +203,15 @@
         if isinstance(
                 clouds,
             (clouds.Lambda, clouds.SCP, clouds.Fluidstack, clouds.Paperspace)):
             # no need to install any cloud dependencies for lambda, scp,
             # fluidstack and paperspace
             continue
         if isinstance(cloud, clouds.AWS):
-            commands.append(f'echo -n "{prefix_str}AWS{empty_str}" && ' +
+            commands.append(f'echo -en "\\r{prefix_str}AWS{empty_str}" && ' +
                             aws_dependencies_installation)
         elif isinstance(cloud, clouds.Azure):
             commands.append(
                 f'echo -en "\\r{prefix_str}Azure{empty_str}" && '
                 'pip list | grep azure-cli > /dev/null 2>&1 || '
                 'pip install "azure-cli>=2.31.0" azure-core '
                 '"azure-identity>=1.13.0" azure-mgmt-network > /dev/null 2>&1')
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/dag_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/db_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/env_options.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/create_cluster.sh` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/create_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/delete_cluster.sh` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/generate_kind_config.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/generate_kind_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/generate_static_kubeconfig.sh` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/generate_static_kubeconfig.sh`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/gpu_labeler.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/gpu_labeler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/kubernetes_enums.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/kubernetes_enums.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/log_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/resources_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/rich_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/schemas.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/schemas.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/subprocess_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/timeline.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/ux_utils.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/sky/utils/validator.py` & `skypilot_nightly-1.0.0.dev20240529/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/PKG-INFO` & `skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20240527
+Version: 1.0.0.dev20240529
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/skypilot_nightly.egg-info/requires.txt` & `skypilot_nightly-1.0.0.dev20240529/skypilot_nightly.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_cli.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_config.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_jobs.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_jobs_and_serve.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_jobs_and_serve.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_list_accelerators.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_optimizer_dryruns.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_optimizer_random_dag.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_serve_autoscaler.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_smoke.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_smoke.py`

 * *Files 0% similar despite different names*

```diff
@@ -6140,7614 +6140,7633 @@
 00017fb0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
 00017fc0: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
 00017fd0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
 00017fe0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
 00017ff0: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
 00018000: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
 00018010: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
-00018020: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-00018030: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00018040: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
-00018050: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-00018060: 4e4e 494e 475c 7c53 5543 4345 4544 4544  NNING\|SUCCEEDED
-00018070: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00018080: 2020 2020 2020 2023 2054 4f44 4f28 7a68         # TODO(zh
-00018090: 7775 293a 2043 6861 6e67 6520 746f 205f  wu): Change to _
-000180a0: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
-000180b0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-000180c0: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
-000180d0: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
-000180e0: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
-000180f0: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
-00018100: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
-00018110: 642e 0a20 2020 2020 2020 2028 5f4a 4f42  d..        (_JOB
-00018120: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-00018130: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
-00018140: 6e61 6d65 7d2d 3127 2920 2b20 273b 2027  name}-1') + '; '
-00018150: 202b 0a20 2020 2020 2020 2020 5f4a 4f42   +.         _JOB
-00018160: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-00018170: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
-00018180: 6e61 6d65 7d2d 3227 2929 2c0a 2020 2020  name}-2')),.    
-00018190: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
-000181a0: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
-000181b0: 206a 6f62 7320 7175 6575 6520 2d72 2063   jobs queue -r c
-000181c0: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
-000181d0: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
-000181e0: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
-000181f0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00018200: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00018210: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00018220: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00018230: 7374 6163 6b20 2023 666c 7569 6473 7461  stack  #fluidsta
-00018240: 636b 2064 6f65 7320 6e6f 7420 7375 7070  ck does not supp
-00018250: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00018260: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00018270: 6e6f 5f61 7a75 7265 2020 2320 417a 7572  no_azure  # Azur
-00018280: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-00018290: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-000182a0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-000182b0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-000182c0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-000182d0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-000182e0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-000182f0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
-00018300: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
-00018310: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00018320: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00018330: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00018340: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-00018350: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00018360: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00018370: 7374 2e6d 6172 6b2e 6e6f 5f70 6170 6572  st.mark.no_paper
-00018380: 7370 6163 6520 2023 2050 6170 6572 7370  space  # Papersp
-00018390: 6163 6520 646f 6573 206e 6f74 2073 7570  ace does not sup
-000183a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-000183b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-000183c0: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
-000183d0: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
-000183e0: 7320 6e6f 7420 6861 7665 2061 206e 6f74  s not have a not
-000183f0: 696f 6e20 6f66 2073 706f 7420 696e 7374  ion of spot inst
-00018400: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00018410: 726b 2e6d 616e 6167 6564 5f6a 6f62 730a  rk.managed_jobs.
-00018420: 6465 6620 7465 7374 5f6a 6f62 5f70 6970  def test_job_pip
-00018430: 656c 696e 6528 6765 6e65 7269 635f 636c  eline(generic_cl
-00018440: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-00018450: 2222 5465 7374 2061 206a 6f62 2070 6970  ""Test a job pip
-00018460: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
-00018470: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00018480: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00018490: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000184a0: 2020 2773 706f 742d 7069 7065 6c69 6e65    'spot-pipeline
-000184b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000184c0: 2020 2020 2020 2020 2066 2773 6b79 206a           f'sky j
-000184d0: 6f62 7320 6c61 756e 6368 202d 6e20 7b6e  obs launch -n {n
-000184e0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-000184f0: 7961 6d6c 732f 7069 7065 6c69 6e65 2e79  yamls/pipeline.y
-00018500: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-00018510: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00018520: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018530: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-00018540: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00018550: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00018560: 7020 2253 5441 5254 494e 475c 7c52 554e  p "STARTING\|RUN
-00018570: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-00018580: 2020 2020 2320 6067 7265 7020 2d41 2034      # `grep -A 4
-00018590: 207b 6e61 6d65 7d60 2066 696e 6473 2074   {name}` finds t
-000185a0: 6865 206a 6f62 2077 6974 6820 7b6e 616d  he job with {nam
-000185b0: 657d 2061 6e64 2074 6865 2034 206c 696e  e} and the 4 lin
-000185c0: 6573 0a20 2020 2020 2020 2020 2020 2023  es.            #
-000185d0: 2061 6674 6572 2069 742c 2069 2e65 2e20   after it, i.e. 
-000185e0: 7468 6520 3420 7461 736b 7320 7769 7468  the 4 tasks with
-000185f0: 696e 2074 6865 206a 6f62 2e0a 2020 2020  in the job..    
-00018600: 2020 2020 2020 2020 2320 6073 6564 202d          # `sed -
-00018610: 6e20 3270 6020 6765 7473 2074 6865 2073  n 2p` gets the s
-00018620: 6563 6f6e 6420 6c69 6e65 206f 6620 7468  econd line of th
-00018630: 6520 3420 6c69 6e65 732c 2069 2e65 2e20  e 4 lines, i.e. 
-00018640: 7468 6520 6669 7273 740a 2020 2020 2020  the first.      
-00018650: 2020 2020 2020 2320 7461 736b 2077 6974        # task wit
-00018660: 6869 6e20 7468 6520 6a6f 622e 0a20 2020  hin the job..   
-00018670: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-00018680: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00018690: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-000186a0: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-000186b0: 2022 5354 4152 5449 4e47 5c7c 5255 4e4e   "STARTING\|RUNN
-000186c0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-000186d0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-000186e0: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-000186f0: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-00018700: 2033 7020 7c20 6772 6570 2022 5045 4e44   3p | grep "PEND
-00018710: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00018720: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
-00018730: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00018740: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
-00018750: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00018760: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-00018770: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-00018780: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-00018790: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-000187a0: 2032 7020 7c20 6772 6570 2022 4341 4e43   2p | grep "CANC
-000187b0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-000187c0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-000187d0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-000187e0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-000187f0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
-00018800: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00018810: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-00018820: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018830: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-00018840: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00018850: 616d 657d 7c20 7365 6420 2d6e 2034 7020  ame}| sed -n 4p 
-00018860: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
-00018870: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
-00018880: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018890: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
-000188a0: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
-000188b0: 657d 7c20 7365 6420 2d6e 2035 7020 7c20  e}| sed -n 5p | 
-000188c0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-000188d0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-000188e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000188f0: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
-00018900: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-00018910: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-00018920: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-00018930: 6e20 3270 207c 2067 7265 7020 2243 414e  n 2p | grep "CAN
-00018940: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-00018950: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
-00018960: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00018970: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00018980: 202d 6e20 3370 207c 2067 7265 7020 2243   -n 3p | grep "C
-00018990: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-000189a0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-000189b0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-000189c0: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-000189d0: 6564 202d 6e20 3470 207c 2067 7265 7020  ed -n 4p | grep 
-000189e0: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-000189f0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-00018a00: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-00018a10: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00018a20: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
-00018a30: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-00018a40: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00018a50: 2020 205f 4a4f 425f 4341 4e43 454c 5f57     _JOB_CANCEL_W
-00018a60: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00018a70: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
-00018a80: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
-00018a90: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
-00018aa0: 2073 6b79 206a 6f62 7320 7175 6575 6520   sky jobs queue 
-00018ab0: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
-00018ac0: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
-00018ad0: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
-00018ae0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-00018af0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00018b00: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00018b10: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00018b20: 6c75 6964 7374 6163 6b20 2023 666c 7569  luidstack  #flui
-00018b30: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
-00018b40: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00018b50: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00018b60: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
-00018b70: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
-00018b80: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00018b90: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00018ba0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-00018bb0: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-00018bc0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-00018bd0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00018be0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00018bf0: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
-00018c00: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-00018c10: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00018c20: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00018c30: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-00018c40: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00018c50: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00018c60: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
-00018c70: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
-00018c80: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
-00018c90: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00018ca0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00018cb0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-00018cc0: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
-00018cd0: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
-00018ce0: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
-00018cf0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00018d00: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
-00018d10: 6f62 730a 6465 6620 7465 7374 5f6d 616e  obs.def test_man
-00018d20: 6167 6564 5f6a 6f62 735f 6661 696c 6564  aged_jobs_failed
-00018d30: 5f73 6574 7570 2867 656e 6572 6963 5f63  _setup(generic_c
-00018d40: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00018d50: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-00018d60: 6a6f 6220 7769 7468 2066 6169 6c65 6420  job with failed 
-00018d70: 7365 7475 702e 2222 220a 2020 2020 6e61  setup.""".    na
-00018d80: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00018d90: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00018da0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00018db0: 2020 276d 616e 6167 6564 5f6a 6f62 735f    'managed_jobs_
-00018dc0: 6661 696c 6564 5f73 6574 7570 272c 0a20  failed_setup',. 
-00018dd0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00018de0: 2020 2020 2066 2773 6b79 206a 6f62 7320       f'sky jobs 
-00018df0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-00018e00: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00018e10: 635f 636c 6f75 647d 202d 7920 2d64 2074  c_cloud} -y -d t
-00018e20: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00018e30: 6661 696c 6564 5f73 6574 7570 2e79 616d  failed_setup.yam
-00018e40: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00018e50: 2773 6c65 6570 2033 3330 272c 0a20 2020  'sleep 330',.   
-00018e60: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
-00018e70: 7375 7265 2074 6865 206a 6f62 2066 6169  sure the job fai
-00018e80: 6c65 6420 7175 6963 6b6c 792e 0a20 2020  led quickly..   
-00018e90: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-00018ea0: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-00018eb0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-00018ec0: 6420 2d6e 3120 7c20 6772 6570 2022 4641  d -n1 | grep "FA
-00018ed0: 494c 4544 5f53 4554 5550 2227 2c0a 2020  ILED_SETUP"',.  
-00018ee0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00018ef0: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
-00018f00: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00018f10: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00018f20: 2023 2049 6e63 7265 6173 6520 7469 6d65   # Increase time
-00018f30: 6f75 7420 7369 6e63 6520 736b 7920 6a6f  out since sky jo
-00018f40: 6273 2071 7565 7565 202d 7220 6361 6e20  bs queue -r can 
-00018f50: 6265 2062 6c6f 636b 6564 2062 7920 6f74  be blocked by ot
-00018f60: 6865 7220 7370 6f74 2074 6573 7473 2e0a  her spot tests..
-00018f70: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00018f80: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00018f90: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00018fa0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00018fb0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00018fc0: 636b 2020 2366 6c75 6964 7374 6163 6b20  ck  #fluidstack 
-00018fd0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00018fe0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00018ff0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00019000: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
-00019010: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00019020: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00019030: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-00019040: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-00019050: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-00019060: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00019070: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00019080: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-00019090: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-000190a0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-000190b0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-000190c0: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-000190d0: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-000190e0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-000190f0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00019100: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
-00019110: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
-00019120: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00019130: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00019140: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00019150: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-00019160: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00019170: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-00019180: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-00019190: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-000191a0: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
-000191b0: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
-000191c0: 6273 5f70 6970 656c 696e 655f 6661 696c  bs_pipeline_fail
-000191d0: 6564 5f73 6574 7570 2867 656e 6572 6963  ed_setup(generic
-000191e0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-000191f0: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-00019200: 6420 6a6f 6220 7769 7468 2066 6169 6c65  d job with faile
-00019210: 6420 7365 7475 7020 666f 7220 6120 7069  d setup for a pi
-00019220: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
-00019230: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00019240: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00019250: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00019260: 2020 2027 6d61 6e61 6765 645f 6a6f 6273     'managed_jobs
-00019270: 5f70 6970 656c 696e 655f 6661 696c 6564  _pipeline_failed
-00019280: 5f73 6574 7570 272c 0a20 2020 2020 2020  _setup',.       
-00019290: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000192a0: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
-000192b0: 202d 6e20 7b6e 616d 657d 202d 7920 2d64   -n {name} -y -d
-000192c0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-000192d0: 732f 6661 696c 6564 5f73 6574 7570 5f70  s/failed_setup_p
-000192e0: 6970 656c 696e 652e 7961 6d6c 272c 0a20  ipeline.yaml',. 
-000192f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00019300: 7020 3630 3027 2c0a 2020 2020 2020 2020  p 600',.        
-00019310: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-00019320: 7468 6520 6a6f 6220 6661 696c 6564 2071  the job failed q
-00019330: 7569 636b 6c79 2e0a 2020 2020 2020 2020  uickly..        
-00019340: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-00019350: 455f 5741 4954 7d20 7c20 6772 6570 207b  E_WAIT} | grep {
-00019360: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00019370: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
-00019380: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
-00019390: 2020 2020 2023 2054 6173 6b20 3020 7368       # Task 0 sh
-000193a0: 6f75 6c64 2062 6520 5355 4343 4545 4445  ould be SUCCEEDE
-000193b0: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
-000193c0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-000193d0: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-000193e0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
-000193f0: 207c 2067 7265 7020 2253 5543 4345 4544   | grep "SUCCEED
-00019400: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00019410: 2020 2320 5461 736b 2031 2073 686f 756c    # Task 1 shoul
-00019420: 6420 6265 2046 4149 4c45 445f 5345 5455  d be FAILED_SETU
-00019430: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00019440: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-00019450: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-00019460: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
-00019470: 207c 2067 7265 7020 2246 4149 4c45 445f   | grep "FAILED_
-00019480: 5345 5455 5022 272c 0a20 2020 2020 2020  SETUP"',.       
-00019490: 2020 2020 2023 2054 6173 6b20 3220 7368       # Task 2 sh
-000194a0: 6f75 6c64 2062 6520 4341 4e43 454c 4c45  ould be CANCELLE
-000194b0: 442e 0a20 2020 2020 2020 2020 2020 2066  D..            f
-000194c0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-000194d0: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-000194e0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3470  name}| sed -n 4p
-000194f0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00019500: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00019510: 2020 2320 5461 736b 2033 2073 686f 756c    # Task 3 shoul
-00019520: 6420 6265 2043 414e 4345 4c4c 4544 2e0a  d be CANCELLED..
-00019530: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00019540: 4a4f 425f 5155 4555 455f 5741 4954 7d20  JOB_QUEUE_WAIT} 
-00019550: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
-00019560: 657d 7c20 7365 6420 2d6e 2035 7020 7c20  e}| sed -n 5p | 
-00019570: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-00019580: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00019590: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
-000195a0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-000195b0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-000195c0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
-000195d0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
-000195e0: 6b79 206a 6f62 7320 7175 6575 6520 2d72  ky jobs queue -r
-000195f0: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
-00019600: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
-00019610: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
-00019620: 656f 7574 3d33 3020 2a20 3630 2c0a 2020  eout=30 * 60,.  
-00019630: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00019640: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00019650: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00019660: 6720 6d61 6e61 6765 6420 6a6f 6220 7265  g managed job re
-00019670: 636f 7665 7279 202d 2d2d 2d2d 2d2d 2d2d  covery ---------
-00019680: 2d0a 0a0a 4070 7974 6573 742e 6d61 726b  -...@pytest.mark
-00019690: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
-000196a0: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
-000196b0: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
-000196c0: 6a6f 6273 5f72 6563 6f76 6572 795f 6177  jobs_recovery_aw
-000196d0: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
-000196e0: 696f 6e29 3a0a 2020 2020 2222 2254 6573  ion):.    """Tes
-000196f0: 7420 6d61 6e61 6765 6420 6a6f 6220 7265  t managed job re
-00019700: 636f 7665 7279 2e22 2222 0a20 2020 206e  covery.""".    n
-00019710: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00019720: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
-00019730: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-00019740: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-00019750: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00019760: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
-00019770: 616d 652c 206a 6f62 732e 4a4f 4253 5f43  ame, jobs.JOBS_C
-00019780: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
-00019790: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
-000197a0: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
-000197b0: 2020 2020 7265 6769 6f6e 203d 2061 7773      region = aws
-000197c0: 5f63 6f6e 6669 675f 7265 6769 6f6e 0a20  _config_region. 
-000197d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000197e0: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
-000197f0: 5f6a 6f62 735f 7265 636f 7665 7279 5f61  _jobs_recovery_a
-00019800: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
-00019810: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00019820: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
-00019830: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-00019840: 6e20 7b72 6567 696f 6e7d 202d 2d75 7365  n {region} --use
-00019850: 2d73 706f 7420 2d6e 207b 6e61 6d65 7d20  -spot -n {name} 
-00019860: 2265 6368 6f20 534b 5950 494c 4f54 5f54  "echo SKYPILOT_T
-00019870: 4153 4b5f 4944 3a20 5c24 534b 5950 494c  ASK_ID: \$SKYPIL
-00019880: 4f54 5f54 4153 4b5f 4944 3b20 736c 6565  OT_TASK_ID; slee
-00019890: 7020 3138 3030 2220 202d 7920 2d64 272c  p 1800"  -y -d',
-000198a0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000198b0: 6565 7020 3336 3027 2c0a 2020 2020 2020  eep 360',.      
-000198c0: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
-000198d0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-000198e0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-000198f0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00019900: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00019910: 2066 2752 554e 5f49 443d 2428 736b 7920   f'RUN_ID=$(sky 
-00019920: 6a6f 6273 206c 6f67 7320 2d6e 207b 6e61  jobs logs -n {na
-00019930: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
-00019940: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
-00019950: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
-00019960: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
-00019970: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
-00019980: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
-00019990: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000199a0: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-000199b0: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-000199c0: 2020 2020 2020 2020 2020 2020 2866 2761              (f'a
-000199d0: 7773 2065 6332 2074 6572 6d69 6e61 7465  ws ec2 terminate
-000199e0: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
-000199f0: 696f 6e20 7b72 6567 696f 6e7d 202d 2d69  ion {region} --i
-00019a00: 6e73 7461 6e63 652d 6964 7320 2428 270a  nstance-ids $('.
-00019a10: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
-00019a20: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-00019a30: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-00019a40: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-00019a50: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
-00019a60: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
-00019a70: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-00019a80: 2c56 616c 7565 733d 7b6e 616d 655f 6f6e  ,Values={name_on
-00019a90: 5f63 6c6f 7564 7d2a 2027 0a20 2020 2020  _cloud}* '.     
-00019aa0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-00019ab0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-00019ac0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-00019ad0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-00019ae0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-00019af0: 2074 6578 7429 2729 2c0a 2020 2020 2020   text)'),.      
-00019b00: 2020 2020 2020 2773 6c65 6570 2031 3030        'sleep 100
-00019b10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00019b20: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-00019b30: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00019b40: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00019b50: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
-00019b60: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00019b70: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00019b80: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
-00019b90: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00019ba0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00019bb0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00019bc0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00019bd0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
-00019be0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00019bf0: 6964 293b 2065 6368 6f20 2224 5255 4e5f  id); echo "$RUN_
-00019c00: 4944 223b 2073 6b79 206a 6f62 7320 6c6f  ID"; sky jobs lo
-00019c10: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-00019c20: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00019c30: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-00019c40: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
-00019c50: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-00019c60: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
-00019c70: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-00019c80: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
-00019c90: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00019ca0: 3520 2a20 3630 2c0a 2020 2020 290a 2020  5 * 60,.    ).  
-00019cb0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00019cc0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00019cd0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
-00019ce0: 6d61 726b 2e6d 616e 6167 6564 5f6a 6f62  mark.managed_job
-00019cf0: 730a 6465 6620 7465 7374 5f6d 616e 6167  s.def test_manag
-00019d00: 6564 5f6a 6f62 735f 7265 636f 7665 7279  ed_jobs_recovery
-00019d10: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
-00019d20: 6573 7420 6d61 6e61 6765 6420 6a6f 6220  est managed job 
-00019d30: 7265 636f 7665 7279 2e22 2222 0a20 2020  recovery.""".   
-00019d40: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00019d50: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00019d60: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
-00019d70: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
-00019d80: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
-00019d90: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
-00019da0: 206e 616d 652c 206a 6f62 732e 4a4f 4253   name, jobs.JOBS
-00019db0: 5f43 4c55 5354 4552 5f4e 414d 455f 5052  _CLUSTER_NAME_PR
-00019dc0: 4546 4958 5f4c 454e 4754 482c 2061 6464  EFIX_LENGTH, add
-00019dd0: 5f75 7365 725f 6861 7368 3d46 616c 7365  _user_hash=False
-00019de0: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
-00019df0: 2d65 6173 7434 2d62 270a 2020 2020 7175  -east4-b'.    qu
-00019e00: 6572 795f 636d 6420 3d20 280a 2020 2020  ery_cmd = (.    
-00019e10: 2020 2020 6627 6763 6c6f 7564 2063 6f6d      f'gcloud com
-00019e20: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-00019e30: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
-00019e40: 2020 2020 2020 2023 2060 3a60 206d 6561         # `:` mea
-00019e50: 6e73 2070 7265 6669 7820 6d61 7463 682e  ns prefix match.
-00019e60: 0a20 2020 2020 2020 2066 2722 286c 6162  .        f'"(lab
-00019e70: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
-00019e80: 6e61 6d65 3a7b 6e61 6d65 5f6f 6e5f 636c  name:{name_on_cl
-00019e90: 6f75 647d 2922 2027 0a20 2020 2020 2020  oud})" '.       
-00019ea0: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
-00019eb0: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
-00019ec0: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
-00019ed0: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
-00019ee0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-00019ef0: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
-00019f00: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
-00019f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019f20: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
-00019f30: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
-00019f40: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00019f50: 7428 0a20 2020 2020 2020 2027 6d61 6e61  t(.        'mana
-00019f60: 6765 645f 6a6f 6273 5f72 6563 6f76 6572  ged_jobs_recover
-00019f70: 795f 6763 7027 2c0a 2020 2020 2020 2020  y_gcp',.        
-00019f80: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00019f90: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
-00019fa0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-00019fb0: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
-00019fc0: 6d65 7d20 2d2d 7573 652d 7370 6f74 202d  me} --use-spot -
-00019fd0: 2d63 7075 7320 3220 2265 6368 6f20 534b  -cpus 2 "echo SK
-00019fe0: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-00019ff0: 5c24 534b 5950 494c 4f54 5f54 4153 4b5f  \$SKYPILOT_TASK_
-0001a000: 4944 3b20 736c 6565 7020 3138 3030 2220  ID; sleep 1800" 
-0001a010: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-0001a020: 2020 2020 2027 736c 6565 7020 3336 3027       'sleep 360'
-0001a030: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a040: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001a050: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001a060: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001a070: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0001a080: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0001a090: 443d 2428 736b 7920 6a6f 6273 206c 6f67  D=$(sky jobs log
-0001a0a0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0001a0b0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-0001a0c0: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-0001a0d0: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-0001a0e0: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-0001a0f0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-0001a100: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-0001a110: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-0001a120: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-0001a130: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-0001a140: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-0001a150: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
-0001a160: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-0001a170: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001a180: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001a190: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001a1a0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001a1b0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001a1c0: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
-0001a1d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001a1e0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001a1f0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001a200: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001a210: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0001a220: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0001a230: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
-0001a240: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
-0001a250: 6f20 2224 5255 4e5f 4944 223b 2073 6b79  o "$RUN_ID"; sky
-0001a260: 206a 6f62 7320 6c6f 6773 202d 6e20 7b6e   jobs logs -n {n
-0001a270: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-0001a280: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-0001a290: 5f54 4153 4b5f 4944 3a20 7c20 6772 6570  _TASK_ID: | grep
-0001a2a0: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
-0001a2b0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001a2c0: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
-0001a2d0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-0001a2e0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-0001a2f0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-0001a300: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001a310: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001a320: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-0001a330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-0001a340: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
-0001a350: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
-0001a360: 5f70 6970 656c 696e 655f 7265 636f 7665  _pipeline_recove
-0001a370: 7279 5f61 7773 2861 7773 5f63 6f6e 6669  ry_aws(aws_confi
-0001a380: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
-0001a390: 2222 5465 7374 206d 616e 6167 6564 206a  ""Test managed j
-0001a3a0: 6f62 2072 6563 6f76 6572 7920 666f 7220  ob recovery for 
-0001a3b0: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
-0001a3c0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001a3d0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001a3e0: 2020 7573 6572 5f68 6173 6820 3d20 636f    user_hash = co
-0001a3f0: 6d6d 6f6e 5f75 7469 6c73 2e67 6574 5f75  mmon_utils.get_u
-0001a400: 7365 725f 6861 7368 2829 0a20 2020 2075  ser_hash().    u
-0001a410: 7365 725f 6861 7368 203d 2075 7365 725f  ser_hash = user_
-0001a420: 6861 7368 5b3a 636f 6d6d 6f6e 5f75 7469  hash[:common_uti
-0001a430: 6c73 2e55 5345 525f 4841 5348 5f4c 454e  ls.USER_HASH_LEN
-0001a440: 4754 485f 494e 5f43 4c55 5354 4552 5f4e  GTH_IN_CLUSTER_N
-0001a450: 414d 455d 0a20 2020 2072 6567 696f 6e20  AME].    region 
-0001a460: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
-0001a470: 696f 6e0a 2020 2020 6966 2072 6567 696f  ion.    if regio
-0001a480: 6e20 213d 2027 7573 2d65 6173 742d 3227  n != 'us-east-2'
-0001a490: 3a0a 2020 2020 2020 2020 7079 7465 7374  :.        pytest
-0001a4a0: 2e73 6b69 7028 274f 6e6c 7920 7275 6e20  .skip('Only run 
-0001a4b0: 7370 6f74 2070 6970 656c 696e 6520 7265  spot pipeline re
-0001a4c0: 636f 7665 7279 2074 6573 7420 696e 2075  covery test in u
-0001a4d0: 732d 6561 7374 2d32 2729 0a20 2020 2074  s-east-2').    t
-0001a4e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001a4f0: 2020 2020 276d 616e 6167 6564 5f6a 6f62      'managed_job
-0001a500: 735f 7069 7065 6c69 6e65 5f72 6563 6f76  s_pipeline_recov
-0001a510: 6572 795f 6177 7327 2c0a 2020 2020 2020  ery_aws',.      
-0001a520: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001a530: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
-0001a540: 6820 2d6e 207b 6e61 6d65 7d20 7465 7374  h -n {name} test
-0001a550: 732f 7465 7374 5f79 616d 6c73 2f70 6970  s/test_yamls/pip
-0001a560: 656c 696e 655f 6177 732e 7961 6d6c 2020  eline_aws.yaml  
-0001a570: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0001a580: 2020 2020 2773 6c65 6570 2034 3030 272c      'sleep 400',
-0001a590: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001a5a0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
-0001a5b0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001a5c0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001a5d0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-0001a5e0: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-0001a5f0: 3d24 2873 6b79 206a 6f62 7320 6c6f 6773  =$(sky jobs logs
-0001a600: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-0001a610: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-0001a620: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-0001a630: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-0001a640: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-0001a650: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-0001a660: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-0001a670: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
-0001a680: 2428 736b 7920 6a6f 6273 206c 6f67 7320  $(sky jobs logs 
-0001a690: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-0001a6a0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
-0001a6b0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
-0001a6c0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
-0001a6d0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
-0001a6e0: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
-0001a6f0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 7327  /{name}-run-ids'
-0001a700: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0001a710: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-0001a720: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-0001a730: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0001a740: 6520 6063 6174 202e 2e2e 7c20 7265 7660  e `cat ...| rev`
-0001a750: 2069 7320 746f 2072 6574 7269 6576 6520   is to retrieve 
-0001a760: 7468 6520 6a6f 625f 6964 2066 726f 6d20  the job_id from 
-0001a770: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0001a780: 2320 534b 5950 494c 4f54 5f54 4153 4b5f  # SKYPILOT_TASK_
-0001a790: 4944 2c20 7768 6963 6820 6765 7473 2074  ID, which gets t
-0001a7a0: 6865 2073 6563 6f6e 6420 746f 206c 6173  he second to las
-0001a7b0: 7420 6669 656c 640a 2020 2020 2020 2020  t field.        
-0001a7c0: 2020 2020 2320 7365 7061 7261 7465 6420      # separated 
-0001a7d0: 6279 2060 2d60 2e0a 2020 2020 2020 2020  by `-`..        
-0001a7e0: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
-0001a7f0: 2020 2020 2020 6627 4d41 4e41 4745 445f        f'MANAGED_
-0001a800: 4a4f 425f 4944 3d60 6361 7420 2f74 6d70  JOB_ID=`cat /tmp
-0001a810: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 207c  /{name}-run-id |
-0001a820: 2072 6576 207c 2027 0a20 2020 2020 2020   rev | '.       
-0001a830: 2020 2020 2020 2020 2027 6375 7420 2d64           'cut -d
-0001a840: 5c27 5f5c 2720 2d66 3120 7c20 7265 7620  \'_\' -f1 | rev 
-0001a850: 7c20 6375 7420 2d64 5c27 2d5c 2720 2d66  | cut -d\'-\' -f
-0001a860: 3160 3b27 0a20 2020 2020 2020 2020 2020  1`;'.           
-0001a870: 2020 2020 2066 2761 7773 2065 6332 2074       f'aws ec2 t
-0001a880: 6572 6d69 6e61 7465 2d69 6e73 7461 6e63  erminate-instanc
-0001a890: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-0001a8a0: 696f 6e7d 202d 2d69 6e73 7461 6e63 652d  ion} --instance-
-0001a8b0: 6964 7320 2428 270a 2020 2020 2020 2020  ids $('.        
-0001a8c0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-0001a8d0: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-0001a8e0: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-0001a8f0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-0001a900: 2020 2020 2020 2020 2023 2054 4f44 4f28           # TODO(
-0001a910: 7a68 7775 293a 2066 6978 2074 6865 206e  zhwu): fix the n
-0001a920: 616d 6520 666f 7220 7370 6f74 2063 6c75  ame for spot clu
-0001a930: 7374 6572 2e0a 2020 2020 2020 2020 2020  ster..          
-0001a940: 2020 2020 2020 272d 2d66 696c 7465 7273        '--filters
-0001a950: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
-0001a960: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
-0001a970: 733d 2a2d 247b 4d41 4e41 4745 445f 4a4f  s=*-${MANAGED_JO
-0001a980: 425f 4944 7d27 0a20 2020 2020 2020 2020  B_ID}'.         
-0001a990: 2020 2020 2020 2066 272d 7b75 7365 725f         f'-{user_
-0001a9a0: 6861 7368 7d20 270a 2020 2020 2020 2020  hash} '.        
-0001a9b0: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-0001a9c0: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-0001a9d0: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-0001a9e0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-0001a9f0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
-0001aa00: 7075 7420 7465 7874 2927 292c 0a20 2020  put text)'),.   
-0001aa10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001aa20: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
-0001aa30: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
-0001aa40: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-0001aa50: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-0001aa60: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-0001aa70: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001aa80: 2773 6c65 6570 2032 3030 272c 0a20 2020  'sleep 200',.   
-0001aa90: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001aaa0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001aab0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0001aac0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-0001aad0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-0001aae0: 2020 2020 6627 5255 4e5f 4944 3d24 2863      f'RUN_ID=$(c
-0001aaf0: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-0001ab00: 756e 2d69 6429 3b20 6563 686f 2024 5255  un-id); echo $RU
-0001ab10: 4e5f 4944 3b20 736b 7920 6a6f 6273 206c  N_ID; sky jobs l
-0001ab20: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-0001ab30: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-0001ab40: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-0001ab50: 443a 207c 2067 7265 7020 2224 5255 4e5f  D: | grep "$RUN_
-0001ab60: 4944 2227 2c0a 2020 2020 2020 2020 2020  ID"',.          
-0001ab70: 2020 6627 5255 4e5f 4944 533d 2428 736b    f'RUN_IDS=$(sk
-0001ab80: 7920 6a6f 6273 206c 6f67 7320 2d6e 207b  y jobs logs -n {
-0001ab90: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
-0001aba0: 7720 7c20 6772 6570 202d 4120 3420 534b  w | grep -A 4 SK
-0001abb0: 5950 494c 4f54 5f54 4153 4b5f 4944 5320  YPILOT_TASK_IDS 
-0001abc0: 7c20 6375 7420 2d64 2229 2220 2d66 3229  | cut -d")" -f2)
-0001abd0: 3b20 6563 686f 2022 2452 554e 5f49 4453  ; echo "$RUN_IDS
-0001abe0: 2220 7c20 7465 6520 2f74 6d70 2f7b 6e61  " | tee /tmp/{na
-0001abf0: 6d65 7d2d 7275 6e2d 6964 732d 6e65 7727  me}-run-ids-new'
-0001ac00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001ac10: 6469 6666 202f 746d 702f 7b6e 616d 657d  diff /tmp/{name}
-0001ac20: 2d72 756e 2d69 6473 202f 746d 702f 7b6e  -run-ids /tmp/{n
-0001ac30: 616d 657d 2d72 756e 2d69 6473 2d6e 6577  ame}-run-ids-new
-0001ac40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001ac50: 2763 6174 202f 746d 702f 7b6e 616d 657d  'cat /tmp/{name}
-0001ac60: 2d72 756e 2d69 6473 207c 2073 6564 202d  -run-ids | sed -
-0001ac70: 6e20 3270 207c 2067 7265 7020 6063 6174  n 2p | grep `cat
-0001ac80: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0001ac90: 2d69 6460 272c 0a20 2020 2020 2020 205d  -id`',.        ]
-0001aca0: 2c0a 2020 2020 2020 2020 5f4a 4f42 5f43  ,.        _JOB_C
-0001acb0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001acc0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-0001acd0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001ace0: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
-0001acf0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001ad00: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001ad10: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
-0001ad20: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-0001ad30: 6a6f 6273 0a64 6566 2074 6573 745f 6d61  jobs.def test_ma
-0001ad40: 6e61 6765 645f 6a6f 6273 5f70 6970 656c  naged_jobs_pipel
-0001ad50: 696e 655f 7265 636f 7665 7279 5f67 6370  ine_recovery_gcp
-0001ad60: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-0001ad70: 6d61 6e61 6765 6420 6a6f 6220 7265 636f  managed job reco
-0001ad80: 7665 7279 2066 6f72 2061 2070 6970 656c  very for a pipel
-0001ad90: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
-0001ada0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0001adb0: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
-0001adc0: 3d20 2775 732d 6561 7374 342d 6227 0a20  = 'us-east4-b'. 
-0001add0: 2020 2075 7365 725f 6861 7368 203d 2063     user_hash = c
-0001ade0: 6f6d 6d6f 6e5f 7574 696c 732e 6765 745f  ommon_utils.get_
-0001adf0: 7573 6572 5f68 6173 6828 290a 2020 2020  user_hash().    
-0001ae00: 7573 6572 5f68 6173 6820 3d20 7573 6572  user_hash = user
-0001ae10: 5f68 6173 685b 3a63 6f6d 6d6f 6e5f 7574  _hash[:common_ut
-0001ae20: 696c 732e 5553 4552 5f48 4153 485f 4c45  ils.USER_HASH_LE
-0001ae30: 4e47 5448 5f49 4e5f 434c 5553 5445 525f  NGTH_IN_CLUSTER_
-0001ae40: 4e41 4d45 5d0a 2020 2020 7175 6572 795f  NAME].    query_
-0001ae50: 636d 6420 3d20 280a 2020 2020 2020 2020  cmd = (.        
-0001ae60: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-0001ae70: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
-0001ae80: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
-0001ae90: 2020 6627 2228 6c61 6265 6c73 2e72 6179    f'"(labels.ray
-0001aea0: 2d63 6c75 7374 6572 2d6e 616d 653a 2a2d  -cluster-name:*-
-0001aeb0: 247b 7b4d 414e 4147 4544 5f4a 4f42 5f49  ${{MANAGED_JOB_I
-0001aec0: 447d 7d2d 7b75 7365 725f 6861 7368 7d29  D}}-{user_hash})
-0001aed0: 2220 270a 2020 2020 2020 2020 6627 2d2d  " '.        f'--
-0001aee0: 7a6f 6e65 733d 7b7a 6f6e 657d 202d 2d66  zones={zone} --f
-0001aef0: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
-0001af00: 6529 2227 290a 2020 2020 7465 726d 696e  e)"').    termin
-0001af10: 6174 655f 636d 6420 3d20 2866 2767 636c  ate_cmd = (f'gcl
-0001af20: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-0001af30: 616e 6365 7320 6465 6c65 7465 202d 2d7a  ances delete --z
-0001af40: 6f6e 653d 7b7a 6f6e 657d 270a 2020 2020  one={zone}'.    
-0001af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af60: 2066 2720 2d2d 7175 6965 7420 2428 7b71   f' --quiet $({q
-0001af70: 7565 7279 5f63 6d64 7d29 2729 0a20 2020  uery_cmd})').   
-0001af80: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001af90: 2020 2020 2020 276d 616e 6167 6564 5f6a        'managed_j
-0001afa0: 6f62 735f 7069 7065 6c69 6e65 5f72 6563  obs_pipeline_rec
-0001afb0: 6f76 6572 795f 6763 7027 2c0a 2020 2020  overy_gcp',.    
-0001afc0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001afd0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001afe0: 6e63 6820 2d6e 207b 6e61 6d65 7d20 7465  nch -n {name} te
-0001aff0: 7374 732f 7465 7374 5f79 616d 6c73 2f70  sts/test_yamls/p
-0001b000: 6970 656c 696e 655f 6763 702e 7961 6d6c  ipeline_gcp.yaml
-0001b010: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-0001b020: 2020 2020 2020 2773 6c65 6570 2034 3030        'sleep 400
-0001b030: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001b040: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001b050: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001b060: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001b070: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-0001b080: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-0001b090: 4944 3d24 2873 6b79 206a 6f62 7320 6c6f  ID=$(sky jobs lo
-0001b0a0: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-0001b0b0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-0001b0c0: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-0001b0d0: 3a20 7c20 6375 7420 2d64 3a20 2d66 3229  : | cut -d: -f2)
-0001b0e0: 3b20 6563 686f 2022 2452 554e 5f49 4422  ; echo "$RUN_ID"
-0001b0f0: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
-0001b100: 657d 2d72 756e 2d69 6427 2c0a 2020 2020  e}-run-id',.    
-0001b110: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-0001b120: 533d 2428 736b 7920 6a6f 6273 206c 6f67  S=$(sky jobs log
-0001b130: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0001b140: 2d66 6f6c 6c6f 7720 7c20 6772 6570 202d  -follow | grep -
-0001b150: 4120 3420 534b 5950 494c 4f54 5f54 4153  A 4 SKYPILOT_TAS
-0001b160: 4b5f 4944 5320 7c20 6375 7420 2d64 2229  K_IDS | cut -d")
-0001b170: 2220 2d66 3229 3b20 6563 686f 2022 2452  " -f2); echo "$R
-0001b180: 554e 5f49 4453 2220 7c20 7465 6520 2f74  UN_IDS" | tee /t
-0001b190: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-0001b1a0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0001b1b0: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
-0001b1c0: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
-0001b1d0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0001b1e0: 5468 6520 6063 6174 202e 2e2e 7c20 7265  The `cat ...| re
-0001b1f0: 7660 2069 7320 746f 2072 6574 7269 6576  v` is to retriev
-0001b200: 6520 7468 6520 6a6f 625f 6964 2066 726f  e the job_id fro
-0001b210: 6d20 7468 650a 2020 2020 2020 2020 2020  m the.          
-0001b220: 2020 2320 534b 5950 494c 4f54 5f54 4153    # SKYPILOT_TAS
-0001b230: 4b5f 4944 2c20 7768 6963 6820 6765 7473  K_ID, which gets
-0001b240: 2074 6865 2073 6563 6f6e 6420 746f 206c   the second to l
-0001b250: 6173 7420 6669 656c 640a 2020 2020 2020  ast field.      
-0001b260: 2020 2020 2020 2320 7365 7061 7261 7465        # separate
-0001b270: 6420 6279 2060 2d60 2e0a 2020 2020 2020  d by `-`..      
-0001b280: 2020 2020 2020 2866 274d 414e 4147 4544        (f'MANAGED
-0001b290: 5f4a 4f42 5f49 443d 6063 6174 202f 746d  _JOB_ID=`cat /tm
-0001b2a0: 702f 7b6e 616d 657d 2d72 756e 2d69 6420  p/{name}-run-id 
-0001b2b0: 7c20 7265 7620 7c20 270a 2020 2020 2020  | rev | '.      
-0001b2c0: 2020 2020 2020 2066 2763 7574 202d 645c         f'cut -d\
-0001b2d0: 275f 5c27 202d 6631 207c 2072 6576 207c  '_\' -f1 | rev |
-0001b2e0: 2063 7574 202d 645c 272d 5c27 202d 6631   cut -d\'-\' -f1
-0001b2f0: 603b 207b 7465 726d 696e 6174 655f 636d  `; {terminate_cm
-0001b300: 647d 2729 2c0a 2020 2020 2020 2020 2020  d}'),.          
-0001b310: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-0001b320: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001b330: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001b340: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001b350: 6420 2d6e 3120 7c20 6772 6570 2022 5245  d -n1 | grep "RE
-0001b360: 434f 5645 5249 4e47 2227 2c0a 2020 2020  COVERING"',.    
-0001b370: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-0001b380: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-0001b390: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
-0001b3a0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001b3b0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0001b3c0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
-0001b3d0: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-0001b3e0: 4e5f 4944 3d24 2863 6174 202f 746d 702f  N_ID=$(cat /tmp/
-0001b3f0: 7b6e 616d 657d 2d72 756e 2d69 6429 3b20  {name}-run-id); 
-0001b400: 6563 686f 2024 5255 4e5f 4944 3b20 736b  echo $RUN_ID; sk
-0001b410: 7920 6a6f 6273 206c 6f67 7320 2d6e 207b  y jobs logs -n {
-0001b420: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
-0001b430: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
-0001b440: 545f 5441 534b 5f49 443a 207c 2067 7265  T_TASK_ID: | gre
-0001b450: 7020 2224 5255 4e5f 4944 2227 2c0a 2020  p "$RUN_ID"',.  
-0001b460: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-0001b470: 4944 533d 2428 736b 7920 6a6f 6273 206c  IDS=$(sky jobs l
-0001b480: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-0001b490: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-0001b4a0: 202d 4120 3420 534b 5950 494c 4f54 5f54   -A 4 SKYPILOT_T
-0001b4b0: 4153 4b5f 4944 5320 7c20 6375 7420 2d64  ASK_IDS | cut -d
-0001b4c0: 2229 2220 2d66 3229 3b20 6563 686f 2022  ")" -f2); echo "
-0001b4d0: 2452 554e 5f49 4453 2220 7c20 7465 6520  $RUN_IDS" | tee 
-0001b4e0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-0001b4f0: 6964 732d 6e65 7727 2c0a 2020 2020 2020  ids-new',.      
-0001b500: 2020 2020 2020 6627 6469 6666 202f 746d        f'diff /tm
-0001b510: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-0001b520: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0001b530: 2d69 6473 2d6e 6577 272c 0a20 2020 2020  -ids-new',.     
-0001b540: 2020 2020 2020 2066 2763 6174 202f 746d         f'cat /tm
-0001b550: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-0001b560: 207c 2073 6564 202d 6e20 3270 207c 2067   | sed -n 2p | g
-0001b570: 7265 7020 6063 6174 202f 746d 702f 7b6e  rep `cat /tmp/{n
-0001b580: 616d 657d 2d72 756e 2d69 6460 272c 0a20  ame}-run-id`',. 
-0001b590: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001b5a0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
-0001b5b0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001b5c0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001b5d0: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
-0001b5e0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0001b5f0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001b600: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-0001b610: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-0001b620: 466c 7569 6473 7461 636b 2064 6f65 7320  Fluidstack does 
-0001b630: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0001b640: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0001b650: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
-0001b660: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-0001b670: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001b680: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001b690: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-0001b6a0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-0001b6b0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-0001b6c0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-0001b6d0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0001b6e0: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-0001b6f0: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
-0001b700: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001b710: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001b720: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-0001b730: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-0001b740: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001b750: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001b760: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
-0001b770: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
-0001b780: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-0001b790: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0001b7a0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-0001b7b0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-0001b7c0: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
-0001b7d0: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
-0001b7e0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001b7f0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001b800: 6564 5f6a 6f62 730a 6465 6620 7465 7374  ed_jobs.def test
-0001b810: 5f6d 616e 6167 6564 5f6a 6f62 735f 7265  _managed_jobs_re
-0001b820: 636f 7665 7279 5f64 6566 6175 6c74 5f72  covery_default_r
-0001b830: 6573 6f75 7263 6573 2867 656e 6572 6963  esources(generic
-0001b840: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-0001b850: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-0001b860: 6420 6a6f 6220 7265 636f 7665 7279 2066  d job recovery f
-0001b870: 6f72 2064 6566 6175 6c74 2072 6573 6f75  or default resou
-0001b880: 7263 6573 2e22 2222 0a20 2020 206e 616d  rces.""".    nam
-0001b890: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0001b8a0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0001b8b0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001b8c0: 2027 6d61 6e61 6765 642d 7370 6f74 2d72   'managed-spot-r
-0001b8d0: 6563 6f76 6572 792d 6465 6661 756c 742d  ecovery-default-
-0001b8e0: 7265 736f 7572 6365 7327 2c0a 2020 2020  resources',.    
-0001b8f0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001b900: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001b910: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
-0001b920: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0001b930: 6c6f 7564 7d20 2d2d 7573 652d 7370 6f74  loud} --use-spot
-0001b940: 2022 736c 6565 7020 3330 2026 2620 7375   "sleep 30 && su
-0001b950: 646f 2073 6875 7464 6f77 6e20 6e6f 7720  do shutdown now 
-0001b960: 2626 2073 6c65 6570 2031 3030 3022 202d  && sleep 1000" -
-0001b970: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-0001b980: 2020 2027 736c 6565 7020 3336 3027 2c0a     'sleep 360',.
-0001b990: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001b9a0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-0001b9b0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001b9c0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001b9d0: 5255 4e4e 494e 475c 7c52 4543 4f56 4552  RUNNING\|RECOVER
-0001b9e0: 494e 4722 272c 0a20 2020 2020 2020 205d  ING"',.        ]
-0001b9f0: 2c0a 2020 2020 2020 2020 5f4a 4f42 5f43  ,.        _JOB_C
-0001ba00: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001ba10: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-0001ba20: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001ba30: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
-0001ba40: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001ba50: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001ba60: 742e 6d61 726b 2e61 7773 0a40 7079 7465  t.mark.aws.@pyte
-0001ba70: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-0001ba80: 6a6f 6273 0a64 6566 2074 6573 745f 6d61  jobs.def test_ma
-0001ba90: 6e61 6765 645f 6a6f 6273 5f72 6563 6f76  naged_jobs_recov
-0001baa0: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
-0001bab0: 7773 2861 7773 5f63 6f6e 6669 675f 7265  ws(aws_config_re
-0001bac0: 6769 6f6e 293a 0a20 2020 2022 2222 5465  gion):.    """Te
-0001bad0: 7374 206d 616e 6167 6564 206a 6f62 2072  st managed job r
-0001bae0: 6563 6f76 6572 792e 2222 220a 2020 2020  ecovery.""".    
-0001baf0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001bb00: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-0001bb10: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-0001bb20: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001bb30: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001bb40: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001bb50: 6e61 6d65 2c20 6a6f 6273 2e4a 4f42 535f  name, jobs.JOBS_
-0001bb60: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
-0001bb70: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
-0001bb80: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
-0001bb90: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
-0001bba0: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
-0001bbb0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001bbc0: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
-0001bbd0: 645f 6a6f 6273 5f72 6563 6f76 6572 795f  d_jobs_recovery_
-0001bbe0: 6d75 6c74 695f 6e6f 6465 5f61 7773 272c  multi_node_aws',
-0001bbf0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001bc00: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001bc10: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
-0001bc20: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001bc30: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001bc40: 202d 2d75 7365 2d73 706f 7420 2d2d 6e75   --use-spot --nu
-0001bc50: 6d2d 6e6f 6465 7320 3220 2265 6368 6f20  m-nodes 2 "echo 
-0001bc60: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-0001bc70: 3a20 5c24 534b 5950 494c 4f54 5f54 4153  : \$SKYPILOT_TAS
-0001bc80: 4b5f 4944 3b20 736c 6565 7020 3138 3030  K_ID; sleep 1800
-0001bc90: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
-0001bca0: 2020 2020 2020 2027 736c 6565 7020 3435         'sleep 45
-0001bcb0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001bcc0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001bcd0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001bce0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001bcf0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-0001bd00: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-0001bd10: 5f49 443d 2428 736b 7920 6a6f 6273 206c  _ID=$(sky jobs l
-0001bd20: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-0001bd30: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-0001bd40: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-0001bd50: 4420 7c20 6375 7420 2d64 3a20 2d66 3229  D | cut -d: -f2)
-0001bd60: 3b20 6563 686f 2022 2452 554e 5f49 4422  ; echo "$RUN_ID"
-0001bd70: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
-0001bd80: 657d 2d72 756e 2d69 6427 2c0a 2020 2020  e}-run-id',.    
-0001bd90: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
-0001bda0: 6174 6520 7468 6520 776f 726b 6572 206d  ate the worker m
-0001bdb0: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
-0001bdc0: 2020 2020 2028 6627 6177 7320 6563 3220       (f'aws ec2 
-0001bdd0: 7465 726d 696e 6174 652d 696e 7374 616e  terminate-instan
-0001bde0: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
-0001bdf0: 6769 6f6e 7d20 2d2d 696e 7374 616e 6365  gion} --instance
-0001be00: 2d69 6473 2024 2827 0a20 2020 2020 2020  -ids $('.       
-0001be10: 2020 2020 2020 6627 6177 7320 6563 3220        f'aws ec2 
-0001be20: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
-0001be30: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-0001be40: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-0001be50: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
-0001be60: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
-0001be70: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
-0001be80: 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  ={name_on_cloud}
-0001be90: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
-0001bea0: 2027 4e61 6d65 3d74 6167 3a72 6179 2d6e   'Name=tag:ray-n
-0001beb0: 6f64 652d 7479 7065 2c56 616c 7565 733d  ode-type,Values=
-0001bec0: 776f 726b 6572 2027 0a20 2020 2020 2020  worker '.       
-0001bed0: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-0001bee0: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
-0001bef0: 6e73 7461 6e63 6573 5b5d 2e49 6e73 7461  nstances[].Insta
-0001bf00: 6e63 6549 6420 270a 2020 2020 2020 2020  nceId '.        
-0001bf10: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
-0001bf20: 6578 7429 2729 2c0a 2020 2020 2020 2020  ext)'),.        
-0001bf30: 2020 2020 2773 6c65 6570 2035 3027 2c0a      'sleep 50',.
-0001bf40: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001bf50: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-0001bf60: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001bf70: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001bf80: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-0001bf90: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0001bfa0: 2035 3630 272c 0a20 2020 2020 2020 2020   560',.         
-0001bfb0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-0001bfc0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001bfd0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001bfe0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-0001bff0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c000: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-0001c010: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-0001c020: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-0001c030: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
-0001c040: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-0001c050: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-0001c060: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
-0001c070: 7420 2d64 3a20 2d66 3220 7c20 6772 6570  t -d: -f2 | grep
-0001c080: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
-0001c090: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0001c0a0: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
-0001c0b0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-0001c0c0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-0001c0d0: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
-0001c0e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001c0f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001c100: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0001c110: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-0001c120: 6e61 6765 645f 6a6f 6273 0a64 6566 2074  naged_jobs.def t
-0001c130: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
-0001c140: 5f72 6563 6f76 6572 795f 6d75 6c74 695f  _recovery_multi_
-0001c150: 6e6f 6465 5f67 6370 2829 3a0a 2020 2020  node_gcp():.    
-0001c160: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-0001c170: 6a6f 6220 7265 636f 7665 7279 2e22 2222  job recovery."""
-0001c180: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001c190: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001c1a0: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
-0001c1b0: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001c1c0: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001c1d0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001c1e0: 2020 2020 206e 616d 652c 206a 6f62 732e       name, jobs.
-0001c1f0: 4a4f 4253 5f43 4c55 5354 4552 5f4e 414d  JOBS_CLUSTER_NAM
-0001c200: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
-0001c210: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
-0001c220: 616c 7365 290a 2020 2020 7a6f 6e65 203d  alse).    zone =
-0001c230: 2027 7573 2d77 6573 7432 2d61 270a 2020   'us-west2-a'.  
-0001c240: 2020 2320 5573 6520 273a 2720 746f 206d    # Use ':' to m
-0001c250: 6174 6368 2061 7320 7468 6520 636c 7573  atch as the clus
-0001c260: 7465 7220 6e61 6d65 2077 696c 6c20 636f  ter name will co
-0001c270: 6e74 6169 6e20 7468 6520 7375 6666 6978  ntain the suffix
-0001c280: 2077 6974 6820 6a6f 6220 6964 0a20 2020   with job id.   
-0001c290: 2071 7565 7279 5f63 6d64 203d 2028 0a20   query_cmd = (. 
-0001c2a0: 2020 2020 2020 2066 2767 636c 6f75 6420         f'gcloud 
-0001c2b0: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-0001c2c0: 7320 6c69 7374 202d 2d66 696c 7465 723d  s list --filter=
-0001c2d0: 270a 2020 2020 2020 2020 6627 2228 6c61  '.        f'"(la
-0001c2e0: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
-0001c2f0: 2d6e 616d 653a 7b6e 616d 655f 6f6e 5f63  -name:{name_on_c
-0001c300: 6c6f 7564 7d20 414e 4420 270a 2020 2020  loud} AND '.    
-0001c310: 2020 2020 6627 6c61 6265 6c73 2e72 6179      f'labels.ray
-0001c320: 2d6e 6f64 652d 7479 7065 3d77 6f72 6b65  -node-type=worke
-0001c330: 7229 2220 2d2d 7a6f 6e65 733d 7b7a 6f6e  r)" --zones={zon
-0001c340: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
-0001c350: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
-0001c360: 7465 726d 696e 6174 655f 636d 6420 3d20  terminate_cmd = 
-0001c370: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
-0001c380: 6520 696e 7374 616e 6365 7320 6465 6c65  e instances dele
-0001c390: 7465 202d 2d7a 6f6e 653d 7b7a 6f6e 657d  te --zone={zone}
-0001c3a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001c3b0: 2020 2020 2020 2066 2720 2d2d 7175 6965         f' --quie
-0001c3c0: 7420 2428 7b71 7565 7279 5f63 6d64 7d29  t $({query_cmd})
-0001c3d0: 2729 0a20 2020 2074 6573 7420 3d20 5465  ').    test = Te
-0001c3e0: 7374 280a 2020 2020 2020 2020 276d 616e  st(.        'man
-0001c3f0: 6167 6564 5f6a 6f62 735f 7265 636f 7665  aged_jobs_recove
-0001c400: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
-0001c410: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-0001c420: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001c430: 6a6f 6273 206c 6175 6e63 6820 2d2d 636c  jobs launch --cl
-0001c440: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
-0001c450: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
-0001c460: 2d2d 7573 652d 7370 6f74 202d 2d6e 756d  --use-spot --num
-0001c470: 2d6e 6f64 6573 2032 2022 6563 686f 2053  -nodes 2 "echo S
-0001c480: 4b59 5049 4c4f 545f 5441 534b 5f49 443a  KYPILOT_TASK_ID:
-0001c490: 205c 2453 4b59 5049 4c4f 545f 5441 534b   \$SKYPILOT_TASK
-0001c4a0: 5f49 443b 2073 6c65 6570 2031 3830 3022  _ID; sleep 1800"
-0001c4b0: 2020 2d79 202d 6427 2c0a 2020 2020 2020    -y -d',.      
-0001c4c0: 2020 2020 2020 2773 6c65 6570 2034 3030        'sleep 400
-0001c4d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001c4e0: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001c4f0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001c500: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001c510: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-0001c520: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
-0001c530: 4944 3d24 2873 6b79 206a 6f62 7320 6c6f  ID=$(sky jobs lo
-0001c540: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-0001c550: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-0001c560: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-0001c570: 207c 2063 7574 202d 643a 202d 6632 293b   | cut -d: -f2);
-0001c580: 2065 6368 6f20 2224 5255 4e5f 4944 2220   echo "$RUN_ID" 
-0001c590: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
-0001c5a0: 7d2d 7275 6e2d 6964 272c 0a20 2020 2020  }-run-id',.     
-0001c5b0: 2020 2020 2020 2023 2054 6572 6d69 6e61         # Termina
-0001c5c0: 7465 2074 6865 2077 6f72 6b65 7220 6d61  te the worker ma
-0001c5d0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-0001c5e0: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-0001c5f0: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
-0001c600: 736c 6565 7020 3530 272c 0a20 2020 2020  sleep 50',.     
-0001c610: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
-0001c620: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0001c630: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-0001c640: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-0001c650: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-0001c660: 2020 2020 2027 736c 6565 7020 3432 3027       'sleep 420'
-0001c670: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c680: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001c690: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001c6a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001c6b0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0001c6c0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0001c6d0: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
-0001c6e0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
-0001c6f0: 6f20 2452 554e 5f49 443b 2073 6b79 206a  o $RUN_ID; sky j
-0001c700: 6f62 7320 6c6f 6773 202d 6e20 7b6e 616d  obs logs -n {nam
-0001c710: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
-0001c720: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
-0001c730: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
-0001c740: 202d 6632 207c 2067 7265 7020 2224 5255   -f2 | grep "$RU
-0001c750: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
-0001c760: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
-0001c770: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-0001c780: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-0001c790: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-0001c7a0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
-0001c7b0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001c7c0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001c7d0: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
-0001c7e0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0001c7f0: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
-0001c800: 616e 6167 6564 5f6a 6f62 735f 6361 6e63  anaged_jobs_canc
-0001c810: 656c 6c61 7469 6f6e 5f61 7773 2861 7773  ellation_aws(aws
-0001c820: 5f63 6f6e 6669 675f 7265 6769 6f6e 293a  _config_region):
-0001c830: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001c840: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001c850: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
-0001c860: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
-0001c870: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
-0001c880: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
-0001c890: 2020 2020 206e 616d 652c 206a 6f62 732e       name, jobs.
-0001c8a0: 4a4f 4253 5f43 4c55 5354 4552 5f4e 414d  JOBS_CLUSTER_NAM
-0001c8b0: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
-0001c8c0: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
-0001c8d0: 616c 7365 290a 2020 2020 6e61 6d65 5f32  alse).    name_2
-0001c8e0: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-0001c8f0: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-0001c900: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-0001c910: 6f75 6428 0a20 2020 2020 2020 2066 277b  oud(.        f'{
-0001c920: 6e61 6d65 7d2d 3227 2c20 6a6f 6273 2e4a  name}-2', jobs.J
-0001c930: 4f42 535f 434c 5553 5445 525f 4e41 4d45  OBS_CLUSTER_NAME
-0001c940: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-0001c950: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-0001c960: 6c73 6529 0a20 2020 206e 616d 655f 335f  lse).    name_3_
-0001c970: 6f6e 5f63 6c6f 7564 203d 2063 6f6d 6d6f  on_cloud = commo
-0001c980: 6e5f 7574 696c 732e 6d61 6b65 5f63 6c75  n_utils.make_clu
-0001c990: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-0001c9a0: 7564 280a 2020 2020 2020 2020 6627 7b6e  ud(.        f'{n
-0001c9b0: 616d 657d 2d33 272c 206a 6f62 732e 4a4f  ame}-3', jobs.JO
-0001c9c0: 4253 5f43 4c55 5354 4552 5f4e 414d 455f  BS_CLUSTER_NAME_
-0001c9d0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
-0001c9e0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
-0001c9f0: 7365 290a 2020 2020 7265 6769 6f6e 203d  se).    region =
-0001ca00: 2061 7773 5f63 6f6e 6669 675f 7265 6769   aws_config_regi
-0001ca10: 6f6e 0a20 2020 2074 6573 7420 3d20 5465  on.    test = Te
-0001ca20: 7374 280a 2020 2020 2020 2020 276d 616e  st(.        'man
-0001ca30: 6167 6564 5f6a 6f62 735f 6361 6e63 656c  aged_jobs_cancel
-0001ca40: 6c61 7469 6f6e 5f61 7773 272c 0a20 2020  lation_aws',.   
-0001ca50: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001ca60: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001ca70: 6c61 7469 6f6e 2064 7572 696e 6720 7370  lation during sp
-0001ca80: 6f74 2063 6c75 7374 6572 2062 6569 6e67  ot cluster being
-0001ca90: 206c 6175 6e63 6865 642e 0a20 2020 2020   launched..     
-0001caa0: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001cab0: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
-0001cac0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001cad0: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001cae0: 202d 2d75 7365 2d73 706f 7420 2273 6c65   --use-spot "sle
-0001caf0: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
-0001cb00: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001cb10: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-0001cb20: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
-0001cb30: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001cb40: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-0001cb50: 3120 7c20 6772 6570 2022 5354 4152 5449  1 | grep "STARTI
-0001cb60: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-0001cb70: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
-0001cb80: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001cb90: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001cba0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-0001cbb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001cbc0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
-0001cbd0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001cbe0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001cbf0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-0001cc00: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-0001cc10: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0001cc20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001cc30: 277b 5f4a 4f42 5f51 5545 5545 5f57 4149  '{_JOB_QUEUE_WAI
-0001cc40: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-0001cc50: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001cc60: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
-0001cc70: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
-0001cc80: 3d24 2861 7773 2065 6332 2064 6573 6372  =$(aws ec2 descr
-0001cc90: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-0001cca0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001ccb0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001ccc0: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
-0001ccd0: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
-0001cce0: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
-0001ccf0: 655f 6f6e 5f63 6c6f 7564 7d2d 2a20 270a  e_on_cloud}-* '.
-0001cd00: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001cd10: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
-0001cd20: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
-0001cd30: 5d2e 5374 6174 655b 5d2e 4e61 6d65 2027  ].State[].Name '
-0001cd40: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
-0001cd50: 2d6f 7574 7075 7420 7465 7874 2920 2626  -output text) &&
-0001cd60: 2065 6368 6f20 2224 7322 2026 2620 6563   echo "$s" && ec
-0001cd70: 686f 3b20 5b5b 202d 7a20 2224 7322 205d  ho; [[ -z "$s" ]
-0001cd80: 5d20 7c7c 205b 5b20 2224 7322 203d 2022  ] || [[ "$s" = "
-0001cd90: 7465 726d 696e 6174 6564 2220 5d5d 207c  terminated" ]] |
-0001cda0: 7c20 5b5b 2022 2473 2220 3d20 2273 6875  | [[ "$s" = "shu
-0001cdb0: 7474 696e 672d 646f 776e 2220 5d5d 270a  tting-down" ]]'.
-0001cdc0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001cdd0: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
-0001cde0: 7420 6361 6e63 656c 6c69 6e67 2074 6865  t cancelling the
-0001cdf0: 2073 706f 7420 636c 7573 7465 7220 6475   spot cluster du
-0001ce00: 7269 6e67 2073 706f 7420 6a6f 6220 6265  ring spot job be
-0001ce10: 696e 6720 7365 7475 702e 0a20 2020 2020  ing setup..     
-0001ce20: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001ce30: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
-0001ce40: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001ce50: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001ce60: 2d32 202d 2d75 7365 2d73 706f 7420 7465  -2 --use-spot te
-0001ce70: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-0001ce80: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
-0001ce90: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
-0001cea0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001ceb0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-0001cec0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
-0001ced0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001cee0: 6d65 3d66 277b 6e61 6d65 7d2d 3227 292c  me=f'{name}-2'),
-0001cef0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001cf00: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0001cf10: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-0001cf20: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001cf30: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
-0001cf40: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001cf50: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0001cf60: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001cf70: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0001cf80: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
-0001cf90: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001cfa0: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
-0001cfb0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001cfc0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001cfd0: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-0001cfe0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-0001cff0: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-0001d000: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-0001d010: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-0001d020: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-0001d030: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-0001d040: 5661 6c75 6573 3d7b 6e61 6d65 5f32 5f6f  Values={name_2_o
-0001d050: 6e5f 636c 6f75 647d 2d2a 2027 0a20 2020  n_cloud}-* '.   
-0001d060: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0001d070: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0001d080: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e53  [].Instances[].S
-0001d090: 7461 7465 5b5d 2e4e 616d 6520 270a 2020  tate[].Name '.  
-0001d0a0: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
-0001d0b0: 7470 7574 2074 6578 7429 2026 2620 6563  tput text) && ec
-0001d0c0: 686f 2022 2473 2220 2626 2065 6368 6f3b  ho "$s" && echo;
-0001d0d0: 205b 5b20 2d7a 2022 2473 2220 5d5d 207c   [[ -z "$s" ]] |
-0001d0e0: 7c20 5b5b 2022 2473 2220 3d20 2274 6572  | [[ "$s" = "ter
-0001d0f0: 6d69 6e61 7465 6422 205d 5d20 7c7c 205b  minated" ]] || [
-0001d100: 5b20 2224 7322 203d 2022 7368 7574 7469  [ "$s" = "shutti
-0001d110: 6e67 2d64 6f77 6e22 205d 5d27 0a20 2020  ng-down" ]]'.   
-0001d120: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-0001d130: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
-0001d140: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
-0001d150: 6e67 2073 706f 7420 6a6f 6220 6973 2072  ng spot job is r
-0001d160: 6563 6f76 6572 696e 672e 0a20 2020 2020  ecovering..     
-0001d170: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001d180: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
-0001d190: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
-0001d1a0: 6567 696f 6e7d 202d 6e20 7b6e 616d 657d  egion} -n {name}
-0001d1b0: 2d33 202d 2d75 7365 2d73 706f 7420 2273  -3 --use-spot "s
-0001d1c0: 6c65 6570 2031 3030 3022 2020 2d79 202d  leep 1000"  -y -
-0001d1d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0001d1e0: 2773 6c65 6570 2033 3030 272c 0a20 2020  'sleep 300',.   
-0001d1f0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
-0001d200: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0001d210: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0001d220: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0001d230: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0001d240: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-0001d250: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-0001d260: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-0001d270: 2020 2020 2866 2761 7773 2065 6332 2074      (f'aws ec2 t
-0001d280: 6572 6d69 6e61 7465 2d69 6e73 7461 6e63  erminate-instanc
-0001d290: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-0001d2a0: 696f 6e7d 202d 2d69 6e73 7461 6e63 652d  ion} --instance-
-0001d2b0: 6964 7320 2428 270a 2020 2020 2020 2020  ids $('.        
-0001d2c0: 2020 2020 2066 2761 7773 2065 6332 2064       f'aws ec2 d
-0001d2d0: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-0001d2e0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-0001d2f0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-0001d300: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-0001d310: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-0001d320: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-0001d330: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
-0001d340: 7d2d 2a20 270a 2020 2020 2020 2020 2020  }-* '.          
-0001d350: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
-0001d360: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
-0001d370: 616e 6365 735b 5d2e 496e 7374 616e 6365  ances[].Instance
-0001d380: 4964 2027 0a20 2020 2020 2020 2020 2020  Id '.           
-0001d390: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-0001d3a0: 2927 292c 0a20 2020 2020 2020 2020 2020  )'),.           
-0001d3b0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-0001d3c0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
-0001d3d0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
-0001d3e0: 7265 7020 7b6e 616d 657d 2d33 207c 2068  rep {name}-3 | h
-0001d3f0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001d400: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-0001d410: 2020 2020 2020 2020 2020 5f4a 4f42 5f43            _JOB_C
-0001d420: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-0001d430: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
-0001d440: 6d65 7d2d 3327 292c 0a20 2020 2020 2020  me}-3'),.       
-0001d450: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-0001d460: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001d470: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-0001d480: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0001d490: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001d4a0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-0001d4b0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0001d4c0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-0001d4d0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001d4e0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001d4f0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001d500: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001d510: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-0001d520: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0001d530: 2054 6865 2063 6c75 7374 6572 2073 686f   The cluster sho
-0001d540: 756c 6420 6265 2074 6572 6d69 6e61 7465  uld be terminate
-0001d550: 6420 2873 6875 7474 696e 672d 646f 776e  d (shutting-down
-0001d560: 2920 6166 7465 7220 6361 6e63 656c 6c61  ) after cancella
-0001d570: 7469 6f6e 2e20 5765 2064 6f6e 2774 2075  tion. We don't u
-0001d580: 7365 2074 6865 2060 3d60 206f 7065 7261  se the `=` opera
-0001d590: 746f 7220 6865 7265 2062 6563 6175 7365  tor here because
-0001d5a0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-0001d5b0: 6865 7265 2063 616e 2062 6520 6d75 6c74  here can be mult
-0001d5c0: 6970 6c65 2056 4d20 7769 7468 2074 6865  iple VM with the
-0001d5d0: 2073 616d 6520 6e61 6d65 2064 7565 2074   same name due t
-0001d5e0: 6f20 7468 6520 7265 636f 7665 7279 2e0a  o the recovery..
-0001d5f0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
-0001d600: 3d24 2861 7773 2065 6332 2064 6573 6372  =$(aws ec2 descr
-0001d610: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-0001d620: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001d630: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001d640: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
-0001d650: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
-0001d660: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
-0001d670: 655f 335f 6f6e 5f63 6c6f 7564 7d2d 2a20  e_3_on_cloud}-* 
-0001d680: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-0001d690: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
-0001d6a0: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
-0001d6b0: 735b 5d2e 5374 6174 655b 5d2e 4e61 6d65  s[].State[].Name
-0001d6c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0001d6d0: 272d 2d6f 7574 7075 7420 7465 7874 2920  '--output text) 
-0001d6e0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-0001d6f0: 6563 686f 3b20 5b5b 202d 7a20 2224 7322  echo; [[ -z "$s"
-0001d700: 205d 5d20 7c7c 2065 6368 6f20 2224 7322   ]] || echo "$s"
-0001d710: 207c 2067 7265 7020 2d76 202d 4520 2270   | grep -v -E "p
-0001d720: 656e 6469 6e67 7c72 756e 6e69 6e67 7c73  ending|running|s
-0001d730: 746f 7070 6564 7c73 746f 7070 696e 6722  topped|stopping"
-0001d740: 270a 2020 2020 2020 2020 2020 2020 292c  '.            ),
-0001d750: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0001d760: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-0001d770: 2036 3029 0a20 2020 2072 756e 5f6f 6e65   60).    run_one
-0001d780: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0001d790: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-0001d7a0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-0001d7b0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
-0001d7c0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f63  t_managed_jobs_c
-0001d7d0: 616e 6365 6c6c 6174 696f 6e5f 6763 7028  ancellation_gcp(
-0001d7e0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0001d7f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001d800: 290a 2020 2020 6e61 6d65 5f33 203d 2066  ).    name_3 = f
-0001d810: 277b 6e61 6d65 7d2d 3327 0a20 2020 206e  '{name}-3'.    n
-0001d820: 616d 655f 335f 6f6e 5f63 6c6f 7564 203d  ame_3_on_cloud =
-0001d830: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-0001d840: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-0001d850: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
-0001d860: 2020 6e61 6d65 5f33 2c20 6a6f 6273 2e4a    name_3, jobs.J
-0001d870: 4f42 535f 434c 5553 5445 525f 4e41 4d45  OBS_CLUSTER_NAME
-0001d880: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
-0001d890: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
-0001d8a0: 6c73 6529 0a20 2020 207a 6f6e 6520 3d20  lse).    zone = 
-0001d8b0: 2775 732d 7765 7374 332d 6227 0a20 2020  'us-west3-b'.   
-0001d8c0: 2071 7565 7279 5f73 7461 7465 5f63 6d64   query_state_cmd
-0001d8d0: 203d 2028 0a20 2020 2020 2020 2027 6763   = (.        'gc
-0001d8e0: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-0001d8f0: 7461 6e63 6573 206c 6973 7420 270a 2020  tances list '.  
-0001d900: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
-0001d910: 3d22 286c 6162 656c 732e 7261 792d 636c  ="(labels.ray-cl
-0001d920: 7573 7465 722d 6e61 6d65 3a7b 6e61 6d65  uster-name:{name
-0001d930: 5f33 5f6f 6e5f 636c 6f75 647d 2922 2027  _3_on_cloud})" '
-0001d940: 0a20 2020 2020 2020 2027 2d2d 666f 726d  .        '--form
-0001d950: 6174 3d22 7661 6c75 6528 7374 6174 7573  at="value(status
-0001d960: 2922 2729 0a20 2020 2071 7565 7279 5f63  )"').    query_c
-0001d970: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
-0001d980: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
-0001d990: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
-0001d9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d9b0: 2020 6627 2228 6c61 6265 6c73 2e72 6179    f'"(labels.ray
-0001d9c0: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
-0001d9d0: 616d 655f 335f 6f6e 5f63 6c6f 7564 7d29  ame_3_on_cloud})
-0001d9e0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-0001d9f0: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
-0001da00: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
-0001da10: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
-0001da20: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
-0001da30: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
-0001da40: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
-0001da50: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
-0001da60: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
-0001da70: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
-0001da80: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
-0001da90: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
-0001daa0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001dab0: 6d61 6e61 6765 645f 6a6f 6273 5f63 616e  managed_jobs_can
-0001dac0: 6365 6c6c 6174 696f 6e5f 6763 7027 2c0a  cellation_gcp',.
-0001dad0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0001dae0: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-0001daf0: 6365 6c6c 6174 696f 6e20 6475 7269 6e67  cellation during
-0001db00: 2073 706f 7420 636c 7573 7465 7220 6265   spot cluster be
-0001db10: 696e 6720 6c61 756e 6368 6564 2e0a 2020  ing launched..  
-0001db20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001db30: 6a6f 6273 206c 6175 6e63 6820 2d2d 636c  jobs launch --cl
-0001db40: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
-0001db50: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
-0001db60: 2d2d 7573 652d 7370 6f74 2022 736c 6565  --use-spot "slee
-0001db70: 7020 3130 3030 2220 202d 7920 2d64 272c  p 1000"  -y -d',
-0001db80: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001db90: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-0001dba0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-0001dbb0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001dbc0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001dbd0: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
-0001dbe0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0001dbf0: 205f 4a4f 425f 4341 4e43 454c 5f57 4149   _JOB_CANCEL_WAI
-0001dc00: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001dc10: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001dc20: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-0001dc30: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001dc40: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
-0001dc50: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0001dc60: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0001dc70: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-0001dc80: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-0001dc90: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
-0001dca0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001dcb0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001dcc0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001dcd0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001dce0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-0001dcf0: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
-0001dd00: 7420 6361 6e63 656c 6c69 6e67 2074 6865  t cancelling the
-0001dd10: 2073 706f 7420 636c 7573 7465 7220 6475   spot cluster du
-0001dd20: 7269 6e67 2073 706f 7420 6a6f 6220 6265  ring spot job be
-0001dd30: 696e 6720 7365 7475 702e 0a20 2020 2020  ing setup..     
-0001dd40: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
-0001dd50: 7320 6c61 756e 6368 202d 2d63 6c6f 7564  s launch --cloud
-0001dd60: 2067 6370 202d 2d7a 6f6e 6520 7b7a 6f6e   gcp --zone {zon
-0001dd70: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
-0001dd80: 2d75 7365 2d73 706f 7420 7465 7374 732f  -use-spot tests/
-0001dd90: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-0001dda0: 6c6f 6e67 5f73 6574 7570 2e79 616d 6c20  long_setup.yaml 
-0001ddb0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
-0001ddc0: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
-0001ddd0: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
-0001dde0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
-0001ddf0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-0001de00: 277b 6e61 6d65 7d2d 3227 292c 0a20 2020  '{name}-2'),.   
-0001de10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001de20: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-0001de30: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001de40: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001de50: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
-0001de60: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-0001de70: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-0001de80: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001de90: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-0001dea0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-0001deb0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001dec0: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
-0001ded0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001dee0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-0001def0: 2020 2023 2054 6573 7420 6361 6e63 656c     # Test cancel
-0001df00: 6c61 7469 6f6e 2064 7572 696e 6720 7370  lation during sp
-0001df10: 6f74 206a 6f62 2069 7320 7265 636f 7665  ot job is recove
-0001df20: 7269 6e67 2e0a 2020 2020 2020 2020 2020  ring..          
-0001df30: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
-0001df40: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
-0001df50: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
-0001df60: 207b 6e61 6d65 7d2d 3320 2d2d 7573 652d   {name}-3 --use-
-0001df70: 7370 6f74 2022 736c 6565 7020 3130 3030  spot "sleep 1000
-0001df80: 2220 202d 7920 2d64 272c 0a20 2020 2020  "  -y -d',.     
-0001df90: 2020 2020 2020 2027 736c 6565 7020 3330         'sleep 30
-0001dfa0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001dfb0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001dfc0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001dfd0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001dfe0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-0001dff0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0001e000: 6572 6d69 6e61 7465 2074 6865 2063 6c75  erminate the clu
-0001e010: 7374 6572 206d 616e 7561 6c6c 792e 0a20  ster manually.. 
-0001e020: 2020 2020 2020 2020 2020 2074 6572 6d69             termi
-0001e030: 6e61 7465 5f63 6d64 2c0a 2020 2020 2020  nate_cmd,.      
-0001e040: 2020 2020 2020 2773 6c65 6570 2038 3027        'sleep 80'
-0001e050: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001e060: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
-0001e070: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
-0001e080: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0001e090: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
-0001e0a0: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
-0001e0b0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
-0001e0c0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-0001e0d0: 277b 6e61 6d65 7d2d 3327 292c 0a20 2020  '{name}-3'),.   
-0001e0e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001e0f0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-0001e100: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001e110: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001e120: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001e130: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-0001e140: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-0001e150: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001e160: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-0001e170: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-0001e180: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0001e190: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0001e1a0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0001e1b0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-0001e1c0: 2020 2023 2054 6865 2063 6c75 7374 6572     # The cluster
-0001e1d0: 2073 686f 756c 6420 6265 2074 6572 6d69   should be termi
-0001e1e0: 6e61 7465 6420 2853 544f 5050 494e 4729  nated (STOPPING)
-0001e1f0: 2061 6674 6572 2063 616e 6365 6c6c 6174   after cancellat
-0001e200: 696f 6e2e 2057 6520 646f 6e27 7420 7573  ion. We don't us
-0001e210: 6520 7468 6520 603d 6020 6f70 6572 6174  e the `=` operat
-0001e220: 6f72 2068 6572 6520 6265 6361 7573 650a  or here because.
-0001e230: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-0001e240: 6572 6520 6361 6e20 6265 206d 756c 7469  ere can be multi
-0001e250: 706c 6520 564d 2077 6974 6820 7468 6520  ple VM with the 
-0001e260: 7361 6d65 206e 616d 6520 6475 6520 746f  same name due to
-0001e270: 2074 6865 2072 6563 6f76 6572 792e 0a20   the recovery.. 
-0001e280: 2020 2020 2020 2020 2020 2028 6627 733d             (f's=
-0001e290: 2428 7b71 7565 7279 5f73 7461 7465 5f63  $({query_state_c
-0001e2a0: 6d64 7d29 2026 2620 6563 686f 2022 2473  md}) && echo "$s
-0001e2b0: 2220 2626 2065 6368 6f3b 205b 5b20 2d7a  " && echo; [[ -z
-0001e2c0: 2022 2473 2220 5d5d 207c 7c20 6563 686f   "$s" ]] || echo
-0001e2d0: 2022 2473 2220 7c20 6772 6570 202d 7620   "$s" | grep -v 
-0001e2e0: 2d45 2022 5052 4f56 4953 494f 4e49 4e47  -E "PROVISIONING
-0001e2f0: 7c53 5441 4749 4e47 7c52 554e 4e49 4e47  |STAGING|RUNNING
-0001e300: 7c52 4550 4149 5249 4e47 7c54 4552 4d49  |REPAIRING|TERMI
-0001e310: 4e41 5445 447c 5355 5350 454e 4449 4e47  NATED|SUSPENDING
-0001e320: 7c53 5553 5045 4e44 4544 7c53 5553 5045  |SUSPENDED|SUSPE
-0001e330: 4e44 4544 2227 0a20 2020 2020 2020 2020  NDED"'.         
-0001e340: 2020 2029 2c0a 2020 2020 2020 2020 5d2c     ),.        ],
-0001e350: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001e360: 3d32 3520 2a20 3630 290a 2020 2020 7275  =25 * 60).    ru
-0001e370: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001e380: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0001e390: 5465 7374 696e 6720 7374 6f72 6167 6520  Testing storage 
-0001e3a0: 666f 7220 6d61 6e61 6765 6420 6a6f 6220  for managed job 
-0001e3b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0001e3c0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0001e3d0: 7374 6163 6b20 2023 2046 6c75 6964 7374  stack  # Fluidst
-0001e3e0: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
-0001e3f0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-0001e400: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-0001e410: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
-0001e420: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
-0001e430: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001e440: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001e450: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0001e460: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-0001e470: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0001e480: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001e490: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0001e4a0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-0001e4b0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001e4c0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-0001e4d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001e4e0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
-0001e4f0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
-0001e500: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0001e510: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0001e520: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-0001e530: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-0001e540: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001e550: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001e560: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
-0001e570: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
-0001e580: 6a6f 6273 5f73 746f 7261 6765 2867 656e  jobs_storage(gen
-0001e590: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0001e5a0: 3a0a 2020 2020 2222 2254 6573 7420 7374  :.    """Test st
-0001e5b0: 6f72 6167 6520 7769 7468 206d 616e 6167  orage with manag
-0001e5c0: 6564 206a 6f62 2222 220a 2020 2020 6e61  ed job""".    na
-0001e5d0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0001e5e0: 725f 6e61 6d65 2829 0a20 2020 2079 616d  r_name().    yam
-0001e5f0: 6c5f 7374 7220 3d20 7061 7468 6c69 622e  l_str = pathlib.
-0001e600: 5061 7468 280a 2020 2020 2020 2020 2765  Path(.        'e
-0001e610: 7861 6d70 6c65 732f 6d61 6e61 6765 645f  xamples/managed_
-0001e620: 6a6f 625f 7769 7468 5f73 746f 7261 6765  job_with_storage
-0001e630: 2e79 616d 6c27 292e 7265 6164 5f74 6578  .yaml').read_tex
-0001e640: 7428 290a 2020 2020 7374 6f72 6167 655f  t().    storage_
-0001e650: 6e61 6d65 203d 2066 2773 6b79 2d74 6573  name = f'sky-tes
-0001e660: 742d 7b69 6e74 2874 696d 652e 7469 6d65  t-{int(time.time
-0001e670: 2829 297d 270a 0a20 2020 2023 2041 6c73  ())}'..    # Als
-0001e680: 6f20 7065 7266 6f72 6d20 7265 6769 6f6e  o perform region
-0001e690: 2074 6573 7469 6e67 2066 6f72 2062 7563   testing for buc
-0001e6a0: 6b65 7420 6372 6561 7469 6f6e 2074 6f20  ket creation to 
-0001e6b0: 7661 6c69 6461 7465 2069 6620 6275 636b  validate if buck
-0001e6c0: 6574 7320 6172 650a 2020 2020 2320 6372  ets are.    # cr
-0001e6d0: 6561 7465 6420 696e 2074 6865 2063 6f72  eated in the cor
-0001e6e0: 7265 6374 2072 6567 696f 6e20 616e 6420  rect region and 
-0001e6f0: 636f 7272 6563 746c 7920 6d6f 756e 7465  correctly mounte
-0001e700: 6420 696e 206d 616e 6167 6564 206a 6f62  d in managed job
-0001e710: 732e 0a20 2020 2023 2048 6f77 6576 6572  s..    # However
-0001e720: 2c20 7765 2069 6e6a 6563 7420 7468 6973  , we inject this
-0001e730: 2074 6573 7469 6e67 206f 6e6c 7920 666f   testing only fo
-0001e740: 7220 4157 5320 616e 6420 4743 5020 7369  r AWS and GCP si
-0001e750: 6e63 6520 7468 6579 2061 7265 2074 6865  nce they are the
-0001e760: 0a20 2020 2023 2073 7570 706f 7274 6564  .    # supported
-0001e770: 206f 626a 6563 7420 7374 6f72 6167 6520   object storage 
-0001e780: 7072 6f76 6964 6572 7320 696e 2053 6b79  providers in Sky
-0001e790: 5069 6c6f 742e 0a20 2020 2072 6567 696f  Pilot..    regio
-0001e7a0: 6e5f 666c 6167 203d 2027 270a 2020 2020  n_flag = ''.    
-0001e7b0: 7265 6769 6f6e 5f76 616c 6964 6174 696f  region_validatio
-0001e7c0: 6e5f 636d 6420 3d20 2774 7275 6527 0a20  n_cmd = 'true'. 
-0001e7d0: 2020 2075 7365 5f73 706f 7420 3d20 2720     use_spot = ' 
-0001e7e0: 2d2d 7573 652d 7370 6f74 270a 2020 2020  --use-spot'.    
-0001e7f0: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-0001e800: 203d 3d20 2761 7773 273a 0a20 2020 2020   == 'aws':.     
-0001e810: 2020 2072 6567 696f 6e20 3d20 2765 752d     region = 'eu-
-0001e820: 6365 6e74 7261 6c2d 3127 0a20 2020 2020  central-1'.     
-0001e830: 2020 2072 6567 696f 6e5f 666c 6167 203d     region_flag =
-0001e840: 2066 2720 2d2d 7265 6769 6f6e 207b 7265   f' --region {re
-0001e850: 6769 6f6e 7d27 0a20 2020 2020 2020 2072  gion}'.        r
-0001e860: 6567 696f 6e5f 636d 6420 3d20 5465 7374  egion_cmd = Test
-0001e870: 5374 6f72 6167 6557 6974 6843 7265 6465  StorageWithCrede
-0001e880: 6e74 6961 6c73 2e63 6c69 5f72 6567 696f  ntials.cli_regio
-0001e890: 6e5f 636d 6428 0a20 2020 2020 2020 2020  n_cmd(.         
-0001e8a0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-0001e8b0: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
-0001e8c0: 7261 6765 5f6e 616d 6529 0a20 2020 2020  rage_name).     
-0001e8d0: 2020 2072 6567 696f 6e5f 7661 6c69 6461     region_valida
-0001e8e0: 7469 6f6e 5f63 6d64 203d 2066 277b 7265  tion_cmd = f'{re
-0001e8f0: 6769 6f6e 5f63 6d64 7d20 7c20 6772 6570  gion_cmd} | grep
-0001e900: 207b 7265 6769 6f6e 7d27 0a20 2020 2065   {region}'.    e
-0001e910: 6c69 6620 6765 6e65 7269 635f 636c 6f75  lif generic_clou
-0001e920: 6420 3d3d 2027 6763 7027 3a0a 2020 2020  d == 'gcp':.    
-0001e930: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-0001e940: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
-0001e950: 7265 6769 6f6e 5f66 6c61 6720 3d20 6627  region_flag = f'
-0001e960: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0001e970: 6e7d 270a 2020 2020 2020 2020 7265 6769  n}'.        regi
-0001e980: 6f6e 5f63 6d64 203d 2054 6573 7453 746f  on_cmd = TestSto
-0001e990: 7261 6765 5769 7468 4372 6564 656e 7469  rageWithCredenti
-0001e9a0: 616c 732e 636c 695f 7265 6769 6f6e 5f63  als.cli_region_c
-0001e9b0: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
-0001e9c0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001e9d0: 6554 7970 652e 4743 532c 2073 746f 7261  eType.GCS, stora
-0001e9e0: 6765 5f6e 616d 6529 0a20 2020 2020 2020  ge_name).       
-0001e9f0: 2072 6567 696f 6e5f 7661 6c69 6461 7469   region_validati
-0001ea00: 6f6e 5f63 6d64 203d 2066 277b 7265 6769  on_cmd = f'{regi
-0001ea10: 6f6e 5f63 6d64 7d20 7c20 6772 6570 207b  on_cmd} | grep {
-0001ea20: 7265 6769 6f6e 7d27 0a20 2020 2065 6c69  region}'.    eli
-0001ea30: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
-0001ea40: 3d3d 2027 6b75 6265 726e 6574 6573 273a  == 'kubernetes':
-0001ea50: 0a20 2020 2020 2020 2075 7365 5f73 706f  .        use_spo
-0001ea60: 7420 3d20 2720 2d2d 6e6f 2d75 7365 2d73  t = ' --no-use-s
-0001ea70: 706f 7427 0a0a 2020 2020 7961 6d6c 5f73  pot'..    yaml_s
-0001ea80: 7472 203d 2079 616d 6c5f 7374 722e 7265  tr = yaml_str.re
-0001ea90: 706c 6163 6528 2773 6b79 2d77 6f72 6b64  place('sky-workd
-0001eaa0: 6972 2d7a 6877 7527 2c20 7374 6f72 6167  ir-zhwu', storag
-0001eab0: 655f 6e61 6d65 290a 2020 2020 7769 7468  e_name).    with
-0001eac0: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
-0001ead0: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
-0001eae0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
-0001eaf0: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
-0001eb00: 2020 2020 2066 2e77 7269 7465 2879 616d       f.write(yam
-0001eb10: 6c5f 7374 7229 0a20 2020 2020 2020 2066  l_str).        f
-0001eb20: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
-0001eb30: 2066 696c 655f 7061 7468 203d 2066 2e6e   file_path = f.n
-0001eb40: 616d 650a 2020 2020 2020 2020 7465 7374  ame.        test
-0001eb50: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001eb60: 2020 2020 2027 6d61 6e61 6765 645f 6a6f       'managed_jo
-0001eb70: 6273 5f73 746f 7261 6765 272c 0a20 2020  bs_storage',.   
-0001eb80: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-0001eb90: 2020 2020 2020 2020 2020 202a 7374 6f72             *stor
-0001eba0: 6167 655f 7365 7475 705f 636f 6d6d 616e  age_setup_comman
-0001ebb0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-0001ebc0: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
-0001ebd0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d7b  aunch -n {name}{
-0001ebe0: 7573 655f 7370 6f74 7d20 2d2d 636c 6f75  use_spot} --clou
-0001ebf0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-0001ec00: 7d7b 7265 6769 6f6e 5f66 6c61 677d 207b  }{region_flag} {
-0001ec10: 6669 6c65 5f70 6174 687d 202d 7927 2c0a  file_path} -y',.
-0001ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec30: 7265 6769 6f6e 5f76 616c 6964 6174 696f  region_validatio
-0001ec40: 6e5f 636d 642c 2020 2320 4368 6563 6b20  n_cmd,  # Check 
-0001ec50: 6966 2074 6865 2062 7563 6b65 7420 6973  if the bucket is
-0001ec60: 2063 7265 6174 6564 2069 6e20 7468 6520   created in the 
-0001ec70: 636f 7272 6563 7420 7265 6769 6f6e 0a20  correct region. 
-0001ec80: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001ec90: 736c 6565 7020 3630 272c 2020 2320 5761  sleep 60',  # Wa
-0001eca0: 6974 2074 6865 2073 706f 7420 7175 6575  it the spot queu
-0001ecb0: 6520 746f 2062 6520 7570 6461 7465 640a  e to be updated.
-0001ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecd0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
-0001ece0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001ecf0: 207c 2067 7265 7020 5355 4343 4545 4445   | grep SUCCEEDE
-0001ed00: 4427 2c0a 2020 2020 2020 2020 2020 2020  D',.            
-0001ed10: 2020 2020 6627 5b20 2428 6177 7320 7333      f'[ $(aws s3
-0001ed20: 6170 6920 6c69 7374 2d62 7563 6b65 7473  api list-buckets
-0001ed30: 202d 2d71 7565 7279 2022 4275 636b 6574   --query "Bucket
-0001ed40: 735b 3f63 6f6e 7461 696e 7328 4e61 6d65  s[?contains(Name
-0001ed50: 2c20 5c27 7b73 746f 7261 6765 5f6e 616d  , \'{storage_nam
-0001ed60: 657d 5c27 295d 2e4e 616d 6522 202d 2d6f  e}\')].Name" --o
-0001ed70: 7574 7075 7420 7465 7874 207c 2077 6320  utput text | wc 
-0001ed80: 2d6c 2920 2d65 7120 3020 5d27 0a20 2020  -l) -eq 0 ]'.   
-0001ed90: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-0001eda0: 2020 2020 2020 2020 5f4a 4f42 5f43 414e          _JOB_CAN
-0001edb0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-0001edc0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-0001edd0: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-0001ede0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-0001edf0: 696e 6365 2073 6b79 206a 6f62 7320 7175  ince sky jobs qu
-0001ee00: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-0001ee10: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-0001ee20: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-0001ee30: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-0001ee40: 3020 2a20 3630 2c0a 2020 2020 2020 2020  0 * 60,.        
-0001ee50: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-0001ee60: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0001ee70: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-0001ee80: 696e 6720 7370 6f74 2054 5055 202d 2d2d  ing spot TPU ---
-0001ee90: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0001eea0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-0001eeb0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
-0001eec0: 6273 0a40 7079 7465 7374 2e6d 6172 6b2e  bs.@pytest.mark.
-0001eed0: 7470 750a 6465 6620 7465 7374 5f6d 616e  tpu.def test_man
-0001eee0: 6167 6564 5f6a 6f62 735f 7470 7528 293a  aged_jobs_tpu():
-0001eef0: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
-0001ef00: 6167 6564 206a 6f62 206f 6e20 5450 552e  aged job on TPU.
-0001ef10: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0001ef20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001ef30: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0001ef40: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-0001ef50: 742d 7370 6f74 2d74 7075 272c 0a20 2020  t-spot-tpu',.   
-0001ef60: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001ef70: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
-0001ef80: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
-0001ef90: 2d75 7365 2d73 706f 7420 6578 616d 706c  -use-spot exampl
-0001efa0: 6573 2f74 7075 2f74 7075 766d 5f6d 6e69  es/tpu/tpuvm_mni
-0001efb0: 7374 2e79 616d 6c20 2d79 202d 6427 2c0a  st.yaml -y -d',.
-0001efc0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001efd0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0001efe0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
-0001eff0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0001f000: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0001f010: 2067 7265 7020 5354 4152 5449 4e47 272c   grep STARTING',
-0001f020: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0001f030: 6565 7020 3930 3027 2c20 2023 2054 5055  eep 900',  # TPU
-0001f040: 2074 616b 6573 2061 2077 6869 6c65 2074   takes a while t
-0001f050: 6f20 6c61 756e 6368 0a20 2020 2020 2020  o launch.       
-0001f060: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
-0001f070: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001f080: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0001f090: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-0001f0a0: 5c7c 5355 4343 4545 4445 4422 272c 0a20  \|SUCCEEDED"',. 
-0001f0b0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001f0c0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
-0001f0d0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0001f0e0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001f0f0: 2020 2320 496e 6372 6561 7365 2074 696d    # Increase tim
-0001f100: 656f 7574 2073 696e 6365 2073 6b79 206a  eout since sky j
-0001f110: 6f62 7320 7175 6575 6520 2d72 2063 616e  obs queue -r can
-0001f120: 2062 6520 626c 6f63 6b65 6420 6279 206f   be blocked by o
-0001f130: 7468 6572 2073 706f 7420 7465 7374 732e  ther spot tests.
-0001f140: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001f150: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0001f160: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001f170: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0001f180: 2d2d 2d2d 2d20 5465 7374 696e 6720 656e  ----- Testing en
-0001f190: 7620 666f 7220 6d61 6e61 6765 6420 6a6f  v for managed jo
-0001f1a0: 6273 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  bs ----------.@p
-0001f1b0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-0001f1c0: 6564 5f6a 6f62 730a 6465 6620 7465 7374  ed_jobs.def test
-0001f1d0: 5f6d 616e 6167 6564 5f6a 6f62 735f 696e  _managed_jobs_in
-0001f1e0: 6c69 6e65 5f65 6e76 2867 656e 6572 6963  line_env(generic
-0001f1f0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-0001f200: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-0001f210: 6420 6a6f 6273 2065 6e76 2222 220a 2020  d jobs env""".  
-0001f220: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001f230: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001f240: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001f250: 2020 2020 2020 2774 6573 742d 6d61 6e61        'test-mana
-0001f260: 6765 642d 6a6f 6273 2d69 6e6c 696e 652d  ged-jobs-inline-
-0001f270: 656e 7627 2c0a 2020 2020 2020 2020 5b0a  env',.        [.
-0001f280: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001f290: 7920 6a6f 6273 206c 6175 6e63 6820 2d6e  y jobs launch -n
-0001f2a0: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
-0001f2b0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0001f2c0: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
-0001f2d0: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
-0001f2e0: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
-0001f2f0: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
-0001f300: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
-0001f310: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
-0001f320: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
-0001f330: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
-0001f340: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
-0001f350: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
-0001f360: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0001f370: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
-0001f380: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
-0001f390: 455f 5741 4954 7d20 7c20 6772 6570 207b  E_WAIT} | grep {
-0001f3a0: 6e61 6d65 7d20 7c20 6772 6570 2053 5543  name} | grep SUC
-0001f3b0: 4345 4544 4544 272c 0a20 2020 2020 2020  CEEDED',.       
-0001f3c0: 205d 2c0a 2020 2020 2020 2020 5f4a 4f42   ],.        _JOB
-0001f3d0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-0001f3e0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-0001f3f0: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-0001f400: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-0001f410: 696e 6365 2073 6b79 206a 6f62 7320 7175  ince sky jobs qu
-0001f420: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-0001f430: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-0001f440: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-0001f450: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-0001f460: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0001f470: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001f480: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0001f490: 5465 7374 696e 6720 656e 7620 2d2d 2d2d  Testing env ----
-0001f4a0: 2d2d 2d2d 2d2d 0a64 6566 2074 6573 745f  ------.def test_
-0001f4b0: 696e 6c69 6e65 5f65 6e76 2867 656e 6572  inline_env(gener
-0001f4c0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-0001f4d0: 2020 2020 2222 2254 6573 7420 656e 7622      """Test env"
-0001f4e0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001f4f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001f500: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001f510: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
-0001f520: 2d69 6e6c 696e 652d 656e 7627 2c0a 2020  -inline-env',.  
-0001f530: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001f540: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0001f550: 202d 6320 7b6e 616d 657d 202d 7920 2d2d   -c {name} -y --
-0001f560: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0001f570: 6c6f 7564 7d20 2d2d 656e 7620 5445 5354  loud} --env TEST
-0001f580: 5f45 4e56 3d22 6865 6c6c 6f20 776f 726c  _ENV="hello worl
-0001f590: 6422 202d 2d20 2228 5b5b 2021 202d 7a20  d" -- "([[ ! -z 
-0001f5a0: 5c5c 225c 2454 4553 545f 454e 565c 5c22  \\"\$TEST_ENV\\"
-0001f5b0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001f5c0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001f5d0: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
-0001f5e0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001f5f0: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
-0001f600: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
-0001f610: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0001f620: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-0001f630: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0001f640: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-0001f650: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-0001f660: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0001f670: 6d65 7d20 2d2d 656e 7620 5445 5354 5f45  me} --env TEST_E
-0001f680: 4e56 323d 2273 7563 6365 7373 2220 2228  NV2="success" "(
-0001f690: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-0001f6a0: 545f 454e 5632 5c5c 2220 5d5d 2026 2620  T_ENV2\\" ]] && 
-0001f6b0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001f6c0: 5049 4c4f 545f 4e4f 4445 5f49 5053 5c5c  PILOT_NODE_IPS\\
-0001f6d0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001f6e0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001f6f0: 4445 5f52 414e 4b5c 5c22 205d 5d29 207c  DE_RANK\\" ]]) |
-0001f700: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0001f710: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0001f720: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0001f730: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-0001f740: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0001f750: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001f760: 0a20 2020 2020 2020 205f 6765 745f 7469  .        _get_ti
-0001f770: 6d65 6f75 7428 6765 6e65 7269 635f 636c  meout(generic_cl
-0001f780: 6f75 6429 2c0a 2020 2020 290a 2020 2020  oud),.    ).    
-0001f790: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001f7a0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0001f7b0: 2d20 5465 7374 696e 6720 656e 7620 6669  - Testing env fi
-0001f7c0: 6c65 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465  le ----------.de
-0001f7d0: 6620 7465 7374 5f69 6e6c 696e 655f 656e  f test_inline_en
-0001f7e0: 765f 6669 6c65 2867 656e 6572 6963 5f63  v_file(generic_c
-0001f7f0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0001f800: 2222 2254 6573 7420 656e 7622 2222 0a20  """Test env""". 
-0001f810: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001f820: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001f830: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0001f840: 2020 2020 2020 2027 7465 7374 2d69 6e6c         'test-inl
-0001f850: 696e 652d 656e 762d 6669 6c65 272c 0a20  ine-env-file',. 
-0001f860: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001f870: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0001f880: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
-0001f890: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0001f8a0: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
-0001f8b0: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
-0001f8c0: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
-0001f8d0: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
-0001f8e0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001f8f0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001f900: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
-0001f910: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001f920: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
-0001f930: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
-0001f940: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0001f950: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0001f960: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
-0001f970: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001f980: 2065 7865 6320 7b6e 616d 657d 202d 2d65   exec {name} --e
-0001f990: 6e76 2d66 696c 6520 6578 616d 706c 6573  nv-file examples
-0001f9a0: 2f73 616d 706c 655f 646f 7465 6e76 2022  /sample_dotenv "
-0001f9b0: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
-0001f9c0: 5354 5f45 4e56 325c 5c22 205d 5d20 2626  ST_ENV2\\" ]] &&
-0001f9d0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
-0001f9e0: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
-0001f9f0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
-0001fa00: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
-0001fa10: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
-0001fa20: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-0001fa30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001fa40: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0001fa50: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0001fa60: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0001fa70: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0001fa80: 2c0a 2020 2020 2020 2020 5f67 6574 5f74  ,.        _get_t
-0001fa90: 696d 656f 7574 2867 656e 6572 6963 5f63  imeout(generic_c
-0001faa0: 6c6f 7564 292c 0a20 2020 2029 0a20 2020  loud),.    ).   
-0001fab0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0001fac0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-0001fad0: 2d2d 2054 6573 7469 6e67 2063 7573 746f  -- Testing custo
-0001fae0: 6d20 696d 6167 6520 2d2d 2d2d 2d2d 2d2d  m image --------
-0001faf0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0001fb00: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
-0001fb10: 5f63 7573 746f 6d5f 696d 6167 6528 293a  _custom_image():
-0001fb20: 0a20 2020 2022 2222 5465 7374 2041 5753  .    """Test AWS
-0001fb30: 2063 7573 746f 6d20 696d 6167 6522 2222   custom image"""
-0001fb40: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001fb50: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001fb60: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0001fb70: 0a20 2020 2020 2020 2027 7465 7374 2d61  .        'test-a
-0001fb80: 7773 2d63 7573 746f 6d2d 696d 6167 6527  ws-custom-image'
-0001fb90: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0001fba0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0001fbb0: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
-0001fbc0: 2d72 6574 7279 2d75 6e74 696c 2d75 7020  -retry-until-up 
-0001fbd0: 2d79 2074 6573 7473 2f74 6573 745f 7961  -y tests/test_ya
-0001fbe0: 6d6c 732f 7465 7374 5f63 7573 746f 6d5f  mls/test_custom_
-0001fbf0: 696d 6167 652e 7961 6d6c 202d 2d63 6c6f  image.yaml --clo
-0001fc00: 7564 2061 7773 202d 2d72 6567 696f 6e20  ud aws --region 
-0001fc10: 7573 2d65 6173 742d 3220 2d2d 696d 6167  us-east-2 --imag
-0001fc20: 652d 6964 2061 6d69 2d30 3632 6464 6439  e-id ami-062ddd9
-0001fc30: 3066 6236 6638 3236 3761 272c 2020 2320  0fb6f8267a',  # 
-0001fc40: 4e76 6964 6961 2069 6d61 6765 0a20 2020  Nvidia image.   
-0001fc50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001fc60: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0001fc70: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0001fc80: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0001fc90: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0001fca0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001fcb0: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-0001fcc0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001fcd0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001fce0: 742e 6d61 726b 2e6b 7562 6572 6e65 7465  t.mark.kubernete
-0001fcf0: 730a 4070 7974 6573 742e 6d61 726b 2e70  s.@pytest.mark.p
-0001fd00: 6172 616d 6574 7269 7a65 280a 2020 2020  arametrize(.    
-0001fd10: 2769 6d61 6765 5f69 6427 2c0a 2020 2020  'image_id',.    
-0001fd20: 5b0a 2020 2020 2020 2020 2764 6f63 6b65  [.        'docke
-0001fd30: 723a 6e76 6964 6961 2f63 7564 613a 3131  r:nvidia/cuda:11
-0001fd40: 2e38 2e30 2d64 6576 656c 2d75 6275 6e74  .8.0-devel-ubunt
-0001fd50: 7531 382e 3034 272c 0a20 2020 2020 2020  u18.04',.       
-0001fd60: 2027 646f 636b 6572 3a75 6275 6e74 753a   'docker:ubuntu:
-0001fd70: 3138 2e30 3427 2c0a 2020 2020 2020 2020  18.04',.        
-0001fd80: 2320 5465 7374 206c 6174 6573 7420 696d  # Test latest im
-0001fd90: 6167 6520 7769 7468 2070 7974 686f 6e20  age with python 
-0001fda0: 332e 3131 2069 6e73 7461 6c6c 6564 2062  3.11 installed b
-0001fdb0: 7920 6465 6661 756c 742e 0a20 2020 2020  y default..     
-0001fdc0: 2020 2027 646f 636b 6572 3a63 6f6e 7469     'docker:conti
-0001fdd0: 6e75 756d 696f 2f6d 696e 6963 6f6e 6461  nuumio/miniconda
-0001fde0: 333a 3234 2e31 2e32 2d30 272c 0a20 2020  3:24.1.2-0',.   
-0001fdf0: 2020 2020 2023 2054 6573 7420 7079 7468       # Test pyth
-0001fe00: 6f6e 3e3d 332e 3132 2077 6865 7265 2053  on>=3.12 where S
-0001fe10: 6b79 5069 6c6f 7420 7368 6f75 6c64 2061  kyPilot should a
-0001fe20: 7574 6f6d 6174 6963 616c 6c79 2063 7265  utomatically cre
-0001fe30: 6174 6520 6120 7365 7061 7261 7465 0a20  ate a separate. 
-0001fe40: 2020 2020 2020 2023 2063 6f6e 6461 2065         # conda e
-0001fe50: 6e76 2066 6f72 2072 756e 7469 6d65 2077  nv for runtime w
-0001fe60: 6974 6820 7079 7468 6f6e 2033 2e31 302e  ith python 3.10.
-0001fe70: 0a20 2020 2020 2020 2027 646f 636b 6572  .        'docker
-0001fe80: 3a63 6f6e 7469 6e75 756d 696f 2f6d 696e  :continuumio/min
-0001fe90: 6963 6f6e 6461 333a 6c61 7465 7374 272c  iconda3:latest',
-0001fea0: 0a20 2020 205d 290a 6465 6620 7465 7374  .    ]).def test
-0001feb0: 5f6b 7562 6572 6e65 7465 735f 6375 7374  _kubernetes_cust
-0001fec0: 6f6d 5f69 6d61 6765 2869 6d61 6765 5f69  om_image(image_i
-0001fed0: 6429 3a0a 2020 2020 2222 2254 6573 7420  d):.    """Test 
-0001fee0: 4b75 6265 726e 6574 6573 2063 7573 746f  Kubernetes custo
-0001fef0: 6d20 696d 6167 6522 2222 0a20 2020 206e  m image""".    n
-0001ff00: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0001ff10: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0001ff20: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0001ff30: 2020 2027 7465 7374 2d6b 7562 6572 6e65     'test-kuberne
-0001ff40: 7465 732d 6375 7374 6f6d 2d69 6d61 6765  tes-custom-image
-0001ff50: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0001ff60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0001ff70: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-0001ff80: 2d2d 7265 7472 792d 756e 7469 6c2d 7570  --retry-until-up
-0001ff90: 202d 7920 7465 7374 732f 7465 7374 5f79   -y tests/test_y
-0001ffa0: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
-0001ffb0: 5f69 6d61 6765 2e79 616d 6c20 2d2d 636c  _image.yaml --cl
-0001ffc0: 6f75 6420 6b75 6265 726e 6574 6573 202d  oud kubernetes -
-0001ffd0: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
-0001ffe0: 5f69 647d 202d 2d72 6567 696f 6e20 4e6f  _id} --region No
-0001fff0: 6e65 202d 2d67 7075 7320 5434 3a31 272c  ne --gpus T4:1',
-00020000: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020010: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00020020: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00020030: 2020 2020 2020 2020 2320 5472 7920 6578          # Try ex
-00020040: 6563 2074 6f20 7275 6e20 6167 6169 6e20  ec to run again 
-00020050: 616e 6420 6368 6563 6b20 6966 2074 6865  and check if the
-00020060: 206c 6f67 7320 6172 6520 7072 696e 7465   logs are printe
-00020070: 640a 2020 2020 2020 2020 2020 2020 6627  d.            f'
-00020080: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00020090: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-000200a0: 2f74 6573 745f 6375 7374 6f6d 5f69 6d61  /test_custom_ima
-000200b0: 6765 2e79 616d 6c20 2d2d 636c 6f75 6420  ge.yaml --cloud 
-000200c0: 6b75 6265 726e 6574 6573 202d 2d69 6d61  kubernetes --ima
-000200d0: 6765 2d69 6420 7b69 6d61 6765 5f69 647d  ge-id {image_id}
-000200e0: 202d 2d72 6567 696f 6e20 4e6f 6e65 202d   --region None -
-000200f0: 2d67 7075 7320 5434 3a31 207c 2067 7265  -gpus T4:1 | gre
-00020100: 7020 2248 656c 6c6f 2031 3030 2227 2c0a  p "Hello 100"',.
-00020110: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00020120: 6b65 2073 7572 6520 7373 6820 6973 2077  ke sure ssh is w
-00020130: 6f72 6b69 6e67 2077 6974 6820 6375 7374  orking with cust
-00020140: 6f6d 2075 7365 726e 616d 650a 2020 2020  om username.    
-00020150: 2020 2020 2020 2020 6627 7373 6820 7b6e          f'ssh {n
-00020160: 616d 657d 2065 6368 6f20 6869 207c 2067  ame} echo hi | g
-00020170: 7265 7020 6869 272c 0a20 2020 2020 2020  rep hi',.       
-00020180: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00020190: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000201a0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-000201b0: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
-000201c0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000201d0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-000201e0: 7374 2e6d 6172 6b2e 736c 6f77 0a64 6566  st.mark.slow.def
-000201f0: 2074 6573 745f 617a 7572 655f 7374 6172   test_azure_star
-00020200: 745f 7374 6f70 5f74 776f 5f6e 6f64 6573  t_stop_two_nodes
-00020210: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00020220: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00020230: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00020240: 7374 280a 2020 2020 2020 2020 2761 7a75  st(.        'azu
-00020250: 7265 2d73 7461 7274 2d73 746f 702d 7477  re-start-stop-tw
-00020260: 6f2d 6e6f 6465 7327 2c0a 2020 2020 2020  o-nodes',.      
-00020270: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00020280: 6627 736b 7920 6c61 756e 6368 202d 2d6e  f'sky launch --n
-00020290: 756d 2d6e 6f64 6573 3d32 202d 7920 2d63  um-nodes=2 -y -c
-000202a0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-000202b0: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
-000202c0: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-000202d0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-000202e0: 2d2d 6e75 6d2d 6e6f 6465 733d 3220 7b6e  --num-nodes=2 {n
-000202f0: 616d 657d 2065 7861 6d70 6c65 732f 617a  ame} examples/az
-00020300: 7572 655f 7374 6172 745f 7374 6f70 2e79  ure_start_stop.y
-00020310: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00020320: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00020330: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00020340: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00020350: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00020360: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00020370: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
-00020380: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020390: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
-000203a0: 657d 202d 6920 3127 2c0a 2020 2020 2020  e} -i 1',.      
-000203b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000203c0: 202d 2d6e 756d 2d6e 6f64 6573 3d32 207b   --num-nodes=2 {
-000203d0: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
-000203e0: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
-000203f0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00020400: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00020410: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00020420: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00020430: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00020440: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00020450: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
-00020460: 2020 2020 6627 733d 2428 736b 7920 7374      f's=$(sky st
-00020470: 6174 7573 202d 7220 7b6e 616d 657d 2920  atus -r {name}) 
-00020480: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-00020490: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000204a0: 2022 494e 4954 5c7c 5354 4f50 5045 4422   "INIT\|STOPPED"
-000204b0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-000204c0: 7c7c 207b 7b20 7373 6820 7b6e 616d 657d  || {{ ssh {name}
-000204d0: 2022 6361 7420 7e2f 2e73 6b79 2f73 6b79   "cat ~/.sky/sky
-000204e0: 6c65 742e 6c6f 6722 3b20 6578 6974 2031  let.log"; exit 1
-000204f0: 3b20 7d7d 270a 2020 2020 2020 2020 5d2c  ; }}'.        ],
-00020500: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00020510: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00020520: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00020530: 3330 202a 2036 302c 2020 2320 3330 206d  30 * 60,  # 30 m
-00020540: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
-00020550: 726f 756e 6420 7e32 3320 6d69 6e73 290a  round ~23 mins).
-00020560: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00020570: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00020580: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00020590: 696e 6720 656e 7620 666f 7220 6469 736b  ing env for disk
-000205a0: 2074 6965 7220 2d2d 2d2d 2d2d 2d2d 2d2d   tier ----------
-000205b0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-000205c0: 730a 6465 6620 7465 7374 5f61 7773 5f64  s.def test_aws_d
-000205d0: 6973 6b5f 7469 6572 2829 3a0a 0a20 2020  isk_tier():..   
-000205e0: 2064 6566 205f 6765 745f 6177 735f 7175   def _get_aws_qu
-000205f0: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-00020600: 6f6e 2c20 696e 7374 616e 6365 5f69 642c  on, instance_id,
-00020610: 2066 6965 6c64 2c20 6578 7065 6374 6564   field, expected
-00020620: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00020630: 6e20 2866 2761 7773 2065 6332 2064 6573  n (f'aws ec2 des
-00020640: 6372 6962 652d 766f 6c75 6d65 7320 2d2d  cribe-volumes --
-00020650: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00020660: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00020670: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
-00020680: 6d65 3d61 7474 6163 686d 656e 742e 696e  me=attachment.in
-00020690: 7374 616e 6365 2d69 642c 5661 6c75 6573  stance-id,Values
-000206a0: 3d7b 696e 7374 616e 6365 5f69 647d 2027  ={instance_id} '
-000206b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000206c0: 2066 272d 2d71 7565 7279 2056 6f6c 756d   f'--query Volum
-000206d0: 6573 5b2a 5d2e 7b66 6965 6c64 7d20 7c20  es[*].{field} | 
-000206e0: 6772 6570 207b 6578 7065 6374 6564 7d20  grep {expected} 
-000206f0: 3b20 2729 0a0a 2020 2020 666f 7220 6469  ; ')..    for di
-00020700: 736b 5f74 6965 7220 696e 206c 6973 7428  sk_tier in list(
-00020710: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
-00020720: 4469 736b 5469 6572 293a 0a20 2020 2020  DiskTier):.     
-00020730: 2020 2073 7065 6373 203d 2041 5753 2e5f     specs = AWS._
-00020740: 6765 745f 6469 736b 5f73 7065 6373 2864  get_disk_specs(d
-00020750: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
-00020760: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00020770: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
-00020780: 2d27 202b 2064 6973 6b5f 7469 6572 2e76  -' + disk_tier.v
-00020790: 616c 7565 0a20 2020 2020 2020 206e 616d  alue.        nam
-000207a0: 655f 6f6e 5f63 6c6f 7564 203d 2063 6f6d  e_on_cloud = com
-000207b0: 6d6f 6e5f 7574 696c 732e 6d61 6b65 5f63  mon_utils.make_c
-000207c0: 6c75 7374 6572 5f6e 616d 655f 6f6e 5f63  luster_name_on_c
-000207d0: 6c6f 7564 280a 2020 2020 2020 2020 2020  loud(.          
-000207e0: 2020 6e61 6d65 2c20 736b 792e 4157 532e    name, sky.AWS.
-000207f0: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
-00020800: 5f6c 656e 6774 6828 2929 0a20 2020 2020  _length()).     
-00020810: 2020 2072 6567 696f 6e20 3d20 2775 732d     region = 'us-
-00020820: 6561 7374 2d32 270a 2020 2020 2020 2020  east-2'.        
-00020830: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00020840: 2020 2020 2020 2020 2027 6177 732d 6469           'aws-di
-00020850: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
-00020860: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
-00020870: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-00020880: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00020890: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-000208a0: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
-000208b0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-000208c0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-000208d0: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-000208e0: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
-000208f0: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
-00020900: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-00020910: 2020 2020 2020 2020 6627 6964 3d60 6177          f'id=`aw
-00020920: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-00020930: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00020940: 6e20 7b72 6567 696f 6e7d 202d 2d66 696c  n {region} --fil
-00020950: 7465 7273 2027 0a20 2020 2020 2020 2020  ters '.         
-00020960: 2020 2020 2020 2066 274e 616d 653d 7461         f'Name=ta
-00020970: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-00020980: 6d65 2c56 616c 7565 733d 7b6e 616d 655f  me,Values={name_
-00020990: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
-000209a0: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
-000209b0: 2020 2020 6627 5265 7365 7276 6174 696f      f'Reservatio
-000209c0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
-000209d0: 2e49 6e73 7461 6e63 6549 6420 2d2d 6f75  .InstanceId --ou
-000209e0: 7470 7574 2074 6578 7460 3b20 2720 2b0a  tput text`; ' +.
-000209f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a00: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
-00020a10: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2027  ommand(region, '
-00020a20: 2469 6427 2c20 2756 6f6c 756d 6554 7970  $id', 'VolumeTyp
-00020a30: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00020a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a50: 2020 2020 2020 2020 2020 2073 7065 6373             specs
-00020a60: 5b27 6469 736b 5f74 6965 7227 5d29 202b  ['disk_tier']) +
-00020a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020a80: 2028 2727 2069 6620 6469 736b 5f74 6965   ('' if disk_tie
-00020a90: 7220 3d3d 2072 6573 6f75 7263 6573 5f75  r == resources_u
-00020aa0: 7469 6c73 2e44 6973 6b54 6965 722e 4c4f  tils.DiskTier.LO
-00020ab0: 5720 656c 7365 0a20 2020 2020 2020 2020  W else.         
-00020ac0: 2020 2020 2020 2020 285f 6765 745f 6177          (_get_aw
-00020ad0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
-00020ae0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
-00020af0: 496f 7073 272c 0a20 2020 2020 2020 2020  Iops',.         
-00020b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b20: 7370 6563 735b 2764 6973 6b5f 696f 7073  specs['disk_iops
-00020b30: 275d 2920 2b0a 2020 2020 2020 2020 2020  ']) +.          
-00020b40: 2020 2020 2020 2020 5f67 6574 5f61 7773          _get_aws
-00020b50: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
-00020b60: 6567 696f 6e2c 2027 2469 6427 2c20 2754  egion, '$id', 'T
-00020b70: 6872 6f75 6768 7075 7427 2c0a 2020 2020  hroughput',.    
-00020b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ba0: 2020 2020 2073 7065 6373 5b27 6469 736b       specs['disk
-00020bb0: 5f74 6872 6f75 6768 7075 7427 5d29 2929  _throughput'])))
-00020bc0: 2c0a 2020 2020 2020 2020 2020 2020 5d2c  ,.            ],
-00020bd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00020be0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00020bf0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00020c00: 7469 6d65 6f75 743d 3130 202a 2036 302c  timeout=10 * 60,
-00020c10: 2020 2320 3130 206d 696e 7320 2028 6974    # 10 mins  (it
-00020c20: 2074 616b 6573 2061 726f 756e 6420 7e36   takes around ~6
-00020c30: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
-00020c40: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
-00020c50: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00020c60: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-00020c70: 6566 2074 6573 745f 6763 705f 6469 736b  ef test_gcp_disk
-00020c80: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
-00020c90: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
-00020ca0: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
-00020cb0: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
-00020cc0: 2020 2020 2020 7479 7065 203d 2047 4350        type = GCP
-00020cd0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
-00020ce0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
-00020cf0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00020d00: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
-00020d10: 272d 2720 2b20 6469 736b 5f74 6965 722e  '-' + disk_tier.
-00020d20: 7661 6c75 650a 2020 2020 2020 2020 6e61  value.        na
-00020d30: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-00020d40: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-00020d50: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00020d60: 636c 6f75 6428 0a20 2020 2020 2020 2020  cloud(.         
-00020d70: 2020 206e 616d 652c 2073 6b79 2e47 4350     name, sky.GCP
-00020d80: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
-00020d90: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
-00020da0: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-00020db0: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
-00020dc0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00020dd0: 2020 2020 2020 2020 2027 6763 702d 6469           'gcp-di
-00020de0: 736b 2d74 6965 722d 2720 2b20 6469 736b  sk-tier-' + disk
-00020df0: 5f74 6965 722e 7661 6c75 652c 0a20 2020  _tier.value,.   
-00020e00: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
-00020e10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00020e20: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00020e30: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00020e40: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00020e50: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-00020e60: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-00020e70: 6572 207b 6469 736b 5f74 6965 722e 7661  er {disk_tier.va
-00020e80: 6c75 657d 2065 6368 6f20 2268 656c 6c6f  lue} echo "hello
-00020e90: 2073 6b79 2227 2c0a 2020 2020 2020 2020   sky"',.        
-00020ea0: 2020 2020 2020 2020 6627 6e61 6d65 3d60          f'name=`
-00020eb0: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-00020ec0: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
-00020ed0: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
-00020ee0: 2020 2020 2020 2020 2066 2722 6c61 6265           f'"labe
-00020ef0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-00020f00: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
-00020f10: 7564 7d22 2027 0a20 2020 2020 2020 2020  ud}" '.         
-00020f20: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
-00020f30: 3d22 7661 6c75 6528 6e61 6d65 2922 603b  ="value(name)"`;
-00020f40: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00020f50: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
-00020f60: 7574 6520 6469 736b 7320 6c69 7374 202d  ute disks list -
-00020f70: 2d66 696c 7465 723d 226e 616d 653d 246e  -filter="name=$n
-00020f80: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
-00020f90: 2020 2020 2020 2066 272d 2d66 6f72 6d61         f'--forma
-00020fa0: 743d 2276 616c 7565 2874 7970 6529 2220  t="value(type)" 
-00020fb0: 7c20 6772 6570 207b 7479 7065 7d20 270a  | grep {type} '.
-00020fc0: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-00020fd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00020fe0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00020ff0: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
-00021000: 6d65 6f75 743d 3620 2a20 3630 2c20 2023  meout=6 * 60,  #
-00021010: 2036 206d 696e 7320 2028 6974 2074 616b   6 mins  (it tak
-00021020: 6573 2061 726f 756e 6420 7e33 206d 696e  es around ~3 min
-00021030: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
-00021040: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-00021050: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00021060: 742e 6d61 726b 2e61 7a75 7265 0a64 6566  t.mark.azure.def
-00021070: 2074 6573 745f 617a 7572 655f 6469 736b   test_azure_disk
-00021080: 5f74 6965 7228 293a 0a20 2020 2066 6f72  _tier():.    for
-00021090: 2064 6973 6b5f 7469 6572 2069 6e20 6c69   disk_tier in li
-000210a0: 7374 2872 6573 6f75 7263 6573 5f75 7469  st(resources_uti
-000210b0: 6c73 2e44 6973 6b54 6965 7229 3a0a 2020  ls.DiskTier):.  
-000210c0: 2020 2020 2020 6966 2064 6973 6b5f 7469        if disk_ti
-000210d0: 6572 203d 3d20 7265 736f 7572 6365 735f  er == resources_
-000210e0: 7574 696c 732e 4469 736b 5469 6572 2e48  utils.DiskTier.H
-000210f0: 4947 483a 0a20 2020 2020 2020 2020 2020  IGH:.           
-00021100: 2023 2041 7a75 7265 2064 6f65 7320 6e6f   # Azure does no
-00021110: 7420 7375 7070 6f72 7420 6869 6768 2064  t support high d
-00021120: 6973 6b20 7469 6572 2e0a 2020 2020 2020  isk tier..      
-00021130: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00021140: 2020 2020 2020 2074 7970 6520 3d20 417a         type = Az
-00021150: 7572 652e 5f67 6574 5f64 6973 6b5f 7479  ure._get_disk_ty
-00021160: 7065 2864 6973 6b5f 7469 6572 290a 2020  pe(disk_tier).  
-00021170: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
-00021180: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00021190: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
-000211a0: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
-000211b0: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
-000211c0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-000211d0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-000211e0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
-000211f0: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
-00021200: 417a 7572 652e 6d61 785f 636c 7573 7465  Azure.max_cluste
-00021210: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
-00021220: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
-00021230: 3d20 2777 6573 7475 7332 270a 2020 2020  = 'westus2'.    
-00021240: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00021250: 0a20 2020 2020 2020 2020 2020 2027 617a  .            'az
-00021260: 7572 652d 6469 736b 2d74 6965 722d 2720  ure-disk-tier-' 
-00021270: 2b20 6469 736b 5f74 6965 722e 7661 6c75  + disk_tier.valu
-00021280: 652c 0a20 2020 2020 2020 2020 2020 205b  e,.            [
-00021290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000212a0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000212b0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000212c0: 7564 2061 7a75 7265 202d 2d72 6567 696f  ud azure --regio
-000212d0: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-000212e0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-000212f0: 2d64 6973 6b2d 7469 6572 207b 6469 736b  -disk-tier {disk
-00021300: 5f74 6965 722e 7661 6c75 657d 2065 6368  _tier.value} ech
-00021310: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
-00021320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021330: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
-00021340: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
-00021350: 7374 6572 2d6e 616d 653d 7b6e 616d 655f  ster-name={name_
-00021360: 6f6e 5f63 6c6f 7564 7d20 2d2d 7175 6572  on_cloud} --quer
-00021370: 7920 270a 2020 2020 2020 2020 2020 2020  y '.            
-00021380: 2020 2020 6627 225b 3f74 7970 653d 3d5c      f'"[?type==\
-00021390: 274d 6963 726f 736f 6674 2e43 6f6d 7075  'Microsoft.Compu
-000213a0: 7465 2f64 6973 6b73 5c27 5d2e 736b 752e  te/disks\'].sku.
-000213b0: 6e61 6d65 2220 270a 2020 2020 2020 2020  name" '.        
-000213c0: 2020 2020 2020 2020 6627 2d2d 6f75 7470          f'--outp
-000213d0: 7574 2074 7376 207c 2067 7265 7020 7b74  ut tsv | grep {t
-000213e0: 7970 657d 270a 2020 2020 2020 2020 2020  ype}'.          
-000213f0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
-00021400: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00021410: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00021420: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00021430: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
-00021440: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-00021450: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
-00021460: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
-00021470: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00021480: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00021490: 617a 7572 650a 6465 6620 7465 7374 5f61  azure.def test_a
-000214a0: 7a75 7265 5f62 6573 745f 7469 6572 5f66  zure_best_tier_f
-000214b0: 6169 6c6f 7665 7228 293a 0a20 2020 2074  ailover():.    t
-000214c0: 7970 6520 3d20 417a 7572 652e 5f67 6574  ype = Azure._get
-000214d0: 5f64 6973 6b5f 7479 7065 2872 6573 6f75  _disk_type(resou
-000214e0: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
-000214f0: 6965 722e 4c4f 5729 0a20 2020 206e 616d  ier.LOW).    nam
-00021500: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00021510: 5f6e 616d 6528 290a 2020 2020 6e61 6d65  _name().    name
-00021520: 5f6f 6e5f 636c 6f75 6420 3d20 636f 6d6d  _on_cloud = comm
-00021530: 6f6e 5f75 7469 6c73 2e6d 616b 655f 636c  on_utils.make_cl
-00021540: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
-00021550: 6f75 6428 0a20 2020 2020 2020 206e 616d  oud(.        nam
-00021560: 652c 2073 6b79 2e41 7a75 7265 2e6d 6178  e, sky.Azure.max
-00021570: 5f63 6c75 7374 6572 5f6e 616d 655f 6c65  _cluster_name_le
-00021580: 6e67 7468 2829 290a 2020 2020 7265 6769  ngth()).    regi
-00021590: 6f6e 203d 2027 7765 7374 7573 3227 0a20  on = 'westus2'. 
-000215a0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000215b0: 2020 2020 2020 2020 2761 7a75 7265 2d62          'azure-b
-000215c0: 6573 742d 7469 6572 2d66 6169 6c6f 7665  est-tier-failove
-000215d0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
-000215e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000215f0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00021600: 6d65 7d20 2d2d 636c 6f75 6420 617a 7572  me} --cloud azur
-00021610: 6520 2d2d 7265 6769 6f6e 207b 7265 6769  e --region {regi
-00021620: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00021630: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-00021640: 6265 7374 202d 2d69 6e73 7461 6e63 652d  best --instance-
-00021650: 7479 7065 2053 7461 6e64 6172 645f 4438  type Standard_D8
-00021660: 5f76 3520 6563 686f 2022 6865 6c6c 6f20  _v5 echo "hello 
-00021670: 736b 7922 272c 0a20 2020 2020 2020 2020  sky"',.         
-00021680: 2020 2066 2761 7a20 7265 736f 7572 6365     f'az resource
-00021690: 206c 6973 7420 2d2d 7461 6720 7261 792d   list --tag ray-
-000216a0: 636c 7573 7465 722d 6e61 6d65 3d7b 6e61  cluster-name={na
-000216b0: 6d65 5f6f 6e5f 636c 6f75 647d 202d 2d71  me_on_cloud} --q
-000216c0: 7565 7279 2027 0a20 2020 2020 2020 2020  uery '.         
-000216d0: 2020 2066 2722 5b3f 7479 7065 3d3d 5c27     f'"[?type==\'
-000216e0: 4d69 6372 6f73 6f66 742e 436f 6d70 7574  Microsoft.Comput
-000216f0: 652f 6469 736b 735c 275d 2e73 6b75 2e6e  e/disks\'].sku.n
-00021700: 616d 6522 2027 0a20 2020 2020 2020 2020  ame" '.         
-00021710: 2020 2066 272d 2d6f 7574 7075 7420 7473     f'--output ts
-00021720: 7620 7c20 6772 6570 207b 7479 7065 7d27  v | grep {type}'
-00021730: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00021740: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00021750: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00021760: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00021770: 2036 302c 2020 2320 3230 206d 696e 7320   60,  # 20 mins 
-00021780: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
-00021790: 6420 7e31 3220 6d69 6e73 290a 2020 2020  d ~12 mins).    
-000217a0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000217b0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-000217c0: 2d2d 2d20 5465 7374 696e 6720 5a65 726f  --- Testing Zero
-000217d0: 2051 756f 7461 2046 6169 6c6f 7665 7220   Quota Failover 
-000217e0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-000217f0: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00021800: 5f61 7773 5f7a 6572 6f5f 7175 6f74 615f  _aws_zero_quota_
-00021810: 6661 696c 6f76 6572 2829 3a0a 0a20 2020  failover():..   
-00021820: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00021830: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00021840: 7265 6769 6f6e 203d 2067 6574 5f61 7773  region = get_aws
-00021850: 5f72 6567 696f 6e5f 666f 725f 7175 6f74  _region_for_quot
-00021860: 615f 6661 696c 6f76 6572 2829 0a0a 2020  a_failover()..  
-00021870: 2020 6966 206e 6f74 2072 6567 696f 6e3a    if not region:
-00021880: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-00021890: 7866 6169 6c28 0a20 2020 2020 2020 2020  xfail(.         
-000218a0: 2020 2027 556e 6162 6c65 2074 6f20 7465     'Unable to te
-000218b0: 7374 207a 6572 6f20 7175 6f74 6120 6661  st zero quota fa
-000218c0: 696c 6f76 6572 206f 7074 696d 697a 6174  ilover optimizat
-000218d0: 696f 6e20 e280 9420 7175 6f74 6173 2027  ion ... quotas '
-000218e0: 0a20 2020 2020 2020 2020 2020 2027 666f  .            'fo
-000218f0: 7220 4543 3220 5033 2069 6e73 7461 6e63  r EC2 P3 instanc
-00021900: 6573 2077 6572 6520 666f 756e 6420 6f6e  es were found on
-00021910: 2061 6c6c 2041 5753 2072 6567 696f 6e73   all AWS regions
-00021920: 2e20 4973 2074 6869 7320 270a 2020 2020  . Is this '.    
-00021930: 2020 2020 2020 2020 2765 7870 6563 7465          'expecte
-00021940: 6420 666f 7220 796f 7572 2061 6363 6f75  d for your accou
-00021950: 6e74 3f27 290a 2020 2020 2020 2020 7265  nt?').        re
-00021960: 7475 726e 0a0a 2020 2020 7465 7374 203d  turn..    test =
-00021970: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00021980: 6177 732d 7a65 726f 2d71 756f 7461 2d66  aws-zero-quota-f
-00021990: 6169 6c6f 7665 7227 2c0a 2020 2020 2020  ailover',.      
-000219a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-000219b0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-000219c0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-000219d0: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
-000219e0: 7265 6769 6f6e 7d20 2d2d 6770 7573 2056  region} --gpus V
-000219f0: 3130 303a 3820 2d2d 7573 652d 7370 6f74  100:8 --use-spot
-00021a00: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
-00021a10: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
-00021a20: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00021a30: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00021a40: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00021a50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00021a60: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00021a70: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00021a80: 705f 7a65 726f 5f71 756f 7461 5f66 6169  p_zero_quota_fai
-00021a90: 6c6f 7665 7228 293a 0a0a 2020 2020 6e61  lover():..    na
-00021aa0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00021ab0: 725f 6e61 6d65 2829 0a20 2020 2072 6567  r_name().    reg
-00021ac0: 696f 6e20 3d20 6765 745f 6763 705f 7265  ion = get_gcp_re
-00021ad0: 6769 6f6e 5f66 6f72 5f71 756f 7461 5f66  gion_for_quota_f
-00021ae0: 6169 6c6f 7665 7228 290a 0a20 2020 2069  ailover()..    i
-00021af0: 6620 6e6f 7420 7265 6769 6f6e 3a0a 2020  f not region:.  
-00021b00: 2020 2020 2020 7079 7465 7374 2e78 6661        pytest.xfa
-00021b10: 696c 280a 2020 2020 2020 2020 2020 2020  il(.            
-00021b20: 2755 6e61 626c 6520 746f 2074 6573 7420  'Unable to test 
-00021b30: 7a65 726f 2071 756f 7461 2066 6169 6c6f  zero quota failo
-00021b40: 7665 7220 6f70 7469 6d69 7a61 7469 6f6e  ver optimization
-00021b50: 20e2 8094 2071 756f 7461 7320 270a 2020   ... quotas '.  
-00021b60: 2020 2020 2020 2020 2020 2766 6f72 2041            'for A
-00021b70: 3130 302d 3830 4742 2047 5055 7320 7765  100-80GB GPUs we
-00021b80: 7265 2066 6f75 6e64 206f 6e20 616c 6c20  re found on all 
-00021b90: 4743 5020 7265 6769 6f6e 732e 2049 7320  GCP regions. Is 
-00021ba0: 7468 6973 2027 0a20 2020 2020 2020 2020  this '.         
-00021bb0: 2020 2027 6578 7065 6374 6564 2066 6f72     'expected for
-00021bc0: 2079 6f75 7220 6163 636f 756e 743f 2729   your account?')
-00021bd0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-00021be0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00021bf0: 280a 2020 2020 2020 2020 2767 6370 2d7a  (.        'gcp-z
-00021c00: 6572 6f2d 7175 6f74 612d 6661 696c 6f76  ero-quota-failov
-00021c10: 6572 272c 0a20 2020 2020 2020 205b 0a20  er',.        [. 
-00021c20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00021c30: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00021c40: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00021c50: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00021c60: 6e7d 202d 2d67 7075 7320 4131 3030 2d38  n} --gpus A100-8
-00021c70: 3047 423a 3120 2d2d 7573 652d 7370 6f74  0GB:1 --use-spot
-00021c80: 207c 2067 7265 7020 2246 6f75 6e64 206e   | grep "Found n
-00021c90: 6f20 7175 6f74 6122 272c 0a20 2020 2020  o quota"',.     
-00021ca0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00021cb0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00021cc0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00021cd0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00021ce0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00021cf0: 2054 6573 7469 6e67 2073 6b79 7365 7276   Testing skyserv
-00021d00: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a64  e ----------...d
-00021d10: 6566 205f 6765 745f 7365 7276 6963 655f  ef _get_service_
-00021d20: 6e61 6d65 2829 202d 3e20 7374 723a 0a20  name() -> str:. 
-00021d30: 2020 2022 2222 5265 7475 726e 7320 6120     """Returns a 
-00021d40: 7573 6572 2d75 6e69 7175 6520 7365 7276  user-unique serv
-00021d50: 6963 6520 6e61 6d65 2066 6f72 2065 6163  ice name for eac
-00021d60: 6820 7465 7374 5f73 6b79 7365 7276 655f  h test_skyserve_
-00021d70: 3c6e 616d 653e 2829 2e0a 0a20 2020 204d  <name>()...    M
-00021d80: 7573 7420 6265 2063 616c 6c65 6420 6672  ust be called fr
-00021d90: 6f6d 2065 6163 6820 7465 7374 5f73 6b79  om each test_sky
-00021da0: 7365 7276 655f 3c6e 616d 653e 2829 2e0a  serve_<name>()..
-00021db0: 2020 2020 2222 220a 2020 2020 6361 6c6c      """.    call
-00021dc0: 6572 5f66 756e 635f 6e61 6d65 203d 2069  er_func_name = i
-00021dd0: 6e73 7065 6374 2e73 7461 636b 2829 5b31  nspect.stack()[1
-00021de0: 5d5b 335d 0a20 2020 2074 6573 745f 6e61  ][3].    test_na
-00021df0: 6d65 203d 2063 616c 6c65 725f 6675 6e63  me = caller_func
-00021e00: 5f6e 616d 652e 7265 706c 6163 6528 275f  _name.replace('_
-00021e10: 272c 2027 2d27 292e 7265 706c 6163 6528  ', '-').replace(
-00021e20: 2774 6573 742d 272c 2027 742d 2729 0a20  'test-', 't-'). 
-00021e30: 2020 2074 6573 745f 6e61 6d65 203d 2074     test_name = t
-00021e40: 6573 745f 6e61 6d65 2e72 6570 6c61 6365  est_name.replace
-00021e50: 2827 736b 7973 6572 7665 2d27 2c20 2773  ('skyserve-', 's
-00021e60: 732d 2729 0a20 2020 2074 6573 745f 6e61  s-').    test_na
-00021e70: 6d65 203d 2063 6f6d 6d6f 6e5f 7574 696c  me = common_util
-00021e80: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-00021e90: 616d 655f 6f6e 5f63 6c6f 7564 2874 6573  ame_on_cloud(tes
-00021ea0: 745f 6e61 6d65 2c20 3234 290a 2020 2020  t_name, 24).    
-00021eb0: 7265 7475 726e 2066 277b 7465 7374 5f6e  return f'{test_n
-00021ec0: 616d 657d 2d7b 7465 7374 5f69 647d 270a  ame}-{test_id}'.
-00021ed0: 0a0a 2320 5765 2063 6865 636b 2074 6865  ..# We check the
-00021ee0: 206f 7574 7075 7420 6f66 2074 6865 2073   output of the s
-00021ef0: 6b79 7365 7276 6520 7365 7276 6963 6520  kyserve service 
-00021f00: 746f 2073 6565 2069 6620 6974 2069 7320  to see if it is 
-00021f10: 7265 6164 792e 204f 7574 7075 7420 6f66  ready. Output of
-00021f20: 0a23 2060 5245 504c 4943 4153 6020 6973  .# `REPLICAS` is
-00021f30: 2069 6e20 7468 6520 666f 726d 206f 6620   in the form of 
-00021f40: 6031 2f32 6020 7768 6572 6520 7468 6520  `1/2` where the 
-00021f50: 6669 7273 7420 6e75 6d62 6572 2069 7320  first number is 
-00021f60: 7468 6520 6e75 6d62 6572 206f 660a 2320  the number of.# 
-00021f70: 7265 6164 7920 7265 706c 6963 6173 2061  ready replicas a
-00021f80: 6e64 2074 6865 2073 6563 6f6e 6420 6e75  nd the second nu
-00021f90: 6d62 6572 2069 7320 7468 6520 6e75 6d62  mber is the numb
-00021fa0: 6572 206f 6620 746f 7461 6c20 7265 706c  er of total repl
-00021fb0: 6963 6173 2e20 5765 0a23 2067 7265 7020  icas. We.# grep 
-00021fc0: 7375 6368 2066 6f72 6d61 7420 746f 2065  such format to e
-00021fd0: 6e73 7572 6520 7468 6174 2074 6865 2073  nsure that the s
-00021fe0: 6572 7669 6365 2069 7320 7265 6164 792c  ervice is ready,
-00021ff0: 2061 6e64 2065 6172 6c79 2065 7869 7420   and early exit 
-00022000: 6966 2061 6e79 0a23 2066 6169 6c75 7265  if any.# failure
-00022010: 2064 6574 6563 7465 642e 2049 6e20 7468   detected. In th
-00022020: 6520 656e 6420 7765 2073 6c65 6570 2066  e end we sleep f
-00022030: 6f72 0a23 2073 6572 7665 2e4c 425f 434f  or.# serve.LB_CO
-00022040: 4e54 524f 4c4c 4552 5f53 594e 435f 494e  NTROLLER_SYNC_IN
-00022050: 5445 5256 414c 5f53 4543 4f4e 4453 2074  TERVAL_SECONDS t
-00022060: 6f20 6d61 6b65 2073 7572 6520 6c6f 6164  o make sure load
-00022070: 2062 616c 616e 6365 7220 6861 7665 0a23   balancer have.#
-00022080: 2065 6e6f 7567 6820 7469 6d65 2074 6f20   enough time to 
-00022090: 7379 6e63 2077 6974 6820 7468 6520 636f  sync with the co
-000220a0: 6e74 726f 6c6c 6572 2061 6e64 2067 6574  ntroller and get
-000220b0: 2061 6c6c 2072 6561 6479 2072 6570 6c69   all ready repli
-000220c0: 6361 2049 5073 2e0a 5f53 4552 5645 5f57  ca IPs.._SERVE_W
-000220d0: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
-000220e0: 3d20 280a 2020 2020 277b 7b20 7768 696c  = (.    '{{ whil
-000220f0: 6520 7472 7565 3b20 646f 270a 2020 2020  e true; do'.    
-00022100: 2720 2020 2020 733d 2428 736b 7920 7365  '     s=$(sky se
-00022110: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
-00022120: 7d29 3b20 6563 686f 2022 2473 223b 270a  }); echo "$s";'.
-00022130: 2020 2020 2720 2020 2020 6563 686f 2022      '     echo "
-00022140: 2473 2220 7c20 6772 6570 202d 7120 227b  $s" | grep -q "{
-00022150: 7265 706c 6963 615f 6e75 6d7d 2f7b 7265  replica_num}/{re
-00022160: 706c 6963 615f 6e75 6d7d 2220 2626 2062  plica_num}" && b
-00022170: 7265 616b 3b27 0a20 2020 2027 2020 2020  reak;'.    '    
-00022180: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00022190: 7020 2d71 2022 4641 494c 4544 2220 2626  p -q "FAILED" &&
-000221a0: 2065 7869 7420 313b 270a 2020 2020 2720   exit 1;'.    ' 
-000221b0: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
-000221c0: 2020 2027 2064 6f6e 653b 207d 7d3b 2065     ' done; }}; e
-000221d0: 6368 6f20 2247 6f74 2073 6572 7669 6365  cho "Got service
-000221e0: 2073 7461 7475 7320 2473 223b 270a 2020   status $s";'.  
-000221f0: 2020 6627 736c 6565 7020 7b73 6572 7665    f'sleep {serve
-00022200: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
-00022210: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
-00022220: 4f4e 4453 202b 2032 7d3b 2729 0a5f 4950  ONDS + 2};')._IP
-00022230: 5f52 4547 4558 203d 2072 2728 5b30 2d39  _REGEX = r'([0-9
-00022240: 5d7b 312c 337d 5c2e 297b 337d 5b30 2d39  ]{1,3}\.){3}[0-9
-00022250: 5d7b 312c 337d 270a 5f41 574b 5f41 4c4c  ]{1,3}'._AWK_ALL
-00022260: 5f4c 494e 4553 5f42 454c 4f57 5f52 4550  _LINES_BELOW_REP
-00022270: 4c49 4341 5320 3d20 7227 2f52 6570 6c69  LICAS = r'/Repli
-00022280: 6361 732f 7b66 6c61 673d 313b 206e 6578  cas/{flag=1; nex
-00022290: 747d 2066 6c61 6727 0a5f 5345 5256 4943  t} flag'._SERVIC
-000222a0: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-000222b0: 5553 5f52 4547 4558 203d 2027 5052 4f56  US_REGEX = 'PROV
-000222c0: 4953 494f 4e49 4e47 5c7c 5354 4152 5449  ISIONING\|STARTI
-000222d0: 4e47 270a 2320 5369 6e63 6520 7765 2064  NG'.# Since we d
-000222e0: 6f6e 2774 2061 6c6c 6f77 2074 6572 6d69  on't allow termi
-000222f0: 6e61 7465 2074 6865 2073 6572 7669 6365  nate the service
-00022300: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
-00022310: 6572 2069 7320 494e 4954 2c0a 2320 7768  er is INIT,.# wh
-00022320: 6963 6820 6973 2063 6f6d 6d6f 6e20 666f  ich is common fo
-00022330: 7220 7369 6d75 6c74 616e 656f 7573 2070  r simultaneous p
-00022340: 7974 6573 742c 2077 6520 6e65 6564 2074  ytest, we need t
-00022350: 6f20 7761 6974 2075 6e74 696c 2074 6865  o wait until the
-00022360: 0a23 2063 6f6e 7472 6f6c 6c65 7220 6973  .# controller is
-00022370: 2055 5020 6265 666f 7265 2077 6520 6361   UP before we ca
-00022380: 6e20 7465 726d 696e 6174 6520 7468 6520  n terminate the 
-00022390: 7365 7276 6963 652e 0a23 2054 6865 2074  service..# The t
-000223a0: 6561 7264 6f77 6e20 636f 6d6d 616e 6420  eardown command 
-000223b0: 6861 7320 6120 3130 2d6d 696e 7320 7469  has a 10-mins ti
-000223c0: 6d65 6f75 742c 2073 6f20 7765 2064 6f6e  meout, so we don
-000223d0: 2774 206e 6565 6420 746f 2064 6f0a 2320  't need to do.# 
-000223e0: 7468 6520 7469 6d65 6f75 7420 6865 7265  the timeout here
-000223f0: 2e20 5365 6520 696d 706c 656d 656e 7461  . See implementa
-00022400: 7469 6f6e 206f 6620 7275 6e5f 6f6e 655f  tion of run_one_
-00022410: 7465 7374 2829 2066 6f72 2064 6574 6169  test() for detai
-00022420: 6c73 2e0a 5f54 4541 5244 4f57 4e5f 5345  ls.._TEARDOWN_SE
-00022430: 5256 4943 4520 3d20 280a 2020 2020 2728  RVICE = (.    '(
-00022440: 666f 7220 6920 696e 2060 7365 7120 3120  for i in `seq 1 
-00022450: 3230 603b 2064 6f27 0a20 2020 2027 2020  20`; do'.    '  
-00022460: 2020 2073 3d24 2873 6b79 2073 6572 7665     s=$(sky serve
-00022470: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d29   down -y {name})
-00022480: 3b27 0a20 2020 2027 2020 2020 2065 6368  ;'.    '     ech
-00022490: 6f20 2254 7279 696e 6720 746f 2074 6572  o "Trying to ter
-000224a0: 6d69 6e61 7465 207b 6e61 6d65 7d22 3b27  minate {name}";'
-000224b0: 0a20 2020 2027 2020 2020 2065 6368 6f20  .    '     echo 
-000224c0: 2224 7322 3b27 0a20 2020 2027 2020 2020  "$s";'.    '    
-000224d0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-000224e0: 7020 2d71 2022 7363 6865 6475 6c65 6420  p -q "scheduled 
-000224f0: 746f 2062 6520 7465 726d 696e 6174 6564  to be terminated
-00022500: 5c7c 4e6f 2073 6572 7669 6365 2074 6f20  \|No service to 
-00022510: 7465 726d 696e 6174 6522 2026 2620 6272  terminate" && br
-00022520: 6561 6b3b 270a 2020 2020 2720 2020 2020  eak;'.    '     
-00022530: 736c 6565 7020 3130 3b27 0a20 2020 2027  sleep 10;'.    '
-00022540: 2020 2020 205b 2024 6920 2d65 7120 3230       [ $i -eq 20
-00022550: 205d 2026 2620 6563 686f 2022 4661 696c   ] && echo "Fail
-00022560: 6564 2074 6f20 7465 726d 696e 6174 6520  ed to terminate 
-00022570: 7365 7276 6963 6520 7b6e 616d 657d 223b  service {name}";
-00022580: 270a 2020 2020 2764 6f6e 6529 2729 0a0a  '.    'done)')..
-00022590: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
-000225a0: 5741 4954 203d 2028 0a20 2020 2027 6578  WAIT = (.    'ex
-000225b0: 706f 7274 204f 5249 4749 4e5f 534b 5950  port ORIGIN_SKYP
-000225c0: 494c 4f54 5f44 4542 5547 3d24 534b 5950  ILOT_DEBUG=$SKYP
-000225d0: 494c 4f54 5f44 4542 5547 3b20 6578 706f  ILOT_DEBUG; expo
-000225e0: 7274 2053 4b59 5049 4c4f 545f 4445 4255  rt SKYPILOT_DEBU
-000225f0: 473d 303b 2027 0a20 2020 2027 656e 6470  G=0; '.    'endp
-00022600: 6f69 6e74 3d24 2873 6b79 2073 6572 7665  oint=$(sky serve
-00022610: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
-00022620: 6e74 207b 6e61 6d65 7d29 3b20 270a 2020  nt {name}); '.  
-00022630: 2020 2775 6e74 696c 2021 2065 6368 6f20    'until ! echo 
-00022640: 2224 656e 6470 6f69 6e74 2220 7c20 6772  "$endpoint" | gr
-00022650: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
-00022660: 7320 696e 6974 6961 6c69 7a69 6e67 223b  s initializing";
-00022670: 2027 0a20 2020 2027 646f 2065 6368 6f20   '.    'do echo 
-00022680: 2257 6169 7469 6e67 2066 6f72 2073 6572  "Waiting for ser
-00022690: 7665 2065 6e64 706f 696e 7420 746f 2062  ve endpoint to b
-000226a0: 6520 7265 6164 792e 2e2e 223b 2027 0a20  e ready..."; '. 
-000226b0: 2020 2027 736c 6565 7020 353b 2065 6e64     'sleep 5; end
-000226c0: 706f 696e 743d 2428 736b 7920 7365 7276  point=$(sky serv
-000226d0: 6520 7374 6174 7573 202d 2d65 6e64 706f  e status --endpo
-000226e0: 696e 7420 7b6e 616d 657d 293b 2064 6f6e  int {name}); don
-000226f0: 653b 2027 0a20 2020 2027 6578 706f 7274  e; '.    'export
-00022700: 2053 4b59 5049 4c4f 545f 4445 4255 473d   SKYPILOT_DEBUG=
-00022710: 244f 5249 4749 4e5f 534b 5950 494c 4f54  $ORIGIN_SKYPILOT
-00022720: 5f44 4542 5547 3b20 6563 686f 2022 2465  _DEBUG; echo "$e
-00022730: 6e64 706f 696e 7422 2729 0a0a 5f53 4552  ndpoint"').._SER
-00022740: 5645 5f53 5441 5455 535f 5741 4954 203d  VE_STATUS_WAIT =
-00022750: 2028 2773 3d24 2873 6b79 2073 6572 7665   ('s=$(sky serve
-00022760: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00022770: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00022780: 2020 2020 2020 2020 2027 756e 7469 6c20           'until 
-00022790: 2120 6563 686f 2022 2473 2220 7c20 6772  ! echo "$s" | gr
-000227a0: 6570 2022 436f 6e74 726f 6c6c 6572 2069  ep "Controller i
-000227b0: 7320 696e 6974 6961 6c69 7a69 6e67 2e22  s initializing."
-000227c0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-000227d0: 2020 2020 2020 2020 2020 2764 6f20 6563            'do ec
-000227e0: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-000227f0: 7365 7276 6520 7374 6174 7573 2074 6f20  serve status to 
-00022800: 6265 2072 6561 6479 2e2e 2e22 3b20 270a  be ready..."; '.
-00022810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022820: 2020 2020 2020 2773 6c65 6570 2035 3b20        'sleep 5; 
-00022830: 733d 2428 736b 7920 7365 7276 6520 7374  s=$(sky serve st
-00022840: 6174 7573 207b 6e61 6d65 7d29 3b20 646f  atus {name}); do
-00022850: 6e65 3b20 6563 686f 2022 2473 2227 290a  ne; echo "$s"').
-00022860: 0a0a 6465 6620 5f67 6574 5f72 6570 6c69  ..def _get_repli
-00022870: 6361 5f69 7028 6e61 6d65 3a20 7374 722c  ca_ip(name: str,
-00022880: 2072 6570 6c69 6361 5f69 643a 2069 6e74   replica_id: int
-00022890: 2920 2d3e 2073 7472 3a0a 2020 2020 7265  ) -> str:.    re
-000228a0: 7475 726e 2028 6627 6970 7b72 6570 6c69  turn (f'ip{repli
-000228b0: 6361 5f69 647d 3d24 2865 6368 6f20 2224  ca_id}=$(echo "$
-000228c0: 7322 207c 2027 0a20 2020 2020 2020 2020  s" | '.         
-000228d0: 2020 2066 2761 776b 2022 7b5f 4157 4b5f     f'awk "{_AWK_
-000228e0: 414c 4c5f 4c49 4e45 535f 4245 4c4f 575f  ALL_LINES_BELOW_
-000228f0: 5245 504c 4943 4153 7d22 207c 2027 0a20  REPLICAS}" | '. 
-00022900: 2020 2020 2020 2020 2020 2066 2767 7265             f'gre
-00022910: 7020 2d45 2022 7b6e 616d 657d 5c73 2b7b  p -E "{name}\s+{
-00022920: 7265 706c 6963 615f 6964 7d22 207c 2027  replica_id}" | '
-00022930: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-00022940: 7265 7020 2d45 6f20 227b 5f49 505f 5245  rep -Eo "{_IP_RE
-00022950: 4745 587d 2229 2729 0a0a 0a64 6566 205f  GEX}")')...def _
-00022960: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00022970: 705f 7465 7374 286e 616d 653a 2073 7472  p_test(name: str
-00022980: 2c20 636c 6f75 643a 2073 7472 2c0a 2020  , cloud: str,.  
-00022990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229a0: 2020 2020 2020 2020 2020 7469 6d65 6f75            timeou
-000229b0: 745f 6d69 6e75 7465 733a 2069 6e74 2920  t_minutes: int) 
-000229c0: 2d3e 2054 6573 743a 0a20 2020 2074 6573  -> Test:.    tes
-000229d0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000229e0: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
-000229f0: 652d 7b63 6c6f 7564 2e72 6570 6c61 6365  e-{cloud.replace
-00022a00: 2822 5f22 2c20 222d 2229 7d27 2c0a 2020  ("_", "-")}',.  
-00022a10: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00022a20: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00022a30: 7570 202d 6e20 7b6e 616d 657d 202d 7920  up -n {name} -y 
-00022a40: 7465 7374 732f 736b 7973 6572 7665 2f68  tests/skyserve/h
-00022a50: 7474 702f 7b63 6c6f 7564 7d2e 7961 6d6c  ttp/{cloud}.yaml
-00022a60: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00022a70: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00022a80: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00022a90: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00022aa0: 5f6e 756d 3d32 292c 0a20 2020 2020 2020  _num=2),.       
-00022ab0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00022ac0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00022ad0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00022ae0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00022af0: 6375 726c 2068 7474 703a 2f2f 2465 6e64  curl http://$end
-00022b00: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-00022b10: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00022b20: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00022b30: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00022b40: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00022b50: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00022b60: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
-00022b70: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
-00022b80: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-00022b90: 6e20 7465 7374 0a0a 0a64 6566 205f 6368  n test...def _ch
-00022ba0: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00022bb0: 7461 7475 7328 6e61 6d65 3a20 7374 722c  tatus(name: str,
-00022bc0: 2063 6865 636b 5f74 7570 6c65 733a 204c   check_tuples: L
-00022bd0: 6973 745b 5475 706c 655b 696e 742c 2062  ist[Tuple[int, b
-00022be0: 6f6f 6c2c 0a20 2020 2020 2020 2020 2020  ool,.           
-00022bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c20: 2020 2020 2020 7374 725d 5d29 202d 3e20        str]]) -> 
-00022c30: 7374 723a 0a20 2020 2022 2222 4368 6563  str:.    """Chec
-00022c40: 6b20 7265 706c 6963 6173 2720 7374 6174  k replicas' stat
-00022c50: 7573 2061 6e64 2063 6f75 6e74 2069 6e20  us and count in 
-00022c60: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
-00022c70: 0a0a 2020 2020 5765 2077 696c 6c20 6368  ..    We will ch
-00022c80: 6563 6b20 7643 5055 3d32 2c20 6173 2061  eck vCPU=2, as a
-00022c90: 6c6c 206f 7572 2074 6573 7473 2075 7365  ll our tests use
-00022ca0: 2076 4350 553d 322e 0a20 2020 200a 2020   vCPU=2..    .  
-00022cb0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-00022cc0: 6e61 6d65 3a20 7468 6520 6e61 6d65 206f  name: the name o
-00022cd0: 6620 7468 6520 7365 7276 6963 650a 2020  f the service.  
-00022ce0: 2020 2020 2020 6368 6563 6b5f 7475 706c        check_tupl
-00022cf0: 6573 3a20 4120 6c69 7374 206f 6620 7265  es: A list of re
-00022d00: 706c 6963 6120 7072 6f70 6572 7479 2074  plica property t
-00022d10: 6f20 6368 6563 6b2e 2045 6163 6820 7475  o check. Each tu
-00022d20: 706c 6520 6973 0a20 2020 2020 2020 2020  ple is.         
-00022d30: 2020 2028 636f 756e 742c 2069 735f 7370     (count, is_sp
-00022d40: 6f74 2c20 7374 6174 7573 290a 2020 2020  ot, status).    
-00022d50: 2222 220a 2020 2020 6368 6563 6b5f 636d  """.    check_cm
-00022d60: 6420 3d20 2727 0a20 2020 2066 6f72 2063  d = ''.    for c
-00022d70: 6865 636b 5f74 7570 6c65 2069 6e20 6368  heck_tuple in ch
-00022d80: 6563 6b5f 7475 706c 6573 3a0a 2020 2020  eck_tuples:.    
-00022d90: 2020 2020 636f 756e 742c 2069 735f 7370      count, is_sp
-00022da0: 6f74 2c20 7374 6174 7573 203d 2063 6865  ot, status = che
-00022db0: 636b 5f74 7570 6c65 0a20 2020 2020 2020  ck_tuple.       
-00022dc0: 2072 6573 6f75 7263 655f 7374 7220 3d20   resource_str = 
-00022dd0: 2727 0a20 2020 2020 2020 2069 6620 7374  ''.        if st
-00022de0: 6174 7573 206e 6f74 2069 6e20 5b27 5045  atus not in ['PE
-00022df0: 4e44 494e 4727 2c20 2753 4855 5454 494e  NDING', 'SHUTTIN
-00022e00: 475f 444f 574e 270a 2020 2020 2020 2020  G_DOWN'.        
-00022e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e20: 205d 2061 6e64 206e 6f74 2073 7461 7475   ] and not statu
-00022e30: 732e 7374 6172 7473 7769 7468 2827 4641  s.startswith('FA
-00022e40: 494c 4544 2729 3a0a 2020 2020 2020 2020  ILED'):.        
-00022e50: 2020 2020 7370 6f74 5f73 7472 203d 2027      spot_str = '
-00022e60: 270a 2020 2020 2020 2020 2020 2020 6966  '.            if
-00022e70: 2069 735f 7370 6f74 3a0a 2020 2020 2020   is_spot:.      
-00022e80: 2020 2020 2020 2020 2020 7370 6f74 5f73            spot_s
-00022e90: 7472 203d 2027 5c5b 5370 6f74 5c5d 270a  tr = '\[Spot\]'.
-00022ea0: 2020 2020 2020 2020 2020 2020 7265 736f              reso
-00022eb0: 7572 6365 5f73 7472 203d 2066 2728 7b73  urce_str = f'({s
-00022ec0: 706f 745f 7374 727d 7643 5055 3d32 2927  pot_str}vCPU=2)'
-00022ed0: 0a20 2020 2020 2020 2063 6865 636b 5f63  .        check_c
-00022ee0: 6d64 202b 3d20 2866 2720 6563 686f 2022  md += (f' echo "
-00022ef0: 2473 2220 7c20 6772 6570 2022 7b72 6573  $s" | grep "{res
-00022f00: 6f75 7263 655f 7374 727d 2220 7c20 270a  ource_str}" | '.
-00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f20: 2020 2020 2020 6627 6772 6570 2022 7b73        f'grep "{s
-00022f30: 7461 7475 737d 2220 7c20 7763 202d 6c20  tatus}" | wc -l 
-00022f40: 7c20 6772 6570 207b 636f 756e 747d 207c  | grep {count} |
-00022f50: 7c20 6578 6974 2031 3b27 290a 2020 2020  | exit 1;').    
-00022f60: 7265 7475 726e 2028 6627 7b5f 5345 5256  return (f'{_SERV
-00022f70: 455f 5354 4154 5553 5f57 4149 542e 666f  E_STATUS_WAIT.fo
-00022f80: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00022f90: 3b20 6563 686f 2022 2473 223b 2027 202b  ; echo "$s"; ' +
-00022fa0: 2063 6865 636b 5f63 6d64 290a 0a0a 6465   check_cmd)...de
-00022fb0: 6620 5f63 6865 636b 5f73 6572 7669 6365  f _check_service
-00022fc0: 5f76 6572 7369 6f6e 2873 6572 7669 6365  _version(service
-00022fd0: 5f6e 616d 653a 2073 7472 2c20 7665 7273  _name: str, vers
-00022fe0: 696f 6e3a 2073 7472 2920 2d3e 2073 7472  ion: str) -> str
-00022ff0: 3a0a 2020 2020 2320 4772 6570 2074 6865  :.    # Grep the
-00023000: 206c 696e 6573 2062 6566 6f72 6520 2753   lines before 'S
-00023010: 6572 7669 6365 2052 6570 6c69 6361 7327  ervice Replicas'
-00023020: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
-00023030: 6520 7365 7276 6963 6520 7665 7273 696f  e service versio
-00023040: 6e0a 2020 2020 2320 6973 2063 6f72 7265  n.    # is corre
-00023050: 6374 2e0a 2020 2020 7265 7475 726e 2028  ct..    return (
-00023060: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
-00023070: 6570 202d 4231 3030 3020 2253 6572 7669  ep -B1000 "Servi
-00023080: 6365 2052 6570 6c69 6361 7322 207c 2027  ce Replicas" | '
-00023090: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
-000230a0: 7265 7020 2d45 2022 7b73 6572 7669 6365  rep -E "{service
-000230b0: 5f6e 616d 657d 5c73 2b7b 7665 7273 696f  _name}\s+{versio
-000230c0: 6e7d 2220 7c7c 2065 7869 7420 313b 2027  n}" || exit 1; '
-000230d0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-000230e0: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-000230f0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
-00023100: 5f73 6b79 7365 7276 655f 6763 705f 6874  _skyserve_gcp_ht
-00023110: 7470 2829 3a0a 2020 2020 2222 2254 6573  tp():.    """Tes
-00023120: 7420 736b 7973 6572 7665 206f 6e20 4743  t skyserve on GC
-00023130: 5022 2222 0a20 2020 206e 616d 6520 3d20  P""".    name = 
-00023140: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00023150: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-00023160: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00023170: 705f 7465 7374 286e 616d 652c 2027 6763  p_test(name, 'gc
-00023180: 7027 2c20 3230 290a 2020 2020 7275 6e5f  p', 20).    run_
-00023190: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000231a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-000231b0: 730a 4070 7974 6573 742e 6d61 726b 2e73  s.@pytest.mark.s
-000231c0: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
-000231d0: 7973 6572 7665 5f61 7773 5f68 7474 7028  yserve_aws_http(
-000231e0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-000231f0: 6b79 7365 7276 6520 6f6e 2041 5753 2222  kyserve on AWS""
-00023200: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-00023210: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-00023220: 0a20 2020 2074 6573 7420 3d20 5f67 6574  .    test = _get
-00023230: 5f73 6b79 7365 7276 655f 6874 7470 5f74  _skyserve_http_t
-00023240: 6573 7428 6e61 6d65 2c20 2761 7773 272c  est(name, 'aws',
-00023250: 2032 3029 0a20 2020 2072 756e 5f6f 6e65   20).    run_one
-00023260: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00023270: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
-00023280: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00023290: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-000232a0: 7365 7276 655f 617a 7572 655f 6874 7470  serve_azure_http
-000232b0: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-000232c0: 736b 7973 6572 7665 206f 6e20 417a 7572  skyserve on Azur
-000232d0: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
-000232e0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-000232f0: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-00023300: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-00023310: 705f 7465 7374 286e 616d 652c 2027 617a  p_test(name, 'az
-00023320: 7572 6527 2c20 3330 290a 2020 2020 7275  ure', 30).    ru
-00023330: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00023340: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00023350: 6b75 6265 726e 6574 6573 0a40 7079 7465  kubernetes.@pyte
-00023360: 7374 2e6d 6172 6b2e 7365 7276 650a 6465  st.mark.serve.de
-00023370: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
-00023380: 6b75 6265 726e 6574 6573 5f68 7474 7028  kubernetes_http(
-00023390: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
-000233a0: 6b79 7365 7276 6520 6f6e 204b 7562 6572  kyserve on Kuber
-000233b0: 6e65 7465 7322 2222 0a20 2020 206e 616d  netes""".    nam
-000233c0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
-000233d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000233e0: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
-000233f0: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
-00023400: 2027 6b75 6265 726e 6574 6573 272c 2033   'kubernetes', 3
-00023410: 3029 0a20 2020 2072 756e 5f6f 6e65 5f74  0).    run_one_t
-00023420: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00023430: 6573 742e 6d61 726b 2e73 6572 7665 0a64  est.mark.serve.d
-00023440: 6566 2074 6573 745f 736b 7973 6572 7665  ef test_skyserve
-00023450: 5f6c 6c6d 2867 656e 6572 6963 5f63 6c6f  _llm(generic_clo
-00023460: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00023470: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
-00023480: 6974 6820 7265 616c 204c 4c4d 2075 7365  ith real LLM use
-00023490: 6361 7365 2222 220a 2020 2020 6e61 6d65  case""".    name
-000234a0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-000234b0: 6e61 6d65 2829 0a0a 2020 2020 6465 6620  name()..    def 
-000234c0: 6765 6e65 7261 7465 5f6c 6c6d 5f74 6573  generate_llm_tes
-000234d0: 745f 636f 6d6d 616e 6428 7072 6f6d 7074  t_command(prompt
-000234e0: 3a20 7374 722c 2065 7870 6563 7465 645f  : str, expected_
-000234f0: 6f75 7470 7574 3a20 7374 7229 202d 3e20  output: str) -> 
-00023500: 7374 723a 0a20 2020 2020 2020 2070 726f  str:.        pro
-00023510: 6d70 7420 3d20 7368 6c65 782e 7175 6f74  mpt = shlex.quot
-00023520: 6528 7072 6f6d 7074 290a 2020 2020 2020  e(prompt).      
-00023530: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
-00023540: 7420 3d20 7368 6c65 782e 7175 6f74 6528  t = shlex.quote(
-00023550: 6578 7065 6374 6564 5f6f 7574 7075 7429  expected_output)
-00023560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00023570: 280a 2020 2020 2020 2020 2020 2020 6627  (.            f'
-00023580: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00023590: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-000235a0: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-000235b0: 2020 2020 2020 2020 2770 7974 686f 6e20          'python 
-000235c0: 7465 7374 732f 736b 7973 6572 7665 2f6c  tests/skyserve/l
-000235d0: 6c6d 2f67 6574 5f72 6573 706f 6e73 652e  lm/get_response.
-000235e0: 7079 202d 2d65 6e64 706f 696e 7420 2465  py --endpoint $e
-000235f0: 6e64 706f 696e 7420 270a 2020 2020 2020  ndpoint '.      
-00023600: 2020 2020 2020 6627 2d2d 7072 6f6d 7074        f'--prompt
-00023610: 207b 7072 6f6d 7074 7d20 7c20 6772 6570   {prompt} | grep
-00023620: 207b 6578 7065 6374 6564 5f6f 7574 7075   {expected_outpu
-00023630: 747d 2729 0a0a 2020 2020 7769 7468 206f  t}')..    with o
-00023640: 7065 6e28 2774 6573 7473 2f73 6b79 7365  pen('tests/skyse
-00023650: 7276 652f 6c6c 6d2f 7072 6f6d 7074 5f6f  rve/llm/prompt_o
-00023660: 7574 7075 742e 6a73 6f6e 272c 2027 7227  utput.json', 'r'
-00023670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023680: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00023690: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-000236a0: 7072 6f6d 7074 326f 7574 7075 7420 3d20  prompt2output = 
-000236b0: 6a73 6f6e 2e6c 6f61 6428 6629 0a0a 2020  json.load(f)..  
-000236c0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000236d0: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
-000236e0: 7973 6572 7665 2d6c 6c6d 272c 0a20 2020  yserve-llm',.   
-000236f0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00023700: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00023710: 7020 2d6e 207b 6e61 6d65 7d20 2d2d 636c  p -n {name} --cl
-00023720: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00023730: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-00023740: 7365 7276 652f 6c6c 6d2f 7365 7276 6963  serve/llm/servic
-00023750: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-00023760: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-00023770: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-00023780: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-00023790: 6570 6c69 6361 5f6e 756d 3d31 292c 0a20  eplica_num=1),. 
-000237a0: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
-000237b0: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-000237c0: 6e65 7261 7465 5f6c 6c6d 5f74 6573 745f  nerate_llm_test_
-000237d0: 636f 6d6d 616e 6428 7072 6f6d 7074 2c20  command(prompt, 
-000237e0: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
-000237f0: 2020 2020 2020 2020 666f 7220 7072 6f6d          for prom
-00023800: 7074 2c20 6f75 7470 7574 2069 6e20 7072  pt, output in pr
-00023810: 6f6d 7074 326f 7574 7075 742e 6974 656d  ompt2output.item
-00023820: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00023830: 5d2c 0a20 2020 2020 2020 205d 2c0a 2020  ],.        ],.  
-00023840: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-00023850: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-00023860: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00023870: 2020 2074 696d 656f 7574 3d34 3020 2a20     timeout=40 * 
-00023880: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00023890: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000238a0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000238b0: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-000238c0: 2e73 6572 7665 0a64 6566 2074 6573 745f  .serve.def test_
-000238d0: 736b 7973 6572 7665 5f73 706f 745f 7265  skyserve_spot_re
-000238e0: 636f 7665 7279 2829 3a0a 2020 2020 6e61  covery():.    na
-000238f0: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-00023900: 655f 6e61 6d65 2829 0a20 2020 207a 6f6e  e_name().    zon
-00023910: 6520 3d20 2775 732d 6365 6e74 7261 6c31  e = 'us-central1
-00023920: 2d61 270a 0a20 2020 2074 6573 7420 3d20  -a'..    test = 
-00023930: 5465 7374 280a 2020 2020 2020 2020 6627  Test(.        f'
-00023940: 7465 7374 2d73 6b79 7365 7276 652d 7370  test-skyserve-sp
-00023950: 6f74 2d72 6563 6f76 6572 792d 6763 7027  ot-recovery-gcp'
-00023960: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00023970: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00023980: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00023990: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-000239a0: 7665 2f73 706f 742f 7265 636f 7665 7279  ve/spot/recovery
-000239b0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-000239c0: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-000239d0: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-000239e0: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-000239f0: 706c 6963 615f 6e75 6d3d 3129 2c0a 2020  plica_num=1),.  
-00023a00: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00023a10: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00023a20: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00023a30: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00023a40: 2020 2020 2772 6571 7565 7374 5f6f 7574      'request_out
-00023a50: 7075 743d 2428 6375 726c 2068 7474 703a  put=$(curl http:
-00023a60: 2f2f 2465 6e64 706f 696e 7429 3b20 6563  //$endpoint); ec
-00023a70: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
-00023a80: 7075 7422 3b20 6563 686f 2022 2472 6571  put"; echo "$req
-00023a90: 7565 7374 5f6f 7574 7075 7422 207c 2067  uest_output" | g
-00023aa0: 7265 7020 2248 692c 2053 6b79 5069 6c6f  rep "Hi, SkyPilo
-00023ab0: 7420 6865 7265 2227 2c0a 2020 2020 2020  t here"',.      
-00023ac0: 2020 2020 2020 5f74 6572 6d69 6e61 7465        _terminate
-00023ad0: 5f67 6370 5f72 6570 6c69 6361 286e 616d  _gcp_replica(nam
-00023ae0: 652c 207a 6f6e 652c 2031 292c 0a20 2020  e, zone, 1),.   
-00023af0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00023b00: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00023b10: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00023b20: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
-00023b30: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00023b40: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00023b50: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-00023b60: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
-00023b70: 2020 2020 2020 2020 2027 7265 7175 6573           'reques
-00023b80: 745f 6f75 7470 7574 3d24 2863 7572 6c20  t_output=$(curl 
-00023b90: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
-00023ba0: 293b 2065 6368 6f20 2224 7265 7175 6573  ); echo "$reques
-00023bb0: 745f 6f75 7470 7574 223b 2065 6368 6f20  t_output"; echo 
-00023bc0: 2224 7265 7175 6573 745f 6f75 7470 7574  "$request_output
-00023bd0: 2220 7c20 6772 6570 2022 4869 2c20 536b  " | grep "Hi, Sk
-00023be0: 7950 696c 6f74 2068 6572 6522 272c 0a20  yPilot here"',. 
-00023bf0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00023c00: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-00023c10: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-00023c20: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-00023c30: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00023c40: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00023c50: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00023c60: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
-00023c70: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
-00023c80: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
-00023c90: 2074 6573 745f 736b 7973 6572 7665 5f62   test_skyserve_b
-00023ca0: 6173 655f 6f6e 6465 6d61 6e64 5f66 616c  ase_ondemand_fal
-00023cb0: 6c62 6163 6b28 6765 6e65 7269 635f 636c  lback(generic_cl
-00023cc0: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00023cd0: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00023ce0: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
-00023cf0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00023d00: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-00023d10: 7665 2d62 6173 652d 6f6e 6465 6d61 6e64  ve-base-ondemand
-00023d20: 2d66 616c 6c62 6163 6b27 2c0a 2020 2020  -fallback',.    
-00023d30: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00023d40: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00023d50: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-00023d60: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00023d70: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00023d80: 6572 7665 2f73 706f 742f 6261 7365 5f6f  erve/spot/base_o
-00023d90: 6e64 656d 616e 645f 6661 6c6c 6261 636b  ndemand_fallback
-00023da0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00023db0: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00023dc0: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00023dd0: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00023de0: 706c 6963 615f 6e75 6d3d 3229 2c0a 2020  plica_num=2),.  
-00023df0: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00023e00: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00023e10: 7573 286e 616d 652c 205b 2831 2c20 5472  us(name, [(1, Tr
-00023e20: 7565 2c20 2752 4541 4459 2729 2c0a 2020  ue, 'READY'),.  
-00023e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e50: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
-00023e60: 6c73 652c 2027 5245 4144 5927 295d 292c  lse, 'READY')]),
-00023e70: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00023e80: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00023e90: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00023ea0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00023eb0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00023ec0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00023ed0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00023ee0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-00023ef0: 700a 4070 7974 6573 742e 6d61 726b 2e73  p.@pytest.mark.s
-00023f00: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
-00023f10: 7973 6572 7665 5f64 796e 616d 6963 5f6f  yserve_dynamic_o
-00023f20: 6e64 656d 616e 645f 6661 6c6c 6261 636b  ndemand_fallback
-00023f30: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00023f40: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00023f50: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
-00023f60: 732d 6365 6e74 7261 6c31 2d61 270a 0a20  s-central1-a'.. 
-00023f70: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00023f80: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00023f90: 6b79 7365 7276 652d 6479 6e61 6d69 632d  kyserve-dynamic-
-00023fa0: 6f6e 6465 6d61 6e64 2d66 616c 6c62 6163  ondemand-fallbac
-00023fb0: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
-00023fc0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00023fd0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-00023fe0: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-00023ff0: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
-00024000: 2f73 706f 742f 6479 6e61 6d69 635f 6f6e  /spot/dynamic_on
-00024010: 6465 6d61 6e64 5f66 616c 6c62 6163 6b2e  demand_fallback.
-00024020: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00024030: 2020 2066 2773 6c65 6570 2034 3027 2c0a     f'sleep 40',.
-00024040: 2020 2020 2020 2020 2020 2020 2320 3220              # 2 
-00024050: 6f6e 2d64 656d 616e 6420 2870 726f 7669  on-demand (provi
-00024060: 7369 6f6e 696e 6729 202b 2032 2053 706f  sioning) + 2 Spo
-00024070: 7420 2870 726f 7669 7369 6f6e 696e 6729  t (provisioning)
-00024080: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00024090: 7b5f 5345 5256 455f 5354 4154 5553 5f57  {_SERVE_STATUS_W
-000240a0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
-000240b0: 6e61 6d65 297d 3b20 6563 686f 2022 2473  name)}; echo "$s
-000240c0: 223b 270a 2020 2020 2020 2020 2020 2020  ";'.            
-000240d0: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
-000240e0: 7020 2d71 2022 302f 3422 207c 7c20 6578  p -q "0/4" || ex
-000240f0: 6974 2031 272c 0a20 2020 2020 2020 2020  it 1',.         
-00024100: 2020 2023 2057 6169 7420 666f 7220 7468     # Wait for th
-00024110: 6520 7072 6f76 6973 696f 6e69 6e67 2073  e provisioning s
-00024120: 7461 7274 730a 2020 2020 2020 2020 2020  tarts.          
-00024130: 2020 6627 736c 6565 7020 3430 272c 0a20    f'sleep 40',. 
-00024140: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00024150: 6b5f 7265 706c 6963 615f 696e 5f73 7461  k_replica_in_sta
-00024160: 7475 7328 6e61 6d65 2c20 5b0a 2020 2020  tus(name, [.    
-00024170: 2020 2020 2020 2020 2020 2020 2832 2c20              (2, 
-00024180: 5472 7565 2c20 5f53 4552 5649 4345 5f4c  True, _SERVICE_L
-00024190: 4155 4e43 4849 4e47 5f53 5441 5455 535f  AUNCHING_STATUS_
-000241a0: 5245 4745 5820 2b20 275c 7c52 4541 4459  REGEX + '\|READY
-000241b0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000241c0: 2020 2020 2832 2c20 4661 6c73 652c 205f      (2, False, _
-000241d0: 5345 5256 4943 455f 4c41 554e 4348 494e  SERVICE_LAUNCHIN
-000241e0: 475f 5354 4154 5553 5f52 4547 4558 202b  G_STATUS_REGEX +
-000241f0: 2027 5c7c 5348 5554 5449 4e47 5f44 4f57   '\|SHUTTING_DOW
-00024200: 4e27 290a 2020 2020 2020 2020 2020 2020  N').            
-00024210: 5d29 2c0a 0a20 2020 2020 2020 2020 2020  ]),..           
-00024220: 2023 2057 6169 7420 756e 7469 6c20 3220   # Wait until 2 
-00024230: 7370 6f74 2069 6e73 7461 6e63 6573 2061  spot instances a
-00024240: 7265 2072 6561 6479 2e0a 2020 2020 2020  re ready..      
-00024250: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00024260: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00024270: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00024280: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
-00024290: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-000242a0: 636b 5f72 6570 6c69 6361 5f69 6e5f 7374  ck_replica_in_st
-000242b0: 6174 7573 286e 616d 652c 205b 2832 2c20  atus(name, [(2, 
-000242c0: 5472 7565 2c20 2752 4541 4459 2729 2c0a  True, 'READY'),.
-000242d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242f0: 2020 2020 2020 2020 2020 2020 2830 2c20              (0, 
-00024300: 4661 6c73 652c 2027 2729 5d29 2c0a 2020  False, '')]),.  
-00024310: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
-00024320: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
-00024330: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
-00024340: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00024350: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
-00024360: 2020 2020 2020 2320 3120 6f6e 2d64 656d        # 1 on-dem
-00024370: 616e 6420 2870 726f 7669 7369 6f6e 696e  and (provisionin
-00024380: 6729 202b 2031 2053 706f 7420 2872 6561  g) + 1 Spot (rea
-00024390: 6479 2920 2b20 3120 7370 6f74 2028 7072  dy) + 1 spot (pr
-000243a0: 6f76 6973 696f 6e69 6e67 292e 0a20 2020  ovisioning)..   
-000243b0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-000243c0: 5645 5f53 5441 5455 535f 5741 4954 2e66  VE_STATUS_WAIT.f
-000243d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-000243e0: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
-000243f0: 2027 6563 686f 2022 2473 2220 7c20 6772   'echo "$s" | gr
-00024400: 6570 202d 7120 2231 2f33 2227 2c0a 2020  ep -q "1/3"',.  
-00024410: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00024420: 5f72 6570 6c69 6361 5f69 6e5f 7374 6174  _replica_in_stat
-00024430: 7573 280a 2020 2020 2020 2020 2020 2020  us(.            
-00024440: 2020 2020 6e61 6d65 2c20 5b28 312c 2054      name, [(1, T
-00024450: 7275 652c 2027 5245 4144 5927 292c 0a20  rue, 'READY'),. 
-00024460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024470: 2020 2020 2020 2831 2c20 5472 7565 2c20        (1, True, 
-00024480: 5f53 4552 5649 4345 5f4c 4155 4e43 4849  _SERVICE_LAUNCHI
-00024490: 4e47 5f53 5441 5455 535f 5245 4745 5829  NG_STATUS_REGEX)
-000244a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000244b0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
-000244c0: 7365 2c20 5f53 4552 5649 4345 5f4c 4155  se, _SERVICE_LAU
-000244d0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
-000244e0: 4745 5829 5d29 2c0a 0a20 2020 2020 2020  GEX)]),..       
-000244f0: 2020 2020 2023 2057 6169 7420 756e 7469       # Wait unti
-00024500: 6c20 3220 7370 6f74 2069 6e73 7461 6e63  l 2 spot instanc
-00024510: 6573 2061 7265 2072 6561 6479 2e0a 2020  es are ready..  
-00024520: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
-00024530: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
-00024540: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
-00024550: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
-00024560: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
-00024570: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00024580: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00024590: 2832 2c20 5472 7565 2c20 2752 4541 4459  (2, True, 'READY
-000245a0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-000245b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245d0: 2830 2c20 4661 6c73 652c 2027 2729 5d29  (0, False, '')])
-000245e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000245f0: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-00024600: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00024610: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00024620: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00024630: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00024640: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00024650: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-00024660: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
-00024670: 7973 6572 7665 5f75 7365 725f 6275 675f  yserve_user_bug_
-00024680: 7265 7374 6172 7428 6765 6e65 7269 635f  restart(generic_
-00024690: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-000246a0: 2022 2222 5465 7374 7320 7468 6174 2077   """Tests that w
-000246b0: 6520 7265 7374 6172 7420 7468 6520 7365  e restart the se
-000246c0: 7276 6963 6520 6166 7465 7220 7573 6572  rvice after user
-000246d0: 2062 7567 2e22 2222 0a20 2020 2023 2054   bug.""".    # T
-000246e0: 4f44 4f28 7a68 7775 293a 2074 6869 7320  ODO(zhwu): this 
-000246f0: 6265 6861 7669 6f72 206e 6565 6473 2073  behavior needs s
-00024700: 6f6d 6520 7265 7468 696e 6b69 6e67 2e0a  ome rethinking..
-00024710: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00024720: 7365 7276 6963 655f 6e61 6d65 2829 0a20  service_name(). 
-00024730: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00024740: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00024750: 6b79 7365 7276 652d 7573 6572 2d62 7567  kyserve-user-bug
-00024760: 2d72 6573 7461 7274 272c 0a20 2020 2020  -restart',.     
-00024770: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00024780: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-00024790: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-000247a0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000247b0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-000247c0: 7276 652f 7265 7374 6172 742f 7573 6572  rve/restart/user
-000247d0: 5f62 7567 2e79 616d 6c27 2c0a 2020 2020  _bug.yaml',.    
-000247e0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-000247f0: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
-00024800: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-00024810: 223b 270a 2020 2020 2020 2020 2020 2020  ";'.            
-00024820: 2775 6e74 696c 2065 6368 6f20 2224 7322  'until echo "$s"
-00024830: 207c 2067 7265 7020 2d41 2031 3030 2022   | grep -A 100 "
-00024840: 5365 7276 6963 6520 5265 706c 6963 6173  Service Replicas
-00024850: 2220 7c20 6772 6570 2022 5348 5554 5449  " | grep "SHUTTI
-00024860: 4e47 5f44 4f57 4e22 3b20 270a 2020 2020  NG_DOWN"; '.    
-00024870: 2020 2020 2020 2020 2764 6f20 6563 686f          'do echo
-00024880: 2022 5761 6974 696e 6720 666f 7220 6669   "Waiting for fi
-00024890: 7273 7420 7365 7276 6963 6520 746f 2062  rst service to b
-000248a0: 6520 5348 5554 5449 4e47 2044 4f57 4e2e  e SHUTTING DOWN.
-000248b0: 2e2e 223b 2027 0a20 2020 2020 2020 2020  .."; '.         
-000248c0: 2020 2066 2773 6c65 6570 2035 3b20 733d     f'sleep 5; s=
-000248d0: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-000248e0: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
-000248f0: 2022 2473 223b 2064 6f6e 653b 2027 2c0a   "$s"; done; ',.
+00018020: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
+00018030: 6865 2066 756e 6374 696f 6e61 6c69 7479  he functionality
+00018040: 2066 6f72 206c 6f67 6769 6e67 2e0a 2020   for logging..  
+00018050: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00018060: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+00018070: 207b 6e61 6d65 7d2d 3220 2d2d 6e6f 2d66   {name}-2 --no-f
+00018080: 6f6c 6c6f 7729 3b20 6563 686f 2022 2473  ollow); echo "$s
+00018090: 223b 2065 6368 6f20 2224 7322 207c 2067  "; echo "$s" | g
+000180a0: 7265 7020 2273 7461 7274 2063 6f75 6e74  rep "start count
+000180b0: 696e 6722 272c 0a20 2020 2020 2020 2020  ing"',.         
+000180c0: 2020 2066 2773 3d24 2873 6b79 206a 6f62     f's=$(sky job
+000180d0: 7320 6c6f 6773 202d 2d63 6f6e 7472 6f6c  s logs --control
+000180e0: 6c65 7220 2d6e 207b 6e61 6d65 7d2d 3220  ler -n {name}-2 
+000180f0: 2d2d 6e6f 2d66 6f6c 6c6f 7729 3b20 6563  --no-follow); ec
+00018100: 686f 2022 2473 223b 2065 6368 6f20 2224  ho "$s"; echo "$
+00018110: 7322 207c 2067 7265 7020 2253 7563 6365  s" | grep "Succe
+00018120: 7373 6675 6c6c 7920 7072 6f76 6973 696f  ssfully provisio
+00018130: 6e65 6420 636c 7573 7465 723a 2227 2c0a  ned cluster:"',.
+00018140: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00018150: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00018160: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+00018170: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018180: 2022 5255 4e4e 494e 475c 7c53 5543 4345   "RUNNING\|SUCCE
+00018190: 4544 4544 2227 2c0a 2020 2020 2020 2020  EDED"',.        
+000181a0: 5d2c 0a20 2020 2020 2020 2023 2054 4f44  ],.        # TOD
+000181b0: 4f28 7a68 7775 293a 2043 6861 6e67 6520  O(zhwu): Change 
+000181c0: 746f 205f 4a4f 425f 4341 4e43 454c 5f57  to _JOB_CANCEL_W
+000181d0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+000181e0: 616d 653d 6627 7b6e 616d 657d 2d31 202d  ame=f'{name}-1 -
+000181f0: 6e20 7b6e 616d 657d 2d32 2729 2077 6865  n {name}-2') whe
+00018200: 6e0a 2020 2020 2020 2020 2320 6361 6e63  n.        # canc
+00018210: 656c 696e 6720 6d75 6c74 6970 6c65 206a  eling multiple j
+00018220: 6f62 206e 616d 6573 2069 7320 7375 7070  ob names is supp
+00018230: 6f72 7465 642e 0a20 2020 2020 2020 2028  orted..        (
+00018240: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+00018250: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00018260: 3d66 277b 6e61 6d65 7d2d 3127 2920 2b20  =f'{name}-1') + 
+00018270: 273b 2027 202b 0a20 2020 2020 2020 2020  '; ' +.         
+00018280: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+00018290: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000182a0: 3d66 277b 6e61 6d65 7d2d 3227 2929 2c0a  =f'{name}-2')),.
+000182b0: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+000182c0: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+000182d0: 2073 6b79 206a 6f62 7320 7175 6575 6520   sky jobs queue 
+000182e0: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+000182f0: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+00018300: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
+00018310: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00018320: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00018330: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00018340: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00018350: 6c75 6964 7374 6163 6b20 2023 666c 7569  luidstack  #flui
+00018360: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
+00018370: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00018380: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00018390: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
+000183a0: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
+000183b0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000183c0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000183d0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+000183e0: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+000183f0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+00018400: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00018410: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00018420: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
+00018430: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+00018440: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00018450: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00018460: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00018470: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00018480: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00018490: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+000184a0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+000184b0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+000184c0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+000184d0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+000184e0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
+000184f0: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
+00018500: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
+00018510: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
+00018520: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00018530: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
+00018540: 6f62 730a 6465 6620 7465 7374 5f6a 6f62  obs.def test_job
+00018550: 5f70 6970 656c 696e 6528 6765 6e65 7269  _pipeline(generi
+00018560: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00018570: 2020 2022 2222 5465 7374 2061 206a 6f62     """Test a job
+00018580: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
+00018590: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000185a0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000185b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000185c0: 2020 2020 2020 2773 706f 742d 7069 7065        'spot-pipe
+000185d0: 6c69 6e65 272c 0a20 2020 2020 2020 205b  line',.        [
+000185e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000185f0: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
+00018600: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
+00018610: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
+00018620: 6e65 2e79 616d 6c20 2d79 202d 6427 2c0a  ne.yaml -y -d',.
+00018630: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00018640: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00018650: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00018660: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00018670: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00018680: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00018690: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000186a0: 2020 2020 2020 2020 2320 6067 7265 7020          # `grep 
+000186b0: 2d41 2034 207b 6e61 6d65 7d60 2066 696e  -A 4 {name}` fin
+000186c0: 6473 2074 6865 206a 6f62 2077 6974 6820  ds the job with 
+000186d0: 7b6e 616d 657d 2061 6e64 2074 6865 2034  {name} and the 4
+000186e0: 206c 696e 6573 0a20 2020 2020 2020 2020   lines.         
+000186f0: 2020 2023 2061 6674 6572 2069 742c 2069     # after it, i
+00018700: 2e65 2e20 7468 6520 3420 7461 736b 7320  .e. the 4 tasks 
+00018710: 7769 7468 696e 2074 6865 206a 6f62 2e0a  within the job..
+00018720: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
+00018730: 6564 202d 6e20 3270 6020 6765 7473 2074  ed -n 2p` gets t
+00018740: 6865 2073 6563 6f6e 6420 6c69 6e65 206f  he second line o
+00018750: 6620 7468 6520 3420 6c69 6e65 732c 2069  f the 4 lines, i
+00018760: 2e65 2e20 7468 6520 6669 7273 740a 2020  .e. the first.  
+00018770: 2020 2020 2020 2020 2020 2320 7461 736b            # task
+00018780: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+00018790: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000187a0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+000187b0: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+000187c0: 657d 7c20 7365 6420 2d6e 2032 7020 7c20  e}| sed -n 2p | 
+000187d0: 6772 6570 2022 5354 4152 5449 4e47 5c7c  grep "STARTING\|
+000187e0: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+000187f0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00018800: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00018810: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00018820: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
+00018830: 5045 4e44 494e 4722 272c 0a20 2020 2020  PENDING"',.     
+00018840: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+00018850: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00018860: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+00018870: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00018880: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00018890: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+000188a0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000188b0: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+000188c0: 6420 2d6e 2032 7020 7c20 6772 6570 2022  d -n 2p | grep "
+000188d0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+000188e0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+000188f0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+00018900: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
+00018910: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+00018920: 2d6e 2033 7020 7c20 6772 6570 2022 4341  -n 3p | grep "CA
+00018930: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00018940: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00018950: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00018960: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+00018970: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00018980: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
+00018990: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
+000189a0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+000189b0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+000189c0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
+000189d0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
+000189e0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+000189f0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+00018a00: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00018a10: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00018a20: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00018a30: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00018a40: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00018a50: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+00018a60: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+00018a70: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00018a80: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00018a90: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00018aa0: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
+00018ab0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00018ac0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00018ad0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00018ae0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00018af0: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00018b00: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00018b10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00018b20: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00018b30: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00018b40: 6d65 7d7c 2073 6564 202d 6e20 3570 207c  me}| sed -n 5p |
+00018b50: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+00018b60: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00018b70: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+00018b80: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00018b90: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+00018ba0: 2729 2c0a 2020 2020 2020 2020 2320 496e  '),.        # In
+00018bb0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
+00018bc0: 696e 6365 2073 6b79 206a 6f62 7320 7175  ince sky jobs qu
+00018bd0: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
+00018be0: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
+00018bf0: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
+00018c00: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+00018c10: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00018c20: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00018c30: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00018c40: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+00018c50: 666c 7569 6473 7461 636b 2064 6f65 7320  fluidstack does 
+00018c60: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00018c70: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00018c80: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
+00018c90: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
+00018ca0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00018cb0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00018cc0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+00018cd0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+00018ce0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+00018cf0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00018d00: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00018d10: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
+00018d20: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
+00018d30: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00018d40: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00018d50: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00018d60: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00018d70: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00018d80: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00018d90: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+00018da0: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
+00018db0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00018dc0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00018dd0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00018de0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+00018df0: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
+00018e00: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
+00018e10: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00018e20: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00018e30: 6564 5f6a 6f62 730a 6465 6620 7465 7374  ed_jobs.def test
+00018e40: 5f6d 616e 6167 6564 5f6a 6f62 735f 6661  _managed_jobs_fa
+00018e50: 696c 6564 5f73 6574 7570 2867 656e 6572  iled_setup(gener
+00018e60: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00018e70: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+00018e80: 6765 6420 6a6f 6220 7769 7468 2066 6169  ged job with fai
+00018e90: 6c65 6420 7365 7475 702e 2222 220a 2020  led setup.""".  
+00018ea0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00018eb0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00018ec0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00018ed0: 2020 2020 2020 276d 616e 6167 6564 5f6a        'managed_j
+00018ee0: 6f62 735f 6661 696c 6564 5f73 6574 7570  obs_failed_setup
+00018ef0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00018f00: 2020 2020 2020 2020 2066 2773 6b79 206a           f'sky j
+00018f10: 6f62 7320 6c61 756e 6368 202d 6e20 7b6e  obs launch -n {n
+00018f20: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00018f30: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00018f40: 2d64 2074 6573 7473 2f74 6573 745f 7961  -d tests/test_ya
+00018f50: 6d6c 732f 6661 696c 6564 5f73 6574 7570  mls/failed_setup
+00018f60: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00018f70: 2020 2020 2773 6c65 6570 2033 3330 272c      'sleep 330',
+00018f80: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
+00018f90: 616b 6520 7375 7265 2074 6865 206a 6f62  ake sure the job
+00018fa0: 2066 6169 6c65 6420 7175 6963 6b6c 792e   failed quickly.
+00018fb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018fc0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+00018fd0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00018fe0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018ff0: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00019000: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00019010: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+00019020: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00019030: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+00019040: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+00019050: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+00019060: 7920 6a6f 6273 2071 7565 7565 202d 7220  y jobs queue -r 
+00019070: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+00019080: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+00019090: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+000190a0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+000190b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000190c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000190d0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+000190e0: 6473 7461 636b 2020 2366 6c75 6964 7374  dstack  #fluidst
+000190f0: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
+00019100: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00019110: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00019120: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
+00019130: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
+00019140: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00019150: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00019160: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00019170: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00019180: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00019190: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000191a0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000191b0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+000191c0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+000191d0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+000191e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000191f0: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00019200: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00019210: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00019220: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+00019230: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+00019240: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00019250: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00019260: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00019270: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+00019280: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+00019290: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
+000192a0: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
+000192b0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000192c0: 6172 6b2e 6d61 6e61 6765 645f 6a6f 6273  ark.managed_jobs
+000192d0: 0a64 6566 2074 6573 745f 6d61 6e61 6765  .def test_manage
+000192e0: 645f 6a6f 6273 5f70 6970 656c 696e 655f  d_jobs_pipeline_
+000192f0: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
+00019300: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00019310: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00019320: 6e61 6765 6420 6a6f 6220 7769 7468 2066  naged job with f
+00019330: 6169 6c65 6420 7365 7475 7020 666f 7220  ailed setup for 
+00019340: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
+00019350: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00019360: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00019370: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00019380: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
+00019390: 6a6f 6273 5f70 6970 656c 696e 655f 6661  jobs_pipeline_fa
+000193a0: 696c 6564 5f73 6574 7570 272c 0a20 2020  iled_setup',.   
+000193b0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000193c0: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+000193d0: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
+000193e0: 7920 2d64 2074 6573 7473 2f74 6573 745f  y -d tests/test_
+000193f0: 7961 6d6c 732f 6661 696c 6564 5f73 6574  yamls/failed_set
+00019400: 7570 5f70 6970 656c 696e 652e 7961 6d6c  up_pipeline.yaml
+00019410: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00019420: 736c 6565 7020 3630 3027 2c0a 2020 2020  sleep 600',.    
+00019430: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+00019440: 7572 6520 7468 6520 6a6f 6220 6661 696c  ure the job fail
+00019450: 6564 2071 7569 636b 6c79 2e0a 2020 2020  ed quickly..    
+00019460: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00019470: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+00019480: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+00019490: 202d 6e31 207c 2067 7265 7020 2246 4149   -n1 | grep "FAI
+000194a0: 4c45 445f 5345 5455 5022 272c 0a20 2020  LED_SETUP"',.   
+000194b0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
+000194c0: 3020 7368 6f75 6c64 2062 6520 5355 4343  0 should be SUCC
+000194d0: 4545 4445 442e 0a20 2020 2020 2020 2020  EEDED..         
+000194e0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000194f0: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019500: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019510: 6e20 3270 207c 2067 7265 7020 2253 5543  n 2p | grep "SUC
+00019520: 4345 4544 4544 2227 2c0a 2020 2020 2020  CEEDED"',.      
+00019530: 2020 2020 2020 2320 5461 736b 2031 2073        # Task 1 s
+00019540: 686f 756c 6420 6265 2046 4149 4c45 445f  hould be FAILED_
+00019550: 5345 5455 502e 0a20 2020 2020 2020 2020  SETUP..         
+00019560: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00019570: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019580: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019590: 6e20 3370 207c 2067 7265 7020 2246 4149  n 3p | grep "FAI
+000195a0: 4c45 445f 5345 5455 5022 272c 0a20 2020  LED_SETUP"',.   
+000195b0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
+000195c0: 3220 7368 6f75 6c64 2062 6520 4341 4e43  2 should be CANC
+000195d0: 454c 4c45 442e 0a20 2020 2020 2020 2020  ELLED..         
+000195e0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000195f0: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019600: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019610: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
+00019620: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00019630: 2020 2020 2020 2320 5461 736b 2033 2073        # Task 3 s
+00019640: 686f 756c 6420 6265 2043 414e 4345 4c4c  hould be CANCELL
+00019650: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
+00019660: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+00019670: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
+00019680: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
+00019690: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+000196a0: 4c45 4422 272c 0a20 2020 2020 2020 205d  LED"',.        ]
+000196b0: 2c0a 2020 2020 2020 2020 5f4a 4f42 5f43  ,.        _JOB_C
+000196c0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+000196d0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+000196e0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
+000196f0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
+00019700: 6365 2073 6b79 206a 6f62 7320 7175 6575  ce sky jobs queu
+00019710: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
+00019720: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
+00019730: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
+00019740: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+00019750: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00019760: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00019770: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00019780: 7374 696e 6720 6d61 6e61 6765 6420 6a6f  sting managed jo
+00019790: 6220 7265 636f 7665 7279 202d 2d2d 2d2d  b recovery -----
+000197a0: 2d2d 2d2d 2d0a 0a0a 4070 7974 6573 742e  -----...@pytest.
+000197b0: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
+000197c0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
+000197d0: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
+000197e0: 6765 645f 6a6f 6273 5f72 6563 6f76 6572  ged_jobs_recover
+000197f0: 795f 6177 7328 6177 735f 636f 6e66 6967  y_aws(aws_config
+00019800: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
+00019810: 2254 6573 7420 6d61 6e61 6765 6420 6a6f  "Test managed jo
+00019820: 6220 7265 636f 7665 7279 2e22 2222 0a20  b recovery.""". 
+00019830: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00019840: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00019850: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00019860: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+00019870: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+00019880: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+00019890: 2020 206e 616d 652c 206a 6f62 732e 4a4f     name, jobs.JO
+000198a0: 4253 5f43 4c55 5354 4552 5f4e 414d 455f  BS_CLUSTER_NAME_
+000198b0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
+000198c0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
+000198d0: 7365 290a 2020 2020 7265 6769 6f6e 203d  se).    region =
+000198e0: 2061 7773 5f63 6f6e 6669 675f 7265 6769   aws_config_regi
+000198f0: 6f6e 0a20 2020 2074 6573 7420 3d20 5465  on.    test = Te
+00019900: 7374 280a 2020 2020 2020 2020 276d 616e  st(.        'man
+00019910: 6167 6564 5f6a 6f62 735f 7265 636f 7665  aged_jobs_recove
+00019920: 7279 5f61 7773 272c 0a20 2020 2020 2020  ry_aws',.       
+00019930: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00019940: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+00019950: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+00019960: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+00019970: 2d75 7365 2d73 706f 7420 2d6e 207b 6e61  -use-spot -n {na
+00019980: 6d65 7d20 2265 6368 6f20 534b 5950 494c  me} "echo SKYPIL
+00019990: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
+000199a0: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
+000199b0: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
+000199c0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+000199d0: 2027 736c 6565 7020 3336 3027 2c0a 2020   'sleep 360',.  
+000199e0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+000199f0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019a00: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019a10: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00019a20: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00019a30: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+00019a40: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+00019a50: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019a60: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+00019a70: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+00019a80: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
+00019a90: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
+00019aa0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00019ab0: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
+00019ac0: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+00019ad0: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+00019ae0: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00019af0: 2866 2761 7773 2065 6332 2074 6572 6d69  (f'aws ec2 termi
+00019b00: 6e61 7465 2d69 6e73 7461 6e63 6573 202d  nate-instances -
+00019b10: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00019b20: 202d 2d69 6e73 7461 6e63 652d 6964 7320   --instance-ids 
+00019b30: 2428 270a 2020 2020 2020 2020 2020 2020  $('.            
+00019b40: 2066 2761 7773 2065 6332 2064 6573 6372   f'aws ec2 descr
+00019b50: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+00019b60: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+00019b70: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00019b80: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+00019b90: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+00019ba0: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+00019bb0: 655f 6f6e 5f63 6c6f 7564 7d2a 2027 0a20  e_on_cloud}* '. 
+00019bc0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+00019bd0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
+00019be0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+00019bf0: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
+00019c00: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
+00019c10: 7470 7574 2074 6578 7429 2729 2c0a 2020  tput text)'),.  
+00019c20: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00019c30: 2031 3030 272c 0a20 2020 2020 2020 2020   100',.         
+00019c40: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00019c50: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019c60: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019c70: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+00019c80: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00019c90: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
+00019ca0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00019cb0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019cc0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019cd0: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00019ce0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00019cf0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+00019d00: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
+00019d10: 7275 6e2d 6964 293b 2065 6368 6f20 2224  run-id); echo "$
+00019d20: 5255 4e5f 4944 223b 2073 6b79 206a 6f62  RUN_ID"; sky job
+00019d30: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+00019d40: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+00019d50: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+00019d60: 4b5f 4944 207c 2067 7265 7020 2224 5255  K_ID | grep "$RU
+00019d70: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
+00019d80: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
+00019d90: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00019da0: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+00019db0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00019dc0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
+00019dd0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00019de0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00019df0: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
+00019e00: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
+00019e10: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
+00019e20: 616e 6167 6564 5f6a 6f62 735f 7265 636f  anaged_jobs_reco
+00019e30: 7665 7279 5f67 6370 2829 3a0a 2020 2020  very_gcp():.    
+00019e40: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
+00019e50: 6a6f 6220 7265 636f 7665 7279 2e22 2222  job recovery."""
+00019e60: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00019e70: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00019e80: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
+00019e90: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
+00019ea0: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
+00019eb0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
+00019ec0: 2020 2020 206e 616d 652c 206a 6f62 732e       name, jobs.
+00019ed0: 4a4f 4253 5f43 4c55 5354 4552 5f4e 414d  JOBS_CLUSTER_NAM
+00019ee0: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
+00019ef0: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
+00019f00: 616c 7365 290a 2020 2020 7a6f 6e65 203d  alse).    zone =
+00019f10: 2027 7573 2d65 6173 7434 2d62 270a 2020   'us-east4-b'.  
+00019f20: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
+00019f30: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+00019f40: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+00019f50: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+00019f60: 3d27 0a20 2020 2020 2020 2023 2060 3a60  ='.        # `:`
+00019f70: 206d 6561 6e73 2070 7265 6669 7820 6d61   means prefix ma
+00019f80: 7463 682e 0a20 2020 2020 2020 2066 2722  tch..        f'"
+00019f90: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
+00019fa0: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f6f  ter-name:{name_o
+00019fb0: 6e5f 636c 6f75 647d 2922 2027 0a20 2020  n_cloud})" '.   
+00019fc0: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
+00019fd0: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
+00019fe0: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
+00019ff0: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+0001a000: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+0001a010: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
+0001a020: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
+0001a030: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
+0001a040: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
+0001a050: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
+0001a060: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
+0001a070: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001a080: 6d61 6e61 6765 645f 6a6f 6273 5f72 6563  managed_jobs_rec
+0001a090: 6f76 6572 795f 6763 7027 2c0a 2020 2020  overy_gcp',.    
+0001a0a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001a0b0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
+0001a0c0: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
+0001a0d0: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
+0001a0e0: 207b 6e61 6d65 7d20 2d2d 7573 652d 7370   {name} --use-sp
+0001a0f0: 6f74 202d 2d63 7075 7320 3220 2265 6368  ot --cpus 2 "ech
+0001a100: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
+0001a110: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
+0001a120: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
+0001a130: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+0001a140: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a150: 3336 3027 2c0a 2020 2020 2020 2020 2020  360',.          
+0001a160: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001a170: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001a180: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001a190: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001a1a0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001a1b0: 554e 5f49 443d 2428 736b 7920 6a6f 6273  UN_ID=$(sky jobs
+0001a1c0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001a1d0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001a1e0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+0001a1f0: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
+0001a200: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a210: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+0001a220: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+0001a230: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001a240: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+0001a250: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001a260: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001a270: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001a280: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+0001a290: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001a2a0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001a2b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001a2c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001a2d0: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001a2e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a2f0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+0001a300: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001a310: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001a320: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001a330: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001a340: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001a350: 554e 5f49 443d 2428 6361 7420 2f74 6d70  UN_ID=$(cat /tmp
+0001a360: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 293b  /{name}-run-id);
+0001a370: 2065 6368 6f20 2224 5255 4e5f 4944 223b   echo "$RUN_ID";
+0001a380: 2073 6b79 206a 6f62 7320 6c6f 6773 202d   sky jobs logs -
+0001a390: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001a3a0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001a3b0: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
+0001a3c0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
+0001a3d0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001a3e0: 2020 2020 5f4a 4f42 5f43 414e 4345 4c5f      _JOB_CANCEL_
+0001a3f0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001a400: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001a410: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+0001a420: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001a430: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001a440: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001a450: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+0001a460: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
+0001a470: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
+0001a480: 6a6f 6273 5f70 6970 656c 696e 655f 7265  jobs_pipeline_re
+0001a490: 636f 7665 7279 5f61 7773 2861 7773 5f63  covery_aws(aws_c
+0001a4a0: 6f6e 6669 675f 7265 6769 6f6e 293a 0a20  onfig_region):. 
+0001a4b0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+0001a4c0: 6564 206a 6f62 2072 6563 6f76 6572 7920  ed job recovery 
+0001a4d0: 666f 7220 6120 7069 7065 6c69 6e65 2e22  for a pipeline."
+0001a4e0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001a4f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001a500: 290a 2020 2020 7573 6572 5f68 6173 6820  ).    user_hash 
+0001a510: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e67  = common_utils.g
+0001a520: 6574 5f75 7365 725f 6861 7368 2829 0a20  et_user_hash(). 
+0001a530: 2020 2075 7365 725f 6861 7368 203d 2075     user_hash = u
+0001a540: 7365 725f 6861 7368 5b3a 636f 6d6d 6f6e  ser_hash[:common
+0001a550: 5f75 7469 6c73 2e55 5345 525f 4841 5348  _utils.USER_HASH
+0001a560: 5f4c 454e 4754 485f 494e 5f43 4c55 5354  _LENGTH_IN_CLUST
+0001a570: 4552 5f4e 414d 455d 0a20 2020 2072 6567  ER_NAME].    reg
+0001a580: 696f 6e20 3d20 6177 735f 636f 6e66 6967  ion = aws_config
+0001a590: 5f72 6567 696f 6e0a 2020 2020 6966 2072  _region.    if r
+0001a5a0: 6567 696f 6e20 213d 2027 7573 2d65 6173  egion != 'us-eas
+0001a5b0: 742d 3227 3a0a 2020 2020 2020 2020 7079  t-2':.        py
+0001a5c0: 7465 7374 2e73 6b69 7028 274f 6e6c 7920  test.skip('Only 
+0001a5d0: 7275 6e20 7370 6f74 2070 6970 656c 696e  run spot pipelin
+0001a5e0: 6520 7265 636f 7665 7279 2074 6573 7420  e recovery test 
+0001a5f0: 696e 2075 732d 6561 7374 2d32 2729 0a20  in us-east-2'). 
+0001a600: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001a610: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
+0001a620: 5f6a 6f62 735f 7069 7065 6c69 6e65 5f72  _jobs_pipeline_r
+0001a630: 6563 6f76 6572 795f 6177 7327 2c0a 2020  ecovery_aws',.  
+0001a640: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001a650: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
+0001a660: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
+0001a670: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0001a680: 2f70 6970 656c 696e 655f 6177 732e 7961  /pipeline_aws.ya
+0001a690: 6d6c 2020 2d79 202d 6427 2c0a 2020 2020  ml  -y -d',.    
+0001a6a0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+0001a6b0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+0001a6c0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001a6d0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001a6e0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001a6f0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+0001a700: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+0001a710: 4e5f 4944 3d24 2873 6b79 206a 6f62 7320  N_ID=$(sky jobs 
+0001a720: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+0001a730: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+0001a740: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
+0001a750: 4944 3a20 7c20 6375 7420 2d64 3a20 2d66  ID: | cut -d: -f
+0001a760: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a770: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+0001a780: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+0001a790: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+0001a7a0: 4944 533d 2428 736b 7920 6a6f 6273 206c  IDS=$(sky jobs l
+0001a7b0: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
+0001a7c0: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
+0001a7d0: 202d 4120 3420 534b 5950 494c 4f54 5f54   -A 4 SKYPILOT_T
+0001a7e0: 4153 4b5f 4944 5320 7c20 6375 7420 2d64  ASK_IDS | cut -d
+0001a7f0: 2229 2220 2d66 3229 3b20 6563 686f 2022  ")" -f2); echo "
+0001a800: 2452 554e 5f49 4453 2220 7c20 7465 6520  $RUN_IDS" | tee 
+0001a810: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+0001a820: 6964 7327 2c0a 2020 2020 2020 2020 2020  ids',.          
+0001a830: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+0001a840: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+0001a850: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001a860: 2320 5468 6520 6063 6174 202e 2e2e 7c20  # The `cat ...| 
+0001a870: 7265 7660 2069 7320 746f 2072 6574 7269  rev` is to retri
+0001a880: 6576 6520 7468 6520 6a6f 625f 6964 2066  eve the job_id f
+0001a890: 726f 6d20 7468 650a 2020 2020 2020 2020  rom the.        
+0001a8a0: 2020 2020 2320 534b 5950 494c 4f54 5f54      # SKYPILOT_T
+0001a8b0: 4153 4b5f 4944 2c20 7768 6963 6820 6765  ASK_ID, which ge
+0001a8c0: 7473 2074 6865 2073 6563 6f6e 6420 746f  ts the second to
+0001a8d0: 206c 6173 7420 6669 656c 640a 2020 2020   last field.    
+0001a8e0: 2020 2020 2020 2020 2320 7365 7061 7261          # separa
+0001a8f0: 7465 6420 6279 2060 2d60 2e0a 2020 2020  ted by `-`..    
+0001a900: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+0001a910: 2020 2020 2020 2020 2020 6627 4d41 4e41            f'MANA
+0001a920: 4745 445f 4a4f 425f 4944 3d60 6361 7420  GED_JOB_ID=`cat 
+0001a930: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+0001a940: 6964 207c 2072 6576 207c 2027 0a20 2020  id | rev | '.   
+0001a950: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
+0001a960: 7420 2d64 5c27 5f5c 2720 2d66 3120 7c20  t -d\'_\' -f1 | 
+0001a970: 7265 7620 7c20 6375 7420 2d64 5c27 2d5c  rev | cut -d\'-\
+0001a980: 2720 2d66 3160 3b27 0a20 2020 2020 2020  ' -f1`;'.       
+0001a990: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+0001a9a0: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
+0001a9b0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001a9c0: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
+0001a9d0: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
+0001a9e0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
+0001a9f0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
+0001aa00: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001aa10: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
+0001aa20: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0001aa30: 4f44 4f28 7a68 7775 293a 2066 6978 2074  ODO(zhwu): fix t
+0001aa40: 6865 206e 616d 6520 666f 7220 7370 6f74  he name for spot
+0001aa50: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+0001aa60: 2020 2020 2020 2020 2020 272d 2d66 696c            '--fil
+0001aa70: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
+0001aa80: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+0001aa90: 616c 7565 733d 2a2d 247b 4d41 4e41 4745  alues=*-${MANAGE
+0001aaa0: 445f 4a4f 425f 4944 7d27 0a20 2020 2020  D_JOB_ID}'.     
+0001aab0: 2020 2020 2020 2020 2020 2066 272d 7b75             f'-{u
+0001aac0: 7365 725f 6861 7368 7d20 270a 2020 2020  ser_hash} '.    
+0001aad0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+0001aae0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
+0001aaf0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+0001ab00: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
+0001ab10: 2020 2020 2020 2020 2020 2020 2020 272d                '-
+0001ab20: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+0001ab30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001ab40: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+0001ab50: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+0001ab60: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001ab70: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001ab80: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
+0001ab90: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
+0001aba0: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+0001abb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001abc0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001abd0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001abe0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001abf0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+0001ac00: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+0001ac10: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
+0001ac20: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
+0001ac30: 2024 5255 4e5f 4944 3b20 736b 7920 6a6f   $RUN_ID; sky jo
+0001ac40: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001ac50: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001ac60: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001ac70: 534b 5f49 443a 207c 2067 7265 7020 2224  SK_ID: | grep "$
+0001ac80: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+0001ac90: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
+0001aca0: 2428 736b 7920 6a6f 6273 206c 6f67 7320  $(sky jobs logs 
+0001acb0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001acc0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
+0001acd0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
+0001ace0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
+0001acf0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001ad00: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
+0001ad10: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
+0001ad20: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
+0001ad30: 2020 6627 6469 6666 202f 746d 702f 7b6e    f'diff /tmp/{n
+0001ad40: 616d 657d 2d72 756e 2d69 6473 202f 746d  ame}-run-ids /tm
+0001ad50: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+0001ad60: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+0001ad70: 2020 2066 2763 6174 202f 746d 702f 7b6e     f'cat /tmp/{n
+0001ad80: 616d 657d 2d72 756e 2d69 6473 207c 2073  ame}-run-ids | s
+0001ad90: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+0001ada0: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
+0001adb0: 2d72 756e 2d69 6460 272c 0a20 2020 2020  -run-id`',.     
+0001adc0: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001add0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001ade0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001adf0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+0001ae00: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+0001ae10: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001ae20: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001ae30: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+0001ae40: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+0001ae50: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+0001ae60: 745f 6d61 6e61 6765 645f 6a6f 6273 5f70  t_managed_jobs_p
+0001ae70: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
+0001ae80: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+0001ae90: 6573 7420 6d61 6e61 6765 6420 6a6f 6220  est managed job 
+0001aea0: 7265 636f 7665 7279 2066 6f72 2061 2070  recovery for a p
+0001aeb0: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
+0001aec0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0001aed0: 7465 725f 6e61 6d65 2829 0a20 2020 207a  ter_name().    z
+0001aee0: 6f6e 6520 3d20 2775 732d 6561 7374 342d  one = 'us-east4-
+0001aef0: 6227 0a20 2020 2075 7365 725f 6861 7368  b'.    user_hash
+0001af00: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001af10: 6765 745f 7573 6572 5f68 6173 6828 290a  get_user_hash().
+0001af20: 2020 2020 7573 6572 5f68 6173 6820 3d20      user_hash = 
+0001af30: 7573 6572 5f68 6173 685b 3a63 6f6d 6d6f  user_hash[:commo
+0001af40: 6e5f 7574 696c 732e 5553 4552 5f48 4153  n_utils.USER_HAS
+0001af50: 485f 4c45 4e47 5448 5f49 4e5f 434c 5553  H_LENGTH_IN_CLUS
+0001af60: 5445 525f 4e41 4d45 5d0a 2020 2020 7175  TER_NAME].    qu
+0001af70: 6572 795f 636d 6420 3d20 280a 2020 2020  ery_cmd = (.    
+0001af80: 2020 2020 2767 636c 6f75 6420 636f 6d70      'gcloud comp
+0001af90: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
+0001afa0: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
+0001afb0: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+0001afc0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+0001afd0: 653a 2a2d 247b 7b4d 414e 4147 4544 5f4a  e:*-${{MANAGED_J
+0001afe0: 4f42 5f49 447d 7d2d 7b75 7365 725f 6861  OB_ID}}-{user_ha
+0001aff0: 7368 7d29 2220 270a 2020 2020 2020 2020  sh})" '.        
+0001b000: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
+0001b010: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+0001b020: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
+0001b030: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
+0001b040: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
+0001b050: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
+0001b060: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
+0001b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b080: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
+0001b090: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
+0001b0a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001b0b0: 280a 2020 2020 2020 2020 276d 616e 6167  (.        'manag
+0001b0c0: 6564 5f6a 6f62 735f 7069 7065 6c69 6e65  ed_jobs_pipeline
+0001b0d0: 5f72 6563 6f76 6572 795f 6763 7027 2c0a  _recovery_gcp',.
+0001b0e0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001b0f0: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001b100: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
+0001b110: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+0001b120: 6c73 2f70 6970 656c 696e 655f 6763 702e  ls/pipeline_gcp.
+0001b130: 7961 6d6c 2020 2d79 202d 6427 2c0a 2020  yaml  -y -d',.  
+0001b140: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001b150: 2034 3030 272c 0a20 2020 2020 2020 2020   400',.         
+0001b160: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001b170: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001b180: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001b190: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001b1a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b1b0: 5255 4e5f 4944 3d24 2873 6b79 206a 6f62  RUN_ID=$(sky job
+0001b1c0: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+0001b1d0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001b1e0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001b1f0: 4b5f 4944 3a20 7c20 6375 7420 2d64 3a20  K_ID: | cut -d: 
+0001b200: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001b210: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+0001b220: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+0001b230: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+0001b240: 4e5f 4944 533d 2428 736b 7920 6a6f 6273  N_IDS=$(sky jobs
+0001b250: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001b260: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001b270: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
+0001b280: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
+0001b290: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
+0001b2a0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
+0001b2b0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+0001b2c0: 6e2d 6964 7327 2c0a 2020 2020 2020 2020  n-ids',.        
+0001b2d0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+0001b2e0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+0001b2f0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+0001b300: 2020 2320 5468 6520 6063 6174 202e 2e2e    # The `cat ...
+0001b310: 7c20 7265 7660 2069 7320 746f 2072 6574  | rev` is to ret
+0001b320: 7269 6576 6520 7468 6520 6a6f 625f 6964  rieve the job_id
+0001b330: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
+0001b340: 2020 2020 2020 2320 534b 5950 494c 4f54        # SKYPILOT
+0001b350: 5f54 4153 4b5f 4944 2c20 7768 6963 6820  _TASK_ID, which 
+0001b360: 6765 7473 2074 6865 2073 6563 6f6e 6420  gets the second 
+0001b370: 746f 206c 6173 7420 6669 656c 640a 2020  to last field.  
+0001b380: 2020 2020 2020 2020 2020 2320 7365 7061            # sepa
+0001b390: 7261 7465 6420 6279 2060 2d60 2e0a 2020  rated by `-`..  
+0001b3a0: 2020 2020 2020 2020 2020 2866 274d 414e            (f'MAN
+0001b3b0: 4147 4544 5f4a 4f42 5f49 443d 6063 6174  AGED_JOB_ID=`cat
+0001b3c0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b3d0: 2d69 6420 7c20 7265 7620 7c20 270a 2020  -id | rev | '.  
+0001b3e0: 2020 2020 2020 2020 2020 2066 2763 7574             f'cut
+0001b3f0: 202d 645c 275f 5c27 202d 6631 207c 2072   -d\'_\' -f1 | r
+0001b400: 6576 207c 2063 7574 202d 645c 272d 5c27  ev | cut -d\'-\'
+0001b410: 202d 6631 603b 207b 7465 726d 696e 6174   -f1`; {terminat
+0001b420: 655f 636d 647d 2729 2c0a 2020 2020 2020  e_cmd}'),.      
+0001b430: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
+0001b440: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b450: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001b460: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+0001b470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001b480: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+0001b490: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001b4a0: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+0001b4b0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001b4c0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001b4d0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+0001b4e0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+0001b4f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001b500: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
+0001b510: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+0001b520: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
+0001b530: 3b20 736b 7920 6a6f 6273 206c 6f67 7320  ; sky jobs logs 
+0001b540: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001b550: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+0001b560: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
+0001b570: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+0001b580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b590: 5255 4e5f 4944 533d 2428 736b 7920 6a6f  RUN_IDS=$(sky jo
+0001b5a0: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001b5b0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001b5c0: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
+0001b5d0: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
+0001b5e0: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
+0001b5f0: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
+0001b600: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+0001b610: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
+0001b620: 2020 2020 2020 2020 2020 6627 6469 6666            f'diff
+0001b630: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b640: 2d69 6473 202f 746d 702f 7b6e 616d 657d  -ids /tmp/{name}
+0001b650: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+0001b660: 2020 2020 2020 2020 2020 2066 2763 6174             f'cat
+0001b670: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b680: 2d69 6473 207c 2073 6564 202d 6e20 3270  -ids | sed -n 2p
+0001b690: 207c 2067 7265 7020 6063 6174 202f 746d   | grep `cat /tm
+0001b6a0: 702f 7b6e 616d 657d 2d72 756e 2d69 6460  p/{name}-run-id`
+0001b6b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001b6c0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001b6d0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001b6e0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001b6f0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001b700: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001b710: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001b720: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001b730: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0001b740: 2020 2320 466c 7569 6473 7461 636b 2064    # Fluidstack d
+0001b750: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001b760: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001b770: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f61  pytest.mark.no_a
+0001b780: 7a75 7265 2020 2320 417a 7572 6520 646f  zure  # Azure do
+0001b790: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001b7a0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001b7b0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+0001b7c0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+0001b7d0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+0001b7e0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+0001b7f0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0001b800: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+0001b810: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+0001b820: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+0001b830: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001b840: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+0001b850: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+0001b860: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001b870: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001b880: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+0001b890: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+0001b8a0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0001b8b0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+0001b8c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001b8d0: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+0001b8e0: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
+0001b8f0: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
+0001b900: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
+0001b910: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+0001b920: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
+0001b930: 7465 7374 5f6d 616e 6167 6564 5f6a 6f62  test_managed_job
+0001b940: 735f 7265 636f 7665 7279 5f64 6566 6175  s_recovery_defau
+0001b950: 6c74 5f72 6573 6f75 7263 6573 2867 656e  lt_resources(gen
+0001b960: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0001b970: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+0001b980: 6e61 6765 6420 6a6f 6220 7265 636f 7665  naged job recove
+0001b990: 7279 2066 6f72 2064 6566 6175 6c74 2072  ry for default r
+0001b9a0: 6573 6f75 7263 6573 2e22 2222 0a20 2020  esources.""".   
+0001b9b0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001b9c0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001b9d0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001b9e0: 2020 2020 2027 6d61 6e61 6765 642d 7370       'managed-sp
+0001b9f0: 6f74 2d72 6563 6f76 6572 792d 6465 6661  ot-recovery-defa
+0001ba00: 756c 742d 7265 736f 7572 6365 7327 2c0a  ult-resources',.
+0001ba10: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001ba20: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001ba30: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
+0001ba40: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0001ba50: 6963 5f63 6c6f 7564 7d20 2d2d 7573 652d  ic_cloud} --use-
+0001ba60: 7370 6f74 2022 736c 6565 7020 3330 2026  spot "sleep 30 &
+0001ba70: 2620 7375 646f 2073 6875 7464 6f77 6e20  & sudo shutdown 
+0001ba80: 6e6f 7720 2626 2073 6c65 6570 2031 3030  now && sleep 100
+0001ba90: 3022 202d 7920 2d64 272c 0a20 2020 2020  0" -y -d',.     
+0001baa0: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
+0001bab0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001bac0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001bad0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001bae0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001baf0: 6570 2022 5255 4e4e 494e 475c 7c52 4543  ep "RUNNING\|REC
+0001bb00: 4f56 4552 494e 4722 272c 0a20 2020 2020  OVERING"',.     
+0001bb10: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001bb20: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001bb30: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001bb40: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+0001bb50: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+0001bb60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001bb70: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001bb80: 7974 6573 742e 6d61 726b 2e61 7773 0a40  ytest.mark.aws.@
+0001bb90: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+0001bba0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+0001bbb0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f72  t_managed_jobs_r
+0001bbc0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
+0001bbd0: 6465 5f61 7773 2861 7773 5f63 6f6e 6669  de_aws(aws_confi
+0001bbe0: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
+0001bbf0: 2222 5465 7374 206d 616e 6167 6564 206a  ""Test managed j
+0001bc00: 6f62 2072 6563 6f76 6572 792e 2222 220a  ob recovery.""".
+0001bc10: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001bc20: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001bc30: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+0001bc40: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001bc50: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001bc60: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001bc70: 2020 2020 6e61 6d65 2c20 6a6f 6273 2e4a      name, jobs.J
+0001bc80: 4f42 535f 434c 5553 5445 525f 4e41 4d45  OBS_CLUSTER_NAME
+0001bc90: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
+0001bca0: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
+0001bcb0: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
+0001bcc0: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
+0001bcd0: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
+0001bce0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+0001bcf0: 6e61 6765 645f 6a6f 6273 5f72 6563 6f76  naged_jobs_recov
+0001bd00: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
+0001bd10: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
+0001bd20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001bd30: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001bd40: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001bd50: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001bd60: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001bd70: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
+0001bd80: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
+0001bd90: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
+0001bda0: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
+0001bdb0: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
+0001bdc0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001bdd0: 7020 3435 3027 2c0a 2020 2020 2020 2020  p 450',.        
+0001bde0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001bdf0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001be00: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001be10: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+0001be20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001be30: 2752 554e 5f49 443d 2428 736b 7920 6a6f  'RUN_ID=$(sky jo
+0001be40: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001be50: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001be60: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001be70: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
+0001be80: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001be90: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+0001bea0: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+0001beb0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001bec0: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
+0001bed0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+0001bee0: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
+0001bef0: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+0001bf00: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001bf10: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+0001bf20: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+0001bf30: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+0001bf40: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
+0001bf50: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001bf60: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+0001bf70: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+0001bf80: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+0001bf90: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+0001bfa0: 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f 636c  lues={name_on_cl
+0001bfb0: 6f75 647d 2a20 270a 2020 2020 2020 2020  oud}* '.        
+0001bfc0: 2020 2020 2027 4e61 6d65 3d74 6167 3a72       'Name=tag:r
+0001bfd0: 6179 2d6e 6f64 652d 7479 7065 2c56 616c  ay-node-type,Val
+0001bfe0: 7565 733d 776f 726b 6572 2027 0a20 2020  ues=worker '.   
+0001bff0: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
+0001c000: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
+0001c010: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
+0001c020: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
+0001c030: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
+0001c040: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
+0001c050: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001c060: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001c070: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001c080: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001c090: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001c0a0: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
+0001c0b0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001c0c0: 6c65 6570 2035 3630 272c 0a20 2020 2020  leep 560',.     
+0001c0d0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+0001c0e0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001c0f0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001c100: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001c110: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001c120: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
+0001c130: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001c140: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
+0001c150: 4944 3b20 736b 7920 6a6f 6273 206c 6f67  ID; sky jobs log
+0001c160: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+0001c170: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+0001c180: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+0001c190: 7c20 6375 7420 2d64 3a20 2d66 3220 7c20  | cut -d: -f2 | 
+0001c1a0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
+0001c1b0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001c1c0: 2020 2020 5f4a 4f42 5f43 414e 4345 4c5f      _JOB_CANCEL_
+0001c1d0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001c1e0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001c1f0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+0001c200: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001c210: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001c220: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001c230: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+0001c240: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
+0001c250: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
+0001c260: 6a6f 6273 5f72 6563 6f76 6572 795f 6d75  jobs_recovery_mu
+0001c270: 6c74 695f 6e6f 6465 5f67 6370 2829 3a0a  lti_node_gcp():.
+0001c280: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+0001c290: 6765 6420 6a6f 6220 7265 636f 7665 7279  ged job recovery
+0001c2a0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+0001c2b0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001c2c0: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+0001c2d0: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001c2e0: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001c2f0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001c300: 0a20 2020 2020 2020 206e 616d 652c 206a  .        name, j
+0001c310: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001c320: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001c330: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001c340: 7368 3d46 616c 7365 290a 2020 2020 7a6f  sh=False).    zo
+0001c350: 6e65 203d 2027 7573 2d77 6573 7432 2d61  ne = 'us-west2-a
+0001c360: 270a 2020 2020 2320 5573 6520 273a 2720  '.    # Use ':' 
+0001c370: 746f 206d 6174 6368 2061 7320 7468 6520  to match as the 
+0001c380: 636c 7573 7465 7220 6e61 6d65 2077 696c  cluster name wil
+0001c390: 6c20 636f 6e74 6169 6e20 7468 6520 7375  l contain the su
+0001c3a0: 6666 6978 2077 6974 6820 6a6f 6220 6964  ffix with job id
+0001c3b0: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
+0001c3c0: 2028 0a20 2020 2020 2020 2066 2767 636c   (.        f'gcl
+0001c3d0: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001c3e0: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+0001c3f0: 7465 723d 270a 2020 2020 2020 2020 6627  ter='.        f'
+0001c400: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+0001c410: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
+0001c420: 6f6e 5f63 6c6f 7564 7d20 414e 4420 270a  on_cloud} AND '.
+0001c430: 2020 2020 2020 2020 6627 6c61 6265 6c73          f'labels
+0001c440: 2e72 6179 2d6e 6f64 652d 7479 7065 3d77  .ray-node-type=w
+0001c450: 6f72 6b65 7229 2220 2d2d 7a6f 6e65 733d  orker)" --zones=
+0001c460: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
+0001c470: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
+0001c480: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+0001c490: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
+0001c4a0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+0001c4b0: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
+0001c4c0: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
+0001c4d0: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
+0001c4e0: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
+0001c4f0: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
+0001c500: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001c510: 276d 616e 6167 6564 5f6a 6f62 735f 7265  'managed_jobs_re
+0001c520: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
+0001c530: 655f 6763 7027 2c0a 2020 2020 2020 2020  e_gcp',.        
+0001c540: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001c550: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001c560: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+0001c570: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
+0001c580: 6d65 7d20 2d2d 7573 652d 7370 6f74 202d  me} --use-spot -
+0001c590: 2d6e 756d 2d6e 6f64 6573 2032 2022 6563  -num-nodes 2 "ec
+0001c5a0: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
+0001c5b0: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
+0001c5c0: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
+0001c5d0: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
+0001c5e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001c5f0: 2034 3030 272c 0a20 2020 2020 2020 2020   400',.         
+0001c600: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001c610: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001c620: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001c630: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001c640: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001c650: 5255 4e5f 4944 3d24 2873 6b79 206a 6f62  RUN_ID=$(sky job
+0001c660: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+0001c670: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001c680: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001c690: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+0001c6a0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+0001c6b0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+0001c6c0: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+0001c6d0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+0001c6e0: 6d69 6e61 7465 2074 6865 2077 6f72 6b65  minate the worke
+0001c6f0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001c700: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001c710: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001c720: 2020 2027 736c 6565 7020 3530 272c 0a20     'sleep 50',. 
+0001c730: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001c740: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001c750: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001c760: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001c770: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001c780: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001c790: 3432 3027 2c0a 2020 2020 2020 2020 2020  420',.          
+0001c7a0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001c7b0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001c7c0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001c7d0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001c7e0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001c7f0: 554e 5f49 443d 2428 6361 7420 2f74 6d70  UN_ID=$(cat /tmp
+0001c800: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 293b  /{name}-run-id);
+0001c810: 2065 6368 6f20 2452 554e 5f49 443b 2073   echo $RUN_ID; s
+0001c820: 6b79 206a 6f62 7320 6c6f 6773 202d 6e20  ky jobs logs -n 
+0001c830: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
+0001c840: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
+0001c850: 4f54 5f54 4153 4b5f 4944 207c 2063 7574  OT_TASK_ID | cut
+0001c860: 202d 643a 202d 6632 207c 2067 7265 7020   -d: -f2 | grep 
+0001c870: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+0001c880: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+0001c890: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+0001c8a0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0001c8b0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+0001c8c0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+0001c8d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001c8e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0001c8f0: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+0001c900: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+0001c910: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
+0001c920: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+0001c930: 6361 6e63 656c 6c61 7469 6f6e 5f61 7773  cancellation_aws
+0001c940: 2861 7773 5f63 6f6e 6669 675f 7265 6769  (aws_config_regi
+0001c950: 6f6e 293a 0a20 2020 206e 616d 6520 3d20  on):.    name = 
+0001c960: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001c970: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+0001c980: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001c990: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001c9a0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001c9b0: 0a20 2020 2020 2020 206e 616d 652c 206a  .        name, j
+0001c9c0: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001c9d0: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001c9e0: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001c9f0: 7368 3d46 616c 7365 290a 2020 2020 6e61  sh=False).    na
+0001ca00: 6d65 5f32 5f6f 6e5f 636c 6f75 6420 3d20  me_2_on_cloud = 
+0001ca10: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001ca20: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001ca30: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001ca40: 2066 277b 6e61 6d65 7d2d 3227 2c20 6a6f   f'{name}-2', jo
+0001ca50: 6273 2e4a 4f42 535f 434c 5553 5445 525f  bs.JOBS_CLUSTER_
+0001ca60: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001ca70: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001ca80: 683d 4661 6c73 6529 0a20 2020 206e 616d  h=False).    nam
+0001ca90: 655f 335f 6f6e 5f63 6c6f 7564 203d 2063  e_3_on_cloud = c
+0001caa0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001cab0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001cac0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001cad0: 6627 7b6e 616d 657d 2d33 272c 206a 6f62  f'{name}-3', job
+0001cae0: 732e 4a4f 4253 5f43 4c55 5354 4552 5f4e  s.JOBS_CLUSTER_N
+0001caf0: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
+0001cb00: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
+0001cb10: 3d46 616c 7365 290a 2020 2020 7265 6769  =False).    regi
+0001cb20: 6f6e 203d 2061 7773 5f63 6f6e 6669 675f  on = aws_config_
+0001cb30: 7265 6769 6f6e 0a20 2020 2074 6573 7420  region.    test 
+0001cb40: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001cb50: 276d 616e 6167 6564 5f6a 6f62 735f 6361  'managed_jobs_ca
+0001cb60: 6e63 656c 6c61 7469 6f6e 5f61 7773 272c  ncellation_aws',
+0001cb70: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001cb80: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001cb90: 6e63 656c 6c61 7469 6f6e 2064 7572 696e  ncellation durin
+0001cba0: 6720 7370 6f74 2063 6c75 7374 6572 2062  g spot cluster b
+0001cbb0: 6569 6e67 206c 6175 6e63 6865 642e 0a20  eing launched.. 
+0001cbc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001cbd0: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001cbe0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001cbf0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001cc00: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001cc10: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
+0001cc20: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001cc30: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0001cc40: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001cc50: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001cc60: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001cc70: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
+0001cc80: 4152 5449 4e47 2227 2c0a 2020 2020 2020  ARTING"',.      
+0001cc90: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001cca0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001ccb0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001ccc0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001ccd0: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0001cce0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001ccf0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001cd00: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001cd10: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+0001cd20: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+0001cd30: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001cd40: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+0001cd50: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001cd60: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001cd70: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001cd80: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+0001cd90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001cda0: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
+0001cdb0: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+0001cdc0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001cdd0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001cde0: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001cdf0: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+0001ce00: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+0001ce10: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2d  {name_on_cloud}-
+0001ce20: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
+0001ce30: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+0001ce40: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+0001ce50: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
+0001ce60: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
+0001ce70: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+0001ce80: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001ce90: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+0001cea0: 7322 205d 5d20 7c7c 205b 5b20 2224 7322  s" ]] || [[ "$s"
+0001ceb0: 203d 2022 7465 726d 696e 6174 6564 2220   = "terminated" 
+0001cec0: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+0001ced0: 2273 6875 7474 696e 672d 646f 776e 2220  "shutting-down" 
+0001cee0: 5d5d 270a 2020 2020 2020 2020 2020 2020  ]]'.            
+0001cef0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
+0001cf00: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
+0001cf10: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
+0001cf20: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
+0001cf30: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
+0001cf40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001cf50: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001cf60: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001cf70: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001cf80: 616d 657d 2d32 202d 2d75 7365 2d73 706f  ame}-2 --use-spo
+0001cf90: 7420 7465 7374 732f 7465 7374 5f79 616d  t tests/test_yam
+0001cfa0: 6c73 2f74 6573 745f 6c6f 6e67 5f73 6574  ls/test_long_set
+0001cfb0: 7570 2e79 616d 6c20 202d 7920 2d64 272c  up.yaml  -y -d',
+0001cfc0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001cfd0: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
+0001cfe0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001cff0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001d000: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
+0001d010: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+0001d020: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0001d030: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001d040: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001d050: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+0001d060: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001d070: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+0001d080: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001d090: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+0001d0a0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001d0b0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001d0c0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0001d0d0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001d0e0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+0001d0f0: 2020 2020 2020 2020 2020 2028 6627 733d             (f's=
+0001d100: 2428 6177 7320 6563 3220 6465 7363 7269  $(aws ec2 descri
+0001d110: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
+0001d120: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
+0001d130: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+0001d140: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
+0001d150: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
+0001d160: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
+0001d170: 5f32 5f6f 6e5f 636c 6f75 647d 2d2a 2027  _2_on_cloud}-* '
+0001d180: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+0001d190: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+0001d1a0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+0001d1b0: 5b5d 2e53 7461 7465 5b5d 2e4e 616d 6520  [].State[].Name 
+0001d1c0: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+0001d1d0: 2d2d 6f75 7470 7574 2074 6578 7429 2026  --output text) &
+0001d1e0: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
+0001d1f0: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
+0001d200: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+0001d210: 2274 6572 6d69 6e61 7465 6422 205d 5d20  "terminated" ]] 
+0001d220: 7c7c 205b 5b20 2224 7322 203d 2022 7368  || [[ "$s" = "sh
+0001d230: 7574 7469 6e67 2d64 6f77 6e22 205d 5d27  utting-down" ]]'
+0001d240: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0001d250: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001d260: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+0001d270: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+0001d280: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+0001d290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001d2a0: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001d2b0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001d2c0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001d2d0: 616d 657d 2d33 202d 2d75 7365 2d73 706f  ame}-3 --use-spo
+0001d2e0: 7420 2273 6c65 6570 2031 3030 3022 2020  t "sleep 1000"  
+0001d2f0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+0001d300: 2020 2020 2773 6c65 6570 2033 3030 272c      'sleep 300',
+0001d310: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001d320: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001d330: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0001d340: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001d350: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+0001d360: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001d370: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+0001d380: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001d390: 2020 2020 2020 2020 2866 2761 7773 2065          (f'aws e
+0001d3a0: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
+0001d3b0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001d3c0: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
+0001d3d0: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
+0001d3e0: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+0001d3f0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+0001d400: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+0001d410: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+0001d420: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+0001d430: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+0001d440: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+0001d450: 7565 733d 7b6e 616d 655f 335f 6f6e 5f63  ues={name_3_on_c
+0001d460: 6c6f 7564 7d2d 2a20 270a 2020 2020 2020  loud}-* '.      
+0001d470: 2020 2020 2020 2066 272d 2d71 7565 7279         f'--query
+0001d480: 2052 6573 6572 7661 7469 6f6e 735b 5d2e   Reservations[].
+0001d490: 496e 7374 616e 6365 735b 5d2e 496e 7374  Instances[].Inst
+0001d4a0: 616e 6365 4964 2027 0a20 2020 2020 2020  anceId '.       
+0001d4b0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+0001d4c0: 7465 7874 2927 292c 0a20 2020 2020 2020  text)'),.       
+0001d4d0: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+0001d4e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001d4f0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001d500: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
+0001d510: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001d520: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
+0001d530: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
+0001d540: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001d550: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+0001d560: 277b 6e61 6d65 7d2d 3327 292c 0a20 2020  '{name}-3'),.   
+0001d570: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001d580: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001d590: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001d5a0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d5b0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+0001d5c0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+0001d5d0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+0001d5e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001d5f0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0001d600: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001d610: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001d620: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001d630: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001d640: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001d650: 2020 2023 2054 6865 2063 6c75 7374 6572     # The cluster
+0001d660: 2073 686f 756c 6420 6265 2074 6572 6d69   should be termi
+0001d670: 6e61 7465 6420 2873 6875 7474 696e 672d  nated (shutting-
+0001d680: 646f 776e 2920 6166 7465 7220 6361 6e63  down) after canc
+0001d690: 656c 6c61 7469 6f6e 2e20 5765 2064 6f6e  ellation. We don
+0001d6a0: 2774 2075 7365 2074 6865 2060 3d60 206f  't use the `=` o
+0001d6b0: 7065 7261 746f 7220 6865 7265 2062 6563  perator here bec
+0001d6c0: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
+0001d6d0: 2023 2074 6865 7265 2063 616e 2062 6520   # there can be 
+0001d6e0: 6d75 6c74 6970 6c65 2056 4d20 7769 7468  multiple VM with
+0001d6f0: 2074 6865 2073 616d 6520 6e61 6d65 2064   the same name d
+0001d700: 7565 2074 6f20 7468 6520 7265 636f 7665  ue to the recove
+0001d710: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0001d720: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
+0001d730: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+0001d740: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001d750: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001d760: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001d770: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+0001d780: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+0001d790: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
+0001d7a0: 7d2d 2a20 270a 2020 2020 2020 2020 2020  }-* '.          
+0001d7b0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
+0001d7c0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
+0001d7d0: 616e 6365 735b 5d2e 5374 6174 655b 5d2e  ances[].State[].
+0001d7e0: 4e61 6d65 2027 0a20 2020 2020 2020 2020  Name '.         
+0001d7f0: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
+0001d800: 7874 2920 2626 2065 6368 6f20 2224 7322  xt) && echo "$s"
+0001d810: 2026 2620 6563 686f 3b20 5b5b 202d 7a20   && echo; [[ -z 
+0001d820: 2224 7322 205d 5d20 7c7c 2065 6368 6f20  "$s" ]] || echo 
+0001d830: 2224 7322 207c 2067 7265 7020 2d76 202d  "$s" | grep -v -
+0001d840: 4520 2270 656e 6469 6e67 7c72 756e 6e69  E "pending|runni
+0001d850: 6e67 7c73 746f 7070 6564 7c73 746f 7070  ng|stopped|stopp
+0001d860: 696e 6722 270a 2020 2020 2020 2020 2020  ing"'.          
+0001d870: 2020 292c 0a20 2020 2020 2020 205d 2c0a    ),.        ],.
+0001d880: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001d890: 3235 202a 2036 3029 0a20 2020 2072 756e  25 * 60).    run
+0001d8a0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001d8b0: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+0001d8c0: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+0001d8d0: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
+0001d8e0: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
+0001d8f0: 6273 5f63 616e 6365 6c6c 6174 696f 6e5f  bs_cancellation_
+0001d900: 6763 7028 293a 0a20 2020 206e 616d 6520  gcp():.    name 
+0001d910: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001d920: 616d 6528 290a 2020 2020 6e61 6d65 5f33  ame().    name_3
+0001d930: 203d 2066 277b 6e61 6d65 7d2d 3327 0a20   = f'{name}-3'. 
+0001d940: 2020 206e 616d 655f 335f 6f6e 5f63 6c6f     name_3_on_clo
+0001d950: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+0001d960: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+0001d970: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+0001d980: 2020 2020 2020 6e61 6d65 5f33 2c20 6a6f        name_3, jo
+0001d990: 6273 2e4a 4f42 535f 434c 5553 5445 525f  bs.JOBS_CLUSTER_
+0001d9a0: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001d9b0: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001d9c0: 683d 4661 6c73 6529 0a20 2020 207a 6f6e  h=False).    zon
+0001d9d0: 6520 3d20 2775 732d 7765 7374 332d 6227  e = 'us-west3-b'
+0001d9e0: 0a20 2020 2071 7565 7279 5f73 7461 7465  .    query_state
+0001d9f0: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
+0001da00: 2027 6763 6c6f 7564 2063 6f6d 7075 7465   'gcloud compute
+0001da10: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
+0001da20: 270a 2020 2020 2020 2020 6627 2d2d 6669  '.        f'--fi
+0001da30: 6c74 6572 3d22 286c 6162 656c 732e 7261  lter="(labels.ra
+0001da40: 792d 636c 7573 7465 722d 6e61 6d65 3a7b  y-cluster-name:{
+0001da50: 6e61 6d65 5f33 5f6f 6e5f 636c 6f75 647d  name_3_on_cloud}
+0001da60: 2922 2027 0a20 2020 2020 2020 2027 2d2d  )" '.        '--
+0001da70: 666f 726d 6174 3d22 7661 6c75 6528 7374  format="value(st
+0001da80: 6174 7573 2922 2729 0a20 2020 2071 7565  atus)"').    que
+0001da90: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
+0001daa0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+0001dab0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
+0001dac0: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
+0001dad0: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+0001dae0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+0001daf0: 653a 7b6e 616d 655f 335f 6f6e 5f63 6c6f  e:{name_3_on_clo
+0001db00: 7564 7d29 2220 270a 2020 2020 2020 2020  ud})" '.        
+0001db10: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
+0001db20: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
+0001db30: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
+0001db40: 2729 0a20 2020 2074 6572 6d69 6e61 7465  ').    terminate
+0001db50: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
+0001db60: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+0001db70: 6573 2064 656c 6574 6520 2d2d 7a6f 6e65  es delete --zone
+0001db80: 3d7b 7a6f 6e65 7d27 0a20 2020 2020 2020  ={zone}'.       
+0001db90: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001dba0: 202d 2d71 7569 6574 2024 287b 7175 6572   --quiet $({quer
+0001dbb0: 795f 636d 647d 2927 290a 2020 2020 7465  y_cmd})').    te
+0001dbc0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001dbd0: 2020 2027 6d61 6e61 6765 645f 6a6f 6273     'managed_jobs
+0001dbe0: 5f63 616e 6365 6c6c 6174 696f 6e5f 6763  _cancellation_gc
+0001dbf0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+0001dc00: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
+0001dc10: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
+0001dc20: 7269 6e67 2073 706f 7420 636c 7573 7465  ring spot cluste
+0001dc30: 7220 6265 696e 6720 6c61 756e 6368 6564  r being launched
+0001dc40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0001dc50: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001dc60: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+0001dc70: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
+0001dc80: 6d65 7d20 2d2d 7573 652d 7370 6f74 2022  me} --use-spot "
+0001dc90: 736c 6565 7020 3130 3030 2220 202d 7920  sleep 1000"  -y 
+0001dca0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+0001dcb0: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
+0001dcc0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001dcd0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001dce0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001dcf0: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
+0001dd00: 5254 494e 4722 272c 0a20 2020 2020 2020  RTING"',.       
+0001dd10: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+0001dd20: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001dd30: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001dd40: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001dd50: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001dd60: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001dd70: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001dd80: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001dd90: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+0001dda0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+0001ddb0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001ddc0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+0001ddd0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001dde0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001ddf0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001de00: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+0001de10: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001de20: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
+0001de30: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
+0001de40: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
+0001de50: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
+0001de60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001de70: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001de80: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+0001de90: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+0001dea0: 2d32 202d 2d75 7365 2d73 706f 7420 7465  -2 --use-spot te
+0001deb0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+0001dec0: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
+0001ded0: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
+0001dee0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001def0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
+0001df00: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
+0001df10: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001df20: 6d65 3d66 277b 6e61 6d65 7d2d 3227 292c  me=f'{name}-2'),
+0001df30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001df40: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0001df50: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001df60: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001df70: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
+0001df80: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001df90: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001dfa0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001dfb0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001dfc0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001dfd0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001dfe0: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+0001dff0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001e000: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001e010: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001e020: 6e63 656c 6c61 7469 6f6e 2064 7572 696e  ncellation durin
+0001e030: 6720 7370 6f74 206a 6f62 2069 7320 7265  g spot job is re
+0001e040: 636f 7665 7269 6e67 2e0a 2020 2020 2020  covering..      
+0001e050: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001e060: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001e070: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+0001e080: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0001e090: 7573 652d 7370 6f74 2022 736c 6565 7020  use-spot "sleep 
+0001e0a0: 3130 3030 2220 202d 7920 2d64 272c 0a20  1000"  -y -d',. 
+0001e0b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001e0c0: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
+0001e0d0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001e0e0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001e0f0: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001e100: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+0001e110: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001e120: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
+0001e130: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
+0001e140: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
+0001e150: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
+0001e160: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001e170: 2038 3027 2c0a 2020 2020 2020 2020 2020   80',.          
+0001e180: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001e190: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001e1a0: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
+0001e1b0: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
+0001e1c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001e1d0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
+0001e1e0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001e1f0: 6d65 3d66 277b 6e61 6d65 7d2d 3327 292c  me=f'{name}-3'),
+0001e200: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001e210: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0001e220: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001e230: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001e240: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001e250: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001e260: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001e270: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001e280: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001e290: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001e2a0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001e2b0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+0001e2c0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001e2d0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001e2e0: 2020 2020 2020 2023 2054 6865 2063 6c75         # The clu
+0001e2f0: 7374 6572 2073 686f 756c 6420 6265 2074  ster should be t
+0001e300: 6572 6d69 6e61 7465 6420 2853 544f 5050  erminated (STOPP
+0001e310: 494e 4729 2061 6674 6572 2063 616e 6365  ING) after cance
+0001e320: 6c6c 6174 696f 6e2e 2057 6520 646f 6e27  llation. We don'
+0001e330: 7420 7573 6520 7468 6520 603d 6020 6f70  t use the `=` op
+0001e340: 6572 6174 6f72 2068 6572 6520 6265 6361  erator here beca
+0001e350: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
+0001e360: 2320 7468 6572 6520 6361 6e20 6265 206d  # there can be m
+0001e370: 756c 7469 706c 6520 564d 2077 6974 6820  ultiple VM with 
+0001e380: 7468 6520 7361 6d65 206e 616d 6520 6475  the same name du
+0001e390: 6520 746f 2074 6865 2072 6563 6f76 6572  e to the recover
+0001e3a0: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
+0001e3b0: 6627 733d 2428 7b71 7565 7279 5f73 7461  f's=$({query_sta
+0001e3c0: 7465 5f63 6d64 7d29 2026 2620 6563 686f  te_cmd}) && echo
+0001e3d0: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
+0001e3e0: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
+0001e3f0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0001e400: 202d 7620 2d45 2022 5052 4f56 4953 494f   -v -E "PROVISIO
+0001e410: 4e49 4e47 7c53 5441 4749 4e47 7c52 554e  NING|STAGING|RUN
+0001e420: 4e49 4e47 7c52 4550 4149 5249 4e47 7c54  NING|REPAIRING|T
+0001e430: 4552 4d49 4e41 5445 447c 5355 5350 454e  ERMINATED|SUSPEN
+0001e440: 4449 4e47 7c53 5553 5045 4e44 4544 7c53  DING|SUSPENDED|S
+0001e450: 5553 5045 4e44 4544 2227 0a20 2020 2020  USPENDED"'.     
+0001e460: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001e470: 2020 5d2c 0a20 2020 2020 2020 2074 696d    ],.        tim
+0001e480: 656f 7574 3d32 3520 2a20 3630 290a 2020  eout=25 * 60).  
+0001e490: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001e4a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0001e4b0: 2d2d 2d20 5465 7374 696e 6720 7374 6f72  --- Testing stor
+0001e4c0: 6167 6520 666f 7220 6d61 6e61 6765 6420  age for managed 
+0001e4d0: 6a6f 6220 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  job ----------.@
+0001e4e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0001e4f0: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+0001e500: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
+0001e510: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001e520: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001e530: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
+0001e540: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
+0001e550: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001e560: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001e570: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0001e580: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0001e590: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+0001e5a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+0001e5b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+0001e5c0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
+0001e5d0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+0001e5e0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001e5f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001e600: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
+0001e610: 2023 2050 6170 6572 7370 6163 6520 646f   # Paperspace do
+0001e620: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001e630: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001e640: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0001e650: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0001e660: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+0001e670: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001e680: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
+0001e690: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
+0001e6a0: 6765 645f 6a6f 6273 5f73 746f 7261 6765  ged_jobs_storage
+0001e6b0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0001e6c0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
+0001e6d0: 7420 7374 6f72 6167 6520 7769 7468 206d  t storage with m
+0001e6e0: 616e 6167 6564 206a 6f62 2222 220a 2020  anaged job""".  
+0001e6f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001e700: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001e710: 2079 616d 6c5f 7374 7220 3d20 7061 7468   yaml_str = path
+0001e720: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+0001e730: 2020 2765 7861 6d70 6c65 732f 6d61 6e61    'examples/mana
+0001e740: 6765 645f 6a6f 625f 7769 7468 5f73 746f  ged_job_with_sto
+0001e750: 7261 6765 2e79 616d 6c27 292e 7265 6164  rage.yaml').read
+0001e760: 5f74 6578 7428 290a 2020 2020 7374 6f72  _text().    stor
+0001e770: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+0001e780: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+0001e790: 7469 6d65 2829 297d 270a 0a20 2020 2023  time())}'..    #
+0001e7a0: 2041 6c73 6f20 7065 7266 6f72 6d20 7265   Also perform re
+0001e7b0: 6769 6f6e 2074 6573 7469 6e67 2066 6f72  gion testing for
+0001e7c0: 2062 7563 6b65 7420 6372 6561 7469 6f6e   bucket creation
+0001e7d0: 2074 6f20 7661 6c69 6461 7465 2069 6620   to validate if 
+0001e7e0: 6275 636b 6574 7320 6172 650a 2020 2020  buckets are.    
+0001e7f0: 2320 6372 6561 7465 6420 696e 2074 6865  # created in the
+0001e800: 2063 6f72 7265 6374 2072 6567 696f 6e20   correct region 
+0001e810: 616e 6420 636f 7272 6563 746c 7920 6d6f  and correctly mo
+0001e820: 756e 7465 6420 696e 206d 616e 6167 6564  unted in managed
+0001e830: 206a 6f62 732e 0a20 2020 2023 2048 6f77   jobs..    # How
+0001e840: 6576 6572 2c20 7765 2069 6e6a 6563 7420  ever, we inject 
+0001e850: 7468 6973 2074 6573 7469 6e67 206f 6e6c  this testing onl
+0001e860: 7920 666f 7220 4157 5320 616e 6420 4743  y for AWS and GC
+0001e870: 5020 7369 6e63 6520 7468 6579 2061 7265  P since they are
+0001e880: 2074 6865 0a20 2020 2023 2073 7570 706f   the.    # suppo
+0001e890: 7274 6564 206f 626a 6563 7420 7374 6f72  rted object stor
+0001e8a0: 6167 6520 7072 6f76 6964 6572 7320 696e  age providers in
+0001e8b0: 2053 6b79 5069 6c6f 742e 0a20 2020 2072   SkyPilot..    r
+0001e8c0: 6567 696f 6e5f 666c 6167 203d 2027 270a  egion_flag = ''.
+0001e8d0: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
+0001e8e0: 6174 696f 6e5f 636d 6420 3d20 2774 7275  ation_cmd = 'tru
+0001e8f0: 6527 0a20 2020 2075 7365 5f73 706f 7420  e'.    use_spot 
+0001e900: 3d20 2720 2d2d 7573 652d 7370 6f74 270a  = ' --use-spot'.
+0001e910: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
+0001e920: 6c6f 7564 203d 3d20 2761 7773 273a 0a20  loud == 'aws':. 
+0001e930: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+0001e940: 2765 752d 6365 6e74 7261 6c2d 3127 0a20  'eu-central-1'. 
+0001e950: 2020 2020 2020 2072 6567 696f 6e5f 666c         region_fl
+0001e960: 6167 203d 2066 2720 2d2d 7265 6769 6f6e  ag = f' --region
+0001e970: 207b 7265 6769 6f6e 7d27 0a20 2020 2020   {region}'.     
+0001e980: 2020 2072 6567 696f 6e5f 636d 6420 3d20     region_cmd = 
+0001e990: 5465 7374 5374 6f72 6167 6557 6974 6843  TestStorageWithC
+0001e9a0: 7265 6465 6e74 6961 6c73 2e63 6c69 5f72  redentials.cli_r
+0001e9b0: 6567 696f 6e5f 636d 6428 0a20 2020 2020  egion_cmd(.     
+0001e9c0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0001e9d0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0001e9e0: 2073 746f 7261 6765 5f6e 616d 6529 0a20   storage_name). 
+0001e9f0: 2020 2020 2020 2072 6567 696f 6e5f 7661         region_va
+0001ea00: 6c69 6461 7469 6f6e 5f63 6d64 203d 2066  lidation_cmd = f
+0001ea10: 277b 7265 6769 6f6e 5f63 6d64 7d20 7c20  '{region_cmd} | 
+0001ea20: 6772 6570 207b 7265 6769 6f6e 7d27 0a20  grep {region}'. 
+0001ea30: 2020 2065 6c69 6620 6765 6e65 7269 635f     elif generic_
+0001ea40: 636c 6f75 6420 3d3d 2027 6763 7027 3a0a  cloud == 'gcp':.
+0001ea50: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
+0001ea60: 2027 7573 2d77 6573 7432 270a 2020 2020   'us-west2'.    
+0001ea70: 2020 2020 7265 6769 6f6e 5f66 6c61 6720      region_flag 
+0001ea80: 3d20 6627 202d 2d72 6567 696f 6e20 7b72  = f' --region {r
+0001ea90: 6567 696f 6e7d 270a 2020 2020 2020 2020  egion}'.        
+0001eaa0: 7265 6769 6f6e 5f63 6d64 203d 2054 6573  region_cmd = Tes
+0001eab0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
+0001eac0: 656e 7469 616c 732e 636c 695f 7265 6769  entials.cli_regi
+0001ead0: 6f6e 5f63 6d64 280a 2020 2020 2020 2020  on_cmd(.        
+0001eae0: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+0001eaf0: 5374 6f72 6554 7970 652e 4743 532c 2073  StoreType.GCS, s
+0001eb00: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
+0001eb10: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
+0001eb20: 6461 7469 6f6e 5f63 6d64 203d 2066 277b  dation_cmd = f'{
+0001eb30: 7265 6769 6f6e 5f63 6d64 7d20 7c20 6772  region_cmd} | gr
+0001eb40: 6570 207b 7265 6769 6f6e 7d27 0a20 2020  ep {region}'.   
+0001eb50: 2065 6c69 6620 6765 6e65 7269 635f 636c   elif generic_cl
+0001eb60: 6f75 6420 3d3d 2027 6b75 6265 726e 6574  oud == 'kubernet
+0001eb70: 6573 273a 0a20 2020 2020 2020 2075 7365  es':.        use
+0001eb80: 5f73 706f 7420 3d20 2720 2d2d 6e6f 2d75  _spot = ' --no-u
+0001eb90: 7365 2d73 706f 7427 0a0a 2020 2020 7961  se-spot'..    ya
+0001eba0: 6d6c 5f73 7472 203d 2079 616d 6c5f 7374  ml_str = yaml_st
+0001ebb0: 722e 7265 706c 6163 6528 2773 6b79 2d77  r.replace('sky-w
+0001ebc0: 6f72 6b64 6972 2d7a 6877 7527 2c20 7374  orkdir-zhwu', st
+0001ebd0: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
+0001ebe0: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
+0001ebf0: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
+0001ec00: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
+0001ec10: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
+0001ec20: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
+0001ec30: 2879 616d 6c5f 7374 7229 0a20 2020 2020  (yaml_str).     
+0001ec40: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+0001ec50: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+0001ec60: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+0001ec70: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001ec80: 2020 2020 2020 2020 2027 6d61 6e61 6765           'manage
+0001ec90: 645f 6a6f 6273 5f73 746f 7261 6765 272c  d_jobs_storage',
+0001eca0: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+0001ecb0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0001ecc0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+0001ecd0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+0001ece0: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
+0001ecf0: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
+0001ed00: 6d65 7d7b 7573 655f 7370 6f74 7d20 2d2d  me}{use_spot} --
+0001ed10: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0001ed20: 6c6f 7564 7d7b 7265 6769 6f6e 5f66 6c61  loud}{region_fla
+0001ed30: 677d 207b 6669 6c65 5f70 6174 687d 202d  g} {file_path} -
+0001ed40: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0001ed50: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
+0001ed60: 6174 696f 6e5f 636d 642c 2020 2320 4368  ation_cmd,  # Ch
+0001ed70: 6563 6b20 6966 2074 6865 2062 7563 6b65  eck if the bucke
+0001ed80: 7420 6973 2063 7265 6174 6564 2069 6e20  t is created in 
+0001ed90: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+0001eda0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0001edb0: 2020 2027 736c 6565 7020 3630 272c 2020     'sleep 60',  
+0001edc0: 2320 5761 6974 2074 6865 2073 706f 7420  # Wait the spot 
+0001edd0: 7175 6575 6520 746f 2062 6520 7570 6461  queue to be upda
+0001ede0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0001edf0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001ee00: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001ee10: 616d 657d 207c 2067 7265 7020 5355 4343  ame} | grep SUCC
+0001ee20: 4545 4445 4427 2c0a 2020 2020 2020 2020  EEDED',.        
+0001ee30: 2020 2020 2020 2020 6627 5b20 2428 6177          f'[ $(aw
+0001ee40: 7320 7333 6170 6920 6c69 7374 2d62 7563  s s3api list-buc
+0001ee50: 6b65 7473 202d 2d71 7565 7279 2022 4275  kets --query "Bu
+0001ee60: 636b 6574 735b 3f63 6f6e 7461 696e 7328  ckets[?contains(
+0001ee70: 4e61 6d65 2c20 5c27 7b73 746f 7261 6765  Name, \'{storage
+0001ee80: 5f6e 616d 657d 5c27 295d 2e4e 616d 6522  _name}\')].Name"
+0001ee90: 202d 2d6f 7574 7075 7420 7465 7874 207c   --output text |
+0001eea0: 2077 6320 2d6c 2920 2d65 7120 3020 5d27   wc -l) -eq 0 ]'
+0001eeb0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0001eec0: 2020 2020 2020 2020 2020 2020 5f4a 4f42              _JOB
+0001eed0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+0001eee0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
+0001eef0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001ef00: 2320 496e 6372 6561 7365 2074 696d 656f  # Increase timeo
+0001ef10: 7574 2073 696e 6365 2073 6b79 206a 6f62  ut since sky job
+0001ef20: 7320 7175 6575 6520 2d72 2063 616e 2062  s queue -r can b
+0001ef30: 6520 626c 6f63 6b65 6420 6279 206f 7468  e blocked by oth
+0001ef40: 6572 2073 706f 7420 7465 7374 732e 0a20  er spot tests.. 
+0001ef50: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+0001ef60: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+0001ef70: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+0001ef80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0001ef90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0001efa0: 5465 7374 696e 6720 7370 6f74 2054 5055  Testing spot TPU
+0001efb0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0001efc0: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+0001efd0: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+0001efe0: 645f 6a6f 6273 0a40 7079 7465 7374 2e6d  d_jobs.@pytest.m
+0001eff0: 6172 6b2e 7470 750a 6465 6620 7465 7374  ark.tpu.def test
+0001f000: 5f6d 616e 6167 6564 5f6a 6f62 735f 7470  _managed_jobs_tp
+0001f010: 7528 293a 0a20 2020 2022 2222 5465 7374  u():.    """Test
+0001f020: 206d 616e 6167 6564 206a 6f62 206f 6e20   managed job on 
+0001f030: 5450 552e 2222 220a 2020 2020 6e61 6d65  TPU.""".    name
+0001f040: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001f050: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0001f060: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001f070: 2774 6573 742d 7370 6f74 2d74 7075 272c  'test-spot-tpu',
+0001f080: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001f090: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001f0a0: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
+0001f0b0: 657d 202d 2d75 7365 2d73 706f 7420 6578  e} --use-spot ex
+0001f0c0: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+0001f0d0: 5f6d 6e69 7374 2e79 616d 6c20 2d79 202d  _mnist.yaml -y -
+0001f0e0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+0001f0f0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+0001f100: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+0001f110: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001f120: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001f130: 6e31 207c 2067 7265 7020 5354 4152 5449  n1 | grep STARTI
+0001f140: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0001f150: 2027 736c 6565 7020 3930 3027 2c20 2023   'sleep 900',  #
+0001f160: 2054 5055 2074 616b 6573 2061 2077 6869   TPU takes a whi
+0001f170: 6c65 2074 6f20 6c61 756e 6368 0a20 2020  le to launch.   
+0001f180: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001f190: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001f1a0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001f1b0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+0001f1c0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
+0001f1d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001f1e0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001f1f0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001f200: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001f210: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+0001f220: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+0001f230: 6b79 206a 6f62 7320 7175 6575 6520 2d72  ky jobs queue -r
+0001f240: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+0001f250: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+0001f260: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+0001f270: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+0001f280: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001f290: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0001f2a0: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+0001f2b0: 6720 656e 7620 666f 7220 6d61 6e61 6765  g env for manage
+0001f2c0: 6420 6a6f 6273 202d 2d2d 2d2d 2d2d 2d2d  d jobs ---------
+0001f2d0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6d  -.@pytest.mark.m
+0001f2e0: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
+0001f2f0: 7465 7374 5f6d 616e 6167 6564 5f6a 6f62  test_managed_job
+0001f300: 735f 696e 6c69 6e65 5f65 6e76 2867 656e  s_inline_env(gen
+0001f310: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0001f320: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+0001f330: 6e61 6765 6420 6a6f 6273 2065 6e76 2222  naged jobs env""
+0001f340: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+0001f350: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0001f360: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001f370: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
+0001f380: 6d61 6e61 6765 642d 6a6f 6273 2d69 6e6c  managed-jobs-inl
+0001f390: 696e 652d 656e 7627 2c0a 2020 2020 2020  ine-env',.      
+0001f3a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001f3b0: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
+0001f3c0: 6820 2d6e 207b 6e61 6d65 7d20 2d79 202d  h -n {name} -y -
+0001f3d0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0001f3e0: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
+0001f3f0: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
+0001f400: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
+0001f410: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
+0001f420: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+0001f430: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+0001f440: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
+0001f450: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+0001f460: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
+0001f470: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
+0001f480: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001f490: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+0001f4a0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001f4b0: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+0001f4c0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0001f4d0: 2053 5543 4345 4544 4544 272c 0a20 2020   SUCCEEDED',.   
+0001f4e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001f4f0: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+0001f500: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+0001f510: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+0001f520: 2320 496e 6372 6561 7365 2074 696d 656f  # Increase timeo
+0001f530: 7574 2073 696e 6365 2073 6b79 206a 6f62  ut since sky job
+0001f540: 7320 7175 6575 6520 2d72 2063 616e 2062  s queue -r can b
+0001f550: 6520 626c 6f63 6b65 6420 6279 206f 7468  e blocked by oth
+0001f560: 6572 2073 706f 7420 7465 7374 732e 0a20  er spot tests.. 
+0001f570: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0001f580: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0001f590: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001f5a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0001f5b0: 2d2d 2d20 5465 7374 696e 6720 656e 7620  --- Testing env 
+0001f5c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074  ----------.def t
+0001f5d0: 6573 745f 696e 6c69 6e65 5f65 6e76 2867  est_inline_env(g
+0001f5e0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0001f5f0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+0001f600: 656e 7622 2222 0a20 2020 206e 616d 6520  env""".    name 
+0001f610: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001f620: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0001f630: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001f640: 7465 7374 2d69 6e6c 696e 652d 656e 7627  test-inline-env'
+0001f650: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001f660: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0001f670: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
+0001f680: 7920 2d2d 636c 6f75 6420 7b67 656e 6572  y --cloud {gener
+0001f690: 6963 5f63 6c6f 7564 7d20 2d2d 656e 7620  ic_cloud} --env 
+0001f6a0: 5445 5354 5f45 4e56 3d22 6865 6c6c 6f20  TEST_ENV="hello 
+0001f6b0: 776f 726c 6422 202d 2d20 2228 5b5b 2021  world" -- "([[ !
+0001f6c0: 202d 7a20 5c5c 225c 2454 4553 545f 454e   -z \\"\$TEST_EN
+0001f6d0: 565c 5c22 205d 5d20 2626 205b 5b20 2120  V\\" ]] && [[ ! 
+0001f6e0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001f6f0: 5f4e 4f44 455f 4950 535c 5c22 205d 5d20  _NODE_IPS\\" ]] 
+0001f700: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001f710: 534b 5950 494c 4f54 5f4e 4f44 455f 5241  SKYPILOT_NODE_RA
+0001f720: 4e4b 5c5c 2220 5d5d 2920 7c7c 2065 7869  NK\\" ]]) || exi
+0001f730: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0001f740: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
+0001f750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001f760: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0001f770: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0001f780: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0001f790: 207b 6e61 6d65 7d20 2d2d 656e 7620 5445   {name} --env TE
+0001f7a0: 5354 5f45 4e56 323d 2273 7563 6365 7373  ST_ENV2="success
+0001f7b0: 2220 2228 5b5b 2021 202d 7a20 5c5c 225c  " "([[ ! -z \\"\
+0001f7c0: 2454 4553 545f 454e 5632 5c5c 2220 5d5d  $TEST_ENV2\\" ]]
+0001f7d0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001f7e0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+0001f7f0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+0001f800: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001f810: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+0001f820: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+0001f830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f840: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+0001f850: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0001f860: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0001f870: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0001f880: 657d 272c 0a20 2020 2020 2020 205f 6765  e}',.        _ge
+0001f890: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
+0001f8a0: 635f 636c 6f75 6429 2c0a 2020 2020 290a  c_cloud),.    ).
+0001f8b0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0001f8c0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0001f8d0: 2d2d 2d2d 2d20 5465 7374 696e 6720 656e  ----- Testing en
+0001f8e0: 7620 6669 6c65 202d 2d2d 2d2d 2d2d 2d2d  v file ---------
+0001f8f0: 2d0a 6465 6620 7465 7374 5f69 6e6c 696e  -.def test_inlin
+0001f900: 655f 656e 765f 6669 6c65 2867 656e 6572  e_env_file(gener
+0001f910: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+0001f920: 2020 2020 2222 2254 6573 7420 656e 7622      """Test env"
+0001f930: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001f940: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001f950: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001f960: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+0001f970: 2d69 6e6c 696e 652d 656e 762d 6669 6c65  -inline-env-file
+0001f980: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0001f990: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001f9a0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0001f9b0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+0001f9c0: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
+0001f9d0: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
+0001f9e0: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
+0001f9f0: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+0001fa00: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
+0001fa10: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001fa20: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+0001fa30: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001fa40: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+0001fa50: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+0001fa60: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0001fa70: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001fa80: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0001fa90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001faa0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0001fab0: 202d 2d65 6e76 2d66 696c 6520 6578 616d   --env-file exam
+0001fac0: 706c 6573 2f73 616d 706c 655f 646f 7465  ples/sample_dote
+0001fad0: 6e76 2022 285b 5b20 2120 2d7a 205c 5c22  nv "([[ ! -z \\"
+0001fae0: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
+0001faf0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001fb00: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001fb10: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+0001fb20: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001fb30: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+0001fb40: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+0001fb50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001fb60: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0001fb70: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001fb80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001fb90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001fba0: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
+0001fbb0: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
+0001fbc0: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
+0001fbd0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0001fbe0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0001fbf0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2063  ------ Testing c
+0001fc00: 7573 746f 6d20 696d 6167 6520 2d2d 2d2d  ustom image ----
+0001fc10: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0001fc20: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+0001fc30: 5f61 7773 5f63 7573 746f 6d5f 696d 6167  _aws_custom_imag
+0001fc40: 6528 293a 0a20 2020 2022 2222 5465 7374  e():.    """Test
+0001fc50: 2041 5753 2063 7573 746f 6d20 696d 6167   AWS custom imag
+0001fc60: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
+0001fc70: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001fc80: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0001fc90: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
+0001fca0: 7374 2d61 7773 2d63 7573 746f 6d2d 696d  st-aws-custom-im
+0001fcb0: 6167 6527 2c0a 2020 2020 2020 2020 5b0a  age',.        [.
+0001fcc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001fcd0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0001fce0: 657d 202d 2d72 6574 7279 2d75 6e74 696c  e} --retry-until
+0001fcf0: 2d75 7020 2d79 2074 6573 7473 2f74 6573  -up -y tests/tes
+0001fd00: 745f 7961 6d6c 732f 7465 7374 5f63 7573  t_yamls/test_cus
+0001fd10: 746f 6d5f 696d 6167 652e 7961 6d6c 202d  tom_image.yaml -
+0001fd20: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
+0001fd30: 696f 6e20 7573 2d65 6173 742d 3220 2d2d  ion us-east-2 --
+0001fd40: 696d 6167 652d 6964 2061 6d69 2d30 3632  image-id ami-062
+0001fd50: 6464 6439 3066 6236 6638 3236 3761 272c  ddd90fb6f8267a',
+0001fd60: 2020 2320 4e76 6964 6961 2069 6d61 6765    # Nvidia image
+0001fd70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001fd80: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0001fd90: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001fda0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001fdb0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001fdc0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0001fdd0: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+0001fde0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001fdf0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001fe00: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+0001fe10: 6e65 7465 730a 4070 7974 6573 742e 6d61  netes.@pytest.ma
+0001fe20: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
+0001fe30: 2020 2020 2769 6d61 6765 5f69 6427 2c0a      'image_id',.
+0001fe40: 2020 2020 5b0a 2020 2020 2020 2020 2764      [.        'd
+0001fe50: 6f63 6b65 723a 6e76 6964 6961 2f63 7564  ocker:nvidia/cud
+0001fe60: 613a 3131 2e38 2e30 2d64 6576 656c 2d75  a:11.8.0-devel-u
+0001fe70: 6275 6e74 7531 382e 3034 272c 0a20 2020  buntu18.04',.   
+0001fe80: 2020 2020 2027 646f 636b 6572 3a75 6275       'docker:ubu
+0001fe90: 6e74 753a 3138 2e30 3427 2c0a 2020 2020  ntu:18.04',.    
+0001fea0: 2020 2020 2320 5465 7374 206c 6174 6573      # Test lates
+0001feb0: 7420 696d 6167 6520 7769 7468 2070 7974  t image with pyt
+0001fec0: 686f 6e20 332e 3131 2069 6e73 7461 6c6c  hon 3.11 install
+0001fed0: 6564 2062 7920 6465 6661 756c 742e 0a20  ed by default.. 
+0001fee0: 2020 2020 2020 2027 646f 636b 6572 3a63         'docker:c
+0001fef0: 6f6e 7469 6e75 756d 696f 2f6d 696e 6963  ontinuumio/minic
+0001ff00: 6f6e 6461 333a 3234 2e31 2e32 2d30 272c  onda3:24.1.2-0',
+0001ff10: 0a20 2020 2020 2020 2023 2054 6573 7420  .        # Test 
+0001ff20: 7079 7468 6f6e 3e3d 332e 3132 2077 6865  python>=3.12 whe
+0001ff30: 7265 2053 6b79 5069 6c6f 7420 7368 6f75  re SkyPilot shou
+0001ff40: 6c64 2061 7574 6f6d 6174 6963 616c 6c79  ld automatically
+0001ff50: 2063 7265 6174 6520 6120 7365 7061 7261   create a separa
+0001ff60: 7465 0a20 2020 2020 2020 2023 2063 6f6e  te.        # con
+0001ff70: 6461 2065 6e76 2066 6f72 2072 756e 7469  da env for runti
+0001ff80: 6d65 2077 6974 6820 7079 7468 6f6e 2033  me with python 3
+0001ff90: 2e31 302e 0a20 2020 2020 2020 2027 646f  .10..        'do
+0001ffa0: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
+0001ffb0: 2f6d 696e 6963 6f6e 6461 333a 6c61 7465  /miniconda3:late
+0001ffc0: 7374 272c 0a20 2020 205d 290a 6465 6620  st',.    ]).def 
+0001ffd0: 7465 7374 5f6b 7562 6572 6e65 7465 735f  test_kubernetes_
+0001ffe0: 6375 7374 6f6d 5f69 6d61 6765 2869 6d61  custom_image(ima
+0001fff0: 6765 5f69 6429 3a0a 2020 2020 2222 2254  ge_id):.    """T
+00020000: 6573 7420 4b75 6265 726e 6574 6573 2063  est Kubernetes c
+00020010: 7573 746f 6d20 696d 6167 6522 2222 0a20  ustom image""". 
+00020020: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00020030: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00020040: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00020050: 2020 2020 2020 2027 7465 7374 2d6b 7562         'test-kub
+00020060: 6572 6e65 7465 732d 6375 7374 6f6d 2d69  ernetes-custom-i
+00020070: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
+00020080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00020090: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+000200a0: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
+000200b0: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
+000200c0: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
+000200d0: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
+000200e0: 2d2d 636c 6f75 6420 6b75 6265 726e 6574  --cloud kubernet
+000200f0: 6573 202d 2d69 6d61 6765 2d69 6420 7b69  es --image-id {i
+00020100: 6d61 6765 5f69 647d 202d 2d72 6567 696f  mage_id} --regio
+00020110: 6e20 4e6f 6e65 202d 2d67 7075 7320 5434  n None --gpus T4
+00020120: 3a31 272c 0a20 2020 2020 2020 2020 2020  :1',.           
+00020130: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00020140: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+00020150: 2020 2020 2020 2020 2020 2020 2320 5472              # Tr
+00020160: 7920 6578 6563 2074 6f20 7275 6e20 6167  y exec to run ag
+00020170: 6169 6e20 616e 6420 6368 6563 6b20 6966  ain and check if
+00020180: 2074 6865 206c 6f67 7320 6172 6520 7072   the logs are pr
+00020190: 696e 7465 640a 2020 2020 2020 2020 2020  inted.          
+000201a0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000201b0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+000201c0: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
+000201d0: 5f69 6d61 6765 2e79 616d 6c20 2d2d 636c  _image.yaml --cl
+000201e0: 6f75 6420 6b75 6265 726e 6574 6573 202d  oud kubernetes -
+000201f0: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
+00020200: 5f69 647d 202d 2d72 6567 696f 6e20 4e6f  _id} --region No
+00020210: 6e65 202d 2d67 7075 7320 5434 3a31 207c  ne --gpus T4:1 |
+00020220: 2067 7265 7020 2248 656c 6c6f 2031 3030   grep "Hello 100
+00020230: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00020240: 2320 4d61 6b65 2073 7572 6520 7373 6820  # Make sure ssh 
+00020250: 6973 2077 6f72 6b69 6e67 2077 6974 6820  is working with 
+00020260: 6375 7374 6f6d 2075 7365 726e 616d 650a  custom username.
+00020270: 2020 2020 2020 2020 2020 2020 6627 7373              f'ss
+00020280: 6820 7b6e 616d 657d 2065 6368 6f20 6869  h {name} echo hi
+00020290: 207c 2067 7265 7020 6869 272c 0a20 2020   | grep hi',.   
+000202a0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000202b0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000202c0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+000202d0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+000202e0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000202f0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00020300: 7079 7465 7374 2e6d 6172 6b2e 736c 6f77  pytest.mark.slow
+00020310: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
+00020320: 7374 6172 745f 7374 6f70 5f74 776f 5f6e  start_stop_two_n
+00020330: 6f64 6573 2829 3a0a 2020 2020 6e61 6d65  odes():.    name
+00020340: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00020350: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00020360: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00020370: 2761 7a75 7265 2d73 7461 7274 2d73 746f  'azure-start-sto
+00020380: 702d 7477 6f2d 6e6f 6465 7327 2c0a 2020  p-two-nodes',.  
+00020390: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000203a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000203b0: 202d 2d6e 756d 2d6e 6f64 6573 3d32 202d   --num-nodes=2 -
+000203c0: 7920 2d63 207b 6e61 6d65 7d20 6578 616d  y -c {name} exam
+000203d0: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
+000203e0: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
+000203f0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00020400: 7865 6320 2d2d 6e75 6d2d 6e6f 6465 733d  xec --num-nodes=
+00020410: 3220 7b6e 616d 657d 2065 7861 6d70 6c65  2 {name} example
+00020420: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
+00020430: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+00020440: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00020450: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00020460: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00020470: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00020480: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00020490: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
+000204a0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+000204b0: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+000204c0: 7b6e 616d 657d 202d 6920 3127 2c0a 2020  {name} -i 1',.  
+000204d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000204e0: 6578 6563 202d 2d6e 756d 2d6e 6f64 6573  exec --num-nodes
+000204f0: 3d32 207b 6e61 6d65 7d20 6578 616d 706c  =2 {name} exampl
+00020500: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+00020510: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+00020520: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00020530: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00020540: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00020550: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00020560: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+00020570: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00020580: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00020590: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+000205a0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+000205b0: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
+000205c0: 6772 6570 2022 494e 4954 5c7c 5354 4f50  grep "INIT\|STOP
+000205d0: 5045 4422 270a 2020 2020 2020 2020 2020  PED"'.          
+000205e0: 2020 6627 7c7c 207b 7b20 7373 6820 7b6e    f'|| {{ ssh {n
+000205f0: 616d 657d 2022 6361 7420 7e2f 2e73 6b79  ame} "cat ~/.sky
+00020600: 2f73 6b79 6c65 742e 6c6f 6722 3b20 6578  /skylet.log"; ex
+00020610: 6974 2031 3b20 7d7d 270a 2020 2020 2020  it 1; }}'.      
+00020620: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00020630: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00020640: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00020650: 6f75 743d 3330 202a 2036 302c 2020 2320  out=30 * 60,  # 
+00020660: 3330 206d 696e 7320 2028 6974 2074 616b  30 mins  (it tak
+00020670: 6573 2061 726f 756e 6420 7e32 3320 6d69  es around ~23 mi
+00020680: 6e73 290a 2020 2020 290a 2020 2020 7275  ns).    ).    ru
+00020690: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000206a0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+000206b0: 5465 7374 696e 6720 656e 7620 666f 7220  Testing env for 
+000206c0: 6469 736b 2074 6965 7220 2d2d 2d2d 2d2d  disk tier ------
+000206d0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+000206e0: 6b2e 6177 730a 6465 6620 7465 7374 5f61  k.aws.def test_a
+000206f0: 7773 5f64 6973 6b5f 7469 6572 2829 3a0a  ws_disk_tier():.
+00020700: 0a20 2020 2064 6566 205f 6765 745f 6177  .    def _get_aw
+00020710: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
+00020720: 7265 6769 6f6e 2c20 696e 7374 616e 6365  region, instance
+00020730: 5f69 642c 2066 6965 6c64 2c20 6578 7065  _id, field, expe
+00020740: 6374 6564 293a 0a20 2020 2020 2020 2072  cted):.        r
+00020750: 6574 7572 6e20 2866 2761 7773 2065 6332  eturn (f'aws ec2
+00020760: 2064 6573 6372 6962 652d 766f 6c75 6d65   describe-volume
+00020770: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00020780: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00020790: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+000207a0: 7320 4e61 6d65 3d61 7474 6163 686d 656e  s Name=attachmen
+000207b0: 742e 696e 7374 616e 6365 2d69 642c 5661  t.instance-id,Va
+000207c0: 6c75 6573 3d7b 696e 7374 616e 6365 5f69  lues={instance_i
+000207d0: 647d 2027 0a20 2020 2020 2020 2020 2020  d} '.           
+000207e0: 2020 2020 2066 272d 2d71 7565 7279 2056       f'--query V
+000207f0: 6f6c 756d 6573 5b2a 5d2e 7b66 6965 6c64  olumes[*].{field
+00020800: 7d20 7c20 6772 6570 207b 6578 7065 6374  } | grep {expect
+00020810: 6564 7d20 3b20 2729 0a0a 2020 2020 666f  ed} ; ')..    fo
+00020820: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
+00020830: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
+00020840: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
+00020850: 2020 2020 2020 2073 7065 6373 203d 2041         specs = A
+00020860: 5753 2e5f 6765 745f 6469 736b 5f73 7065  WS._get_disk_spe
+00020870: 6373 2864 6973 6b5f 7469 6572 290a 2020  cs(disk_tier).  
+00020880: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+00020890: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000208a0: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+000208b0: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
+000208c0: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
+000208d0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+000208e0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+000208f0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+00020900: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
+00020910: 4157 532e 6d61 785f 636c 7573 7465 725f  AWS.max_cluster_
+00020920: 6e61 6d65 5f6c 656e 6774 6828 2929 0a20  name_length()). 
+00020930: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+00020940: 2775 732d 6561 7374 2d32 270a 2020 2020  'us-east-2'.    
+00020950: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020960: 0a20 2020 2020 2020 2020 2020 2027 6177  .            'aw
+00020970: 732d 6469 736b 2d74 6965 722d 2720 2b20  s-disk-tier-' + 
+00020980: 6469 736b 5f74 6965 722e 7661 6c75 652c  disk_tier.value,
+00020990: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+000209a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000209b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000209c0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000209d0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+000209e0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+000209f0: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
+00020a00: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
+00020a10: 722e 7661 6c75 657d 2065 6368 6f20 2268  r.value} echo "h
+00020a20: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
+00020a30: 2020 2020 2020 2020 2020 2020 6627 6964              f'id
+00020a40: 3d60 6177 7320 6563 3220 6465 7363 7269  =`aws ec2 descri
+00020a50: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
+00020a60: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+00020a70: 2d66 696c 7465 7273 2027 0a20 2020 2020  -filters '.     
+00020a80: 2020 2020 2020 2020 2020 2066 274e 616d             f'Nam
+00020a90: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00020aa0: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+00020ab0: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
+00020ac0: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+00020ad0: 2020 2020 2020 2020 6627 5265 7365 7276          f'Reserv
+00020ae0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
+00020af0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
+00020b00: 2d2d 6f75 7470 7574 2074 6578 7460 3b20  --output text`; 
+00020b10: 2720 2b0a 2020 2020 2020 2020 2020 2020  ' +.            
+00020b20: 2020 2020 5f67 6574 5f61 7773 5f71 7565      _get_aws_que
+00020b30: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
+00020b40: 6e2c 2027 2469 6427 2c20 2756 6f6c 756d  n, '$id', 'Volum
+00020b50: 6554 7970 6527 2c0a 2020 2020 2020 2020  eType',.        
+00020b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00020b80: 7065 6373 5b27 6469 736b 5f74 6965 7227  pecs['disk_tier'
+00020b90: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00020ba0: 2020 2020 2028 2727 2069 6620 6469 736b       ('' if disk
+00020bb0: 5f74 6965 7220 3d3d 2072 6573 6f75 7263  _tier == resourc
+00020bc0: 6573 5f75 7469 6c73 2e44 6973 6b54 6965  es_utils.DiskTie
+00020bd0: 722e 4c4f 5720 656c 7365 0a20 2020 2020  r.LOW else.     
+00020be0: 2020 2020 2020 2020 2020 2020 285f 6765              (_ge
+00020bf0: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
+00020c00: 616e 6428 7265 6769 6f6e 2c20 2724 6964  and(region, '$id
+00020c10: 272c 2027 496f 7073 272c 0a20 2020 2020  ', 'Iops',.     
+00020c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c40: 2020 2020 7370 6563 735b 2764 6973 6b5f      specs['disk_
+00020c50: 696f 7073 275d 2920 2b0a 2020 2020 2020  iops']) +.      
+00020c60: 2020 2020 2020 2020 2020 2020 5f67 6574              _get
+00020c70: 5f61 7773 5f71 7565 7279 5f63 6f6d 6d61  _aws_query_comma
+00020c80: 6e64 2872 6567 696f 6e2c 2027 2469 6427  nd(region, '$id'
+00020c90: 2c20 2754 6872 6f75 6768 7075 7427 2c0a  , 'Throughput',.
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cc0: 2020 2020 2020 2020 2073 7065 6373 5b27           specs['
+00020cd0: 6469 736b 5f74 6872 6f75 6768 7075 7427  disk_throughput'
+00020ce0: 5d29 2929 2c0a 2020 2020 2020 2020 2020  ]))),.          
+00020cf0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00020d00: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00020d10: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00020d20: 2020 2020 7469 6d65 6f75 743d 3130 202a      timeout=10 *
+00020d30: 2036 302c 2020 2320 3130 206d 696e 7320   60,  # 10 mins 
+00020d40: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
+00020d50: 6420 7e36 206d 696e 7329 0a20 2020 2020  d ~6 mins).     
+00020d60: 2020 2029 0a20 2020 2020 2020 2072 756e     ).        run
+00020d70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00020d80: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00020d90: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00020da0: 6469 736b 5f74 6965 7228 293a 0a20 2020  disk_tier():.   
+00020db0: 2066 6f72 2064 6973 6b5f 7469 6572 2069   for disk_tier i
+00020dc0: 6e20 6c69 7374 2872 6573 6f75 7263 6573  n list(resources
+00020dd0: 5f75 7469 6c73 2e44 6973 6b54 6965 7229  _utils.DiskTier)
+00020de0: 3a0a 2020 2020 2020 2020 7479 7065 203d  :.        type =
+00020df0: 2047 4350 2e5f 6765 745f 6469 736b 5f74   GCP._get_disk_t
+00020e00: 7970 6528 6469 736b 5f74 6965 7229 0a20  ype(disk_tier). 
+00020e10: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+00020e20: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00020e30: 2920 2b20 272d 2720 2b20 6469 736b 5f74  ) + '-' + disk_t
+00020e40: 6965 722e 7661 6c75 650a 2020 2020 2020  ier.value.      
+00020e50: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00020e60: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+00020e70: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+00020e80: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+00020e90: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
+00020ea0: 2e47 4350 2e6d 6178 5f63 6c75 7374 6572  .GCP.max_cluster
+00020eb0: 5f6e 616d 655f 6c65 6e67 7468 2829 290a  _name_length()).
+00020ec0: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
+00020ed0: 2027 7573 2d77 6573 7432 270a 2020 2020   'us-west2'.    
+00020ee0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020ef0: 0a20 2020 2020 2020 2020 2020 2027 6763  .            'gc
+00020f00: 702d 6469 736b 2d74 6965 722d 2720 2b20  p-disk-tier-' + 
+00020f10: 6469 736b 5f74 6965 722e 7661 6c75 652c  disk_tier.value,
+00020f20: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00020f30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020f40: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00020f50: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00020f60: 2067 6370 202d 2d72 6567 696f 6e20 7b72   gcp --region {r
+00020f70: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00020f80: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
+00020f90: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
+00020fa0: 722e 7661 6c75 657d 2065 6368 6f20 2268  r.value} echo "h
+00020fb0: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
+00020fc0: 2020 2020 2020 2020 2020 2020 6627 6e61              f'na
+00020fd0: 6d65 3d60 6763 6c6f 7564 2063 6f6d 7075  me=`gcloud compu
+00020fe0: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
+00020ff0: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
+00021000: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
+00021010: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
+00021020: 6572 2d6e 616d 653a 7b6e 616d 655f 6f6e  er-name:{name_on
+00021030: 5f63 6c6f 7564 7d22 2027 0a20 2020 2020  _cloud}" '.     
+00021040: 2020 2020 2020 2020 2020 2027 2d2d 666f             '--fo
+00021050: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
+00021060: 2922 603b 2027 0a20 2020 2020 2020 2020  )"`; '.         
+00021070: 2020 2020 2020 2066 2767 636c 6f75 6420         f'gcloud 
+00021080: 636f 6d70 7574 6520 6469 736b 7320 6c69  compute disks li
+00021090: 7374 202d 2d66 696c 7465 723d 226e 616d  st --filter="nam
+000210a0: 653d 246e 616d 6522 2027 0a20 2020 2020  e=$name" '.     
+000210b0: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+000210c0: 6f72 6d61 743d 2276 616c 7565 2874 7970  ormat="value(typ
+000210d0: 6529 2220 7c20 6772 6570 207b 7479 7065  e)" | grep {type
+000210e0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+000210f0: 5d2c 0a20 2020 2020 2020 2020 2020 2066  ],.            f
+00021100: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00021110: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+00021120: 2020 7469 6d65 6f75 743d 3620 2a20 3630    timeout=6 * 60
+00021130: 2c20 2023 2036 206d 696e 7320 2028 6974  ,  # 6 mins  (it
+00021140: 2074 616b 6573 2061 726f 756e 6420 7e33   takes around ~3
+00021150: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
+00021160: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+00021170: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00021180: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
+00021190: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
+000211a0: 6469 736b 5f74 6965 7228 293a 0a20 2020  disk_tier():.   
+000211b0: 2066 6f72 2064 6973 6b5f 7469 6572 2069   for disk_tier i
+000211c0: 6e20 6c69 7374 2872 6573 6f75 7263 6573  n list(resources
+000211d0: 5f75 7469 6c73 2e44 6973 6b54 6965 7229  _utils.DiskTier)
+000211e0: 3a0a 2020 2020 2020 2020 6966 2064 6973  :.        if dis
+000211f0: 6b5f 7469 6572 203d 3d20 7265 736f 7572  k_tier == resour
+00021200: 6365 735f 7574 696c 732e 4469 736b 5469  ces_utils.DiskTi
+00021210: 6572 2e48 4947 483a 0a20 2020 2020 2020  er.HIGH:.       
+00021220: 2020 2020 2023 2041 7a75 7265 2064 6f65       # Azure doe
+00021230: 7320 6e6f 7420 7375 7070 6f72 7420 6869  s not support hi
+00021240: 6768 2064 6973 6b20 7469 6572 2e0a 2020  gh disk tier..  
+00021250: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00021260: 7565 0a20 2020 2020 2020 2074 7970 6520  ue.        type 
+00021270: 3d20 417a 7572 652e 5f67 6574 5f64 6973  = Azure._get_dis
+00021280: 6b5f 7479 7065 2864 6973 6b5f 7469 6572  k_type(disk_tier
+00021290: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
+000212a0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000212b0: 6d65 2829 202b 2027 2d27 202b 2064 6973  me() + '-' + dis
+000212c0: 6b5f 7469 6572 2e76 616c 7565 0a20 2020  k_tier.value.   
+000212d0: 2020 2020 206e 616d 655f 6f6e 5f63 6c6f       name_on_clo
+000212e0: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+000212f0: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+00021300: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+00021310: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
+00021320: 736b 792e 417a 7572 652e 6d61 785f 636c  sky.Azure.max_cl
+00021330: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
+00021340: 6828 2929 0a20 2020 2020 2020 2072 6567  h()).        reg
+00021350: 696f 6e20 3d20 2777 6573 7475 7332 270a  ion = 'westus2'.
+00021360: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+00021370: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+00021380: 2027 617a 7572 652d 6469 736b 2d74 6965   'azure-disk-tie
+00021390: 722d 2720 2b20 6469 736b 5f74 6965 722e  r-' + disk_tier.
+000213a0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+000213b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000213c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000213d0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+000213e0: 2d63 6c6f 7564 2061 7a75 7265 202d 2d72  -cloud azure --r
+000213f0: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
+00021400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021410: 2066 272d 2d64 6973 6b2d 7469 6572 207b   f'--disk-tier {
+00021420: 6469 736b 5f74 6965 722e 7661 6c75 657d  disk_tier.value}
+00021430: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
+00021440: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00021450: 2020 2020 6627 617a 2072 6573 6f75 7263      f'az resourc
+00021460: 6520 6c69 7374 202d 2d74 6167 2072 6179  e list --tag ray
+00021470: 2d63 6c75 7374 6572 2d6e 616d 653d 7b6e  -cluster-name={n
+00021480: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
+00021490: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+000214a0: 2020 2020 2020 2020 6627 225b 3f74 7970          f'"[?typ
+000214b0: 653d 3d5c 274d 6963 726f 736f 6674 2e43  e==\'Microsoft.C
+000214c0: 6f6d 7075 7465 2f64 6973 6b73 5c27 5d2e  ompute/disks\'].
+000214d0: 736b 752e 6e61 6d65 2220 270a 2020 2020  sku.name" '.    
+000214e0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000214f0: 6f75 7470 7574 2074 7376 207c 2067 7265  output tsv | gre
+00021500: 7020 7b74 7970 657d 270a 2020 2020 2020  p {type}'.      
+00021510: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00021520: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00021530: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00021540: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00021550: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
+00021560: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+00021570: 726f 756e 6420 7e31 3220 6d69 6e73 290a  round ~12 mins).
+00021580: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00021590: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000215a0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000215b0: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
+000215c0: 7374 5f61 7a75 7265 5f62 6573 745f 7469  st_azure_best_ti
+000215d0: 6572 5f66 6169 6c6f 7665 7228 293a 0a20  er_failover():. 
+000215e0: 2020 2074 7970 6520 3d20 417a 7572 652e     type = Azure.
+000215f0: 5f67 6574 5f64 6973 6b5f 7479 7065 2872  _get_disk_type(r
+00021600: 6573 6f75 7263 6573 5f75 7469 6c73 2e44  esources_utils.D
+00021610: 6973 6b54 6965 722e 4c4f 5729 0a20 2020  iskTier.LOW).   
+00021620: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00021630: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00021640: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+00021650: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+00021660: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+00021670: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+00021680: 206e 616d 652c 2073 6b79 2e41 7a75 7265   name, sky.Azure
+00021690: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+000216a0: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
+000216b0: 7265 6769 6f6e 203d 2027 7765 7374 7573  region = 'westus
+000216c0: 3227 0a20 2020 2074 6573 7420 3d20 5465  2'.    test = Te
+000216d0: 7374 280a 2020 2020 2020 2020 2761 7a75  st(.        'azu
+000216e0: 7265 2d62 6573 742d 7469 6572 2d66 6169  re-best-tier-fai
+000216f0: 6c6f 7665 7227 2c0a 2020 2020 2020 2020  lover',.        
+00021700: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00021710: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00021720: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00021730: 617a 7572 6520 2d2d 7265 6769 6f6e 207b  azure --region {
+00021740: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+00021750: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
+00021760: 6965 7220 6265 7374 202d 2d69 6e73 7461  ier best --insta
+00021770: 6e63 652d 7479 7065 2053 7461 6e64 6172  nce-type Standar
+00021780: 645f 4438 5f76 3520 6563 686f 2022 6865  d_D8_v5 echo "he
+00021790: 6c6c 6f20 736b 7922 272c 0a20 2020 2020  llo sky"',.     
+000217a0: 2020 2020 2020 2066 2761 7a20 7265 736f         f'az reso
+000217b0: 7572 6365 206c 6973 7420 2d2d 7461 6720  urce list --tag 
+000217c0: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+000217d0: 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  ={name_on_cloud}
+000217e0: 202d 2d71 7565 7279 2027 0a20 2020 2020   --query '.     
+000217f0: 2020 2020 2020 2066 2722 5b3f 7479 7065         f'"[?type
+00021800: 3d3d 5c27 4d69 6372 6f73 6f66 742e 436f  ==\'Microsoft.Co
+00021810: 6d70 7574 652f 6469 736b 735c 275d 2e73  mpute/disks\'].s
+00021820: 6b75 2e6e 616d 6522 2027 0a20 2020 2020  ku.name" '.     
+00021830: 2020 2020 2020 2066 272d 2d6f 7574 7075         f'--outpu
+00021840: 7420 7473 7620 7c20 6772 6570 207b 7479  t tsv | grep {ty
+00021850: 7065 7d27 2c0a 2020 2020 2020 2020 5d2c  pe}',.        ],
+00021860: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00021870: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00021880: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00021890: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
+000218a0: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+000218b0: 726f 756e 6420 7e31 3220 6d69 6e73 290a  round ~12 mins).
+000218c0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000218d0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+000218e0: 202d 2d2d 2d2d 2d20 5465 7374 696e 6720   ------ Testing 
+000218f0: 5a65 726f 2051 756f 7461 2046 6169 6c6f  Zero Quota Failo
+00021900: 7665 7220 2d2d 2d2d 2d2d 0a40 7079 7465  ver ------.@pyte
+00021910: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00021920: 7465 7374 5f61 7773 5f7a 6572 6f5f 7175  test_aws_zero_qu
+00021930: 6f74 615f 6661 696c 6f76 6572 2829 3a0a  ota_failover():.
+00021940: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00021950: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00021960: 2020 2020 7265 6769 6f6e 203d 2067 6574      region = get
+00021970: 5f61 7773 5f72 6567 696f 6e5f 666f 725f  _aws_region_for_
+00021980: 7175 6f74 615f 6661 696c 6f76 6572 2829  quota_failover()
+00021990: 0a0a 2020 2020 6966 206e 6f74 2072 6567  ..    if not reg
+000219a0: 696f 6e3a 0a20 2020 2020 2020 2070 7974  ion:.        pyt
+000219b0: 6573 742e 7866 6169 6c28 0a20 2020 2020  est.xfail(.     
+000219c0: 2020 2020 2020 2027 556e 6162 6c65 2074         'Unable t
+000219d0: 6f20 7465 7374 207a 6572 6f20 7175 6f74  o test zero quot
+000219e0: 6120 6661 696c 6f76 6572 206f 7074 696d  a failover optim
+000219f0: 697a 6174 696f 6e20 e280 9420 7175 6f74  ization ... quot
+00021a00: 6173 2027 0a20 2020 2020 2020 2020 2020  as '.           
+00021a10: 2027 666f 7220 4543 3220 5033 2069 6e73   'for EC2 P3 ins
+00021a20: 7461 6e63 6573 2077 6572 6520 666f 756e  tances were foun
+00021a30: 6420 6f6e 2061 6c6c 2041 5753 2072 6567  d on all AWS reg
+00021a40: 696f 6e73 2e20 4973 2074 6869 7320 270a  ions. Is this '.
+00021a50: 2020 2020 2020 2020 2020 2020 2765 7870              'exp
+00021a60: 6563 7465 6420 666f 7220 796f 7572 2061  ected for your a
+00021a70: 6363 6f75 6e74 3f27 290a 2020 2020 2020  ccount?').      
+00021a80: 2020 7265 7475 726e 0a0a 2020 2020 7465    return..    te
+00021a90: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00021aa0: 2020 2027 6177 732d 7a65 726f 2d71 756f     'aws-zero-quo
+00021ab0: 7461 2d66 6169 6c6f 7665 7227 2c0a 2020  ta-failover',.  
+00021ac0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00021ad0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00021ae0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00021af0: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00021b00: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 6770  on {region} --gp
+00021b10: 7573 2056 3130 303a 3820 2d2d 7573 652d  us V100:8 --use-
+00021b20: 7370 6f74 207c 2067 7265 7020 2246 6f75  spot | grep "Fou
+00021b30: 6e64 206e 6f20 7175 6f74 6122 272c 0a20  nd no quota"',. 
+00021b40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00021b50: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00021b60: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00021b70: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00021b80: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00021b90: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00021ba0: 745f 6763 705f 7a65 726f 5f71 756f 7461  t_gcp_zero_quota
+00021bb0: 5f66 6169 6c6f 7665 7228 293a 0a0a 2020  _failover():..  
+00021bc0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00021bd0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00021be0: 2072 6567 696f 6e20 3d20 6765 745f 6763   region = get_gc
+00021bf0: 705f 7265 6769 6f6e 5f66 6f72 5f71 756f  p_region_for_quo
+00021c00: 7461 5f66 6169 6c6f 7665 7228 290a 0a20  ta_failover().. 
+00021c10: 2020 2069 6620 6e6f 7420 7265 6769 6f6e     if not region
+00021c20: 3a0a 2020 2020 2020 2020 7079 7465 7374  :.        pytest
+00021c30: 2e78 6661 696c 280a 2020 2020 2020 2020  .xfail(.        
+00021c40: 2020 2020 2755 6e61 626c 6520 746f 2074      'Unable to t
+00021c50: 6573 7420 7a65 726f 2071 756f 7461 2066  est zero quota f
+00021c60: 6169 6c6f 7665 7220 6f70 7469 6d69 7a61  ailover optimiza
+00021c70: 7469 6f6e 20e2 8094 2071 756f 7461 7320  tion ... quotas 
+00021c80: 270a 2020 2020 2020 2020 2020 2020 2766  '.            'f
+00021c90: 6f72 2041 3130 302d 3830 4742 2047 5055  or A100-80GB GPU
+00021ca0: 7320 7765 7265 2066 6f75 6e64 206f 6e20  s were found on 
+00021cb0: 616c 6c20 4743 5020 7265 6769 6f6e 732e  all GCP regions.
+00021cc0: 2049 7320 7468 6973 2027 0a20 2020 2020   Is this '.     
+00021cd0: 2020 2020 2020 2027 6578 7065 6374 6564         'expected
+00021ce0: 2066 6f72 2079 6f75 7220 6163 636f 756e   for your accoun
+00021cf0: 743f 2729 0a20 2020 2020 2020 2072 6574  t?').        ret
+00021d00: 7572 6e0a 0a20 2020 2074 6573 7420 3d20  urn..    test = 
+00021d10: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
+00021d20: 6370 2d7a 6572 6f2d 7175 6f74 612d 6661  cp-zero-quota-fa
+00021d30: 696c 6f76 6572 272c 0a20 2020 2020 2020  ilover',.       
+00021d40: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00021d50: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00021d60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00021d70: 2067 6370 202d 2d72 6567 696f 6e20 7b72   gcp --region {r
+00021d80: 6567 696f 6e7d 202d 2d67 7075 7320 4131  egion} --gpus A1
+00021d90: 3030 2d38 3047 423a 3120 2d2d 7573 652d  00-80GB:1 --use-
+00021da0: 7370 6f74 207c 2067 7265 7020 2246 6f75  spot | grep "Fou
+00021db0: 6e64 206e 6f20 7175 6f74 6122 272c 0a20  nd no quota"',. 
+00021dc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00021dd0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00021de0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00021df0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00021e00: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00021e10: 2d2d 2d2d 2054 6573 7469 6e67 2073 6b79  ---- Testing sky
+00021e20: 7365 7276 6520 2d2d 2d2d 2d2d 2d2d 2d2d  serve ----------
+00021e30: 0a0a 0a64 6566 205f 6765 745f 7365 7276  ...def _get_serv
+00021e40: 6963 655f 6e61 6d65 2829 202d 3e20 7374  ice_name() -> st
+00021e50: 723a 0a20 2020 2022 2222 5265 7475 726e  r:.    """Return
+00021e60: 7320 6120 7573 6572 2d75 6e69 7175 6520  s a user-unique 
+00021e70: 7365 7276 6963 6520 6e61 6d65 2066 6f72  service name for
+00021e80: 2065 6163 6820 7465 7374 5f73 6b79 7365   each test_skyse
+00021e90: 7276 655f 3c6e 616d 653e 2829 2e0a 0a20  rve_<name>()... 
+00021ea0: 2020 204d 7573 7420 6265 2063 616c 6c65     Must be calle
+00021eb0: 6420 6672 6f6d 2065 6163 6820 7465 7374  d from each test
+00021ec0: 5f73 6b79 7365 7276 655f 3c6e 616d 653e  _skyserve_<name>
+00021ed0: 2829 2e0a 2020 2020 2222 220a 2020 2020  ()..    """.    
+00021ee0: 6361 6c6c 6572 5f66 756e 635f 6e61 6d65  caller_func_name
+00021ef0: 203d 2069 6e73 7065 6374 2e73 7461 636b   = inspect.stack
+00021f00: 2829 5b31 5d5b 335d 0a20 2020 2074 6573  ()[1][3].    tes
+00021f10: 745f 6e61 6d65 203d 2063 616c 6c65 725f  t_name = caller_
+00021f20: 6675 6e63 5f6e 616d 652e 7265 706c 6163  func_name.replac
+00021f30: 6528 275f 272c 2027 2d27 292e 7265 706c  e('_', '-').repl
+00021f40: 6163 6528 2774 6573 742d 272c 2027 742d  ace('test-', 't-
+00021f50: 2729 0a20 2020 2074 6573 745f 6e61 6d65  ').    test_name
+00021f60: 203d 2074 6573 745f 6e61 6d65 2e72 6570   = test_name.rep
+00021f70: 6c61 6365 2827 736b 7973 6572 7665 2d27  lace('skyserve-'
+00021f80: 2c20 2773 732d 2729 0a20 2020 2074 6573  , 'ss-').    tes
+00021f90: 745f 6e61 6d65 203d 2063 6f6d 6d6f 6e5f  t_name = common_
+00021fa0: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+00021fb0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+00021fc0: 2874 6573 745f 6e61 6d65 2c20 3234 290a  (test_name, 24).
+00021fd0: 2020 2020 7265 7475 726e 2066 277b 7465      return f'{te
+00021fe0: 7374 5f6e 616d 657d 2d7b 7465 7374 5f69  st_name}-{test_i
+00021ff0: 647d 270a 0a0a 2320 5765 2063 6865 636b  d}'...# We check
+00022000: 2074 6865 206f 7574 7075 7420 6f66 2074   the output of t
+00022010: 6865 2073 6b79 7365 7276 6520 7365 7276  he skyserve serv
+00022020: 6963 6520 746f 2073 6565 2069 6620 6974  ice to see if it
+00022030: 2069 7320 7265 6164 792e 204f 7574 7075   is ready. Outpu
+00022040: 7420 6f66 0a23 2060 5245 504c 4943 4153  t of.# `REPLICAS
+00022050: 6020 6973 2069 6e20 7468 6520 666f 726d  ` is in the form
+00022060: 206f 6620 6031 2f32 6020 7768 6572 6520   of `1/2` where 
+00022070: 7468 6520 6669 7273 7420 6e75 6d62 6572  the first number
+00022080: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
+00022090: 660a 2320 7265 6164 7920 7265 706c 6963  f.# ready replic
+000220a0: 6173 2061 6e64 2074 6865 2073 6563 6f6e  as and the secon
+000220b0: 6420 6e75 6d62 6572 2069 7320 7468 6520  d number is the 
+000220c0: 6e75 6d62 6572 206f 6620 746f 7461 6c20  number of total 
+000220d0: 7265 706c 6963 6173 2e20 5765 0a23 2067  replicas. We.# g
+000220e0: 7265 7020 7375 6368 2066 6f72 6d61 7420  rep such format 
+000220f0: 746f 2065 6e73 7572 6520 7468 6174 2074  to ensure that t
+00022100: 6865 2073 6572 7669 6365 2069 7320 7265  he service is re
+00022110: 6164 792c 2061 6e64 2065 6172 6c79 2065  ady, and early e
+00022120: 7869 7420 6966 2061 6e79 0a23 2066 6169  xit if any.# fai
+00022130: 6c75 7265 2064 6574 6563 7465 642e 2049  lure detected. I
+00022140: 6e20 7468 6520 656e 6420 7765 2073 6c65  n the end we sle
+00022150: 6570 2066 6f72 0a23 2073 6572 7665 2e4c  ep for.# serve.L
+00022160: 425f 434f 4e54 524f 4c4c 4552 5f53 594e  B_CONTROLLER_SYN
+00022170: 435f 494e 5445 5256 414c 5f53 4543 4f4e  C_INTERVAL_SECON
+00022180: 4453 2074 6f20 6d61 6b65 2073 7572 6520  DS to make sure 
+00022190: 6c6f 6164 2062 616c 616e 6365 7220 6861  load balancer ha
+000221a0: 7665 0a23 2065 6e6f 7567 6820 7469 6d65  ve.# enough time
+000221b0: 2074 6f20 7379 6e63 2077 6974 6820 7468   to sync with th
+000221c0: 6520 636f 6e74 726f 6c6c 6572 2061 6e64  e controller and
+000221d0: 2067 6574 2061 6c6c 2072 6561 6479 2072   get all ready r
+000221e0: 6570 6c69 6361 2049 5073 2e0a 5f53 4552  eplica IPs.._SER
+000221f0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00022200: 4144 5920 3d20 280a 2020 2020 277b 7b20  ADY = (.    '{{ 
+00022210: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
+00022220: 2020 2020 2720 2020 2020 733d 2428 736b      '     s=$(sk
+00022230: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
+00022240: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00022250: 223b 270a 2020 2020 2720 2020 2020 6563  ";'.    '     ec
+00022260: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00022270: 7120 227b 7265 706c 6963 615f 6e75 6d7d  q "{replica_num}
+00022280: 2f7b 7265 706c 6963 615f 6e75 6d7d 2220  /{replica_num}" 
+00022290: 2626 2062 7265 616b 3b27 0a20 2020 2027  && break;'.    '
+000222a0: 2020 2020 2065 6368 6f20 2224 7322 207c       echo "$s" |
+000222b0: 2067 7265 7020 2d71 2022 4641 494c 4544   grep -q "FAILED
+000222c0: 2220 2626 2065 7869 7420 313b 270a 2020  " && exit 1;'.  
+000222d0: 2020 2720 2020 2020 736c 6565 7020 3130    '     sleep 10
+000222e0: 3b27 0a20 2020 2027 2064 6f6e 653b 207d  ;'.    ' done; }
+000222f0: 7d3b 2065 6368 6f20 2247 6f74 2073 6572  }; echo "Got ser
+00022300: 7669 6365 2073 7461 7475 7320 2473 223b  vice status $s";
+00022310: 270a 2020 2020 6627 736c 6565 7020 7b73  '.    f'sleep {s
+00022320: 6572 7665 2e4c 425f 434f 4e54 524f 4c4c  erve.LB_CONTROLL
+00022330: 4552 5f53 594e 435f 494e 5445 5256 414c  ER_SYNC_INTERVAL
+00022340: 5f53 4543 4f4e 4453 202b 2032 7d3b 2729  _SECONDS + 2};')
+00022350: 0a5f 4950 5f52 4547 4558 203d 2072 2728  ._IP_REGEX = r'(
+00022360: 5b30 2d39 5d7b 312c 337d 5c2e 297b 337d  [0-9]{1,3}\.){3}
+00022370: 5b30 2d39 5d7b 312c 337d 270a 5f41 574b  [0-9]{1,3}'._AWK
+00022380: 5f41 4c4c 5f4c 494e 4553 5f42 454c 4f57  _ALL_LINES_BELOW
+00022390: 5f52 4550 4c49 4341 5320 3d20 7227 2f52  _REPLICAS = r'/R
+000223a0: 6570 6c69 6361 732f 7b66 6c61 673d 313b  eplicas/{flag=1;
+000223b0: 206e 6578 747d 2066 6c61 6727 0a5f 5345   next} flag'._SE
+000223c0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000223d0: 5354 4154 5553 5f52 4547 4558 203d 2027  STATUS_REGEX = '
+000223e0: 5052 4f56 4953 494f 4e49 4e47 5c7c 5354  PROVISIONING\|ST
+000223f0: 4152 5449 4e47 270a 2320 5369 6e63 6520  ARTING'.# Since 
+00022400: 7765 2064 6f6e 2774 2061 6c6c 6f77 2074  we don't allow t
+00022410: 6572 6d69 6e61 7465 2074 6865 2073 6572  erminate the ser
+00022420: 7669 6365 2069 6620 7468 6520 636f 6e74  vice if the cont
+00022430: 726f 6c6c 6572 2069 7320 494e 4954 2c0a  roller is INIT,.
+00022440: 2320 7768 6963 6820 6973 2063 6f6d 6d6f  # which is commo
+00022450: 6e20 666f 7220 7369 6d75 6c74 616e 656f  n for simultaneo
+00022460: 7573 2070 7974 6573 742c 2077 6520 6e65  us pytest, we ne
+00022470: 6564 2074 6f20 7761 6974 2075 6e74 696c  ed to wait until
+00022480: 2074 6865 0a23 2063 6f6e 7472 6f6c 6c65   the.# controlle
+00022490: 7220 6973 2055 5020 6265 666f 7265 2077  r is UP before w
+000224a0: 6520 6361 6e20 7465 726d 696e 6174 6520  e can terminate 
+000224b0: 7468 6520 7365 7276 6963 652e 0a23 2054  the service..# T
+000224c0: 6865 2074 6561 7264 6f77 6e20 636f 6d6d  he teardown comm
+000224d0: 616e 6420 6861 7320 6120 3130 2d6d 696e  and has a 10-min
+000224e0: 7320 7469 6d65 6f75 742c 2073 6f20 7765  s timeout, so we
+000224f0: 2064 6f6e 2774 206e 6565 6420 746f 2064   don't need to d
+00022500: 6f0a 2320 7468 6520 7469 6d65 6f75 7420  o.# the timeout 
+00022510: 6865 7265 2e20 5365 6520 696d 706c 656d  here. See implem
+00022520: 656e 7461 7469 6f6e 206f 6620 7275 6e5f  entation of run_
+00022530: 6f6e 655f 7465 7374 2829 2066 6f72 2064  one_test() for d
+00022540: 6574 6169 6c73 2e0a 5f54 4541 5244 4f57  etails.._TEARDOW
+00022550: 4e5f 5345 5256 4943 4520 3d20 280a 2020  N_SERVICE = (.  
+00022560: 2020 2728 666f 7220 6920 696e 2060 7365    '(for i in `se
+00022570: 7120 3120 3230 603b 2064 6f27 0a20 2020  q 1 20`; do'.   
+00022580: 2027 2020 2020 2073 3d24 2873 6b79 2073   '     s=$(sky s
+00022590: 6572 7665 2064 6f77 6e20 2d79 207b 6e61  erve down -y {na
+000225a0: 6d65 7d29 3b27 0a20 2020 2027 2020 2020  me});'.    '    
+000225b0: 2065 6368 6f20 2254 7279 696e 6720 746f   echo "Trying to
+000225c0: 2074 6572 6d69 6e61 7465 207b 6e61 6d65   terminate {name
+000225d0: 7d22 3b27 0a20 2020 2027 2020 2020 2065  }";'.    '     e
+000225e0: 6368 6f20 2224 7322 3b27 0a20 2020 2027  cho "$s";'.    '
+000225f0: 2020 2020 2065 6368 6f20 2224 7322 207c       echo "$s" |
+00022600: 2067 7265 7020 2d71 2022 7363 6865 6475   grep -q "schedu
+00022610: 6c65 6420 746f 2062 6520 7465 726d 696e  led to be termin
+00022620: 6174 6564 5c7c 4e6f 2073 6572 7669 6365  ated\|No service
+00022630: 2074 6f20 7465 726d 696e 6174 6522 2026   to terminate" &
+00022640: 2620 6272 6561 6b3b 270a 2020 2020 2720  & break;'.    ' 
+00022650: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
+00022660: 2020 2027 2020 2020 205b 2024 6920 2d65     '     [ $i -e
+00022670: 7120 3230 205d 2026 2620 6563 686f 2022  q 20 ] && echo "
+00022680: 4661 696c 6564 2074 6f20 7465 726d 696e  Failed to termin
+00022690: 6174 6520 7365 7276 6963 6520 7b6e 616d  ate service {nam
+000226a0: 657d 223b 270a 2020 2020 2764 6f6e 6529  e}";'.    'done)
+000226b0: 2729 0a0a 5f53 4552 5645 5f45 4e44 504f  ').._SERVE_ENDPO
+000226c0: 494e 545f 5741 4954 203d 2028 0a20 2020  INT_WAIT = (.   
+000226d0: 2027 6578 706f 7274 204f 5249 4749 4e5f   'export ORIGIN_
+000226e0: 534b 5950 494c 4f54 5f44 4542 5547 3d24  SKYPILOT_DEBUG=$
+000226f0: 534b 5950 494c 4f54 5f44 4542 5547 3b20  SKYPILOT_DEBUG; 
+00022700: 6578 706f 7274 2053 4b59 5049 4c4f 545f  export SKYPILOT_
+00022710: 4445 4255 473d 303b 2027 0a20 2020 2027  DEBUG=0; '.    '
+00022720: 656e 6470 6f69 6e74 3d24 2873 6b79 2073  endpoint=$(sky s
+00022730: 6572 7665 2073 7461 7475 7320 2d2d 656e  erve status --en
+00022740: 6470 6f69 6e74 207b 6e61 6d65 7d29 3b20  dpoint {name}); 
+00022750: 270a 2020 2020 2775 6e74 696c 2021 2065  '.    'until ! e
+00022760: 6368 6f20 2224 656e 6470 6f69 6e74 2220  cho "$endpoint" 
+00022770: 7c20 6772 6570 2022 436f 6e74 726f 6c6c  | grep "Controll
+00022780: 6572 2069 7320 696e 6974 6961 6c69 7a69  er is initializi
+00022790: 6e67 223b 2027 0a20 2020 2027 646f 2065  ng"; '.    'do e
+000227a0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+000227b0: 2073 6572 7665 2065 6e64 706f 696e 7420   serve endpoint 
+000227c0: 746f 2062 6520 7265 6164 792e 2e2e 223b  to be ready...";
+000227d0: 2027 0a20 2020 2027 736c 6565 7020 353b   '.    'sleep 5;
+000227e0: 2065 6e64 706f 696e 743d 2428 736b 7920   endpoint=$(sky 
+000227f0: 7365 7276 6520 7374 6174 7573 202d 2d65  serve status --e
+00022800: 6e64 706f 696e 7420 7b6e 616d 657d 293b  ndpoint {name});
+00022810: 2064 6f6e 653b 2027 0a20 2020 2027 6578   done; '.    'ex
+00022820: 706f 7274 2053 4b59 5049 4c4f 545f 4445  port SKYPILOT_DE
+00022830: 4255 473d 244f 5249 4749 4e5f 534b 5950  BUG=$ORIGIN_SKYP
+00022840: 494c 4f54 5f44 4542 5547 3b20 6563 686f  ILOT_DEBUG; echo
+00022850: 2022 2465 6e64 706f 696e 7422 2729 0a0a   "$endpoint"')..
+00022860: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+00022870: 4954 203d 2028 2773 3d24 2873 6b79 2073  IT = ('s=$(sky s
+00022880: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00022890: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
+000228a0: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+000228b0: 7469 6c20 2120 6563 686f 2022 2473 2220  til ! echo "$s" 
+000228c0: 7c20 6772 6570 2022 436f 6e74 726f 6c6c  | grep "Controll
+000228d0: 6572 2069 7320 696e 6974 6961 6c69 7a69  er is initializi
+000228e0: 6e67 2e22 3b20 270a 2020 2020 2020 2020  ng."; '.        
+000228f0: 2020 2020 2020 2020 2020 2020 2020 2764                'd
+00022900: 6f20 6563 686f 2022 5761 6974 696e 6720  o echo "Waiting 
+00022910: 666f 7220 7365 7276 6520 7374 6174 7573  for serve status
+00022920: 2074 6f20 6265 2072 6561 6479 2e2e 2e22   to be ready..."
+00022930: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00022940: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00022950: 2035 3b20 733d 2428 736b 7920 7365 7276   5; s=$(sky serv
+00022960: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00022970: 3b20 646f 6e65 3b20 6563 686f 2022 2473  ; done; echo "$s
+00022980: 2227 290a 0a0a 6465 6620 5f67 6574 5f72  "')...def _get_r
+00022990: 6570 6c69 6361 5f69 7028 6e61 6d65 3a20  eplica_ip(name: 
+000229a0: 7374 722c 2072 6570 6c69 6361 5f69 643a  str, replica_id:
+000229b0: 2069 6e74 2920 2d3e 2073 7472 3a0a 2020   int) -> str:.  
+000229c0: 2020 7265 7475 726e 2028 6627 6970 7b72    return (f'ip{r
+000229d0: 6570 6c69 6361 5f69 647d 3d24 2865 6368  eplica_id}=$(ech
+000229e0: 6f20 2224 7322 207c 2027 0a20 2020 2020  o "$s" | '.     
+000229f0: 2020 2020 2020 2066 2761 776b 2022 7b5f         f'awk "{_
+00022a00: 4157 4b5f 414c 4c5f 4c49 4e45 535f 4245  AWK_ALL_LINES_BE
+00022a10: 4c4f 575f 5245 504c 4943 4153 7d22 207c  LOW_REPLICAS}" |
+00022a20: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00022a30: 2767 7265 7020 2d45 2022 7b6e 616d 657d  'grep -E "{name}
+00022a40: 5c73 2b7b 7265 706c 6963 615f 6964 7d22  \s+{replica_id}"
+00022a50: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+00022a60: 2066 2767 7265 7020 2d45 6f20 227b 5f49   f'grep -Eo "{_I
+00022a70: 505f 5245 4745 587d 2229 2729 0a0a 0a64  P_REGEX}")')...d
+00022a80: 6566 205f 6765 745f 736b 7973 6572 7665  ef _get_skyserve
+00022a90: 5f68 7474 705f 7465 7374 286e 616d 653a  _http_test(name:
+00022aa0: 2073 7472 2c20 636c 6f75 643a 2073 7472   str, cloud: str
+00022ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00022ad0: 6d65 6f75 745f 6d69 6e75 7465 733a 2069  meout_minutes: i
+00022ae0: 6e74 2920 2d3e 2054 6573 743a 0a20 2020  nt) -> Test:.   
+00022af0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00022b00: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+00022b10: 7365 7276 652d 7b63 6c6f 7564 2e72 6570  serve-{cloud.rep
+00022b20: 6c61 6365 2822 5f22 2c20 222d 2229 7d27  lace("_", "-")}'
+00022b30: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00022b40: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00022b50: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00022b60: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00022b70: 7665 2f68 7474 702f 7b63 6c6f 7564 7d2e  ve/http/{cloud}.
+00022b80: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00022b90: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00022ba0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00022bb0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00022bc0: 6c69 6361 5f6e 756d 3d32 292c 0a20 2020  lica_num=2),.   
+00022bd0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00022be0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00022bf0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022c00: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+00022c10: 2020 2027 6375 726c 2068 7474 703a 2f2f     'curl http://
+00022c20: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00022c30: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00022c40: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00022c50: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00022c60: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00022c70: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00022c80: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
+00022c90: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00022ca0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00022cb0: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
+00022cc0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00022cd0: 696e 5f73 7461 7475 7328 6e61 6d65 3a20  in_status(name: 
+00022ce0: 7374 722c 2063 6865 636b 5f74 7570 6c65  str, check_tuple
+00022cf0: 733a 204c 6973 745b 5475 706c 655b 696e  s: List[Tuple[in
+00022d00: 742c 2062 6f6f 6c2c 0a20 2020 2020 2020  t, bool,.       
+00022d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d40: 2020 2020 2020 2020 2020 7374 725d 5d29            str]])
+00022d50: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+00022d60: 4368 6563 6b20 7265 706c 6963 6173 2720  Check replicas' 
+00022d70: 7374 6174 7573 2061 6e64 2063 6f75 6e74  status and count
+00022d80: 2069 6e20 736b 7920 7365 7276 6520 7374   in sky serve st
+00022d90: 6174 7573 0a0a 2020 2020 5765 2077 696c  atus..    We wil
+00022da0: 6c20 6368 6563 6b20 7643 5055 3d32 2c20  l check vCPU=2, 
+00022db0: 6173 2061 6c6c 206f 7572 2074 6573 7473  as all our tests
+00022dc0: 2075 7365 2076 4350 553d 322e 0a20 2020   use vCPU=2..   
+00022dd0: 200a 2020 2020 4172 6773 3a0a 2020 2020   .    Args:.    
+00022de0: 2020 2020 6e61 6d65 3a20 7468 6520 6e61      name: the na
+00022df0: 6d65 206f 6620 7468 6520 7365 7276 6963  me of the servic
+00022e00: 650a 2020 2020 2020 2020 6368 6563 6b5f  e.        check_
+00022e10: 7475 706c 6573 3a20 4120 6c69 7374 206f  tuples: A list o
+00022e20: 6620 7265 706c 6963 6120 7072 6f70 6572  f replica proper
+00022e30: 7479 2074 6f20 6368 6563 6b2e 2045 6163  ty to check. Eac
+00022e40: 6820 7475 706c 6520 6973 0a20 2020 2020  h tuple is.     
+00022e50: 2020 2020 2020 2028 636f 756e 742c 2069         (count, i
+00022e60: 735f 7370 6f74 2c20 7374 6174 7573 290a  s_spot, status).
+00022e70: 2020 2020 2222 220a 2020 2020 6368 6563      """.    chec
+00022e80: 6b5f 636d 6420 3d20 2727 0a20 2020 2066  k_cmd = ''.    f
+00022e90: 6f72 2063 6865 636b 5f74 7570 6c65 2069  or check_tuple i
+00022ea0: 6e20 6368 6563 6b5f 7475 706c 6573 3a0a  n check_tuples:.
+00022eb0: 2020 2020 2020 2020 636f 756e 742c 2069          count, i
+00022ec0: 735f 7370 6f74 2c20 7374 6174 7573 203d  s_spot, status =
+00022ed0: 2063 6865 636b 5f74 7570 6c65 0a20 2020   check_tuple.   
+00022ee0: 2020 2020 2072 6573 6f75 7263 655f 7374       resource_st
+00022ef0: 7220 3d20 2727 0a20 2020 2020 2020 2069  r = ''.        i
+00022f00: 6620 7374 6174 7573 206e 6f74 2069 6e20  f status not in 
+00022f10: 5b27 5045 4e44 494e 4727 2c20 2753 4855  ['PENDING', 'SHU
+00022f20: 5454 494e 475f 444f 574e 270a 2020 2020  TTING_DOWN'.    
+00022f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f40: 2020 2020 205d 2061 6e64 206e 6f74 2073       ] and not s
+00022f50: 7461 7475 732e 7374 6172 7473 7769 7468  tatus.startswith
+00022f60: 2827 4641 494c 4544 2729 3a0a 2020 2020  ('FAILED'):.    
+00022f70: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
+00022f80: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
+00022f90: 2020 6966 2069 735f 7370 6f74 3a0a 2020    if is_spot:.  
+00022fa0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00022fb0: 6f74 5f73 7472 203d 2027 5c5b 5370 6f74  ot_str = '\[Spot
+00022fc0: 5c5d 270a 2020 2020 2020 2020 2020 2020  \]'.            
+00022fd0: 7265 736f 7572 6365 5f73 7472 203d 2066  resource_str = f
+00022fe0: 2728 7b73 706f 745f 7374 727d 7643 5055  '({spot_str}vCPU
+00022ff0: 3d32 2927 0a20 2020 2020 2020 2063 6865  =2)'.        che
+00023000: 636b 5f63 6d64 202b 3d20 2866 2720 6563  ck_cmd += (f' ec
+00023010: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
+00023020: 7b72 6573 6f75 7263 655f 7374 727d 2220  {resource_str}" 
+00023030: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00023040: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+00023050: 2022 7b73 7461 7475 737d 2220 7c20 7763   "{status}" | wc
+00023060: 202d 6c20 7c20 6772 6570 207b 636f 756e   -l | grep {coun
+00023070: 747d 207c 7c20 6578 6974 2031 3b27 290a  t} || exit 1;').
+00023080: 2020 2020 7265 7475 726e 2028 6627 7b5f      return (f'{_
+00023090: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+000230a0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+000230b0: 6d65 297d 3b20 6563 686f 2022 2473 223b  me)}; echo "$s";
+000230c0: 2027 202b 2063 6865 636b 5f63 6d64 290a   ' + check_cmd).
+000230d0: 0a0a 6465 6620 5f63 6865 636b 5f73 6572  ..def _check_ser
+000230e0: 7669 6365 5f76 6572 7369 6f6e 2873 6572  vice_version(ser
+000230f0: 7669 6365 5f6e 616d 653a 2073 7472 2c20  vice_name: str, 
+00023100: 7665 7273 696f 6e3a 2073 7472 2920 2d3e  version: str) ->
+00023110: 2073 7472 3a0a 2020 2020 2320 4772 6570   str:.    # Grep
+00023120: 2074 6865 206c 696e 6573 2062 6566 6f72   the lines befor
+00023130: 6520 2753 6572 7669 6365 2052 6570 6c69  e 'Service Repli
+00023140: 6361 7327 2061 6e64 2063 6865 636b 2069  cas' and check i
+00023150: 6620 7468 6520 7365 7276 6963 6520 7665  f the service ve
+00023160: 7273 696f 6e0a 2020 2020 2320 6973 2063  rsion.    # is c
+00023170: 6f72 7265 6374 2e0a 2020 2020 7265 7475  orrect..    retu
+00023180: 726e 2028 6627 6563 686f 2022 2473 2220  rn (f'echo "$s" 
+00023190: 7c20 6772 6570 202d 4231 3030 3020 2253  | grep -B1000 "S
+000231a0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+000231b0: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+000231c0: 2066 2767 7265 7020 2d45 2022 7b73 6572   f'grep -E "{ser
+000231d0: 7669 6365 5f6e 616d 657d 5c73 2b7b 7665  vice_name}\s+{ve
+000231e0: 7273 696f 6e7d 2220 7c7c 2065 7869 7420  rsion}" || exit 
+000231f0: 313b 2027 290a 0a0a 4070 7974 6573 742e  1; ')...@pytest.
+00023200: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00023210: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00023220: 7465 7374 5f73 6b79 7365 7276 655f 6763  test_skyserve_gc
+00023230: 705f 6874 7470 2829 3a0a 2020 2020 2222  p_http():.    ""
+00023240: 2254 6573 7420 736b 7973 6572 7665 206f  "Test skyserve o
+00023250: 6e20 4743 5022 2222 0a20 2020 206e 616d  n GCP""".    nam
+00023260: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00023270: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00023280: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+00023290: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+000232a0: 2027 6763 7027 2c20 3230 290a 2020 2020   'gcp', 20).    
+000232b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000232c0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000232d0: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+000232e0: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+000232f0: 745f 736b 7973 6572 7665 5f61 7773 5f68  t_skyserve_aws_h
+00023300: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+00023310: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
+00023320: 5753 2222 220a 2020 2020 6e61 6d65 203d  WS""".    name =
+00023330: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00023340: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00023350: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
+00023360: 7470 5f74 6573 7428 6e61 6d65 2c20 2761  tp_test(name, 'a
+00023370: 7773 272c 2032 3029 0a20 2020 2072 756e  ws', 20).    run
+00023380: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00023390: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+000233a0: 7a75 7265 0a40 7079 7465 7374 2e6d 6172  zure.@pytest.mar
+000233b0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+000233c0: 5f73 6b79 7365 7276 655f 617a 7572 655f  _skyserve_azure_
+000233d0: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
+000233e0: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
+000233f0: 417a 7572 6522 2222 0a20 2020 206e 616d  Azure""".    nam
+00023400: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00023410: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00023420: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+00023430: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+00023440: 2027 617a 7572 6527 2c20 3330 290a 2020   'azure', 30).  
+00023450: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00023460: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00023470: 6172 6b2e 6b75 6265 726e 6574 6573 0a40  ark.kubernetes.@
+00023480: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00023490: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
+000234a0: 7276 655f 6b75 6265 726e 6574 6573 5f68  rve_kubernetes_h
+000234b0: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+000234c0: 7374 2073 6b79 7365 7276 6520 6f6e 204b  st skyserve on K
+000234d0: 7562 6572 6e65 7465 7322 2222 0a20 2020  ubernetes""".   
+000234e0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+000234f0: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
+00023500: 7465 7374 203d 205f 6765 745f 736b 7973  test = _get_skys
+00023510: 6572 7665 5f68 7474 705f 7465 7374 286e  erve_http_test(n
+00023520: 616d 652c 2027 6b75 6265 726e 6574 6573  ame, 'kubernetes
+00023530: 272c 2033 3029 0a20 2020 2072 756e 5f6f  ', 30).    run_o
+00023540: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00023550: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+00023560: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+00023570: 6572 7665 5f6c 6c6d 2867 656e 6572 6963  erve_llm(generic
+00023580: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00023590: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+000235a0: 7665 2077 6974 6820 7265 616c 204c 4c4d  ve with real LLM
+000235b0: 2075 7365 6361 7365 2222 220a 2020 2020   usecase""".    
+000235c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+000235d0: 6963 655f 6e61 6d65 2829 0a0a 2020 2020  ice_name()..    
+000235e0: 6465 6620 6765 6e65 7261 7465 5f6c 6c6d  def generate_llm
+000235f0: 5f74 6573 745f 636f 6d6d 616e 6428 7072  _test_command(pr
+00023600: 6f6d 7074 3a20 7374 722c 2065 7870 6563  ompt: str, expec
+00023610: 7465 645f 6f75 7470 7574 3a20 7374 7229  ted_output: str)
+00023620: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00023630: 2070 726f 6d70 7420 3d20 7368 6c65 782e   prompt = shlex.
+00023640: 7175 6f74 6528 7072 6f6d 7074 290a 2020  quote(prompt).  
+00023650: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
+00023660: 7574 7075 7420 3d20 7368 6c65 782e 7175  utput = shlex.qu
+00023670: 6f74 6528 6578 7065 6374 6564 5f6f 7574  ote(expected_out
+00023680: 7075 7429 0a20 2020 2020 2020 2072 6574  put).        ret
+00023690: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+000236a0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+000236b0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+000236c0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+000236d0: 2020 2020 2020 2020 2020 2020 2770 7974              'pyt
+000236e0: 686f 6e20 7465 7374 732f 736b 7973 6572  hon tests/skyser
+000236f0: 7665 2f6c 6c6d 2f67 6574 5f72 6573 706f  ve/llm/get_respo
+00023700: 6e73 652e 7079 202d 2d65 6e64 706f 696e  nse.py --endpoin
+00023710: 7420 2465 6e64 706f 696e 7420 270a 2020  t $endpoint '.  
+00023720: 2020 2020 2020 2020 2020 6627 2d2d 7072            f'--pr
+00023730: 6f6d 7074 207b 7072 6f6d 7074 7d20 7c20  ompt {prompt} | 
+00023740: 6772 6570 207b 6578 7065 6374 6564 5f6f  grep {expected_o
+00023750: 7574 7075 747d 2729 0a0a 2020 2020 7769  utput}')..    wi
+00023760: 7468 206f 7065 6e28 2774 6573 7473 2f73  th open('tests/s
+00023770: 6b79 7365 7276 652f 6c6c 6d2f 7072 6f6d  kyserve/llm/prom
+00023780: 7074 5f6f 7574 7075 742e 6a73 6f6e 272c  pt_output.json',
+00023790: 2027 7227 2c0a 2020 2020 2020 2020 2020   'r',.          
+000237a0: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
+000237b0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+000237c0: 2020 2020 7072 6f6d 7074 326f 7574 7075      prompt2outpu
+000237d0: 7420 3d20 6a73 6f6e 2e6c 6f61 6428 6629  t = json.load(f)
+000237e0: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
+000237f0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+00023800: 742d 736b 7973 6572 7665 2d6c 6c6d 272c  t-skyserve-llm',
+00023810: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00023820: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00023830: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00023840: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00023850: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00023860: 2f73 6b79 7365 7276 652f 6c6c 6d2f 7365  /skyserve/llm/se
+00023870: 7276 6963 652e 7961 6d6c 272c 0a20 2020  rvice.yaml',.   
+00023880: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00023890: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+000238a0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000238b0: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+000238c0: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+000238d0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000238e0: 2020 6765 6e65 7261 7465 5f6c 6c6d 5f74    generate_llm_t
+000238f0: 6573 745f 636f 6d6d 616e 6428 7072 6f6d  est_command(prom
+00023900: 7074 2c20 6f75 7470 7574 290a 2020 2020  pt, output).    
+00023910: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023920: 7072 6f6d 7074 2c20 6f75 7470 7574 2069  prompt, output i
+00023930: 6e20 7072 6f6d 7074 326f 7574 7075 742e  n prompt2output.
+00023940: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+00023950: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+00023960: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00023970: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00023980: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00023990: 2020 2020 2020 2074 696d 656f 7574 3d34         timeout=4
+000239a0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+000239b0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000239c0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000239d0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+000239e0: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
+000239f0: 6573 745f 736b 7973 6572 7665 5f73 706f  est_skyserve_spo
+00023a00: 745f 7265 636f 7665 7279 2829 3a0a 2020  t_recovery():.  
+00023a10: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+00023a20: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+00023a30: 207a 6f6e 6520 3d20 2775 732d 6365 6e74   zone = 'us-cent
+00023a40: 7261 6c31 2d61 270a 0a20 2020 2074 6573  ral1-a'..    tes
+00023a50: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00023a60: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
+00023a70: 652d 7370 6f74 2d72 6563 6f76 6572 792d  e-spot-recovery-
+00023a80: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
+00023a90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00023aa0: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+00023ab0: 616d 657d 202d 7920 7465 7374 732f 736b  ame} -y tests/sk
+00023ac0: 7973 6572 7665 2f73 706f 742f 7265 636f  yserve/spot/reco
+00023ad0: 7665 7279 2e79 616d 6c27 2c0a 2020 2020  very.yaml',.    
+00023ae0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00023af0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00023b00: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00023b10: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+00023b20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00023b30: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00023b40: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00023b50: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00023b60: 2020 2020 2020 2020 2772 6571 7565 7374          'request
+00023b70: 5f6f 7574 7075 743d 2428 6375 726c 2068  _output=$(curl h
+00023b80: 7474 703a 2f2f 2465 6e64 706f 696e 7429  ttp://$endpoint)
+00023b90: 3b20 6563 686f 2022 2472 6571 7565 7374  ; echo "$request
+00023ba0: 5f6f 7574 7075 7422 3b20 6563 686f 2022  _output"; echo "
+00023bb0: 2472 6571 7565 7374 5f6f 7574 7075 7422  $request_output"
+00023bc0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+00023bd0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+00023be0: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
+00023bf0: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
+00023c00: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
+00023c10: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00023c20: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00023c30: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00023c40: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00023c50: 756d 3d31 292c 0a20 2020 2020 2020 2020  um=1),.         
+00023c60: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+00023c70: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+00023c80: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+00023c90: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
+00023ca0: 7175 6573 745f 6f75 7470 7574 3d24 2863  quest_output=$(c
+00023cb0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00023cc0: 6f69 6e74 293b 2065 6368 6f20 2224 7265  oint); echo "$re
+00023cd0: 7175 6573 745f 6f75 7470 7574 223b 2065  quest_output"; e
+00023ce0: 6368 6f20 2224 7265 7175 6573 745f 6f75  cho "$request_ou
+00023cf0: 7470 7574 2220 7c20 6772 6570 2022 4869  tput" | grep "Hi
+00023d00: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00023d10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00023d20: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00023d30: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00023d40: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00023d50: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00023d60: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00023d70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00023d80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00023d90: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+00023da0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00023db0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00023dc0: 7665 5f62 6173 655f 6f6e 6465 6d61 6e64  ve_base_ondemand
+00023dd0: 5f66 616c 6c62 6163 6b28 6765 6e65 7269  _fallback(generi
+00023de0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00023df0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00023e00: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00023e10: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00023e20: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00023e30: 7973 6572 7665 2d62 6173 652d 6f6e 6465  yserve-base-onde
+00023e40: 6d61 6e64 2d66 616c 6c62 6163 6b27 2c0a  mand-fallback',.
+00023e50: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00023e60: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00023e70: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00023e80: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00023e90: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00023ea0: 736b 7973 6572 7665 2f73 706f 742f 6261  skyserve/spot/ba
+00023eb0: 7365 5f6f 6e64 656d 616e 645f 6661 6c6c  se_ondemand_fall
+00023ec0: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
+00023ed0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00023ee0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00023ef0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00023f00: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00023f10: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00023f20: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00023f30: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
+00023f40: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
+00023f50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00023f80: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
+00023f90: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
+00023fa0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00023fb0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00023fc0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00023fd0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00023fe0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00023ff0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00024000: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00024010: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00024020: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00024030: 745f 736b 7973 6572 7665 5f64 796e 616d  t_skyserve_dynam
+00024040: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
+00024050: 6261 636b 2829 3a0a 2020 2020 6e61 6d65  back():.    name
+00024060: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00024070: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+00024080: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
+00024090: 270a 0a20 2020 2074 6573 7420 3d20 5465  '..    test = Te
+000240a0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000240b0: 7374 2d73 6b79 7365 7276 652d 6479 6e61  st-skyserve-dyna
+000240c0: 6d69 632d 6f6e 6465 6d61 6e64 2d66 616c  mic-ondemand-fal
+000240d0: 6c62 6163 6b27 2c0a 2020 2020 2020 2020  lback',.        
+000240e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000240f0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00024100: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00024110: 6370 202d 7920 7465 7374 732f 736b 7973  cp -y tests/skys
+00024120: 6572 7665 2f73 706f 742f 6479 6e61 6d69  erve/spot/dynami
+00024130: 635f 6f6e 6465 6d61 6e64 5f66 616c 6c62  c_ondemand_fallb
+00024140: 6163 6b2e 7961 6d6c 272c 0a20 2020 2020  ack.yaml',.     
+00024150: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
+00024160: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00024170: 2320 3220 6f6e 2d64 656d 616e 6420 2870  # 2 on-demand (p
+00024180: 726f 7669 7369 6f6e 696e 6729 202b 2032  rovisioning) + 2
+00024190: 2053 706f 7420 2870 726f 7669 7369 6f6e   Spot (provision
+000241a0: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
+000241b0: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
+000241c0: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
+000241d0: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
+000241e0: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
+000241f0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
+00024200: 2067 7265 7020 2d71 2022 302f 3422 207c   grep -q "0/4" |
+00024210: 7c20 6578 6974 2031 272c 0a20 2020 2020  | exit 1',.     
+00024220: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+00024230: 7220 7468 6520 7072 6f76 6973 696f 6e69  r the provisioni
+00024240: 6e67 2073 7461 7274 730a 2020 2020 2020  ng starts.      
+00024250: 2020 2020 2020 6627 736c 6565 7020 3430        f'sleep 40
+00024260: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00024270: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00024280: 5f73 7461 7475 7328 6e61 6d65 2c20 5b0a  _status(name, [.
+00024290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242a0: 2832 2c20 5472 7565 2c20 5f53 4552 5649  (2, True, _SERVI
+000242b0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+000242c0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
+000242d0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000242e0: 2020 2020 2020 2020 2832 2c20 4661 6c73          (2, Fals
+000242f0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00024300: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00024310: 4558 202b 2027 5c7c 5348 5554 5449 4e47  EX + '\|SHUTTING
+00024320: 5f44 4f57 4e27 290a 2020 2020 2020 2020  _DOWN').        
+00024330: 2020 2020 5d29 2c0a 0a20 2020 2020 2020      ]),..       
+00024340: 2020 2020 2023 2057 6169 7420 756e 7469       # Wait unti
+00024350: 6c20 3220 7370 6f74 2069 6e73 7461 6e63  l 2 spot instanc
+00024360: 6573 2061 7265 2072 6561 6479 2e0a 2020  es are ready..  
+00024370: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00024380: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00024390: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+000243a0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+000243b0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
+000243c0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+000243d0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+000243e0: 2832 2c20 5472 7565 2c20 2752 4541 4459  (2, True, 'READY
+000243f0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00024400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024420: 2830 2c20 4661 6c73 652c 2027 2729 5d29  (0, False, '')])
+00024430: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
+00024440: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
+00024450: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
+00024460: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00024470: 2066 2773 6c65 6570 2034 3027 2c0a 2020   f'sleep 40',.  
+00024480: 2020 2020 2020 2020 2020 2320 3120 6f6e            # 1 on
+00024490: 2d64 656d 616e 6420 2870 726f 7669 7369  -demand (provisi
+000244a0: 6f6e 696e 6729 202b 2031 2053 706f 7420  oning) + 1 Spot 
+000244b0: 2872 6561 6479 2920 2b20 3120 7370 6f74  (ready) + 1 spot
+000244c0: 2028 7072 6f76 6973 696f 6e69 6e67 292e   (provisioning).
+000244d0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000244e0: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+000244f0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00024500: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00024510: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
+00024520: 7c20 6772 6570 202d 7120 2231 2f33 2227  | grep -q "1/3"'
+00024530: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00024540: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00024550: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+00024560: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
+00024570: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
+00024580: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00024590: 2020 2020 2020 2020 2020 2831 2c20 5472            (1, Tr
+000245a0: 7565 2c20 5f53 4552 5649 4345 5f4c 4155  ue, _SERVICE_LAU
+000245b0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+000245c0: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
+000245d0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+000245e0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+000245f0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00024600: 535f 5245 4745 5829 5d29 2c0a 0a20 2020  S_REGEX)]),..   
+00024610: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+00024620: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
+00024630: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
+00024640: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
+00024650: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+00024660: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+00024670: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+00024680: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
+00024690: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+000246a0: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+000246b0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
+000246c0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000246d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246f0: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
+00024700: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
+00024710: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00024720: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00024730: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00024740: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00024750: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00024760: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00024770: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00024780: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00024790: 745f 736b 7973 6572 7665 5f75 7365 725f  t_skyserve_user_
+000247a0: 6275 675f 7265 7374 6172 7428 6765 6e65  bug_restart(gene
+000247b0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+000247c0: 0a20 2020 2022 2222 5465 7374 7320 7468  .    """Tests th
+000247d0: 6174 2077 6520 7265 7374 6172 7420 7468  at we restart th
+000247e0: 6520 7365 7276 6963 6520 6166 7465 7220  e service after 
+000247f0: 7573 6572 2062 7567 2e22 2222 0a20 2020  user bug.""".   
+00024800: 2023 2054 4f44 4f28 7a68 7775 293a 2074   # TODO(zhwu): t
+00024810: 6869 7320 6265 6861 7669 6f72 206e 6565  his behavior nee
+00024820: 6473 2073 6f6d 6520 7265 7468 696e 6b69  ds some rethinki
+00024830: 6e67 2e0a 2020 2020 6e61 6d65 203d 205f  ng..    name = _
+00024840: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
+00024850: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00024860: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00024870: 7374 2d73 6b79 7365 7276 652d 7573 6572  st-skyserve-user
+00024880: 2d62 7567 2d72 6573 7461 7274 272c 0a20  -bug-restart',. 
+00024890: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000248a0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+000248b0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+000248c0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+000248d0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+000248e0: 6b79 7365 7276 652f 7265 7374 6172 742f  kyserve/restart/
+000248f0: 7573 6572 5f62 7567 2e79 616d 6c27 2c0a  user_bug.yaml',.
 00024900: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
 00024910: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
 00024920: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
 00024930: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
 00024940: 2020 2020 2775 6e74 696c 2065 6368 6f20      'until echo 
 00024950: 2224 7322 207c 2067 7265 7020 2d41 2031  "$s" | grep -A 1
 00024960: 3030 2022 5365 7276 6963 6520 5265 706c  00 "Service Repl
-00024970: 6963 6173 2220 7c20 6772 6570 2022 4641  icas" | grep "FA
-00024980: 494c 4544 223b 2027 0a20 2020 2020 2020  ILED"; '.       
-00024990: 2020 2020 2027 646f 2065 6368 6f20 2257       'do echo "W
-000249a0: 6169 7469 6e67 2066 6f72 2066 6972 7374  aiting for first
-000249b0: 2073 6572 7669 6365 2074 6f20 6265 2046   service to be F
-000249c0: 4149 4c45 442e 2e2e 223b 2027 0a20 2020  AILED..."; '.   
-000249d0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-000249e0: 2035 3b20 733d 2428 736b 7920 7365 7276   5; s=$(sky serv
-000249f0: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
-00024a00: 3b20 6563 686f 2022 2473 223b 2064 6f6e  ; echo "$s"; don
-00024a10: 653b 2065 6368 6f20 2224 7322 3b20 270a  e; echo "$s"; '.
-00024a20: 2020 2020 2020 2020 2020 2020 2b20 5f63              + _c
-00024a30: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00024a40: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
-00024a50: 2c20 5472 7565 2c20 2746 4149 4c45 4427  , True, 'FAILED'
-00024a60: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
-00024a70: 2020 2320 5573 6572 2062 7567 2066 6169    # User bug fai
-00024a80: 6c75 7265 2077 696c 6c20 6361 7573 6520  lure will cause 
-00024a90: 6e6f 2066 7572 7468 6572 2073 6361 6c69  no further scali
-00024aa0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-00024ab0: 6627 6563 686f 2022 2473 2220 7c20 6772  f'echo "$s" | gr
-00024ac0: 6570 202d 4120 3130 3020 2253 6572 7669  ep -A 100 "Servi
-00024ad0: 6365 2052 6570 6c69 6361 7322 207c 2067  ce Replicas" | g
-00024ae0: 7265 7020 227b 6e61 6d65 7d22 207c 2077  rep "{name}" | w
-00024af0: 6320 2d6c 207c 2067 7265 7020 313b 2027  c -l | grep 1; '
-00024b00: 0a20 2020 2020 2020 2020 2020 2066 2765  .            f'e
-00024b10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00024b20: 2d42 2031 3030 2022 4e4f 5f52 4550 4c49  -B 100 "NO_REPLI
-00024b30: 4341 2220 7c20 6772 6570 2022 302f 3022  CA" | grep "0/0"
-00024b40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00024b50: 2773 6b79 2073 6572 7665 2075 7064 6174  'sky serve updat
-00024b60: 6520 7b6e 616d 657d 202d 2d63 6c6f 7564  e {name} --cloud
-00024b70: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00024b80: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00024b90: 7665 2f61 7574 6f5f 7265 7374 6172 742e  ve/auto_restart.
-00024ba0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00024bb0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
-00024bc0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
-00024bd0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
-00024be0: 0a20 2020 2020 2020 2020 2020 2027 756e  .            'un
-00024bf0: 7469 6c20 6375 726c 2068 7474 703a 2f2f  til curl http://
-00024c00: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00024c10: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00024c20: 6572 6521 223b 2064 6f20 736c 6565 7020  ere!"; do sleep 
-00024c30: 323b 2064 6f6e 653b 2073 6c65 6570 2032  2; done; sleep 2
-00024c40: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00024c50: 2b20 5f63 6865 636b 5f72 6570 6c69 6361  + _check_replica
-00024c60: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
-00024c70: 205b 2831 2c20 4661 6c73 652c 2027 5245   [(1, False, 'RE
-00024c80: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
-00024c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024cb0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
-00024cc0: 2746 4149 4c45 4427 295d 292c 0a20 2020  'FAILED')]),.   
-00024cd0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00024ce0: 5f54 4541 5244 4f57 4e5f 5345 5256 4943  _TEARDOWN_SERVIC
-00024cf0: 452e 666f 726d 6174 286e 616d 653d 6e61  E.format(name=na
-00024d00: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-00024d10: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-00024d20: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00024d30: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00024d40: 7465 7374 2e6d 6172 6b2e 7365 7276 650a  test.mark.serve.
-00024d50: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00024d60: 6b75 6265 726e 6574 6573 2020 2320 5265  kubernetes  # Re
-00024d70: 706c 6963 6173 206f 6e20 6b38 7320 6d61  plicas on k8s ma
-00024d80: 7920 6265 2072 756e 6e69 6e67 206f 6e20  y be running on 
-00024d90: 7468 6520 7361 6d65 206e 6f64 6520 616e  the same node an
-00024da0: 6420 6861 7665 2074 6865 2073 616d 6520  d have the same 
-00024db0: 7075 626c 6963 2049 500a 6465 6620 7465  public IP.def te
-00024dc0: 7374 5f73 6b79 7365 7276 655f 6c6f 6164  st_skyserve_load
-00024dd0: 5f62 616c 616e 6365 7228 6765 6e65 7269  _balancer(generi
-00024de0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00024df0: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-00024e00: 7276 6520 6c6f 6164 2062 616c 616e 6365  rve load balance
-00024e10: 7220 726f 756e 642d 726f 6269 6e20 706f  r round-robin po
-00024e20: 6c69 6379 2222 220a 2020 2020 6e61 6d65  licy""".    name
-00024e30: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-00024e40: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00024e50: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00024e60: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
-00024e70: 6c6f 6164 2d62 616c 616e 6365 7227 2c0a  load-balancer',.
-00024e80: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00024e90: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
-00024ea0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
-00024eb0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00024ec0: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
-00024ed0: 736b 7973 6572 7665 2f6c 6f61 645f 6261  skyserve/load_ba
-00024ee0: 6c61 6e63 6572 2f73 6572 7669 6365 2e79  lancer/service.y
-00024ef0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00024f00: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00024f10: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00024f20: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00024f30: 6963 615f 6e75 6d3d 3329 2c0a 2020 2020  ica_num=3),.    
-00024f40: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00024f50: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00024f60: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00024f70: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
-00024f80: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
-00024f90: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
-00024fa0: 616d 653d 6e61 6d65 297d 3b20 270a 2020  ame=name)}; '.  
-00024fb0: 2020 2020 2020 2020 2020 6627 7b5f 6765            f'{_ge
-00024fc0: 745f 7265 706c 6963 615f 6970 286e 616d  t_replica_ip(nam
-00024fd0: 652c 2031 297d 3b20 270a 2020 2020 2020  e, 1)}; '.      
-00024fe0: 2020 2020 2020 6627 7b5f 6765 745f 7265        f'{_get_re
-00024ff0: 706c 6963 615f 6970 286e 616d 652c 2032  plica_ip(name, 2
-00025000: 297d 3b20 7b5f 6765 745f 7265 706c 6963  )}; {_get_replic
-00025010: 615f 6970 286e 616d 652c 2033 297d 3b20  a_ip(name, 3)}; 
-00025020: 270a 2020 2020 2020 2020 2020 2020 2770  '.            'p
-00025030: 7974 686f 6e20 7465 7374 732f 736b 7973  ython tests/skys
-00025040: 6572 7665 2f6c 6f61 645f 6261 6c61 6e63  erve/load_balanc
-00025050: 6572 2f74 6573 745f 726f 756e 645f 726f  er/test_round_ro
-00025060: 6269 6e2e 7079 2027 0a20 2020 2020 2020  bin.py '.       
-00025070: 2020 2020 2027 2d2d 656e 6470 6f69 6e74       '--endpoint
-00025080: 2024 656e 6470 6f69 6e74 202d 2d72 6570   $endpoint --rep
-00025090: 6c69 6361 2d6e 756d 2033 202d 2d72 6570  lica-num 3 --rep
-000250a0: 6c69 6361 2d69 7073 2024 6970 3120 2469  lica-ips $ip1 $i
-000250b0: 7032 2024 6970 3327 2c0a 2020 2020 2020  p2 $ip3',.      
-000250c0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
-000250d0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
-000250e0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
-000250f0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00025100: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-00025110: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00025120: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00025130: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
-00025140: 7374 2e6d 6172 6b2e 7365 7276 650a 4070  st.mark.serve.@p
-00025150: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
-00025160: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
-00025170: 745f 736b 7973 6572 7665 5f61 7574 6f5f  t_skyserve_auto_
-00025180: 7265 7374 6172 7428 293a 0a20 2020 2022  restart():.    "
-00025190: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
-000251a0: 7769 7468 2061 7574 6f20 7265 7374 6172  with auto restar
-000251b0: 7422 2222 0a20 2020 206e 616d 6520 3d20  t""".    name = 
-000251c0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-000251d0: 6528 290a 2020 2020 7a6f 6e65 203d 2027  e().    zone = '
-000251e0: 7573 2d63 656e 7472 616c 312d 6127 0a20  us-central1-a'. 
-000251f0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00025200: 2020 2020 2020 2020 6627 7465 7374 2d73          f'test-s
-00025210: 6b79 7365 7276 652d 6175 746f 2d72 6573  kyserve-auto-res
-00025220: 7461 7274 272c 0a20 2020 2020 2020 205b  tart',.        [
-00025230: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00025240: 4f44 4f28 7469 616e 293a 2077 6520 6361  ODO(tian): we ca
-00025250: 6e20 6479 6e61 6d69 6361 6c6c 7920 6765  n dynamically ge
-00025260: 6e65 7261 7465 2059 414d 4c20 6672 6f6d  nerate YAML from
-00025270: 2074 656d 706c 6174 6520 746f 0a20 2020   template to.   
-00025280: 2020 2020 2020 2020 2023 2061 766f 6964           # avoid
-00025290: 206d 6169 6e74 6169 6e69 6e67 2074 6f6f   maintaining too
-000252a0: 206d 616e 7920 5941 4d4c 2066 696c 6573   many YAML files
-000252b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000252c0: 6b79 2073 6572 7665 2075 7020 2d6e 207b  ky serve up -n {
-000252d0: 6e61 6d65 7d20 2d79 2074 6573 7473 2f73  name} -y tests/s
-000252e0: 6b79 7365 7276 652f 6175 746f 5f72 6573  kyserve/auto_res
-000252f0: 7461 7274 2e79 616d 6c27 2c0a 2020 2020  tart.yaml',.    
-00025300: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00025310: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00025320: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00025330: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
-00025340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00025350: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00025360: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00025370: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-00025380: 2020 2020 2020 2020 2772 6571 7565 7374          'request
-00025390: 5f6f 7574 7075 743d 2428 6375 726c 2068  _output=$(curl h
-000253a0: 7474 703a 2f2f 2465 6e64 706f 696e 7429  ttp://$endpoint)
-000253b0: 3b20 6563 686f 2022 2472 6571 7565 7374  ; echo "$request
-000253c0: 5f6f 7574 7075 7422 3b20 6563 686f 2022  _output"; echo "
-000253d0: 2472 6571 7565 7374 5f6f 7574 7075 7422  $request_output"
-000253e0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
-000253f0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
-00025400: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
-00025410: 7020 666f 7220 3230 2073 6563 6f6e 6473  p for 20 seconds
-00025420: 2028 696e 6974 6961 6c20 6465 6c61 7929   (initial delay)
-00025430: 2074 6f20 6d61 6b65 2073 7572 6520 6974   to make sure it
-00025440: 2077 696c 6c0a 2020 2020 2020 2020 2020   will.          
-00025450: 2020 2320 6265 2072 6573 7461 7274 6564    # be restarted
-00025460: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00025470: 6c65 6570 2032 3027 2c0a 2020 2020 2020  leep 20',.      
-00025480: 2020 2020 2020 5f74 6572 6d69 6e61 7465        _terminate
-00025490: 5f67 6370 5f72 6570 6c69 6361 286e 616d  _gcp_replica(nam
-000254a0: 652c 207a 6f6e 652c 2031 292c 0a20 2020  e, zone, 1),.   
-000254b0: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-000254c0: 666f 7220 636f 6e73 6563 7574 6976 6520  for consecutive 
-000254d0: 6661 696c 7572 6520 7469 6d65 6f75 7420  failure timeout 
-000254e0: 7061 7373 6564 2e0a 2020 2020 2020 2020  passed..        
-000254f0: 2020 2020 2320 4966 2074 6865 2063 6c75      # If the clu
-00025500: 7374 6572 2069 7320 6e6f 7420 7573 696e  ster is not usin
-00025510: 6720 7370 6f74 2c20 6974 2077 6f6e 2774  g spot, it won't
-00025520: 2063 6865 636b 2074 6865 2063 6c75 7374   check the clust
-00025530: 6572 2073 7461 7475 730a 2020 2020 2020  er status.      
-00025540: 2020 2020 2020 2320 6f6e 2074 6865 2063        # on the c
-00025550: 6c6f 7564 2028 7369 6e63 6520 6d61 6e75  loud (since manu
-00025560: 616c 2073 6875 7464 6f77 6e20 6973 206e  al shutdown is n
-00025570: 6f74 2061 2063 6f6d 6d6f 6e20 6265 6861  ot a common beha
-00025580: 7669 6f72 2061 6e64 2073 7563 680a 2020  vior and such.  
-00025590: 2020 2020 2020 2020 2020 2320 7175 6572            # quer
-000255a0: 6965 7320 7461 6b65 7320 6120 6c6f 7420  ies takes a lot 
-000255b0: 6f66 2074 696d 6529 2e20 496e 7374 6561  of time). Instea
-000255c0: 642c 2077 6520 7468 696e 6b20 636f 6e74  d, we think cont
-000255d0: 696e 756f 7573 2033 206d 696e 2070 726f  inuous 3 min pro
-000255e0: 6265 0a20 2020 2020 2020 2020 2020 2023  be.            #
-000255f0: 2066 6169 6c75 7265 2069 7320 6e6f 7420   failure is not 
-00025600: 6120 7465 6d70 6f72 6172 7920 7072 6f62  a temporary prob
-00025610: 6c65 6d20 6275 7420 696e 6465 6564 2061  lem but indeed a
-00025620: 2066 6169 6c75 7265 2e0a 2020 2020 2020   failure..      
-00025630: 2020 2020 2020 2773 6c65 6570 2031 3830        'sleep 180
-00025640: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00025650: 2057 6520 6361 6e6e 6f74 2075 7365 205f   We cannot use _
-00025660: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00025670: 5f52 4541 4459 3b20 7468 6572 6520 7769  _READY; there wi
-00025680: 6c6c 2062 6520 6120 696e 7465 726d 6564  ll be a intermed
-00025690: 6961 7465 2074 696d 650a 2020 2020 2020  iate time.      
-000256a0: 2020 2020 2020 2320 7468 6174 2074 6865        # that the
-000256b0: 206f 7574 7075 7420 6f66 2060 736b 7920   output of `sky 
-000256c0: 7365 7276 6520 7374 6174 7573 6020 7368  serve status` sh
-000256d0: 6f77 7320 4641 494c 4544 2061 6e64 2074  ows FAILED and t
-000256e0: 6869 7320 7374 6174 7573 2077 696c 6c0a  his status will.
-000256f0: 2020 2020 2020 2020 2020 2020 2320 6361              # ca
-00025700: 7573 6520 5f53 4552 5645 5f57 4149 545f  use _SERVE_WAIT_
-00025710: 554e 5449 4c5f 5245 4144 5920 746f 2065  UNTIL_READY to e
-00025720: 6172 6c79 2071 7569 742e 0a20 2020 2020  arly quit..     
-00025730: 2020 2020 2020 2027 2877 6869 6c65 2074         '(while t
-00025740: 7275 653b 2064 6f27 0a20 2020 2020 2020  rue; do'.       
-00025750: 2020 2020 2066 2720 2020 206f 7574 7075       f'    outpu
-00025760: 743d 2428 736b 7920 7365 7276 6520 7374  t=$(sky serve st
-00025770: 6174 7573 207b 6e61 6d65 7d29 3b27 0a20  atus {name});'. 
-00025780: 2020 2020 2020 2020 2020 2027 2020 2020             '    
-00025790: 2065 6368 6f20 2224 6f75 7470 7574 2220   echo "$output" 
-000257a0: 7c20 6772 6570 202d 7120 2231 2f31 2220  | grep -q "1/1" 
-000257b0: 2626 2062 7265 616b 3b27 0a20 2020 2020  && break;'.     
-000257c0: 2020 2020 2020 2027 2020 2020 2073 6c65         '     sle
-000257d0: 6570 2031 303b 270a 2020 2020 2020 2020  ep 10;'.        
-000257e0: 2020 2020 6627 646f 6e65 293b 2073 6c65      f'done); sle
-000257f0: 6570 207b 7365 7276 652e 4c42 5f43 4f4e  ep {serve.LB_CON
-00025800: 5452 4f4c 4c45 525f 5359 4e43 5f49 4e54  TROLLER_SYNC_INT
-00025810: 4552 5641 4c5f 5345 434f 4e44 537d 3b27  ERVAL_SECONDS};'
-00025820: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00025830: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00025840: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00025850: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-00025860: 2020 2020 2020 2020 2772 6571 7565 7374          'request
-00025870: 5f6f 7574 7075 743d 2428 6375 726c 2068  _output=$(curl h
-00025880: 7474 703a 2f2f 2465 6e64 706f 696e 7429  ttp://$endpoint)
-00025890: 3b20 6563 686f 2022 2472 6571 7565 7374  ; echo "$request
-000258a0: 5f6f 7574 7075 7422 3b20 6563 686f 2022  _output"; echo "
-000258b0: 2472 6571 7565 7374 5f6f 7574 7075 7422  $request_output"
-000258c0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
-000258d0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
-000258e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-000258f0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
-00025900: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
-00025910: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00025920: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00025930: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00025940: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00025950: 7974 6573 742e 6d61 726b 2e73 6572 7665  ytest.mark.serve
-00025960: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00025970: 7665 5f63 616e 6365 6c28 6765 6e65 7269  ve_cancel(generi
-00025980: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-00025990: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-000259a0: 7276 6520 7769 7468 2063 616e 6365 6c22  rve with cancel"
-000259b0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000259c0: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-000259d0: 290a 0a20 2020 2074 6573 7420 3d20 5465  )..    test = Te
-000259e0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
-000259f0: 7374 2d73 6b79 7365 7276 652d 6361 6e63  st-skyserve-canc
-00025a00: 656c 272c 0a20 2020 2020 2020 205b 0a20  el',.        [. 
-00025a10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00025a20: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-00025a30: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00025a40: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00025a50: 6573 7473 2f73 6b79 7365 7276 652f 6361  ests/skyserve/ca
-00025a60: 6e63 656c 2f63 616e 6365 6c2e 7961 6d6c  ncel/cancel.yaml
-00025a70: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00025a80: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00025a90: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00025aa0: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00025ab0: 5f6e 756d 3d31 292c 0a20 2020 2020 2020  _num=1),.       
-00025ac0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-00025ad0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-00025ae0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-00025af0: 2070 7974 686f 6e33 2027 0a20 2020 2020   python3 '.     
-00025b00: 2020 2020 2020 2027 7465 7374 732f 736b         'tests/sk
-00025b10: 7973 6572 7665 2f63 616e 6365 6c2f 7365  yserve/cancel/se
-00025b20: 6e64 5f63 616e 6365 6c5f 7265 7175 6573  nd_cancel_reques
-00025b30: 742e 7079 2027 0a20 2020 2020 2020 2020  t.py '.         
-00025b40: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
-00025b50: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00025b60: 2252 6571 7565 7374 2077 6173 2063 616e  "Request was can
-00025b70: 6365 6c6c 6564 2227 2c0a 2020 2020 2020  celled"',.      
-00025b80: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00025b90: 7365 7276 6520 6c6f 6773 207b 6e61 6d65  serve logs {name
-00025ba0: 7d20 3120 2d2d 6e6f 2d66 6f6c 6c6f 7729  } 1 --no-follow)
-00025bb0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00025bc0: 2775 6e74 696c 2021 2065 6368 6f20 2224  'until ! echo "$
-00025bd0: 7322 207c 2067 7265 7020 2250 6c65 6173  s" | grep "Pleas
-00025be0: 6520 7761 6974 2066 6f72 2074 6865 2063  e wait for the c
-00025bf0: 6f6e 7472 6f6c 6c65 7220 746f 2062 6522  ontroller to be"
-00025c00: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00025c10: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
-00025c20: 6720 666f 7220 7365 7276 6520 6c6f 6773  g for serve logs
-00025c30: 223b 2073 6c65 6570 2031 303b 2027 0a20  "; sleep 10; '. 
-00025c40: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00025c50: 2873 6b79 2073 6572 7665 206c 6f67 7320  (sky serve logs 
-00025c60: 7b6e 616d 657d 2031 202d 2d6e 6f2d 666f  {name} 1 --no-fo
-00025c70: 6c6c 6f77 293b 2064 6f6e 653b 2027 0a20  llow); done; '. 
-00025c80: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
-00025c90: 2022 2473 223b 2065 6368 6f20 2224 7322   "$s"; echo "$s"
-00025ca0: 207c 2067 7265 7020 2243 6c69 656e 7420   | grep "Client 
-00025cb0: 6469 7363 6f6e 6e65 6374 6564 2c20 7374  disconnected, st
-00025cc0: 6f70 7069 6e67 2063 6f6d 7075 7461 7469  opping computati
-00025cd0: 6f6e 2227 2c0a 2020 2020 2020 2020 5d2c  on"',.        ],
-00025ce0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00025cf0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00025d00: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00025d10: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00025d20: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00025d30: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00025d40: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00025d50: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00025d60: 745f 736b 7973 6572 7665 5f73 7472 6561  t_skyserve_strea
-00025d70: 6d69 6e67 2867 656e 6572 6963 5f63 6c6f  ming(generic_clo
-00025d80: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-00025d90: 2254 6573 7420 736b 7973 6572 7665 2077  "Test skyserve w
-00025da0: 6974 6820 7374 7265 616d 696e 6722 2222  ith streaming"""
-00025db0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00025dc0: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00025dd0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00025de0: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-00025df0: 736b 7973 6572 7665 2d73 7472 6561 6d69  skyserve-streami
-00025e00: 6e67 272c 0a20 2020 2020 2020 205b 0a20  ng',.        [. 
-00025e10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00025e20: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-00025e30: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00025e40: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00025e50: 6573 7473 2f73 6b79 7365 7276 652f 7374  ests/skyserve/st
-00025e60: 7265 616d 696e 672f 7374 7265 616d 696e  reaming/streamin
-00025e70: 672e 7961 6d6c 272c 0a20 2020 2020 2020  g.yaml',.       
-00025e80: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-00025e90: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-00025ea0: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-00025eb0: 6570 6c69 6361 5f6e 756d 3d31 292c 0a20  eplica_num=1),. 
-00025ec0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00025ed0: 4552 5645 5f45 4e44 504f 494e 545f 5741  ERVE_ENDPOINT_WA
-00025ee0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
-00025ef0: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
-00025f00: 2020 2020 2027 7079 7468 6f6e 3320 7465       'python3 te
-00025f10: 7374 732f 736b 7973 6572 7665 2f73 7472  sts/skyserve/str
-00025f20: 6561 6d69 6e67 2f73 656e 645f 7374 7265  eaming/send_stre
-00025f30: 616d 696e 675f 7265 7175 6573 742e 7079  aming_request.py
-00025f40: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-00025f50: 2d2d 656e 6470 6f69 6e74 2024 656e 6470  --endpoint $endp
-00025f60: 6f69 6e74 207c 2067 7265 7020 2253 7472  oint | grep "Str
-00025f70: 6561 6d69 6e67 2074 6573 7420 7061 7373  eaming test pass
-00025f80: 6564 2227 2c0a 2020 2020 2020 2020 5d2c  ed"',.        ],
-00025f90: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00025fa0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00025fb0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00025fc0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00025fd0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00025fe0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00025ff0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00026000: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00026010: 745f 736b 7973 6572 7665 5f75 7064 6174  t_skyserve_updat
-00026020: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00026030: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00026040: 7374 2073 6b79 7365 7276 6520 7769 7468  st skyserve with
-00026050: 2075 7064 6174 6522 2222 0a20 2020 206e   update""".    n
-00026060: 616d 6520 3d20 5f67 6574 5f73 6572 7669  ame = _get_servi
-00026070: 6365 5f6e 616d 6528 290a 2020 2020 7465  ce_name().    te
-00026080: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00026090: 2020 2066 2774 6573 742d 736b 7973 6572     f'test-skyser
-000260a0: 7665 2d75 7064 6174 6527 2c0a 2020 2020  ve-update',.    
-000260b0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000260c0: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-000260d0: 202d 6e20 7b6e 616d 657d 202d 2d63 6c6f   -n {name} --clo
-000260e0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-000260f0: 647d 202d 7920 7465 7374 732f 736b 7973  d} -y tests/skys
-00026100: 6572 7665 2f75 7064 6174 652f 6f6c 642e  erve/update/old.
-00026110: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00026120: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
-00026130: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
-00026140: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
-00026150: 6c69 6361 5f6e 756d 3d32 292c 0a20 2020  lica_num=2),.   
-00026160: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
-00026170: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
-00026180: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00026190: 6529 7d3b 2063 7572 6c20 6874 7470 3a2f  e)}; curl http:/
-000261a0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-000261b0: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-000261c0: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-000261d0: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-000261e0: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-000261f0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00026200: 6c6f 7564 7d20 2d2d 6d6f 6465 2062 6c75  loud} --mode blu
-00026210: 655f 6772 6565 6e20 2d79 2074 6573 7473  e_green -y tests
-00026220: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-00026230: 2f6e 6577 2e79 616d 6c27 2c0a 2020 2020  /new.yaml',.    
-00026240: 2020 2020 2020 2020 2320 736c 6565 7020          # sleep 
-00026250: 6265 666f 7265 2075 7064 6174 6520 6973  before update is
-00026260: 2072 6567 6973 7465 7265 642e 0a20 2020   registered..   
-00026270: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00026280: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-00026290: 2066 277b 5f53 4552 5645 5f45 4e44 504f   f'{_SERVE_ENDPO
-000262a0: 494e 545f 5741 4954 2e66 6f72 6d61 7428  INT_WAIT.format(
-000262b0: 6e61 6d65 3d6e 616d 6529 7d3b 2027 0a20  name=name)}; '. 
-000262c0: 2020 2020 2020 2020 2020 2027 756e 7469             'unti
-000262d0: 6c20 6375 726c 2068 7474 703a 2f2f 2465  l curl http://$e
-000262e0: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
-000262f0: 4869 2c20 6e65 7720 536b 7950 696c 6f74  Hi, new SkyPilot
-00026300: 2068 6572 6521 223b 2064 6f20 736c 6565   here!"; do slee
-00026310: 7020 323b 2064 6f6e 653b 270a 2020 2020  p 2; done;'.    
-00026320: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-00026330: 7572 6520 7468 6520 7472 6166 6669 6320  ure the traffic 
-00026340: 6973 206e 6f74 206d 6978 6564 0a20 2020  is not mixed.   
-00026350: 2020 2020 2020 2020 2027 6375 726c 2068           'curl h
-00026360: 7474 703a 2f2f 2465 6e64 706f 696e 7420  ttp://$endpoint 
-00026370: 7c20 6772 6570 2022 4869 2c20 6e65 7720  | grep "Hi, new 
-00026380: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00026390: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000263a0: 6865 206c 6174 6573 7420 3220 7665 7273  he latest 2 vers
-000263b0: 696f 6e20 7368 6f75 6c64 2062 6520 5245  ion should be RE
-000263c0: 4144 5920 616e 6420 7468 6520 6f6c 6465  ADY and the olde
-000263d0: 7220 7665 7273 696f 6e73 2073 686f 756c  r versions shoul
-000263e0: 6420 6265 2073 6875 7474 696e 6720 646f  d be shutting do
-000263f0: 776e 0a20 2020 2020 2020 2020 2020 2028  wn.            (
-00026400: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00026410: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00026420: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00026430: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
-00026440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026460: 2020 2832 2c20 4661 6c73 652c 2027 5348    (2, False, 'SH
-00026470: 5554 5449 4e47 5f44 4f57 4e27 295d 2920  UTTING_DOWN')]) 
-00026480: 2b0a 2020 2020 2020 2020 2020 2020 205f  +.             _
-00026490: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
-000264a0: 7273 696f 6e28 6e61 6d65 2c20 2232 2229  rsion(name, "2")
-000264b0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-000264c0: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
-000264d0: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
-000264e0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-000264f0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00026500: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00026510: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00026520: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00026530: 7365 7276 650a 6465 6620 7465 7374 5f73  serve.def test_s
-00026540: 6b79 7365 7276 655f 726f 6c6c 696e 675f  kyserve_rolling_
-00026550: 7570 6461 7465 2867 656e 6572 6963 5f63  update(generic_c
-00026560: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00026570: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-00026580: 2077 6974 6820 726f 6c6c 696e 6720 7570   with rolling up
-00026590: 6461 7465 2222 220a 2020 2020 6e61 6d65  date""".    name
-000265a0: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
-000265b0: 6e61 6d65 2829 0a20 2020 2073 696e 676c  name().    singl
-000265c0: 655f 6e65 775f 7265 706c 6963 6120 3d20  e_new_replica = 
-000265d0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-000265e0: 6e5f 7374 6174 7573 280a 2020 2020 2020  n_status(.      
-000265f0: 2020 6e61 6d65 2c20 5b28 322c 2046 616c    name, [(2, Fal
-00026600: 7365 2c20 2752 4541 4459 2729 2c20 2831  se, 'READY'), (1
-00026610: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
-00026620: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-00026630: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
-00026640: 2020 2020 2020 2020 2020 2831 2c20 4661            (1, Fa
-00026650: 6c73 652c 2027 5348 5554 5449 4e47 5f44  lse, 'SHUTTING_D
-00026660: 4f57 4e27 295d 290a 2020 2020 7465 7374  OWN')]).    test
-00026670: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00026680: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-00026690: 2d72 6f6c 6c69 6e67 2d75 7064 6174 6527  -rolling-update'
-000266a0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000266b0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-000266c0: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-000266d0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000266e0: 635f 636c 6f75 647d 202d 7920 7465 7374  c_cloud} -y test
-000266f0: 732f 736b 7973 6572 7665 2f75 7064 6174  s/skyserve/updat
-00026700: 652f 6f6c 642e 7961 6d6c 272c 0a20 2020  e/old.yaml',.   
-00026710: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00026720: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00026730: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00026740: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
-00026750: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00026760: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-00026770: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-00026780: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
-00026790: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
-000267a0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
-000267b0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
-000267c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000267d0: 7365 7276 6520 7570 6461 7465 207b 6e61  serve update {na
-000267e0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-000267f0: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00026800: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
-00026810: 6461 7465 2f6e 6577 2e79 616d 6c27 2c0a  date/new.yaml',.
-00026820: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-00026830: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
-00026840: 6669 6320 6973 206d 6978 6564 2061 6372  fic is mixed acr
-00026850: 6f73 7320 7477 6f20 7665 7273 696f 6e73  oss two versions
-00026860: 2c20 7468 6520 7265 706c 6963 6173 0a20  , the replicas. 
-00026870: 2020 2020 2020 2020 2020 2023 2077 6974             # wit
-00026880: 6820 6576 656e 2069 6420 7769 6c6c 2073  h even id will s
-00026890: 6c65 6570 2036 3020 7365 636f 6e64 7320  leep 60 seconds 
-000268a0: 6265 666f 7265 2062 6569 6e67 2072 6561  before being rea
-000268b0: 6479 2c20 736f 2077 650a 2020 2020 2020  dy, so we.      
-000268c0: 2020 2020 2020 2320 7368 6f75 6c64 2062        # should b
-000268d0: 6520 6162 6c65 2074 6f20 6765 7420 6f62  e able to get ob
-000268e0: 7365 7276 6520 7468 6520 7065 7269 6f64  serve the period
-000268f0: 2074 6861 7420 7468 6520 7472 6166 6669   that the traffi
-00026900: 6320 6973 206d 6978 6564 0a20 2020 2020  c is mixed.     
-00026910: 2020 2020 2020 2023 2061 6372 6f73 7320         # across 
-00026920: 7477 6f20 7665 7273 696f 6e73 2e0a 2020  two versions..  
-00026930: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-00026940: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-00026950: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00026960: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00026970: 2020 2020 2775 6e74 696c 2063 7572 6c20      'until curl 
-00026980: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
-00026990: 207c 2067 7265 7020 2248 692c 206e 6577   | grep "Hi, new
-000269a0: 2053 6b79 5069 6c6f 7420 6865 7265 2122   SkyPilot here!"
-000269b0: 3b20 646f 2073 6c65 6570 2032 3b20 646f  ; do sleep 2; do
-000269c0: 6e65 3b20 736c 6565 7020 323b 2027 0a20  ne; sleep 2; '. 
-000269d0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-000269e0: 206c 6174 6573 7420 7665 7273 696f 6e20   latest version 
-000269f0: 7368 6f75 6c64 2068 6176 6520 6f6e 6520  should have one 
-00026a00: 5245 4144 5920 616e 6420 7468 6520 6f6e  READY and the on
-00026a10: 6520 6f66 2074 6865 206f 6c64 6572 2076  e of the older v
-00026a20: 6572 7369 6f6e 7320 7368 6f75 6c64 2062  ersions should b
-00026a30: 6520 7368 7574 7469 6e67 2064 6f77 6e0a  e shutting down.
-00026a40: 2020 2020 2020 2020 2020 2020 6627 7b73              f'{s
-00026a50: 696e 676c 655f 6e65 775f 7265 706c 6963  ingle_new_replic
-00026a60: 617d 207b 5f63 6865 636b 5f73 6572 7669  a} {_check_servi
-00026a70: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00026a80: 2022 312c 3222 297d 2027 0a20 2020 2020   "1,2")} '.     
-00026a90: 2020 2020 2020 2023 2043 6865 636b 2074         # Check t
-00026aa0: 6865 206f 7574 7075 7420 6672 6f6d 2074  he output from t
-00026ab0: 6865 206f 6c64 2076 6572 7369 6f6e 2c20  he old version, 
-00026ac0: 696d 6d65 6469 6174 656c 7920 6166 7465  immediately afte
-00026ad0: 7220 7468 650a 2020 2020 2020 2020 2020  r the.          
-00026ae0: 2020 2320 6f75 7470 7574 2066 726f 6d20    # output from 
-00026af0: 7468 6520 6e65 7720 7665 7273 696f 6e20  the new version 
-00026b00: 6170 7065 6172 732e 2054 6869 7320 6973  appears. This is
-00026b10: 2067 7561 7261 6e74 6565 6420 6279 2074   guaranteed by t
-00026b20: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
-00026b30: 2072 6f75 6e64 2072 6f62 696e 206c 6f61   round robin loa
-00026b40: 6420 6261 6c61 6e63 696e 6720 706f 6c69  d balancing poli
-00026b50: 6379 2e0a 2020 2020 2020 2020 2020 2020  cy..            
-00026b60: 2320 544f 444f 287a 6877 7529 3a20 7765  # TODO(zhwu): we
-00026b70: 2073 686f 756c 6420 6861 7665 2061 206d   should have a m
-00026b80: 6f72 6520 6765 6e65 7261 6c69 7a65 6420  ore generalized 
-00026b90: 7761 7920 666f 7220 6368 6563 6b69 6e67  way for checking
-00026ba0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00026bb0: 2023 206d 6978 6564 2076 6572 7369 6f6e   # mixed version
-00026bc0: 206f 6620 7265 706c 6963 6173 2074 6f20   of replicas to 
-00026bd0: 6176 6f69 6420 6465 7065 6e64 696e 6720  avoid depending 
-00026be0: 6f6e 2074 6865 2073 7065 6369 6669 630a  on the specific.
-00026bf0: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-00026c00: 756e 6420 726f 6269 6e20 6c6f 6164 2062  und robin load b
-00026c10: 616c 616e 6369 6e67 2070 6f6c 6963 792e  alancing policy.
-00026c20: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
-00026c30: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
-00026c40: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00026c50: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-00026c60: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00026c70: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-00026c80: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-00026c90: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00026ca0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00026cb0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00026cc0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00026cd0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00026ce0: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-00026cf0: 7365 7276 655f 6661 7374 5f75 7064 6174  serve_fast_updat
-00026d00: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00026d10: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00026d20: 7374 2073 6b79 7365 7276 6520 7769 7468  st skyserve with
-00026d30: 2066 6173 7420 7570 6461 7465 2028 496e   fast update (In
-00026d40: 6372 656d 656e 7420 7665 7273 696f 6e20  crement version 
-00026d50: 6f66 206f 6c64 2072 6570 6c69 6361 7329  of old replicas)
-00026d60: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00026d70: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-00026d80: 2829 0a0a 2020 2020 7465 7374 203d 2054  ()..    test = T
-00026d90: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
-00026da0: 6573 742d 736b 7973 6572 7665 2d66 6173  est-skyserve-fas
-00026db0: 742d 7570 6461 7465 272c 0a20 2020 2020  t-update',.     
-00026dc0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00026dd0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-00026de0: 2d6e 207b 6e61 6d65 7d20 2d79 202d 2d63  -n {name} -y --c
-00026df0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00026e00: 6f75 647d 2074 6573 7473 2f73 6b79 7365  oud} tests/skyse
-00026e10: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
-00026e20: 7665 7273 696f 6e5f 6265 666f 7265 2e79  version_before.y
-00026e30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00026e40: 2020 5f53 4552 5645 5f57 4149 545f 554e    _SERVE_WAIT_UN
-00026e50: 5449 4c5f 5245 4144 592e 666f 726d 6174  TIL_READY.format
-00026e60: 286e 616d 653d 6e61 6d65 2c20 7265 706c  (name=name, repl
-00026e70: 6963 615f 6e75 6d3d 3229 2c0a 2020 2020  ica_num=2),.    
-00026e80: 2020 2020 2020 2020 6627 7b5f 5345 5256          f'{_SERV
-00026e90: 455f 454e 4450 4f49 4e54 5f57 4149 542e  E_ENDPOINT_WAIT.
-00026ea0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00026eb0: 297d 3b20 6375 726c 2068 7474 703a 2f2f  )}; curl http://
-00026ec0: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
-00026ed0: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00026ee0: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
-00026ef0: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00026f00: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
-00026f10: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00026f20: 6f75 647d 202d 2d6d 6f64 6520 626c 7565  oud} --mode blue
-00026f30: 5f67 7265 656e 202d 7920 7465 7374 732f  _green -y tests/
-00026f40: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
-00026f50: 6275 6d70 5f76 6572 7369 6f6e 5f61 6674  bump_version_aft
-00026f60: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-00026f70: 2020 2020 2020 2320 736c 6565 7020 746f        # sleep to
-00026f80: 2077 6169 7420 666f 7220 7570 6461 7465   wait for update
-00026f90: 2074 6f20 6265 2072 6567 6973 7465 7265   to be registere
-00026fa0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-00026fb0: 736c 6565 7020 3330 272c 0a20 2020 2020  sleep 30',.     
-00026fc0: 2020 2020 2020 2023 2032 206f 6e2d 6465         # 2 on-de
-00026fd0: 616d 6e64 2028 7265 6164 7929 202b 2031  amnd (ready) + 1
-00026fe0: 206f 6e2d 6465 6d61 6e64 2028 7072 6f76   on-demand (prov
-00026ff0: 6973 696f 6e69 6e67 292e 0a20 2020 2020  isioning)..     
-00027000: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-00027010: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00027020: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
-00027030: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00027040: 2020 2020 2020 206e 616d 652c 205b 2832         name, [(2
-00027050: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
-00027060: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00027070: 2020 2020 2020 2020 2020 2020 2020 2831                (1
-00027080: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
-00027090: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
-000270a0: 5553 5f52 4547 4558 295d 2920 2b0a 2020  US_REGEX)]) +.  
-000270b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000270c0: 4661 7374 2075 7064 6174 6520 7769 6c6c  Fast update will
-000270d0: 2064 6972 6563 746c 7920 6861 7665 2074   directly have t
-000270e0: 6865 206c 6174 6573 7420 7665 7273 696f  he latest versio
-000270f0: 6e20 7265 6164 792e 0a20 2020 2020 2020  n ready..       
-00027100: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00027110: 7365 7276 6963 655f 7665 7273 696f 6e28  service_version(
-00027120: 6e61 6d65 2c20 2232 2229 292c 0a20 2020  name, "2")),.   
-00027130: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00027140: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00027150: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00027160: 652c 2072 6570 6c69 6361 5f6e 756d 3d33  e, replica_num=3
-00027170: 2920 2b0a 2020 2020 2020 2020 2020 2020  ) +.            
-00027180: 5f63 6865 636b 5f73 6572 7669 6365 5f76  _check_service_v
-00027190: 6572 7369 6f6e 286e 616d 652c 2022 3222  ersion(name, "2"
-000271a0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-000271b0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
-000271c0: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
-000271d0: 6d65 3d6e 616d 6529 7d3b 2063 7572 6c20  me=name)}; curl 
-000271e0: 6874 7470 3a2f 2f24 656e 6470 6f69 6e74  http://$endpoint
-000271f0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
-00027200: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
-00027210: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-00027220: 2072 6f6c 6c69 6e67 2075 7064 6174 650a   rolling update.
-00027230: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00027240: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
-00027250: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00027260: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
-00027270: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-00027280: 7570 6461 7465 2f62 756d 705f 7665 7273  update/bump_vers
-00027290: 696f 6e5f 6265 666f 7265 2e79 616d 6c27  ion_before.yaml'
-000272a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000272b0: 736c 6565 7020 746f 2077 6169 7420 666f  sleep to wait fo
-000272c0: 7220 7570 6461 7465 2074 6f20 6265 2072  r update to be r
-000272d0: 6567 6973 7465 7265 642e 0a20 2020 2020  egistered..     
-000272e0: 2020 2020 2020 2027 736c 6565 7020 3135         'sleep 15
-000272f0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00027300: 2032 206f 6e2d 6465 616d 6e64 2028 7265   2 on-deamnd (re
-00027310: 6164 7929 202b 2031 206f 6e2d 6465 6d61  ady) + 1 on-dema
-00027320: 6e64 2028 7368 7574 7469 6e67 2064 6f77  nd (shutting dow
-00027330: 6e29 2e0a 2020 2020 2020 2020 2020 2020  n)..            
-00027340: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
-00027350: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
-00027360: 2832 2c20 4661 6c73 652c 2027 5245 4144  (2, False, 'READ
-00027370: 5927 292c 0a20 2020 2020 2020 2020 2020  Y'),.           
-00027380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000273a0: 2028 312c 2046 616c 7365 2c20 2753 4855   (1, False, 'SHU
-000273b0: 5454 494e 475f 444f 574e 2729 5d29 2c0a  TTING_DOWN')]),.
-000273c0: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
-000273d0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
-000273e0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
-000273f0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
-00027400: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
-00027410: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
-00027420: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
-00027430: 2233 2229 2c0a 2020 2020 2020 2020 2020  "3"),.          
-00027440: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
-00027450: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
-00027460: 286e 616d 653d 6e61 6d65 297d 3b20 6375  (name=name)}; cu
-00027470: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
-00027480: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-00027490: 536b 7950 696c 6f74 2068 6572 6522 272c  SkyPilot here"',
-000274a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000274b0: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
-000274c0: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
-000274d0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-000274e0: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-000274f0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00027500: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00027510: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
-00027520: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-00027530: 7365 7276 655f 7570 6461 7465 5f61 7574  serve_update_aut
-00027540: 6f73 6361 6c65 2867 656e 6572 6963 5f63  oscale(generic_c
-00027550: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00027560: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-00027570: 2075 7064 6174 6520 7769 7468 2061 7574   update with aut
-00027580: 6f73 6361 6c65 2222 220a 2020 2020 6e61  oscale""".    na
-00027590: 6d65 203d 205f 6765 745f 7365 7276 6963  me = _get_servic
-000275a0: 655f 6e61 6d65 2829 0a20 2020 2074 6573  e_name().    tes
-000275b0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000275c0: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
-000275d0: 652d 7570 6461 7465 2d61 7574 6f73 6361  e-update-autosca
-000275e0: 6c65 272c 0a20 2020 2020 2020 205b 0a20  le',.        [. 
-000275f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00027600: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-00027610: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00027620: 6572 6963 5f63 6c6f 7564 7d20 2d79 2074  eric_cloud} -y t
-00027630: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
-00027640: 6461 7465 2f6e 756d 5f6d 696e 5f74 776f  date/num_min_two
-00027650: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00027660: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00027670: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00027680: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00027690: 706c 6963 615f 6e75 6d3d 3229 202b 0a20  plica_num=2) +. 
-000276a0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000276b0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
-000276c0: 6e28 6e61 6d65 2c20 2231 2229 2c0a 2020  n(name, "1"),.  
-000276d0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000276e0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-000276f0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-00027700: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00027710: 2020 2020 2763 7572 6c20 6874 7470 3a2f      'curl http:/
-00027720: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00027730: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00027740: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-00027750: 2020 2020 6627 736b 7920 7365 7276 6520      f'sky serve 
-00027760: 7570 6461 7465 207b 6e61 6d65 7d20 2d2d  update {name} --
-00027770: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00027780: 6c6f 7564 7d20 2d2d 6d6f 6465 2062 6c75  loud} --mode blu
-00027790: 655f 6772 6565 6e20 2d79 2074 6573 7473  e_green -y tests
-000277a0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
-000277b0: 2f6e 756d 5f6d 696e 5f6f 6e65 2e79 616d  /num_min_one.yam
-000277c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000277d0: 2320 736c 6565 7020 6265 666f 7265 2075  # sleep before u
-000277e0: 7064 6174 6520 6973 2072 6567 6973 7465  pdate is registe
-000277f0: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
-00027800: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
-00027810: 2020 2020 2020 2020 2023 2054 696d 656f           # Timeo
-00027820: 7574 2077 696c 6c20 6265 2074 7269 6767  ut will be trigg
-00027830: 6572 6564 2077 6865 6e20 7570 6461 7465  ered when update
-00027840: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
-00027850: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00027860: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00027870: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00027880: 706c 6963 615f 6e75 6d3d 3129 202b 0a20  plica_num=1) +. 
-00027890: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000278a0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
-000278b0: 6e28 6e61 6d65 2c20 2232 2229 2c0a 2020  n(name, "2"),.  
-000278c0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
-000278d0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
-000278e0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
-000278f0: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
-00027900: 2020 2020 2763 7572 6c20 6874 7470 3a2f      'curl http:/
-00027910: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-00027920: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-00027930: 6865 7265 2122 272c 0a20 2020 2020 2020  here!"',.       
-00027940: 2020 2020 2023 2052 6f6c 6c69 6e67 2055       # Rolling U
-00027950: 7064 6174 650a 2020 2020 2020 2020 2020  pdate.          
-00027960: 2020 6627 736b 7920 7365 7276 6520 7570    f'sky serve up
-00027970: 6461 7465 207b 6e61 6d65 7d20 2d2d 636c  date {name} --cl
-00027980: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00027990: 7564 7d20 2d79 2074 6573 7473 2f73 6b79  ud} -y tests/sky
-000279a0: 7365 7276 652f 7570 6461 7465 2f6e 756d  serve/update/num
-000279b0: 5f6d 696e 5f74 776f 2e79 616d 6c27 2c0a  _min_two.yaml',.
-000279c0: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
-000279d0: 6565 7020 6265 666f 7265 2075 7064 6174  eep before updat
-000279e0: 6520 6973 2072 6567 6973 7465 7265 642e  e is registered.
-000279f0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00027a00: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
-00027a10: 2020 2020 2023 2054 696d 656f 7574 2077       # Timeout w
-00027a20: 696c 6c20 6265 2074 7269 6767 6572 6564  ill be triggered
-00027a30: 2077 6865 6e20 7570 6461 7465 2066 6169   when update fai
-00027a40: 6c73 2e0a 2020 2020 2020 2020 2020 2020  ls..            
-00027a50: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-00027a60: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-00027a70: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-00027a80: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
-00027a90: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
-00027aa0: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
-00027ab0: 6d65 2c20 2233 2229 2c0a 2020 2020 2020  me, "3"),.      
-00027ac0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
-00027ad0: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
-00027ae0: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
-00027af0: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00027b00: 2763 7572 6c20 6874 7470 3a2f 2f24 656e  'curl http://$en
-00027b10: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00027b20: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00027b30: 2122 272c 0a20 2020 2020 2020 205d 2c0a  !"',.        ],.
-00027b40: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
-00027b50: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
-00027b60: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
-00027b70: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-00027b80: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00027b90: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00027ba0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00027bb0: 6b2e 7365 7276 650a 4070 7974 6573 742e  k.serve.@pytest.
-00027bc0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-00027bd0: 6573 2020 2320 5370 6f74 2069 6e73 7461  es  # Spot insta
-00027be0: 6e63 6573 2061 7265 206e 6f74 2073 7570  nces are not sup
-00027bf0: 706f 7274 6564 2069 6e20 4b75 6265 726e  ported in Kubern
-00027c00: 6574 6573 0a40 7079 7465 7374 2e6d 6172  etes.@pytest.mar
-00027c10: 6b2e 7061 7261 6d65 7472 697a 6528 276d  k.parametrize('m
-00027c20: 6f64 6527 2c20 5b27 726f 6c6c 696e 6727  ode', ['rolling'
-00027c30: 2c20 2762 6c75 655f 6772 6565 6e27 5d29  , 'blue_green'])
-00027c40: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00027c50: 7665 5f6e 6577 5f61 7574 6f73 6361 6c65  ve_new_autoscale
-00027c60: 725f 7570 6461 7465 286d 6f64 653a 2073  r_update(mode: s
-00027c70: 7472 2c20 6765 6e65 7269 635f 636c 6f75  tr, generic_clou
-00027c80: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00027c90: 5465 7374 2073 6b79 7365 7276 6520 7769  Test skyserve wi
-00027ca0: 7468 2075 7064 6174 6520 7468 6174 2063  th update that c
-00027cb0: 6861 6e67 6573 2061 7574 6f73 6361 6c65  hanges autoscale
-00027cc0: 7222 2222 0a20 2020 206e 616d 6520 3d20  r""".    name = 
-00027cd0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-00027ce0: 6528 2920 2b20 6d6f 6465 0a0a 2020 2020  e() + mode..    
-00027cf0: 666f 7572 5f73 706f 745f 7570 5f63 6d64  four_spot_up_cmd
-00027d00: 203d 205f 6368 6563 6b5f 7265 706c 6963   = _check_replic
-00027d10: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
-00027d20: 2c20 5b28 342c 2054 7275 652c 2027 5245  , [(4, True, 'RE
-00027d30: 4144 5927 295d 290a 2020 2020 7570 6461  ADY')]).    upda
-00027d40: 7465 5f63 6865 636b 203d 205b 6627 756e  te_check = [f'un
-00027d50: 7469 6c20 287b 666f 7572 5f73 706f 745f  til ({four_spot_
-00027d60: 7570 5f63 6d64 7d29 3b20 646f 2073 6c65  up_cmd}); do sle
-00027d70: 6570 2035 3b20 646f 6e65 3b20 736c 6565  ep 5; done; slee
-00027d80: 7020 3130 3b27 5d0a 2020 2020 6966 206d  p 10;'].    if m
-00027d90: 6f64 6520 3d3d 2027 726f 6c6c 696e 6727  ode == 'rolling'
-00027da0: 3a0a 2020 2020 2020 2020 2320 4368 6563  :.        # Chec
-00027db0: 6b20 726f 6c6c 696e 6720 7570 6461 7465  k rolling update
-00027dc0: 2c20 6974 2077 696c 6c20 7465 726d 696e  , it will termin
-00027dd0: 6174 6520 6f6e 6520 6f66 2074 6865 206f  ate one of the o
-00027de0: 6c64 206f 6e2d 6465 6d61 6e64 0a20 2020  ld on-demand.   
-00027df0: 2020 2020 2023 2069 6e73 7461 6e63 6573       # instances
-00027e00: 2c20 6f6e 6365 2074 6865 7265 2061 7265  , once there are
-00027e10: 2034 2073 706f 7420 696e 7374 616e 6365   4 spot instance
-00027e20: 2072 6561 6479 2e0a 2020 2020 2020 2020   ready..        
-00027e30: 7570 6461 7465 5f63 6865 636b 202b 3d20  update_check += 
-00027e40: 5b0a 2020 2020 2020 2020 2020 2020 5f63  [.            _c
-00027e50: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
-00027e60: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
-00027e70: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
-00027e80: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
-00027e90: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00027ea0: 5455 535f 5245 4745 5829 2c0a 2020 2020  TUS_REGEX),.    
-00027eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ec0: 2020 2028 312c 2046 616c 7365 2c20 2753     (1, False, 'S
-00027ed0: 4855 5454 494e 475f 444f 574e 2729 2c20  HUTTING_DOWN'), 
-00027ee0: 2831 2c20 4661 6c73 652c 2027 5245 4144  (1, False, 'READ
-00027ef0: 5927 295d 2920 2b0a 2020 2020 2020 2020  Y')]) +.        
-00027f00: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
-00027f10: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
-00027f20: 2022 312c 3222 292c 0a20 2020 2020 2020   "1,2"),.       
-00027f30: 205d 0a20 2020 2065 6c73 653a 0a20 2020   ].    else:.   
-00027f40: 2020 2020 2023 2043 6865 636b 2062 6c75       # Check blu
-00027f50: 6520 6772 6565 6e20 7570 6461 7465 2c20  e green update, 
-00027f60: 6974 2077 696c 6c20 6b65 6570 2062 6f74  it will keep bot
-00027f70: 6820 6f6c 6420 6f6e 2d64 656d 616e 6420  h old on-demand 
-00027f80: 696e 7374 616e 6365 730a 2020 2020 2020  instances.      
-00027f90: 2020 2320 7275 6e6e 696e 672c 206f 6e63    # running, onc
-00027fa0: 6520 7468 6572 6520 6172 6520 3420 7370  e there are 4 sp
-00027fb0: 6f74 2069 6e73 7461 6e63 6520 7265 6164  ot instance read
-00027fc0: 792e 0a20 2020 2020 2020 2075 7064 6174  y..        updat
-00027fd0: 655f 6368 6563 6b20 2b3d 205b 0a20 2020  e_check += [.   
-00027fe0: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00027ff0: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
-00028000: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00028010: 2020 206e 616d 652c 205b 2831 2c20 4661     name, [(1, Fa
-00028020: 6c73 652c 205f 5345 5256 4943 455f 4c41  lse, _SERVICE_LA
-00028030: 554e 4348 494e 475f 5354 4154 5553 5f52  UNCHING_STATUS_R
-00028040: 4547 4558 292c 0a20 2020 2020 2020 2020  EGEX),.         
-00028050: 2020 2020 2020 2020 2020 2020 2020 2832                (2
-00028060: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
-00028070: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
-00028080: 2020 5f63 6865 636b 5f73 6572 7669 6365    _check_service
-00028090: 5f76 6572 7369 6f6e 286e 616d 652c 2022  _version(name, "
-000280a0: 3122 292c 0a20 2020 2020 2020 205d 0a20  1"),.        ]. 
-000280b0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-000280c0: 2020 2020 2020 2020 2774 6573 742d 736b          'test-sk
-000280d0: 7973 6572 7665 2d6e 6577 2d61 7574 6f73  yserve-new-autos
-000280e0: 6361 6c65 722d 7570 6461 7465 272c 0a20  caler-update',. 
-000280f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00028100: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-00028110: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
-00028120: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00028130: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
-00028140: 6b79 7365 7276 652f 7570 6461 7465 2f6e  kyserve/update/n
-00028150: 6577 5f61 7574 6f73 6361 6c65 725f 6265  ew_autoscaler_be
-00028160: 666f 7265 2e79 616d 6c27 2c0a 2020 2020  fore.yaml',.    
-00028170: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
-00028180: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
-00028190: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-000281a0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
-000281b0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
-000281c0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
-000281d0: 7273 696f 6e28 6e61 6d65 2c20 2231 2229  rsion(name, "1")
-000281e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000281f0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
-00028200: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
-00028210: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
-00028220: 2020 2020 2020 2020 2773 3d24 2863 7572          's=$(cur
-00028230: 6c20 6874 7470 3a2f 2f24 656e 6470 6f69  l http://$endpoi
-00028240: 6e74 293b 2065 6368 6f20 2224 7322 3b20  nt); echo "$s"; 
-00028250: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-00028260: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
-00028270: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
-00028280: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
-00028290: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
-000282a0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-000282b0: 6f75 647d 202d 2d6d 6f64 6520 7b6d 6f64  oud} --mode {mod
-000282c0: 657d 202d 7920 7465 7374 732f 736b 7973  e} -y tests/skys
-000282d0: 6572 7665 2f75 7064 6174 652f 6e65 775f  erve/update/new_
-000282e0: 6175 746f 7363 616c 6572 5f61 6674 6572  autoscaler_after
-000282f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00028300: 2020 2020 2320 5761 6974 2066 6f72 2075      # Wait for u
-00028310: 7064 6174 6520 746f 2062 6520 7265 6769  pdate to be regi
-00028320: 7374 6572 6564 0a20 2020 2020 2020 2020  stered.         
-00028330: 2020 2066 2773 6c65 6570 2031 3230 272c     f'sleep 120',
-00028340: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00028350: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
-00028360: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
-00028370: 2020 2020 2020 206e 616d 652c 205b 2834         name, [(4
-00028380: 2c20 5472 7565 2c20 5f53 4552 5649 4345  , True, _SERVICE
-00028390: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-000283a0: 535f 5245 4745 5820 2b20 275c 7c52 4541  S_REGEX + '\|REA
-000283b0: 4459 2729 2c0a 2020 2020 2020 2020 2020  DY'),.          
-000283c0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
-000283d0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
-000283e0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
-000283f0: 535f 5245 4745 5829 2c0a 2020 2020 2020  S_REGEX),.      
-00028400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028410: 2028 322c 2046 616c 7365 2c20 2752 4541   (2, False, 'REA
-00028420: 4459 2729 5d29 2c0a 2020 2020 2020 2020  DY')]),.        
-00028430: 2020 2020 2a75 7064 6174 655f 6368 6563      *update_chec
-00028440: 6b2c 0a20 2020 2020 2020 2020 2020 205f  k,.            _
-00028450: 5345 5256 455f 5741 4954 5f55 4e54 494c  SERVE_WAIT_UNTIL
-00028460: 5f52 4541 4459 2e66 6f72 6d61 7428 6e61  _READY.format(na
-00028470: 6d65 3d6e 616d 652c 2072 6570 6c69 6361  me=name, replica
-00028480: 5f6e 756d 3d35 292c 0a20 2020 2020 2020  _num=5),.       
-00028490: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
-000284a0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
-000284b0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
-000284c0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000284d0: 6375 726c 2068 7474 703a 2f2f 2465 6e64  curl http://$end
-000284e0: 706f 696e 7420 7c20 6772 6570 2022 4869  point | grep "Hi
-000284f0: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
-00028500: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00028510: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
-00028520: 5f73 7461 7475 7328 6e61 6d65 2c20 5b28  _status(name, [(
-00028530: 342c 2054 7275 652c 2027 5245 4144 5927  4, True, 'READY'
-00028540: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00028550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028560: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00028570: 312c 2046 616c 7365 2c20 2752 4541 4459  1, False, 'READY
-00028580: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
-00028590: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-000285a0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-000285b0: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-000285c0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-000285d0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-000285e0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000285f0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00028600: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
-00028610: 745f 736b 7973 6572 7665 5f66 6169 6c75  t_skyserve_failu
-00028620: 7265 7328 6765 6e65 7269 635f 636c 6f75  res(generic_clou
-00028630: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00028640: 5465 7374 2072 6570 6c69 6361 2066 6169  Test replica fai
-00028650: 6c75 7265 2073 7461 7475 7365 7322 2222  lure statuses"""
-00028660: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00028670: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00028680: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00028690: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
-000286a0: 736b 7973 6572 7665 2d66 6169 6c75 7265  skyserve-failure
-000286b0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-000286c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000286d0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
-000286e0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-000286f0: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
-00028700: 7374 732f 736b 7973 6572 7665 2f66 6169  sts/skyserve/fai
-00028710: 6c75 7265 732f 696e 6974 6961 6c5f 6465  lures/initial_de
-00028720: 6c61 792e 7961 6d6c 272c 0a20 2020 2020  lay.yaml',.     
-00028730: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00028740: 2073 6572 7665 2073 7461 7475 7320 7b6e   serve status {n
-00028750: 616d 657d 293b 2027 0a20 2020 2020 2020  ame}); '.       
-00028760: 2020 2020 2066 2775 6e74 696c 2065 6368       f'until ech
-00028770: 6f20 2224 7322 207c 2067 7265 7020 2246  o "$s" | grep "F
-00028780: 4149 4c45 445f 494e 4954 4941 4c5f 4445  AILED_INITIAL_DE
-00028790: 4c41 5922 3b20 646f 2027 0a20 2020 2020  LAY"; do '.     
-000287a0: 2020 2020 2020 2027 6563 686f 2022 5761         'echo "Wa
-000287b0: 6974 696e 6720 666f 7220 7265 706c 6963  iting for replic
-000287c0: 6120 746f 2062 6520 6661 696c 6564 2e2e  a to be failed..
-000287d0: 2e22 3b20 736c 6565 7020 353b 2027 0a20  ."; sleep 5; '. 
-000287e0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-000287f0: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00028800: 7320 7b6e 616d 657d 293b 2065 6368 6f20  s {name}); echo 
-00028810: 2224 7322 3b20 646f 6e65 3b27 2c0a 2020  "$s"; done;',.  
-00028820: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00028830: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-00028840: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
-00028850: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
-00028860: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
-00028870: 2022 2473 2220 7c20 6772 6570 2022 7b6e   "$s" | grep "{n
-00028880: 616d 657d 2220 7c20 6772 6570 2022 4641  ame}" | grep "FA
-00028890: 494c 4544 5f49 4e49 5449 414c 5f44 454c  ILED_INITIAL_DEL
-000288a0: 4159 2220 7c20 7763 202d 6c20 7c20 6772  AY" | wc -l | gr
-000288b0: 6570 2032 3b20 270a 2020 2020 2020 2020  ep 2; '.        
-000288c0: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-000288d0: 6e6f 206e 6577 2072 6570 6c69 6361 7320  no new replicas 
-000288e0: 6172 6520 7374 6172 7465 6420 666f 7220  are started for 
-000288f0: 6561 726c 7920 6661 696c 7572 652e 0a20  early failure.. 
-00028900: 2020 2020 2020 2020 2020 2066 2765 6368             f'ech
-00028910: 6f20 2224 7322 207c 2067 7265 7020 2d41  o "$s" | grep -A
-00028920: 2031 3030 2022 5365 7276 6963 6520 5265   100 "Service Re
-00028930: 706c 6963 6173 2220 7c20 6772 6570 2022  plicas" | grep "
-00028940: 7b6e 616d 657d 2220 7c20 7763 202d 6c20  {name}" | wc -l 
-00028950: 7c20 6772 6570 2032 3b27 2c0a 2020 2020  | grep 2;',.    
-00028960: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00028970: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
-00028980: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-00028990: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
-000289a0: 7473 2f73 6b79 7365 7276 652f 6661 696c  ts/skyserve/fail
-000289b0: 7572 6573 2f70 726f 6269 6e67 2e79 616d  ures/probing.yam
-000289c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000289d0: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
-000289e0: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
-000289f0: 270a 2020 2020 2020 2020 2020 2020 2320  '.            # 
-00028a00: 5761 6974 2066 6f72 2072 6570 6c69 6361  Wait for replica
-00028a10: 2074 6f20 6265 2072 6561 6479 2e0a 2020   to be ready..  
-00028a20: 2020 2020 2020 2020 2020 6627 756e 7469            f'unti
-00028a30: 6c20 6563 686f 2022 2473 2220 7c20 6772  l echo "$s" | gr
-00028a40: 6570 2022 5245 4144 5922 3b20 646f 2027  ep "READY"; do '
-00028a50: 0a20 2020 2020 2020 2020 2020 2027 6563  .            'ec
-00028a60: 686f 2022 5761 6974 696e 6720 666f 7220  ho "Waiting for 
-00028a70: 7265 706c 6963 6120 746f 2062 6520 6661  replica to be fa
-00028a80: 696c 6564 2e2e 2e22 3b20 736c 6565 7020  iled..."; sleep 
-00028a90: 353b 2027 0a20 2020 2020 2020 2020 2020  5; '.           
-00028aa0: 2066 2773 3d24 2873 6b79 2073 6572 7665   f's=$(sky serve
-00028ab0: 2073 7461 7475 7320 7b6e 616d 657d 293b   status {name});
-00028ac0: 2065 6368 6f20 2224 7322 3b20 646f 6e65   echo "$s"; done
-00028ad0: 3b27 2c0a 2020 2020 2020 2020 2020 2020  ;',.            
-00028ae0: 2320 5761 6974 2066 6f72 2072 6570 6c69  # Wait for repli
-00028af0: 6361 2074 6f20 6368 616e 6765 2074 6f20  ca to change to 
-00028b00: 4641 494c 4544 5f50 524f 4249 4e47 0a20  FAILED_PROBING. 
-00028b10: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00028b20: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
-00028b30: 7320 7b6e 616d 657d 293b 2027 0a20 2020  s {name}); '.   
-00028b40: 2020 2020 2020 2020 2066 2775 6e74 696c           f'until
-00028b50: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-00028b60: 7020 2246 4149 4c45 445f 5052 4f42 494e  p "FAILED_PROBIN
-00028b70: 4722 3b20 646f 2027 0a20 2020 2020 2020  G"; do '.       
-00028b80: 2020 2020 2027 6563 686f 2022 5761 6974       'echo "Wait
-00028b90: 696e 6720 666f 7220 7265 706c 6963 6120  ing for replica 
-00028ba0: 746f 2062 6520 6661 696c 6564 2e2e 2e22  to be failed..."
-00028bb0: 3b20 736c 6565 7020 353b 2027 0a20 2020  ; sleep 5; '.   
-00028bc0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00028bd0: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-00028be0: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-00028bf0: 7322 3b20 646f 6e65 3b27 202b 0a20 2020  s"; done;' +.   
-00028c00: 2020 2020 2020 2020 205f 6368 6563 6b5f           _check_
-00028c10: 7265 706c 6963 615f 696e 5f73 7461 7475  replica_in_statu
-00028c20: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00028c30: 2020 206e 616d 652c 205b 2831 2c20 4661     name, [(1, Fa
-00028c40: 6c73 652c 2027 4641 494c 4544 5f50 524f  lse, 'FAILED_PRO
-00028c50: 4249 4e47 2729 2c0a 2020 2020 2020 2020  BING'),.        
-00028c60: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00028c70: 312c 2046 616c 7365 2c20 5f53 4552 5649  1, False, _SERVI
-00028c80: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
-00028c90: 5455 535f 5245 4745 5829 5d29 2c0a 2020  TUS_REGEX)]),.  
-00028ca0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-00028cb0: 287a 6877 7529 3a20 6164 6420 7465 7374  (zhwu): add test
-00028cc0: 2066 6f72 2046 4149 4c45 445f 5052 4f56   for FAILED_PROV
-00028cd0: 4953 494f 4e0a 2020 2020 2020 2020 5d2c  ISION.        ],
-00028ce0: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
-00028cf0: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
-00028d00: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
-00028d10: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00028d20: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00028d30: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00028d40: 7374 290a 0a0a 2320 544f 444f 285a 696d  st)...# TODO(Zim
-00028d50: 696e 672c 2054 6961 6e29 3a20 4164 6420  ing, Tian): Add 
-00028d60: 7465 7374 7320 666f 7220 6175 746f 7363  tests for autosc
-00028d70: 616c 696e 672e 0a0a 0a23 202d 2d2d 2d2d  aling....# -----
-00028d80: 2d2d 2054 6573 7469 6e67 2075 7365 7220  -- Testing user 
-00028d90: 6465 7065 6e64 656e 6369 6573 202d 2d2d  dependencies ---
-00028da0: 2d2d 2d2d 2d0a 6465 6620 7465 7374 5f75  -----.def test_u
-00028db0: 7365 725f 6465 7065 6e64 656e 6369 6573  ser_dependencies
-00028dc0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00028dd0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00028de0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00028df0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00028e00: 5465 7374 280a 2020 2020 2020 2020 2775  Test(.        'u
-00028e10: 7365 722d 6465 7065 6e64 656e 6369 6573  ser-dependencies
-00028e20: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00028e30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00028e40: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00028e50: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-00028e60: 7269 635f 636c 6f75 647d 2022 7069 7020  ric_cloud} "pip 
-00028e70: 696e 7374 616c 6c20 7261 793e 322e 3131  install ray>2.11
-00028e80: 3b20 7261 7920 7374 6172 7420 2d2d 6865  ; ray start --he
-00028e90: 6164 2227 2c0a 2020 2020 2020 2020 2020  ad"',.          
-00028ea0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00028eb0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00028ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00028ed0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00028ee0: 6563 686f 2068 6922 272c 0a20 2020 2020  echo hi"',.     
-00028ef0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00028f00: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-00028f10: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00028f20: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-00028f30: 7220 7b6e 616d 657d 207c 2067 7265 7020  r {name} | grep 
-00028f40: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
-00028f50: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00028f60: 657d 2022 6563 686f 2062 7965 2227 2c0a  e} "echo bye"',.
-00028f70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00028f80: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-00028f90: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00028fa0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00028fb0: 6e63 6820 2d63 207b 6e61 6d65 7d20 7465  nch -c {name} te
-00028fc0: 7374 732f 7465 7374 5f79 616d 6c73 2f64  sts/test_yamls/d
-00028fd0: 6966 6665 7265 6e74 5f64 6566 6175 6c74  ifferent_default
-00028fe0: 5f63 6f6e 6461 5f65 6e76 2e79 616d 6c27  _conda_env.yaml'
-00028ff0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00029000: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00029010: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
-00029020: 2020 2020 2020 2020 2023 204c 6175 6e63           # Launc
-00029030: 6820 6167 6169 6e20 746f 2074 6573 7420  h again to test 
-00029040: 7468 6520 6465 6661 756c 7420 656e 7620  the default env 
-00029050: 646f 6573 206e 6f74 2061 6666 6563 7420  does not affect 
-00029060: 536b 7950 696c 6f74 0a20 2020 2020 2020  SkyPilot.       
-00029070: 2020 2020 2023 2072 756e 7469 6d65 2073       # runtime s
-00029080: 6574 7570 0a20 2020 2020 2020 2020 2020  etup.           
-00029090: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
-000290a0: 207b 6e61 6d65 7d20 2270 7974 686f 6e20   {name} "python 
-000290b0: 2d2d 7665 7273 696f 6e20 323e 2631 207c  --version 2>&1 |
-000290c0: 2067 7265 7020 5c27 5079 7468 6f6e 2033   grep \'Python 3
-000290d0: 2e36 5c27 207c 7c20 6578 6974 2031 2227  .6\' || exit 1"'
-000290e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000290f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00029100: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-00029110: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00029120: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00029130: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00029140: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00029150: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d20  st)...# ------- 
-00029160: 5465 7374 696e 6720 7468 6520 636f 7265  Testing the core
-00029170: 2041 5049 202d 2d2d 2d2d 2d2d 2d0a 2320   API --------.# 
-00029180: 4d6f 7374 206f 6620 7468 6520 636f 7265  Most of the core
-00029190: 2041 5049 7320 6861 7665 2062 6565 6e20   APIs have been 
-000291a0: 7465 7374 6564 2069 6e20 7468 6520 434c  tested in the CL
-000291b0: 4920 7465 7374 732e 0a23 2054 6865 7365  I tests..# These
-000291c0: 2074 6573 7473 2061 7265 2066 6f72 2074   tests are for t
-000291d0: 6573 7469 6e67 2074 6865 2072 6574 7572  esting the retur
-000291e0: 6e20 7661 6c75 6520 6f66 2074 6865 2041  n value of the A
-000291f0: 5049 7320 6e6f 7420 6675 6c6c 7920 7573  PIs not fully us
-00029200: 6564 2069 6e20 434c 492e 0a0a 0a40 7079  ed in CLI....@py
-00029210: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00029220: 6620 7465 7374 5f63 6f72 655f 6170 695f  f test_core_api_
-00029230: 736b 795f 6c61 756e 6368 5f65 7865 6328  sky_launch_exec(
-00029240: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00029250: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00029260: 290a 2020 2020 7461 736b 203d 2073 6b79  ).    task = sky
-00029270: 2e54 6173 6b28 7275 6e3d 2277 686f 616d  .Task(run="whoam
-00029280: 6922 290a 2020 2020 7461 736b 2e73 6574  i").    task.set
-00029290: 5f72 6573 6f75 7263 6573 2873 6b79 2e52  _resources(sky.R
-000292a0: 6573 6f75 7263 6573 2863 6c6f 7564 3d73  esources(cloud=s
-000292b0: 6b79 2e47 4350 2829 2929 0a20 2020 206a  ky.GCP())).    j
-000292c0: 6f62 5f69 642c 2068 616e 646c 6520 3d20  ob_id, handle = 
-000292d0: 736b 792e 6c61 756e 6368 2874 6173 6b2c  sky.launch(task,
-000292e0: 2063 6c75 7374 6572 5f6e 616d 653d 6e61   cluster_name=na
-000292f0: 6d65 290a 2020 2020 6173 7365 7274 206a  me).    assert j
-00029300: 6f62 5f69 6420 3d3d 2031 0a20 2020 2061  ob_id == 1.    a
-00029310: 7373 6572 7420 6861 6e64 6c65 2069 7320  ssert handle is 
-00029320: 6e6f 7420 4e6f 6e65 0a20 2020 2061 7373  not None.    ass
-00029330: 6572 7420 6861 6e64 6c65 2e63 6c75 7374  ert handle.clust
-00029340: 6572 5f6e 616d 6520 3d3d 206e 616d 650a  er_name == name.
-00029350: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
-00029360: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
-00029370: 7263 6573 2e63 6c6f 7564 2e69 735f 7361  rces.cloud.is_sa
-00029380: 6d65 5f63 6c6f 7564 2873 6b79 2e47 4350  me_cloud(sky.GCP
-00029390: 2829 290a 2020 2020 6a6f 625f 6964 5f65  ()).    job_id_e
-000293a0: 7865 632c 2068 616e 646c 655f 6578 6563  xec, handle_exec
-000293b0: 203d 2073 6b79 2e65 7865 6328 7461 736b   = sky.exec(task
-000293c0: 2c20 636c 7573 7465 725f 6e61 6d65 3d6e  , cluster_name=n
-000293d0: 616d 6529 0a20 2020 2061 7373 6572 7420  ame).    assert 
-000293e0: 6a6f 625f 6964 5f65 7865 6320 3d3d 2032  job_id_exec == 2
-000293f0: 0a20 2020 2061 7373 6572 7420 6861 6e64  .    assert hand
-00029400: 6c65 5f65 7865 6320 6973 206e 6f74 204e  le_exec is not N
-00029410: 6f6e 650a 2020 2020 6173 7365 7274 2068  one.    assert h
-00029420: 616e 646c 655f 6578 6563 2e63 6c75 7374  andle_exec.clust
-00029430: 6572 5f6e 616d 6520 3d3d 206e 616d 650a  er_name == name.
-00029440: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
-00029450: 655f 6578 6563 2e6c 6175 6e63 6865 645f  e_exec.launched_
-00029460: 7265 736f 7572 6365 732e 636c 6f75 642e  resources.cloud.
-00029470: 6973 5f73 616d 655f 636c 6f75 6428 736b  is_same_cloud(sk
-00029480: 792e 4743 5028 2929 0a20 2020 2023 2046  y.GCP()).    # F
-00029490: 6f72 2064 756d 6d79 2074 6173 6b20 2869  or dummy task (i
-000294a0: 2e65 2e20 7461 736b 2e72 756e 2069 7320  .e. task.run is 
-000294b0: 4e6f 6e65 292c 2074 6865 206a 6f62 2077  None), the job w
-000294c0: 6f6e 2774 2062 6520 7375 626d 6974 7465  on't be submitte
-000294d0: 642e 0a20 2020 2064 756d 6d79 5f74 6173  d..    dummy_tas
-000294e0: 6b20 3d20 736b 792e 5461 736b 2829 0a20  k = sky.Task(). 
-000294f0: 2020 206a 6f62 5f69 645f 6475 6d6d 792c     job_id_dummy,
-00029500: 205f 203d 2073 6b79 2e65 7865 6328 6475   _ = sky.exec(du
-00029510: 6d6d 795f 7461 736b 2c20 636c 7573 7465  mmy_task, cluste
-00029520: 725f 6e61 6d65 3d6e 616d 6529 0a20 2020  r_name=name).   
-00029530: 2061 7373 6572 7420 6a6f 625f 6964 5f64   assert job_id_d
-00029540: 756d 6d79 2069 7320 4e6f 6e65 0a20 2020  ummy is None.   
-00029550: 2073 6b79 2e64 6f77 6e28 6e61 6d65 290a   sky.down(name).
-00029560: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-00029570: 6573 7469 6e67 2053 746f 7261 6765 202d  esting Storage -
-00029580: 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173 7320  ---------.class 
-00029590: 5465 7374 5374 6f72 6167 6557 6974 6843  TestStorageWithC
-000295a0: 7265 6465 6e74 6961 6c73 3a0a 2020 2020  redentials:.    
-000295b0: 2222 2253 746f 7261 6765 2074 6573 7473  """Storage tests
-000295c0: 2077 6869 6368 2072 6571 7569 7265 2063   which require c
-000295d0: 7265 6465 6e74 6961 6c73 2061 6e64 206e  redentials and n
-000295e0: 6574 776f 726b 2063 6f6e 6e65 6374 696f  etwork connectio
-000295f0: 6e22 2222 0a0a 2020 2020 4157 535f 494e  n"""..    AWS_IN
-00029600: 5641 4c49 445f 4e41 4d45 5320 3d20 5b0a  VALID_NAMES = [.
-00029610: 2020 2020 2020 2020 2761 6227 2c20 2023          'ab',  #
-00029620: 206c 6573 7320 7468 616e 2033 2063 6861   less than 3 cha
-00029630: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00029640: 2761 6263 6465 6667 6869 6a6b 6c6d 6e6f  'abcdefghijklmno
-00029650: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
-00029660: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00029670: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00029680: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
-00029690: 272c 0a20 2020 2020 2020 2023 206d 6f72  ',.        # mor
-000296a0: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
-000296b0: 7465 7273 0a20 2020 2020 2020 2027 4162  ters.        'Ab
-000296c0: 6364 6566 272c 2020 2320 636f 6e74 6169  cdef',  # contai
-000296d0: 6e73 2061 6e20 7570 7065 7263 6173 6520  ns an uppercase 
-000296e0: 6c65 7474 6572 0a20 2020 2020 2020 2027  letter.        '
-000296f0: 6162 6320 6465 6627 2c20 2023 2063 6f6e  abc def',  # con
-00029700: 7461 696e 7320 6120 7370 6163 650a 2020  tains a space.  
-00029710: 2020 2020 2020 2761 6263 2e2e 6465 6627        'abc..def'
-00029720: 2c20 2023 2074 776f 2061 646a 6163 656e  ,  # two adjacen
-00029730: 7420 7065 7269 6f64 730a 2020 2020 2020  t periods.      
-00029740: 2020 2731 3932 2e31 3638 2e35 2e34 272c    '192.168.5.4',
-00029750: 2020 2320 666f 726d 6174 7465 6420 6173    # formatted as
-00029760: 2061 6e20 4950 2061 6464 7265 7373 0a20   an IP address. 
-00029770: 2020 2020 2020 2027 786e 2d2d 6275 636b         'xn--buck
-00029780: 6574 272c 2020 2320 7374 6172 7473 2077  et',  # starts w
-00029790: 6974 6820 2778 6e2d 2d27 2070 7265 6669  ith 'xn--' prefi
-000297a0: 780a 2020 2020 2020 2020 2762 7563 6b65  x.        'bucke
-000297b0: 742d 7333 616c 6961 7327 2c20 2023 2065  t-s3alias',  # e
-000297c0: 6e64 7320 7769 7468 2027 2d73 3361 6c69  nds with '-s3ali
-000297d0: 6173 2720 7375 6666 6978 0a20 2020 2020  as' suffix.     
-000297e0: 2020 2027 6275 636b 6574 2d2d 6f6c 2d73     'bucket--ol-s
-000297f0: 3327 2c20 2023 2065 6e64 7320 7769 7468  3',  # ends with
-00029800: 2027 2d2d 6f6c 2d73 3327 2073 7566 6669   '--ol-s3' suffi
-00029810: 780a 2020 2020 2020 2020 272e 6162 6327  x.        '.abc'
-00029820: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
-00029830: 2061 2064 6f74 0a20 2020 2020 2020 2027   a dot.        '
-00029840: 6162 632e 272c 2020 2320 656e 6473 2077  abc.',  # ends w
-00029850: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
-00029860: 2020 272d 6162 6327 2c20 2023 2073 7461    '-abc',  # sta
-00029870: 7274 7320 7769 7468 2061 2068 7970 6865  rts with a hyphe
-00029880: 6e0a 2020 2020 2020 2020 2761 6263 2d27  n.        'abc-'
-00029890: 2c20 2023 2065 6e64 7320 7769 7468 2061  ,  # ends with a
-000298a0: 2068 7970 6865 6e0a 2020 2020 5d0a 0a20   hyphen.    ].. 
-000298b0: 2020 2047 4353 5f49 4e56 414c 4944 5f4e     GCS_INVALID_N
-000298c0: 414d 4553 203d 205b 0a20 2020 2020 2020  AMES = [.       
-000298d0: 2027 6162 272c 2020 2320 6c65 7373 2074   'ab',  # less t
-000298e0: 6861 6e20 3320 6368 6172 6163 7465 7273  han 3 characters
-000298f0: 0a20 2020 2020 2020 2027 6162 6364 6566  .        'abcdef
-00029900: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-00029910: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
-00029920: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-00029930: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-00029940: 7374 7576 7778 797a 3127 2c0a 2020 2020  stuvwxyz1',.    
-00029950: 2020 2020 2320 6d6f 7265 2074 6861 6e20      # more than 
-00029960: 3633 2063 6861 7261 6374 6572 7320 2877  63 characters (w
-00029970: 6974 686f 7574 2064 6f74 7329 0a20 2020  ithout dots).   
-00029980: 2020 2020 2027 4162 6364 6566 272c 2020       'Abcdef',  
-00029990: 2320 636f 6e74 6169 6e73 2061 6e20 7570  # contains an up
-000299a0: 7065 7263 6173 6520 6c65 7474 6572 0a20  percase letter. 
-000299b0: 2020 2020 2020 2027 6162 6320 6465 6627         'abc def'
-000299c0: 2c20 2023 2063 6f6e 7461 696e 7320 6120  ,  # contains a 
-000299d0: 7370 6163 650a 2020 2020 2020 2020 2761  space.        'a
-000299e0: 6263 2e2e 6465 6627 2c20 2023 2074 776f  bc..def',  # two
-000299f0: 2061 646a 6163 656e 7420 7065 7269 6f64   adjacent period
-00029a00: 730a 2020 2020 2020 2020 2761 6263 5f2e  s.        'abc_.
-00029a10: 6465 662e 6768 692e 6a6b 6c6d 6e6f 7071  def.ghi.jklmnopq
-00029a20: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00029a30: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00029a40: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-00029a50: 6e6f 7071 7273 7475 7677 7879 7a31 270a  nopqrstuvwxyz1'.
-00029a60: 2020 2020 2020 2020 2320 4d6f 7265 2074          # More t
-00029a70: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
-00029a80: 7320 6265 7477 6565 6e20 646f 7473 0a20  s between dots. 
-00029a90: 2020 2020 2020 2027 6162 635f 2e64 6566         'abc_.def
-00029aa0: 2e67 6869 2e6a 6b6c 6d6e 6f70 7172 7374  .ghi.jklmnopqrst
-00029ab0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00029ac0: 6b6c 6d6e 6f70 7166 6768 696a 6b6c 6d6e  klmnopqfghijklmn
-00029ad0: 6f70 7172 7374 7576 7727 202a 2035 2c0a  opqrstuvw' * 5,.
-00029ae0: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
-00029af0: 6861 6e20 3232 3220 6368 6172 6163 7465  han 222 characte
-00029b00: 7273 2028 7769 7468 2064 6f74 7329 0a20  rs (with dots). 
-00029b10: 2020 2020 2020 2027 3139 322e 3136 382e         '192.168.
-00029b20: 352e 3427 2c20 2023 2066 6f72 6d61 7474  5.4',  # formatt
-00029b30: 6564 2061 7320 616e 2049 5020 6164 6472  ed as an IP addr
-00029b40: 6573 730a 2020 2020 2020 2020 2767 6f6f  ess.        'goo
-00029b50: 6762 7563 6b65 7427 2c20 2023 2073 7461  gbucket',  # sta
-00029b60: 7274 7320 7769 7468 2027 676f 6f67 2720  rts with 'goog' 
-00029b70: 7072 6566 6978 0a20 2020 2020 2020 2027  prefix.        '
-00029b80: 676f 6f67 6c65 6275 636b 6574 272c 2020  googlebucket',  
-00029b90: 2320 636f 6e74 6169 6e73 2027 676f 6f67  # contains 'goog
-00029ba0: 6c65 270a 2020 2020 2020 2020 2767 3030  le'.        'g00
-00029bb0: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
-00029bc0: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
-00029bd0: 6527 0a20 2020 2020 2020 2027 676f 3067  e'.        'go0g
-00029be0: 6c65 6275 636b 6574 272c 2020 2320 7661  lebucket',  # va
-00029bf0: 7269 616e 7420 6f66 2027 676f 6f67 6c65  riant of 'google
-00029c00: 270a 2020 2020 2020 2020 2767 306f 676c  '.        'g0ogl
-00029c10: 6562 7563 6b65 7427 2c20 2023 2076 6172  ebucket',  # var
-00029c20: 6961 6e74 206f 6620 2767 6f6f 676c 6527  iant of 'google'
-00029c30: 0a20 2020 2020 2020 2027 2e61 6263 272c  .        '.abc',
-00029c40: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-00029c50: 6120 646f 740a 2020 2020 2020 2020 2761  a dot.        'a
-00029c60: 6263 2e27 2c20 2023 2065 6e64 7320 7769  bc.',  # ends wi
-00029c70: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00029c80: 2027 5f61 6263 272c 2020 2320 7374 6172   '_abc',  # star
-00029c90: 7473 2077 6974 6820 616e 2075 6e64 6572  ts with an under
-00029ca0: 7363 6f72 650a 2020 2020 2020 2020 2761  score.        'a
-00029cb0: 6263 5f27 2c20 2023 2065 6e64 7320 7769  bc_',  # ends wi
-00029cc0: 7468 2061 6e20 756e 6465 7273 636f 7265  th an underscore
-00029cd0: 0a20 2020 205d 0a0a 2020 2020 4942 4d5f  .    ]..    IBM_
-00029ce0: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
-00029cf0: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
-00029d00: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
-00029d10: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
-00029d20: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
-00029d30: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-00029d40: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00029d50: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00029d60: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00029d70: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
-00029d80: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
-00029d90: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
-00029da0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-00029db0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-00029dc0: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-00029dd0: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-00029de0: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-00029df0: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-00029e00: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-00029e10: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-00029e20: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
-00029e30: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
-00029e40: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
-00029e50: 0a20 2020 2020 2020 2027 786e 2d2d 6275  .        'xn--bu
-00029e60: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
-00029e70: 2077 6974 6820 2778 6e2d 2d27 2070 7265   with 'xn--' pre
-00029e80: 6669 780a 2020 2020 2020 2020 272e 6162  fix.        '.ab
-00029e90: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00029ea0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00029eb0: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-00029ec0: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00029ed0: 2020 2020 272d 6162 6327 2c20 2023 2073      '-abc',  # s
-00029ee0: 7461 7274 7320 7769 7468 2061 2068 7970  tarts with a hyp
-00029ef0: 6865 6e0a 2020 2020 2020 2020 2761 6263  hen.        'abc
-00029f00: 2d27 2c20 2023 2065 6e64 7320 7769 7468  -',  # ends with
-00029f10: 2061 2068 7970 6865 6e0a 2020 2020 2020   a hyphen.      
-00029f20: 2020 2761 2e2d 6263 272c 2020 2320 636f    'a.-bc',  # co
-00029f30: 6e74 6169 6e73 2074 6865 2073 6571 7565  ntains the seque
-00029f40: 6e63 6520 272e 2d27 0a20 2020 2020 2020  nce '.-'.       
-00029f50: 2027 612d 2e62 6327 2c20 2023 2063 6f6e   'a-.bc',  # con
-00029f60: 7461 696e 7320 7468 6520 7365 7175 656e  tains the sequen
-00029f70: 6365 2027 2d2e 270a 2020 2020 2020 2020  ce '-.'.        
-00029f80: 2761 2662 6327 2020 2320 636f 6e74 6169  'a&bc'  # contai
-00029f90: 6e73 2073 7065 6369 616c 2063 6861 7261  ns special chara
-00029fa0: 6374 6572 730a 2020 2020 2020 2020 2761  cters.        'a
-00029fb0: 625e 6327 2020 2320 636f 6e74 6169 6e73  b^c'  # contains
-00029fc0: 2073 7065 6369 616c 2063 6861 7261 6374   special charact
-00029fd0: 6572 730a 2020 2020 5d0a 2020 2020 4749  ers.    ].    GI
-00029fe0: 5449 474e 4f52 455f 5359 4e43 5f54 4553  TIGNORE_SYNC_TES
-00029ff0: 545f 4449 525f 5354 5255 4354 5552 4520  T_DIR_STRUCTURE 
-0002a000: 3d20 7b0a 2020 2020 2020 2020 2764 6f75  = {.        'dou
-0002a010: 626c 655f 6173 7465 7269 736b 273a 207b  ble_asterisk': {
-0002a020: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-0002a030: 7562 6c65 5f61 7374 6572 6973 6b5f 6578  uble_asterisk_ex
-0002a040: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-0002a050: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
-0002a060: 6c65 5f61 7374 6572 6973 6b5f 6578 636c  le_asterisk_excl
-0002a070: 7564 6564 5f64 6972 273a 207b 0a20 2020  uded_dir': {.   
-0002a080: 2020 2020 2020 2020 2020 2020 2027 6469               'di
-0002a090: 725f 6578 636c 7564 6564 273a 204e 6f6e  r_excluded': Non
-0002a0a0: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
-0002a0b0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
-0002a0c0: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-0002a0d0: 6572 6973 6b5f 7061 7265 6e74 273a 207b  erisk_parent': {
-0002a0e0: 0a20 2020 2020 2020 2020 2020 2027 7061  .            'pa
-0002a0f0: 7265 6e74 273a 207b 0a20 2020 2020 2020  rent': {.       
-0002a100: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
-0002a110: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-0002a120: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-0002a130: 2020 2020 2763 6869 6c64 273a 207b 0a20      'child': {. 
-0002a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a150: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
-0002a160: 6973 6b5f 7061 7265 6e74 5f63 6869 6c64  isk_parent_child
-0002a170: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-0002a180: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002a190: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0002a1a0: 2020 2020 2020 2020 2027 646f 7562 6c65           'double
-0002a1b0: 5f61 7374 6572 6973 6b5f 7061 7265 6e74  _asterisk_parent
-0002a1c0: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-0002a1d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002a1e0: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
-0002a1f0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-0002a200: 642e 6c6f 6727 3a20 4e6f 6e65 2c0a 2020  d.log': None,.  
-0002a210: 2020 2020 2020 2765 7863 6c75 6465 645f        'excluded_
-0002a220: 6469 7227 3a20 7b0a 2020 2020 2020 2020  dir': {.        
-0002a230: 2020 2020 2765 7863 6c75 6465 642e 7478      'excluded.tx
-0002a240: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
-0002a250: 2020 2020 2020 276e 6573 7465 645f 6578        'nested_ex
-0002a260: 636c 7564 6564 273a 207b 0a20 2020 2020  cluded': {.     
-0002a270: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
-0002a280: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-0002a290: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0002a2a0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-0002a2b0: 6578 702d 3127 3a20 7b0a 2020 2020 2020  exp-1': {.      
-0002a2c0: 2020 2020 2020 2762 655f 6578 636c 7564        'be_exclud
-0002a2d0: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
-0002a2e0: 2020 207d 2c0a 2020 2020 2020 2020 2765     },.        'e
-0002a2f0: 7870 2d32 273a 207b 0a20 2020 2020 2020  xp-2': {.       
-0002a300: 2020 2020 2027 6265 5f65 7863 6c75 6465       'be_exclude
-0002a310: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
-0002a320: 2020 7d2c 0a20 2020 2020 2020 2027 6672    },.        'fr
-0002a330: 6f6e 745f 736c 6173 685f 6578 636c 7564  ont_slash_exclud
-0002a340: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
-0002a350: 2020 2027 696e 636c 7564 6564 2e6c 6f67     'included.log
-0002a360: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-0002a370: 2027 696e 636c 7564 6564 2e74 7874 273a   'included.txt':
-0002a380: 204e 6f6e 652c 0a20 2020 2020 2020 2027   None,.        '
-0002a390: 696e 636c 7564 655f 6469 7227 3a20 7b0a  include_dir': {.
-0002a3a0: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
-0002a3b0: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
-0002a3c0: 2c0a 2020 2020 2020 2020 2020 2020 2769  ,.            'i
-0002a3d0: 6e63 6c75 6465 642e 6c6f 6727 3a20 4e6f  ncluded.log': No
-0002a3e0: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
-0002a3f0: 2020 2020 2020 2027 6e65 7374 6564 5f64         'nested_d
-0002a400: 6f75 626c 655f 6173 7465 7269 736b 273a  ouble_asterisk':
-0002a410: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-0002a420: 6f6e 6527 3a20 7b0a 2020 2020 2020 2020  one': {.        
-0002a430: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-0002a440: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
-0002a450: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-0002a460: 0a20 2020 2020 2020 2020 2020 2027 7477  .            'tw
-0002a470: 6f27 3a20 7b0a 2020 2020 2020 2020 2020  o': {.          
-0002a480: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
-0002a490: 7564 652e 7478 7427 3a20 4e6f 6e65 2c0a  ude.txt': None,.
-0002a4a0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-0002a4b0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0002a4c0: 2020 276e 6573 7465 645f 7769 6c64 6361    'nested_wildca
-0002a4d0: 7264 5f64 6972 273a 207b 0a20 2020 2020  rd_dir': {.     
-0002a4e0: 2020 2020 2020 2027 6d6f 6e64 6179 273a         'monday':
-0002a4f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0002a500: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
-0002a510: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-0002a520: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0002a530: 2020 2020 2020 2020 2774 7565 7364 6179          'tuesday
-0002a540: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-0002a550: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-0002a560: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
-0002a570: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-0002a580: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0002a590: 2027 6e6f 5f73 6c61 7368 5f65 7863 6c75   'no_slash_exclu
-0002a5a0: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
-0002a5b0: 2020 2020 276e 6f5f 736c 6173 685f 7465      'no_slash_te
-0002a5c0: 7374 7327 3a20 7b0a 2020 2020 2020 2020  sts': {.        
-0002a5d0: 2020 2020 276e 6f5f 736c 6173 685f 6578      'no_slash_ex
-0002a5e0: 636c 7564 6564 273a 207b 0a20 2020 2020  cluded': {.     
-0002a5f0: 2020 2020 2020 2020 2020 2027 616c 736f             'also
-0002a600: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-0002a610: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002a620: 2020 7d2c 0a20 2020 2020 2020 207d 2c0a    },.        },.
-0002a630: 2020 2020 2020 2020 2771 7565 7374 696f          'questio
-0002a640: 6e5f 6d61 726b 273a 207b 0a20 2020 2020  n_mark': {.     
-0002a650: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-0002a660: 312e 7478 7427 3a20 4e6f 6e65 2c0a 2020  1.txt': None,.  
-0002a670: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-0002a680: 6465 6440 2e74 7874 273a 204e 6f6e 652c  ded@.txt': None,
-0002a690: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-0002a6a0: 2020 2020 2773 7175 6172 655f 6272 6163      'square_brac
-0002a6b0: 6b65 7427 3a20 7b0a 2020 2020 2020 2020  ket': {.        
-0002a6c0: 2020 2020 2765 7863 6c75 6465 6431 2e74      'excluded1.t
-0002a6d0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-0002a6e0: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
-0002a6f0: 7175 6172 655f 6272 6163 6b65 745f 616c  quare_bracket_al
-0002a700: 7068 6127 3a20 7b0a 2020 2020 2020 2020  pha': {.        
-0002a710: 2020 2020 2765 7863 6c75 6465 647a 2e74      'excludedz.t
-0002a720: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-0002a730: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
-0002a740: 7175 6172 655f 6272 6163 6b65 745f 6578  quare_bracket_ex
-0002a750: 636c 6127 3a20 7b0a 2020 2020 2020 2020  cla': {.        
-0002a760: 2020 2020 2765 7863 6c75 6465 6432 2e74      'excluded2.t
-0002a770: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-0002a780: 2020 2020 2020 2027 6578 636c 7564 6564         'excluded
-0002a790: 402e 7478 7427 3a20 4e6f 6e65 2c0a 2020  @.txt': None,.  
-0002a7a0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-0002a7b0: 2027 7371 7561 7265 5f62 7261 636b 6574   'square_bracket
-0002a7c0: 5f73 696e 676c 6527 3a20 7b0a 2020 2020  _single': {.    
-0002a7d0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-0002a7e0: 6430 2e74 7874 273a 204e 6f6e 652c 0a20  d0.txt': None,. 
-0002a7f0: 2020 2020 2020 207d 2c0a 2020 2020 7d0a         },.    }.
-0002a800: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-0002a810: 6f64 0a20 2020 2064 6566 2063 7265 6174  od.    def creat
-0002a820: 655f 6469 725f 7374 7275 6374 7572 6528  e_dir_structure(
-0002a830: 6261 7365 5f70 6174 682c 2073 7472 7563  base_path, struc
-0002a840: 7475 7265 293a 0a20 2020 2020 2020 2023  ture):.        #
-0002a850: 2063 7265 6174 6573 2061 2067 6976 656e   creates a given
-0002a860: 2066 696c 6520 5354 5255 4354 5552 4520   file STRUCTURE 
-0002a870: 696e 2042 4153 455f 5041 5448 0a20 2020  in BASE_PATH.   
-0002a880: 2020 2020 2066 6f72 206e 616d 652c 2073       for name, s
-0002a890: 7562 7374 7275 6374 7572 6520 696e 2073  ubstructure in s
-0002a8a0: 7472 7563 7475 7265 2e69 7465 6d73 2829  tructure.items()
-0002a8b0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-0002a8c0: 7468 203d 206f 732e 7061 7468 2e6a 6f69  th = os.path.joi
-0002a8d0: 6e28 6261 7365 5f70 6174 682c 206e 616d  n(base_path, nam
-0002a8e0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-0002a8f0: 6620 7375 6273 7472 7563 7475 7265 2069  f substructure i
-0002a900: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0002a910: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002a920: 2061 2066 696c 650a 2020 2020 2020 2020   a file.        
-0002a930: 2020 2020 2020 2020 6f70 656e 2870 6174          open(pat
-0002a940: 682c 2027 6127 2c20 656e 636f 6469 6e67  h, 'a', encoding
-0002a950: 3d27 7574 662d 3827 292e 636c 6f73 6528  ='utf-8').close(
-0002a960: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0002a970: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002a980: 2020 2020 2320 4372 6561 7465 2061 2073      # Create a s
-0002a990: 7562 6469 7265 6374 6f72 790a 2020 2020  ubdirectory.    
-0002a9a0: 2020 2020 2020 2020 2020 2020 6f73 2e6d              os.m
-0002a9b0: 6b64 6972 2870 6174 6829 0a20 2020 2020  kdir(path).     
-0002a9c0: 2020 2020 2020 2020 2020 2054 6573 7453             TestS
-0002a9d0: 746f 7261 6765 5769 7468 4372 6564 656e  torageWithCreden
-0002a9e0: 7469 616c 732e 6372 6561 7465 5f64 6972  tials.create_dir
-0002a9f0: 5f73 7472 7563 7475 7265 280a 2020 2020  _structure(.    
-0002aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa10: 7061 7468 2c20 7375 6273 7472 7563 7475  path, substructu
-0002aa20: 7265 290a 0a20 2020 2040 7374 6174 6963  re)..    @static
-0002aa30: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
-0002aa40: 6c69 5f64 656c 6574 655f 636d 6428 7374  li_delete_cmd(st
-0002aa50: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-0002aa60: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
-0002aa70: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-0002aa80: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0002aa90: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
-0002aaa0: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-0002aab0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-0002aac0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-0002aad0: 6574 7572 6e20 6627 6177 7320 7333 2072  eturn f'aws s3 r
-0002aae0: 6220 7b75 726c 7d20 2d2d 666f 7263 6527  b {url} --force'
-0002aaf0: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
-0002ab00: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-0002ab10: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002ab20: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
-0002ab30: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
-0002ab40: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-0002ab50: 2020 2020 2020 2020 2067 7375 7469 6c5f           gsutil_
-0002ab60: 616c 6961 732c 2061 6c69 6173 5f67 656e  alias, alias_gen
-0002ab70: 203d 2064 6174 615f 7574 696c 732e 6765   = data_utils.ge
-0002ab80: 745f 6773 7574 696c 5f63 6f6d 6d61 6e64  t_gsutil_command
-0002ab90: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-0002aba0: 6574 7572 6e20 6627 7b61 6c69 6173 5f67  eturn f'{alias_g
-0002abb0: 656e 7d3b 207b 6773 7574 696c 5f61 6c69  en}; {gsutil_ali
-0002abc0: 6173 7d20 726d 202d 7220 7b75 726c 7d27  as} rm -r {url}'
-0002abd0: 0a20 2020 2020 2020 2069 6620 7374 6f72  .        if stor
-0002abe0: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-0002abf0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002ac00: 5232 3a0a 2020 2020 2020 2020 2020 2020  R2:.            
-0002ac10: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
-0002ac20: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
-0002ac30: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
-0002ac40: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
-0002ac50: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-0002ac60: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-0002ac70: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
-0002ac80: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-0002ac90: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-0002aca0: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-0002acb0: 5041 5448 7d20 6177 7320 7333 2072 6220  PATH} aws s3 rb 
-0002acc0: 7b75 726c 7d20 2d2d 666f 7263 6520 2d2d  {url} --force --
-0002acd0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0002ace0: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0002acf0: 653d 7232 270a 2020 2020 2020 2020 6966  e=r2'.        if
-0002ad00: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-0002ad10: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002ad20: 5479 7065 2e49 424d 3a0a 2020 2020 2020  Type.IBM:.      
-0002ad30: 2020 2020 2020 6275 636b 6574 5f72 636c        bucket_rcl
-0002ad40: 6f6e 655f 7072 6f66 696c 6520 3d20 5263  one_profile = Rc
-0002ad50: 6c6f 6e65 2e67 656e 6572 6174 655f 7263  lone.generate_rc
-0002ad60: 6c6f 6e65 5f62 7563 6b65 745f 7072 6f66  lone_bucket_prof
-0002ad70: 696c 655f 6e61 6d65 280a 2020 2020 2020  ile_name(.      
-0002ad80: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
-0002ad90: 5f6e 616d 652c 2052 636c 6f6e 652e 5263  _name, Rclone.Rc
-0002ada0: 6c6f 6e65 436c 6f75 6473 2e49 424d 290a  loneClouds.IBM).
-0002adb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002adc0: 726e 2066 2772 636c 6f6e 6520 7075 7267  rn f'rclone purg
-0002add0: 6520 7b62 7563 6b65 745f 7263 6c6f 6e65  e {bucket_rclone
-0002ade0: 5f70 726f 6669 6c65 7d3a 7b62 7563 6b65  _profile}:{bucke
-0002adf0: 745f 6e61 6d65 7d20 2626 2072 636c 6f6e  t_name} && rclon
-0002ae00: 6520 636f 6e66 6967 2064 656c 6574 6520  e config delete 
-0002ae10: 7b62 7563 6b65 745f 7263 6c6f 6e65 5f70  {bucket_rclone_p
-0002ae20: 726f 6669 6c65 7d27 0a0a 2020 2020 4073  rofile}'..    @s
-0002ae30: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-0002ae40: 6465 6620 636c 695f 6c73 5f63 6d64 2873  def cli_ls_cmd(s
-0002ae50: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
-0002ae60: 745f 6e61 6d65 2c20 7375 6666 6978 3d27  t_name, suffix='
-0002ae70: 2729 3a0a 2020 2020 2020 2020 6966 2073  '):.        if s
-0002ae80: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-0002ae90: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002aea0: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
-0002aeb0: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
-0002aec0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-0002aed0: 6c20 3d20 6627 7333 3a2f 2f7b 6275 636b  l = f's3://{buck
-0002aee0: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
-0002aef0: 7d27 0a20 2020 2020 2020 2020 2020 2065  }'.            e
-0002af00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002af10: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
-0002af20: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
-0002af30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002af40: 7572 6e20 6627 6177 7320 7333 206c 7320  urn f'aws s3 ls 
-0002af50: 7b75 726c 7d27 0a20 2020 2020 2020 2069  {url}'.        i
-0002af60: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0002af70: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002af80: 6554 7970 652e 4743 533a 0a20 2020 2020  eType.GCS:.     
-0002af90: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
-0002afa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002afb0: 2020 7572 6c20 3d20 6627 6773 3a2f 2f7b    url = f'gs://{
-0002afc0: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
-0002afd0: 6666 6978 7d27 0a20 2020 2020 2020 2020  ffix}'.         
-0002afe0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002aff0: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-0002b000: 2767 733a 2f2f 7b62 7563 6b65 745f 6e61  'gs://{bucket_na
-0002b010: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
-0002b020: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
-0002b030: 206c 7320 7b75 726c 7d27 0a20 2020 2020   ls {url}'.     
-0002b040: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
-0002b050: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-0002b060: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
-0002b070: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
-0002b080: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
-0002b090: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
-0002b0a0: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
-0002b0b0: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
-0002b0c0: 2020 2020 2020 2020 2020 2020 2075 726c               url
-0002b0d0: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
-0002b0e0: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
-0002b0f0: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-0002b100: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002b110: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
-0002b120: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-0002b130: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002b140: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
-0002b150: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-0002b160: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-0002b170: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-0002b180: 7d20 6177 7320 7333 206c 7320 7b75 726c  } aws s3 ls {url
-0002b190: 7d20 2d2d 656e 6470 6f69 6e74 207b 656e  } --endpoint {en
-0002b1a0: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
-0002b1b0: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
-0002b1c0: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-0002b1d0: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-0002b1e0: 746f 7265 5479 7065 2e49 424d 3a0a 2020  toreType.IBM:.  
-0002b1f0: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
-0002b200: 5f72 636c 6f6e 655f 7072 6f66 696c 6520  _rclone_profile 
-0002b210: 3d20 5263 6c6f 6e65 2e67 656e 6572 6174  = Rclone.generat
-0002b220: 655f 7263 6c6f 6e65 5f62 7563 6b65 745f  e_rclone_bucket_
-0002b230: 7072 6f66 696c 655f 6e61 6d65 280a 2020  profile_name(.  
-0002b240: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-0002b250: 636b 6574 5f6e 616d 652c 2052 636c 6f6e  cket_name, Rclon
-0002b260: 652e 5263 6c6f 6e65 436c 6f75 6473 2e49  e.RcloneClouds.I
-0002b270: 424d 290a 2020 2020 2020 2020 2020 2020  BM).            
-0002b280: 7265 7475 726e 2066 2772 636c 6f6e 6520  return f'rclone 
-0002b290: 6c73 207b 6275 636b 6574 5f72 636c 6f6e  ls {bucket_rclon
-0002b2a0: 655f 7072 6f66 696c 657d 3a7b 6275 636b  e_profile}:{buck
-0002b2b0: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
-0002b2c0: 7d27 0a0a 2020 2020 4073 7461 7469 636d  }'..    @staticm
-0002b2d0: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
-0002b2e0: 695f 7265 6769 6f6e 5f63 6d64 2873 746f  i_region_cmd(sto
-0002b2f0: 7265 5f74 7970 652c 2062 7563 6b65 745f  re_type, bucket_
-0002b300: 6e61 6d65 293a 0a20 2020 2020 2020 2069  name):.        i
-0002b310: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0002b320: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002b330: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
-0002b340: 2020 2020 2020 7265 7475 726e 2028 2761        return ('a
-0002b350: 7773 2073 3361 7069 2067 6574 2d62 7563  ws s3api get-buc
-0002b360: 6b65 742d 6c6f 6361 7469 6f6e 2027 0a20  ket-location '. 
-0002b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b380: 2020 2066 272d 2d62 7563 6b65 7420 7b62     f'--bucket {b
-0002b390: 7563 6b65 745f 6e61 6d65 7d20 2d2d 6f75  ucket_name} --ou
-0002b3a0: 7470 7574 2074 6578 7427 290a 2020 2020  tput text').    
-0002b3b0: 2020 2020 656c 6966 2073 746f 7265 5f74      elif store_t
-0002b3c0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-0002b3d0: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-0002b3e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002b3f0: 7475 726e 2028 6627 6773 7574 696c 206c  turn (f'gsutil l
-0002b400: 7320 2d4c 202d 6220 6773 3a2f 2f7b 6275  s -L -b gs://{bu
-0002b410: 636b 6574 5f6e 616d 657d 2f20 7c20 270a  cket_name}/ | '.
-0002b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b430: 2020 2020 2767 7265 7020 224c 6f63 6174      'grep "Locat
-0002b440: 696f 6e20 636f 6e73 7472 6169 6e74 2220  ion constraint" 
-0002b450: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
-0002b460: 2020 2020 2020 2020 2761 776b 205c 277b          'awk \'{
-0002b470: 7072 696e 7420 746f 6c6f 7765 7228 244e  print tolower($N
-0002b480: 4629 7d5c 2727 290a 2020 2020 2020 2020  F)}\'').        
-0002b490: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002b4a0: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
-0002b4b0: 6d65 6e74 6564 4572 726f 7228 6627 5265  mentedError(f'Re
-0002b4c0: 6769 6f6e 2063 6f6d 6d61 6e64 206e 6f74  gion command not
-0002b4d0: 2069 6d70 6c65 6d65 6e74 6564 2066 6f72   implemented for
-0002b4e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b500: 2020 2020 2020 2020 2066 277b 7374 6f72           f'{stor
-0002b510: 655f 7479 7065 7d27 290a 0a20 2020 2040  e_type}')..    @
-0002b520: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-0002b530: 2064 6566 2063 6c69 5f63 6f75 6e74 5f6e   def cli_count_n
-0002b540: 616d 655f 696e 5f62 7563 6b65 7428 7374  ame_in_bucket(st
-0002b550: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
-0002b560: 5f6e 616d 652c 2066 696c 655f 6e61 6d65  _name, file_name
-0002b570: 2c20 7375 6666 6978 3d27 2729 3a0a 2020  , suffix=''):.  
-0002b580: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-0002b590: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-0002b5a0: 6962 2e53 746f 7265 5479 7065 2e53 333a  ib.StoreType.S3:
-0002b5b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002b5c0: 7375 6666 6978 3a0a 2020 2020 2020 2020  suffix:.        
-0002b5d0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0002b5e0: 2761 7773 2073 3361 7069 206c 6973 742d  'aws s3api list-
-0002b5f0: 6f62 6a65 6374 7320 2d2d 6275 636b 6574  objects --bucket
-0002b600: 2022 7b62 7563 6b65 745f 6e61 6d65 7d22   "{bucket_name}"
-0002b610: 202d 2d70 7265 6669 7820 7b73 7566 6669   --prefix {suffi
-0002b620: 787d 202d 2d71 7565 7279 2022 6c65 6e67  x} --query "leng
-0002b630: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
-0002b640: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
-0002b650: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
-0002b660: 2227 0a20 2020 2020 2020 2020 2020 2065  "'.            e
-0002b670: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002b680: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
-0002b690: 7320 7333 6170 6920 6c69 7374 2d6f 626a  s s3api list-obj
-0002b6a0: 6563 7473 202d 2d62 7563 6b65 7420 227b  ects --bucket "{
-0002b6b0: 6275 636b 6574 5f6e 616d 657d 2220 2d2d  bucket_name}" --
-0002b6c0: 7175 6572 7920 226c 656e 6774 6828 436f  query "length(Co
-0002b6d0: 6e74 656e 7473 5b3f 636f 6e74 6169 6e73  ntents[?contains
-0002b6e0: 284b 6579 2c5c 277b 6669 6c65 5f6e 616d  (Key,\'{file_nam
-0002b6f0: 657d 5c27 295d 2e4b 6579 2922 270a 2020  e}\')].Key)"'.  
-0002b700: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-0002b710: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002b720: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0002b730: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-0002b740: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
-0002b750: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002b760: 6e20 6627 6773 7574 696c 206c 7320 2d72  n f'gsutil ls -r
-0002b770: 2067 733a 2f2f 7b62 7563 6b65 745f 6e61   gs://{bucket_na
-0002b780: 6d65 7d2f 7b73 7566 6669 787d 207c 2067  me}/{suffix} | g
-0002b790: 7265 7020 227b 6669 6c65 5f6e 616d 657d  rep "{file_name}
-0002b7a0: 2220 7c20 7763 202d 6c27 0a20 2020 2020  " | wc -l'.     
-0002b7b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002b7c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002b7d0: 7572 6e20 6627 6773 7574 696c 206c 7320  urn f'gsutil ls 
-0002b7e0: 2d72 2067 733a 2f2f 7b62 7563 6b65 745f  -r gs://{bucket_
-0002b7f0: 6e61 6d65 7d20 7c20 6772 6570 2022 7b66  name} | grep "{f
-0002b800: 696c 655f 6e61 6d65 7d22 207c 2077 6320  ile_name}" | wc 
-0002b810: 2d6c 270a 2020 2020 2020 2020 656c 6966  -l'.        elif
-0002b820: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-0002b830: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002b840: 5479 7065 2e52 323a 0a20 2020 2020 2020  Type.R2:.       
-0002b850: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
-0002b860: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
-0002b870: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
-0002b880: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002b890: 7375 6666 6978 3a0a 2020 2020 2020 2020  suffix:.        
-0002b8a0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-0002b8b0: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
-0002b8c0: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
-0002b8d0: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
-0002b8e0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
-0002b8f0: 7320 7333 6170 6920 6c69 7374 2d6f 626a  s s3api list-obj
-0002b900: 6563 7473 202d 2d62 7563 6b65 7420 227b  ects --bucket "{
-0002b910: 6275 636b 6574 5f6e 616d 657d 2220 2d2d  bucket_name}" --
-0002b920: 7072 6566 6978 207b 7375 6666 6978 7d20  prefix {suffix} 
-0002b930: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
-0002b940: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
-0002b950: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
-0002b960: 616d 657d 5c27 295d 2e4b 6579 2922 202d  ame}\')].Key)" -
-0002b970: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
-0002b980: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
-0002b990: 6c65 3d72 3227 0a20 2020 2020 2020 2020  le=r2'.         
-0002b9a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002b9b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002b9c0: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
-0002b9d0: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
-0002b9e0: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
-0002b9f0: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
-0002ba00: 7773 2073 3361 7069 206c 6973 742d 6f62  ws s3api list-ob
-0002ba10: 6a65 6374 7320 2d2d 6275 636b 6574 2022  jects --bucket "
-0002ba20: 7b62 7563 6b65 745f 6e61 6d65 7d22 202d  {bucket_name}" -
-0002ba30: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
-0002ba40: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
-0002ba50: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
-0002ba60: 6d65 7d5c 2729 5d2e 4b65 7929 2220 2d2d  me}\')].Key)" --
-0002ba70: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0002ba80: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0002ba90: 653d 7232 270a 0a20 2020 2040 7374 6174  e=r2'..    @stat
-0002baa0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-0002bab0: 2063 6c69 5f63 6f75 6e74 5f66 696c 655f   cli_count_file_
-0002bac0: 696e 5f62 7563 6b65 7428 7374 6f72 655f  in_bucket(store_
-0002bad0: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-0002bae0: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
-0002baf0: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-0002bb00: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002bb10: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
-0002bb20: 2020 2072 6574 7572 6e20 6627 6177 7320     return f'aws 
-0002bb30: 7333 206c 7320 7333 3a2f 2f7b 6275 636b  s3 ls s3://{buck
-0002bb40: 6574 5f6e 616d 657d 202d 2d72 6563 7572  et_name} --recur
-0002bb50: 7369 7665 207c 2077 6320 2d6c 270a 2020  sive | wc -l'.  
-0002bb60: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-0002bb70: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0002bb80: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0002bb90: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-0002bba0: 7265 7475 726e 2066 2767 7375 7469 6c20  return f'gsutil 
-0002bbb0: 6c73 202d 7220 6773 3a2f 2f7b 6275 636b  ls -r gs://{buck
-0002bbc0: 6574 5f6e 616d 657d 2f2a 2a20 7c20 7763  et_name}/** | wc
-0002bbd0: 202d 6c27 0a20 2020 2020 2020 2065 6c69   -l'.        eli
-0002bbe0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0002bbf0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002bc00: 6554 7970 652e 5232 3a0a 2020 2020 2020  eType.R2:.      
-0002bc10: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
-0002bc20: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
-0002bc30: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
-0002bc40: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0002bc50: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
-0002bc60: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-0002bc70: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-0002bc80: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-0002bc90: 5448 7d20 6177 7320 7333 206c 7320 7333  TH} aws s3 ls s3
-0002bca0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-0002bcb0: 202d 2d72 6563 7572 7369 7665 202d 2d65   --recursive --e
-0002bcc0: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-0002bcd0: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-0002bce0: 3d72 3220 7c20 7763 202d 6c27 0a0a 2020  =r2 | wc -l'..  
-0002bcf0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002bd00: 650a 2020 2020 6465 6620 746d 705f 736f  e.    def tmp_so
-0002bd10: 7572 6365 2873 656c 662c 2074 6d70 5f70  urce(self, tmp_p
-0002bd20: 6174 6829 3a0a 2020 2020 2020 2020 2320  ath):.        # 
-0002bd30: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0002bd40: 6172 7920 6469 7265 6374 6f72 7920 7769  ary directory wi
-0002bd50: 7468 2061 2066 696c 6520 696e 2069 740a  th a file in it.
-0002bd60: 2020 2020 2020 2020 746d 705f 6469 7220          tmp_dir 
-0002bd70: 3d20 746d 705f 7061 7468 202f 2027 746d  = tmp_path / 'tm
-0002bd80: 702d 736f 7572 6365 270a 2020 2020 2020  p-source'.      
-0002bd90: 2020 746d 705f 6469 722e 6d6b 6469 7228    tmp_dir.mkdir(
-0002bda0: 290a 2020 2020 2020 2020 746d 705f 6669  ).        tmp_fi
-0002bdb0: 6c65 203d 2074 6d70 5f64 6972 202f 2027  le = tmp_dir / '
-0002bdc0: 746d 702d 6669 6c65 270a 2020 2020 2020  tmp-file'.      
-0002bdd0: 2020 746d 705f 6669 6c65 2e77 7269 7465    tmp_file.write
-0002bde0: 5f74 6578 7428 2774 6573 7427 290a 2020  _text('test').  
-0002bdf0: 2020 2020 2020 6369 7263 6c65 5f6c 696e        circle_lin
-0002be00: 6b20 3d20 746d 705f 6469 7220 2f20 2763  k = tmp_dir / 'c
-0002be10: 6972 636c 652d 6c69 6e6b 270a 2020 2020  ircle-link'.    
-0002be20: 2020 2020 6369 7263 6c65 5f6c 696e 6b2e      circle_link.
-0002be30: 7379 6d6c 696e 6b5f 746f 2874 6d70 5f64  symlink_to(tmp_d
-0002be40: 6972 2c20 7461 7267 6574 5f69 735f 6469  ir, target_is_di
-0002be50: 7265 6374 6f72 793d 5472 7565 290a 2020  rectory=True).  
-0002be60: 2020 2020 2020 7969 656c 6420 7374 7228        yield str(
-0002be70: 746d 705f 6469 7229 0a0a 2020 2020 4073  tmp_dir)..    @s
-0002be80: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
-0002be90: 6465 6620 6765 6e65 7261 7465 5f62 7563  def generate_buc
-0002bea0: 6b65 745f 6e61 6d65 2829 3a0a 2020 2020  ket_name():.    
-0002beb0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002bec0: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
-0002bed0: 206e 616d 650a 2020 2020 2020 2020 2320   name.        # 
-0002bee0: 7469 6d65 2e74 696d 6528 2920 7265 7475  time.time() retu
-0002bef0: 726e 7320 7661 7279 696e 6720 7072 6563  rns varying prec
-0002bf00: 6973 696f 6e20 6f6e 2064 6966 6665 7265  ision on differe
-0002bf10: 6e74 2073 7973 7465 6d73 2c20 736f 2077  nt systems, so w
-0002bf20: 650a 2020 2020 2020 2020 2320 7265 706c  e.        # repl
-0002bf30: 6163 6520 7468 6520 6465 6369 6d61 6c20  ace the decimal 
-0002bf40: 706f 696e 7420 616e 6420 7573 6520 7768  point and use wh
-0002bf50: 6174 6576 6572 2070 7265 6369 7369 6f6e  atever precision
-0002bf60: 2077 6520 6361 6e20 6765 742e 0a20 2020   we can get..   
-0002bf70: 2020 2020 2074 696d 6573 7461 6d70 203d       timestamp =
-0002bf80: 2073 7472 2874 696d 652e 7469 6d65 2829   str(time.time()
-0002bf90: 292e 7265 706c 6163 6528 272e 272c 2027  ).replace('.', '
-0002bfa0: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-0002bfb0: 6e20 6627 736b 792d 7465 7374 2d7b 7469  n f'sky-test-{ti
-0002bfc0: 6d65 7374 616d 707d 270a 0a20 2020 2040  mestamp}'..    @
-0002bfd0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-0002bfe0: 2020 2064 6566 2074 6d70 5f62 7563 6b65     def tmp_bucke
-0002bff0: 745f 6e61 6d65 2873 656c 6629 3a0a 2020  t_name(self):.  
-0002c000: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
-0002c010: 2e67 656e 6572 6174 655f 6275 636b 6574  .generate_bucket
-0002c020: 5f6e 616d 6528 290a 0a20 2020 2040 7374  _name()..    @st
-0002c030: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-0002c040: 6566 2079 6965 6c64 5f73 746f 7261 6765  ef yield_storage
-0002c050: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
-0002c060: 2020 2020 206e 616d 653a 204f 7074 696f       name: Optio
-0002c070: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
-0002c080: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0002c090: 7263 653a 204f 7074 696f 6e61 6c5b 7374  rce: Optional[st
-0002c0a0: 6f72 6167 655f 6c69 622e 5061 7468 5d20  orage_lib.Path] 
-0002c0b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0002c0c0: 2020 2020 7374 6f72 6573 3a20 4f70 7469      stores: Opti
-0002c0d0: 6f6e 616c 5b44 6963 745b 7374 6f72 6167  onal[Dict[storag
-0002c0e0: 655f 6c69 622e 5374 6f72 6554 7970 652c  e_lib.StoreType,
-0002c0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c110: 2020 2073 746f 7261 6765 5f6c 6962 2e41     storage_lib.A
-0002c120: 6273 7472 6163 7453 746f 7265 5d5d 203d  bstractStore]] =
-0002c130: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0002c140: 2020 2070 6572 7369 7374 656e 743a 204f     persistent: O
-0002c150: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
-0002c160: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0002c170: 2020 6d6f 6465 3a20 7374 6f72 6167 655f    mode: storage_
-0002c180: 6c69 622e 5374 6f72 6167 654d 6f64 6520  lib.StorageMode 
-0002c190: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002c1a0: 6f72 6167 654d 6f64 652e 4d4f 554e 5429  orageMode.MOUNT)
-0002c1b0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0002c1c0: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
-0002c1d0: 7374 6f72 6167 6520 6f62 6a65 6374 2e20  storage object. 
-0002c1e0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
-0002c1f0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002c200: 2e0a 2020 2020 2020 2020 7374 6f72 6167  ..        storag
-0002c210: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-0002c220: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
-0002c230: 3d6e 616d 652c 0a20 2020 2020 2020 2020  =name,.         
-0002c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c260: 2073 6f75 7263 653d 736f 7572 6365 2c0a   source=source,.
-0002c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c290: 2020 2020 2020 2020 2020 7374 6f72 6573            stores
-0002c2a0: 3d73 746f 7265 732c 0a20 2020 2020 2020  =stores,.       
-0002c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2d0: 2020 2070 6572 7369 7374 656e 743d 7065     persistent=pe
-0002c2e0: 7273 6973 7465 6e74 2c0a 2020 2020 2020  rsistent,.      
-0002c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c310: 2020 2020 6d6f 6465 3d6d 6f64 6529 0a20      mode=mode). 
-0002c320: 2020 2020 2020 2079 6965 6c64 2073 746f         yield sto
-0002c330: 7261 6765 5f6f 626a 0a20 2020 2020 2020  rage_obj.       
-0002c340: 2068 616e 646c 6520 3d20 676c 6f62 616c   handle = global
-0002c350: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-0002c360: 6861 6e64 6c65 5f66 726f 6d5f 7374 6f72  handle_from_stor
-0002c370: 6167 655f 6e61 6d65 280a 2020 2020 2020  age_name(.      
-0002c380: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002c390: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
-0002c3a0: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
-0002c3b0: 2020 2020 2020 2023 2049 6620 6861 6e64         # If hand
-0002c3c0: 6c65 2065 7869 7374 732c 2064 656c 6574  le exists, delet
-0002c3d0: 6520 6d61 6e75 616c 6c79 0a20 2020 2020  e manually.     
-0002c3e0: 2020 2020 2020 2023 2054 4f44 4f28 726f         # TODO(ro
-0002c3f0: 6d69 6c62 293a 2054 6869 7320 6973 2070  milb): This is p
-0002c400: 6f74 656e 7469 616c 6c79 2072 6973 6b79  otentially risky
-0002c410: 202d 2069 6620 7468 6520 6465 6c65 7465   - if the delete
-0002c420: 206d 6574 686f 6420 6861 730a 2020 2020   method has.    
-0002c430: 2020 2020 2020 2020 2320 2020 6275 6773          #   bugs
-0002c440: 2c20 7468 6973 2063 616e 2063 6175 7365  , this can cause
-0002c450: 2072 6573 6f75 7263 6520 6c65 616b 732e   resource leaks.
-0002c460: 2049 6465 616c 6c79 2077 6520 7368 6f75   Ideally we shou
-0002c470: 6c64 206d 616e 7561 6c6c 790a 2020 2020  ld manually.    
-0002c480: 2020 2020 2020 2020 2320 2020 656a 6563          #   ejec
-0002c490: 7420 7374 6f72 6167 6520 6672 6f6d 2067  t storage from g
-0002c4a0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-0002c4b0: 2061 6e64 2064 656c 6574 6520 7468 6520   and delete the 
-0002c4c0: 6275 636b 6574 2075 7369 6e67 0a20 2020  bucket using.   
-0002c4d0: 2020 2020 2020 2020 2023 2020 2062 6f74           #   bot
-0002c4e0: 6f33 2064 6972 6563 746c 792e 0a20 2020  o3 directly..   
-0002c4f0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002c500: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
-0002c510: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-0002c520: 7265 0a20 2020 2064 6566 2074 6d70 5f73  re.    def tmp_s
-0002c530: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002c540: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
-0002c550: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-0002c560: 2020 2023 2043 7265 6174 6573 2061 2073     # Creates a s
-0002c570: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
-0002c580: 7468 206e 6f20 736f 7572 6365 2074 6f20  th no source to 
-0002c590: 6372 6561 7465 2061 2073 6372 6174 6368  create a scratch
-0002c5a0: 2073 746f 7261 6765 2e0a 2020 2020 2020   storage..      
-0002c5b0: 2020 2320 5374 6f72 6573 206d 7573 7420    # Stores must 
-0002c5c0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-0002c5d0: 7465 7374 2e0a 2020 2020 2020 2020 7969  test..        yi
-0002c5e0: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
-0002c5f0: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0002c600: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
-0002c610: 6574 5f6e 616d 6529 0a0a 2020 2020 4070  et_name)..    @p
-0002c620: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002c630: 2020 6465 6620 746d 705f 6d75 6c74 6970    def tmp_multip
-0002c640: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
-0002c650: 6765 5f6f 626a 2873 656c 6629 3a0a 2020  ge_obj(self):.  
-0002c660: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002c670: 6120 6c69 7374 206f 6620 3520 7374 6f72  a list of 5 stor
-0002c680: 6167 6520 6f62 6a65 6374 7320 7769 7468  age objects with
-0002c690: 206e 6f20 736f 7572 6365 2074 6f20 6372   no source to cr
-0002c6a0: 6561 7465 0a20 2020 2020 2020 2023 206d  eate.        # m
-0002c6b0: 756c 7469 706c 6520 7363 7261 7463 6820  ultiple scratch 
-0002c6c0: 7374 6f72 6167 6573 2e0a 2020 2020 2020  storages..      
-0002c6d0: 2020 2320 5374 6f72 6573 2066 6f72 2065    # Stores for e
-0002c6e0: 6163 6820 6f62 6a65 6374 2069 6e20 7468  ach object in th
-0002c6f0: 6520 6c69 7374 206d 7573 7420 6265 2061  e list must be a
-0002c700: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
-0002c710: 2e0a 2020 2020 2020 2020 7374 6f72 6167  ..        storag
-0002c720: 655f 6d75 6c74 5f6f 626a 203d 205b 5d0a  e_mult_obj = [].
-0002c730: 2020 2020 2020 2020 666f 7220 5f20 696e          for _ in
-0002c740: 2072 616e 6765 2835 293a 0a20 2020 2020   range(5):.     
-0002c750: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-0002c760: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
-0002c770: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
-0002c780: 2027 2729 0a20 2020 2020 2020 2020 2020   '').           
-0002c790: 2073 746f 7265 5f6f 626a 203d 2073 746f   store_obj = sto
-0002c7a0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-0002c7b0: 286e 616d 653d 6627 736b 792d 7465 7374  (name=f'sky-test
-0002c7c0: 2d7b 7469 6d65 7374 616d 707d 2729 0a20  -{timestamp}'). 
-0002c7d0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002c7e0: 6765 5f6d 756c 745f 6f62 6a2e 6170 7065  ge_mult_obj.appe
-0002c7f0: 6e64 2873 746f 7265 5f6f 626a 290a 2020  nd(store_obj).  
-0002c800: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
-0002c810: 6167 655f 6d75 6c74 5f6f 626a 0a20 2020  age_mult_obj.   
-0002c820: 2020 2020 2066 6f72 2073 746f 7261 6765       for storage
-0002c830: 5f6f 626a 2069 6e20 7374 6f72 6167 655f  _obj in storage_
-0002c840: 6d75 6c74 5f6f 626a 3a0a 2020 2020 2020  mult_obj:.      
-0002c850: 2020 2020 2020 6861 6e64 6c65 203d 2067        handle = g
-0002c860: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-0002c870: 2e67 6574 5f68 616e 646c 655f 6672 6f6d  .get_handle_from
-0002c880: 5f73 746f 7261 6765 5f6e 616d 6528 0a20  _storage_name(. 
-0002c890: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c8a0: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
-0002c8b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002c8c0: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
-0002c8d0: 2020 2020 2020 2020 2320 4966 2068 616e          # If han
-0002c8e0: 646c 6520 6578 6973 7473 2c20 6465 6c65  dle exists, dele
-0002c8f0: 7465 206d 616e 7561 6c6c 790a 2020 2020  te manually.    
-0002c900: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0002c910: 444f 2872 6f6d 696c 6229 3a20 5468 6973  DO(romilb): This
-0002c920: 2069 7320 706f 7465 6e74 6961 6c6c 7920   is potentially 
-0002c930: 7269 736b 7920 2d20 6966 2074 6865 2064  risky - if the d
-0002c940: 656c 6574 6520 6d65 7468 6f64 2068 6173  elete method has
-0002c950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c960: 2023 2062 7567 732c 2074 6869 7320 6361   # bugs, this ca
-0002c970: 6e20 6361 7573 6520 7265 736f 7572 6365  n cause resource
-0002c980: 206c 6561 6b73 2e20 4964 6561 6c6c 7920   leaks. Ideally 
-0002c990: 7765 2073 686f 756c 6420 6d61 6e75 616c  we should manual
-0002c9a0: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
-0002c9b0: 2020 2023 2065 6a65 6374 2073 746f 7261     # eject stora
-0002c9c0: 6765 2066 726f 6d20 676c 6f62 616c 5f75  ge from global_u
-0002c9d0: 7365 725f 7374 6174 6520 616e 6420 6465  ser_state and de
-0002c9e0: 6c65 7465 2074 6865 2062 7563 6b65 7420  lete the bucket 
-0002c9f0: 7573 696e 670a 2020 2020 2020 2020 2020  using.          
-0002ca00: 2020 2020 2020 2320 626f 746f 3320 6469        # boto3 di
-0002ca10: 7265 6374 6c79 2e0a 2020 2020 2020 2020  rectly..        
-0002ca20: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002ca30: 6f62 6a2e 6465 6c65 7465 2829 0a0a 2020  obj.delete()..  
-0002ca40: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0002ca50: 650a 2020 2020 6465 6620 746d 705f 6d75  e.    def tmp_mu
-0002ca60: 6c74 6970 6c65 5f63 7573 746f 6d5f 736f  ltiple_custom_so
-0002ca70: 7572 6365 5f73 746f 7261 6765 5f6f 626a  urce_storage_obj
-0002ca80: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0002ca90: 2320 4372 6561 7465 7320 6120 6c69 7374  # Creates a list
-0002caa0: 206f 6620 7374 6f72 6167 6520 6f62 6a65   of storage obje
-0002cab0: 6374 7320 7769 7468 2063 7573 746f 6d20  cts with custom 
-0002cac0: 736f 7572 6365 206e 616d 6573 2074 6f0a  source names to.
-0002cad0: 2020 2020 2020 2020 2320 6372 6561 7465          # create
-0002cae0: 206d 756c 7469 706c 6520 7363 7261 7463   multiple scratc
-0002caf0: 6820 7374 6f72 6167 6573 2e0a 2020 2020  h storages..    
-0002cb00: 2020 2020 2320 5374 6f72 6573 2066 6f72      # Stores for
-0002cb10: 2065 6163 6820 6f62 6a65 6374 2069 6e20   each object in 
-0002cb20: 7468 6520 6c69 7374 206d 7573 7420 6265  the list must be
-0002cb30: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
-0002cb40: 7374 2e0a 2020 2020 2020 2020 6375 7374  st..        cust
-0002cb50: 6f6d 5f73 6f75 7263 655f 6e61 6d65 7320  om_source_names 
-0002cb60: 3d20 5b27 2270 6174 6820 5769 7468 2053  = ['"path With S
-0002cb70: 7061 6365 7322 272c 2027 7061 7468 2057  paces"', 'path W
-0002cb80: 6974 6820 5370 6163 6573 275d 0a20 2020  ith Spaces'].   
-0002cb90: 2020 2020 2073 746f 7261 6765 5f6d 756c       storage_mul
-0002cba0: 745f 6f62 6a20 3d20 5b5d 0a20 2020 2020  t_obj = [].     
-0002cbb0: 2020 2066 6f72 206e 616d 6520 696e 2063     for name in c
-0002cbc0: 7573 746f 6d5f 736f 7572 6365 5f6e 616d  ustom_source_nam
-0002cbd0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002cbe0: 7372 635f 7061 7468 203d 206f 732e 7061  src_path = os.pa
-0002cbf0: 7468 2e65 7870 616e 6475 7365 7228 6627  th.expanduser(f'
-0002cc00: 7e2f 7b6e 616d 657d 2729 0a20 2020 2020  ~/{name}').     
-0002cc10: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
-0002cc20: 6174 6828 7372 635f 7061 7468 292e 6578  ath(src_path).ex
-0002cc30: 7061 6e64 7573 6572 2829 2e6d 6b64 6972  panduser().mkdir
-0002cc40: 2865 7869 7374 5f6f 6b3d 5472 7565 290a  (exist_ok=True).
-0002cc50: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0002cc60: 7374 616d 7020 3d20 7374 7228 7469 6d65  stamp = str(time
-0002cc70: 2e74 696d 6528 2929 2e72 6570 6c61 6365  .time()).replace
-0002cc80: 2827 2e27 2c20 2727 290a 2020 2020 2020  ('.', '').      
-0002cc90: 2020 2020 2020 7374 6f72 655f 6f62 6a20        store_obj 
-0002cca0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0002ccb0: 6f72 6167 6528 6e61 6d65 3d66 2773 6b79  orage(name=f'sky
-0002ccc0: 2d74 6573 742d 7b74 696d 6573 7461 6d70  -test-{timestamp
-0002ccd0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0002cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd00: 736f 7572 6365 3d73 7263 5f70 6174 6829  source=src_path)
-0002cd10: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002cd20: 7261 6765 5f6d 756c 745f 6f62 6a2e 6170  rage_mult_obj.ap
-0002cd30: 7065 6e64 2873 746f 7265 5f6f 626a 290a  pend(store_obj).
-0002cd40: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
-0002cd50: 6f72 6167 655f 6d75 6c74 5f6f 626a 0a20  orage_mult_obj. 
-0002cd60: 2020 2020 2020 2066 6f72 2073 746f 7261         for stora
-0002cd70: 6765 5f6f 626a 2069 6e20 7374 6f72 6167  ge_obj in storag
-0002cd80: 655f 6d75 6c74 5f6f 626a 3a0a 2020 2020  e_mult_obj:.    
-0002cd90: 2020 2020 2020 2020 6861 6e64 6c65 203d          handle =
-0002cda0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0002cdb0: 7465 2e67 6574 5f68 616e 646c 655f 6672  te.get_handle_fr
-0002cdc0: 6f6d 5f73 746f 7261 6765 5f6e 616d 6528  om_storage_name(
-0002cdd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cde0: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-0002cdf0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-0002ce00: 6620 6861 6e64 6c65 3a0a 2020 2020 2020  f handle:.      
-0002ce10: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0002ce20: 655f 6f62 6a2e 6465 6c65 7465 2829 0a0a  e_obj.delete()..
-0002ce30: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0002ce40: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0002ce50: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
-0002ce60: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
-0002ce70: 6574 5f6e 616d 652c 2074 6d70 5f73 6f75  et_name, tmp_sou
-0002ce80: 7263 6529 3a0a 2020 2020 2020 2020 2320  rce):.        # 
-0002ce90: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0002cea0: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
-0002ceb0: 6374 2e20 5374 6f72 6573 206d 7573 7420  ct. Stores must 
-0002cec0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-0002ced0: 7465 7374 2e0a 2020 2020 2020 2020 7969  test..        yi
-0002cee0: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
-0002cef0: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0002cf00: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
-0002cf10: 6574 5f6e 616d 652c 0a20 2020 2020 2020  et_name,.       
-0002cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cf40: 2020 2020 2020 736f 7572 6365 3d74 6d70        source=tmp
-0002cf50: 5f73 6f75 7263 6529 0a0a 2020 2020 4070  _source)..    @p
-0002cf60: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0002cf70: 2020 6465 6620 746d 705f 6c6f 6361 6c5f    def tmp_local_
-0002cf80: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
-0002cf90: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0002cfa0: 745f 6e61 6d65 2c20 746d 705f 736f 7572  t_name, tmp_sour
-0002cfb0: 6365 293a 0a20 2020 2020 2020 2023 2043  ce):.        # C
-0002cfc0: 7265 6174 6573 2061 2074 656d 7020 7374  reates a temp st
-0002cfd0: 6f72 6167 6520 6f62 6a65 6374 2077 6869  orage object whi
-0002cfe0: 6368 2075 7365 7320 6120 6c69 7374 206f  ch uses a list o
-0002cff0: 6620 7061 7468 7320 6173 2073 6f75 7263  f paths as sourc
-0002d000: 652e 0a20 2020 2020 2020 2023 2053 746f  e..        # Sto
-0002d010: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
-0002d020: 6420 696e 2074 6865 2074 6573 742e 2041  d in the test. A
-0002d030: 6674 6572 2075 706c 6f61 642c 2074 6865  fter upload, the
-0002d040: 2062 7563 6b65 7420 7368 6f75 6c64 0a20   bucket should. 
-0002d050: 2020 2020 2020 2023 2068 6176 6520 7477         # have tw
-0002d060: 6f20 6669 6c65 7320 2d20 2f74 6d70 2d66  o files - /tmp-f
-0002d070: 696c 6520 616e 6420 2f74 6d70 2d73 6f75  ile and /tmp-sou
-0002d080: 7263 652f 746d 702d 6669 6c65 0a20 2020  rce/tmp-file.   
-0002d090: 2020 2020 206c 6973 745f 736f 7572 6365       list_source
-0002d0a0: 203d 205b 746d 705f 736f 7572 6365 2c20   = [tmp_source, 
-0002d0b0: 746d 705f 736f 7572 6365 202b 2027 2f74  tmp_source + '/t
-0002d0c0: 6d70 2d66 696c 6527 5d0a 2020 2020 2020  mp-file'].      
-0002d0d0: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
-0002d0e0: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
-0002d0f0: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
-0002d100: 6275 636b 6574 5f6e 616d 652c 0a20 2020  bucket_name,.   
-0002d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d130: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0002d140: 3d6c 6973 745f 736f 7572 6365 290a 0a20  =list_source).. 
-0002d150: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-0002d160: 7265 0a20 2020 2064 6566 2074 6d70 5f62  re.    def tmp_b
-0002d170: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
-0002d180: 6f62 6a28 7365 6c66 2c20 746d 705f 6275  obj(self, tmp_bu
-0002d190: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
-0002d1a0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-0002d1b0: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
-0002d1c0: 6520 6f62 6a65 6374 2066 6f72 2074 6573  e object for tes
-0002d1d0: 7469 6e67 2062 756c 6b20 6465 6c65 7469  ting bulk deleti
-0002d1e0: 6f6e 2e0a 2020 2020 2020 2020 2320 5374  on..        # St
-0002d1f0: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-0002d200: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-0002d210: 2020 2020 2020 2020 7769 7468 2074 656d          with tem
-0002d220: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
-0002d230: 6972 6563 746f 7279 2829 2061 7320 746d  irectory() as tm
-0002d240: 7064 6972 3a0a 2020 2020 2020 2020 2020  pdir:.          
-0002d250: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0002d260: 636b 5f6f 7574 7075 7428 6627 6d6b 6469  ck_output(f'mkdi
-0002d270: 7220 2d70 207b 746d 7064 6972 7d2f 666f  r -p {tmpdir}/fo
-0002d280: 6c64 6572 7b7b 3030 302e 2e32 3535 7d7d  lder{{000..255}}
-0002d290: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0002d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2b0: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-0002d2c0: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-0002d2d0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002d2e0: 6f75 7470 7574 2866 2774 6f75 6368 207b  output(f'touch {
-0002d2f0: 746d 7064 6972 7d2f 7465 7374 7b7b 3030  tmpdir}/test{{00
-0002d300: 302e 2e32 3535 7d7d 2e74 7874 272c 0a20  0..255}}.txt',. 
-0002d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d330: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-0002d340: 2020 2020 2020 2020 2020 2073 7562 7072             subpr
-0002d350: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002d360: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
-0002d370: 2020 2020 6627 746f 7563 6820 7b74 6d70      f'touch {tmp
-0002d380: 6469 727d 2f66 6f6c 6465 727b 7b30 3030  dir}/folder{{000
-0002d390: 2e2e 3235 357d 7d2f 7465 7374 2e74 7874  ..255}}/test.txt
-0002d3a0: 272c 2073 6865 6c6c 3d54 7275 6529 0a20  ', shell=True). 
-0002d3b0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-0002d3c0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
-0002d3d0: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
-0002d3e0: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
-0002d3f0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0002d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d420: 2020 2020 2020 2073 6f75 7263 653d 746d         source=tm
-0002d430: 7064 6972 290a 0a20 2020 2040 7079 7465  pdir)..    @pyte
-0002d440: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0002d450: 6566 2074 6d70 5f63 6f70 795f 6d6e 745f  ef tmp_copy_mnt_
-0002d460: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
-0002d470: 5f6f 626a 2873 656c 662c 2074 6d70 5f73  _obj(self, tmp_s
-0002d480: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-0002d490: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
-0002d4a0: 7265 6174 6573 2061 2063 6f70 7920 6d6f  reates a copy mo
-0002d4b0: 756e 7420 7374 6f72 6167 6520 7768 6963  unt storage whic
-0002d4c0: 6820 7265 7573 6573 2061 6e20 6578 6973  h reuses an exis
-0002d4d0: 7469 6e67 2073 746f 7261 6765 206f 626a  ting storage obj
-0002d4e0: 6563 742e 0a20 2020 2020 2020 2074 6d70  ect..        tmp
-0002d4f0: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002d500: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-0002d510: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002d520: 5479 7065 2e53 3329 0a20 2020 2020 2020  Type.S3).       
-0002d530: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-0002d540: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-0002d550: 6167 655f 6f62 6a2e 6e61 6d65 0a0a 2020  age_obj.name..  
-0002d560: 2020 2020 2020 2320 5472 7920 746f 2069        # Try to i
-0002d570: 6e69 7469 616c 697a 6520 616e 6f74 6865  nitialize anothe
-0002d580: 7220 7374 6f72 6167 6520 7769 7468 2074  r storage with t
-0002d590: 6865 2073 746f 7261 6765 206f 626a 6563  he storage objec
-0002d5a0: 7420 6372 6561 7465 640a 2020 2020 2020  t created.      
-0002d5b0: 2020 2320 6162 6f76 652c 2062 7574 206e    # above, but n
-0002d5c0: 6f77 2069 6e20 434f 5059 206d 6f64 652e  ow in COPY mode.
-0002d5d0: 2054 6869 7320 7368 6f75 6c64 2073 7563   This should suc
-0002d5e0: 6365 6564 2e0a 2020 2020 2020 2020 7969  ceed..        yi
-0002d5f0: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
-0002d600: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0002d610: 6374 286e 616d 653d 7374 6f72 6167 655f  ct(name=storage_
-0002d620: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0002d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d650: 2020 206d 6f64 653d 7374 6f72 6167 655f     mode=storage_
-0002d660: 6c69 622e 5374 6f72 6167 654d 6f64 652e  lib.StorageMode.
-0002d670: 434f 5059 290a 0a20 2020 2040 7079 7465  COPY)..    @pyte
-0002d680: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0002d690: 6566 2074 6d70 5f67 6974 6967 6e6f 7265  ef tmp_gitignore
-0002d6a0: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-0002d6b0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-0002d6c0: 6d65 2c20 6769 7469 676e 6f72 655f 7374  me, gitignore_st
-0002d6d0: 7275 6374 7572 6529 3a0a 2020 2020 2020  ructure):.      
-0002d6e0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-0002d6f0: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
-0002d700: 6f62 6a65 6374 2066 6f72 2074 6573 7469  object for testi
-0002d710: 6e67 202e 6769 7469 676e 6f72 6520 6669  ng .gitignore fi
-0002d720: 6c74 6572 2e0a 2020 2020 2020 2020 2320  lter..        # 
-0002d730: 4749 5449 4749 4e4f 5245 5f53 5452 5543  GITIGINORE_STRUC
-0002d740: 5455 5245 2069 7320 7265 7072 6573 656e  TURE is represen
-0002d750: 7469 6e67 2061 2066 696c 6520 7374 7275  ting a file stru
-0002d760: 6374 7572 6520 696e 2061 2064 6963 7469  cture in a dicti
-0002d770: 6f6e 6172 790a 2020 2020 2020 2020 2320  onary.        # 
-0002d780: 666f 726d 6174 2e20 4372 6561 7465 6420  format. Created 
-0002d790: 7374 6f72 6167 6520 6f62 6a65 6374 2077  storage object w
-0002d7a0: 696c 6c20 636f 6e74 6169 6e20 7468 6520  ill contain the 
-0002d7b0: 6669 6c65 2073 7472 7563 7475 7265 2061  file structure a
-0002d7c0: 6c6f 6e67 0a20 2020 2020 2020 2023 2077  long.        # w
-0002d7d0: 6974 6820 2e67 6974 6967 6e6f 7265 2061  ith .gitignore a
-0002d7e0: 6e64 202e 6769 742f 696e 666f 2f65 7863  nd .git/info/exc
-0002d7f0: 6c75 6465 2066 696c 6573 2074 6f20 7465  lude files to te
-0002d800: 7374 2065 7863 6c75 6465 2066 696c 7465  st exclude filte
-0002d810: 722e 0a20 2020 2020 2020 2023 2053 746f  r..        # Sto
-0002d820: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
-0002d830: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
-0002d840: 2020 2020 2020 2077 6974 6820 7465 6d70         with temp
-0002d850: 6669 6c65 2e54 656d 706f 7261 7279 4469  file.TemporaryDi
-0002d860: 7265 6374 6f72 7928 2920 6173 2074 6d70  rectory() as tmp
-0002d870: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
-0002d880: 2023 2043 7265 6174 6573 2066 696c 6520   # Creates file 
-0002d890: 7374 7275 6374 7572 6520 746f 2062 6520  structure to be 
-0002d8a0: 7570 6c6f 6164 6564 2069 6e20 7468 6520  uploaded in the 
-0002d8b0: 5374 6f72 6167 650a 2020 2020 2020 2020  Storage.        
-0002d8c0: 2020 2020 7365 6c66 2e63 7265 6174 655f      self.create_
-0002d8d0: 6469 725f 7374 7275 6374 7572 6528 746d  dir_structure(tm
-0002d8e0: 7064 6972 2c20 6769 7469 676e 6f72 655f  pdir, gitignore_
-0002d8f0: 7374 7275 6374 7572 6529 0a0a 2020 2020  structure)..    
-0002d900: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002d910: 202e 6769 7469 676e 6f72 6520 616e 6420   .gitignore and 
-0002d920: 6c69 7374 2066 696c 6573 2f64 6972 7320  list files/dirs 
-0002d930: 746f 2062 6520 6578 636c 7564 6564 2069  to be excluded i
-0002d940: 6e20 6974 0a20 2020 2020 2020 2020 2020  n it.           
-0002d950: 2073 6b79 7069 6c6f 745f 7061 7468 203d   skypilot_path =
-0002d960: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
-0002d970: 286f 732e 7061 7468 2e64 6972 6e61 6d65  (os.path.dirname
-0002d980: 2873 6b79 2e5f 5f66 696c 655f 5f29 290a  (sky.__file__)).
-0002d990: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0002d9a0: 5f70 6174 6820 3d20 6627 7b74 6d70 6469  _path = f'{tmpdi
-0002d9b0: 727d 2f2e 6769 7469 676e 6f72 6527 0a20  r}/.gitignore'. 
-0002d9c0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-0002d9d0: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-0002d9e0: 6f69 6e28 736b 7970 696c 6f74 5f70 6174  oin(skypilot_pat
-0002d9f0: 682c 2027 7465 7374 732f 6769 7469 676e  h, 'tests/gitign
-0002da00: 6f72 655f 7465 7374 2729 0a20 2020 2020  ore_test').     
-0002da10: 2020 2020 2020 2073 6875 7469 6c2e 636f         shutil.co
-0002da20: 7079 6669 6c65 2866 696c 655f 7061 7468  pyfile(file_path
-0002da30: 2c20 7465 6d70 5f70 6174 6829 0a0a 2020  , temp_path)..  
-0002da40: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-0002da50: 7465 202e 6769 742f 696e 666f 2f65 7863  te .git/info/exc
-0002da60: 6c75 6465 2061 6e64 206c 6973 7420 6669  lude and list fi
-0002da70: 6c65 732f 6469 7273 2074 6f20 6265 2065  les/dirs to be e
-0002da80: 7863 6c75 6465 6420 696e 2069 740a 2020  xcluded in it.  
-0002da90: 2020 2020 2020 2020 2020 7465 6d70 5f70            temp_p
-0002daa0: 6174 6820 3d20 6627 7b74 6d70 6469 727d  ath = f'{tmpdir}
-0002dab0: 2f2e 6769 742f 696e 666f 2f27 0a20 2020  /.git/info/'.   
-0002dac0: 2020 2020 2020 2020 206f 732e 6d61 6b65           os.make
-0002dad0: 6469 7273 2874 656d 705f 7061 7468 290a  dirs(temp_path).
-0002dae0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0002daf0: 5f65 7863 6c75 6465 5f70 6174 6820 3d20  _exclude_path = 
-0002db00: 6f73 2e70 6174 682e 6a6f 696e 2874 656d  os.path.join(tem
-0002db10: 705f 7061 7468 2c20 2765 7863 6c75 6465  p_path, 'exclude
-0002db20: 2729 0a20 2020 2020 2020 2020 2020 2066  ').            f
-0002db30: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
-0002db40: 7468 2e6a 6f69 6e28 736b 7970 696c 6f74  th.join(skypilot
-0002db50: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-0002db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002db70: 2020 2020 2020 2020 2020 2020 2774 6573              'tes
-0002db80: 7473 2f67 6974 5f69 6e66 6f5f 6578 636c  ts/git_info_excl
-0002db90: 7564 655f 7465 7374 2729 0a20 2020 2020  ude_test').     
-0002dba0: 2020 2020 2020 2073 6875 7469 6c2e 636f         shutil.co
-0002dbb0: 7079 6669 6c65 2866 696c 655f 7061 7468  pyfile(file_path
-0002dbc0: 2c20 7465 6d70 5f65 7863 6c75 6465 5f70  , temp_exclude_p
-0002dbd0: 6174 6829 0a0a 2020 2020 2020 2020 2020  ath)..          
-0002dbe0: 2020 2320 4372 6561 7465 2073 6b79 2053    # Create sky S
-0002dbf0: 746f 7261 6765 2077 6974 6820 7468 6520  torage with the 
-0002dc00: 6669 6c65 7320 6372 6561 7465 640a 2020  files created.  
-0002dc10: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-0002dc20: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-0002dc30: 7374 6f72 6167 655f 6f62 6a65 6374 280a  storage_object(.
-0002dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc50: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
-0002dc60: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0002dc70: 2020 2020 2020 736f 7572 6365 3d74 6d70        source=tmp
-0002dc80: 6469 722c 0a20 2020 2020 2020 2020 2020  dir,.           
-0002dc90: 2020 2020 206d 6f64 653d 7374 6f72 6167       mode=storag
-0002dca0: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002dcb0: 652e 434f 5059 290a 0a20 2020 2040 7079  e.COPY)..    @py
-0002dcc0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002dcd0: 2064 6566 2074 6d70 5f61 7773 636c 695f   def tmp_awscli_
-0002dce0: 6275 636b 6574 2873 656c 662c 2074 6d70  bucket(self, tmp
-0002dcf0: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
-0002dd00: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0002dd10: 2061 2074 656d 706f 7261 7279 2062 7563   a temporary buc
-0002dd20: 6b65 7420 7573 696e 6720 6177 7363 6c69  ket using awscli
-0002dd30: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
-0002dd40: 7572 6920 3d20 6627 7333 3a2f 2f7b 746d  uri = f's3://{tm
-0002dd50: 705f 6275 636b 6574 5f6e 616d 657d 270a  p_bucket_name}'.
-0002dd60: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0002dd70: 7373 2e63 6865 636b 5f63 616c 6c28 5b27  ss.check_call(['
-0002dd80: 6177 7327 2c20 2773 3327 2c20 276d 6227  aws', 's3', 'mb'
-0002dd90: 2c20 6275 636b 6574 5f75 7269 5d29 0a20  , bucket_uri]). 
-0002dda0: 2020 2020 2020 2079 6965 6c64 2074 6d70         yield tmp
-0002ddb0: 5f62 7563 6b65 745f 6e61 6d65 2c20 6275  _bucket_name, bu
-0002ddc0: 636b 6574 5f75 7269 0a20 2020 2020 2020  cket_uri.       
-0002ddd0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0002dde0: 6b5f 6361 6c6c 285b 2761 7773 272c 2027  k_call(['aws', '
-0002ddf0: 7333 272c 2027 7262 272c 2062 7563 6b65  s3', 'rb', bucke
-0002de00: 745f 7572 692c 2027 2d2d 666f 7263 6527  t_uri, '--force'
-0002de10: 5d29 0a0a 2020 2020 4070 7974 6573 742e  ])..    @pytest.
-0002de20: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-0002de30: 746d 705f 6773 7574 696c 5f62 7563 6b65  tmp_gsutil_bucke
-0002de40: 7428 7365 6c66 2c20 746d 705f 6275 636b  t(self, tmp_buck
-0002de50: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-0002de60: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-0002de70: 6d70 6f72 6172 7920 6275 636b 6574 2075  mporary bucket u
-0002de80: 7369 6e67 2067 7375 7469 6c0a 2020 2020  sing gsutil.    
-0002de90: 2020 2020 6275 636b 6574 5f75 7269 203d      bucket_uri =
-0002dea0: 2066 2767 733a 2f2f 7b74 6d70 5f62 7563   f'gs://{tmp_buc
-0002deb0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-0002dec0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-0002ded0: 6563 6b5f 6361 6c6c 285b 2767 7375 7469  eck_call(['gsuti
-0002dee0: 6c27 2c20 276d 6227 2c20 6275 636b 6574  l', 'mb', bucket
-0002def0: 5f75 7269 5d29 0a20 2020 2020 2020 2079  _uri]).        y
-0002df00: 6965 6c64 2074 6d70 5f62 7563 6b65 745f  ield tmp_bucket_
-0002df10: 6e61 6d65 2c20 6275 636b 6574 5f75 7269  name, bucket_uri
-0002df20: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-0002df30: 6573 732e 6368 6563 6b5f 6361 6c6c 285b  ess.check_call([
-0002df40: 2767 7375 7469 6c27 2c20 2772 6d27 2c20  'gsutil', 'rm', 
-0002df50: 272d 7227 2c20 6275 636b 6574 5f75 7269  '-r', bucket_uri
-0002df60: 5d29 0a0a 2020 2020 4070 7974 6573 742e  ])..    @pytest.
-0002df70: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-0002df80: 746d 705f 6177 7363 6c69 5f62 7563 6b65  tmp_awscli_bucke
-0002df90: 745f 7232 2873 656c 662c 2074 6d70 5f62  t_r2(self, tmp_b
-0002dfa0: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0002dfb0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0002dfc0: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
-0002dfd0: 7420 7573 696e 6720 6177 7363 6c69 0a20  t using awscli. 
-0002dfe0: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
-0002dff0: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
-0002e000: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
-0002e010: 2829 0a20 2020 2020 2020 2062 7563 6b65  ().        bucke
-0002e020: 745f 7572 6920 3d20 6627 7333 3a2f 2f7b  t_uri = f's3://{
-0002e030: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
-0002e040: 270a 2020 2020 2020 2020 7375 6270 726f  '.        subpro
-0002e050: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0002e060: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
-0002e070: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
-0002e080: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
-0002e090: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
-0002e0a0: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
-0002e0b0: 7333 206d 6220 7b62 7563 6b65 745f 7572  s3 mb {bucket_ur
-0002e0c0: 697d 202d 2d65 6e64 706f 696e 7420 7b65  i} --endpoint {e
-0002e0d0: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
-0002e0e0: 726f 6669 6c65 3d72 3227 2c0a 2020 2020  rofile=r2',.    
-0002e0f0: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-0002e100: 7565 290a 2020 2020 2020 2020 7969 656c  ue).        yiel
-0002e110: 6420 746d 705f 6275 636b 6574 5f6e 616d  d tmp_bucket_nam
-0002e120: 652c 2062 7563 6b65 745f 7572 690a 2020  e, bucket_uri.  
-0002e130: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0002e140: 2e63 6865 636b 5f63 616c 6c28 0a20 2020  .check_call(.   
-0002e150: 2020 2020 2020 2020 2066 2741 5753 5f53           f'AWS_S
-0002e160: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-0002e170: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-0002e180: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-0002e190: 535f 5041 5448 7d20 6177 7320 7333 2072  S_PATH} aws s3 r
-0002e1a0: 6220 7b62 7563 6b65 745f 7572 697d 202d  b {bucket_uri} -
-0002e1b0: 2d66 6f72 6365 202d 2d65 6e64 706f 696e  -force --endpoin
-0002e1c0: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
-0002e1d0: 202d 2d70 726f 6669 6c65 3d72 3227 2c0a   --profile=r2',.
-0002e1e0: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-0002e1f0: 6c3d 5472 7565 290a 0a20 2020 2040 7079  l=True)..    @py
-0002e200: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0002e210: 2064 6566 2074 6d70 5f69 626d 5f63 6f73   def tmp_ibm_cos
-0002e220: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
-0002e230: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
-0002e240: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002e250: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
-0002e260: 636b 6574 2075 7369 6e67 2049 424d 2043  cket using IBM C
-0002e270: 4f53 2041 5049 0a20 2020 2020 2020 2073  OS API.        s
-0002e280: 746f 7261 6765 5f6f 626a 203d 2073 746f  torage_obj = sto
-0002e290: 7261 6765 5f6c 6962 2e49 424d 436f 7353  rage_lib.IBMCosS
-0002e2a0: 746f 7265 2873 6f75 7263 653d 2222 2c20  tore(source="", 
-0002e2b0: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
-0002e2c0: 6e61 6d65 290a 2020 2020 2020 2020 7969  name).        yi
-0002e2d0: 656c 6420 746d 705f 6275 636b 6574 5f6e  eld tmp_bucket_n
-0002e2e0: 616d 650a 2020 2020 2020 2020 7374 6f72  ame.        stor
-0002e2f0: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
-0002e300: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0002e310: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0002e320: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
-0002e330: 5f6f 626a 2873 656c 662c 2072 6571 7565  _obj(self, reque
-0002e340: 7374 293a 0a20 2020 2020 2020 2023 2049  st):.        # I
-0002e350: 6e69 7469 616c 697a 6573 2061 2073 746f  nitializes a sto
-0002e360: 7261 6765 206f 626a 6563 7420 7769 7468  rage object with
-0002e370: 2061 2070 7562 6c69 6320 6275 636b 6574   a public bucket
-0002e380: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0002e390: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-0002e3a0: 6962 2e53 746f 7261 6765 2873 6f75 7263  ib.Storage(sourc
-0002e3b0: 653d 7265 7175 6573 742e 7061 7261 6d29  e=request.param)
-0002e3c0: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-0002e3d0: 746f 7261 6765 5f6f 626a 0a20 2020 2020  torage_obj.     
-0002e3e0: 2020 2023 2054 6869 7320 646f 6573 206e     # This does n
-0002e3f0: 6f74 2072 6571 7569 7265 2061 6e79 2064  ot require any d
-0002e400: 656c 6574 696f 6e20 6c6f 6769 6320 6265  eletion logic be
-0002e410: 6361 7573 6520 6974 2069 7320 6120 7075  cause it is a pu
-0002e420: 626c 6963 2062 7563 6b65 740a 2020 2020  blic bucket.    
-0002e430: 2020 2020 2320 616e 6420 7368 6f75 6c64      # and should
-0002e440: 206e 6f74 2067 6574 2061 6464 6564 2074   not get added t
-0002e450: 6f20 676c 6f62 616c 5f75 7365 725f 7374  o global_user_st
-0002e460: 6174 652e 0a0a 2020 2020 4070 7974 6573  ate...    @pytes
-0002e470: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002e480: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-0002e490: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-0002e4a0: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
-0002e4b0: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
-0002e4c0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002e4d0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
-0002e4e0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
-0002e4f0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002e500: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0002e510: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
-0002e520: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002e530: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-0002e540: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0002e550: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002e560: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-0002e570: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-0002e580: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
-0002e590: 6566 2074 6573 745f 6e65 775f 6275 636b  ef test_new_buck
-0002e5a0: 6574 5f63 7265 6174 696f 6e5f 616e 645f  et_creation_and_
-0002e5b0: 6465 6c65 7469 6f6e 2873 656c 662c 2074  deletion(self, t
-0002e5c0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-0002e5d0: 5f6f 626a 2c0a 2020 2020 2020 2020 2020  _obj,.          
-0002e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e600: 2020 2020 7374 6f72 655f 7479 7065 293a      store_type):
-0002e610: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0002e620: 6573 2061 206e 6577 2062 7563 6b65 7420  es a new bucket 
-0002e630: 7769 7468 2061 206c 6f63 616c 2073 6f75  with a local sou
-0002e640: 7263 652c 2075 706c 6f61 6473 2066 696c  rce, uploads fil
-0002e650: 6573 2074 6f20 6974 0a20 2020 2020 2020  es to it.       
-0002e660: 2023 2061 6e64 2064 656c 6574 6573 2069   # and deletes i
-0002e670: 742e 0a20 2020 2020 2020 2074 6d70 5f6c  t..        tmp_l
-0002e680: 6f63 616c 5f73 746f 7261 6765 5f6f 626a  ocal_storage_obj
-0002e690: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002e6a0: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-0002e6b0: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-0002e6c0: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-0002e6d0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0002e6e0: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
-0002e6f0: 7470 7574 0a20 2020 2020 2020 206f 7574  tput.        out
-0002e700: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002e710: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0002e720: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0002e730: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0002e740: 6572 7420 746d 705f 6c6f 6361 6c5f 7374  ert tmp_local_st
-0002e750: 6f72 6167 655f 6f62 6a2e 6e61 6d65 2069  orage_obj.name i
-0002e760: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
-0002e770: 662d 3827 290a 0a20 2020 2020 2020 2023  f-8')..        #
-0002e780: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002e790: 2064 656c 6574 6520 746f 2064 656c 6574   delete to delet
-0002e7a0: 6520 7468 6520 7374 6f72 6167 6520 6f62  e the storage ob
-0002e7b0: 6a65 6374 0a20 2020 2020 2020 2073 7562  ject.        sub
-0002e7c0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002e7d0: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
-0002e7e0: 2020 5b27 736b 7927 2c20 2773 746f 7261    ['sky', 'stora
-0002e7f0: 6765 272c 2027 6465 6c65 7465 272c 2074  ge', 'delete', t
-0002e800: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-0002e810: 5f6f 626a 2e6e 616d 652c 2027 2d2d 7965  _obj.name, '--ye
-0002e820: 7327 5d29 0a0a 2020 2020 2020 2020 2320  s'])..        # 
-0002e830: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0002e840: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
-0002e850: 746f 7261 6765 206f 626a 6563 7420 6973  torage object is
-0002e860: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
-0002e870: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-0002e880: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-0002e890: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-0002e8a0: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-0002e8b0: 2061 7373 6572 7420 746d 705f 6c6f 6361   assert tmp_loca
-0002e8c0: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
-0002e8d0: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
-0002e8e0: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
-0002e8f0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002e900: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-0002e910: 2020 4070 7974 6573 742e 6d61 726b 2e78    @pytest.mark.x
-0002e920: 6469 7374 5f67 726f 7570 2827 6d75 6c74  dist_group('mult
-0002e930: 6970 6c65 5f62 7563 6b65 745f 6465 6c65  iple_bucket_dele
-0002e940: 7469 6f6e 2729 0a20 2020 2040 7079 7465  tion').    @pyte
-0002e950: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-0002e960: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
-0002e970: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
-0002e980: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002e990: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
-0002e9a0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
-0002e9b0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002e9c0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002e9d0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-0002e9e0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002e9f0: 6b2e 636c 6f75 6466 6c61 7265 292c 0a20  k.cloudflare),. 
-0002ea00: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002ea10: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0002ea20: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
-0002ea30: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002ea40: 2e69 626d 290a 2020 2020 5d29 0a20 2020  .ibm).    ]).   
-0002ea50: 2064 6566 2074 6573 745f 6d75 6c74 6970   def test_multip
-0002ea60: 6c65 5f62 7563 6b65 7473 5f63 7265 6174  le_buckets_creat
-0002ea70: 696f 6e5f 616e 645f 6465 6c65 7469 6f6e  ion_and_deletion
-0002ea80: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-0002ea90: 6c66 2c20 746d 705f 6d75 6c74 6970 6c65  lf, tmp_multiple
-0002eaa0: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
-0002eab0: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
-0002eac0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002ead0: 6174 6573 206d 756c 7469 706c 6520 6e65  ates multiple ne
-0002eae0: 7720 6275 636b 6574 7328 3520 6275 636b  w buckets(5 buck
-0002eaf0: 6574 7329 2077 6974 6820 6120 6c6f 6361  ets) with a loca
-0002eb00: 6c20 736f 7572 6365 0a20 2020 2020 2020  l source.       
-0002eb10: 2023 2061 6e64 2064 656c 6574 6573 2074   # and deletes t
-0002eb20: 6865 6d2e 0a20 2020 2020 2020 2073 746f  hem..        sto
-0002eb30: 7261 6765 5f6f 626a 5f6e 616d 6520 3d20  rage_obj_name = 
-0002eb40: 5b5d 0a20 2020 2020 2020 2066 6f72 2073  [].        for s
-0002eb50: 746f 7265 5f6f 626a 2069 6e20 746d 705f  tore_obj in tmp_
-0002eb60: 6d75 6c74 6970 6c65 5f73 6372 6174 6368  multiple_scratch
-0002eb70: 5f73 746f 7261 6765 5f6f 626a 3a0a 2020  _storage_obj:.  
-0002eb80: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-0002eb90: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0002eba0: 6f72 655f 7479 7065 290a 2020 2020 2020  ore_type).      
-0002ebb0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-0002ebc0: 6a5f 6e61 6d65 2e61 7070 656e 6428 7374  j_name.append(st
-0002ebd0: 6f72 655f 6f62 6a2e 6e61 6d65 290a 0a20  ore_obj.name).. 
-0002ebe0: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0002ebf0: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0002ec00: 6865 636b 2069 6620 616c 6c20 7374 6f72  heck if all stor
-0002ec10: 6167 6520 6f62 6a65 6374 7320 6578 6973  age objects exis
-0002ec20: 7473 2069 6e20 7468 650a 2020 2020 2020  ts in the.      
-0002ec30: 2020 2320 6f75 7470 7574 2066 696c 7465    # output filte
-0002ec40: 7265 6420 6279 2073 746f 7265 2074 7970  red by store typ
-0002ec50: 650a 2020 2020 2020 2020 6f75 745f 616c  e.        out_al
-0002ec60: 6c20 3d20 7375 6270 726f 6365 7373 2e63  l = subprocess.c
-0002ec70: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-0002ec80: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-0002ec90: 6c73 275d 290a 2020 2020 2020 2020 6f75  ls']).        ou
-0002eca0: 7420 3d20 5b0a 2020 2020 2020 2020 2020  t = [.          
-0002ecb0: 2020 6974 656d 2e73 706c 6974 2829 5b30    item.split()[0
-0002ecc0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-0002ecd0: 7220 6974 656d 2069 6e20 6f75 745f 616c  r item in out_al
-0002ece0: 6c2e 6465 636f 6465 2827 7574 662d 3827  l.decode('utf-8'
-0002ecf0: 292e 7370 6c69 746c 696e 6573 2829 0a20  ).splitlines(). 
-0002ed00: 2020 2020 2020 2020 2020 2069 6620 7374             if st
-0002ed10: 6f72 655f 7479 7065 2e76 616c 7565 2069  ore_type.value i
-0002ed20: 6e20 6974 656d 0a20 2020 2020 2020 205d  n item.        ]
-0002ed30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002ed40: 616c 6c28 5b69 7465 6d20 696e 206f 7574  all([item in out
-0002ed50: 2066 6f72 2069 7465 6d20 696e 2073 746f   for item in sto
-0002ed60: 7261 6765 5f6f 626a 5f6e 616d 655d 290a  rage_obj_name]).
-0002ed70: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-0002ed80: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-0002ed90: 6520 616c 6c20 746f 2064 656c 6574 6520  e all to delete 
-0002eda0: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
-0002edb0: 6374 730a 2020 2020 2020 2020 6465 6c65  cts.        dele
-0002edc0: 7465 5f63 6d64 203d 205b 2773 6b79 272c  te_cmd = ['sky',
-0002edd0: 2027 7374 6f72 6167 6527 2c20 2764 656c   'storage', 'del
-0002ede0: 6574 6527 2c20 272d 2d79 6573 275d 0a20  ete', '--yes']. 
-0002edf0: 2020 2020 2020 2064 656c 6574 655f 636d         delete_cm
-0002ee00: 6420 2b3d 2073 746f 7261 6765 5f6f 626a  d += storage_obj
-0002ee10: 5f6e 616d 650a 2020 2020 2020 2020 7375  _name.        su
-0002ee20: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0002ee30: 7574 7075 7428 6465 6c65 7465 5f63 6d64  utput(delete_cmd
-0002ee40: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002ee50: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-0002ee60: 746f 2063 6865 636b 2069 6620 616c 6c20  to check if all 
-0002ee70: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
-0002ee80: 6669 6c74 6572 6564 2062 7920 7374 6f72  filtered by stor
-0002ee90: 650a 2020 2020 2020 2020 2320 7479 7065  e.        # type
-0002eea0: 2061 7265 2064 656c 6574 6564 0a20 2020   are deleted.   
-0002eeb0: 2020 2020 206f 7574 5f61 6c6c 203d 2073       out_all = s
-0002eec0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002eed0: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-0002eee0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-0002eef0: 0a20 2020 2020 2020 206f 7574 203d 205b  .        out = [
-0002ef00: 0a20 2020 2020 2020 2020 2020 2069 7465  .            ite
-0002ef10: 6d2e 7370 6c69 7428 295b 305d 0a20 2020  m.split()[0].   
-0002ef20: 2020 2020 2020 2020 2066 6f72 2069 7465           for ite
-0002ef30: 6d20 696e 206f 7574 5f61 6c6c 2e64 6563  m in out_all.dec
-0002ef40: 6f64 6528 2775 7466 2d38 2729 2e73 706c  ode('utf-8').spl
-0002ef50: 6974 6c69 6e65 7328 290a 2020 2020 2020  itlines().      
-0002ef60: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-0002ef70: 7970 652e 7661 6c75 6520 696e 2069 7465  ype.value in ite
-0002ef80: 6d0a 2020 2020 2020 2020 5d0a 2020 2020  m.        ].    
-0002ef90: 2020 2020 6173 7365 7274 2061 6c6c 285b      assert all([
-0002efa0: 6974 656d 206e 6f74 2069 6e20 6f75 7420  item not in out 
-0002efb0: 666f 7220 6974 656d 2069 6e20 7374 6f72  for item in stor
-0002efc0: 6167 655f 6f62 6a5f 6e61 6d65 5d29 0a0a  age_obj_name])..
-0002efd0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0002efe0: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-0002eff0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0002f000: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-0002f010: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-0002f020: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0002f030: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-0002f040: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002f050: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-0002f060: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0002f070: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002f080: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
-0002f090: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
-0002f0a0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-0002f0b0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
-0002f0c0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
-0002f0d0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002f0e0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-0002f0f0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-0002f100: 745f 7570 6c6f 6164 5f73 6f75 7263 655f  t_upload_source_
-0002f110: 7769 7468 5f73 7061 6365 7328 7365 6c66  with_spaces(self
-0002f120: 2c20 7374 6f72 655f 7479 7065 2c0a 2020  , store_type,.  
-0002f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f150: 2020 2020 2074 6d70 5f6d 756c 7469 706c       tmp_multipl
-0002f160: 655f 6375 7374 6f6d 5f73 6f75 7263 655f  e_custom_source_
-0002f170: 7374 6f72 6167 655f 6f62 6a29 3a0a 2020  storage_obj):.  
-0002f180: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0002f190: 7477 6f20 6275 636b 6574 7320 7769 7468  two buckets with
-0002f1a0: 2073 7065 6369 6669 6564 206c 6f63 616c   specified local
-0002f1b0: 2073 6f75 7263 6573 0a20 2020 2020 2020   sources.       
-0002f1c0: 2023 2077 6974 6820 7370 6163 6573 2069   # with spaces i
-0002f1d0: 6e20 7468 6520 6e61 6d65 0a20 2020 2020  n the name.     
-0002f1e0: 2020 2073 746f 7261 6765 5f6f 626a 5f6e     storage_obj_n
-0002f1f0: 616d 6573 203d 205b 5d0a 2020 2020 2020  ames = [].      
-0002f200: 2020 666f 7220 7374 6f72 6167 655f 6f62    for storage_ob
-0002f210: 6a20 696e 2074 6d70 5f6d 756c 7469 706c  j in tmp_multipl
-0002f220: 655f 6375 7374 6f6d 5f73 6f75 7263 655f  e_custom_source_
-0002f230: 7374 6f72 6167 655f 6f62 6a3a 0a20 2020  storage_obj:.   
-0002f240: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-0002f250: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-0002f260: 746f 7265 5f74 7970 6529 0a20 2020 2020  tore_type).     
-0002f270: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-0002f280: 626a 5f6e 616d 6573 2e61 7070 656e 6428  bj_names.append(
-0002f290: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002f2a0: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-0002f2b0: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-0002f2c0: 746f 2063 6865 636b 2069 6620 616c 6c20  to check if all 
-0002f2d0: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
-0002f2e0: 6578 6973 7473 2069 6e20 7468 650a 2020  exists in the.  
-0002f2f0: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
-0002f300: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
-0002f310: 2074 7970 650a 2020 2020 2020 2020 6f75   type.        ou
-0002f320: 745f 616c 6c20 3d20 7375 6270 726f 6365  t_all = subproce
-0002f330: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002f340: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0002f350: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0002f360: 2020 6f75 7420 3d20 5b0a 2020 2020 2020    out = [.      
-0002f370: 2020 2020 2020 6974 656d 2e73 706c 6974        item.split
-0002f380: 2829 5b30 5d0a 2020 2020 2020 2020 2020  ()[0].          
-0002f390: 2020 666f 7220 6974 656d 2069 6e20 6f75    for item in ou
-0002f3a0: 745f 616c 6c2e 6465 636f 6465 2827 7574  t_all.decode('ut
-0002f3b0: 662d 3827 292e 7370 6c69 746c 696e 6573  f-8').splitlines
-0002f3c0: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
-0002f3d0: 6620 7374 6f72 655f 7479 7065 2e76 616c  f store_type.val
-0002f3e0: 7565 2069 6e20 6974 656d 0a20 2020 2020  ue in item.     
-0002f3f0: 2020 205d 0a20 2020 2020 2020 2061 7373     ].        ass
-0002f400: 6572 7420 616c 6c28 5b69 7465 6d20 696e  ert all([item in
-0002f410: 206f 7574 2066 6f72 2069 7465 6d20 696e   out for item in
-0002f420: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
-0002f430: 6573 5d29 0a0a 2020 2020 4070 7974 6573  es])..    @pytes
-0002f440: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002f450: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
-0002f460: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-0002f470: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
-0002f480: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
-0002f490: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002f4a0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
-0002f4b0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
-0002f4c0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002f4d0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
-0002f4e0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
-0002f4f0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0002f500: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
-0002f510: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-0002f520: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002f530: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-0002f540: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-0002f550: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
-0002f560: 6566 2074 6573 745f 6275 636b 6574 5f65  ef test_bucket_e
-0002f570: 7874 6572 6e61 6c5f 6465 6c65 7469 6f6e  xternal_deletion
-0002f580: 2873 656c 662c 2074 6d70 5f73 6372 6174  (self, tmp_scrat
-0002f590: 6368 5f73 746f 7261 6765 5f6f 626a 2c0a  ch_storage_obj,.
-0002f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5c0: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-0002f5d0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0002f5e0: 6174 6573 2061 2062 7563 6b65 742c 2064  ates a bucket, d
-0002f5f0: 656c 6574 6573 2069 7420 6578 7465 726e  eletes it extern
-0002f600: 616c 6c79 2075 7369 6e67 2063 6c6f 7564  ally using cloud
-0002f610: 2063 6c69 2063 6f6d 6d61 6e64 730a 2020   cli commands.  
-0002f620: 2020 2020 2020 2320 616e 6420 7468 656e        # and then
-0002f630: 2074 7269 6573 2074 6f20 6465 6c65 7465   tries to delete
-0002f640: 2069 7420 7573 696e 6720 736b 7920 7374   it using sky st
-0002f650: 6f72 6167 6520 6465 6c65 7465 2e0a 2020  orage delete..  
-0002f660: 2020 2020 2020 746d 705f 7363 7261 7463        tmp_scratc
-0002f670: 685f 7374 6f72 6167 655f 6f62 6a2e 6164  h_storage_obj.ad
-0002f680: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
-0002f690: 7065 290a 0a20 2020 2020 2020 2023 2052  pe)..        # R
-0002f6a0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
-0002f6b0: 7320 746f 2063 6865 636b 2069 6620 7374  s to check if st
-0002f6c0: 6f72 6167 6520 6f62 6a65 6374 2065 7869  orage object exi
-0002f6d0: 7374 7320 696e 2074 6865 206f 7574 7075  sts in the outpu
-0002f6e0: 740a 2020 2020 2020 2020 6f75 7420 3d20  t.        out = 
-0002f6f0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0002f700: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
-0002f710: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
-0002f720: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0002f730: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-0002f740: 7261 6765 5f6f 626a 2e6e 616d 6520 696e  rage_obj.name in
-0002f750: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
-0002f760: 2d38 2729 0a0a 2020 2020 2020 2020 2320  -8')..        # 
-0002f770: 4465 6c65 7465 2062 7563 6b65 7420 6578  Delete bucket ex
-0002f780: 7465 726e 616c 6c79 0a20 2020 2020 2020  ternally.       
-0002f790: 2063 6d64 203d 2073 656c 662e 636c 695f   cmd = self.cli_
-0002f7a0: 6465 6c65 7465 5f63 6d64 2873 746f 7265  delete_cmd(store
-0002f7b0: 5f74 7970 652c 2074 6d70 5f73 6372 6174  _type, tmp_scrat
-0002f7c0: 6368 5f73 746f 7261 6765 5f6f 626a 2e6e  ch_storage_obj.n
-0002f7d0: 616d 6529 0a20 2020 2020 2020 2073 7562  ame).        sub
-0002f7e0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0002f7f0: 7470 7574 2863 6d64 2c20 7368 656c 6c3d  tput(cmd, shell=
-0002f800: 5472 7565 290a 0a20 2020 2020 2020 2023  True)..        #
-0002f810: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002f820: 2064 656c 6574 6520 746f 2064 656c 6574   delete to delet
-0002f830: 6520 7468 6520 7374 6f72 6167 6520 6f62  e the storage ob
-0002f840: 6a65 6374 0a20 2020 2020 2020 206f 7574  ject.        out
-0002f850: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002f860: 6563 6b5f 6f75 7470 7574 280a 2020 2020  eck_output(.    
-0002f870: 2020 2020 2020 2020 5b27 736b 7927 2c20          ['sky', 
-0002f880: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
-0002f890: 7465 272c 2074 6d70 5f73 6372 6174 6368  te', tmp_scratch
-0002f8a0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0002f8b0: 652c 2027 2d2d 7965 7327 5d29 0a20 2020  e, '--yes']).   
-0002f8c0: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
-0002f8d0: 2062 7563 6b65 7420 7761 7320 6e6f 7420   bucket was not 
-0002f8e0: 6372 6561 7465 6420 6475 7269 6e67 2064  created during d
-0002f8f0: 656c 6574 696f 6e20 2873 6565 2069 7373  eletion (see iss
-0002f900: 7565 2023 3133 3232 290a 2020 2020 2020  ue #1322).      
-0002f910: 2020 6173 7365 7274 2027 6372 6561 7465    assert 'create
-0002f920: 6427 206e 6f74 2069 6e20 6f75 742e 6465  d' not in out.de
-0002f930: 636f 6465 2827 7574 662d 3827 292e 6c6f  code('utf-8').lo
-0002f940: 7765 7228 290a 0a20 2020 2020 2020 2023  wer()..        #
-0002f950: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-0002f960: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-0002f970: 7374 6f72 6167 6520 6f62 6a65 6374 2069  storage object i
-0002f980: 7320 6465 6c65 7465 640a 2020 2020 2020  s deleted.      
-0002f990: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-0002f9a0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0002f9b0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0002f9c0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0002f9d0: 2020 6173 7365 7274 2074 6d70 5f73 6372    assert tmp_scr
-0002f9e0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0002f9f0: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-0002fa00: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0002fa10: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0002fa20: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-0002fa30: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-0002fa40: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
-0002fa50: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
-0002fa60: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
-0002fa70: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
-0002fa80: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002fa90: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
-0002faa0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0002fab0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002fac0: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
-0002fad0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
-0002fae0: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
-0002faf0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
-0002fb00: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002fb10: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
-0002fb20: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
-0002fb30: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-0002fb40: 6573 745f 6275 636b 6574 5f62 756c 6b5f  est_bucket_bulk_
-0002fb50: 6465 6c65 7469 6f6e 2873 656c 662c 2073  deletion(self, s
-0002fb60: 746f 7265 5f74 7970 652c 2074 6d70 5f62  tore_type, tmp_b
-0002fb70: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
-0002fb80: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
-0002fb90: 4372 6561 7465 7320 6120 7465 6d70 2066  Creates a temp f
-0002fba0: 6f6c 6465 7220 7769 7468 206f 7665 7220  older with over 
-0002fbb0: 3235 3620 6669 6c65 7320 616e 6420 666f  256 files and fo
-0002fbc0: 6c64 6572 732c 2075 706c 6f61 640a 2020  lders, upload.  
-0002fbd0: 2020 2020 2020 2320 6669 6c65 7320 616e        # files an
-0002fbe0: 6420 666f 6c64 6572 7320 746f 2061 206e  d folders to a n
-0002fbf0: 6577 2062 7563 6b65 742c 2074 6865 6e20  ew bucket, then 
-0002fc00: 6465 6c65 7465 2062 7563 6b65 742e 0a20  delete bucket.. 
-0002fc10: 2020 2020 2020 2074 6d70 5f62 756c 6b5f         tmp_bulk_
-0002fc20: 6465 6c5f 7374 6f72 6167 655f 6f62 6a2e  del_storage_obj.
-0002fc30: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-0002fc40: 7479 7065 290a 0a20 2020 2020 2020 2073  type)..        s
-0002fc50: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0002fc60: 6f75 7470 7574 285b 0a20 2020 2020 2020  output([.       
-0002fc70: 2020 2020 2027 736b 7927 2c20 2773 746f       'sky', 'sto
-0002fc80: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-0002fc90: 2074 6d70 5f62 756c 6b5f 6465 6c5f 7374   tmp_bulk_del_st
-0002fca0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 2c20  orage_obj.name, 
-0002fcb0: 272d 2d79 6573 270a 2020 2020 2020 2020  '--yes'.        
-0002fcc0: 5d29 0a0a 2020 2020 2020 2020 6f75 7470  ])..        outp
-0002fcd0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0002fce0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-0002fcf0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-0002fd00: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
-0002fd10: 7373 6572 7420 746d 705f 6275 6c6b 5f64  ssert tmp_bulk_d
-0002fd20: 656c 5f73 746f 7261 6765 5f6f 626a 2e6e  el_storage_obj.n
-0002fd30: 616d 6520 6e6f 7420 696e 206f 7574 7075  ame not in outpu
-0002fd40: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0002fd50: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-0002fd60: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002fd70: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-0002fd80: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
-0002fd90: 2020 2020 2020 2020 2774 6d70 5f70 7562          'tmp_pub
-0002fda0: 6c69 635f 7374 6f72 6167 655f 6f62 6a2c  lic_storage_obj,
-0002fdb0: 2073 746f 7265 5f74 7970 6527 2c0a 2020   store_type',.  
-0002fdc0: 2020 2020 2020 5b28 2773 333a 2f2f 7463        [('s3://tc
-0002fdd0: 6761 2d32 2d6f 7065 6e27 2c20 7374 6f72  ga-2-open', stor
-0002fde0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0002fdf0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
-0002fe00: 2827 7333 3a2f 2f64 6967 6974 616c 636f  ('s3://digitalco
-0002fe10: 7270 6f72 6127 2c20 7374 6f72 6167 655f  rpora', storage_
-0002fe20: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0002fe30: 292c 0a20 2020 2020 2020 2020 2827 6773  ),.         ('gs
-0002fe40: 3a2f 2f67 6370 2d70 7562 6c69 632d 6461  ://gcp-public-da
-0002fe50: 7461 2d73 656e 7469 6e65 6c2d 3227 2c20  ta-sentinel-2', 
-0002fe60: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0002fe70: 6554 7970 652e 4743 5329 5d2c 0a20 2020  eType.GCS)],.   
-0002fe80: 2020 2020 2069 6e64 6972 6563 743d 5b27       indirect=['
-0002fe90: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
-0002fea0: 6765 5f6f 626a 275d 290a 2020 2020 6465  ge_obj']).    de
-0002feb0: 6620 7465 7374 5f70 7562 6c69 635f 6275  f test_public_bu
-0002fec0: 636b 6574 2873 656c 662c 2074 6d70 5f70  cket(self, tmp_p
-0002fed0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-0002fee0: 6a2c 2073 746f 7265 5f74 7970 6529 3a0a  j, store_type):.
-0002fef0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0002ff00: 7320 6120 6e65 7720 6275 636b 6574 2077  s a new bucket w
-0002ff10: 6974 6820 6120 7075 626c 6963 2073 6f75  ith a public sou
-0002ff20: 7263 6520 616e 6420 7665 7269 6669 6573  rce and verifies
-0002ff30: 2074 6861 7420 6974 2069 7320 6e6f 740a   that it is not.
-0002ff40: 2020 2020 2020 2020 2320 6164 6465 6420          # added 
-0002ff50: 746f 2067 6c6f 6261 6c5f 7573 6572 5f73  to global_user_s
-0002ff60: 7461 7465 2e0a 2020 2020 2020 2020 746d  tate..        tm
-0002ff70: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
-0002ff80: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-0002ff90: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-0002ffa0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
-0002ffb0: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
-0002ffc0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
-0002ffd0: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
-0002ffe0: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
-0002fff0: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-00030000: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-00030010: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-00030020: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
-00030030: 2061 7373 6572 7420 746d 705f 7075 626c   assert tmp_publ
-00030040: 6963 5f73 746f 7261 6765 5f6f 626a 2e6e  ic_storage_obj.n
-00030050: 616d 6520 6e6f 7420 696e 206f 7574 2e64  ame not in out.d
-00030060: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
-00030070: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00030080: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-00030090: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-000300a0: 7061 7261 6d65 7472 697a 6528 276e 6f6e  parametrize('non
-000300b0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-000300c0: 272c 205b 0a20 2020 2020 2020 2027 7333  ', [.        's3
-000300d0: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
-000300e0: 272c 2027 6773 3a2f 2f7b 7261 6e64 6f6d  ', 'gs://{random
-000300f0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-00030100: 2070 7974 6573 742e 7061 7261 6d28 2763   pytest.param('c
-00030110: 6f73 3a2f 2f75 732d 6561 7374 2f7b 7261  os://us-east/{ra
-00030120: 6e64 6f6d 5f6e 616d 657d 272c 206d 6172  ndom_name}', mar
-00030130: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-00030140: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-00030150: 6573 742e 7061 7261 6d28 2772 323a 2f2f  est.param('r2://
-00030160: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
-00030170: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-00030180: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
-00030190: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
-000301a0: 745f 6e6f 6e65 7869 7374 656e 745f 6275  t_nonexistent_bu
-000301b0: 636b 6574 2873 656c 662c 206e 6f6e 6578  cket(self, nonex
-000301c0: 6973 745f 6275 636b 6574 5f75 726c 293a  ist_bucket_url):
-000301d0: 0a20 2020 2020 2020 2023 2041 7474 656d  .        # Attem
-000301e0: 7074 7320 746f 2063 7265 6174 6520 6665  pts to create fe
-000301f0: 7463 6820 6120 7374 726f 6167 6520 7769  tch a stroage wi
-00030200: 7468 2061 206e 6f6e 2d65 7869 7374 656e  th a non-existen
-00030210: 7420 736f 7572 6365 2e0a 2020 2020 2020  t source..      
-00030220: 2020 2320 4765 6e65 7261 7465 2061 2072    # Generate a r
-00030230: 616e 646f 6d20 6275 636b 6574 206e 616d  andom bucket nam
-00030240: 6520 616e 6420 7665 7269 6679 2069 7420  e and verify it 
-00030250: 646f 6573 6e27 7420 6578 6973 743a 0a20  doesn't exist:. 
-00030260: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
-00030270: 6e74 203d 2030 0a20 2020 2020 2020 2077  nt = 0.        w
-00030280: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
-00030290: 2020 2020 2020 206e 6f6e 6578 6973 745f         nonexist_
-000302a0: 6275 636b 6574 5f6e 616d 6520 3d20 7374  bucket_name = st
-000302b0: 7228 7575 6964 2e75 7569 6434 2829 290a  r(uuid.uuid4()).
-000302c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000302d0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-000302e0: 726c 2e73 7461 7274 7377 6974 6828 2773  rl.startswith('s
-000302f0: 3327 293a 0a20 2020 2020 2020 2020 2020  3'):.           
-00030300: 2020 2020 2063 6f6d 6d61 6e64 203d 2066       command = f
-00030310: 2761 7773 2073 3361 7069 2068 6561 642d  'aws s3api head-
-00030320: 6275 636b 6574 202d 2d62 7563 6b65 7420  bucket --bucket 
-00030330: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-00030340: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
-00030350: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00030360: 5f6f 7574 7075 7420 3d20 2734 3034 270a  _output = '404'.
-00030370: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00030380: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-00030390: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
-000303a0: 2767 7327 293a 0a20 2020 2020 2020 2020  'gs'):.         
-000303b0: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
-000303c0: 2066 2767 7375 7469 6c20 6c73 207b 6e6f   f'gsutil ls {no
-000303d0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-000303e0: 6c2e 666f 726d 6174 2872 616e 646f 6d5f  l.format(random_
-000303f0: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
-00030400: 636b 6574 5f6e 616d 6529 7d27 0a20 2020  cket_name)}'.   
-00030410: 2020 2020 2020 2020 2020 2020 2065 7870               exp
-00030420: 6563 7465 645f 6f75 7470 7574 203d 2027  ected_output = '
-00030430: 4275 636b 6574 4e6f 7446 6f75 6e64 4578  BucketNotFoundEx
-00030440: 6365 7074 696f 6e27 0a20 2020 2020 2020  ception'.       
-00030450: 2020 2020 2065 6c69 6620 6e6f 6e65 7869       elif nonexi
-00030460: 7374 5f62 7563 6b65 745f 7572 6c2e 7374  st_bucket_url.st
-00030470: 6172 7473 7769 7468 2827 7232 2729 3a0a  artswith('r2'):.
-00030480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030490: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
-000304a0: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
-000304b0: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
-000304c0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-000304d0: 616e 6420 3d20 6627 4157 535f 5348 4152  and = f'AWS_SHAR
-000304e0: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
-000304f0: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
-00030500: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
-00030510: 4154 487d 2061 7773 2073 3361 7069 2068  ATH} aws s3api h
-00030520: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
-00030530: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
-00030540: 636b 6574 5f6e 616d 657d 202d 2d65 6e64  cket_name} --end
-00030550: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
-00030560: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
-00030570: 3227 0a20 2020 2020 2020 2020 2020 2020  2'.             
-00030580: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
-00030590: 7574 203d 2027 3430 3427 0a20 2020 2020  ut = '404'.     
-000305a0: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
-000305b0: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-000305c0: 7374 6172 7473 7769 7468 2827 636f 7327  startswith('cos'
-000305d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000305e0: 2020 2023 2055 7369 6e67 2041 5049 2063     # Using API c
-000305f0: 616c 6c73 2c20 7369 6e63 6520 7573 696e  alls, since usin
-00030600: 6720 7263 6c6f 6e65 2072 6571 7569 7265  g rclone require
-00030610: 7320 6120 7072 6f66 696c 6527 7320 6e61  s a profile's na
-00030620: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-00030630: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00030640: 2020 2020 2020 2020 2020 2020 6578 7065              expe
-00030650: 6374 6564 5f6f 7574 7075 7420 3d20 636f  cted_output = co
-00030660: 6d6d 616e 6420 3d20 2265 6368 6f22 2020  mmand = "echo"  
-00030670: 2320 6176 6f69 6420 756e 7265 6c61 7465  # avoid unrelate
-00030680: 6420 6578 6365 7074 696f 6e20 696e 2063  d exception in c
-00030690: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
-000306a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306b0: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
-000306c0: 3d20 7572 6c6c 6962 2e70 6172 7365 2e75  = urllib.parse.u
-000306d0: 726c 7370 6c69 7428 0a20 2020 2020 2020  rlsplit(.       
-000306e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306f0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
-00030700: 5f75 726c 2e66 6f72 6d61 7428 0a20 2020  _url.format(.   
-00030710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030720: 2020 2020 2020 2020 2072 616e 646f 6d5f           random_
-00030730: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
-00030740: 636b 6574 5f6e 616d 6529 292e 7061 7468  cket_name)).path
-00030750: 2e73 7472 6970 2827 2f27 290a 2020 2020  .strip('/').    
+00024970: 6963 6173 2220 7c20 6772 6570 2022 5348  icas" | grep "SH
+00024980: 5554 5449 4e47 5f44 4f57 4e22 3b20 270a  UTTING_DOWN"; '.
+00024990: 2020 2020 2020 2020 2020 2020 2764 6f20              'do 
+000249a0: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
+000249b0: 7220 6669 7273 7420 7365 7276 6963 6520  r first service 
+000249c0: 746f 2062 6520 5348 5554 5449 4e47 2044  to be SHUTTING D
+000249d0: 4f57 4e2e 2e2e 223b 2027 0a20 2020 2020  OWN..."; '.     
+000249e0: 2020 2020 2020 2066 2773 6c65 6570 2035         f'sleep 5
+000249f0: 3b20 733d 2428 736b 7920 7365 7276 6520  ; s=$(sky serve 
+00024a00: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00024a10: 6563 686f 2022 2473 223b 2064 6f6e 653b  echo "$s"; done;
+00024a20: 2027 2c0a 2020 2020 2020 2020 2020 2020   ',.            
+00024a30: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+00024a40: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00024a50: 6563 686f 2022 2473 223b 270a 2020 2020  echo "$s";'.    
+00024a60: 2020 2020 2020 2020 2775 6e74 696c 2065          'until e
+00024a70: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00024a80: 2d41 2031 3030 2022 5365 7276 6963 6520  -A 100 "Service 
+00024a90: 5265 706c 6963 6173 2220 7c20 6772 6570  Replicas" | grep
+00024aa0: 2022 4641 494c 4544 223b 2027 0a20 2020   "FAILED"; '.   
+00024ab0: 2020 2020 2020 2020 2027 646f 2065 6368           'do ech
+00024ac0: 6f20 2257 6169 7469 6e67 2066 6f72 2066  o "Waiting for f
+00024ad0: 6972 7374 2073 6572 7669 6365 2074 6f20  irst service to 
+00024ae0: 6265 2046 4149 4c45 442e 2e2e 223b 2027  be FAILED..."; '
+00024af0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00024b00: 6c65 6570 2035 3b20 733d 2428 736b 7920  leep 5; s=$(sky 
+00024b10: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
+00024b20: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+00024b30: 2064 6f6e 653b 2065 6368 6f20 2224 7322   done; echo "$s"
+00024b40: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00024b50: 2b20 5f63 6865 636b 5f72 6570 6c69 6361  + _check_replica
+00024b60: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+00024b70: 205b 2831 2c20 5472 7565 2c20 2746 4149   [(1, True, 'FAI
+00024b80: 4c45 4427 295d 2920 2b0a 2020 2020 2020  LED')]) +.      
+00024b90: 2020 2020 2020 2320 5573 6572 2062 7567        # User bug
+00024ba0: 2066 6169 6c75 7265 2077 696c 6c20 6361   failure will ca
+00024bb0: 7573 6520 6e6f 2066 7572 7468 6572 2073  use no further s
+00024bc0: 6361 6c69 6e67 2e0a 2020 2020 2020 2020  caling..        
+00024bd0: 2020 2020 6627 6563 686f 2022 2473 2220      f'echo "$s" 
+00024be0: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
+00024bf0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00024c00: 207c 2067 7265 7020 227b 6e61 6d65 7d22   | grep "{name}"
+00024c10: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
+00024c20: 313b 2027 0a20 2020 2020 2020 2020 2020  1; '.           
+00024c30: 2066 2765 6368 6f20 2224 7322 207c 2067   f'echo "$s" | g
+00024c40: 7265 7020 2d42 2031 3030 2022 4e4f 5f52  rep -B 100 "NO_R
+00024c50: 4550 4c49 4341 2220 7c20 6772 6570 2022  EPLICA" | grep "
+00024c60: 302f 3022 272c 0a20 2020 2020 2020 2020  0/0"',.         
+00024c70: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00024c80: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
+00024c90: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00024ca0: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00024cb0: 7973 6572 7665 2f61 7574 6f5f 7265 7374  yserve/auto_rest
+00024cc0: 6172 742e 7961 6d6c 272c 0a20 2020 2020  art.yaml',.     
+00024cd0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00024ce0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00024cf0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00024d00: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00024d10: 2027 756e 7469 6c20 6375 726c 2068 7474   'until curl htt
+00024d20: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00024d30: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00024d40: 6f74 2068 6572 6521 223b 2064 6f20 736c  ot here!"; do sl
+00024d50: 6565 7020 323b 2064 6f6e 653b 2073 6c65  eep 2; done; sle
+00024d60: 6570 2032 3b20 270a 2020 2020 2020 2020  ep 2; '.        
+00024d70: 2020 2020 2b20 5f63 6865 636b 5f72 6570      + _check_rep
+00024d80: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
+00024d90: 616d 652c 205b 2831 2c20 4661 6c73 652c  ame, [(1, False,
+00024da0: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
+00024db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024dd0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+00024de0: 7365 2c20 2746 4149 4c45 4427 295d 292c  se, 'FAILED')]),
+00024df0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00024e00: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
+00024e10: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
+00024e20: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00024e30: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00024e40: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00024e50: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00024e60: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+00024e70: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
+00024e80: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+00024e90: 2320 5265 706c 6963 6173 206f 6e20 6b38  # Replicas on k8
+00024ea0: 7320 6d61 7920 6265 2072 756e 6e69 6e67  s may be running
+00024eb0: 206f 6e20 7468 6520 7361 6d65 206e 6f64   on the same nod
+00024ec0: 6520 616e 6420 6861 7665 2074 6865 2073  e and have the s
+00024ed0: 616d 6520 7075 626c 6963 2049 500a 6465  ame public IP.de
+00024ee0: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
+00024ef0: 6c6f 6164 5f62 616c 616e 6365 7228 6765  load_balancer(ge
+00024f00: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00024f10: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00024f20: 6b79 7365 7276 6520 6c6f 6164 2062 616c  kyserve load bal
+00024f30: 616e 6365 7220 726f 756e 642d 726f 6269  ancer round-robi
+00024f40: 6e20 706f 6c69 6379 2222 220a 2020 2020  n policy""".    
+00024f50: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00024f60: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
+00024f70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00024f80: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00024f90: 7276 652d 6c6f 6164 2d62 616c 616e 6365  rve-load-balance
+00024fa0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+00024fb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00024fc0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00024fd0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00024fe0: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00024ff0: 7374 732f 736b 7973 6572 7665 2f6c 6f61  sts/skyserve/loa
+00025000: 645f 6261 6c61 6e63 6572 2f73 6572 7669  d_balancer/servi
+00025010: 6365 2e79 616d 6c27 2c0a 2020 2020 2020  ce.yaml',.      
+00025020: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00025030: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00025040: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00025050: 7265 706c 6963 615f 6e75 6d3d 3329 2c0a  replica_num=3),.
+00025060: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00025070: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00025080: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00025090: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+000250a0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+000250b0: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+000250c0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+000250d0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+000250e0: 7b5f 6765 745f 7265 706c 6963 615f 6970  {_get_replica_ip
+000250f0: 286e 616d 652c 2031 297d 3b20 270a 2020  (name, 1)}; '.  
+00025100: 2020 2020 2020 2020 2020 6627 7b5f 6765            f'{_ge
+00025110: 745f 7265 706c 6963 615f 6970 286e 616d  t_replica_ip(nam
+00025120: 652c 2032 297d 3b20 7b5f 6765 745f 7265  e, 2)}; {_get_re
+00025130: 706c 6963 615f 6970 286e 616d 652c 2033  plica_ip(name, 3
+00025140: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00025150: 2020 2770 7974 686f 6e20 7465 7374 732f    'python tests/
+00025160: 736b 7973 6572 7665 2f6c 6f61 645f 6261  skyserve/load_ba
+00025170: 6c61 6e63 6572 2f74 6573 745f 726f 756e  lancer/test_roun
+00025180: 645f 726f 6269 6e2e 7079 2027 0a20 2020  d_robin.py '.   
+00025190: 2020 2020 2020 2020 2027 2d2d 656e 6470           '--endp
+000251a0: 6f69 6e74 2024 656e 6470 6f69 6e74 202d  oint $endpoint -
+000251b0: 2d72 6570 6c69 6361 2d6e 756d 2033 202d  -replica-num 3 -
+000251c0: 2d72 6570 6c69 6361 2d69 7073 2024 6970  -replica-ips $ip
+000251d0: 3120 2469 7032 2024 6970 3327 2c0a 2020  1 $ip2 $ip3',.  
+000251e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000251f0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00025200: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00025210: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00025220: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00025230: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00025240: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00025250: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+00025260: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00025270: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
+00025280: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
+00025290: 2074 6573 745f 736b 7973 6572 7665 5f61   test_skyserve_a
+000252a0: 7574 6f5f 7265 7374 6172 7428 293a 0a20  uto_restart():. 
+000252b0: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+000252c0: 7276 6520 7769 7468 2061 7574 6f20 7265  rve with auto re
+000252d0: 7374 6172 7422 2222 0a20 2020 206e 616d  start""".    nam
+000252e0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+000252f0: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
+00025300: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
+00025310: 6127 0a20 2020 2074 6573 7420 3d20 5465  a'.    test = Te
+00025320: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00025330: 7374 2d73 6b79 7365 7276 652d 6175 746f  st-skyserve-auto
+00025340: 2d72 6573 7461 7274 272c 0a20 2020 2020  -restart',.     
+00025350: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00025360: 2023 2054 4f44 4f28 7469 616e 293a 2077   # TODO(tian): w
+00025370: 6520 6361 6e20 6479 6e61 6d69 6361 6c6c  e can dynamicall
+00025380: 7920 6765 6e65 7261 7465 2059 414d 4c20  y generate YAML 
+00025390: 6672 6f6d 2074 656d 706c 6174 6520 746f  from template to
+000253a0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000253b0: 766f 6964 206d 6169 6e74 6169 6e69 6e67  void maintaining
+000253c0: 2074 6f6f 206d 616e 7920 5941 4d4c 2066   too many YAML f
+000253d0: 696c 6573 0a20 2020 2020 2020 2020 2020  iles.           
+000253e0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+000253f0: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
+00025400: 7473 2f73 6b79 7365 7276 652f 6175 746f  ts/skyserve/auto
+00025410: 5f72 6573 7461 7274 2e79 616d 6c27 2c0a  _restart.yaml',.
+00025420: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00025430: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00025440: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00025450: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00025460: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
+00025470: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025480: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025490: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+000254a0: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+000254b0: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+000254c0: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+000254d0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+000254e0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+000254f0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00025500: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+00025510: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025520: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00025530: 736c 6565 7020 666f 7220 3230 2073 6563  sleep for 20 sec
+00025540: 6f6e 6473 2028 696e 6974 6961 6c20 6465  onds (initial de
+00025550: 6c61 7929 2074 6f20 6d61 6b65 2073 7572  lay) to make sur
+00025560: 6520 6974 2077 696c 6c0a 2020 2020 2020  e it will.      
+00025570: 2020 2020 2020 2320 6265 2072 6573 7461        # be resta
+00025580: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+00025590: 2066 2773 6c65 6570 2032 3027 2c0a 2020   f'sleep 20',.  
+000255a0: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
+000255b0: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
+000255c0: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
+000255d0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+000255e0: 6169 7420 666f 7220 636f 6e73 6563 7574  ait for consecut
+000255f0: 6976 6520 6661 696c 7572 6520 7469 6d65  ive failure time
+00025600: 6f75 7420 7061 7373 6564 2e0a 2020 2020  out passed..    
+00025610: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+00025620: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+00025630: 7573 696e 6720 7370 6f74 2c20 6974 2077  using spot, it w
+00025640: 6f6e 2774 2063 6865 636b 2074 6865 2063  on't check the c
+00025650: 6c75 7374 6572 2073 7461 7475 730a 2020  luster status.  
+00025660: 2020 2020 2020 2020 2020 2320 6f6e 2074            # on t
+00025670: 6865 2063 6c6f 7564 2028 7369 6e63 6520  he cloud (since 
+00025680: 6d61 6e75 616c 2073 6875 7464 6f77 6e20  manual shutdown 
+00025690: 6973 206e 6f74 2061 2063 6f6d 6d6f 6e20  is not a common 
+000256a0: 6265 6861 7669 6f72 2061 6e64 2073 7563  behavior and suc
+000256b0: 680a 2020 2020 2020 2020 2020 2020 2320  h.            # 
+000256c0: 7175 6572 6965 7320 7461 6b65 7320 6120  queries takes a 
+000256d0: 6c6f 7420 6f66 2074 696d 6529 2e20 496e  lot of time). In
+000256e0: 7374 6561 642c 2077 6520 7468 696e 6b20  stead, we think 
+000256f0: 636f 6e74 696e 756f 7573 2033 206d 696e  continuous 3 min
+00025700: 2070 726f 6265 0a20 2020 2020 2020 2020   probe.         
+00025710: 2020 2023 2066 6169 6c75 7265 2069 7320     # failure is 
+00025720: 6e6f 7420 6120 7465 6d70 6f72 6172 7920  not a temporary 
+00025730: 7072 6f62 6c65 6d20 6275 7420 696e 6465  problem but inde
+00025740: 6564 2061 2066 6169 6c75 7265 2e0a 2020  ed a failure..  
+00025750: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00025760: 2031 3830 272c 0a20 2020 2020 2020 2020   180',.         
+00025770: 2020 2023 2057 6520 6361 6e6e 6f74 2075     # We cannot u
+00025780: 7365 205f 5345 5256 455f 5741 4954 5f55  se _SERVE_WAIT_U
+00025790: 4e54 494c 5f52 4541 4459 3b20 7468 6572  NTIL_READY; ther
+000257a0: 6520 7769 6c6c 2062 6520 6120 696e 7465  e will be a inte
+000257b0: 726d 6564 6961 7465 2074 696d 650a 2020  rmediate time.  
+000257c0: 2020 2020 2020 2020 2020 2320 7468 6174            # that
+000257d0: 2074 6865 206f 7574 7075 7420 6f66 2060   the output of `
+000257e0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+000257f0: 6020 7368 6f77 7320 4641 494c 4544 2061  ` shows FAILED a
+00025800: 6e64 2074 6869 7320 7374 6174 7573 2077  nd this status w
+00025810: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
+00025820: 2320 6361 7573 6520 5f53 4552 5645 5f57  # cause _SERVE_W
+00025830: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
+00025840: 746f 2065 6172 6c79 2071 7569 742e 0a20  to early quit.. 
+00025850: 2020 2020 2020 2020 2020 2027 2877 6869             '(whi
+00025860: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
+00025870: 2020 2020 2020 2020 2066 2720 2020 206f           f'    o
+00025880: 7574 7075 743d 2428 736b 7920 7365 7276  utput=$(sky serv
+00025890: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+000258a0: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+000258b0: 2020 2020 2065 6368 6f20 2224 6f75 7470       echo "$outp
+000258c0: 7574 2220 7c20 6772 6570 202d 7120 2231  ut" | grep -q "1
+000258d0: 2f31 2220 2626 2062 7265 616b 3b27 0a20  /1" && break;'. 
+000258e0: 2020 2020 2020 2020 2020 2027 2020 2020             '    
+000258f0: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
+00025900: 2020 2020 2020 2020 6627 646f 6e65 293b          f'done);
+00025910: 2073 6c65 6570 207b 7365 7276 652e 4c42   sleep {serve.LB
+00025920: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
+00025930: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00025940: 537d 3b27 2c0a 2020 2020 2020 2020 2020  S};',.          
+00025950: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025960: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025970: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00025980: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+00025990: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+000259a0: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+000259b0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+000259c0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+000259d0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+000259e0: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+000259f0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025a00: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00025a10: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00025a20: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00025a30: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00025a40: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00025a50: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00025a60: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00025a70: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00025a80: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
+00025a90: 7973 6572 7665 5f63 616e 6365 6c28 6765  yserve_cancel(ge
+00025aa0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00025ab0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00025ac0: 6b79 7365 7276 6520 7769 7468 2063 616e  kyserve with can
+00025ad0: 6365 6c22 2222 0a20 2020 206e 616d 6520  cel""".    name 
+00025ae0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00025af0: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00025b00: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00025b10: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00025b20: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00025b30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00025b40: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00025b50: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00025b60: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00025b70: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025b80: 652f 6361 6e63 656c 2f63 616e 6365 6c2e  e/cancel/cancel.
+00025b90: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00025ba0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00025bb0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00025bc0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00025bd0: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
+00025be0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00025bf0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00025c00: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025c10: 6529 7d3b 2070 7974 686f 6e33 2027 0a20  e)}; python3 '. 
+00025c20: 2020 2020 2020 2020 2020 2027 7465 7374             'test
+00025c30: 732f 736b 7973 6572 7665 2f63 616e 6365  s/skyserve/cance
+00025c40: 6c2f 7365 6e64 5f63 616e 6365 6c5f 7265  l/send_cancel_re
+00025c50: 7175 6573 742e 7079 2027 0a20 2020 2020  quest.py '.     
+00025c60: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
+00025c70: 6e74 2024 656e 6470 6f69 6e74 207c 2067  nt $endpoint | g
+00025c80: 7265 7020 2252 6571 7565 7374 2077 6173  rep "Request was
+00025c90: 2063 616e 6365 6c6c 6564 2227 2c0a 2020   cancelled"',.  
+00025ca0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00025cb0: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
+00025cc0: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
+00025cd0: 6c6f 7729 3b20 270a 2020 2020 2020 2020  low); '.        
+00025ce0: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
+00025cf0: 6f20 2224 7322 207c 2067 7265 7020 2250  o "$s" | grep "P
+00025d00: 6c65 6173 6520 7761 6974 2066 6f72 2074  lease wait for t
+00025d10: 6865 2063 6f6e 7472 6f6c 6c65 7220 746f  he controller to
+00025d20: 2062 6522 3b20 270a 2020 2020 2020 2020   be"; '.        
+00025d30: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00025d40: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+00025d50: 6c6f 6773 223b 2073 6c65 6570 2031 303b  logs"; sleep 10;
+00025d60: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00025d70: 2773 3d24 2873 6b79 2073 6572 7665 206c  's=$(sky serve l
+00025d80: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
+00025d90: 6f2d 666f 6c6c 6f77 293b 2064 6f6e 653b  o-follow); done;
+00025da0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00025db0: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
+00025dc0: 2224 7322 207c 2067 7265 7020 2243 6c69  "$s" | grep "Cli
+00025dd0: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
+00025de0: 2c20 7374 6f70 7069 6e67 2063 6f6d 7075  , stopping compu
+00025df0: 7461 7469 6f6e 2227 2c0a 2020 2020 2020  tation"',.      
+00025e00: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00025e10: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00025e20: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025e30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00025e40: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00025e50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00025e60: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00025e70: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00025e80: 2074 6573 745f 736b 7973 6572 7665 5f73   test_skyserve_s
+00025e90: 7472 6561 6d69 6e67 2867 656e 6572 6963  treaming(generic
+00025ea0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00025eb0: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00025ec0: 7665 2077 6974 6820 7374 7265 616d 696e  ve with streamin
+00025ed0: 6722 2222 0a20 2020 206e 616d 6520 3d20  g""".    name = 
+00025ee0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00025ef0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00025f00: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+00025f10: 6573 742d 736b 7973 6572 7665 2d73 7472  est-skyserve-str
+00025f20: 6561 6d69 6e67 272c 0a20 2020 2020 2020  eaming',.       
+00025f30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00025f40: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00025f50: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00025f60: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00025f70: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025f80: 652f 7374 7265 616d 696e 672f 7374 7265  e/streaming/stre
+00025f90: 616d 696e 672e 7961 6d6c 272c 0a20 2020  aming.yaml',.   
+00025fa0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00025fb0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00025fc0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025fd0: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+00025fe0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00025ff0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00026000: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00026010: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00026020: 2020 2020 2020 2020 2027 7079 7468 6f6e           'python
+00026030: 3320 7465 7374 732f 736b 7973 6572 7665  3 tests/skyserve
+00026040: 2f73 7472 6561 6d69 6e67 2f73 656e 645f  /streaming/send_
+00026050: 7374 7265 616d 696e 675f 7265 7175 6573  streaming_reques
+00026060: 742e 7079 2027 0a20 2020 2020 2020 2020  t.py '.         
+00026070: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
+00026080: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00026090: 2253 7472 6561 6d69 6e67 2074 6573 7420  "Streaming test 
+000260a0: 7061 7373 6564 2227 2c0a 2020 2020 2020  passed"',.      
+000260b0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+000260c0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+000260d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000260e0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000260f0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00026100: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00026110: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00026120: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00026130: 2074 6573 745f 736b 7973 6572 7665 5f75   test_skyserve_u
+00026140: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+00026150: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026160: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026170: 7769 7468 2075 7064 6174 6522 2222 0a20  with update""". 
+00026180: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00026190: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+000261a0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000261b0: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+000261c0: 7973 6572 7665 2d75 7064 6174 6527 2c0a  yserve-update',.
+000261d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000261e0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+000261f0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00026200: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00026210: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00026220: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00026230: 6f6c 642e 7961 6d6c 272c 0a20 2020 2020  old.yaml',.     
+00026240: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00026250: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00026260: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00026270: 2072 6570 6c69 6361 5f6e 756d 3d32 292c   replica_num=2),
+00026280: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00026290: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+000262a0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+000262b0: 3d6e 616d 6529 7d3b 2063 7572 6c20 6874  =name)}; curl ht
+000262c0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+000262d0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+000262e0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+000262f0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00026300: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00026310: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00026320: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
+00026330: 2062 6c75 655f 6772 6565 6e20 2d79 2074   blue_green -y t
+00026340: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+00026350: 6461 7465 2f6e 6577 2e79 616d 6c27 2c0a  date/new.yaml',.
+00026360: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
+00026370: 6565 7020 6265 666f 7265 2075 7064 6174  eep before updat
+00026380: 6520 6973 2072 6567 6973 7465 7265 642e  e is registered.
+00026390: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000263a0: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
+000263b0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+000263c0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+000263d0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+000263e0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+000263f0: 756e 7469 6c20 6375 726c 2068 7474 703a  until curl http:
+00026400: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00026410: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
+00026420: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
+00026430: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
+00026440: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00026450: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
+00026460: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
+00026470: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
+00026480: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+00026490: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+000264a0: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
+000264b0: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+000264c0: 2023 2054 6865 206c 6174 6573 7420 3220   # The latest 2 
+000264d0: 7665 7273 696f 6e20 7368 6f75 6c64 2062  version should b
+000264e0: 6520 5245 4144 5920 616e 6420 7468 6520  e READY and the 
+000264f0: 6f6c 6465 7220 7665 7273 696f 6e73 2073  older versions s
+00026500: 686f 756c 6420 6265 2073 6875 7474 696e  hould be shuttin
+00026510: 6720 646f 776e 0a20 2020 2020 2020 2020  g down.         
+00026520: 2020 2028 5f63 6865 636b 5f72 6570 6c69     (_check_repli
+00026530: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00026540: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
+00026550: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00026560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026580: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
+00026590: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
+000265a0: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
+000265b0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+000265c0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+000265d0: 2232 2229 292c 0a20 2020 2020 2020 205d  "2")),.        ]
+000265e0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+000265f0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00026600: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00026610: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00026620: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00026630: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00026640: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00026650: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00026660: 7374 5f73 6b79 7365 7276 655f 726f 6c6c  st_skyserve_roll
+00026670: 696e 675f 7570 6461 7465 2867 656e 6572  ing_update(gener
+00026680: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00026690: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+000266a0: 6572 7665 2077 6974 6820 726f 6c6c 696e  erve with rollin
+000266b0: 6720 7570 6461 7465 2222 220a 2020 2020  g update""".    
+000266c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+000266d0: 6963 655f 6e61 6d65 2829 0a20 2020 2073  ice_name().    s
+000266e0: 696e 676c 655f 6e65 775f 7265 706c 6963  ingle_new_replic
+000266f0: 6120 3d20 5f63 6865 636b 5f72 6570 6c69  a = _check_repli
+00026700: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
+00026710: 2020 2020 2020 6e61 6d65 2c20 5b28 322c        name, [(2,
+00026720: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00026730: 2c20 2831 2c20 4661 6c73 652c 205f 5345  , (1, False, _SE
+00026740: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00026750: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00026760: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00026770: 2c20 4661 6c73 652c 2027 5348 5554 5449  , False, 'SHUTTI
+00026780: 4e47 5f44 4f57 4e27 295d 290a 2020 2020  NG_DOWN')]).    
+00026790: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000267a0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+000267b0: 6572 7665 2d72 6f6c 6c69 6e67 2d75 7064  erve-rolling-upd
+000267c0: 6174 6527 2c0a 2020 2020 2020 2020 5b0a  ate',.        [.
+000267d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000267e0: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+000267f0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00026800: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00026810: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
+00026820: 7064 6174 652f 6f6c 642e 7961 6d6c 272c  pdate/old.yaml',
+00026830: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00026840: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00026850: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00026860: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00026870: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
+00026880: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+00026890: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000268a0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2063  t(name=name)}; c
+000268b0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+000268c0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+000268d0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+000268e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000268f0: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
+00026900: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00026910: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00026920: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00026930: 652f 7570 6461 7465 2f6e 6577 2e79 616d  e/update/new.yam
+00026940: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00026950: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+00026960: 7472 6166 6669 6320 6973 206d 6978 6564  traffic is mixed
+00026970: 2061 6372 6f73 7320 7477 6f20 7665 7273   across two vers
+00026980: 696f 6e73 2c20 7468 6520 7265 706c 6963  ions, the replic
+00026990: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+000269a0: 2077 6974 6820 6576 656e 2069 6420 7769   with even id wi
+000269b0: 6c6c 2073 6c65 6570 2036 3020 7365 636f  ll sleep 60 seco
+000269c0: 6e64 7320 6265 666f 7265 2062 6569 6e67  nds before being
+000269d0: 2072 6561 6479 2c20 736f 2077 650a 2020   ready, so we.  
+000269e0: 2020 2020 2020 2020 2020 2320 7368 6f75            # shou
+000269f0: 6c64 2062 6520 6162 6c65 2074 6f20 6765  ld be able to ge
+00026a00: 7420 6f62 7365 7276 6520 7468 6520 7065  t observe the pe
+00026a10: 7269 6f64 2074 6861 7420 7468 6520 7472  riod that the tr
+00026a20: 6166 6669 6320 6973 206d 6978 6564 0a20  affic is mixed. 
+00026a30: 2020 2020 2020 2020 2020 2023 2061 6372             # acr
+00026a40: 6f73 7320 7477 6f20 7665 7273 696f 6e73  oss two versions
+00026a50: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00026a60: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00026a70: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00026a80: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00026a90: 2020 2020 2020 2020 2775 6e74 696c 2063          'until c
+00026aa0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00026ab0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00026ac0: 206e 6577 2053 6b79 5069 6c6f 7420 6865   new SkyPilot he
+00026ad0: 7265 2122 3b20 646f 2073 6c65 6570 2032  re!"; do sleep 2
+00026ae0: 3b20 646f 6e65 3b20 736c 6565 7020 323b  ; done; sleep 2;
+00026af0: 2027 0a20 2020 2020 2020 2020 2020 2023   '.            #
+00026b00: 2054 6865 206c 6174 6573 7420 7665 7273   The latest vers
+00026b10: 696f 6e20 7368 6f75 6c64 2068 6176 6520  ion should have 
+00026b20: 6f6e 6520 5245 4144 5920 616e 6420 7468  one READY and th
+00026b30: 6520 6f6e 6520 6f66 2074 6865 206f 6c64  e one of the old
+00026b40: 6572 2076 6572 7369 6f6e 7320 7368 6f75  er versions shou
+00026b50: 6c64 2062 6520 7368 7574 7469 6e67 2064  ld be shutting d
+00026b60: 6f77 6e0a 2020 2020 2020 2020 2020 2020  own.            
+00026b70: 6627 7b73 696e 676c 655f 6e65 775f 7265  f'{single_new_re
+00026b80: 706c 6963 617d 207b 5f63 6865 636b 5f73  plica} {_check_s
+00026b90: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00026ba0: 616d 652c 2022 312c 3222 297d 2027 0a20  ame, "1,2")} '. 
+00026bb0: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+00026bc0: 636b 2074 6865 206f 7574 7075 7420 6672  ck the output fr
+00026bd0: 6f6d 2074 6865 206f 6c64 2076 6572 7369  om the old versi
+00026be0: 6f6e 2c20 696d 6d65 6469 6174 656c 7920  on, immediately 
+00026bf0: 6166 7465 7220 7468 650a 2020 2020 2020  after the.      
+00026c00: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00026c10: 726f 6d20 7468 6520 6e65 7720 7665 7273  rom the new vers
+00026c20: 696f 6e20 6170 7065 6172 732e 2054 6869  ion appears. Thi
+00026c30: 7320 6973 2067 7561 7261 6e74 6565 6420  s is guaranteed 
+00026c40: 6279 2074 6865 0a20 2020 2020 2020 2020  by the.         
+00026c50: 2020 2023 2072 6f75 6e64 2072 6f62 696e     # round robin
+00026c60: 206c 6f61 6420 6261 6c61 6e63 696e 6720   load balancing 
+00026c70: 706f 6c69 6379 2e0a 2020 2020 2020 2020  policy..        
+00026c80: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
+00026c90: 3a20 7765 2073 686f 756c 6420 6861 7665  : we should have
+00026ca0: 2061 206d 6f72 6520 6765 6e65 7261 6c69   a more generali
+00026cb0: 7a65 6420 7761 7920 666f 7220 6368 6563  zed way for chec
+00026cc0: 6b69 6e67 2074 6865 0a20 2020 2020 2020  king the.       
+00026cd0: 2020 2020 2023 206d 6978 6564 2076 6572       # mixed ver
+00026ce0: 7369 6f6e 206f 6620 7265 706c 6963 6173  sion of replicas
+00026cf0: 2074 6f20 6176 6f69 6420 6465 7065 6e64   to avoid depend
+00026d00: 696e 6720 6f6e 2074 6865 2073 7065 6369  ing on the speci
+00026d10: 6669 630a 2020 2020 2020 2020 2020 2020  fic.            
+00026d20: 2320 726f 756e 6420 726f 6269 6e20 6c6f  # round robin lo
+00026d30: 6164 2062 616c 616e 6369 6e67 2070 6f6c  ad balancing pol
+00026d40: 6963 792e 0a20 2020 2020 2020 2020 2020  icy..           
+00026d50: 2027 6375 726c 2068 7474 703a 2f2f 2465   'curl http://$e
+00026d60: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00026d70: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00026d80: 6522 272c 0a20 2020 2020 2020 205d 2c0a  e"',.        ],.
+00026d90: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00026da0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00026db0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00026dc0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00026dd0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00026de0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00026df0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00026e00: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00026e10: 5f73 6b79 7365 7276 655f 6661 7374 5f75  _skyserve_fast_u
+00026e20: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+00026e30: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026e40: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026e50: 7769 7468 2066 6173 7420 7570 6461 7465  with fast update
+00026e60: 2028 496e 6372 656d 656e 7420 7665 7273   (Increment vers
+00026e70: 696f 6e20 6f66 206f 6c64 2072 6570 6c69  ion of old repli
+00026e80: 6361 7329 2222 220a 2020 2020 6e61 6d65  cas)""".    name
+00026e90: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00026ea0: 6e61 6d65 2829 0a0a 2020 2020 7465 7374  name()..    test
+00026eb0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00026ec0: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00026ed0: 2d66 6173 742d 7570 6461 7465 272c 0a20  -fast-update',. 
+00026ee0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00026ef0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00026f00: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
+00026f10: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00026f20: 635f 636c 6f75 647d 2074 6573 7473 2f73  c_cloud} tests/s
+00026f30: 6b79 7365 7276 652f 7570 6461 7465 2f62  kyserve/update/b
+00026f40: 756d 705f 7665 7273 696f 6e5f 6265 666f  ump_version_befo
+00026f50: 7265 2e79 616d 6c27 2c0a 2020 2020 2020  re.yaml',.      
+00026f60: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00026f70: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00026f80: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00026f90: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
+00026fa0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00026fb0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00026fc0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00026fd0: 6e61 6d65 297d 3b20 6375 726c 2068 7474  name)}; curl htt
+00026fe0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00026ff0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00027000: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+00027010: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00027020: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+00027030: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00027040: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+00027050: 626c 7565 5f67 7265 656e 202d 7920 7465  blue_green -y te
+00027060: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00027070: 6174 652f 6275 6d70 5f76 6572 7369 6f6e  ate/bump_version
+00027080: 5f61 6674 6572 2e79 616d 6c27 2c0a 2020  _after.yaml',.  
+00027090: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
+000270a0: 7020 746f 2077 6169 7420 666f 7220 7570  p to wait for up
+000270b0: 6461 7465 2074 6f20 6265 2072 6567 6973  date to be regis
+000270c0: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
+000270d0: 2020 2027 736c 6565 7020 3330 272c 0a20     'sleep 30',. 
+000270e0: 2020 2020 2020 2020 2020 2023 2032 206f             # 2 o
+000270f0: 6e2d 6465 616d 6e64 2028 7265 6164 7929  n-deamnd (ready)
+00027100: 202b 2031 206f 6e2d 6465 6d61 6e64 2028   + 1 on-demand (
+00027110: 7072 6f76 6973 696f 6e69 6e67 292e 0a20  provisioning).. 
+00027120: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+00027130: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00027140: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00027150: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00027160: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+00027170: 205b 2832 2c20 4661 6c73 652c 2027 5245   [(2, False, 'RE
+00027180: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00027190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271a0: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
+000271b0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000271c0: 5354 4154 5553 5f52 4547 4558 295d 2920  STATUS_REGEX)]) 
+000271d0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+000271e0: 2020 2320 4661 7374 2075 7064 6174 6520    # Fast update 
+000271f0: 7769 6c6c 2064 6972 6563 746c 7920 6861  will directly ha
+00027200: 7665 2074 6865 206c 6174 6573 7420 7665  ve the latest ve
+00027210: 7273 696f 6e20 7265 6164 792e 0a20 2020  rsion ready..   
+00027220: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00027230: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
+00027240: 696f 6e28 6e61 6d65 2c20 2232 2229 292c  ion(name, "2")),
+00027250: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00027260: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00027270: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00027280: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00027290: 756d 3d33 2920 2b0a 2020 2020 2020 2020  um=3) +.        
+000272a0: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
+000272b0: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
+000272c0: 2022 3222 292c 0a20 2020 2020 2020 2020   "2"),.         
+000272d0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000272e0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000272f0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2063  t(name=name)}; c
+00027300: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00027310: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00027320: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00027330: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00027340: 5465 7374 2072 6f6c 6c69 6e67 2075 7064  Test rolling upd
+00027350: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+00027360: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
+00027370: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
+00027380: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00027390: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+000273a0: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
+000273b0: 7665 7273 696f 6e5f 6265 666f 7265 2e79  version_before.y
+000273c0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000273d0: 2020 2320 736c 6565 7020 746f 2077 6169    # sleep to wai
+000273e0: 7420 666f 7220 7570 6461 7465 2074 6f20  t for update to 
+000273f0: 6265 2072 6567 6973 7465 7265 642e 0a20  be registered.. 
+00027400: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00027410: 7020 3135 272c 0a20 2020 2020 2020 2020  p 15',.         
+00027420: 2020 2023 2032 206f 6e2d 6465 616d 6e64     # 2 on-deamnd
+00027430: 2028 7265 6164 7929 202b 2031 206f 6e2d   (ready) + 1 on-
+00027440: 6465 6d61 6e64 2028 7368 7574 7469 6e67  demand (shutting
+00027450: 2064 6f77 6e29 2e0a 2020 2020 2020 2020   down)..        
+00027460: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+00027470: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00027480: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
+00027490: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+000274a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274c0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
+000274d0: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
+000274e0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000274f0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00027500: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00027510: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00027520: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
+00027530: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+00027540: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00027550: 6d65 2c20 2233 2229 2c0a 2020 2020 2020  me, "3"),.      
+00027560: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00027570: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00027580: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00027590: 3b20 6375 726c 2068 7474 703a 2f2f 2465  ; curl http://$e
+000275a0: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+000275b0: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+000275c0: 6522 272c 0a20 2020 2020 2020 205d 2c0a  e"',.        ],.
+000275d0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+000275e0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+000275f0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00027600: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+00027610: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00027620: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00027630: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00027640: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00027650: 5f73 6b79 7365 7276 655f 7570 6461 7465  _skyserve_update
+00027660: 5f61 7574 6f73 6361 6c65 2867 656e 6572  _autoscale(gener
+00027670: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00027680: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+00027690: 6572 7665 2075 7064 6174 6520 7769 7468  erve update with
+000276a0: 2061 7574 6f73 6361 6c65 2222 220a 2020   autoscale""".  
+000276b0: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+000276c0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+000276d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000276e0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+000276f0: 7365 7276 652d 7570 6461 7465 2d61 7574  serve-update-aut
+00027700: 6f73 6361 6c65 272c 0a20 2020 2020 2020  oscale',.       
+00027710: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00027720: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00027730: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00027740: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00027750: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00027760: 652f 7570 6461 7465 2f6e 756d 5f6d 696e  e/update/num_min
+00027770: 5f74 776f 2e79 616d 6c27 2c0a 2020 2020  _two.yaml',.    
+00027780: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00027790: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+000277a0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000277b0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+000277c0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
+000277d0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+000277e0: 7273 696f 6e28 6e61 6d65 2c20 2231 2229  rsion(name, "1")
+000277f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00027800: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00027810: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00027820: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00027830: 2020 2020 2020 2020 2763 7572 6c20 6874          'curl ht
+00027840: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00027850: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00027860: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00027870: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00027880: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00027890: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+000278a0: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
+000278b0: 2062 6c75 655f 6772 6565 6e20 2d79 2074   blue_green -y t
+000278c0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+000278d0: 6461 7465 2f6e 756d 5f6d 696e 5f6f 6e65  date/num_min_one
+000278e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000278f0: 2020 2020 2320 736c 6565 7020 6265 666f      # sleep befo
+00027900: 7265 2075 7064 6174 6520 6973 2072 6567  re update is reg
+00027910: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
+00027920: 2020 2020 2027 736c 6565 7020 3230 272c       'sleep 20',
+00027930: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00027940: 696d 656f 7574 2077 696c 6c20 6265 2074  imeout will be t
+00027950: 7269 6767 6572 6564 2077 6865 6e20 7570  riggered when up
+00027960: 6461 7465 2066 6169 6c73 2e0a 2020 2020  date fails..    
+00027970: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00027980: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00027990: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000279a0: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+000279b0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
+000279c0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+000279d0: 7273 696f 6e28 6e61 6d65 2c20 2232 2229  rsion(name, "2")
+000279e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000279f0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00027a00: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00027a10: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00027a20: 2020 2020 2020 2020 2763 7572 6c20 6874          'curl ht
+00027a30: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00027a40: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00027a50: 6c6f 7420 6865 7265 2122 272c 0a20 2020  lot here!"',.   
+00027a60: 2020 2020 2020 2020 2023 2052 6f6c 6c69           # Rolli
+00027a70: 6e67 2055 7064 6174 650a 2020 2020 2020  ng Update.      
+00027a80: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00027a90: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00027aa0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00027ab0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00027ac0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00027ad0: 2f6e 756d 5f6d 696e 5f74 776f 2e79 616d  /num_min_two.yam
+00027ae0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00027af0: 2320 736c 6565 7020 6265 666f 7265 2075  # sleep before u
+00027b00: 7064 6174 6520 6973 2072 6567 6973 7465  pdate is registe
+00027b10: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
+00027b20: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
+00027b30: 2020 2020 2020 2020 2023 2054 696d 656f           # Timeo
+00027b40: 7574 2077 696c 6c20 6265 2074 7269 6767  ut will be trigg
+00027b50: 6572 6564 2077 6865 6e20 7570 6461 7465  ered when update
+00027b60: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
+00027b70: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00027b80: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00027b90: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00027ba0: 706c 6963 615f 6e75 6d3d 3229 202b 0a20  plica_num=2) +. 
+00027bb0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00027bc0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
+00027bd0: 6e28 6e61 6d65 2c20 2233 2229 2c0a 2020  n(name, "3"),.  
+00027be0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00027bf0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00027c00: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00027c10: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+00027c20: 2020 2020 2763 7572 6c20 6874 7470 3a2f      'curl http:/
+00027c30: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00027c40: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00027c50: 6865 7265 2122 272c 0a20 2020 2020 2020  here!"',.       
+00027c60: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00027c70: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00027c80: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00027c90: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00027ca0: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+00027cb0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00027cc0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00027cd0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00027ce0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00027cf0: 726e 6574 6573 2020 2320 5370 6f74 2069  rnetes  # Spot i
+00027d00: 6e73 7461 6e63 6573 2061 7265 206e 6f74  nstances are not
+00027d10: 2073 7570 706f 7274 6564 2069 6e20 4b75   supported in Ku
+00027d20: 6265 726e 6574 6573 0a40 7079 7465 7374  bernetes.@pytest
+00027d30: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00027d40: 6528 276d 6f64 6527 2c20 5b27 726f 6c6c  e('mode', ['roll
+00027d50: 696e 6727 2c20 2762 6c75 655f 6772 6565  ing', 'blue_gree
+00027d60: 6e27 5d29 0a64 6566 2074 6573 745f 736b  n']).def test_sk
+00027d70: 7973 6572 7665 5f6e 6577 5f61 7574 6f73  yserve_new_autos
+00027d80: 6361 6c65 725f 7570 6461 7465 286d 6f64  caler_update(mod
+00027d90: 653a 2073 7472 2c20 6765 6e65 7269 635f  e: str, generic_
+00027da0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00027db0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00027dc0: 6520 7769 7468 2075 7064 6174 6520 7468  e with update th
+00027dd0: 6174 2063 6861 6e67 6573 2061 7574 6f73  at changes autos
+00027de0: 6361 6c65 7222 2222 0a20 2020 206e 616d  caler""".    nam
+00027df0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00027e00: 5f6e 616d 6528 2920 2b20 6d6f 6465 0a0a  _name() + mode..
+00027e10: 2020 2020 666f 7572 5f73 706f 745f 7570      four_spot_up
+00027e20: 5f63 6d64 203d 205f 6368 6563 6b5f 7265  _cmd = _check_re
+00027e30: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00027e40: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
+00027e50: 2027 5245 4144 5927 295d 290a 2020 2020   'READY')]).    
+00027e60: 7570 6461 7465 5f63 6865 636b 203d 205b  update_check = [
+00027e70: 6627 756e 7469 6c20 287b 666f 7572 5f73  f'until ({four_s
+00027e80: 706f 745f 7570 5f63 6d64 7d29 3b20 646f  pot_up_cmd}); do
+00027e90: 2073 6c65 6570 2035 3b20 646f 6e65 3b20   sleep 5; done; 
+00027ea0: 736c 6565 7020 3130 3b27 5d0a 2020 2020  sleep 10;'].    
+00027eb0: 6966 206d 6f64 6520 3d3d 2027 726f 6c6c  if mode == 'roll
+00027ec0: 696e 6727 3a0a 2020 2020 2020 2020 2320  ing':.        # 
+00027ed0: 4368 6563 6b20 726f 6c6c 696e 6720 7570  Check rolling up
+00027ee0: 6461 7465 2c20 6974 2077 696c 6c20 7465  date, it will te
+00027ef0: 726d 696e 6174 6520 6f6e 6520 6f66 2074  rminate one of t
+00027f00: 6865 206f 6c64 206f 6e2d 6465 6d61 6e64  he old on-demand
+00027f10: 0a20 2020 2020 2020 2023 2069 6e73 7461  .        # insta
+00027f20: 6e63 6573 2c20 6f6e 6365 2074 6865 7265  nces, once there
+00027f30: 2061 7265 2034 2073 706f 7420 696e 7374   are 4 spot inst
+00027f40: 616e 6365 2072 6561 6479 2e0a 2020 2020  ance ready..    
+00027f50: 2020 2020 7570 6461 7465 5f63 6865 636b      update_check
+00027f60: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
+00027f70: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00027f80: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00027f90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00027fa0: 2c20 5b28 312c 2046 616c 7365 2c20 5f53  , [(1, False, _S
+00027fb0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00027fc0: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
+00027fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027fe0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00027ff0: 2c20 2753 4855 5454 494e 475f 444f 574e  , 'SHUTTING_DOWN
+00028000: 2729 2c20 2831 2c20 4661 6c73 652c 2027  '), (1, False, '
+00028010: 5245 4144 5927 295d 2920 2b0a 2020 2020  READY')]) +.    
+00028020: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00028030: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00028040: 616d 652c 2022 312c 3222 292c 0a20 2020  ame, "1,2"),.   
+00028050: 2020 2020 205d 0a20 2020 2065 6c73 653a       ].    else:
+00028060: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00028070: 2062 6c75 6520 6772 6565 6e20 7570 6461   blue green upda
+00028080: 7465 2c20 6974 2077 696c 6c20 6b65 6570  te, it will keep
+00028090: 2062 6f74 6820 6f6c 6420 6f6e 2d64 656d   both old on-dem
+000280a0: 616e 6420 696e 7374 616e 6365 730a 2020  and instances.  
+000280b0: 2020 2020 2020 2320 7275 6e6e 696e 672c        # running,
+000280c0: 206f 6e63 6520 7468 6572 6520 6172 6520   once there are 
+000280d0: 3420 7370 6f74 2069 6e73 7461 6e63 6520  4 spot instance 
+000280e0: 7265 6164 792e 0a20 2020 2020 2020 2075  ready..        u
+000280f0: 7064 6174 655f 6368 6563 6b20 2b3d 205b  pdate_check += [
+00028100: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00028110: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00028120: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00028130: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00028140: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
+00028150: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00028160: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
+00028170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028180: 2020 2832 2c20 4661 6c73 652c 2027 5245    (2, False, 'RE
+00028190: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
+000281a0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+000281b0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+000281c0: 652c 2022 3122 292c 0a20 2020 2020 2020  e, "1"),.       
+000281d0: 205d 0a20 2020 2074 6573 7420 3d20 5465   ].    test = Te
+000281e0: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+000281f0: 742d 736b 7973 6572 7665 2d6e 6577 2d61  t-skyserve-new-a
+00028200: 7574 6f73 6361 6c65 722d 7570 6461 7465  utoscaler-update
+00028210: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00028220: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00028230: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00028240: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00028250: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00028260: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00028270: 7465 2f6e 6577 5f61 7574 6f73 6361 6c65  te/new_autoscale
+00028280: 725f 6265 666f 7265 2e79 616d 6c27 2c0a  r_before.yaml',.
+00028290: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+000282a0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+000282b0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+000282c0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+000282d0: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
+000282e0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+000282f0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00028300: 2231 2229 2c0a 2020 2020 2020 2020 2020  "1"),.          
+00028310: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00028320: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00028330: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00028340: 2020 2020 2020 2020 2020 2020 2773 3d24              's=$
+00028350: 2863 7572 6c20 6874 7470 3a2f 2f24 656e  (curl http://$en
+00028360: 6470 6f69 6e74 293b 2065 6368 6f20 2224  dpoint); echo "$
+00028370: 7322 3b20 6563 686f 2022 2473 2220 7c20  s"; echo "$s" | 
+00028380: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00028390: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+000283a0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+000283b0: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+000283c0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000283d0: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+000283e0: 7b6d 6f64 657d 202d 7920 7465 7374 732f  {mode} -y tests/
+000283f0: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00028400: 6e65 775f 6175 746f 7363 616c 6572 5f61  new_autoscaler_a
+00028410: 6674 6572 2e79 616d 6c27 2c0a 2020 2020  fter.yaml',.    
+00028420: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+00028430: 6f72 2075 7064 6174 6520 746f 2062 6520  or update to be 
+00028440: 7265 6769 7374 6572 6564 0a20 2020 2020  registered.     
+00028450: 2020 2020 2020 2066 2773 6c65 6570 2031         f'sleep 1
+00028460: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+00028470: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00028480: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+00028490: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+000284a0: 205b 2834 2c20 5472 7565 2c20 5f53 4552   [(4, True, _SER
+000284b0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+000284c0: 5441 5455 535f 5245 4745 5820 2b20 275c  TATUS_REGEX + '\
+000284d0: 7c52 4541 4459 2729 2c0a 2020 2020 2020  |READY'),.      
+000284e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000284f0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00028500: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00028510: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
+00028520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028530: 2020 2020 2028 322c 2046 616c 7365 2c20       (2, False, 
+00028540: 2752 4541 4459 2729 5d29 2c0a 2020 2020  'READY')]),.    
+00028550: 2020 2020 2020 2020 2a75 7064 6174 655f          *update_
+00028560: 6368 6563 6b2c 0a20 2020 2020 2020 2020  check,.         
+00028570: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00028580: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00028590: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+000285a0: 6c69 6361 5f6e 756d 3d35 292c 0a20 2020  lica_num=5),.   
+000285b0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+000285c0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+000285d0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000285e0: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+000285f0: 2020 2027 6375 726c 2068 7474 703a 2f2f     'curl http://
+00028600: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00028610: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00028620: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
+00028630: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00028640: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+00028650: 2c20 5b28 342c 2054 7275 652c 2027 5245  , [(4, True, 'RE
+00028660: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00028670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028690: 2020 2028 312c 2046 616c 7365 2c20 2752     (1, False, 'R
+000286a0: 4541 4459 2729 5d29 2c0a 2020 2020 2020  EADY')]),.      
+000286b0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+000286c0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+000286d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000286e0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000286f0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00028700: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00028710: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00028720: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00028730: 2074 6573 745f 736b 7973 6572 7665 5f66   test_skyserve_f
+00028740: 6169 6c75 7265 7328 6765 6e65 7269 635f  ailures(generic_
+00028750: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00028760: 2022 2222 5465 7374 2072 6570 6c69 6361   """Test replica
+00028770: 2066 6169 6c75 7265 2073 7461 7475 7365   failure statuse
+00028780: 7322 2222 0a20 2020 206e 616d 6520 3d20  s""".    name = 
+00028790: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+000287a0: 6528 290a 0a20 2020 2074 6573 7420 3d20  e()..    test = 
+000287b0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
+000287c0: 6573 742d 736b 7973 6572 7665 2d66 6169  est-skyserve-fai
+000287d0: 6c75 7265 7327 2c0a 2020 2020 2020 2020  lures',.        
+000287e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000287f0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00028800: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00028810: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00028820: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00028830: 2f66 6169 6c75 7265 732f 696e 6974 6961  /failures/initia
+00028840: 6c5f 6465 6c61 792e 7961 6d6c 272c 0a20  l_delay.yaml',. 
+00028850: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00028860: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00028870: 7320 7b6e 616d 657d 293b 2027 0a20 2020  s {name}); '.   
+00028880: 2020 2020 2020 2020 2066 2775 6e74 696c           f'until
+00028890: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+000288a0: 7020 2246 4149 4c45 445f 494e 4954 4941  p "FAILED_INITIA
+000288b0: 4c5f 4445 4c41 5922 3b20 646f 2027 0a20  L_DELAY"; do '. 
+000288c0: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
+000288d0: 2022 5761 6974 696e 6720 666f 7220 7265   "Waiting for re
+000288e0: 706c 6963 6120 746f 2062 6520 6661 696c  plica to be fail
+000288f0: 6564 2e2e 2e22 3b20 736c 6565 7020 353b  ed..."; sleep 5;
+00028900: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00028910: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00028920: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00028930: 6368 6f20 2224 7322 3b20 646f 6e65 3b27  cho "$s"; done;'
+00028940: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00028950: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00028960: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00028970: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+00028980: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00028990: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+000289a0: 2022 7b6e 616d 657d 2220 7c20 6772 6570   "{name}" | grep
+000289b0: 2022 4641 494c 4544 5f49 4e49 5449 414c   "FAILED_INITIAL
+000289c0: 5f44 454c 4159 2220 7c20 7763 202d 6c20  _DELAY" | wc -l 
+000289d0: 7c20 6772 6570 2032 3b20 270a 2020 2020  | grep 2; '.    
+000289e0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+000289f0: 7572 6520 6e6f 206e 6577 2072 6570 6c69  ure no new repli
+00028a00: 6361 7320 6172 6520 7374 6172 7465 6420  cas are started 
+00028a10: 666f 7220 6561 726c 7920 6661 696c 7572  for early failur
+00028a20: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
+00028a30: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
+00028a40: 7020 2d41 2031 3030 2022 5365 7276 6963  p -A 100 "Servic
+00028a50: 6520 5265 706c 6963 6173 2220 7c20 6772  e Replicas" | gr
+00028a60: 6570 2022 7b6e 616d 657d 2220 7c20 7763  ep "{name}" | wc
+00028a70: 202d 6c20 7c20 6772 6570 2032 3b27 2c0a   -l | grep 2;',.
+00028a80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00028a90: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
+00028aa0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00028ab0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+00028ac0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00028ad0: 6661 696c 7572 6573 2f70 726f 6269 6e67  failures/probing
+00028ae0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00028af0: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
+00028b00: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00028b10: 7d29 3b20 270a 2020 2020 2020 2020 2020  }); '.          
+00028b20: 2020 2320 5761 6974 2066 6f72 2072 6570    # Wait for rep
+00028b30: 6c69 6361 2074 6f20 6265 2072 6561 6479  lica to be ready
+00028b40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00028b50: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+00028b60: 7c20 6772 6570 2022 5245 4144 5922 3b20  | grep "READY"; 
+00028b70: 646f 2027 0a20 2020 2020 2020 2020 2020  do '.           
+00028b80: 2027 6563 686f 2022 5761 6974 696e 6720   'echo "Waiting 
+00028b90: 666f 7220 7265 706c 6963 6120 746f 2062  for replica to b
+00028ba0: 6520 6661 696c 6564 2e2e 2e22 3b20 736c  e failed..."; sl
+00028bb0: 6565 7020 353b 2027 0a20 2020 2020 2020  eep 5; '.       
+00028bc0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00028bd0: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00028be0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00028bf0: 646f 6e65 3b27 2c0a 2020 2020 2020 2020  done;',.        
+00028c00: 2020 2020 2320 5761 6974 2066 6f72 2072      # Wait for r
+00028c10: 6570 6c69 6361 2074 6f20 6368 616e 6765  eplica to change
+00028c20: 2074 6f20 4641 494c 4544 5f50 524f 4249   to FAILED_PROBI
+00028c30: 4e47 0a20 2020 2020 2020 2020 2020 2066  NG.            f
+00028c40: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00028c50: 7461 7475 7320 7b6e 616d 657d 293b 2027  tatus {name}); '
+00028c60: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
+00028c70: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
+00028c80: 2067 7265 7020 2246 4149 4c45 445f 5052   grep "FAILED_PR
+00028c90: 4f42 494e 4722 3b20 646f 2027 0a20 2020  OBING"; do '.   
+00028ca0: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
+00028cb0: 5761 6974 696e 6720 666f 7220 7265 706c  Waiting for repl
+00028cc0: 6963 6120 746f 2062 6520 6661 696c 6564  ica to be failed
+00028cd0: 2e2e 2e22 3b20 736c 6565 7020 353b 2027  ..."; sleep 5; '
+00028ce0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00028cf0: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
+00028d00: 7475 7320 7b6e 616d 657d 293b 2065 6368  tus {name}); ech
+00028d10: 6f20 2224 7322 3b20 646f 6e65 3b27 202b  o "$s"; done;' +
+00028d20: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00028d30: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00028d40: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00028d50: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00028d60: 2c20 4661 6c73 652c 2027 4641 494c 4544  , False, 'FAILED
+00028d70: 5f50 524f 4249 4e47 2729 2c0a 2020 2020  _PROBING'),.    
+00028d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d90: 2020 2028 312c 2046 616c 7365 2c20 5f53     (1, False, _S
+00028da0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00028db0: 5f53 5441 5455 535f 5245 4745 5829 5d29  _STATUS_REGEX)])
+00028dc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00028dd0: 544f 444f 287a 6877 7529 3a20 6164 6420  TODO(zhwu): add 
+00028de0: 7465 7374 2066 6f72 2046 4149 4c45 445f  test for FAILED_
+00028df0: 5052 4f56 4953 494f 4e0a 2020 2020 2020  PROVISION.      
+00028e00: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00028e10: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00028e20: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00028e30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00028e40: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00028e50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00028e60: 7428 7465 7374 290a 0a0a 2320 544f 444f  t(test)...# TODO
+00028e70: 285a 696d 696e 672c 2054 6961 6e29 3a20  (Ziming, Tian): 
+00028e80: 4164 6420 7465 7374 7320 666f 7220 6175  Add tests for au
+00028e90: 746f 7363 616c 696e 672e 0a0a 0a23 202d  toscaling....# -
+00028ea0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2075  ------ Testing u
+00028eb0: 7365 7220 6465 7065 6e64 656e 6369 6573  ser dependencies
+00028ec0: 202d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465   --------.def te
+00028ed0: 7374 5f75 7365 725f 6465 7065 6e64 656e  st_user_dependen
+00028ee0: 6369 6573 2867 656e 6572 6963 5f63 6c6f  cies(generic_clo
+00028ef0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00028f00: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00028f10: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00028f20: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00028f30: 2020 2775 7365 722d 6465 7065 6e64 656e    'user-dependen
+00028f40: 6369 6573 272c 0a20 2020 2020 2020 205b  cies',.        [
+00028f50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00028f60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00028f70: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00028f80: 6765 6e65 7269 635f 636c 6f75 647d 2022  generic_cloud} "
+00028f90: 7069 7020 696e 7374 616c 6c20 7261 793e  pip install ray>
+00028fa0: 322e 3131 3b20 7261 7920 7374 6172 7420  2.11; ray start 
+00028fb0: 2d2d 6865 6164 2227 2c0a 2020 2020 2020  --head"',.      
+00028fc0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00028fd0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00028fe0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00028ff0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00029000: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
+00029010: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00029020: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00029030: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00029040: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+00029050: 7573 202d 7220 7b6e 616d 657d 207c 2067  us -r {name} | g
+00029060: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+00029070: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00029080: 7b6e 616d 657d 2022 6563 686f 2062 7965  {name} "echo bye
+00029090: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000290a0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000290b0: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+000290c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000290d0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+000290e0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+000290f0: 6c73 2f64 6966 6665 7265 6e74 5f64 6566  ls/different_def
+00029100: 6175 6c74 5f63 6f6e 6461 5f65 6e76 2e79  ault_conda_env.y
+00029110: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00029120: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00029130: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
+00029140: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
+00029150: 6175 6e63 6820 6167 6169 6e20 746f 2074  aunch again to t
+00029160: 6573 7420 7468 6520 6465 6661 756c 7420  est the default 
+00029170: 656e 7620 646f 6573 206e 6f74 2061 6666  env does not aff
+00029180: 6563 7420 536b 7950 696c 6f74 0a20 2020  ect SkyPilot.   
+00029190: 2020 2020 2020 2020 2023 2072 756e 7469           # runti
+000291a0: 6d65 2073 6574 7570 0a20 2020 2020 2020  me setup.       
+000291b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000291c0: 6820 2d63 207b 6e61 6d65 7d20 2270 7974  h -c {name} "pyt
+000291d0: 686f 6e20 2d2d 7665 7273 696f 6e20 323e  hon --version 2>
+000291e0: 2631 207c 2067 7265 7020 5c27 5079 7468  &1 | grep \'Pyth
+000291f0: 6f6e 2033 2e36 5c27 207c 7c20 6578 6974  on 3.6\' || exit
+00029200: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+00029210: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00029220: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+00029230: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00029240: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00029250: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00029260: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00029270: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00029280: 2d2d 2d20 5465 7374 696e 6720 7468 6520  --- Testing the 
+00029290: 636f 7265 2041 5049 202d 2d2d 2d2d 2d2d  core API -------
+000292a0: 2d0a 2320 4d6f 7374 206f 6620 7468 6520  -.# Most of the 
+000292b0: 636f 7265 2041 5049 7320 6861 7665 2062  core APIs have b
+000292c0: 6565 6e20 7465 7374 6564 2069 6e20 7468  een tested in th
+000292d0: 6520 434c 4920 7465 7374 732e 0a23 2054  e CLI tests..# T
+000292e0: 6865 7365 2074 6573 7473 2061 7265 2066  hese tests are f
+000292f0: 6f72 2074 6573 7469 6e67 2074 6865 2072  or testing the r
+00029300: 6574 7572 6e20 7661 6c75 6520 6f66 2074  eturn value of t
+00029310: 6865 2041 5049 7320 6e6f 7420 6675 6c6c  he APIs not full
+00029320: 7920 7573 6564 2069 6e20 434c 492e 0a0a  y used in CLI...
+00029330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00029340: 700a 6465 6620 7465 7374 5f63 6f72 655f  p.def test_core_
+00029350: 6170 695f 736b 795f 6c61 756e 6368 5f65  api_sky_launch_e
+00029360: 7865 6328 293a 0a20 2020 206e 616d 6520  xec():.    name 
+00029370: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00029380: 616d 6528 290a 2020 2020 7461 736b 203d  ame().    task =
+00029390: 2073 6b79 2e54 6173 6b28 7275 6e3d 2277   sky.Task(run="w
+000293a0: 686f 616d 6922 290a 2020 2020 7461 736b  hoami").    task
+000293b0: 2e73 6574 5f72 6573 6f75 7263 6573 2873  .set_resources(s
+000293c0: 6b79 2e52 6573 6f75 7263 6573 2863 6c6f  ky.Resources(clo
+000293d0: 7564 3d73 6b79 2e47 4350 2829 2929 0a20  ud=sky.GCP())). 
+000293e0: 2020 206a 6f62 5f69 642c 2068 616e 646c     job_id, handl
+000293f0: 6520 3d20 736b 792e 6c61 756e 6368 2874  e = sky.launch(t
+00029400: 6173 6b2c 2063 6c75 7374 6572 5f6e 616d  ask, cluster_nam
+00029410: 653d 6e61 6d65 290a 2020 2020 6173 7365  e=name).    asse
+00029420: 7274 206a 6f62 5f69 6420 3d3d 2031 0a20  rt job_id == 1. 
+00029430: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
+00029440: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00029450: 2061 7373 6572 7420 6861 6e64 6c65 2e63   assert handle.c
+00029460: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00029470: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00029480: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00029490: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
+000294a0: 735f 7361 6d65 5f63 6c6f 7564 2873 6b79  s_same_cloud(sky
+000294b0: 2e47 4350 2829 290a 2020 2020 6a6f 625f  .GCP()).    job_
+000294c0: 6964 5f65 7865 632c 2068 616e 646c 655f  id_exec, handle_
+000294d0: 6578 6563 203d 2073 6b79 2e65 7865 6328  exec = sky.exec(
+000294e0: 7461 736b 2c20 636c 7573 7465 725f 6e61  task, cluster_na
+000294f0: 6d65 3d6e 616d 6529 0a20 2020 2061 7373  me=name).    ass
+00029500: 6572 7420 6a6f 625f 6964 5f65 7865 6320  ert job_id_exec 
+00029510: 3d3d 2032 0a20 2020 2061 7373 6572 7420  == 2.    assert 
+00029520: 6861 6e64 6c65 5f65 7865 6320 6973 206e  handle_exec is n
+00029530: 6f74 204e 6f6e 650a 2020 2020 6173 7365  ot None.    asse
+00029540: 7274 2068 616e 646c 655f 6578 6563 2e63  rt handle_exec.c
+00029550: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00029560: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00029570: 616e 646c 655f 6578 6563 2e6c 6175 6e63  andle_exec.launc
+00029580: 6865 645f 7265 736f 7572 6365 732e 636c  hed_resources.cl
+00029590: 6f75 642e 6973 5f73 616d 655f 636c 6f75  oud.is_same_clou
+000295a0: 6428 736b 792e 4743 5028 2929 0a20 2020  d(sky.GCP()).   
+000295b0: 2023 2046 6f72 2064 756d 6d79 2074 6173   # For dummy tas
+000295c0: 6b20 2869 2e65 2e20 7461 736b 2e72 756e  k (i.e. task.run
+000295d0: 2069 7320 4e6f 6e65 292c 2074 6865 206a   is None), the j
+000295e0: 6f62 2077 6f6e 2774 2062 6520 7375 626d  ob won't be subm
+000295f0: 6974 7465 642e 0a20 2020 2064 756d 6d79  itted..    dummy
+00029600: 5f74 6173 6b20 3d20 736b 792e 5461 736b  _task = sky.Task
+00029610: 2829 0a20 2020 206a 6f62 5f69 645f 6475  ().    job_id_du
+00029620: 6d6d 792c 205f 203d 2073 6b79 2e65 7865  mmy, _ = sky.exe
+00029630: 6328 6475 6d6d 795f 7461 736b 2c20 636c  c(dummy_task, cl
+00029640: 7573 7465 725f 6e61 6d65 3d6e 616d 6529  uster_name=name)
+00029650: 0a20 2020 2061 7373 6572 7420 6a6f 625f  .    assert job_
+00029660: 6964 5f64 756d 6d79 2069 7320 4e6f 6e65  id_dummy is None
+00029670: 0a20 2020 2073 6b79 2e64 6f77 6e28 6e61  .    sky.down(na
+00029680: 6d65 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  me)...# --------
+00029690: 2d2d 2054 6573 7469 6e67 2053 746f 7261  -- Testing Stora
+000296a0: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c  ge ----------.cl
+000296b0: 6173 7320 5465 7374 5374 6f72 6167 6557  ass TestStorageW
+000296c0: 6974 6843 7265 6465 6e74 6961 6c73 3a0a  ithCredentials:.
+000296d0: 2020 2020 2222 2253 746f 7261 6765 2074      """Storage t
+000296e0: 6573 7473 2077 6869 6368 2072 6571 7569  ests which requi
+000296f0: 7265 2063 7265 6465 6e74 6961 6c73 2061  re credentials a
+00029700: 6e64 206e 6574 776f 726b 2063 6f6e 6e65  nd network conne
+00029710: 6374 696f 6e22 2222 0a0a 2020 2020 4157  ction"""..    AW
+00029720: 535f 494e 5641 4c49 445f 4e41 4d45 5320  S_INVALID_NAMES 
+00029730: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
+00029740: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
+00029750: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+00029760: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
+00029770: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00029780: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00029790: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+000297a0: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+000297b0: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
+000297c0: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
+000297d0: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+000297e0: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
+000297f0: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
+00029800: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
+00029810: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
+00029820: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
+00029830: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
+00029840: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
+00029850: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
+00029860: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
+00029870: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
+00029880: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
+00029890: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
+000298a0: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
+000298b0: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
+000298c0: 7265 6669 780a 2020 2020 2020 2020 2762  refix.        'b
+000298d0: 7563 6b65 742d 7333 616c 6961 7327 2c20  ucket-s3alias', 
+000298e0: 2023 2065 6e64 7320 7769 7468 2027 2d73   # ends with '-s
+000298f0: 3361 6c69 6173 2720 7375 6666 6978 0a20  3alias' suffix. 
+00029900: 2020 2020 2020 2027 6275 636b 6574 2d2d         'bucket--
+00029910: 6f6c 2d73 3327 2c20 2023 2065 6e64 7320  ol-s3',  # ends 
+00029920: 7769 7468 2027 2d2d 6f6c 2d73 3327 2073  with '--ol-s3' s
+00029930: 7566 6669 780a 2020 2020 2020 2020 272e  uffix.        '.
+00029940: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+00029950: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00029960: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
+00029970: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
+00029980: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
+00029990: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
+000299a0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
+000299b0: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
+000299c0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+000299d0: 5d0a 0a20 2020 2047 4353 5f49 4e56 414c  ]..    GCS_INVAL
+000299e0: 4944 5f4e 414d 4553 203d 205b 0a20 2020  ID_NAMES = [.   
+000299f0: 2020 2020 2027 6162 272c 2020 2320 6c65       'ab',  # le
+00029a00: 7373 2074 6861 6e20 3320 6368 6172 6163  ss than 3 charac
+00029a10: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
+00029a20: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00029a30: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+00029a40: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+00029a50: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+00029a60: 6f70 7172 7374 7576 7778 797a 3127 2c0a  opqrstuvwxyz1',.
+00029a70: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
+00029a80: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
+00029a90: 7320 2877 6974 686f 7574 2064 6f74 7329  s (without dots)
+00029aa0: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
+00029ab0: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
+00029ac0: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
+00029ad0: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
+00029ae0: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+00029af0: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
+00029b00: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
+00029b10: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
+00029b20: 7269 6f64 730a 2020 2020 2020 2020 2761  riods.        'a
+00029b30: 6263 5f2e 6465 662e 6768 692e 6a6b 6c6d  bc_.def.ghi.jklm
+00029b40: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+00029b50: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00029b60: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+00029b70: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00029b80: 7a31 270a 2020 2020 2020 2020 2320 4d6f  z1'.        # Mo
+00029b90: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
+00029ba0: 6374 6572 7320 6265 7477 6565 6e20 646f  cters between do
+00029bb0: 7473 0a20 2020 2020 2020 2027 6162 635f  ts.        'abc_
+00029bc0: 2e64 6566 2e67 6869 2e6a 6b6c 6d6e 6f70  .def.ghi.jklmnop
+00029bd0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+00029be0: 6768 696a 6b6c 6d6e 6f70 7166 6768 696a  ghijklmnopqfghij
+00029bf0: 6b6c 6d6e 6f70 7172 7374 7576 7727 202a  klmnopqrstuvw' *
+00029c00: 2035 2c0a 2020 2020 2020 2020 2320 6d6f   5,.        # mo
+00029c10: 7265 2074 6861 6e20 3232 3220 6368 6172  re than 222 char
+00029c20: 6163 7465 7273 2028 7769 7468 2064 6f74  acters (with dot
+00029c30: 7329 0a20 2020 2020 2020 2027 3139 322e  s).        '192.
+00029c40: 3136 382e 352e 3427 2c20 2023 2066 6f72  168.5.4',  # for
+00029c50: 6d61 7474 6564 2061 7320 616e 2049 5020  matted as an IP 
+00029c60: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00029c70: 2767 6f6f 6762 7563 6b65 7427 2c20 2023  'googbucket',  #
+00029c80: 2073 7461 7274 7320 7769 7468 2027 676f   starts with 'go
+00029c90: 6f67 2720 7072 6566 6978 0a20 2020 2020  og' prefix.     
+00029ca0: 2020 2027 676f 6f67 6c65 6275 636b 6574     'googlebucket
+00029cb0: 272c 2020 2320 636f 6e74 6169 6e73 2027  ',  # contains '
+00029cc0: 676f 6f67 6c65 270a 2020 2020 2020 2020  google'.        
+00029cd0: 2767 3030 676c 6562 7563 6b65 7427 2c20  'g00glebucket', 
+00029ce0: 2023 2076 6172 6961 6e74 206f 6620 2767   # variant of 'g
+00029cf0: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
+00029d00: 676f 3067 6c65 6275 636b 6574 272c 2020  go0glebucket',  
+00029d10: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
+00029d20: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
+00029d30: 306f 676c 6562 7563 6b65 7427 2c20 2023  0oglebucket',  #
+00029d40: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
+00029d50: 676c 6527 0a20 2020 2020 2020 2027 2e61  gle'.        '.a
+00029d60: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
+00029d70: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
+00029d80: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
+00029d90: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00029da0: 2020 2020 2027 5f61 6263 272c 2020 2320       '_abc',  # 
+00029db0: 7374 6172 7473 2077 6974 6820 616e 2075  starts with an u
+00029dc0: 6e64 6572 7363 6f72 650a 2020 2020 2020  nderscore.      
+00029dd0: 2020 2761 6263 5f27 2c20 2023 2065 6e64    'abc_',  # end
+00029de0: 7320 7769 7468 2061 6e20 756e 6465 7273  s with an unders
+00029df0: 636f 7265 0a20 2020 205d 0a0a 2020 2020  core.    ]..    
+00029e00: 4942 4d5f 494e 5641 4c49 445f 4e41 4d45  IBM_INVALID_NAME
+00029e10: 5320 3d20 5b0a 2020 2020 2020 2020 2761  S = [.        'a
+00029e20: 6227 2c20 2023 206c 6573 7320 7468 616e  b',  # less than
+00029e30: 2033 2063 6861 7261 6374 6572 730a 2020   3 characters.  
+00029e40: 2020 2020 2020 2761 6263 6465 6667 6869        'abcdefghi
+00029e50: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00029e60: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+00029e70: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00029e80: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00029e90: 7677 7879 7a31 272c 0a20 2020 2020 2020  vwxyz1',.       
+00029ea0: 2023 206d 6f72 6520 7468 616e 2036 3320   # more than 63 
+00029eb0: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+00029ec0: 2020 2027 4162 6364 6566 272c 2020 2320     'Abcdef',  # 
+00029ed0: 636f 6e74 6169 6e73 2061 6e20 7570 7065  contains an uppe
+00029ee0: 7263 6173 6520 6c65 7474 6572 0a20 2020  rcase letter.   
+00029ef0: 2020 2020 2027 6162 6320 6465 6627 2c20       'abc def', 
+00029f00: 2023 2063 6f6e 7461 696e 7320 6120 7370   # contains a sp
+00029f10: 6163 650a 2020 2020 2020 2020 2761 6263  ace.        'abc
+00029f20: 2e2e 6465 6627 2c20 2023 2074 776f 2061  ..def',  # two a
+00029f30: 646a 6163 656e 7420 7065 7269 6f64 730a  djacent periods.
+00029f40: 2020 2020 2020 2020 2731 3932 2e31 3638          '192.168
+00029f50: 2e35 2e34 272c 2020 2320 666f 726d 6174  .5.4',  # format
+00029f60: 7465 6420 6173 2061 6e20 4950 2061 6464  ted as an IP add
+00029f70: 7265 7373 0a20 2020 2020 2020 2027 786e  ress.        'xn
+00029f80: 2d2d 6275 636b 6574 272c 2020 2320 7374  --bucket',  # st
+00029f90: 6172 7473 2077 6974 6820 2778 6e2d 2d27  arts with 'xn--'
+00029fa0: 2070 7265 6669 780a 2020 2020 2020 2020   prefix.        
+00029fb0: 272e 6162 6327 2c20 2023 2073 7461 7274  '.abc',  # start
+00029fc0: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00029fd0: 2020 2020 2027 6162 632e 272c 2020 2320       'abc.',  # 
+00029fe0: 656e 6473 2077 6974 6820 6120 646f 740a  ends with a dot.
+00029ff0: 2020 2020 2020 2020 272d 6162 6327 2c20          '-abc', 
+0002a000: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
+0002a010: 2068 7970 6865 6e0a 2020 2020 2020 2020   hyphen.        
+0002a020: 2761 6263 2d27 2c20 2023 2065 6e64 7320  'abc-',  # ends 
+0002a030: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
+0002a040: 2020 2020 2020 2761 2e2d 6263 272c 2020        'a.-bc',  
+0002a050: 2320 636f 6e74 6169 6e73 2074 6865 2073  # contains the s
+0002a060: 6571 7565 6e63 6520 272e 2d27 0a20 2020  equence '.-'.   
+0002a070: 2020 2020 2027 612d 2e62 6327 2c20 2023       'a-.bc',  #
+0002a080: 2063 6f6e 7461 696e 7320 7468 6520 7365   contains the se
+0002a090: 7175 656e 6365 2027 2d2e 270a 2020 2020  quence '-.'.    
+0002a0a0: 2020 2020 2761 2662 6327 2020 2320 636f      'a&bc'  # co
+0002a0b0: 6e74 6169 6e73 2073 7065 6369 616c 2063  ntains special c
+0002a0c0: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+0002a0d0: 2020 2761 625e 6327 2020 2320 636f 6e74    'ab^c'  # cont
+0002a0e0: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
+0002a0f0: 7261 6374 6572 730a 2020 2020 5d0a 2020  racters.    ].  
+0002a100: 2020 4749 5449 474e 4f52 455f 5359 4e43    GITIGNORE_SYNC
+0002a110: 5f54 4553 545f 4449 525f 5354 5255 4354  _TEST_DIR_STRUCT
+0002a120: 5552 4520 3d20 7b0a 2020 2020 2020 2020  URE = {.        
+0002a130: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
+0002a140: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0002a150: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
+0002a160: 6b5f 6578 636c 7564 6564 273a 204e 6f6e  k_excluded': Non
+0002a170: 652c 0a20 2020 2020 2020 2020 2020 2027  e,.            '
+0002a180: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
+0002a190: 6578 636c 7564 6564 5f64 6972 273a 207b  excluded_dir': {
+0002a1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a1b0: 2027 6469 725f 6578 636c 7564 6564 273a   'dir_excluded':
+0002a1c0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0002a1d0: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
+0002a1e0: 0a20 2020 2020 2020 2027 646f 7562 6c65  .        'double
+0002a1f0: 5f61 7374 6572 6973 6b5f 7061 7265 6e74  _asterisk_parent
+0002a200: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0002a210: 2027 7061 7265 6e74 273a 207b 0a20 2020   'parent': {.   
+0002a220: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+0002a230: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
+0002a240: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0002a250: 2020 2020 2020 2020 2763 6869 6c64 273a          'child':
+0002a260: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a270: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+0002a280: 7374 6572 6973 6b5f 7061 7265 6e74 5f63  sterisk_parent_c
+0002a290: 6869 6c64 5f65 7863 6c75 6465 642e 7478  hild_excluded.tx
+0002a2a0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a2b0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0002a2c0: 2020 2020 2020 2020 2020 2020 2027 646f               'do
+0002a2d0: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
+0002a2e0: 7265 6e74 5f65 7863 6c75 6465 642e 7478  rent_excluded.tx
+0002a2f0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a300: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a310: 207d 2c0a 2020 2020 2020 2020 2765 7863   },.        'exc
+0002a320: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
+0002a330: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
+0002a340: 6465 645f 6469 7227 3a20 7b0a 2020 2020  ded_dir': {.    
+0002a350: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a360: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+0002a370: 2020 2020 2020 2020 2020 276e 6573 7465            'neste
+0002a380: 645f 6578 636c 7564 6564 273a 207b 0a20  d_excluded': {. 
+0002a390: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002a3a0: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
+0002a3b0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a3c0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0002a3d0: 2020 2027 6578 702d 3127 3a20 7b0a 2020     'exp-1': {.  
+0002a3e0: 2020 2020 2020 2020 2020 2762 655f 6578            'be_ex
+0002a3f0: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+0002a400: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a410: 2020 2765 7870 2d32 273a 207b 0a20 2020    'exp-2': {.   
+0002a420: 2020 2020 2020 2020 2027 6265 5f65 7863           'be_exc
+0002a430: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+0002a440: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a450: 2027 6672 6f6e 745f 736c 6173 685f 6578   'front_slash_ex
+0002a460: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+0002a470: 2020 2020 2020 2027 696e 636c 7564 6564         'included
+0002a480: 2e6c 6f67 273a 204e 6f6e 652c 0a20 2020  .log': None,.   
+0002a490: 2020 2020 2027 696e 636c 7564 6564 2e74       'included.t
+0002a4a0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+0002a4b0: 2020 2027 696e 636c 7564 655f 6469 7227     'include_dir'
+0002a4c0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0002a4d0: 2765 7863 6c75 6465 642e 6c6f 6727 3a20  'excluded.log': 
+0002a4e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002a4f0: 2020 2769 6e63 6c75 6465 642e 6c6f 6727    'included.log'
+0002a500: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0002a510: 7d2c 0a20 2020 2020 2020 2027 6e65 7374  },.        'nest
+0002a520: 6564 5f64 6f75 626c 655f 6173 7465 7269  ed_double_asteri
+0002a530: 736b 273a 207b 0a20 2020 2020 2020 2020  sk': {.         
+0002a540: 2020 2027 6f6e 6527 3a20 7b0a 2020 2020     'one': {.    
+0002a550: 2020 2020 2020 2020 2020 2020 2761 6c73              'als
+0002a560: 6f5f 6578 636c 7564 652e 7478 7427 3a20  o_exclude.txt': 
+0002a570: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002a580: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0002a590: 2027 7477 6f27 3a20 7b0a 2020 2020 2020   'two': {.      
+0002a5a0: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
+0002a5b0: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
+0002a5c0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002a5d0: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
+0002a5e0: 2020 2020 2020 276e 6573 7465 645f 7769        'nested_wi
+0002a5f0: 6c64 6361 7264 5f64 6972 273a 207b 0a20  ldcard_dir': {. 
+0002a600: 2020 2020 2020 2020 2020 2027 6d6f 6e64             'mond
+0002a610: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
+0002a620: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+0002a630: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
+0002a640: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a650: 2020 2020 2020 2020 2020 2020 2774 7565              'tue
+0002a660: 7364 6179 273a 207b 0a20 2020 2020 2020  sday': {.       
+0002a670: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
+0002a680: 7863 6c75 6465 2e74 7874 273a 204e 6f6e  xclude.txt': Non
+0002a690: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+0002a6a0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+0002a6b0: 2020 2020 2027 6e6f 5f73 6c61 7368 5f65       'no_slash_e
+0002a6c0: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
+0002a6d0: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+0002a6e0: 685f 7465 7374 7327 3a20 7b0a 2020 2020  h_tests': {.    
+0002a6f0: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+0002a700: 685f 6578 636c 7564 6564 273a 207b 0a20  h_excluded': {. 
+0002a710: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002a720: 616c 736f 5f65 7863 6c75 6465 642e 7478  also_excluded.tx
+0002a730: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a740: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a750: 207d 2c0a 2020 2020 2020 2020 2771 7565   },.        'que
+0002a760: 7374 696f 6e5f 6d61 726b 273a 207b 0a20  stion_mark': {. 
+0002a770: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+0002a780: 7564 6564 312e 7478 7427 3a20 4e6f 6e65  uded1.txt': None
+0002a790: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
+0002a7a0: 7863 6c75 6465 6440 2e74 7874 273a 204e  xcluded@.txt': N
+0002a7b0: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+0002a7c0: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
+0002a7d0: 6272 6163 6b65 7427 3a20 7b0a 2020 2020  bracket': {.    
+0002a7e0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a7f0: 6431 2e74 7874 273a 204e 6f6e 652c 0a20  d1.txt': None,. 
+0002a800: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a810: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+0002a820: 745f 616c 7068 6127 3a20 7b0a 2020 2020  t_alpha': {.    
+0002a830: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a840: 647a 2e74 7874 273a 204e 6f6e 652c 0a20  dz.txt': None,. 
+0002a850: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a860: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+0002a870: 745f 6578 636c 6127 3a20 7b0a 2020 2020  t_excla': {.    
+0002a880: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a890: 6432 2e74 7874 273a 204e 6f6e 652c 0a20  d2.txt': None,. 
+0002a8a0: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+0002a8b0: 7564 6564 402e 7478 7427 3a20 4e6f 6e65  uded@.txt': None
+0002a8c0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+0002a8d0: 2020 2020 2027 7371 7561 7265 5f62 7261       'square_bra
+0002a8e0: 636b 6574 5f73 696e 676c 6527 3a20 7b0a  cket_single': {.
+0002a8f0: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+0002a900: 6c75 6465 6430 2e74 7874 273a 204e 6f6e  luded0.txt': Non
+0002a910: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+0002a920: 2020 7d0a 0a20 2020 2040 7374 6174 6963    }..    @static
+0002a930: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
+0002a940: 7265 6174 655f 6469 725f 7374 7275 6374  reate_dir_struct
+0002a950: 7572 6528 6261 7365 5f70 6174 682c 2073  ure(base_path, s
+0002a960: 7472 7563 7475 7265 293a 0a20 2020 2020  tructure):.     
+0002a970: 2020 2023 2063 7265 6174 6573 2061 2067     # creates a g
+0002a980: 6976 656e 2066 696c 6520 5354 5255 4354  iven file STRUCT
+0002a990: 5552 4520 696e 2042 4153 455f 5041 5448  URE in BASE_PATH
+0002a9a0: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+0002a9b0: 652c 2073 7562 7374 7275 6374 7572 6520  e, substructure 
+0002a9c0: 696e 2073 7472 7563 7475 7265 2e69 7465  in structure.ite
+0002a9d0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0002a9e0: 2020 7061 7468 203d 206f 732e 7061 7468    path = os.path
+0002a9f0: 2e6a 6f69 6e28 6261 7365 5f70 6174 682c  .join(base_path,
+0002aa00: 206e 616d 6529 0a20 2020 2020 2020 2020   name).         
+0002aa10: 2020 2069 6620 7375 6273 7472 7563 7475     if substructu
+0002aa20: 7265 2069 7320 4e6f 6e65 3a0a 2020 2020  re is None:.    
+0002aa30: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002aa40: 6561 7465 2061 2066 696c 650a 2020 2020  eate a file.    
+0002aa50: 2020 2020 2020 2020 2020 2020 6f70 656e              open
+0002aa60: 2870 6174 682c 2027 6127 2c20 656e 636f  (path, 'a', enco
+0002aa70: 6469 6e67 3d27 7574 662d 3827 292e 636c  ding='utf-8').cl
+0002aa80: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
+0002aa90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002aaa0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002aab0: 2061 2073 7562 6469 7265 6374 6f72 790a   a subdirectory.
+0002aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aad0: 6f73 2e6d 6b64 6972 2870 6174 6829 0a20  os.mkdir(path). 
+0002aae0: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+0002aaf0: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
+0002ab00: 6564 656e 7469 616c 732e 6372 6561 7465  edentials.create
+0002ab10: 5f64 6972 5f73 7472 7563 7475 7265 280a  _dir_structure(.
+0002ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab30: 2020 2020 7061 7468 2c20 7375 6273 7472      path, substr
+0002ab40: 7563 7475 7265 290a 0a20 2020 2040 7374  ucture)..    @st
+0002ab50: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+0002ab60: 6566 2063 6c69 5f64 656c 6574 655f 636d  ef cli_delete_cm
+0002ab70: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
+0002ab80: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002ab90: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+0002aba0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+0002abb0: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+0002abc0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+0002abd0: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
+0002abe0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+0002abf0: 2020 2072 6574 7572 6e20 6627 6177 7320     return f'aws 
+0002ac00: 7333 2072 6220 7b75 726c 7d20 2d2d 666f  s3 rb {url} --fo
+0002ac10: 7263 6527 0a20 2020 2020 2020 2069 6620  rce'.        if 
+0002ac20: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0002ac30: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002ac40: 7970 652e 4743 533a 0a20 2020 2020 2020  ype.GCS:.       
+0002ac50: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
+0002ac60: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+0002ac70: 0a20 2020 2020 2020 2020 2020 2067 7375  .            gsu
+0002ac80: 7469 6c5f 616c 6961 732c 2061 6c69 6173  til_alias, alias
+0002ac90: 5f67 656e 203d 2064 6174 615f 7574 696c  _gen = data_util
+0002aca0: 732e 6765 745f 6773 7574 696c 5f63 6f6d  s.get_gsutil_com
+0002acb0: 6d61 6e64 2829 0a20 2020 2020 2020 2020  mand().         
+0002acc0: 2020 2072 6574 7572 6e20 6627 7b61 6c69     return f'{ali
+0002acd0: 6173 5f67 656e 7d3b 207b 6773 7574 696c  as_gen}; {gsutil
+0002ace0: 5f61 6c69 6173 7d20 726d 202d 7220 7b75  _alias} rm -r {u
+0002acf0: 726c 7d27 0a20 2020 2020 2020 2069 6620  rl}'.        if 
+0002ad00: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0002ad10: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002ad20: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
+0002ad30: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+0002ad40: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+0002ad50: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+0002ad60: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+0002ad70: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+0002ad80: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0002ad90: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+0002ada0: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0002adb0: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0002adc0: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0002add0: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0002ade0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
+0002adf0: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
+0002ae00: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002ae10: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
+0002ae20: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+0002ae30: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+0002ae40: 746f 7265 5479 7065 2e49 424d 3a0a 2020  toreType.IBM:.  
+0002ae50: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
+0002ae60: 5f72 636c 6f6e 655f 7072 6f66 696c 6520  _rclone_profile 
+0002ae70: 3d20 5263 6c6f 6e65 2e67 656e 6572 6174  = Rclone.generat
+0002ae80: 655f 7263 6c6f 6e65 5f62 7563 6b65 745f  e_rclone_bucket_
+0002ae90: 7072 6f66 696c 655f 6e61 6d65 280a 2020  profile_name(.  
+0002aea0: 2020 2020 2020 2020 2020 2020 2020 6275                bu
+0002aeb0: 636b 6574 5f6e 616d 652c 2052 636c 6f6e  cket_name, Rclon
+0002aec0: 652e 5263 6c6f 6e65 436c 6f75 6473 2e49  e.RcloneClouds.I
+0002aed0: 424d 290a 2020 2020 2020 2020 2020 2020  BM).            
+0002aee0: 7265 7475 726e 2066 2772 636c 6f6e 6520  return f'rclone 
+0002aef0: 7075 7267 6520 7b62 7563 6b65 745f 7263  purge {bucket_rc
+0002af00: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b62  lone_profile}:{b
+0002af10: 7563 6b65 745f 6e61 6d65 7d20 2626 2072  ucket_name} && r
+0002af20: 636c 6f6e 6520 636f 6e66 6967 2064 656c  clone config del
+0002af30: 6574 6520 7b62 7563 6b65 745f 7263 6c6f  ete {bucket_rclo
+0002af40: 6e65 5f70 726f 6669 6c65 7d27 0a0a 2020  ne_profile}'..  
+0002af50: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+0002af60: 2020 2020 6465 6620 636c 695f 6c73 5f63      def cli_ls_c
+0002af70: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+0002af80: 7563 6b65 745f 6e61 6d65 2c20 7375 6666  ucket_name, suff
+0002af90: 6978 3d27 2729 3a0a 2020 2020 2020 2020  ix=''):.        
+0002afa0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002afb0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002afc0: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+0002afd0: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
+0002afe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002aff0: 2020 7572 6c20 3d20 6627 7333 3a2f 2f7b    url = f's3://{
+0002b000: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+0002b010: 6666 6978 7d27 0a20 2020 2020 2020 2020  ffix}'.         
+0002b020: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b030: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+0002b040: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
+0002b050: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+0002b060: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
+0002b070: 206c 7320 7b75 726c 7d27 0a20 2020 2020   ls {url}'.     
+0002b080: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002b090: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002b0a0: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
+0002b0b0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+0002b0c0: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+0002b0d0: 2020 2020 2020 7572 6c20 3d20 6627 6773        url = f'gs
+0002b0e0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002b0f0: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
+0002b100: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002b110: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0002b120: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
+0002b130: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+0002b140: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+0002b150: 7574 696c 206c 7320 7b75 726c 7d27 0a20  util ls {url}'. 
+0002b160: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0002b170: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0002b180: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0002b190: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+0002b1a0: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
+0002b1b0: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
+0002b1c0: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
+0002b1d0: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
+0002b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b1f0: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+0002b200: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+0002b210: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
+0002b220: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002b230: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
+0002b240: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
+0002b250: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+0002b260: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
+0002b270: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+0002b280: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+0002b290: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+0002b2a0: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
+0002b2b0: 7b75 726c 7d20 2d2d 656e 6470 6f69 6e74  {url} --endpoint
+0002b2c0: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0002b2d0: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
+0002b2e0: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+0002b2f0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+0002b300: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0002b310: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
+0002b320: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+0002b330: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+0002b340: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+0002b350: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+0002b360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002b370: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
+0002b380: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
+0002b390: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
+0002b3a0: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
+0002b3b0: 6f6e 6520 6c73 207b 6275 636b 6574 5f72  one ls {bucket_r
+0002b3c0: 636c 6f6e 655f 7072 6f66 696c 657d 3a7b  clone_profile}:{
+0002b3d0: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+0002b3e0: 6666 6978 7d27 0a0a 2020 2020 4073 7461  ffix}'..    @sta
+0002b3f0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0002b400: 6620 636c 695f 7265 6769 6f6e 5f63 6d64  f cli_region_cmd
+0002b410: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+0002b420: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+0002b430: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002b440: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002b450: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
+0002b460: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002b470: 2028 2761 7773 2073 3361 7069 2067 6574   ('aws s3api get
+0002b480: 2d62 7563 6b65 742d 6c6f 6361 7469 6f6e  -bucket-location
+0002b490: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0002b4a0: 2020 2020 2020 2066 272d 2d62 7563 6b65         f'--bucke
+0002b4b0: 7420 7b62 7563 6b65 745f 6e61 6d65 7d20  t {bucket_name} 
+0002b4c0: 2d2d 6f75 7470 7574 2074 6578 7427 290a  --output text').
+0002b4d0: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
+0002b4e0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002b4f0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002b500: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
+0002b510: 2020 7265 7475 726e 2028 6627 6773 7574    return (f'gsut
+0002b520: 696c 206c 7320 2d4c 202d 6220 6773 3a2f  il ls -L -b gs:/
+0002b530: 2f7b 6275 636b 6574 5f6e 616d 657d 2f20  /{bucket_name}/ 
+0002b540: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+0002b550: 2020 2020 2020 2020 2767 7265 7020 224c          'grep "L
+0002b560: 6f63 6174 696f 6e20 636f 6e73 7472 6169  ocation constrai
+0002b570: 6e74 2220 7c20 270a 2020 2020 2020 2020  nt" | '.        
+0002b580: 2020 2020 2020 2020 2020 2020 2761 776b              'awk
+0002b590: 205c 277b 7072 696e 7420 746f 6c6f 7765   \'{print tolowe
+0002b5a0: 7228 244e 4629 7d5c 2727 290a 2020 2020  r($NF)}\'').    
+0002b5b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002b5c0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0002b5d0: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0002b5e0: 6627 5265 6769 6f6e 2063 6f6d 6d61 6e64  f'Region command
+0002b5f0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0002b600: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+0002b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b620: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0002b630: 7374 6f72 655f 7479 7065 7d27 290a 0a20  store_type}').. 
+0002b640: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0002b650: 0a20 2020 2064 6566 2063 6c69 5f63 6f75  .    def cli_cou
+0002b660: 6e74 5f6e 616d 655f 696e 5f62 7563 6b65  nt_name_in_bucke
+0002b670: 7428 7374 6f72 655f 7479 7065 2c20 6275  t(store_type, bu
+0002b680: 636b 6574 5f6e 616d 652c 2066 696c 655f  cket_name, file_
+0002b690: 6e61 6d65 2c20 7375 6666 6978 3d27 2729  name, suffix='')
+0002b6a0: 3a0a 2020 2020 2020 2020 6966 2073 746f  :.        if sto
+0002b6b0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002b6c0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002b6d0: 2e53 333a 0a20 2020 2020 2020 2020 2020  .S3:.           
+0002b6e0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002b6f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002b700: 726e 2066 2761 7773 2073 3361 7069 206c  rn f'aws s3api l
+0002b710: 6973 742d 6f62 6a65 6374 7320 2d2d 6275  ist-objects --bu
+0002b720: 636b 6574 2022 7b62 7563 6b65 745f 6e61  cket "{bucket_na
+0002b730: 6d65 7d22 202d 2d70 7265 6669 7820 7b73  me}" --prefix {s
+0002b740: 7566 6669 787d 202d 2d71 7565 7279 2022  uffix} --query "
+0002b750: 6c65 6e67 7468 2843 6f6e 7465 6e74 735b  length(Contents[
+0002b760: 3f63 6f6e 7461 696e 7328 4b65 792c 5c27  ?contains(Key,\'
+0002b770: 7b66 696c 655f 6e61 6d65 7d5c 2729 5d2e  {file_name}\')].
+0002b780: 4b65 7929 2227 0a20 2020 2020 2020 2020  Key)"'.         
+0002b790: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b7a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b7b0: 6627 6177 7320 7333 6170 6920 6c69 7374  f'aws s3api list
+0002b7c0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002b7d0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002b7e0: 2220 2d2d 7175 6572 7920 226c 656e 6774  " --query "lengt
+0002b7f0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+0002b800: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+0002b810: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+0002b820: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002b830: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002b840: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002b850: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002b860: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+0002b870: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002b880: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
+0002b890: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
+0002b8a0: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
+0002b8b0: 207c 2067 7265 7020 227b 6669 6c65 5f6e   | grep "{file_n
+0002b8c0: 616d 657d 2220 7c20 7763 202d 6c27 0a20  ame}" | wc -l'. 
+0002b8d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b8f0: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
+0002b900: 206c 7320 2d72 2067 733a 2f2f 7b62 7563   ls -r gs://{buc
+0002b910: 6b65 745f 6e61 6d65 7d20 7c20 6772 6570  ket_name} | grep
+0002b920: 2022 7b66 696c 655f 6e61 6d65 7d22 207c   "{file_name}" |
+0002b930: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
+0002b940: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
+0002b950: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+0002b960: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
+0002b970: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+0002b980: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+0002b990: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+0002b9a0: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+0002b9b0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002b9c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002b9d0: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
+0002b9e0: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+0002b9f0: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+0002ba00: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+0002ba10: 7d20 6177 7320 7333 6170 6920 6c69 7374  } aws s3api list
+0002ba20: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002ba30: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002ba40: 2220 2d2d 7072 6566 6978 207b 7375 6666  " --prefix {suff
+0002ba50: 6978 7d20 2d2d 7175 6572 7920 226c 656e  ix} --query "len
+0002ba60: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
+0002ba70: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
+0002ba80: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
+0002ba90: 2922 202d 2d65 6e64 706f 696e 7420 7b65  )" --endpoint {e
+0002baa0: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+0002bab0: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
+0002bac0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002bad0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002bae0: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+0002baf0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+0002bb00: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+0002bb10: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+0002bb20: 487d 2061 7773 2073 3361 7069 206c 6973  H} aws s3api lis
+0002bb30: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0002bb40: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0002bb50: 7d22 202d 2d71 7565 7279 2022 6c65 6e67  }" --query "leng
+0002bb60: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
+0002bb70: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
+0002bb80: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
+0002bb90: 2220 2d2d 656e 6470 6f69 6e74 207b 656e  " --endpoint {en
+0002bba0: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002bbb0: 6f66 696c 653d 7232 270a 0a20 2020 2040  ofile=r2'..    @
+0002bbc0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0002bbd0: 2064 6566 2063 6c69 5f63 6f75 6e74 5f66   def cli_count_f
+0002bbe0: 696c 655f 696e 5f62 7563 6b65 7428 7374  ile_in_bucket(st
+0002bbf0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+0002bc00: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
+0002bc10: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002bc20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002bc30: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+0002bc40: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0002bc50: 6177 7320 7333 206c 7320 7333 3a2f 2f7b  aws s3 ls s3://{
+0002bc60: 6275 636b 6574 5f6e 616d 657d 202d 2d72  bucket_name} --r
+0002bc70: 6563 7572 7369 7665 207c 2077 6320 2d6c  ecursive | wc -l
+0002bc80: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002bc90: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002bca0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002bcb0: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002bcc0: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
+0002bcd0: 7469 6c20 6c73 202d 7220 6773 3a2f 2f7b  til ls -r gs://{
+0002bce0: 6275 636b 6574 5f6e 616d 657d 2f2a 2a20  bucket_name}/** 
+0002bcf0: 7c20 7763 202d 6c27 0a20 2020 2020 2020  | wc -l'.       
+0002bd00: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
+0002bd10: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002bd20: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
+0002bd30: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
+0002bd40: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+0002bd50: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+0002bd60: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
+0002bd70: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
+0002bd80: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
+0002bd90: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
+0002bda0: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
+0002bdb0: 535f 5041 5448 7d20 6177 7320 7333 206c  S_PATH} aws s3 l
+0002bdc0: 7320 7333 3a2f 2f7b 6275 636b 6574 5f6e  s s3://{bucket_n
+0002bdd0: 616d 657d 202d 2d72 6563 7572 7369 7665  ame} --recursive
+0002bde0: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+0002bdf0: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+0002be00: 6669 6c65 3d72 3220 7c20 7763 202d 6c27  file=r2 | wc -l'
+0002be10: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002be20: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002be30: 705f 736f 7572 6365 2873 656c 662c 2074  p_source(self, t
+0002be40: 6d70 5f70 6174 6829 3a0a 2020 2020 2020  mp_path):.      
+0002be50: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002be60: 6d70 6f72 6172 7920 6469 7265 6374 6f72  mporary director
+0002be70: 7920 7769 7468 2061 2066 696c 6520 696e  y with a file in
+0002be80: 2069 740a 2020 2020 2020 2020 746d 705f   it.        tmp_
+0002be90: 6469 7220 3d20 746d 705f 7061 7468 202f  dir = tmp_path /
+0002bea0: 2027 746d 702d 736f 7572 6365 270a 2020   'tmp-source'.  
+0002beb0: 2020 2020 2020 746d 705f 6469 722e 6d6b        tmp_dir.mk
+0002bec0: 6469 7228 290a 2020 2020 2020 2020 746d  dir().        tm
+0002bed0: 705f 6669 6c65 203d 2074 6d70 5f64 6972  p_file = tmp_dir
+0002bee0: 202f 2027 746d 702d 6669 6c65 270a 2020   / 'tmp-file'.  
+0002bef0: 2020 2020 2020 746d 705f 6669 6c65 2e77        tmp_file.w
+0002bf00: 7269 7465 5f74 6578 7428 2774 6573 7427  rite_text('test'
+0002bf10: 290a 2020 2020 2020 2020 6369 7263 6c65  ).        circle
+0002bf20: 5f6c 696e 6b20 3d20 746d 705f 6469 7220  _link = tmp_dir 
+0002bf30: 2f20 2763 6972 636c 652d 6c69 6e6b 270a  / 'circle-link'.
+0002bf40: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
+0002bf50: 696e 6b2e 7379 6d6c 696e 6b5f 746f 2874  ink.symlink_to(t
+0002bf60: 6d70 5f64 6972 2c20 7461 7267 6574 5f69  mp_dir, target_i
+0002bf70: 735f 6469 7265 6374 6f72 793d 5472 7565  s_directory=True
+0002bf80: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002bf90: 7374 7228 746d 705f 6469 7229 0a0a 2020  str(tmp_dir)..  
+0002bfa0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+0002bfb0: 2020 2020 6465 6620 6765 6e65 7261 7465      def generate
+0002bfc0: 5f62 7563 6b65 745f 6e61 6d65 2829 3a0a  _bucket_name():.
+0002bfd0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002bfe0: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
+0002bff0: 636b 6574 206e 616d 650a 2020 2020 2020  cket name.      
+0002c000: 2020 2320 7469 6d65 2e74 696d 6528 2920    # time.time() 
+0002c010: 7265 7475 726e 7320 7661 7279 696e 6720  returns varying 
+0002c020: 7072 6563 6973 696f 6e20 6f6e 2064 6966  precision on dif
+0002c030: 6665 7265 6e74 2073 7973 7465 6d73 2c20  ferent systems, 
+0002c040: 736f 2077 650a 2020 2020 2020 2020 2320  so we.        # 
+0002c050: 7265 706c 6163 6520 7468 6520 6465 6369  replace the deci
+0002c060: 6d61 6c20 706f 696e 7420 616e 6420 7573  mal point and us
+0002c070: 6520 7768 6174 6576 6572 2070 7265 6369  e whatever preci
+0002c080: 7369 6f6e 2077 6520 6361 6e20 6765 742e  sion we can get.
+0002c090: 0a20 2020 2020 2020 2074 696d 6573 7461  .        timesta
+0002c0a0: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0002c0b0: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0002c0c0: 272c 2027 2729 0a20 2020 2020 2020 2072  ', '').        r
+0002c0d0: 6574 7572 6e20 6627 736b 792d 7465 7374  eturn f'sky-test
+0002c0e0: 2d7b 7469 6d65 7374 616d 707d 270a 0a20  -{timestamp}'.. 
+0002c0f0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002c100: 7265 0a20 2020 2064 6566 2074 6d70 5f62  re.    def tmp_b
+0002c110: 7563 6b65 745f 6e61 6d65 2873 656c 6629  ucket_name(self)
+0002c120: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+0002c130: 7365 6c66 2e67 656e 6572 6174 655f 6275  self.generate_bu
+0002c140: 636b 6574 5f6e 616d 6528 290a 0a20 2020  cket_name()..   
+0002c150: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0002c160: 2020 2064 6566 2079 6965 6c64 5f73 746f     def yield_sto
+0002c170: 7261 6765 5f6f 626a 6563 7428 0a20 2020  rage_object(.   
+0002c180: 2020 2020 2020 2020 206e 616d 653a 204f           name: O
+0002c190: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0002c1a0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002c1b0: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
+0002c1c0: 6c5b 7374 6f72 6167 655f 6c69 622e 5061  l[storage_lib.Pa
+0002c1d0: 7468 5d20 3d20 4e6f 6e65 2c0a 2020 2020  th] = None,.    
+0002c1e0: 2020 2020 2020 2020 7374 6f72 6573 3a20          stores: 
+0002c1f0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+0002c200: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002c210: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0002c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c230: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002c240: 6962 2e41 6273 7472 6163 7453 746f 7265  ib.AbstractStore
+0002c250: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+0002c260: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002c270: 743a 204f 7074 696f 6e61 6c5b 626f 6f6c  t: Optional[bool
+0002c280: 5d20 3d20 5472 7565 2c0a 2020 2020 2020  ] = True,.      
+0002c290: 2020 2020 2020 6d6f 6465 3a20 7374 6f72        mode: stor
+0002c2a0: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002c2b0: 6f64 6520 3d20 7374 6f72 6167 655f 6c69  ode = storage_li
+0002c2c0: 622e 5374 6f72 6167 654d 6f64 652e 4d4f  b.StorageMode.MO
+0002c2d0: 554e 5429 3a0a 2020 2020 2020 2020 2320  UNT):.        # 
+0002c2e0: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
+0002c2f0: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
+0002c300: 6374 2e20 5374 6f72 6573 206d 7573 7420  ct. Stores must 
+0002c310: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002c320: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002c330: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+0002c340: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+0002c350: 6e61 6d65 3d6e 616d 652c 0a20 2020 2020  name=name,.     
+0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c380: 2020 2020 2073 6f75 7263 653d 736f 7572       source=sour
+0002c390: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0002c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002c3c0: 6f72 6573 3d73 746f 7265 732c 0a20 2020  ores=stores,.   
+0002c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3f0: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002c400: 743d 7065 7273 6973 7465 6e74 2c0a 2020  t=persistent,.  
+0002c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c430: 2020 2020 2020 2020 6d6f 6465 3d6d 6f64          mode=mod
+0002c440: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0002c450: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
+0002c460: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+0002c470: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0002c480: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+0002c490: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+0002c4a0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002c4b0: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+0002c4c0: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+0002c4d0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0002c4e0: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
+0002c4f0: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
+0002c500: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0002c510: 4f28 726f 6d69 6c62 293a 2054 6869 7320  O(romilb): This 
+0002c520: 6973 2070 6f74 656e 7469 616c 6c79 2072  is potentially r
+0002c530: 6973 6b79 202d 2069 6620 7468 6520 6465  isky - if the de
+0002c540: 6c65 7465 206d 6574 686f 6420 6861 730a  lete method has.
+0002c550: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002c560: 6275 6773 2c20 7468 6973 2063 616e 2063  bugs, this can c
+0002c570: 6175 7365 2072 6573 6f75 7263 6520 6c65  ause resource le
+0002c580: 616b 732e 2049 6465 616c 6c79 2077 6520  aks. Ideally we 
+0002c590: 7368 6f75 6c64 206d 616e 7561 6c6c 790a  should manually.
+0002c5a0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002c5b0: 656a 6563 7420 7374 6f72 6167 6520 6672  eject storage fr
+0002c5c0: 6f6d 2067 6c6f 6261 6c5f 7573 6572 5f73  om global_user_s
+0002c5d0: 7461 7465 2061 6e64 2064 656c 6574 6520  tate and delete 
+0002c5e0: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
+0002c5f0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0002c600: 2062 6f74 6f33 2064 6972 6563 746c 792e   boto3 directly.
+0002c610: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002c620: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
+0002c630: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002c640: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002c650: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002c660: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0002c670: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002c680: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002c690: 2061 2073 746f 7261 6765 206f 626a 6563   a storage objec
+0002c6a0: 7420 7769 7468 206e 6f20 736f 7572 6365  t with no source
+0002c6b0: 2074 6f20 6372 6561 7465 2061 2073 6372   to create a scr
+0002c6c0: 6174 6368 2073 746f 7261 6765 2e0a 2020  atch storage..  
+0002c6d0: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
+0002c6e0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002c6f0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002c700: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002c710: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002c720: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002c730: 6275 636b 6574 5f6e 616d 6529 0a0a 2020  bucket_name)..  
+0002c740: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002c750: 650a 2020 2020 6465 6620 746d 705f 6d75  e.    def tmp_mu
+0002c760: 6c74 6970 6c65 5f73 6372 6174 6368 5f73  ltiple_scratch_s
+0002c770: 746f 7261 6765 5f6f 626a 2873 656c 6629  torage_obj(self)
+0002c780: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c790: 7465 7320 6120 6c69 7374 206f 6620 3520  tes a list of 5 
+0002c7a0: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002c7b0: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
+0002c7c0: 6f20 6372 6561 7465 0a20 2020 2020 2020  o create.       
+0002c7d0: 2023 206d 756c 7469 706c 6520 7363 7261   # multiple scra
+0002c7e0: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
+0002c7f0: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
+0002c800: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
+0002c810: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
+0002c820: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002c830: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002c840: 6f72 6167 655f 6d75 6c74 5f6f 626a 203d  orage_mult_obj =
+0002c850: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+0002c860: 5f20 696e 2072 616e 6765 2835 293a 0a20  _ in range(5):. 
+0002c870: 2020 2020 2020 2020 2020 2074 696d 6573             times
+0002c880: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
+0002c890: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
+0002c8a0: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
+0002c8b0: 2020 2020 2073 746f 7265 5f6f 626a 203d       store_obj =
+0002c8c0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002c8d0: 7261 6765 286e 616d 653d 6627 736b 792d  rage(name=f'sky-
+0002c8e0: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0002c8f0: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+0002c900: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
+0002c910: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
+0002c920: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002c930: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002c940: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
+0002c950: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
+0002c960: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
+0002c970: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+0002c980: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+0002c990: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
+0002c9a0: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
+0002c9b0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0002c9c0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+0002c9d0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0002c9e0: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
+0002c9f0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002ca00: 2068 616e 646c 6520 6578 6973 7473 2c20   handle exists, 
+0002ca10: 6465 6c65 7465 206d 616e 7561 6c6c 790a  delete manually.
+0002ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca30: 2320 544f 444f 2872 6f6d 696c 6229 3a20  # TODO(romilb): 
+0002ca40: 5468 6973 2069 7320 706f 7465 6e74 6961  This is potentia
+0002ca50: 6c6c 7920 7269 736b 7920 2d20 6966 2074  lly risky - if t
+0002ca60: 6865 2064 656c 6574 6520 6d65 7468 6f64  he delete method
+0002ca70: 2068 6173 0a20 2020 2020 2020 2020 2020   has.           
+0002ca80: 2020 2020 2023 2062 7567 732c 2074 6869       # bugs, thi
+0002ca90: 7320 6361 6e20 6361 7573 6520 7265 736f  s can cause reso
+0002caa0: 7572 6365 206c 6561 6b73 2e20 4964 6561  urce leaks. Idea
+0002cab0: 6c6c 7920 7765 2073 686f 756c 6420 6d61  lly we should ma
+0002cac0: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
+0002cad0: 2020 2020 2020 2023 2065 6a65 6374 2073         # eject s
+0002cae0: 746f 7261 6765 2066 726f 6d20 676c 6f62  torage from glob
+0002caf0: 616c 5f75 7365 725f 7374 6174 6520 616e  al_user_state an
+0002cb00: 6420 6465 6c65 7465 2074 6865 2062 7563  d delete the buc
+0002cb10: 6b65 7420 7573 696e 670a 2020 2020 2020  ket using.      
+0002cb20: 2020 2020 2020 2020 2020 2320 626f 746f            # boto
+0002cb30: 3320 6469 7265 6374 6c79 2e0a 2020 2020  3 directly..    
+0002cb40: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002cb50: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0002cb60: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002cb70: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002cb80: 705f 6d75 6c74 6970 6c65 5f63 7573 746f  p_multiple_custo
+0002cb90: 6d5f 736f 7572 6365 5f73 746f 7261 6765  m_source_storage
+0002cba0: 5f6f 626a 2873 656c 6629 3a0a 2020 2020  _obj(self):.    
+0002cbb0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002cbc0: 6c69 7374 206f 6620 7374 6f72 6167 6520  list of storage 
+0002cbd0: 6f62 6a65 6374 7320 7769 7468 2063 7573  objects with cus
+0002cbe0: 746f 6d20 736f 7572 6365 206e 616d 6573  tom source names
+0002cbf0: 2074 6f0a 2020 2020 2020 2020 2320 6372   to.        # cr
+0002cc00: 6561 7465 206d 756c 7469 706c 6520 7363  eate multiple sc
+0002cc10: 7261 7463 6820 7374 6f72 6167 6573 2e0a  ratch storages..
+0002cc20: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
+0002cc30: 2066 6f72 2065 6163 6820 6f62 6a65 6374   for each object
+0002cc40: 2069 6e20 7468 6520 6c69 7374 206d 7573   in the list mus
+0002cc50: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002cc60: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002cc70: 6375 7374 6f6d 5f73 6f75 7263 655f 6e61  custom_source_na
+0002cc80: 6d65 7320 3d20 5b27 2270 6174 6820 5769  mes = ['"path Wi
+0002cc90: 7468 2053 7061 6365 7322 272c 2027 7061  th Spaces"', 'pa
+0002cca0: 7468 2057 6974 6820 5370 6163 6573 275d  th With Spaces']
+0002ccb0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002ccc0: 5f6d 756c 745f 6f62 6a20 3d20 5b5d 0a20  _mult_obj = []. 
+0002ccd0: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+0002cce0: 696e 2063 7573 746f 6d5f 736f 7572 6365  in custom_source
+0002ccf0: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
+0002cd00: 2020 2020 7372 635f 7061 7468 203d 206f      src_path = o
+0002cd10: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+0002cd20: 7228 6627 7e2f 7b6e 616d 657d 2729 0a20  r(f'~/{name}'). 
+0002cd30: 2020 2020 2020 2020 2020 2070 6174 686c             pathl
+0002cd40: 6962 2e50 6174 6828 7372 635f 7061 7468  ib.Path(src_path
+0002cd50: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+0002cd60: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+0002cd70: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0002cd80: 7469 6d65 7374 616d 7020 3d20 7374 7228  timestamp = str(
+0002cd90: 7469 6d65 2e74 696d 6528 2929 2e72 6570  time.time()).rep
+0002cda0: 6c61 6365 2827 2e27 2c20 2727 290a 2020  lace('.', '').  
+0002cdb0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002cdc0: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+0002cdd0: 622e 5374 6f72 6167 6528 6e61 6d65 3d66  b.Storage(name=f
+0002cde0: 2773 6b79 2d74 6573 742d 7b74 696d 6573  'sky-test-{times
+0002cdf0: 7461 6d70 7d27 2c0a 2020 2020 2020 2020  tamp}',.        
+0002ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce20: 2020 2020 736f 7572 6365 3d73 7263 5f70      source=src_p
+0002ce30: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0002ce40: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
+0002ce50: 6a2e 6170 7065 6e64 2873 746f 7265 5f6f  j.append(store_o
+0002ce60: 626a 290a 2020 2020 2020 2020 7969 656c  bj).        yiel
+0002ce70: 6420 7374 6f72 6167 655f 6d75 6c74 5f6f  d storage_mult_o
+0002ce80: 626a 0a20 2020 2020 2020 2066 6f72 2073  bj.        for s
+0002ce90: 746f 7261 6765 5f6f 626a 2069 6e20 7374  torage_obj in st
+0002cea0: 6f72 6167 655f 6d75 6c74 5f6f 626a 3a0a  orage_mult_obj:.
+0002ceb0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+0002cec0: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
+0002ced0: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
+0002cee0: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
+0002cef0: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
+0002cf00: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002cf10: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
+0002cf20: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+0002cf30: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002cf40: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
+0002cf50: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
+0002cf60: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002cf70: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+0002cf80: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0002cf90: 6275 636b 6574 5f6e 616d 652c 2074 6d70  bucket_name, tmp
+0002cfa0: 5f73 6f75 7263 6529 3a0a 2020 2020 2020  _source):.      
+0002cfb0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002cfc0: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
+0002cfd0: 6f62 6a65 6374 2e20 5374 6f72 6573 206d  object. Stores m
+0002cfe0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002cff0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002d000: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002d010: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002d020: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002d030: 6275 636b 6574 5f6e 616d 652c 0a20 2020  bucket_name,.   
+0002d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d060: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002d070: 3d74 6d70 5f73 6f75 7263 6529 0a0a 2020  =tmp_source)..  
+0002d080: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002d090: 650a 2020 2020 6465 6620 746d 705f 6c6f  e.    def tmp_lo
+0002d0a0: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+0002d0b0: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002d0c0: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
+0002d0d0: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
+0002d0e0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002d0f0: 7020 7374 6f72 6167 6520 6f62 6a65 6374  p storage object
+0002d100: 2077 6869 6368 2075 7365 7320 6120 6c69   which uses a li
+0002d110: 7374 206f 6620 7061 7468 7320 6173 2073  st of paths as s
+0002d120: 6f75 7263 652e 0a20 2020 2020 2020 2023  ource..        #
+0002d130: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002d140: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002d150: 742e 2041 6674 6572 2075 706c 6f61 642c  t. After upload,
+0002d160: 2074 6865 2062 7563 6b65 7420 7368 6f75   the bucket shou
+0002d170: 6c64 0a20 2020 2020 2020 2023 2068 6176  ld.        # hav
+0002d180: 6520 7477 6f20 6669 6c65 7320 2d20 2f74  e two files - /t
+0002d190: 6d70 2d66 696c 6520 616e 6420 2f74 6d70  mp-file and /tmp
+0002d1a0: 2d73 6f75 7263 652f 746d 702d 6669 6c65  -source/tmp-file
+0002d1b0: 0a20 2020 2020 2020 206c 6973 745f 736f  .        list_so
+0002d1c0: 7572 6365 203d 205b 746d 705f 736f 7572  urce = [tmp_sour
+0002d1d0: 6365 2c20 746d 705f 736f 7572 6365 202b  ce, tmp_source +
+0002d1e0: 2027 2f74 6d70 2d66 696c 6527 5d0a 2020   '/tmp-file'].  
+0002d1f0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002d200: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002d210: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002d220: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002d230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d250: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002d260: 7572 6365 3d6c 6973 745f 736f 7572 6365  urce=list_source
+0002d270: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002d280: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002d290: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002d2a0: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
+0002d2b0: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
+0002d2c0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002d2d0: 7320 6120 7465 6d70 6f72 6172 7920 7374  s a temporary st
+0002d2e0: 6f72 6167 6520 6f62 6a65 6374 2066 6f72  orage object for
+0002d2f0: 2074 6573 7469 6e67 2062 756c 6b20 6465   testing bulk de
+0002d300: 6c65 7469 6f6e 2e0a 2020 2020 2020 2020  letion..        
+0002d310: 2320 5374 6f72 6573 206d 7573 7420 6265  # Stores must be
+0002d320: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0002d330: 7374 2e0a 2020 2020 2020 2020 7769 7468  st..        with
+0002d340: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
+0002d350: 6172 7944 6972 6563 746f 7279 2829 2061  aryDirectory() a
+0002d360: 7320 746d 7064 6972 3a0a 2020 2020 2020  s tmpdir:.      
+0002d370: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002d380: 2e63 6865 636b 5f6f 7574 7075 7428 6627  .check_output(f'
+0002d390: 6d6b 6469 7220 2d70 207b 746d 7064 6972  mkdir -p {tmpdir
+0002d3a0: 7d2f 666f 6c64 6572 7b7b 3030 302e 2e32  }/folder{{000..2
+0002d3b0: 3535 7d7d 272c 0a20 2020 2020 2020 2020  55}}',.         
+0002d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3d0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002d3e0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0002d3f0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002d400: 6563 6b5f 6f75 7470 7574 2866 2774 6f75  eck_output(f'tou
+0002d410: 6368 207b 746d 7064 6972 7d2f 7465 7374  ch {tmpdir}/test
+0002d420: 7b7b 3030 302e 2e32 3535 7d7d 2e74 7874  {{000..255}}.txt
+0002d430: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d450: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0002d460: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002d470: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002d480: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002d490: 2020 2020 2020 2020 6627 746f 7563 6820          f'touch 
+0002d4a0: 7b74 6d70 6469 727d 2f66 6f6c 6465 727b  {tmpdir}/folder{
+0002d4b0: 7b30 3030 2e2e 3235 357d 7d2f 7465 7374  {000..255}}/test
+0002d4c0: 2e74 7874 272c 2073 6865 6c6c 3d54 7275  .txt', shell=Tru
+0002d4d0: 6529 0a20 2020 2020 2020 2020 2020 2079  e).            y
+0002d4e0: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0002d4f0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0002d500: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
+0002d510: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d540: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0002d550: 653d 746d 7064 6972 290a 0a20 2020 2040  e=tmpdir)..    @
+0002d560: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002d570: 2020 2064 6566 2074 6d70 5f63 6f70 795f     def tmp_copy_
+0002d580: 6d6e 745f 6578 6973 7469 6e67 5f73 746f  mnt_existing_sto
+0002d590: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
+0002d5a0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002d5b0: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
+0002d5c0: 2023 2043 7265 6174 6573 2061 2063 6f70   # Creates a cop
+0002d5d0: 7920 6d6f 756e 7420 7374 6f72 6167 6520  y mount storage 
+0002d5e0: 7768 6963 6820 7265 7573 6573 2061 6e20  which reuses an 
+0002d5f0: 6578 6973 7469 6e67 2073 746f 7261 6765  existing storage
+0002d600: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+0002d610: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0002d620: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002d630: 7265 2873 746f 7261 6765 5f6c 6962 2e53  re(storage_lib.S
+0002d640: 746f 7265 5479 7065 2e53 3329 0a20 2020  toreType.S3).   
+0002d650: 2020 2020 2073 746f 7261 6765 5f6e 616d       storage_nam
+0002d660: 6520 3d20 746d 705f 7363 7261 7463 685f  e = tmp_scratch_
+0002d670: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002d680: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
+0002d690: 746f 2069 6e69 7469 616c 697a 6520 616e  to initialize an
+0002d6a0: 6f74 6865 7220 7374 6f72 6167 6520 7769  other storage wi
+0002d6b0: 7468 2074 6865 2073 746f 7261 6765 206f  th the storage o
+0002d6c0: 626a 6563 7420 6372 6561 7465 640a 2020  bject created.  
+0002d6d0: 2020 2020 2020 2320 6162 6f76 652c 2062        # above, b
+0002d6e0: 7574 206e 6f77 2069 6e20 434f 5059 206d  ut now in COPY m
+0002d6f0: 6f64 652e 2054 6869 7320 7368 6f75 6c64  ode. This should
+0002d700: 2073 7563 6365 6564 2e0a 2020 2020 2020   succeed..      
+0002d710: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002d720: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002d730: 6f62 6a65 6374 286e 616d 653d 7374 6f72  object(name=stor
+0002d740: 6167 655f 6e61 6d65 2c0a 2020 2020 2020  age_name,.      
+0002d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d770: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
+0002d780: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002d790: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
+0002d7a0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002d7b0: 2020 2064 6566 2074 6d70 5f67 6974 6967     def tmp_gitig
+0002d7c0: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
+0002d7d0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002d7e0: 745f 6e61 6d65 2c20 6769 7469 676e 6f72  t_name, gitignor
+0002d7f0: 655f 7374 7275 6374 7572 6529 3a0a 2020  e_structure):.  
+0002d800: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002d810: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
+0002d820: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
+0002d830: 6573 7469 6e67 202e 6769 7469 676e 6f72  esting .gitignor
+0002d840: 6520 6669 6c74 6572 2e0a 2020 2020 2020  e filter..      
+0002d850: 2020 2320 4749 5449 4749 4e4f 5245 5f53    # GITIGINORE_S
+0002d860: 5452 5543 5455 5245 2069 7320 7265 7072  TRUCTURE is repr
+0002d870: 6573 656e 7469 6e67 2061 2066 696c 6520  esenting a file 
+0002d880: 7374 7275 6374 7572 6520 696e 2061 2064  structure in a d
+0002d890: 6963 7469 6f6e 6172 790a 2020 2020 2020  ictionary.      
+0002d8a0: 2020 2320 666f 726d 6174 2e20 4372 6561    # format. Crea
+0002d8b0: 7465 6420 7374 6f72 6167 6520 6f62 6a65  ted storage obje
+0002d8c0: 6374 2077 696c 6c20 636f 6e74 6169 6e20  ct will contain 
+0002d8d0: 7468 6520 6669 6c65 2073 7472 7563 7475  the file structu
+0002d8e0: 7265 2061 6c6f 6e67 0a20 2020 2020 2020  re along.       
+0002d8f0: 2023 2077 6974 6820 2e67 6974 6967 6e6f   # with .gitigno
+0002d900: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
+0002d910: 2f65 7863 6c75 6465 2066 696c 6573 2074  /exclude files t
+0002d920: 6f20 7465 7374 2065 7863 6c75 6465 2066  o test exclude f
+0002d930: 696c 7465 722e 0a20 2020 2020 2020 2023  ilter..        #
+0002d940: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002d950: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002d960: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
+0002d970: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
+0002d980: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
+0002d990: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
+0002d9a0: 2020 2020 2023 2043 7265 6174 6573 2066       # Creates f
+0002d9b0: 696c 6520 7374 7275 6374 7572 6520 746f  ile structure to
+0002d9c0: 2062 6520 7570 6c6f 6164 6564 2069 6e20   be uploaded in 
+0002d9d0: 7468 6520 5374 6f72 6167 650a 2020 2020  the Storage.    
+0002d9e0: 2020 2020 2020 2020 7365 6c66 2e63 7265          self.cre
+0002d9f0: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
+0002da00: 6528 746d 7064 6972 2c20 6769 7469 676e  e(tmpdir, gitign
+0002da10: 6f72 655f 7374 7275 6374 7572 6529 0a0a  ore_structure)..
+0002da20: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002da30: 6561 7465 202e 6769 7469 676e 6f72 6520  eate .gitignore 
+0002da40: 616e 6420 6c69 7374 2066 696c 6573 2f64  and list files/d
+0002da50: 6972 7320 746f 2062 6520 6578 636c 7564  irs to be exclud
+0002da60: 6564 2069 6e20 6974 0a20 2020 2020 2020  ed in it.       
+0002da70: 2020 2020 2073 6b79 7069 6c6f 745f 7061       skypilot_pa
+0002da80: 7468 203d 206f 732e 7061 7468 2e64 6972  th = os.path.dir
+0002da90: 6e61 6d65 286f 732e 7061 7468 2e64 6972  name(os.path.dir
+0002daa0: 6e61 6d65 2873 6b79 2e5f 5f66 696c 655f  name(sky.__file_
+0002dab0: 5f29 290a 2020 2020 2020 2020 2020 2020  _)).            
+0002dac0: 7465 6d70 5f70 6174 6820 3d20 6627 7b74  temp_path = f'{t
+0002dad0: 6d70 6469 727d 2f2e 6769 7469 676e 6f72  mpdir}/.gitignor
+0002dae0: 6527 0a20 2020 2020 2020 2020 2020 2066  e'.            f
+0002daf0: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
+0002db00: 7468 2e6a 6f69 6e28 736b 7970 696c 6f74  th.join(skypilot
+0002db10: 5f70 6174 682c 2027 7465 7374 732f 6769  _path, 'tests/gi
+0002db20: 7469 676e 6f72 655f 7465 7374 2729 0a20  tignore_test'). 
+0002db30: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002db40: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002db50: 7061 7468 2c20 7465 6d70 5f70 6174 6829  path, temp_path)
+0002db60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0002db70: 4372 6561 7465 202e 6769 742f 696e 666f  Create .git/info
+0002db80: 2f65 7863 6c75 6465 2061 6e64 206c 6973  /exclude and lis
+0002db90: 7420 6669 6c65 732f 6469 7273 2074 6f20  t files/dirs to 
+0002dba0: 6265 2065 7863 6c75 6465 6420 696e 2069  be excluded in i
+0002dbb0: 740a 2020 2020 2020 2020 2020 2020 7465  t.            te
+0002dbc0: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
+0002dbd0: 6469 727d 2f2e 6769 742f 696e 666f 2f27  dir}/.git/info/'
+0002dbe0: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
+0002dbf0: 6d61 6b65 6469 7273 2874 656d 705f 7061  makedirs(temp_pa
+0002dc00: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0002dc10: 7465 6d70 5f65 7863 6c75 6465 5f70 6174  temp_exclude_pat
+0002dc20: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0002dc30: 2874 656d 705f 7061 7468 2c20 2765 7863  (temp_path, 'exc
+0002dc40: 6c75 6465 2729 0a20 2020 2020 2020 2020  lude').         
+0002dc50: 2020 2066 696c 655f 7061 7468 203d 206f     file_path = o
+0002dc60: 732e 7061 7468 2e6a 6f69 6e28 736b 7970  s.path.join(skyp
+0002dc70: 696c 6f74 5f70 6174 682c 0a20 2020 2020  ilot_path,.     
+0002dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dca0: 2774 6573 7473 2f67 6974 5f69 6e66 6f5f  'tests/git_info_
+0002dcb0: 6578 636c 7564 655f 7465 7374 2729 0a20  exclude_test'). 
+0002dcc0: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002dcd0: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002dce0: 7061 7468 2c20 7465 6d70 5f65 7863 6c75  path, temp_exclu
+0002dcf0: 6465 5f70 6174 6829 0a0a 2020 2020 2020  de_path)..      
+0002dd00: 2020 2020 2020 2320 4372 6561 7465 2073        # Create s
+0002dd10: 6b79 2053 746f 7261 6765 2077 6974 6820  ky Storage with 
+0002dd20: 7468 6520 6669 6c65 7320 6372 6561 7465  the files create
+0002dd30: 640a 2020 2020 2020 2020 2020 2020 7969  d.            yi
+0002dd40: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
+0002dd50: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
+0002dd60: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0002dd70: 2020 2020 6e61 6d65 3d74 6d70 5f62 7563      name=tmp_buc
+0002dd80: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002dd90: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002dda0: 3d74 6d70 6469 722c 0a20 2020 2020 2020  =tmpdir,.       
+0002ddb0: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+0002ddc0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+0002ddd0: 654d 6f64 652e 434f 5059 290a 0a20 2020  eMode.COPY)..   
+0002dde0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002ddf0: 0a20 2020 2064 6566 2074 6d70 5f61 7773  .    def tmp_aws
+0002de00: 636c 695f 6275 636b 6574 2873 656c 662c  cli_bucket(self,
+0002de10: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002de20: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002de30: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002de40: 2062 7563 6b65 7420 7573 696e 6720 6177   bucket using aw
+0002de50: 7363 6c69 0a20 2020 2020 2020 2062 7563  scli.        buc
+0002de60: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
+0002de70: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
+0002de80: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
+0002de90: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0002dea0: 6c28 5b27 6177 7327 2c20 2773 3327 2c20  l(['aws', 's3', 
+0002deb0: 276d 6227 2c20 6275 636b 6574 5f75 7269  'mb', bucket_uri
+0002dec0: 5d29 0a20 2020 2020 2020 2079 6965 6c64  ]).        yield
+0002ded0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002dee0: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
+0002def0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002df00: 6368 6563 6b5f 6361 6c6c 285b 2761 7773  check_call(['aws
+0002df10: 272c 2027 7333 272c 2027 7262 272c 2062  ', 's3', 'rb', b
+0002df20: 7563 6b65 745f 7572 692c 2027 2d2d 666f  ucket_uri, '--fo
+0002df30: 7263 6527 5d29 0a0a 2020 2020 4070 7974  rce'])..    @pyt
+0002df40: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002df50: 6465 6620 746d 705f 6773 7574 696c 5f62  def tmp_gsutil_b
+0002df60: 7563 6b65 7428 7365 6c66 2c20 746d 705f  ucket(self, tmp_
+0002df70: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002df80: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002df90: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0002dfa0: 6574 2075 7369 6e67 2067 7375 7469 6c0a  et using gsutil.
+0002dfb0: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
+0002dfc0: 7269 203d 2066 2767 733a 2f2f 7b74 6d70  ri = f'gs://{tmp
+0002dfd0: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
+0002dfe0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002dff0: 732e 6368 6563 6b5f 6361 6c6c 285b 2767  s.check_call(['g
+0002e000: 7375 7469 6c27 2c20 276d 6227 2c20 6275  sutil', 'mb', bu
+0002e010: 636b 6574 5f75 7269 5d29 0a20 2020 2020  cket_uri]).     
+0002e020: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
+0002e030: 6b65 745f 6e61 6d65 2c20 6275 636b 6574  ket_name, bucket
+0002e040: 5f75 7269 0a20 2020 2020 2020 2073 7562  _uri.        sub
+0002e050: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
+0002e060: 6c6c 285b 2767 7375 7469 6c27 2c20 2772  ll(['gsutil', 'r
+0002e070: 6d27 2c20 272d 7227 2c20 6275 636b 6574  m', '-r', bucket
+0002e080: 5f75 7269 5d29 0a0a 2020 2020 4070 7974  _uri])..    @pyt
+0002e090: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002e0a0: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
+0002e0b0: 7563 6b65 745f 7232 2873 656c 662c 2074  ucket_r2(self, t
+0002e0c0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0002e0d0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002e0e0: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0002e0f0: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
+0002e100: 6c69 0a20 2020 2020 2020 2065 6e64 706f  li.        endpo
+0002e110: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+0002e120: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+0002e130: 6f69 6e74 2829 0a20 2020 2020 2020 2062  oint().        b
+0002e140: 7563 6b65 745f 7572 6920 3d20 6627 7333  ucket_uri = f's3
+0002e150: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
+0002e160: 616d 657d 270a 2020 2020 2020 2020 7375  ame}'.        su
+0002e170: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0002e180: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
+0002e190: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0002e1a0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0002e1b0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0002e1c0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0002e1d0: 6177 7320 7333 206d 6220 7b62 7563 6b65  aws s3 mb {bucke
+0002e1e0: 745f 7572 697d 202d 2d65 6e64 706f 696e  t_uri} --endpoin
+0002e1f0: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
+0002e200: 202d 2d70 726f 6669 6c65 3d72 3227 2c0a   --profile=r2',.
+0002e210: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0002e220: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0002e230: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
+0002e240: 5f6e 616d 652c 2062 7563 6b65 745f 7572  _name, bucket_ur
+0002e250: 690a 2020 2020 2020 2020 7375 6270 726f  i.        subpro
+0002e260: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0002e270: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
+0002e280: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0002e290: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0002e2a0: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0002e2b0: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0002e2c0: 7333 2072 6220 7b62 7563 6b65 745f 7572  s3 rb {bucket_ur
+0002e2d0: 697d 202d 2d66 6f72 6365 202d 2d65 6e64  i} --force --end
+0002e2e0: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0002e2f0: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002e300: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+0002e310: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
+0002e320: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002e330: 0a20 2020 2064 6566 2074 6d70 5f69 626d  .    def tmp_ibm
+0002e340: 5f63 6f73 5f62 7563 6b65 7428 7365 6c66  _cos_bucket(self
+0002e350: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0002e360: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002e370: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002e380: 7920 6275 636b 6574 2075 7369 6e67 2049  y bucket using I
+0002e390: 424d 2043 4f53 2041 5049 0a20 2020 2020  BM COS API.     
+0002e3a0: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
+0002e3b0: 2073 746f 7261 6765 5f6c 6962 2e49 424d   storage_lib.IBM
+0002e3c0: 436f 7353 746f 7265 2873 6f75 7263 653d  CosStore(source=
+0002e3d0: 2222 2c20 6e61 6d65 3d74 6d70 5f62 7563  "", name=tmp_buc
+0002e3e0: 6b65 745f 6e61 6d65 290a 2020 2020 2020  ket_name).      
+0002e3f0: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
+0002e400: 6574 5f6e 616d 650a 2020 2020 2020 2020  et_name.        
+0002e410: 7374 6f72 6167 655f 6f62 6a2e 6465 6c65  storage_obj.dele
+0002e420: 7465 2829 0a0a 2020 2020 4070 7974 6573  te()..    @pytes
+0002e430: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002e440: 6620 746d 705f 7075 626c 6963 5f73 746f  f tmp_public_sto
+0002e450: 7261 6765 5f6f 626a 2873 656c 662c 2072  rage_obj(self, r
+0002e460: 6571 7565 7374 293a 0a20 2020 2020 2020  equest):.       
+0002e470: 2023 2049 6e69 7469 616c 697a 6573 2061   # Initializes a
+0002e480: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002e490: 7769 7468 2061 2070 7562 6c69 6320 6275  with a public bu
+0002e4a0: 636b 6574 0a20 2020 2020 2020 2073 746f  cket.        sto
+0002e4b0: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0002e4c0: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
+0002e4d0: 6f75 7263 653d 7265 7175 6573 742e 7061  ource=request.pa
+0002e4e0: 7261 6d29 0a20 2020 2020 2020 2079 6965  ram).        yie
+0002e4f0: 6c64 2073 746f 7261 6765 5f6f 626a 0a20  ld storage_obj. 
+0002e500: 2020 2020 2020 2023 2054 6869 7320 646f         # This do
+0002e510: 6573 206e 6f74 2072 6571 7569 7265 2061  es not require a
+0002e520: 6e79 2064 656c 6574 696f 6e20 6c6f 6769  ny deletion logi
+0002e530: 6320 6265 6361 7573 6520 6974 2069 7320  c because it is 
+0002e540: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
+0002e550: 2020 2020 2020 2020 2320 616e 6420 7368          # and sh
+0002e560: 6f75 6c64 206e 6f74 2067 6574 2061 6464  ould not get add
+0002e570: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
+0002e580: 725f 7374 6174 652e 0a0a 2020 2020 4070  r_state...    @p
+0002e590: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002e5a0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002e5b0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002e5c0: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002e5d0: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002e5e0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002e5f0: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002e600: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002e610: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002e620: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002e630: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002e640: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002e650: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002e660: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002e670: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002e680: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002e690: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002e6a0: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002e6b0: 2020 2064 6566 2074 6573 745f 6e65 775f     def test_new_
+0002e6c0: 6275 636b 6574 5f63 7265 6174 696f 6e5f  bucket_creation_
+0002e6d0: 616e 645f 6465 6c65 7469 6f6e 2873 656c  and_deletion(sel
+0002e6e0: 662c 2074 6d70 5f6c 6f63 616c 5f73 746f  f, tmp_local_sto
+0002e6f0: 7261 6765 5f6f 626a 2c0a 2020 2020 2020  rage_obj,.      
+0002e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e720: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+0002e730: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
+0002e740: 7265 6174 6573 2061 206e 6577 2062 7563  reates a new buc
+0002e750: 6b65 7420 7769 7468 2061 206c 6f63 616c  ket with a local
+0002e760: 2073 6f75 7263 652c 2075 706c 6f61 6473   source, uploads
+0002e770: 2066 696c 6573 2074 6f20 6974 0a20 2020   files to it.   
+0002e780: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002e790: 6573 2069 742e 0a20 2020 2020 2020 2074  es it..        t
+0002e7a0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
+0002e7b0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+0002e7c0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+0002e7d0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+0002e7e0: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+0002e7f0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
+0002e800: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
+0002e810: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+0002e820: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002e830: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002e840: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002e850: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002e860: 2061 7373 6572 7420 746d 705f 6c6f 6361   assert tmp_loca
+0002e870: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002e880: 6d65 2069 6e20 6f75 742e 6465 636f 6465  me in out.decode
+0002e890: 2827 7574 662d 3827 290a 0a20 2020 2020  ('utf-8')..     
+0002e8a0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002e8b0: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002e8c0: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002e8d0: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002e8e0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002e8f0: 6b5f 6f75 7470 7574 280a 2020 2020 2020  k_output(.      
+0002e900: 2020 2020 2020 5b27 736b 7927 2c20 2773        ['sky', 's
+0002e910: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
+0002e920: 272c 2074 6d70 5f6c 6f63 616c 5f73 746f  ', tmp_local_sto
+0002e930: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+0002e940: 2d2d 7965 7327 5d29 0a0a 2020 2020 2020  --yes'])..      
+0002e950: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002e960: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0002e970: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0002e980: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
+0002e990: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002e9a0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002e9b0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002e9c0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002e9d0: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002e9e0: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002e9f0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0002ea00: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002ea10: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002ea20: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002ea30: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002ea40: 726b 2e78 6469 7374 5f67 726f 7570 2827  rk.xdist_group('
+0002ea50: 6d75 6c74 6970 6c65 5f62 7563 6b65 745f  multiple_bucket_
+0002ea60: 6465 6c65 7469 6f6e 2729 0a20 2020 2040  deletion').    @
+0002ea70: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0002ea80: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
+0002ea90: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
+0002eaa0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002eab0: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
+0002eac0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002ead0: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
+0002eae0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002eaf0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002eb00: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002eb10: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002eb20: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0002eb30: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002eb40: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002eb50: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002eb60: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+0002eb70: 0a20 2020 2064 6566 2074 6573 745f 6d75  .    def test_mu
+0002eb80: 6c74 6970 6c65 5f62 7563 6b65 7473 5f63  ltiple_buckets_c
+0002eb90: 7265 6174 696f 6e5f 616e 645f 6465 6c65  reation_and_dele
+0002eba0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0002ebb0: 2020 7365 6c66 2c20 746d 705f 6d75 6c74    self, tmp_mult
+0002ebc0: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
+0002ebd0: 7261 6765 5f6f 626a 2c20 7374 6f72 655f  rage_obj, store_
+0002ebe0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002ebf0: 2043 7265 6174 6573 206d 756c 7469 706c   Creates multipl
+0002ec00: 6520 6e65 7720 6275 636b 6574 7328 3520  e new buckets(5 
+0002ec10: 6275 636b 6574 7329 2077 6974 6820 6120  buckets) with a 
+0002ec20: 6c6f 6361 6c20 736f 7572 6365 0a20 2020  local source.   
+0002ec30: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002ec40: 6573 2074 6865 6d2e 0a20 2020 2020 2020  es them..       
+0002ec50: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002ec60: 6520 3d20 5b5d 0a20 2020 2020 2020 2066  e = [].        f
+0002ec70: 6f72 2073 746f 7265 5f6f 626a 2069 6e20  or store_obj in 
+0002ec80: 746d 705f 6d75 6c74 6970 6c65 5f73 6372  tmp_multiple_scr
+0002ec90: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002eca0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0002ecb0: 6f72 655f 6f62 6a2e 6164 645f 7374 6f72  ore_obj.add_stor
+0002ecc0: 6528 7374 6f72 655f 7479 7065 290a 2020  e(store_type).  
+0002ecd0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002ece0: 655f 6f62 6a5f 6e61 6d65 2e61 7070 656e  e_obj_name.appen
+0002ecf0: 6428 7374 6f72 655f 6f62 6a2e 6e61 6d65  d(store_obj.name
+0002ed00: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002ed10: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
+0002ed20: 746f 2063 6865 636b 2069 6620 616c 6c20  to check if all 
+0002ed30: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002ed40: 6578 6973 7473 2069 6e20 7468 650a 2020  exists in the.  
+0002ed50: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+0002ed60: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
+0002ed70: 2074 7970 650a 2020 2020 2020 2020 6f75   type.        ou
+0002ed80: 745f 616c 6c20 3d20 7375 6270 726f 6365  t_all = subproce
+0002ed90: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002eda0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002edb0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002edc0: 2020 6f75 7420 3d20 5b0a 2020 2020 2020    out = [.      
+0002edd0: 2020 2020 2020 6974 656d 2e73 706c 6974        item.split
+0002ede0: 2829 5b30 5d0a 2020 2020 2020 2020 2020  ()[0].          
+0002edf0: 2020 666f 7220 6974 656d 2069 6e20 6f75    for item in ou
+0002ee00: 745f 616c 6c2e 6465 636f 6465 2827 7574  t_all.decode('ut
+0002ee10: 662d 3827 292e 7370 6c69 746c 696e 6573  f-8').splitlines
+0002ee20: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0002ee30: 6620 7374 6f72 655f 7479 7065 2e76 616c  f store_type.val
+0002ee40: 7565 2069 6e20 6974 656d 0a20 2020 2020  ue in item.     
+0002ee50: 2020 205d 0a20 2020 2020 2020 2061 7373     ].        ass
+0002ee60: 6572 7420 616c 6c28 5b69 7465 6d20 696e  ert all([item in
+0002ee70: 206f 7574 2066 6f72 2069 7465 6d20 696e   out for item in
+0002ee80: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002ee90: 655d 290a 0a20 2020 2020 2020 2023 2052  e])..        # R
+0002eea0: 756e 2073 6b79 2073 746f 7261 6765 2064  un sky storage d
+0002eeb0: 656c 6574 6520 616c 6c20 746f 2064 656c  elete all to del
+0002eec0: 6574 6520 616c 6c20 7374 6f72 6167 6520  ete all storage 
+0002eed0: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
+0002eee0: 6465 6c65 7465 5f63 6d64 203d 205b 2773  delete_cmd = ['s
+0002eef0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002ef00: 2764 656c 6574 6527 2c20 272d 2d79 6573  'delete', '--yes
+0002ef10: 275d 0a20 2020 2020 2020 2064 656c 6574  '].        delet
+0002ef20: 655f 636d 6420 2b3d 2073 746f 7261 6765  e_cmd += storage
+0002ef30: 5f6f 626a 5f6e 616d 650a 2020 2020 2020  _obj_name.      
+0002ef40: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002ef50: 636b 5f6f 7574 7075 7428 6465 6c65 7465  ck_output(delete
+0002ef60: 5f63 6d64 290a 0a20 2020 2020 2020 2023  _cmd)..        #
+0002ef70: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002ef80: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002ef90: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002efa0: 6374 7320 6669 6c74 6572 6564 2062 7920  cts filtered by 
+0002efb0: 7374 6f72 650a 2020 2020 2020 2020 2320  store.        # 
+0002efc0: 7479 7065 2061 7265 2064 656c 6574 6564  type are deleted
+0002efd0: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
+0002efe0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002eff0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0002f000: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0002f010: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
+0002f020: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002f030: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
+0002f040: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002f050: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
+0002f060: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002f070: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
+0002f080: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
+0002f090: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
+0002f0a0: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
+0002f0b0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+0002f0c0: 6c6c 285b 6974 656d 206e 6f74 2069 6e20  ll([item not in 
+0002f0d0: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
+0002f0e0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002f0f0: 5d29 0a0a 2020 2020 4070 7974 6573 742e  ])..    @pytest.
+0002f100: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002f110: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002f120: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002f130: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+0002f140: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002f150: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0002f160: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0002f170: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+0002f180: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002f190: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+0002f1a0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+0002f1b0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0002f1c0: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0002f1d0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002f1e0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002f1f0: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002f200: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002f210: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0002f220: 2074 6573 745f 7570 6c6f 6164 5f73 6f75   test_upload_sou
+0002f230: 7263 655f 7769 7468 5f73 7061 6365 7328  rce_with_spaces(
+0002f240: 7365 6c66 2c20 7374 6f72 655f 7479 7065  self, store_type
+0002f250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f270: 2020 2020 2020 2020 2074 6d70 5f6d 756c           tmp_mul
+0002f280: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002f290: 7263 655f 7374 6f72 6167 655f 6f62 6a29  rce_storage_obj)
+0002f2a0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002f2b0: 7465 7320 7477 6f20 6275 636b 6574 7320  tes two buckets 
+0002f2c0: 7769 7468 2073 7065 6369 6669 6564 206c  with specified l
+0002f2d0: 6f63 616c 2073 6f75 7263 6573 0a20 2020  ocal sources.   
+0002f2e0: 2020 2020 2023 2077 6974 6820 7370 6163       # with spac
+0002f2f0: 6573 2069 6e20 7468 6520 6e61 6d65 0a20  es in the name. 
+0002f300: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002f310: 626a 5f6e 616d 6573 203d 205b 5d0a 2020  bj_names = [].  
+0002f320: 2020 2020 2020 666f 7220 7374 6f72 6167        for storag
+0002f330: 655f 6f62 6a20 696e 2074 6d70 5f6d 756c  e_obj in tmp_mul
+0002f340: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002f350: 7263 655f 7374 6f72 6167 655f 6f62 6a3a  rce_storage_obj:
+0002f360: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002f370: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002f380: 7265 2873 746f 7265 5f74 7970 6529 0a20  re(store_type). 
+0002f390: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002f3a0: 6765 5f6f 626a 5f6e 616d 6573 2e61 7070  ge_obj_names.app
+0002f3b0: 656e 6428 7374 6f72 6167 655f 6f62 6a2e  end(storage_obj.
+0002f3c0: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+0002f3d0: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002f3e0: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002f3f0: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002f400: 6374 7320 6578 6973 7473 2069 6e20 7468  cts exists in th
+0002f410: 650a 2020 2020 2020 2020 2320 6f75 7470  e.        # outp
+0002f420: 7574 2066 696c 7465 7265 6420 6279 2073  ut filtered by s
+0002f430: 746f 7265 2074 7970 650a 2020 2020 2020  tore type.      
+0002f440: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0002f450: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002f460: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002f470: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002f480: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0002f490: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0002f4a0: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0002f4b0: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0002f4c0: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0002f4d0: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0002f4e0: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0002f4f0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002f500: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0002f510: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002f520: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0002f530: 6d20 696e 206f 7574 2066 6f72 2069 7465  m in out for ite
+0002f540: 6d20 696e 2073 746f 7261 6765 5f6f 626a  m in storage_obj
+0002f550: 5f6e 616d 6573 5d29 0a0a 2020 2020 4070  _names])..    @p
+0002f560: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002f570: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002f580: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002f590: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002f5a0: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002f5b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002f5c0: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002f5d0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002f5e0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002f5f0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002f600: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002f610: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002f620: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002f630: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002f640: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002f650: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002f660: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002f670: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002f680: 2020 2064 6566 2074 6573 745f 6275 636b     def test_buck
+0002f690: 6574 5f65 7874 6572 6e61 6c5f 6465 6c65  et_external_dele
+0002f6a0: 7469 6f6e 2873 656c 662c 2074 6d70 5f73  tion(self, tmp_s
+0002f6b0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002f6c0: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
+0002f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6e0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002f6f0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002f700: 2043 7265 6174 6573 2061 2062 7563 6b65   Creates a bucke
+0002f710: 742c 2064 656c 6574 6573 2069 7420 6578  t, deletes it ex
+0002f720: 7465 726e 616c 6c79 2075 7369 6e67 2063  ternally using c
+0002f730: 6c6f 7564 2063 6c69 2063 6f6d 6d61 6e64  loud cli command
+0002f740: 730a 2020 2020 2020 2020 2320 616e 6420  s.        # and 
+0002f750: 7468 656e 2074 7269 6573 2074 6f20 6465  then tries to de
+0002f760: 6c65 7465 2069 7420 7573 696e 6720 736b  lete it using sk
+0002f770: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0002f780: 2e0a 2020 2020 2020 2020 746d 705f 7363  ..        tmp_sc
+0002f790: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002f7a0: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002f7b0: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+0002f7c0: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002f7d0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002f7e0: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002f7f0: 2065 7869 7374 7320 696e 2074 6865 206f   exists in the o
+0002f800: 7574 7075 740a 2020 2020 2020 2020 6f75  utput.        ou
+0002f810: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002f820: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002f830: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002f840: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002f850: 7365 7274 2074 6d70 5f73 6372 6174 6368  sert tmp_scratch
+0002f860: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002f870: 6520 696e 206f 7574 2e64 6563 6f64 6528  e in out.decode(
+0002f880: 2775 7466 2d38 2729 0a0a 2020 2020 2020  'utf-8')..      
+0002f890: 2020 2320 4465 6c65 7465 2062 7563 6b65    # Delete bucke
+0002f8a0: 7420 6578 7465 726e 616c 6c79 0a20 2020  t externally.   
+0002f8b0: 2020 2020 2063 6d64 203d 2073 656c 662e       cmd = self.
+0002f8c0: 636c 695f 6465 6c65 7465 5f63 6d64 2873  cli_delete_cmd(s
+0002f8d0: 746f 7265 5f74 7970 652c 2074 6d70 5f73  tore_type, tmp_s
+0002f8e0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002f8f0: 626a 2e6e 616d 6529 0a20 2020 2020 2020  bj.name).       
+0002f900: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002f910: 6b5f 6f75 7470 7574 2863 6d64 2c20 7368  k_output(cmd, sh
+0002f920: 656c 6c3d 5472 7565 290a 0a20 2020 2020  ell=True)..     
+0002f930: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002f940: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002f950: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002f960: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002f970: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002f980: 732e 6368 6563 6b5f 6f75 7470 7574 280a  s.check_output(.
+0002f990: 2020 2020 2020 2020 2020 2020 5b27 736b              ['sk
+0002f9a0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002f9b0: 6465 6c65 7465 272c 2074 6d70 5f73 6372  delete', tmp_scr
+0002f9c0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002f9d0: 2e6e 616d 652c 2027 2d2d 7965 7327 5d29  .name, '--yes'])
+0002f9e0: 0a20 2020 2020 2020 2023 204d 616b 6520  .        # Make 
+0002f9f0: 7375 7265 2062 7563 6b65 7420 7761 7320  sure bucket was 
+0002fa00: 6e6f 7420 6372 6561 7465 6420 6475 7269  not created duri
+0002fa10: 6e67 2064 656c 6574 696f 6e20 2873 6565  ng deletion (see
+0002fa20: 2069 7373 7565 2023 3133 3232 290a 2020   issue #1322).  
+0002fa30: 2020 2020 2020 6173 7365 7274 2027 6372        assert 'cr
+0002fa40: 6561 7465 6427 206e 6f74 2069 6e20 6f75  eated' not in ou
+0002fa50: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002fa60: 292e 6c6f 7765 7228 290a 0a20 2020 2020  ).lower()..     
+0002fa70: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002fa80: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002fa90: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0002faa0: 6374 2069 7320 6465 6c65 7465 640a 2020  ct is deleted.  
+0002fab0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002fac0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002fad0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002fae0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002faf0: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
+0002fb00: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002fb10: 5f6f 626a 2e6e 616d 6520 6e6f 7420 696e  _obj.name not in
+0002fb20: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0002fb30: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
+0002fb40: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0002fb50: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
+0002fb60: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0002fb70: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+0002fb80: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+0002fb90: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002fba0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+0002fbb0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+0002fbc0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002fbd0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0002fbe0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
+0002fbf0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002fc00: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+0002fc10: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002fc20: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002fc30: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+0002fc40: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+0002fc50: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
+0002fc60: 6566 2074 6573 745f 6275 636b 6574 5f62  ef test_bucket_b
+0002fc70: 756c 6b5f 6465 6c65 7469 6f6e 2873 656c  ulk_deletion(sel
+0002fc80: 662c 2073 746f 7265 5f74 7970 652c 2074  f, store_type, t
+0002fc90: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002fca0: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+0002fcb0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002fcc0: 6d70 2066 6f6c 6465 7220 7769 7468 206f  mp folder with o
+0002fcd0: 7665 7220 3235 3620 6669 6c65 7320 616e  ver 256 files an
+0002fce0: 6420 666f 6c64 6572 732c 2075 706c 6f61  d folders, uploa
+0002fcf0: 640a 2020 2020 2020 2020 2320 6669 6c65  d.        # file
+0002fd00: 7320 616e 6420 666f 6c64 6572 7320 746f  s and folders to
+0002fd10: 2061 206e 6577 2062 7563 6b65 742c 2074   a new bucket, t
+0002fd20: 6865 6e20 6465 6c65 7465 2062 7563 6b65  hen delete bucke
+0002fd30: 742e 0a20 2020 2020 2020 2074 6d70 5f62  t..        tmp_b
+0002fd40: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
+0002fd50: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002fd60: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002fd70: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002fd80: 6563 6b5f 6f75 7470 7574 285b 0a20 2020  eck_output([.   
+0002fd90: 2020 2020 2020 2020 2027 736b 7927 2c20           'sky', 
+0002fda0: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
+0002fdb0: 7465 272c 2074 6d70 5f62 756c 6b5f 6465  te', tmp_bulk_de
+0002fdc0: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002fdd0: 6d65 2c20 272d 2d79 6573 270a 2020 2020  me, '--yes'.    
+0002fde0: 2020 2020 5d29 0a0a 2020 2020 2020 2020      ])..        
+0002fdf0: 6f75 7470 7574 203d 2073 7562 7072 6f63  output = subproc
+0002fe00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002fe10: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002fe20: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
+0002fe30: 2020 2061 7373 6572 7420 746d 705f 6275     assert tmp_bu
+0002fe40: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002fe50: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0002fe60: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
+0002fe70: 662d 3827 290a 0a20 2020 2040 7079 7465  f-8')..    @pyte
+0002fe80: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002fe90: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002fea0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002feb0: 7a65 280a 2020 2020 2020 2020 2774 6d70  ze(.        'tmp
+0002fec0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002fed0: 6f62 6a2c 2073 746f 7265 5f74 7970 6527  obj, store_type'
+0002fee0: 2c0a 2020 2020 2020 2020 5b28 2773 333a  ,.        [('s3:
+0002fef0: 2f2f 7463 6761 2d32 2d6f 7065 6e27 2c20  //tcga-2-open', 
+0002ff00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002ff10: 6554 7970 652e 5333 292c 0a20 2020 2020  eType.S3),.     
+0002ff20: 2020 2020 2827 7333 3a2f 2f64 6967 6974      ('s3://digit
+0002ff30: 616c 636f 7270 6f72 6127 2c20 7374 6f72  alcorpora', stor
+0002ff40: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002ff50: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+0002ff60: 2827 6773 3a2f 2f67 6370 2d70 7562 6c69  ('gs://gcp-publi
+0002ff70: 632d 6461 7461 2d73 656e 7469 6e65 6c2d  c-data-sentinel-
+0002ff80: 3227 2c20 7374 6f72 6167 655f 6c69 622e  2', storage_lib.
+0002ff90: 5374 6f72 6554 7970 652e 4743 5329 5d2c  StoreType.GCS)],
+0002ffa0: 0a20 2020 2020 2020 2069 6e64 6972 6563  .        indirec
+0002ffb0: 743d 5b27 746d 705f 7075 626c 6963 5f73  t=['tmp_public_s
+0002ffc0: 746f 7261 6765 5f6f 626a 275d 290a 2020  torage_obj']).  
+0002ffd0: 2020 6465 6620 7465 7374 5f70 7562 6c69    def test_publi
+0002ffe0: 635f 6275 636b 6574 2873 656c 662c 2074  c_bucket(self, t
+0002fff0: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+00030000: 655f 6f62 6a2c 2073 746f 7265 5f74 7970  e_obj, store_typ
+00030010: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+00030020: 6561 7465 7320 6120 6e65 7720 6275 636b  eates a new buck
+00030030: 6574 2077 6974 6820 6120 7075 626c 6963  et with a public
+00030040: 2073 6f75 7263 6520 616e 6420 7665 7269   source and veri
+00030050: 6669 6573 2074 6861 7420 6974 2069 7320  fies that it is 
+00030060: 6e6f 740a 2020 2020 2020 2020 2320 6164  not.        # ad
+00030070: 6465 6420 746f 2067 6c6f 6261 6c5f 7573  ded to global_us
+00030080: 6572 5f73 7461 7465 2e0a 2020 2020 2020  er_state..      
+00030090: 2020 746d 705f 7075 626c 6963 5f73 746f    tmp_public_sto
+000300a0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+000300b0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+000300c0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+000300d0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+000300e0: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+000300f0: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+00030100: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
+00030110: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+00030120: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00030130: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+00030140: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+00030150: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+00030160: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
+00030170: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+00030180: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030190: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+000301a0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+000301b0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+000301c0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+000301d0: 276e 6f6e 6578 6973 745f 6275 636b 6574  'nonexist_bucket
+000301e0: 5f75 726c 272c 205b 0a20 2020 2020 2020  _url', [.       
+000301f0: 2027 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e   's3://{random_n
+00030200: 616d 657d 272c 2027 6773 3a2f 2f7b 7261  ame}', 'gs://{ra
+00030210: 6e64 6f6d 5f6e 616d 657d 272c 0a20 2020  ndom_name}',.   
+00030220: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00030230: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
+00030240: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
+00030250: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00030260: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+00030270: 2070 7974 6573 742e 7061 7261 6d28 2772   pytest.param('r
+00030280: 323a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  2://{random_name
+00030290: 7d27 2c20 6d61 726b 733d 7079 7465 7374  }', marks=pytest
+000302a0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+000302b0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+000302c0: 2074 6573 745f 6e6f 6e65 7869 7374 656e   test_nonexisten
+000302d0: 745f 6275 636b 6574 2873 656c 662c 206e  t_bucket(self, n
+000302e0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+000302f0: 726c 293a 0a20 2020 2020 2020 2023 2041  rl):.        # A
+00030300: 7474 656d 7074 7320 746f 2063 7265 6174  ttempts to creat
+00030310: 6520 6665 7463 6820 6120 7374 726f 6167  e fetch a stroag
+00030320: 6520 7769 7468 2061 206e 6f6e 2d65 7869  e with a non-exi
+00030330: 7374 656e 7420 736f 7572 6365 2e0a 2020  stent source..  
+00030340: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
+00030350: 2061 2072 616e 646f 6d20 6275 636b 6574   a random bucket
+00030360: 206e 616d 6520 616e 6420 7665 7269 6679   name and verify
+00030370: 2069 7420 646f 6573 6e27 7420 6578 6973   it doesn't exis
+00030380: 743a 0a20 2020 2020 2020 2072 6574 7279  t:.        retry
+00030390: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
+000303a0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+000303b0: 2020 2020 2020 2020 2020 206e 6f6e 6578             nonex
+000303c0: 6973 745f 6275 636b 6574 5f6e 616d 6520  ist_bucket_name 
+000303d0: 3d20 7374 7228 7575 6964 2e75 7569 6434  = str(uuid.uuid4
+000303e0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+000303f0: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
+00030400: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
+00030410: 6828 2773 3327 293a 0a20 2020 2020 2020  h('s3'):.       
+00030420: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+00030430: 203d 2066 2761 7773 2073 3361 7069 2068   = f'aws s3api h
+00030440: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
+00030450: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
+00030460: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+00030470: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+00030480: 6374 6564 5f6f 7574 7075 7420 3d20 2734  cted_output = '4
+00030490: 3034 270a 2020 2020 2020 2020 2020 2020  04'.            
+000304a0: 656c 6966 206e 6f6e 6578 6973 745f 6275  elif nonexist_bu
+000304b0: 636b 6574 5f75 726c 2e73 7461 7274 7377  cket_url.startsw
+000304c0: 6974 6828 2767 7327 293a 0a20 2020 2020  ith('gs'):.     
+000304d0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+000304e0: 6e64 203d 2066 2767 7375 7469 6c20 6c73  nd = f'gsutil ls
+000304f0: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
+00030500: 745f 7572 6c2e 666f 726d 6174 2872 616e  t_url.format(ran
+00030510: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+00030520: 745f 6275 636b 6574 5f6e 616d 6529 7d27  t_bucket_name)}'
+00030530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030540: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+00030550: 203d 2027 4275 636b 6574 4e6f 7446 6f75   = 'BucketNotFou
+00030560: 6e64 4578 6365 7074 696f 6e27 0a20 2020  ndException'.   
+00030570: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+00030580: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+00030590: 6c2e 7374 6172 7473 7769 7468 2827 7232  l.startswith('r2
+000305a0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000305b0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+000305c0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+000305d0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+000305e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305f0: 636f 6d6d 616e 6420 3d20 6627 4157 535f  command = f'AWS_
+00030600: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+00030610: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+00030620: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+00030630: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
+00030640: 7069 2068 6561 642d 6275 636b 6574 202d  pi head-bucket -
+00030650: 2d62 7563 6b65 7420 7b6e 6f6e 6578 6973  -bucket {nonexis
+00030660: 745f 6275 636b 6574 5f6e 616d 657d 202d  t_bucket_name} -
+00030670: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+00030680: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+00030690: 6c65 3d72 3227 0a20 2020 2020 2020 2020  le=r2'.         
+000306a0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+000306b0: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
+000306c0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000306d0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+000306e0: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
+000306f0: 636f 7327 293a 0a20 2020 2020 2020 2020  cos'):.         
+00030700: 2020 2020 2020 2023 2055 7369 6e67 2041         # Using A
+00030710: 5049 2063 616c 6c73 2c20 7369 6e63 6520  PI calls, since 
+00030720: 7573 696e 6720 7263 6c6f 6e65 2072 6571  using rclone req
+00030730: 7569 7265 7320 6120 7072 6f66 696c 6527  uires a profile'
+00030740: 7320 6e61 6d65 0a20 2020 2020 2020 2020  s name.         
+00030750: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
 00030760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030770: 636c 6965 6e74 203d 2069 626d 2e67 6574  client = ibm.get
-00030780: 5f63 6f73 5f63 6c69 656e 7428 2775 732d  _cos_client('us-
-00030790: 6561 7374 2729 0a20 2020 2020 2020 2020  east').         
-000307a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-000307b0: 742e 6865 6164 5f62 7563 6b65 7428 4275  t.head_bucket(Bu
-000307c0: 636b 6574 3d62 7563 6b65 745f 6e61 6d65  cket=bucket_name
-000307d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000307e0: 2020 6578 6365 7074 2069 626d 2e69 626d    except ibm.ibm
-000307f0: 5f62 6f74 6f63 6f72 652e 6578 6365 7074  _botocore.except
-00030800: 696f 6e73 2e43 6c69 656e 7445 7272 6f72  ions.ClientError
-00030810: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-00030820: 2020 2020 2020 2020 2020 2069 6620 652e             if e.
-00030830: 7265 7370 6f6e 7365 5b27 4572 726f 7227  response['Error'
-00030840: 5d5b 2743 6f64 6527 5d20 3d3d 2027 3430  ]['Code'] == '40
-00030850: 3427 3a0a 2020 2020 2020 2020 2020 2020  4':.            
-00030860: 2020 2020 2020 2020 2020 2020 2320 7375              # su
-00030870: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
-00030880: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00030890: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-000308a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000308b0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-000308c0: 7565 4572 726f 7228 2755 6e73 7570 706f  ueError('Unsuppo
-000308d0: 7274 6564 2062 7563 6b65 7420 7479 7065  rted bucket type
-000308e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000308f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030900: 2020 2020 6627 7b6e 6f6e 6578 6973 745f      f'{nonexist_
-00030910: 6275 636b 6574 5f75 726c 7d27 290a 0a20  bucket_url}').. 
-00030920: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
-00030930: 636b 2069 6620 6275 636b 6574 2065 7869  ck if bucket exi
-00030940: 7374 7320 7573 696e 6720 7468 6520 636c  sts using the cl
-00030950: 693a 0a20 2020 2020 2020 2020 2020 2074  i:.            t
-00030960: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00030970: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
-00030980: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00030990: 7428 636f 6d6d 616e 642c 0a20 2020 2020  t(command,.     
+00030770: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+00030780: 3d20 636f 6d6d 616e 6420 3d20 2265 6368  = command = "ech
+00030790: 6f22 2020 2320 6176 6f69 6420 756e 7265  o"  # avoid unre
+000307a0: 6c61 7465 6420 6578 6365 7074 696f 6e20  lated exception 
+000307b0: 696e 2063 6173 6520 6f66 2066 6169 6c75  in case of failu
+000307c0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+000307d0: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
+000307e0: 616d 6520 3d20 7572 6c6c 6962 2e70 6172  ame = urllib.par
+000307f0: 7365 2e75 726c 7370 6c69 7428 0a20 2020  se.urlsplit(.   
+00030800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030810: 2020 2020 206e 6f6e 6578 6973 745f 6275       nonexist_bu
+00030820: 636b 6574 5f75 726c 2e66 6f72 6d61 7428  cket_url.format(
+00030830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030840: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00030850: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+00030860: 745f 6275 636b 6574 5f6e 616d 6529 292e  t_bucket_name)).
+00030870: 7061 7468 2e73 7472 6970 2827 2f27 290a  path.strip('/').
+00030880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030890: 2020 2020 636c 6965 6e74 203d 2069 626d      client = ibm
+000308a0: 2e67 6574 5f63 6f73 5f63 6c69 656e 7428  .get_cos_client(
+000308b0: 2775 732d 6561 7374 2729 0a20 2020 2020  'us-east').     
+000308c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000308d0: 6c69 656e 742e 6865 6164 5f62 7563 6b65  lient.head_bucke
+000308e0: 7428 4275 636b 6574 3d62 7563 6b65 745f  t(Bucket=bucket_
+000308f0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00030900: 2020 2020 2020 6578 6365 7074 2069 626d        except ibm
+00030910: 2e69 626d 5f62 6f74 6f63 6f72 652e 6578  .ibm_botocore.ex
+00030920: 6365 7074 696f 6e73 2e43 6c69 656e 7445  ceptions.ClientE
+00030930: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00030940: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00030950: 6620 652e 7265 7370 6f6e 7365 5b27 4572  f e.response['Er
+00030960: 726f 7227 5d5b 2743 6f64 6527 5d20 3d3d  ror']['Code'] ==
+00030970: 2027 3430 3427 3a0a 2020 2020 2020 2020   '404':.        
+00030980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030990: 2320 7375 6363 6573 730a 2020 2020 2020  # success.      
 000309a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000309c0: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
-000309d0: 7375 6270 726f 6365 7373 2e53 5444 4f55  subprocess.STDOU
-000309e0: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
-000309f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a10: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-00030a20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00030a30: 7375 6270 726f 6365 7373 2e43 616c 6c65  subprocess.Calle
-00030a40: 6450 726f 6365 7373 4572 726f 7220 6173  dProcessError as
-00030a50: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00030a60: 2020 2020 6f75 7420 3d20 652e 6f75 7470      out = e.outp
-00030a70: 7574 0a20 2020 2020 2020 2020 2020 206f  ut.            o
-00030a80: 7574 203d 206f 7574 2e64 6563 6f64 6528  ut = out.decode(
-00030a90: 2775 7466 2d38 2729 0a20 2020 2020 2020  'utf-8').       
-00030aa0: 2020 2020 2069 6620 6578 7065 6374 6564       if expected
-00030ab0: 5f6f 7574 7075 7420 696e 206f 7574 3a0a  _output in out:.
+000309b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000309c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000309d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000309e0: 2056 616c 7565 4572 726f 7228 2755 6e73   ValueError('Uns
+000309f0: 7570 706f 7274 6564 2062 7563 6b65 7420  upported bucket 
+00030a00: 7479 7065 2027 0a20 2020 2020 2020 2020  type '.         
+00030a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a20: 2020 2020 2020 2020 6627 7b6e 6f6e 6578          f'{nonex
+00030a30: 6973 745f 6275 636b 6574 5f75 726c 7d27  ist_bucket_url}'
+00030a40: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00030a50: 2043 6865 636b 2069 6620 6275 636b 6574   Check if bucket
+00030a60: 2065 7869 7374 7320 7573 696e 6720 7468   exists using th
+00030a70: 6520 636c 693a 0a20 2020 2020 2020 2020  e cli:.         
+00030a80: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00030a90: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00030aa0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00030ab0: 7574 7075 7428 636f 6d6d 616e 642c 0a20  utput(command,. 
 00030ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ad0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-00030ae0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00030af0: 2020 2020 2020 2020 7265 7472 795f 636f          retry_co
-00030b00: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00030b10: 2020 2020 2020 2020 2069 6620 7265 7472           if retr
-00030b20: 795f 636f 756e 7420 3e20 333a 0a20 2020  y_count > 3:.   
-00030b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b40: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00030b50: 726f 7228 2755 6e61 626c 6520 746f 2066  ror('Unable to f
-00030b60: 696e 6420 6120 6e6f 6e65 7869 7374 656e  ind a nonexisten
-00030b70: 7420 6275 636b 6574 2027 0a20 2020 2020  t bucket '.     
-00030b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ba0: 2020 2774 6f20 7573 652e 2054 6869 7320    'to use. This 
-00030bb0: 6973 2068 6967 6c79 2075 6e6c 696b 656c  is higly unlikel
-00030bc0: 7920 2d20 270a 2020 2020 2020 2020 2020  y - '.          
-00030bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030be0: 2020 2020 2020 2020 2020 2020 2027 6368               'ch
-00030bf0: 6563 6b20 6966 2074 6865 2074 6573 7473  eck if the tests
-00030c00: 2061 7265 2063 6f72 7265 6374 2e27 290a   are correct.').
-00030c10: 0a20 2020 2020 2020 2077 6974 6820 7079  .        with py
-00030c20: 7465 7374 2e72 6169 7365 7328 0a20 2020  test.raises(.   
-00030c30: 2020 2020 2020 2020 2020 2020 2073 6b79               sky
-00030c40: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
-00030c50: 6167 6542 7563 6b65 7447 6574 4572 726f  ageBucketGetErro
-00030c60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00030c70: 2020 206d 6174 6368 3d27 4174 7465 6d70     match='Attemp
-00030c80: 7465 6420 746f 2075 7365 2061 206e 6f6e  ted to use a non
-00030c90: 2d65 7869 7374 656e 7420 6275 636b 6574  -existent bucket
-00030ca0: 2061 7320 6120 736f 7572 6365 2729 3a0a   as a source'):.
-00030cb0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00030cc0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-00030cd0: 655f 6c69 622e 5374 6f72 6167 6528 736f  e_lib.Storage(so
-00030ce0: 7572 6365 3d6e 6f6e 6578 6973 745f 6275  urce=nonexist_bu
-00030cf0: 636b 6574 5f75 726c 2e66 6f72 6d61 7428  cket_url.format(
-00030d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030d10: 2072 616e 646f 6d5f 6e61 6d65 3d6e 6f6e   random_name=non
-00030d20: 6578 6973 745f 6275 636b 6574 5f6e 616d  exist_bucket_nam
-00030d30: 6529 290a 0a20 2020 2040 7079 7465 7374  e))..    @pytest
-00030d40: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-00030d50: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-00030d60: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-00030d70: 2827 7072 6976 6174 655f 6275 636b 6574  ('private_bucket
-00030d80: 272c 205b 0a20 2020 2020 2020 2066 2773  ', [.        f's
-00030d90: 333a 2f2f 696d 6167 656e 6574 272c 2066  3://imagenet', f
-00030da0: 2767 733a 2f2f 696d 6167 656e 6574 272c  'gs://imagenet',
-00030db0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
-00030dc0: 7061 7261 6d28 2763 6f73 3a2f 2f75 732d  param('cos://us-
-00030dd0: 6561 7374 2f62 7563 6b65 7431 272c 206d  east/bucket1', m
-00030de0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00030df0: 2e69 626d 290a 2020 2020 5d29 0a20 2020  .ibm).    ]).   
-00030e00: 2064 6566 2074 6573 745f 7072 6976 6174   def test_privat
-00030e10: 655f 6275 636b 6574 2873 656c 662c 2070  e_bucket(self, p
-00030e20: 7269 7661 7465 5f62 7563 6b65 7429 3a0a  rivate_bucket):.
-00030e30: 2020 2020 2020 2020 2320 4174 7465 6d70          # Attemp
-00030e40: 7473 2074 6f20 6163 6365 7373 2070 7269  ts to access pri
-00030e50: 7661 7465 2062 7563 6b65 7473 206e 6f74  vate buckets not
-00030e60: 2062 656c 6f6e 6769 6e67 2074 6f20 7468   belonging to th
-00030e70: 6520 7573 6572 2e0a 2020 2020 2020 2020  e user..        
-00030e80: 2320 5468 6573 6520 6275 636b 6574 7320  # These buckets 
-00030e90: 6172 6520 6b6e 6f77 6e20 746f 2062 6520  are known to be 
-00030ea0: 7072 6976 6174 652c 2062 7574 206d 6179  private, but may
-00030eb0: 206e 6565 6420 746f 2062 6520 7570 6461   need to be upda
-00030ec0: 7465 6420 6966 0a20 2020 2020 2020 2023  ted if.        #
-00030ed0: 2074 6865 7920 6172 6520 7265 6d6f 7665   they are remove
-00030ee0: 6420 6279 2074 6865 6972 206f 776e 6572  d by their owner
-00030ef0: 732e 0a20 2020 2020 2020 2070 7269 7661  s..        priva
-00030f00: 7465 5f62 7563 6b65 745f 6e61 6d65 203d  te_bucket_name =
-00030f10: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
-00030f20: 6c73 706c 6974 2870 7269 7661 7465 5f62  lsplit(private_b
-00030f30: 7563 6b65 7429 2e6e 6574 6c6f 6320 6966  ucket).netloc if
-00030f40: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-00030f50: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
-00030f60: 6c73 706c 6974 2870 7269 7661 7465 5f62  lsplit(private_b
-00030f70: 7563 6b65 7429 2e73 6368 656d 6520 213d  ucket).scheme !=
-00030f80: 2027 636f 7327 2065 6c73 6520 5c0a 2020   'cos' else \.  
-00030f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fa0: 7572 6c6c 6962 2e70 6172 7365 2e75 726c  urllib.parse.url
-00030fb0: 7370 6c69 7428 7072 6976 6174 655f 6275  split(private_bu
-00030fc0: 636b 6574 292e 7061 7468 2e73 7472 6970  cket).path.strip
-00030fd0: 2827 2f27 290a 2020 2020 2020 2020 7769  ('/').        wi
-00030fe0: 7468 2070 7974 6573 742e 7261 6973 6573  th pytest.raises
-00030ff0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00031000: 2020 736b 792e 6578 6365 7074 696f 6e73    sky.exceptions
-00031010: 2e53 746f 7261 6765 4275 636b 6574 4765  .StorageBucketGe
-00031020: 7445 7272 6f72 2c0a 2020 2020 2020 2020  tError,.        
-00031030: 2020 2020 2020 2020 6d61 7463 683d 7374          match=st
-00031040: 6f72 6167 655f 6c69 622e 5f42 5543 4b45  orage_lib._BUCKE
-00031050: 545f 4641 494c 5f54 4f5f 434f 4e4e 4543  T_FAIL_TO_CONNEC
-00031060: 545f 4d45 5353 4147 452e 666f 726d 6174  T_MESSAGE.format
-00031070: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00031080: 2020 2020 2020 6e61 6d65 3d70 7269 7661        name=priva
-00031090: 7465 5f62 7563 6b65 745f 6e61 6d65 2929  te_bucket_name))
-000310a0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-000310b0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-000310c0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-000310d0: 736f 7572 6365 3d70 7269 7661 7465 5f62  source=private_b
-000310e0: 7563 6b65 7429 0a0a 2020 2020 4070 7974  ucket)..    @pyt
-000310f0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00031100: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-00031110: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00031120: 697a 6528 2765 7874 5f62 7563 6b65 745f  ize('ext_bucket_
-00031130: 6669 7874 7572 652c 2073 746f 7265 5f74  fixture, store_t
-00031140: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
-00031150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031160: 2020 205b 2827 746d 705f 6177 7363 6c69     [('tmp_awscli
-00031170: 5f62 7563 6b65 7427 2c20 7374 6f72 6167  _bucket', storag
-00031180: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00031190: 5333 292c 0a20 2020 2020 2020 2020 2020  S3),.           
-000311a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311b0: 2020 2028 2774 6d70 5f67 7375 7469 6c5f     ('tmp_gsutil_
-000311c0: 6275 636b 6574 272c 2073 746f 7261 6765  bucket', storage
-000311d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-000311e0: 4353 292c 0a20 2020 2020 2020 2020 2020  CS),.           
-000311f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031200: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-00031210: 2774 6d70 5f69 626d 5f63 6f73 5f62 7563  'tmp_ibm_cos_buc
-00031220: 6b65 7427 2c0a 2020 2020 2020 2020 2020  ket',.          
-00031230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031250: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00031260: 7265 5479 7065 2e49 424d 2c0a 2020 2020  reType.IBM,.    
+00030ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ae0: 2020 2020 2020 2020 2020 2020 2073 7464               std
+00030af0: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
+00030b00: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
+00030b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b30: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00030b40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00030b50: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+00030b60: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+00030b70: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00030b80: 2020 2020 2020 2020 6f75 7420 3d20 652e          out = e.
+00030b90: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00030ba0: 2020 206f 7574 203d 206f 7574 2e64 6563     out = out.dec
+00030bb0: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
+00030bc0: 2020 2020 2020 2020 2069 6620 6578 7065           if expe
+00030bd0: 6374 6564 5f6f 7574 7075 7420 696e 206f  cted_output in o
+00030be0: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00030bf0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00030c00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00030c10: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+00030c20: 795f 636f 756e 7420 2b3d 2031 0a20 2020  y_count += 1.   
+00030c30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00030c40: 7265 7472 795f 636f 756e 7420 3e20 333a  retry_count > 3:
+00030c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c60: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00030c70: 6d65 4572 726f 7228 2755 6e61 626c 6520  meError('Unable 
+00030c80: 746f 2066 696e 6420 6120 6e6f 6e65 7869  to find a nonexi
+00030c90: 7374 656e 7420 6275 636b 6574 2027 0a20  stent bucket '. 
+00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cc0: 2020 2020 2020 2774 6f20 7573 652e 2054        'to use. T
+00030cd0: 6869 7320 6973 2068 6967 6c79 2075 6e6c  his is higly unl
+00030ce0: 696b 656c 7920 2d20 270a 2020 2020 2020  ikely - '.      
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 2027 6368 6563 6b20 6966 2074 6865 2074   'check if the t
+00030d20: 6573 7473 2061 7265 2063 6f72 7265 6374  ests are correct
+00030d30: 2e27 290a 0a20 2020 2020 2020 2077 6974  .')..        wit
+00030d40: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+00030d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030d60: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
+00030d70: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
+00030d80: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+00030d90: 2020 2020 2020 206d 6174 6368 3d27 4174         match='At
+00030da0: 7465 6d70 7465 6420 746f 2075 7365 2061  tempted to use a
+00030db0: 206e 6f6e 2d65 7869 7374 656e 7420 6275   non-existent bu
+00030dc0: 636b 6574 2061 7320 6120 736f 7572 6365  cket as a source
+00030dd0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00030de0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+00030df0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00030e00: 6528 736f 7572 6365 3d6e 6f6e 6578 6973  e(source=nonexis
+00030e10: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
+00030e20: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00030e30: 2020 2020 2072 616e 646f 6d5f 6e61 6d65       random_name
+00030e40: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
+00030e50: 5f6e 616d 6529 290a 0a20 2020 2040 7079  _name))..    @py
+00030e60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00030e70: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+00030e80: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00030e90: 7269 7a65 2827 7072 6976 6174 655f 6275  rize('private_bu
+00030ea0: 636b 6574 272c 205b 0a20 2020 2020 2020  cket', [.       
+00030eb0: 2066 2773 333a 2f2f 696d 6167 656e 6574   f's3://imagenet
+00030ec0: 272c 2066 2767 733a 2f2f 696d 6167 656e  ', f'gs://imagen
+00030ed0: 6574 272c 0a20 2020 2020 2020 2070 7974  et',.        pyt
+00030ee0: 6573 742e 7061 7261 6d28 2763 6f73 3a2f  est.param('cos:/
+00030ef0: 2f75 732d 6561 7374 2f62 7563 6b65 7431  /us-east/bucket1
+00030f00: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
+00030f10: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+00030f20: 0a20 2020 2064 6566 2074 6573 745f 7072  .    def test_pr
+00030f30: 6976 6174 655f 6275 636b 6574 2873 656c  ivate_bucket(sel
+00030f40: 662c 2070 7269 7661 7465 5f62 7563 6b65  f, private_bucke
+00030f50: 7429 3a0a 2020 2020 2020 2020 2320 4174  t):.        # At
+00030f60: 7465 6d70 7473 2074 6f20 6163 6365 7373  tempts to access
+00030f70: 2070 7269 7661 7465 2062 7563 6b65 7473   private buckets
+00030f80: 206e 6f74 2062 656c 6f6e 6769 6e67 2074   not belonging t
+00030f90: 6f20 7468 6520 7573 6572 2e0a 2020 2020  o the user..    
+00030fa0: 2020 2020 2320 5468 6573 6520 6275 636b      # These buck
+00030fb0: 6574 7320 6172 6520 6b6e 6f77 6e20 746f  ets are known to
+00030fc0: 2062 6520 7072 6976 6174 652c 2062 7574   be private, but
+00030fd0: 206d 6179 206e 6565 6420 746f 2062 6520   may need to be 
+00030fe0: 7570 6461 7465 6420 6966 0a20 2020 2020  updated if.     
+00030ff0: 2020 2023 2074 6865 7920 6172 6520 7265     # they are re
+00031000: 6d6f 7665 6420 6279 2074 6865 6972 206f  moved by their o
+00031010: 776e 6572 732e 0a20 2020 2020 2020 2070  wners..        p
+00031020: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+00031030: 6d65 203d 2075 726c 6c69 622e 7061 7273  me = urllib.pars
+00031040: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+00031050: 7465 5f62 7563 6b65 7429 2e6e 6574 6c6f  te_bucket).netlo
+00031060: 6320 6966 205c 0a20 2020 2020 2020 2020  c if \.         
+00031070: 2020 2020 2075 726c 6c69 622e 7061 7273       urllib.pars
+00031080: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+00031090: 7465 5f62 7563 6b65 7429 2e73 6368 656d  te_bucket).schem
+000310a0: 6520 213d 2027 636f 7327 2065 6c73 6520  e != 'cos' else 
+000310b0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000310c0: 2020 2020 7572 6c6c 6962 2e70 6172 7365      urllib.parse
+000310d0: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
+000310e0: 655f 6275 636b 6574 292e 7061 7468 2e73  e_bucket).path.s
+000310f0: 7472 6970 2827 2f27 290a 2020 2020 2020  trip('/').      
+00031100: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+00031110: 6973 6573 280a 2020 2020 2020 2020 2020  ises(.          
+00031120: 2020 2020 2020 736b 792e 6578 6365 7074        sky.except
+00031130: 696f 6e73 2e53 746f 7261 6765 4275 636b  ions.StorageBuck
+00031140: 6574 4765 7445 7272 6f72 2c0a 2020 2020  etGetError,.    
+00031150: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+00031160: 683d 7374 6f72 6167 655f 6c69 622e 5f42  h=storage_lib._B
+00031170: 5543 4b45 545f 4641 494c 5f54 4f5f 434f  UCKET_FAIL_TO_CO
+00031180: 4e4e 4543 545f 4d45 5353 4147 452e 666f  NNECT_MESSAGE.fo
+00031190: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+000311a0: 2020 2020 2020 2020 2020 6e61 6d65 3d70            name=p
+000311b0: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+000311c0: 6d65 2929 3a0a 2020 2020 2020 2020 2020  me)):.          
+000311d0: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+000311e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+000311f0: 6167 6528 736f 7572 6365 3d70 7269 7661  age(source=priva
+00031200: 7465 5f62 7563 6b65 7429 0a0a 2020 2020  te_bucket)..    
+00031210: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00031220: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00031230: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00031240: 6d65 7472 697a 6528 2765 7874 5f62 7563  metrize('ext_buc
+00031250: 6b65 745f 6669 7874 7572 652c 2073 746f  ket_fixture, sto
+00031260: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
 00031270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031290: 2020 2020 2020 206d 6172 6b73 3d70 7974         marks=pyt
-000312a0: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
-000312b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312c0: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
-000312d0: 6573 742e 7061 7261 6d28 2774 6d70 5f61  est.param('tmp_a
-000312e0: 7773 636c 695f 6275 636b 6574 5f72 3227  wscli_bucket_r2'
-000312f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031310: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00031320: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00031330: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
-00031340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031280: 2020 2020 2020 205b 2827 746d 705f 6177         [('tmp_aw
+00031290: 7363 6c69 5f62 7563 6b65 7427 2c20 7374  scli_bucket', st
+000312a0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000312b0: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312d0: 2020 2020 2020 2028 2774 6d70 5f67 7375         ('tmp_gsu
+000312e0: 7469 6c5f 6275 636b 6574 272c 2073 746f  til_bucket', sto
+000312f0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00031300: 7065 2e47 4353 292c 0a20 2020 2020 2020  pe.GCS),.       
+00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031320: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+00031330: 7261 6d28 2774 6d70 5f69 626d 5f63 6f73  ram('tmp_ibm_cos
+00031340: 5f62 7563 6b65 7427 2c0a 2020 2020 2020  _bucket',.      
 00031350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031360: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-00031370: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
-00031380: 290a 2020 2020 6465 6620 7465 7374 5f75  ).    def test_u
-00031390: 706c 6f61 645f 746f 5f65 7869 7374 696e  pload_to_existin
-000313a0: 675f 6275 636b 6574 2873 656c 662c 2065  g_bucket(self, e
-000313b0: 7874 5f62 7563 6b65 745f 6669 7874 7572  xt_bucket_fixtur
-000313c0: 652c 2072 6571 7565 7374 2c0a 2020 2020  e, request,.    
-000313d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031370: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+00031380: 2e53 746f 7265 5479 7065 2e49 424d 2c0a  .StoreType.IBM,.
+00031390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313b0: 2020 2020 2020 2020 2020 206d 6172 6b73             marks
+000313c0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+000313d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
 000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313f0: 2020 2074 6d70 5f73 6f75 7263 652c 2073     tmp_source, s
-00031400: 746f 7265 5f74 7970 6529 3a0a 2020 2020  tore_type):.    
-00031410: 2020 2020 2320 5472 6965 7320 7570 6c6f      # Tries uplo
-00031420: 6164 696e 6720 6578 6973 7469 6e67 2066  ading existing f
-00031430: 696c 6573 2074 6f20 6e65 776c 7920 6372  iles to newly cr
-00031440: 6561 7465 6420 6275 636b 6574 2028 6f75  eated bucket (ou
-00031450: 7473 6964 6520 6f66 0a20 2020 2020 2020  tside of.       
-00031460: 2023 2073 6b79 2920 616e 6420 7665 7269   # sky) and veri
-00031470: 6669 6573 2074 6861 7420 6669 6c65 7320  fies that files 
-00031480: 6172 6520 7772 6974 7465 6e2e 0a20 2020  are written..   
-00031490: 2020 2020 2062 7563 6b65 745f 6e61 6d65       bucket_name
-000314a0: 2c20 5f20 3d20 7265 7175 6573 742e 6765  , _ = request.ge
-000314b0: 7466 6978 7475 7265 7661 6c75 6528 6578  tfixturevalue(ex
-000314c0: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
-000314d0: 290a 2020 2020 2020 2020 7374 6f72 6167  ).        storag
-000314e0: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-000314f0: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
-00031500: 3d62 7563 6b65 745f 6e61 6d65 2c20 736f  =bucket_name, so
-00031510: 7572 6365 3d74 6d70 5f73 6f75 7263 6529  urce=tmp_source)
-00031520: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-00031530: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-00031540: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-00031550: 2020 2020 2320 4368 6563 6b20 6966 2074      # Check if t
-00031560: 6d70 5f73 6f75 7263 652f 746d 702d 6669  mp_source/tmp-fi
-00031570: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00031580: 2062 7563 6b65 7420 7573 696e 6720 6177   bucket using aw
-00031590: 7320 636c 690a 2020 2020 2020 2020 6f75  s cli.        ou
-000315a0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-000315b0: 6865 636b 5f6f 7574 7075 7428 7365 6c66  heck_output(self
-000315c0: 2e63 6c69 5f6c 735f 636d 6428 7374 6f72  .cli_ls_cmd(stor
-000315d0: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
-000315e0: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-000315f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031600: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-00031610: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-00031620: 6173 7365 7274 2027 746d 702d 6669 6c65  assert 'tmp-file
-00031630: 2720 696e 206f 7574 2e64 6563 6f64 6528  ' in out.decode(
-00031640: 2775 7466 2d38 2729 2c20 5c0a 2020 2020  'utf-8'), \.    
-00031650: 2020 2020 2020 2020 2746 696c 6520 6e6f          'File no
-00031660: 7420 666f 756e 6420 696e 2062 7563 6b65  t found in bucke
-00031670: 7420 2d20 6f75 7470 7574 2077 6173 203a  t - output was :
-00031680: 207b 7d27 2e66 6f72 6d61 7428 6f75 742e   {}'.format(out.
-00031690: 6465 636f 6465 0a20 2020 2020 2020 2020  decode.         
-000316a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316d0: 2020 2020 2020 2028 2775 7466 2d38 2729         ('utf-8')
-000316e0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
-000316f0: 636b 2073 796d 6c69 6e6b 7320 2d20 7379  ck symlinks - sy
-00031700: 6d6c 696e 6b73 2064 6f6e 2774 2067 6574  mlinks don't get
-00031710: 2063 6f70 6965 6420 6279 2073 6b79 2073   copied by sky s
-00031720: 746f 7261 6765 0a20 2020 2020 2020 2061  torage.        a
-00031730: 7373 6572 7420 2870 6174 686c 6962 2e50  ssert (pathlib.P
-00031740: 6174 6828 746d 705f 736f 7572 6365 2920  ath(tmp_source) 
-00031750: 2f20 2763 6972 636c 652d 6c69 6e6b 2729  / 'circle-link')
-00031760: 2e69 735f 7379 6d6c 696e 6b28 292c 2028  .is_symlink(), (
-00031770: 0a20 2020 2020 2020 2020 2020 2027 6369  .            'ci
-00031780: 7263 6c65 2d6c 696e 6b20 7761 7320 6e6f  rcle-link was no
-00031790: 7420 666f 756e 6420 696e 2074 6865 2075  t found in the u
-000317a0: 706c 6f61 6420 736f 7572 6365 202d 2027  pload source - '
-000317b0: 0a20 2020 2020 2020 2020 2020 2027 6172  .            'ar
-000317c0: 6520 7468 6520 7465 7374 2066 6978 7475  e the test fixtu
-000317d0: 7265 7320 636f 7272 6563 743f 2729 0a20  res correct?'). 
-000317e0: 2020 2020 2020 2061 7373 6572 7420 2763         assert 'c
-000317f0: 6972 636c 652d 6c69 6e6b 2720 6e6f 7420  ircle-link' not 
-00031800: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-00031810: 7466 2d38 2729 2c20 280a 2020 2020 2020  tf-8'), (.      
-00031820: 2020 2020 2020 2753 796d 6c69 6e6b 2066        'Symlink f
-00031830: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
-00031840: 206c 7320 6f75 7470 7574 2077 6173 203a   ls output was :
-00031850: 207b 7d27 2e66 6f72 6d61 7428 0a20 2020   {}'.format(.   
-00031860: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00031870: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00031880: 2929 0a0a 2020 2020 2020 2020 2320 5275  ))..        # Ru
-00031890: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-000318a0: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
-000318b0: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-000318c0: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
-000318d0: 2e0a 2020 2020 2020 2020 2320 4974 2073  ..        # It s
-000318e0: 686f 756c 6420 6e6f 7420 6578 6973 7420  hould not exist 
-000318f0: 6265 6361 7573 6520 7468 6520 6275 636b  because the buck
-00031900: 6574 2077 6173 2063 7265 6174 6564 2065  et was created e
-00031910: 7874 6572 6e61 6c6c 792e 0a20 2020 2020  xternally..     
-00031920: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-00031930: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00031940: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-00031950: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-00031960: 2020 2061 7373 6572 7420 7374 6f72 6167     assert storag
-00031970: 655f 6f62 6a2e 6e61 6d65 206e 6f74 2069  e_obj.name not i
-00031980: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
-00031990: 662d 3827 290a 0a20 2020 2040 7079 7465  f-8')..    @pyte
-000319a0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-000319b0: 7374 6163 6b0a 2020 2020 6465 6620 7465  stack.    def te
-000319c0: 7374 5f63 6f70 795f 6d6f 756e 745f 6578  st_copy_mount_ex
-000319d0: 6973 7469 6e67 5f73 746f 7261 6765 2873  isting_storage(s
-000319e0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
-000319f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a00: 2020 2020 2020 2020 2020 2020 2020 746d                tm
-00031a10: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
-00031a20: 696e 675f 7374 6f72 6167 655f 6f62 6a29  ing_storage_obj)
-00031a30: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-00031a40: 7465 7320 6120 6275 636b 6574 2077 6974  tes a bucket wit
-00031a50: 6820 6e6f 2073 6f75 7263 6520 696e 204d  h no source in M
-00031a60: 4f55 4e54 206d 6f64 6520 2865 6d70 7479  OUNT mode (empty
-00031a70: 2062 7563 6b65 7429 2c20 616e 640a 2020   bucket), and.  
-00031a80: 2020 2020 2020 2320 7468 656e 2074 7269        # then tri
-00031a90: 6573 2074 6f20 6c6f 6164 2074 6865 2073  es to load the s
-00031aa0: 616d 6520 7374 6f72 6167 6520 696e 2043  ame storage in C
-00031ab0: 4f50 5920 6d6f 6465 2e0a 2020 2020 2020  OPY mode..      
-00031ac0: 2020 746d 705f 636f 7079 5f6d 6e74 5f65    tmp_copy_mnt_e
-00031ad0: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
-00031ae0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-00031af0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00031b00: 7970 652e 5333 290a 2020 2020 2020 2020  ype.S3).        
-00031b10: 7374 6f72 6167 655f 6e61 6d65 203d 2074  storage_name = t
-00031b20: 6d70 5f63 6f70 795f 6d6e 745f 6578 6973  mp_copy_mnt_exis
-00031b30: 7469 6e67 5f73 746f 7261 6765 5f6f 626a  ting_storage_obj
-00031b40: 2e6e 616d 650a 0a20 2020 2020 2020 2023  .name..        #
-00031b50: 2043 6865 636b 2060 736b 7920 7374 6f72   Check `sky stor
-00031b60: 6167 6520 6c73 6020 746f 2065 6e73 7572  age ls` to ensur
-00031b70: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
-00031b80: 2065 7869 7374 730a 2020 2020 2020 2020   exists.        
-00031b90: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
-00031ba0: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
-00031bb0: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-00031bc0: 2027 6c73 275d 292e 6465 636f 6465 2827   'ls']).decode('
-00031bd0: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
-00031be0: 6173 7365 7274 2073 746f 7261 6765 5f6e  assert storage_n
-00031bf0: 616d 6520 696e 206f 7574 2c20 6627 5374  ame in out, f'St
-00031c00: 6f72 6167 6520 7b73 746f 7261 6765 5f6e  orage {storage_n
-00031c10: 616d 657d 206e 6f74 2066 6f75 6e64 2069  ame} not found i
-00031c20: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-00031c30: 2e27 0a0a 2020 2020 4070 7974 6573 742e  .'..    @pytest.
-00031c40: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
-00031c50: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
-00031c60: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-00031c70: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-00031c80: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00031c90: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-00031ca0: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-00031cb0: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-00031cc0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-00031cd0: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-00031ce0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
-00031cf0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
-00031d00: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
-00031d10: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
-00031d20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00031d30: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
-00031d40: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
-00031d50: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
-00031d60: 2074 6573 745f 6c69 7374 5f73 6f75 7263   test_list_sourc
-00031d70: 6528 7365 6c66 2c20 746d 705f 6c6f 6361  e(self, tmp_loca
-00031d80: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-00031d90: 626a 2c20 7374 6f72 655f 7479 7065 293a  bj, store_type):
-00031da0: 0a20 2020 2020 2020 2023 2055 7365 7320  .        # Uses 
-00031db0: 6120 6c69 7374 2069 6e20 7468 6520 736f  a list in the so
-00031dc0: 7572 6365 2066 6965 6c64 2074 6f20 7370  urce field to sp
-00031dd0: 6563 6966 7920 6120 6669 6c65 2061 6e64  ecify a file and
-00031de0: 2061 2064 6972 6563 746f 7279 2074 6f0a   a directory to.
-00031df0: 2020 2020 2020 2020 2320 6265 2075 706c          # be upl
-00031e00: 6f61 6465 6420 746f 2074 6865 2073 746f  oaded to the sto
-00031e10: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
-00031e20: 2020 2020 2074 6d70 5f6c 6f63 616c 5f6c       tmp_local_l
-00031e30: 6973 745f 7374 6f72 6167 655f 6f62 6a2e  ist_storage_obj.
-00031e40: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-00031e50: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-00031e60: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
-00031e70: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00031e80: 2062 7563 6b65 7420 726f 6f74 2075 7369   bucket root usi
-00031e90: 6e67 2063 6c69 0a20 2020 2020 2020 206f  ng cli.        o
-00031ea0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-00031eb0: 6368 6563 6b5f 6f75 7470 7574 2873 656c  check_output(sel
-00031ec0: 662e 636c 695f 6c73 5f63 6d64 280a 2020  f.cli_ls_cmd(.  
-00031ed0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-00031ee0: 7479 7065 2c20 746d 705f 6c6f 6361 6c5f  type, tmp_local_
-00031ef0: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
-00031f00: 2e6e 616d 6529 2c0a 2020 2020 2020 2020  .name),.        
-00031f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f20: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00031f30: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00031f40: 2020 6173 7365 7274 2027 746d 702d 6669    assert 'tmp-fi
-00031f50: 6c65 2720 696e 206f 7574 2e64 6563 6f64  le' in out.decod
-00031f60: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
-00031f70: 2020 2020 2020 2020 2020 2746 696c 6520            'File 
-00031f80: 6e6f 7420 666f 756e 6420 696e 2062 7563  not found in buc
-00031f90: 6b65 7420 2d20 6f75 7470 7574 2077 6173  ket - output was
-00031fa0: 203a 207b 7d27 2e66 6f72 6d61 7428 6f75   : {}'.format(ou
-00031fb0: 742e 6465 636f 6465 0a20 2020 2020 2020  t.decode.       
-00031fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ff0: 2020 2020 2020 2020 2028 2775 7466 2d38           ('utf-8
-00032000: 2729 290a 0a20 2020 2020 2020 2023 2043  '))..        # C
-00032010: 6865 636b 2069 6620 746d 702d 6669 6c65  heck if tmp-file
-00032020: 2065 7869 7374 7320 696e 2074 6865 2062   exists in the b
-00032030: 7563 6b65 742f 746d 702d 736f 7572 6365  ucket/tmp-source
-00032040: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
-00032050: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-00032060: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00032070: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
-00032080: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00032090: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
-000320a0: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-000320b0: 5f6f 626a 2e6e 616d 652c 2027 746d 702d  _obj.name, 'tmp-
-000320c0: 736f 7572 6365 2f27 292c 0a20 2020 2020  source/'),.     
-000320d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+00031400: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00031410: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+00031420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031440: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00031450: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+00031460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031480: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00031490: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000314a0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000314b0: 7374 5f75 706c 6f61 645f 746f 5f65 7869  st_upload_to_exi
+000314c0: 7374 696e 675f 6275 636b 6574 2873 656c  sting_bucket(sel
+000314d0: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
+000314e0: 7874 7572 652c 2072 6571 7565 7374 2c0a  xture, request,.
+000314f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031510: 2020 2020 2020 2074 6d70 5f73 6f75 7263         tmp_sourc
+00031520: 652c 2073 746f 7265 5f74 7970 6529 3a0a  e, store_type):.
+00031530: 2020 2020 2020 2020 2320 5472 6965 7320          # Tries 
+00031540: 7570 6c6f 6164 696e 6720 6578 6973 7469  uploading existi
+00031550: 6e67 2066 696c 6573 2074 6f20 6e65 776c  ng files to newl
+00031560: 7920 6372 6561 7465 6420 6275 636b 6574  y created bucket
+00031570: 2028 6f75 7473 6964 6520 6f66 0a20 2020   (outside of.   
+00031580: 2020 2020 2023 2073 6b79 2920 616e 6420       # sky) and 
+00031590: 7665 7269 6669 6573 2074 6861 7420 6669  verifies that fi
+000315a0: 6c65 7320 6172 6520 7772 6974 7465 6e2e  les are written.
+000315b0: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+000315c0: 6e61 6d65 2c20 5f20 3d20 7265 7175 6573  name, _ = reques
+000315d0: 742e 6765 7466 6978 7475 7265 7661 6c75  t.getfixturevalu
+000315e0: 6528 6578 745f 6275 636b 6574 5f66 6978  e(ext_bucket_fix
+000315f0: 7475 7265 290a 2020 2020 2020 2020 7374  ture).        st
+00031600: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+00031610: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+00031620: 6e61 6d65 3d62 7563 6b65 745f 6e61 6d65  name=bucket_name
+00031630: 2c20 736f 7572 6365 3d74 6d70 5f73 6f75  , source=tmp_sou
+00031640: 7263 6529 0a20 2020 2020 2020 2073 746f  rce).        sto
+00031650: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+00031660: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+00031670: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00031680: 6966 2074 6d70 5f73 6f75 7263 652f 746d  if tmp_source/tm
+00031690: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+000316a0: 2074 6865 2062 7563 6b65 7420 7573 696e   the bucket usin
+000316b0: 6720 6177 7320 636c 690a 2020 2020 2020  g aws cli.      
+000316c0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+000316d0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+000316e0: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+000316f0: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00031700: 6574 5f6e 616d 6529 2c0a 2020 2020 2020  et_name),.      
+00031710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031730: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+00031740: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
+00031750: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
+00031760: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+00031770: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
+00031780: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00031790: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
+000317a0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+000317b0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
+000317c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317f0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
+00031800: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
+00031810: 2043 6865 636b 2073 796d 6c69 6e6b 7320   Check symlinks 
+00031820: 2d20 7379 6d6c 696e 6b73 2064 6f6e 2774  - symlinks don't
+00031830: 2067 6574 2063 6f70 6965 6420 6279 2073   get copied by s
+00031840: 6b79 2073 746f 7261 6765 0a20 2020 2020  ky storage.     
+00031850: 2020 2061 7373 6572 7420 2870 6174 686c     assert (pathl
+00031860: 6962 2e50 6174 6828 746d 705f 736f 7572  ib.Path(tmp_sour
+00031870: 6365 2920 2f20 2763 6972 636c 652d 6c69  ce) / 'circle-li
+00031880: 6e6b 2729 2e69 735f 7379 6d6c 696e 6b28  nk').is_symlink(
+00031890: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+000318a0: 2027 6369 7263 6c65 2d6c 696e 6b20 7761   'circle-link wa
+000318b0: 7320 6e6f 7420 666f 756e 6420 696e 2074  s not found in t
+000318c0: 6865 2075 706c 6f61 6420 736f 7572 6365  he upload source
+000318d0: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
+000318e0: 2027 6172 6520 7468 6520 7465 7374 2066   'are the test f
+000318f0: 6978 7475 7265 7320 636f 7272 6563 743f  ixtures correct?
+00031900: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
+00031910: 7420 2763 6972 636c 652d 6c69 6e6b 2720  t 'circle-link' 
+00031920: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
+00031930: 6528 2775 7466 2d38 2729 2c20 280a 2020  e('utf-8'), (.  
+00031940: 2020 2020 2020 2020 2020 2753 796d 6c69            'Symli
+00031950: 6e6b 2066 6f75 6e64 2069 6e20 6275 636b  nk found in buck
+00031960: 6574 202d 206c 7320 6f75 7470 7574 2077  et - ls output w
+00031970: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+00031980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031990: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+000319a0: 2d38 2729 2929 0a0a 2020 2020 2020 2020  -8')))..        
+000319b0: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+000319c0: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
+000319d0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+000319e0: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
+000319f0: 7470 7574 2e0a 2020 2020 2020 2020 2320  tput..        # 
+00031a00: 4974 2073 686f 756c 6420 6e6f 7420 6578  It should not ex
+00031a10: 6973 7420 6265 6361 7573 6520 7468 6520  ist because the 
+00031a20: 6275 636b 6574 2077 6173 2063 7265 6174  bucket was creat
+00031a30: 6564 2065 7874 6572 6e61 6c6c 792e 0a20  ed externally.. 
+00031a40: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00031a50: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00031a60: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+00031a70: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+00031a80: 2020 2020 2020 2061 7373 6572 7420 7374         assert st
+00031a90: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
+00031aa0: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
+00031ab0: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
+00031ac0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00031ad0: 6c75 6964 7374 6163 6b0a 2020 2020 6465  luidstack.    de
+00031ae0: 6620 7465 7374 5f63 6f70 795f 6d6f 756e  f test_copy_moun
+00031af0: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
+00031b00: 6765 2873 656c 662c 0a20 2020 2020 2020  ge(self,.       
+00031b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b30: 2020 746d 705f 636f 7079 5f6d 6e74 5f65    tmp_copy_mnt_e
+00031b40: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
+00031b50: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+00031b60: 4372 6561 7465 7320 6120 6275 636b 6574  Creates a bucket
+00031b70: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
+00031b80: 696e 204d 4f55 4e54 206d 6f64 6520 2865  in MOUNT mode (e
+00031b90: 6d70 7479 2062 7563 6b65 7429 2c20 616e  mpty bucket), an
+00031ba0: 640a 2020 2020 2020 2020 2320 7468 656e  d.        # then
+00031bb0: 2074 7269 6573 2074 6f20 6c6f 6164 2074   tries to load t
+00031bc0: 6865 2073 616d 6520 7374 6f72 6167 6520  he same storage 
+00031bd0: 696e 2043 4f50 5920 6d6f 6465 2e0a 2020  in COPY mode..  
+00031be0: 2020 2020 2020 746d 705f 636f 7079 5f6d        tmp_copy_m
+00031bf0: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
+00031c00: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00031c10: 6528 7374 6f72 6167 655f 6c69 622e 5374  e(storage_lib.St
+00031c20: 6f72 6554 7970 652e 5333 290a 2020 2020  oreType.S3).    
+00031c30: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+00031c40: 203d 2074 6d70 5f63 6f70 795f 6d6e 745f   = tmp_copy_mnt_
+00031c50: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
+00031c60: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
+00031c70: 2020 2023 2043 6865 636b 2060 736b 7920     # Check `sky 
+00031c80: 7374 6f72 6167 6520 6c73 6020 746f 2065  storage ls` to e
+00031c90: 6e73 7572 6520 7374 6f72 6167 6520 6f62  nsure storage ob
+00031ca0: 6a65 6374 2065 7869 7374 730a 2020 2020  ject exists.    
+00031cb0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+00031cc0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00031cd0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+00031ce0: 6765 272c 2027 6c73 275d 292e 6465 636f  ge', 'ls']).deco
+00031cf0: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+00031d00: 2020 2020 6173 7365 7274 2073 746f 7261      assert stora
+00031d10: 6765 5f6e 616d 6520 696e 206f 7574 2c20  ge_name in out, 
+00031d20: 6627 5374 6f72 6167 6520 7b73 746f 7261  f'Storage {stora
+00031d30: 6765 5f6e 616d 657d 206e 6f74 2066 6f75  ge_name} not fou
+00031d40: 6e64 2069 6e20 736b 7920 7374 6f72 6167  nd in sky storag
+00031d50: 6520 6c73 2e27 0a0a 2020 2020 4070 7974  e ls.'..    @pyt
+00031d60: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00031d70: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+00031d80: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+00031d90: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+00031da0: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+00031db0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00031dc0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+00031dd0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+00031de0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00031df0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+00031e00: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+00031e10: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00031e20: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+00031e30: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+00031e40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00031e50: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+00031e60: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+00031e70: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+00031e80: 2064 6566 2074 6573 745f 6c69 7374 5f73   def test_list_s
+00031e90: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
+00031ea0: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
+00031eb0: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
+00031ec0: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
+00031ed0: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
+00031ee0: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
+00031ef0: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
+00031f00: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
+00031f10: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
+00031f20: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
+00031f30: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
+00031f40: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
+00031f50: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+00031f60: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+00031f70: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+00031f80: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+00031f90: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+00031fa0: 2074 6865 2062 7563 6b65 7420 726f 6f74   the bucket root
+00031fb0: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00031fc0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+00031fd0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00031fe0: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
+00031ff0: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00032000: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
+00032010: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+00032020: 5f6f 626a 2e6e 616d 6529 2c0a 2020 2020  _obj.name),.    
+00032030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032050: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
+00032060: 2020 2020 2020 6173 7365 7274 2027 746d        assert 'tm
+00032070: 702d 6669 6c65 2720 696e 206f 7574 2e64  p-file' in out.d
+00032080: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00032090: 5c0a 2020 2020 2020 2020 2020 2020 2746  \.            'F
+000320a0: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
+000320b0: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
+000320c0: 2077 6173 203a 207b 7d27 2e66 6f72 6d61   was : {}'.forma
+000320d0: 7428 6f75 742e 6465 636f 6465 0a20 2020  t(out.decode.   
 000320e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320f0: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
-00032100: 2020 2020 2061 7373 6572 7420 2774 6d70       assert 'tmp
-00032110: 2d66 696c 6527 2069 6e20 6f75 742e 6465  -file' in out.de
-00032120: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
-00032130: 0a20 2020 2020 2020 2020 2020 2027 4669  .            'Fi
-00032140: 6c65 206e 6f74 2066 6f75 6e64 2069 6e20  le not found in 
-00032150: 6275 636b 6574 202d 206f 7574 7075 7420  bucket - output 
-00032160: 7761 7320 3a20 7b7d 272e 666f 726d 6174  was : {}'.format
-00032170: 286f 7574 2e64 6563 6f64 650a 2020 2020  (out.decode.    
-00032180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000321a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000321b0: 2020 2020 2020 2020 2020 2020 2827 7574              ('ut
-000321c0: 662d 3827 2929 0a0a 2020 2020 4070 7974  f-8'))..    @pyt
-000321d0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-000321e0: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-000321f0: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00032200: 697a 6528 2769 6e76 616c 6964 5f6e 616d  ize('invalid_nam
-00032210: 655f 6c69 7374 2c20 7374 6f72 655f 7479  e_list, store_ty
-00032220: 7065 272c 0a20 2020 2020 2020 2020 2020  pe',.           
-00032230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032240: 2020 5b28 4157 535f 494e 5641 4c49 445f    [(AWS_INVALID_
-00032250: 4e41 4d45 532c 2073 746f 7261 6765 5f6c  NAMES, storage_l
-00032260: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-00032270: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032290: 2847 4353 5f49 4e56 414c 4944 5f4e 414d  (GCS_INVALID_NAM
-000322a0: 4553 2c20 7374 6f72 6167 655f 6c69 622e  ES, storage_lib.
-000322b0: 5374 6f72 6554 7970 652e 4743 5329 2c0a  StoreType.GCS),.
+000320f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032110: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00032120: 7466 2d38 2729 290a 0a20 2020 2020 2020  tf-8'))..       
+00032130: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
+00032140: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00032150: 6865 2062 7563 6b65 742f 746d 702d 736f  he bucket/tmp-so
+00032160: 7572 6365 2075 7369 6e67 2063 6c69 0a20  urce using cli. 
+00032170: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00032180: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00032190: 7470 7574 2873 656c 662e 636c 695f 6c73  tput(self.cli_ls
+000321a0: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
+000321b0: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
+000321c0: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+000321d0: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+000321e0: 746d 702d 736f 7572 6365 2f27 292c 0a20  tmp-source/'),. 
+000321f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032210: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00032220: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00032230: 2774 6d70 2d66 696c 6527 2069 6e20 6f75  'tmp-file' in ou
+00032240: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00032250: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
+00032260: 2027 4669 6c65 206e 6f74 2066 6f75 6e64   'File not found
+00032270: 2069 6e20 6275 636b 6574 202d 206f 7574   in bucket - out
+00032280: 7075 7420 7761 7320 3a20 7b7d 272e 666f  put was : {}'.fo
+00032290: 726d 6174 286f 7574 2e64 6563 6f64 650a  rmat(out.decode.
+000322a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000322c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000322d0: 2020 2020 2020 2020 2020 2020 2020 7079                py
-000322e0: 7465 7374 2e70 6172 616d 2849 424d 5f49  test.param(IBM_I
-000322f0: 4e56 414c 4944 5f4e 414d 4553 2c0a 2020  NVALID_NAMES,.  
-00032300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032320: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00032330: 5f6c 6962 2e53 746f 7265 5479 7065 2e49  _lib.StoreType.I
-00032340: 424d 2c0a 2020 2020 2020 2020 2020 2020  BM,.            
+000322d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322e0: 2827 7574 662d 3827 2929 0a0a 2020 2020  ('utf-8'))..    
+000322f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00032300: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00032310: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00032320: 6d65 7472 697a 6528 2769 6e76 616c 6964  metrize('invalid
+00032330: 5f6e 616d 655f 6c69 7374 2c20 7374 6f72  _name_list, stor
+00032340: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
 00032350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032360: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00032370: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00032380: 2e69 626d 292c 0a20 2020 2020 2020 2020  .ibm),.         
-00032390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323a0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-000323b0: 6d28 4157 535f 494e 5641 4c49 445f 4e41  m(AWS_INVALID_NA
-000323c0: 4d45 532c 0a20 2020 2020 2020 2020 2020  MES,.           
-000323d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323f0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00032400: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
-00032410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032430: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
-00032440: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-00032450: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
-00032460: 745f 696e 7661 6c69 645f 6e61 6d65 7328  t_invalid_names(
-00032470: 7365 6c66 2c20 696e 7661 6c69 645f 6e61  self, invalid_na
-00032480: 6d65 5f6c 6973 742c 2073 746f 7265 5f74  me_list, store_t
-00032490: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-000324a0: 5573 6573 2061 206c 6973 7420 696e 2074  Uses a list in t
-000324b0: 6865 2073 6f75 7263 6520 6669 656c 6420  he source field 
-000324c0: 746f 2073 7065 6369 6679 2061 2066 696c  to specify a fil
-000324d0: 6520 616e 6420 6120 6469 7265 6374 6f72  e and a director
-000324e0: 7920 746f 0a20 2020 2020 2020 2023 2062  y to.        # b
-000324f0: 6520 7570 6c6f 6164 6564 2074 6f20 7468  e uploaded to th
-00032500: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
-00032510: 2e0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
-00032520: 6d65 2069 6e20 696e 7661 6c69 645f 6e61  me in invalid_na
-00032530: 6d65 5f6c 6973 743a 0a20 2020 2020 2020  me_list:.       
-00032540: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
-00032550: 2e72 6169 7365 7328 736b 792e 6578 6365  .raises(sky.exce
-00032560: 7074 696f 6e73 2e53 746f 7261 6765 4e61  ptions.StorageNa
-00032570: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
-00032580: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00032590: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-000325a0: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
-000325b0: 3d6e 616d 6529 0a20 2020 2020 2020 2020  =name).         
-000325c0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-000325d0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-000325e0: 7265 5f74 7970 6529 0a0a 2020 2020 4070  re_type)..    @p
-000325f0: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00032600: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00032610: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00032620: 7472 697a 6528 0a20 2020 2020 2020 2027  trize(.        '
-00032630: 6769 7469 676e 6f72 655f 7374 7275 6374  gitignore_struct
-00032640: 7572 652c 2073 746f 7265 5f74 7970 6527  ure, store_type'
-00032650: 2c0a 2020 2020 2020 2020 5b28 4749 5449  ,.        [(GITI
-00032660: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
-00032670: 4449 525f 5354 5255 4354 5552 452c 2073  DIR_STRUCTURE, s
-00032680: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00032690: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
-000326a0: 2020 2028 4749 5449 474e 4f52 455f 5359     (GITIGNORE_SY
-000326b0: 4e43 5f54 4553 545f 4449 525f 5354 5255  NC_TEST_DIR_STRU
-000326c0: 4354 5552 452c 2073 746f 7261 6765 5f6c  CTURE, storage_l
-000326d0: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-000326e0: 292c 0a20 2020 2020 2020 2020 7079 7465  ),.         pyte
-000326f0: 7374 2e70 6172 616d 2847 4954 4947 4e4f  st.param(GITIGNO
-00032700: 5245 5f53 594e 435f 5445 5354 5f44 4952  RE_SYNC_TEST_DIR
-00032710: 5f53 5452 5543 5455 5245 2c0a 2020 2020  _STRUCTURE,.    
-00032720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032730: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-00032740: 6f72 6554 7970 652e 5232 2c0a 2020 2020  oreType.R2,.    
-00032750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032760: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-00032770: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
-00032780: 290a 2020 2020 6465 6620 7465 7374 5f65  ).    def test_e
-00032790: 7863 6c75 6465 645f 6669 6c65 5f63 6c6f  xcluded_file_clo
-000327a0: 7564 5f73 746f 7261 6765 5f75 706c 6f61  ud_storage_uploa
-000327b0: 645f 636f 7079 2873 656c 662c 2067 6974  d_copy(self, git
-000327c0: 6967 6e6f 7265 5f73 7472 7563 7475 7265  ignore_structure
-000327d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000327e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000327f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032800: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
-00032810: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00032820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032840: 2020 2020 2020 2020 746d 705f 6769 7469          tmp_giti
-00032850: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
-00032860: 6a29 3a0a 2020 2020 2020 2020 2320 7465  j):.        # te
-00032870: 7374 7320 6966 2066 696c 6573 2069 6e63  sts if files inc
-00032880: 6c75 6465 6420 696e 202e 6769 7469 676e  luded in .gitign
-00032890: 6f72 6520 616e 6420 2e67 6974 2f69 6e66  ore and .git/inf
-000328a0: 6f2f 6578 636c 7564 6520 6172 650a 2020  o/exclude are.  
-000328b0: 2020 2020 2020 2320 6578 636c 7564 6564        # excluded
-000328c0: 2066 726f 6d20 6265 696e 6720 7472 616e   from being tran
-000328d0: 7366 6572 7265 6420 746f 2053 746f 7261  sferred to Stora
-000328e0: 6765 0a0a 2020 2020 2020 2020 746d 705f  ge..        tmp_
-000328f0: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
-00032900: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-00032910: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
-00032920: 2020 2020 2075 706c 6f61 645f 6669 6c65       upload_file
-00032930: 5f6e 616d 6520 3d20 2769 6e63 6c75 6465  _name = 'include
-00032940: 6427 0a20 2020 2020 2020 2023 2043 6f75  d'.        # Cou
-00032950: 6e74 2074 6865 206e 756d 6265 7220 6f66  nt the number of
-00032960: 2066 696c 6573 2077 6974 6820 7468 6520   files with the 
-00032970: 6769 7665 6e20 6669 6c65 206e 616d 650a  given file name.
-00032980: 2020 2020 2020 2020 7570 5f63 6d64 203d          up_cmd =
-00032990: 2073 656c 662e 636c 695f 636f 756e 745f   self.cli_count_
-000329a0: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
-000329b0: 746f 7265 5f74 7970 652c 205c 0a20 2020  tore_type, \.   
-000329c0: 2020 2020 2020 2020 2074 6d70 5f67 6974           tmp_git
-000329d0: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
-000329e0: 626a 2e6e 616d 652c 2066 696c 655f 6e61  bj.name, file_na
-000329f0: 6d65 3d75 706c 6f61 645f 6669 6c65 5f6e  me=upload_file_n
-00032a00: 616d 6529 0a20 2020 2020 2020 2067 6974  ame).        git
-00032a10: 5f65 7863 6c75 6465 5f63 6d64 203d 2073  _exclude_cmd = s
-00032a20: 656c 662e 636c 695f 636f 756e 745f 6e61  elf.cli_count_na
-00032a30: 6d65 5f69 6e5f 6275 636b 6574 2873 746f  me_in_bucket(sto
-00032a40: 7265 5f74 7970 652c 205c 0a20 2020 2020  re_type, \.     
-00032a50: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
-00032a60: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-00032a70: 2e6e 616d 652c 2066 696c 655f 6e61 6d65  .name, file_name
-00032a80: 3d27 2e67 6974 2729 0a20 2020 2020 2020  ='.git').       
-00032a90: 2063 6e74 5f6e 756d 5f66 696c 655f 636d   cnt_num_file_cm
-00032aa0: 6420 3d20 7365 6c66 2e63 6c69 5f63 6f75  d = self.cli_cou
-00032ab0: 6e74 5f66 696c 655f 696e 5f62 7563 6b65  nt_file_in_bucke
-00032ac0: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
-00032ad0: 746f 7265 5f74 7970 652c 2074 6d70 5f67  tore_type, tmp_g
-00032ae0: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-00032af0: 5f6f 626a 2e6e 616d 6529 0a0a 2020 2020  _obj.name)..    
-00032b00: 2020 2020 7570 5f6f 7574 7075 7420 3d20      up_output = 
-00032b10: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-00032b20: 5f6f 7574 7075 7428 7570 5f63 6d64 2c20  _output(up_cmd, 
-00032b30: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00032b40: 2020 2020 6769 745f 6578 636c 7564 655f      git_exclude_
-00032b50: 6f75 7470 7574 203d 2073 7562 7072 6f63  output = subproc
-00032b60: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00032b70: 2867 6974 5f65 7863 6c75 6465 5f63 6d64  (git_exclude_cmd
-00032b80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032bb0: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-00032bc0: 6529 0a20 2020 2020 2020 2063 6e74 5f6f  e).        cnt_o
-00032bd0: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
-00032be0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00032bf0: 636e 745f 6e75 6d5f 6669 6c65 5f63 6d64  cnt_num_file_cmd
-00032c00: 2c20 7368 656c 6c3d 5472 7565 290a 0a20  , shell=True).. 
-00032c10: 2020 2020 2020 2061 7373 6572 7420 2733         assert '3
-00032c20: 2720 696e 2075 705f 6f75 7470 7574 2e64  ' in up_output.d
-00032c30: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-00032c40: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00032c50: 2020 2746 696c 6573 2074 6f20 6265 2069    'Files to be i
-00032c60: 6e63 6c75 6465 6420 6172 6520 6e6f 7420  ncluded are not 
-00032c70: 636f 6d70 6c65 7465 6c79 2075 706c 6f61  completely uploa
-00032c80: 6465 642e 270a 2020 2020 2020 2020 2320  ded.'.        # 
-00032c90: 3120 6973 2072 6561 6420 6173 202e 6769  1 is read as .gi
-00032ca0: 7469 676e 6f72 6520 6973 2075 706c 6f61  tignore is uploa
-00032cb0: 6465 640a 2020 2020 2020 2020 6173 7365  ded.        asse
-00032cc0: 7274 2027 3127 2069 6e20 6769 745f 6578  rt '1' in git_ex
-00032cd0: 636c 7564 655f 6f75 7470 7574 2e64 6563  clude_output.dec
-00032ce0: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-00032cf0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00032d00: 2e67 6974 2064 6972 6563 746f 7279 2073  .git directory s
-00032d10: 686f 756c 6420 6e6f 7420 6265 2075 706c  hould not be upl
-00032d20: 6f61 6465 642e 270a 2020 2020 2020 2020  oaded.'.        
-00032d30: 2320 3420 6669 6c65 7320 696e 636c 7564  # 4 files includ
-00032d40: 6520 2e67 6974 6967 6e6f 7265 2c20 696e  e .gitignore, in
-00032d50: 636c 7564 6564 2e6c 6f67 2c20 696e 636c  cluded.log, incl
-00032d60: 7564 6564 2e74 7874 2c20 696e 636c 7564  uded.txt, includ
-00032d70: 655f 6469 722f 696e 636c 7564 6564 2e6c  e_dir/included.l
-00032d80: 6f67 0a20 2020 2020 2020 2061 7373 6572  og.        asser
-00032d90: 7420 2734 2720 696e 2063 6e74 5f6f 7574  t '4' in cnt_out
-00032da0: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
-00032db0: 3827 292c 205c 0a20 2020 2020 2020 2020  8'), \.         
-00032dc0: 2020 2020 2020 2753 6f6d 6520 6974 656d        'Some item
-00032dd0: 7320 6c69 7374 6564 2069 6e20 2e67 6974  s listed in .git
-00032de0: 6967 6e6f 7265 2061 6e64 202e 6769 742f  ignore and .git/
-00032df0: 696e 666f 2f65 7863 6c75 6465 2061 7265  info/exclude are
-00032e00: 206e 6f74 2065 7863 6c75 6465 642e 270a   not excluded.'.
-00032e10: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-00032e20: 6b2e 7061 7261 6d65 7472 697a 6528 2765  k.parametrize('e
-00032e30: 7874 5f62 7563 6b65 745f 6669 7874 7572  xt_bucket_fixtur
-00032e40: 652c 2073 746f 7265 5f74 7970 6527 2c0a  e, store_type',.
-00032e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e60: 2020 2020 2020 2020 2020 2020 205b 2827               [('
-00032e70: 746d 705f 6177 7363 6c69 5f62 7563 6b65  tmp_awscli_bucke
-00032e80: 7427 2c20 7374 6f72 6167 655f 6c69 622e  t', storage_lib.
-00032e90: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
-00032ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032eb0: 2020 2020 2020 2020 2020 2020 2028 2774               ('t
-00032ec0: 6d70 5f67 7375 7469 6c5f 6275 636b 6574  mp_gsutil_bucket
-00032ed0: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
-00032ee0: 746f 7265 5479 7065 2e47 4353 292c 0a20  toreType.GCS),. 
-00032ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f00: 2020 2020 2020 2020 2020 2020 2070 7974               pyt
-00032f10: 6573 742e 7061 7261 6d28 2774 6d70 5f61  est.param('tmp_a
-00032f20: 7773 636c 695f 6275 636b 6574 5f72 3227  wscli_bucket_r2'
-00032f30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f50: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-00032f60: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00032f70: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
+00032360: 2020 2020 2020 5b28 4157 535f 494e 5641        [(AWS_INVA
+00032370: 4c49 445f 4e41 4d45 532c 2073 746f 7261  LID_NAMES, stora
+00032380: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00032390: 2e53 3329 2c0a 2020 2020 2020 2020 2020  .S3),.          
+000323a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000323b0: 2020 2020 2847 4353 5f49 4e56 414c 4944      (GCS_INVALID
+000323c0: 5f4e 414d 4553 2c20 7374 6f72 6167 655f  _NAMES, storage_
+000323d0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+000323e0: 5329 2c0a 2020 2020 2020 2020 2020 2020  S),.            
+000323f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032400: 2020 7079 7465 7374 2e70 6172 616d 2849    pytest.param(I
+00032410: 424d 5f49 4e56 414c 4944 5f4e 414d 4553  BM_INVALID_NAMES
+00032420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032440: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00032450: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00032460: 7065 2e49 424d 2c0a 2020 2020 2020 2020  pe.IBM,.        
+00032470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032490: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
+000324a0: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+000324b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000324c0: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
+000324d0: 7061 7261 6d28 4157 535f 494e 5641 4c49  param(AWS_INVALI
+000324e0: 445f 4e41 4d45 532c 0a20 2020 2020 2020  D_NAMES,.       
+000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032510: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+00032520: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
+00032530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032550: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
+00032560: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
+00032570: 666c 6172 6529 5d29 0a20 2020 2064 6566  flare)]).    def
+00032580: 2074 6573 745f 696e 7661 6c69 645f 6e61   test_invalid_na
+00032590: 6d65 7328 7365 6c66 2c20 696e 7661 6c69  mes(self, invali
+000325a0: 645f 6e61 6d65 5f6c 6973 742c 2073 746f  d_name_list, sto
+000325b0: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
+000325c0: 2020 2320 5573 6573 2061 206c 6973 7420    # Uses a list 
+000325d0: 696e 2074 6865 2073 6f75 7263 6520 6669  in the source fi
+000325e0: 656c 6420 746f 2073 7065 6369 6679 2061  eld to specify a
+000325f0: 2066 696c 6520 616e 6420 6120 6469 7265   file and a dire
+00032600: 6374 6f72 7920 746f 0a20 2020 2020 2020  ctory to.       
+00032610: 2023 2062 6520 7570 6c6f 6164 6564 2074   # be uploaded t
+00032620: 6f20 7468 6520 7374 6f72 6167 6520 6f62  o the storage ob
+00032630: 6a65 6374 2e0a 2020 2020 2020 2020 666f  ject..        fo
+00032640: 7220 6e61 6d65 2069 6e20 696e 7661 6c69  r name in invali
+00032650: 645f 6e61 6d65 5f6c 6973 743a 0a20 2020  d_name_list:.   
+00032660: 2020 2020 2020 2020 2077 6974 6820 7079           with py
+00032670: 7465 7374 2e72 6169 7365 7328 736b 792e  test.raises(sky.
+00032680: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
+00032690: 6765 4e61 6d65 4572 726f 7229 3a0a 2020  geNameError):.  
+000326a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000326b0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+000326c0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+000326d0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+000326e0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000326f0: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+00032700: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
+00032710: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+00032720: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+00032730: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+00032740: 7261 6d65 7472 697a 6528 0a20 2020 2020  rametrize(.     
+00032750: 2020 2027 6769 7469 676e 6f72 655f 7374     'gitignore_st
+00032760: 7275 6374 7572 652c 2073 746f 7265 5f74  ructure, store_t
+00032770: 7970 6527 2c0a 2020 2020 2020 2020 5b28  ype',.        [(
+00032780: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
+00032790: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
+000327a0: 452c 2073 746f 7261 6765 5f6c 6962 2e53  E, storage_lib.S
+000327b0: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
+000327c0: 2020 2020 2020 2028 4749 5449 474e 4f52         (GITIGNOR
+000327d0: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
+000327e0: 5354 5255 4354 5552 452c 2073 746f 7261  STRUCTURE, stora
+000327f0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00032800: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+00032810: 7079 7465 7374 2e70 6172 616d 2847 4954  pytest.param(GIT
+00032820: 4947 4e4f 5245 5f53 594e 435f 5445 5354  IGNORE_SYNC_TEST
+00032830: 5f44 4952 5f53 5452 5543 5455 5245 2c0a  _DIR_STRUCTURE,.
+00032840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032850: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00032860: 622e 5374 6f72 6554 7970 652e 5232 2c0a  b.StoreType.R2,.
+00032870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032880: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00032890: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000328a0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000328b0: 7374 5f65 7863 6c75 6465 645f 6669 6c65  st_excluded_file
+000328c0: 5f63 6c6f 7564 5f73 746f 7261 6765 5f75  _cloud_storage_u
+000328d0: 706c 6f61 645f 636f 7079 2873 656c 662c  pload_copy(self,
+000328e0: 2067 6974 6967 6e6f 7265 5f73 7472 7563   gitignore_struc
+000328f0: 7475 7265 2c0a 2020 2020 2020 2020 2020  ture,.          
+00032900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032920: 2020 2020 2020 2020 2020 2073 746f 7265             store
+00032930: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+00032940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032960: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
+00032970: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
+00032980: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
+00032990: 2320 7465 7374 7320 6966 2066 696c 6573  # tests if files
+000329a0: 2069 6e63 6c75 6465 6420 696e 202e 6769   included in .gi
+000329b0: 7469 676e 6f72 6520 616e 6420 2e67 6974  tignore and .git
+000329c0: 2f69 6e66 6f2f 6578 636c 7564 6520 6172  /info/exclude ar
+000329d0: 650a 2020 2020 2020 2020 2320 6578 636c  e.        # excl
+000329e0: 7564 6564 2066 726f 6d20 6265 696e 6720  uded from being 
+000329f0: 7472 616e 7366 6572 7265 6420 746f 2053  transferred to S
+00032a00: 746f 7261 6765 0a0a 2020 2020 2020 2020  torage..        
+00032a10: 746d 705f 6769 7469 676e 6f72 655f 7374  tmp_gitignore_st
+00032a20: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+00032a30: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+00032a40: 0a20 2020 2020 2020 2075 706c 6f61 645f  .        upload_
+00032a50: 6669 6c65 5f6e 616d 6520 3d20 2769 6e63  file_name = 'inc
+00032a60: 6c75 6465 6427 0a20 2020 2020 2020 2023  luded'.        #
+00032a70: 2043 6f75 6e74 2074 6865 206e 756d 6265   Count the numbe
+00032a80: 7220 6f66 2066 696c 6573 2077 6974 6820  r of files with 
+00032a90: 7468 6520 6769 7665 6e20 6669 6c65 206e  the given file n
+00032aa0: 616d 650a 2020 2020 2020 2020 7570 5f63  ame.        up_c
+00032ab0: 6d64 203d 2073 656c 662e 636c 695f 636f  md = self.cli_co
+00032ac0: 756e 745f 6e61 6d65 5f69 6e5f 6275 636b  unt_name_in_buck
+00032ad0: 6574 2873 746f 7265 5f74 7970 652c 205c  et(store_type, \
+00032ae0: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+00032af0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
+00032b00: 6765 5f6f 626a 2e6e 616d 652c 2066 696c  ge_obj.name, fil
+00032b10: 655f 6e61 6d65 3d75 706c 6f61 645f 6669  e_name=upload_fi
+00032b20: 6c65 5f6e 616d 6529 0a20 2020 2020 2020  le_name).       
+00032b30: 2067 6974 5f65 7863 6c75 6465 5f63 6d64   git_exclude_cmd
+00032b40: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+00032b50: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+00032b60: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
+00032b70: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+00032b80: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00032b90: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
+00032ba0: 6e61 6d65 3d27 2e67 6974 2729 0a20 2020  name='.git').   
+00032bb0: 2020 2020 2063 6e74 5f6e 756d 5f66 696c       cnt_num_fil
+00032bc0: 655f 636d 6420 3d20 7365 6c66 2e63 6c69  e_cmd = self.cli
+00032bd0: 5f63 6f75 6e74 5f66 696c 655f 696e 5f62  _count_file_in_b
+00032be0: 7563 6b65 7428 0a20 2020 2020 2020 2020  ucket(.         
+00032bf0: 2020 2073 746f 7265 5f74 7970 652c 2074     store_type, t
+00032c00: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
+00032c10: 7261 6765 5f6f 626a 2e6e 616d 6529 0a0a  rage_obj.name)..
+00032c20: 2020 2020 2020 2020 7570 5f6f 7574 7075          up_outpu
+00032c30: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+00032c40: 6865 636b 5f6f 7574 7075 7428 7570 5f63  heck_output(up_c
+00032c50: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00032c60: 2020 2020 2020 2020 6769 745f 6578 636c          git_excl
+00032c70: 7564 655f 6f75 7470 7574 203d 2073 7562  ude_output = sub
+00032c80: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00032c90: 7470 7574 2867 6974 5f65 7863 6c75 6465  tput(git_exclude
+00032ca0: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
+00032cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cd0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+00032ce0: 3d54 7275 6529 0a20 2020 2020 2020 2063  =True).        c
+00032cf0: 6e74 5f6f 7574 7075 7420 3d20 7375 6270  nt_output = subp
+00032d00: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+00032d10: 7075 7428 636e 745f 6e75 6d5f 6669 6c65  put(cnt_num_file
+00032d20: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00032d30: 290a 0a20 2020 2020 2020 2061 7373 6572  )..        asser
+00032d40: 7420 2733 2720 696e 2075 705f 6f75 7470  t '3' in up_outp
+00032d50: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00032d60: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00032d70: 2020 2020 2020 2746 696c 6573 2074 6f20        'Files to 
+00032d80: 6265 2069 6e63 6c75 6465 6420 6172 6520  be included are 
+00032d90: 6e6f 7420 636f 6d70 6c65 7465 6c79 2075  not completely u
+00032da0: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
+00032db0: 2020 2320 3120 6973 2072 6561 6420 6173    # 1 is read as
+00032dc0: 202e 6769 7469 676e 6f72 6520 6973 2075   .gitignore is u
+00032dd0: 706c 6f61 6465 640a 2020 2020 2020 2020  ploaded.        
+00032de0: 6173 7365 7274 2027 3127 2069 6e20 6769  assert '1' in gi
+00032df0: 745f 6578 636c 7564 655f 6f75 7470 7574  t_exclude_output
+00032e00: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00032e10: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+00032e20: 2020 2027 2e67 6974 2064 6972 6563 746f     '.git directo
+00032e30: 7279 2073 686f 756c 6420 6e6f 7420 6265  ry should not be
+00032e40: 2075 706c 6f61 6465 642e 270a 2020 2020   uploaded.'.    
+00032e50: 2020 2020 2320 3420 6669 6c65 7320 696e      # 4 files in
+00032e60: 636c 7564 6520 2e67 6974 6967 6e6f 7265  clude .gitignore
+00032e70: 2c20 696e 636c 7564 6564 2e6c 6f67 2c20  , included.log, 
+00032e80: 696e 636c 7564 6564 2e74 7874 2c20 696e  included.txt, in
+00032e90: 636c 7564 655f 6469 722f 696e 636c 7564  clude_dir/includ
+00032ea0: 6564 2e6c 6f67 0a20 2020 2020 2020 2061  ed.log.        a
+00032eb0: 7373 6572 7420 2734 2720 696e 2063 6e74  ssert '4' in cnt
+00032ec0: 5f6f 7574 7075 742e 6465 636f 6465 2827  _output.decode('
+00032ed0: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
+00032ee0: 2020 2020 2020 2020 2020 2753 6f6d 6520            'Some 
+00032ef0: 6974 656d 7320 6c69 7374 6564 2069 6e20  items listed in 
+00032f00: 2e67 6974 6967 6e6f 7265 2061 6e64 202e  .gitignore and .
+00032f10: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
+00032f20: 2061 7265 206e 6f74 2065 7863 6c75 6465   are not exclude
+00032f30: 642e 270a 0a20 2020 2040 7079 7465 7374  d.'..    @pytest
+00032f40: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00032f50: 6528 2765 7874 5f62 7563 6b65 745f 6669  e('ext_bucket_fi
+00032f60: 7874 7572 652c 2073 746f 7265 5f74 7970  xture, store_typ
+00032f70: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
 00032f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032fa0: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-00032fb0: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
-00032fc0: 290a 2020 2020 6465 6620 7465 7374 5f65  ).    def test_e
-00032fd0: 7874 6572 6e61 6c6c 795f 6372 6561 7465  xternally_create
-00032fe0: 645f 6275 636b 6574 5f6d 6f75 6e74 5f77  d_bucket_mount_w
-00032ff0: 6974 686f 7574 5f73 6f75 7263 6528 0a20  ithout_source(. 
-00033000: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00033010: 2065 7874 5f62 7563 6b65 745f 6669 7874   ext_bucket_fixt
-00033020: 7572 652c 2072 6571 7565 7374 2c20 7374  ure, request, st
-00033030: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-00033040: 2020 2023 204e 6f6e 2d73 6b79 206d 616e     # Non-sky man
-00033050: 6167 6564 2062 7563 6b65 7473 2862 7563  aged buckets(buc
-00033060: 6b65 7473 2063 7265 6174 6564 206f 7574  kets created out
-00033070: 7369 6465 206f 6620 536b 7970 696c 6f74  side of Skypilot
-00033080: 2043 4c49 290a 2020 2020 2020 2020 2320   CLI).        # 
-00033090: 6172 6520 616c 6c6f 7765 6420 746f 2062  are allowed to b
-000330a0: 6520 4d4f 554e 5465 6420 6279 2073 7065  e MOUNTed by spe
-000330b0: 6369 6679 696e 6720 7468 6520 5552 4920  cifying the URI 
-000330c0: 6f66 2074 6865 2062 7563 6b65 7420 746f  of the bucket to
-000330d0: 0a20 2020 2020 2020 2023 2073 6f75 7263  .        # sourc
-000330e0: 6520 6669 656c 6420 6f6e 6c79 2e20 5768  e field only. Wh
-000330f0: 656e 2069 7420 6973 2061 7474 656d 7074  en it is attempt
-00033100: 6564 2062 7920 7370 6563 6966 7969 6e67  ed by specifying
-00033110: 2074 6865 206e 616d 6520 6f66 0a20 2020   the name of.   
-00033120: 2020 2020 2023 2074 6865 2062 7563 6b65       # the bucke
-00033130: 7420 6f6e 6c79 2c20 6974 2073 686f 756c  t only, it shoul
-00033140: 6420 6572 726f 7220 6f75 742e 0a20 2020  d error out..   
-00033150: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
-00033160: 2054 4f44 4f28 646f 796f 756e 6729 3a20   TODO(doyoung): 
-00033170: 4164 6420 7465 7374 2066 6f72 2049 424d  Add test for IBM
-00033180: 2043 4f53 2e20 4375 7272 656e 746c 792c   COS. Currently,
-00033190: 2074 6869 7320 6973 2062 6c6f 636b 6564   this is blocked
-000331a0: 0a20 2020 2020 2020 2023 2061 7320 7263  .        # as rc
-000331b0: 6c6f 6e65 2075 7365 6420 746f 2069 6e74  lone used to int
-000331c0: 6572 6163 7420 7769 7468 2049 424d 2043  eract with IBM C
-000331d0: 4f53 2064 6f65 7320 6e6f 7420 7375 7070  OS does not supp
-000331e0: 6f72 7420 6665 6174 7572 6520 746f 0a20  ort feature to. 
-000331f0: 2020 2020 2020 2023 2063 7265 6174 6520         # create 
-00033200: 6120 6275 636b 6574 2c20 616e 6420 7468  a bucket, and th
-00033210: 6520 6962 6d63 6c6f 7564 2043 4c49 2069  e ibmcloud CLI i
-00033220: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
-00033230: 696e 2053 6b79 7069 6c6f 742e 0a20 2020  in Skypilot..   
-00033240: 2020 2020 2023 2045 6974 6865 7220 6f66       # Either of
-00033250: 2074 6865 2066 6561 7475 7265 2069 7320   the feature is 
-00033260: 6e65 6365 7373 6172 7920 746f 2073 696d  necessary to sim
-00033270: 756c 6174 6520 616e 2065 7874 6572 6e61  ulate an externa
-00033280: 6c20 6275 636b 6574 0a20 2020 2020 2020  l bucket.       
-00033290: 2023 2063 7265 6174 696f 6e20 666f 7220   # creation for 
-000332a0: 4942 4d20 434f 532e 0a20 2020 2020 2020  IBM COS..       
-000332b0: 2023 2068 7474 7073 3a2f 2f67 6974 6875   # https://githu
-000332c0: 622e 636f 6d2f 736b 7970 696c 6f74 2d6f  b.com/skypilot-o
-000332d0: 7267 2f73 6b79 7069 6c6f 742f 7075 6c6c  rg/skypilot/pull
-000332e0: 2f31 3936 362f 6669 6c65 7323 7231 3235  /1966/files#r125
-000332f0: 3334 3339 3833 370a 0a20 2020 2020 2020  3439837..       
-00033300: 2065 7874 5f62 7563 6b65 745f 6e61 6d65   ext_bucket_name
-00033310: 2c20 6578 745f 6275 636b 6574 5f75 7269  , ext_bucket_uri
-00033320: 203d 2072 6571 7565 7374 2e67 6574 6669   = request.getfi
-00033330: 7874 7572 6576 616c 7565 280a 2020 2020  xturevalue(.    
-00033340: 2020 2020 2020 2020 6578 745f 6275 636b          ext_buck
-00033350: 6574 5f66 6978 7475 7265 290a 2020 2020  et_fixture).    
-00033360: 2020 2020 2320 696e 7661 6c69 6420 7370      # invalid sp
-00033370: 6563 0a20 2020 2020 2020 2077 6974 6820  ec.        with 
-00033380: 7079 7465 7374 2e72 6169 7365 7328 736b  pytest.raises(sk
-00033390: 792e 6578 6365 7074 696f 6e73 2e53 746f  y.exceptions.Sto
-000333a0: 7261 6765 5370 6563 4572 726f 7229 2061  rageSpecError) a
-000333b0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-000333c0: 2073 746f 7261 6765 5f6f 626a 203d 2073   storage_obj = s
-000333d0: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-000333e0: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-000333f0: 2020 2020 6e61 6d65 3d65 7874 5f62 7563      name=ext_buc
-00033400: 6b65 745f 6e61 6d65 2c20 6d6f 6465 3d73  ket_name, mode=s
-00033410: 746f 7261 6765 5f6c 6962 2e53 746f 7261  torage_lib.Stora
-00033420: 6765 4d6f 6465 2e4d 4f55 4e54 290a 2020  geMode.MOUNT).  
-00033430: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00033440: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-00033450: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
-00033460: 2020 2020 2061 7373 6572 7420 2741 7474       assert 'Att
-00033470: 656d 7074 6564 2074 6f20 6d6f 756e 7420  empted to mount 
-00033480: 6120 6e6f 6e2d 736b 7920 6d61 6e61 6765  a non-sky manage
-00033490: 6420 6275 636b 6574 2720 696e 2073 7472  d bucket' in str
-000334a0: 2865 290a 0a20 2020 2020 2020 2023 2076  (e)..        # v
-000334b0: 616c 6964 2073 7065 630a 2020 2020 2020  alid spec.      
-000334c0: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
-000334d0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-000334e0: 6167 6528 736f 7572 6365 3d65 7874 5f62  age(source=ext_b
-000334f0: 7563 6b65 745f 7572 692c 0a20 2020 2020  ucket_uri,.     
-00033500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033520: 2020 2020 206d 6f64 653d 7374 6f72 6167       mode=storag
-00033530: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-00033540: 652e 4d4f 554e 5429 0a20 2020 2020 2020  e.MOUNT).       
-00033550: 2068 616e 646c 6520 3d20 676c 6f62 616c   handle = global
-00033560: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-00033570: 6861 6e64 6c65 5f66 726f 6d5f 7374 6f72  handle_from_stor
-00033580: 6167 655f 6e61 6d65 280a 2020 2020 2020  age_name(.      
-00033590: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-000335a0: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
-000335b0: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
-000335c0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-000335d0: 626a 2e64 656c 6574 6528 290a 0a20 2020  bj.delete()..   
-000335e0: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
-000335f0: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
-00033600: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-00033610: 616d 6574 7269 7a65 2827 7265 6769 6f6e  ametrize('region
-00033620: 272c 205b 0a20 2020 2020 2020 2027 6170  ', [.        'ap
-00033630: 2d6e 6f72 7468 6561 7374 2d31 272c 2027  -northeast-1', '
-00033640: 6170 2d6e 6f72 7468 6561 7374 2d32 272c  ap-northeast-2',
-00033650: 2027 6170 2d6e 6f72 7468 6561 7374 2d33   'ap-northeast-3
-00033660: 272c 2027 6170 2d73 6f75 7468 2d31 272c  ', 'ap-south-1',
-00033670: 0a20 2020 2020 2020 2027 6170 2d73 6f75  .        'ap-sou
-00033680: 7468 6561 7374 2d31 272c 2027 6170 2d73  theast-1', 'ap-s
-00033690: 6f75 7468 6561 7374 2d32 272c 2027 6575  outheast-2', 'eu
-000336a0: 2d63 656e 7472 616c 2d31 272c 2027 6575  -central-1', 'eu
-000336b0: 2d6e 6f72 7468 2d31 272c 0a20 2020 2020  -north-1',.     
-000336c0: 2020 2027 6575 2d77 6573 742d 3127 2c20     'eu-west-1', 
-000336d0: 2765 752d 7765 7374 2d32 272c 2027 6575  'eu-west-2', 'eu
-000336e0: 2d77 6573 742d 3327 2c20 2773 612d 6561  -west-3', 'sa-ea
-000336f0: 7374 2d31 272c 2027 7573 2d65 6173 742d  st-1', 'us-east-
-00033700: 3127 2c0a 2020 2020 2020 2020 2775 732d  1',.        'us-
-00033710: 6561 7374 2d32 272c 2027 7573 2d77 6573  east-2', 'us-wes
-00033720: 742d 3127 2c20 2775 732d 7765 7374 2d32  t-1', 'us-west-2
-00033730: 270a 2020 2020 5d29 0a20 2020 2064 6566  '.    ]).    def
-00033740: 2074 6573 745f 6177 735f 7265 6769 6f6e   test_aws_region
-00033750: 7328 7365 6c66 2c20 746d 705f 6c6f 6361  s(self, tmp_loca
-00033760: 6c5f 7374 6f72 6167 655f 6f62 6a2c 2072  l_storage_obj, r
-00033770: 6567 696f 6e29 3a0a 2020 2020 2020 2020  egion):.        
-00033780: 2320 5468 6973 2074 6573 7473 2063 7265  # This tests cre
-00033790: 6174 696f 6e20 616e 6420 7570 6c6f 6164  ation and upload
-000337a0: 2074 6f20 6275 636b 6574 2069 6e20 616c   to bucket in al
-000337b0: 6c20 4157 5320 7333 2072 6567 696f 6e73  l AWS s3 regions
-000337c0: 0a20 2020 2020 2020 2023 2054 6f20 7465  .        # To te
-000337d0: 7374 2066 756c 6c20 6675 6e63 7469 6f6e  st full function
-000337e0: 616c 6974 792c 2075 7365 2074 6573 745f  ality, use test_
-000337f0: 6d61 6e61 6765 645f 6a6f 6273 5f73 746f  managed_jobs_sto
-00033800: 7261 6765 2061 626f 7665 2e0a 2020 2020  rage above..    
-00033810: 2020 2020 7374 6f72 655f 7479 7065 203d      store_type =
-00033820: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00033830: 7265 5479 7065 2e53 330a 2020 2020 2020  reType.S3.      
-00033840: 2020 746d 705f 6c6f 6361 6c5f 7374 6f72    tmp_local_stor
-00033850: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
-00033860: 6528 7374 6f72 655f 7479 7065 2c20 7265  e(store_type, re
-00033870: 6769 6f6e 3d72 6567 696f 6e29 0a20 2020  gion=region).   
-00033880: 2020 2020 2062 7563 6b65 745f 6e61 6d65       bucket_name
-00033890: 203d 2074 6d70 5f6c 6f63 616c 5f73 746f   = tmp_local_sto
-000338a0: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
-000338b0: 2020 2020 2020 2023 2043 6f6e 6669 726d         # Confirm
-000338c0: 2074 6861 7420 7468 6520 6275 636b 6574   that the bucket
-000338d0: 2077 6173 2063 7265 6174 6564 2069 6e20   was created in 
-000338e0: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
-000338f0: 6f6e 0a20 2020 2020 2020 2072 6567 696f  on.        regio
-00033900: 6e5f 636d 6420 3d20 7365 6c66 2e63 6c69  n_cmd = self.cli
-00033910: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
-00033920: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
-00033930: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
-00033940: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-00033950: 6563 6b5f 6f75 7470 7574 2872 6567 696f  eck_output(regio
-00033960: 6e5f 636d 642c 2073 6865 6c6c 3d54 7275  n_cmd, shell=Tru
-00033970: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
-00033980: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
-00033990: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
-000339a0: 6578 7065 6374 6564 5f6f 7574 7075 745f  expected_output_
-000339b0: 7265 6769 6f6e 203d 2072 6567 696f 6e0a  region = region.
-000339c0: 2020 2020 2020 2020 6966 2072 6567 696f          if regio
-000339d0: 6e20 3d3d 2027 7573 2d65 6173 742d 3127  n == 'us-east-1'
-000339e0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-000339f0: 7065 6374 6564 5f6f 7574 7075 745f 7265  pected_output_re
-00033a00: 6769 6f6e 203d 2027 4e6f 6e65 2720 2023  gion = 'None'  #
-00033a10: 2075 732d 6561 7374 2d31 2069 7320 7468   us-east-1 is th
-00033a20: 6520 6465 6661 756c 7420 7265 6769 6f6e  e default region
-00033a30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00033a40: 6578 7065 6374 6564 5f6f 7574 7075 745f  expected_output_
-00033a50: 7265 6769 6f6e 2069 6e20 6f75 742e 6465  region in out.de
-00033a60: 636f 6465 2827 7574 662d 3827 292c 2028  code('utf-8'), (
-00033a70: 0a20 2020 2020 2020 2020 2020 2066 2742  .            f'B
-00033a80: 7563 6b65 7420 7761 7320 6e6f 7420 666f  ucket was not fo
-00033a90: 756e 6420 696e 2072 6567 696f 6e20 7b72  und in region {r
-00033aa0: 6567 696f 6e7d 202d 2027 0a20 2020 2020  egion} - '.     
-00033ab0: 2020 2020 2020 2066 276f 7574 7075 7420         f'output 
-00033ac0: 6f66 207b 7265 6769 6f6e 5f63 6d64 7d20  of {region_cmd} 
-00033ad0: 7761 733a 207b 6f75 7470 7574 7d27 290a  was: {output}').
-00033ae0: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00033af0: 2069 6620 746d 705f 736f 7572 6365 2f74   if tmp_source/t
-00033b00: 6d70 2d66 696c 6520 6578 6973 7473 2069  mp-file exists i
-00033b10: 6e20 7468 6520 6275 636b 6574 2075 7369  n the bucket usi
-00033b20: 6e67 2063 6c69 0a20 2020 2020 2020 206c  ng cli.        l
-00033b30: 735f 636d 6420 3d20 7365 6c66 2e63 6c69  s_cmd = self.cli
-00033b40: 5f6c 735f 636d 6428 7374 6f72 655f 7479  _ls_cmd(store_ty
-00033b50: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
-00033b60: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-00033b70: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00033b80: 6f75 7470 7574 286c 735f 636d 642c 2073  output(ls_cmd, s
-00033b90: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-00033ba0: 2020 206f 7574 7075 7420 3d20 6f75 742e     output = out.
-00033bb0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-00033bc0: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-00033bd0: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
-00033be0: 7075 742c 2028 0a20 2020 2020 2020 2020  put, (.         
-00033bf0: 2020 2066 2774 6d70 2d66 696c 6520 6e6f     f'tmp-file no
-00033c00: 7420 666f 756e 6420 696e 2062 7563 6b65  t found in bucke
-00033c10: 7420 2d20 6f75 7470 7574 206f 6620 7b6c  t - output of {l
-00033c20: 735f 636d 647d 2077 6173 3a20 7b6f 7574  s_cmd} was: {out
-00033c30: 7075 747d 2729 0a0a 2020 2020 4070 7974  put}')..    @pyt
-00033c40: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00033c50: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
-00033c60: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00033c70: 697a 6528 2772 6567 696f 6e27 2c20 5b0a  ize('region', [.
-00033c80: 2020 2020 2020 2020 276e 6f72 7468 616d          'northam
-00033c90: 6572 6963 612d 6e6f 7274 6865 6173 7431  erica-northeast1
-00033ca0: 272c 2027 6e6f 7274 6861 6d65 7269 6361  ', 'northamerica
-00033cb0: 2d6e 6f72 7468 6561 7374 3227 2c20 2775  -northeast2', 'u
-00033cc0: 732d 6365 6e74 7261 6c31 272c 0a20 2020  s-central1',.   
-00033cd0: 2020 2020 2027 7573 2d65 6173 7431 272c       'us-east1',
-00033ce0: 2027 7573 2d65 6173 7434 272c 2027 7573   'us-east4', 'us
-00033cf0: 2d65 6173 7435 272c 2027 7573 2d73 6f75  -east5', 'us-sou
-00033d00: 7468 3127 2c20 2775 732d 7765 7374 3127  th1', 'us-west1'
-00033d10: 2c20 2775 732d 7765 7374 3227 2c0a 2020  , 'us-west2',.  
-00033d20: 2020 2020 2020 2775 732d 7765 7374 3327        'us-west3'
-00033d30: 2c20 2775 732d 7765 7374 3427 2c20 2773  , 'us-west4', 's
-00033d40: 6f75 7468 616d 6572 6963 612d 6561 7374  outhamerica-east
-00033d50: 3127 2c20 2773 6f75 7468 616d 6572 6963  1', 'southameric
-00033d60: 612d 7765 7374 3127 2c0a 2020 2020 2020  a-west1',.      
-00033d70: 2020 2765 7572 6f70 652d 6365 6e74 7261    'europe-centra
-00033d80: 6c32 272c 2027 6575 726f 7065 2d6e 6f72  l2', 'europe-nor
-00033d90: 7468 3127 2c20 2765 7572 6f70 652d 736f  th1', 'europe-so
-00033da0: 7574 6877 6573 7431 272c 2027 6575 726f  uthwest1', 'euro
-00033db0: 7065 2d77 6573 7431 272c 0a20 2020 2020  pe-west1',.     
-00033dc0: 2020 2027 6575 726f 7065 2d77 6573 7432     'europe-west2
-00033dd0: 272c 2027 6575 726f 7065 2d77 6573 7433  ', 'europe-west3
-00033de0: 272c 2027 6575 726f 7065 2d77 6573 7434  ', 'europe-west4
-00033df0: 272c 2027 6575 726f 7065 2d77 6573 7436  ', 'europe-west6
-00033e00: 272c 0a20 2020 2020 2020 2027 6575 726f  ',.        'euro
-00033e10: 7065 2d77 6573 7438 272c 2027 6575 726f  pe-west8', 'euro
-00033e20: 7065 2d77 6573 7439 272c 2027 6575 726f  pe-west9', 'euro
-00033e30: 7065 2d77 6573 7431 3027 2c20 2765 7572  pe-west10', 'eur
-00033e40: 6f70 652d 7765 7374 3132 272c 0a20 2020  ope-west12',.   
-00033e50: 2020 2020 2027 6173 6961 2d65 6173 7431       'asia-east1
-00033e60: 272c 2027 6173 6961 2d65 6173 7432 272c  ', 'asia-east2',
-00033e70: 2027 6173 6961 2d6e 6f72 7468 6561 7374   'asia-northeast
-00033e80: 3127 2c20 2761 7369 612d 6e6f 7274 6865  1', 'asia-northe
-00033e90: 6173 7432 272c 0a20 2020 2020 2020 2027  ast2',.        '
-00033ea0: 6173 6961 2d6e 6f72 7468 6561 7374 3327  asia-northeast3'
-00033eb0: 2c20 2761 7369 612d 736f 7574 6865 6173  , 'asia-southeas
-00033ec0: 7431 272c 2027 6173 6961 2d73 6f75 7468  t1', 'asia-south
-00033ed0: 3127 2c20 2761 7369 612d 736f 7574 6832  1', 'asia-south2
-00033ee0: 272c 0a20 2020 2020 2020 2027 6173 6961  ',.        'asia
-00033ef0: 2d73 6f75 7468 6561 7374 3227 2c20 276d  -southeast2', 'm
-00033f00: 652d 6365 6e74 7261 6c31 272c 2027 6d65  e-central1', 'me
-00033f10: 2d63 656e 7472 616c 3227 2c20 276d 652d  -central2', 'me-
-00033f20: 7765 7374 3127 2c0a 2020 2020 2020 2020  west1',.        
-00033f30: 2761 7573 7472 616c 6961 2d73 6f75 7468  'australia-south
-00033f40: 6561 7374 3127 2c20 2761 7573 7472 616c  east1', 'austral
-00033f50: 6961 2d73 6f75 7468 6561 7374 3227 2c20  ia-southeast2', 
-00033f60: 2761 6672 6963 612d 736f 7574 6831 270a  'africa-south1'.
-00033f70: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
-00033f80: 6573 745f 6763 735f 7265 6769 6f6e 7328  est_gcs_regions(
-00033f90: 7365 6c66 2c20 746d 705f 6c6f 6361 6c5f  self, tmp_local_
-00033fa0: 7374 6f72 6167 655f 6f62 6a2c 2072 6567  storage_obj, reg
-00033fb0: 696f 6e29 3a0a 2020 2020 2020 2020 2320  ion):.        # 
-00033fc0: 5468 6973 2074 6573 7473 2063 7265 6174  This tests creat
-00033fd0: 696f 6e20 616e 6420 7570 6c6f 6164 2074  ion and upload t
-00033fe0: 6f20 6275 636b 6574 2069 6e20 616c 6c20  o bucket in all 
-00033ff0: 4743 5320 7265 6769 6f6e 730a 2020 2020  GCS regions.    
-00034000: 2020 2020 2320 546f 2074 6573 7420 6675      # To test fu
-00034010: 6c6c 2066 756e 6374 696f 6e61 6c69 7479  ll functionality
-00034020: 2c20 7573 6520 7465 7374 5f6d 616e 6167  , use test_manag
-00034030: 6564 5f6a 6f62 735f 7374 6f72 6167 6520  ed_jobs_storage 
-00034040: 6162 6f76 652e 0a20 2020 2020 2020 2073  above..        s
-00034050: 746f 7265 5f74 7970 6520 3d20 7374 6f72  tore_type = stor
-00034060: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00034070: 652e 4743 530a 2020 2020 2020 2020 746d  e.GCS.        tm
-00034080: 705f 6c6f 6361 6c5f 7374 6f72 6167 655f  p_local_storage_
-00034090: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-000340a0: 6f72 655f 7479 7065 2c20 7265 6769 6f6e  ore_type, region
-000340b0: 3d72 6567 696f 6e29 0a20 2020 2020 2020  =region).       
-000340c0: 2062 7563 6b65 745f 6e61 6d65 203d 2074   bucket_name = t
-000340d0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-000340e0: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
-000340f0: 2020 2023 2043 6f6e 6669 726d 2074 6861     # Confirm tha
-00034100: 7420 7468 6520 6275 636b 6574 2077 6173  t the bucket was
-00034110: 2063 7265 6174 6564 2069 6e20 7468 6520   created in the 
-00034120: 636f 7272 6563 7420 7265 6769 6f6e 0a20  correct region. 
-00034130: 2020 2020 2020 2072 6567 696f 6e5f 636d         region_cm
-00034140: 6420 3d20 7365 6c66 2e63 6c69 5f72 6567  d = self.cli_reg
-00034150: 696f 6e5f 636d 6428 7374 6f72 655f 7479  ion_cmd(store_ty
-00034160: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
-00034170: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-00034180: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00034190: 6f75 7470 7574 2872 6567 696f 6e5f 636d  output(region_cm
-000341a0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
-000341b0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
-000341c0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-000341d0: 3827 290a 2020 2020 2020 2020 6173 7365  8').        asse
-000341e0: 7274 2072 6567 696f 6e20 696e 206f 7574  rt region in out
-000341f0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00034200: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00034210: 6627 4275 636b 6574 2077 6173 206e 6f74  f'Bucket was not
-00034220: 2066 6f75 6e64 2069 6e20 7265 6769 6f6e   found in region
-00034230: 207b 7265 6769 6f6e 7d20 2d20 270a 2020   {region} - '.  
-00034240: 2020 2020 2020 2020 2020 6627 6f75 7470            f'outp
-00034250: 7574 206f 6620 7b72 6567 696f 6e5f 636d  ut of {region_cm
-00034260: 647d 2077 6173 3a20 7b6f 7574 7075 747d  d} was: {output}
-00034270: 2729 0a0a 2020 2020 2020 2020 2320 4368  ')..        # Ch
-00034280: 6563 6b20 6966 2074 6d70 5f73 6f75 7263  eck if tmp_sourc
-00034290: 652f 746d 702d 6669 6c65 2065 7869 7374  e/tmp-file exist
-000342a0: 7320 696e 2074 6865 2062 7563 6b65 7420  s in the bucket 
-000342b0: 7573 696e 6720 636c 690a 2020 2020 2020  using cli.      
-000342c0: 2020 6c73 5f63 6d64 203d 2073 656c 662e    ls_cmd = self.
-000342d0: 636c 695f 6c73 5f63 6d64 2873 746f 7265  cli_ls_cmd(store
-000342e0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
-000342f0: 6d65 290a 2020 2020 2020 2020 6f75 7420  me).        out 
-00034300: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00034310: 636b 5f6f 7574 7075 7428 6c73 5f63 6d64  ck_output(ls_cmd
-00034320: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
-00034330: 2020 2020 2020 6f75 7470 7574 203d 206f        output = o
-00034340: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00034350: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
-00034360: 7420 2774 6d70 2d66 696c 6527 2069 6e20  t 'tmp-file' in 
-00034370: 6f75 7470 7574 2c20 280a 2020 2020 2020  output, (.      
-00034380: 2020 2020 2020 6627 746d 702d 6669 6c65        f'tmp-file
-00034390: 206e 6f74 2066 6f75 6e64 2069 6e20 6275   not found in bu
-000343a0: 636b 6574 202d 206f 7574 7075 7420 6f66  cket - output of
-000343b0: 207b 6c73 5f63 6d64 7d20 7761 733a 207b   {ls_cmd} was: {
-000343c0: 6f75 7470 7574 7d27 290a 0a0a 2320 2d2d  output}')...# --
-000343d0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-000343e0: 2059 414d 4c20 5370 6563 7320 2d2d 2d2d   YAML Specs ----
-000343f0: 2d2d 2d2d 2d2d 0a23 204f 7572 2073 6b79  ------.# Our sky
-00034400: 2073 746f 7261 6765 2072 6571 7569 7265   storage require
-00034410: 7320 6372 6564 656e 7469 616c 7320 746f  s credentials to
-00034420: 2063 6865 636b 2074 6865 2062 7563 6b65   check the bucke
-00034430: 7420 6578 6973 7461 6e63 6520 7768 656e  t existance when
-00034440: 0a23 206c 6f61 6469 6e67 2061 2074 6173  .# loading a tas
-00034450: 6b20 6672 6f6d 2074 6865 2079 616d 6c20  k from the yaml 
-00034460: 6669 6c65 2c20 736f 2077 6520 6361 6e6e  file, so we cann
-00034470: 6f74 206d 616b 6520 6974 2061 2075 6e69  ot make it a uni
-00034480: 7420 7465 7374 2e0a 636c 6173 7320 5465  t test..class Te
-00034490: 7374 5961 6d6c 5370 6563 733a 0a20 2020  stYamlSpecs:.   
-000344a0: 2023 2054 4f44 4f28 7a68 7775 293a 2041   # TODO(zhwu): A
-000344b0: 6464 2074 6573 7420 666f 7220 6074 6f5f  dd test for `to_
-000344c0: 7961 6d6c 5f63 6f6e 6669 6760 2066 6f72  yaml_config` for
-000344d0: 2074 6865 2053 746f 7261 6765 206f 626a   the Storage obj
-000344e0: 6563 742e 0a20 2020 2023 2020 5765 2073  ect..    #  We s
-000344f0: 686f 756c 6420 6e6f 7420 7573 6520 6065  hould not use `e
-00034500: 7861 6d70 6c65 732f 7374 6f72 6167 655f  xamples/storage_
-00034510: 6465 6d6f 2e79 616d 6c60 2068 6572 652c  demo.yaml` here,
-00034520: 2073 696e 6365 2069 7420 7265 7175 6972   since it requir
-00034530: 6573 0a20 2020 2023 2020 7573 6572 7320  es.    #  users 
-00034540: 746f 2065 6e73 7572 6520 6275 636b 6574  to ensure bucket
-00034550: 206e 616d 6573 2074 6f20 6e6f 7420 6578   names to not ex
-00034560: 6973 7420 616e 642f 6f72 2062 6520 756e  ist and/or be un
-00034570: 6971 7565 2e0a 2020 2020 5f54 4553 545f  ique..    _TEST_
-00034580: 5941 4d4c 5f50 4154 4853 203d 205b 0a20  YAML_PATHS = [. 
-00034590: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
-000345a0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c20  /minimal.yaml', 
-000345b0: 2765 7861 6d70 6c65 732f 6d61 6e61 6765  'examples/manage
-000345c0: 645f 6a6f 622e 7961 6d6c 272c 0a20 2020  d_job.yaml',.   
-000345d0: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
-000345e0: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
-000345f0: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
-00034600: 732f 7265 736e 6574 5f61 7070 2e79 616d  s/resnet_app.yam
-00034610: 6c27 2c0a 2020 2020 2020 2020 2765 7861  l',.        'exa
-00034620: 6d70 6c65 732f 6d75 6c74 695f 686f 7374  mples/multi_host
-00034630: 6e61 6d65 2e79 616d 6c27 0a20 2020 205d  name.yaml'.    ]
-00034640: 0a0a 2020 2020 6465 6620 5f69 735f 6469  ..    def _is_di
-00034650: 6374 5f73 7562 7365 7428 7365 6c66 2c20  ct_subset(self, 
-00034660: 6431 2c20 6432 293a 0a20 2020 2020 2020  d1, d2):.       
-00034670: 2022 2222 4368 6563 6b20 6966 2064 3120   """Check if d1 
-00034680: 6973 2074 6865 2073 7562 7365 7420 6f66  is the subset of
-00034690: 2064 322e 2222 220a 2020 2020 2020 2020   d2.""".        
-000346a0: 666f 7220 6b2c 2076 2069 6e20 6431 2e69  for k, v in d1.i
-000346b0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-000346c0: 2020 2020 6966 206b 206e 6f74 2069 6e20      if k not in 
-000346d0: 6432 3a0a 2020 2020 2020 2020 2020 2020  d2:.            
-000346e0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000346f0: 6528 762c 206c 6973 7429 206f 7220 6973  e(v, list) or is
-00034700: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
-00034710: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00034720: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00034730: 6e28 7629 203d 3d20 302c 2028 6b2c 2076  n(v) == 0, (k, v
-00034740: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00034750: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00034760: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00034770: 7274 2046 616c 7365 2c20 286b 2c20 7629  rt False, (k, v)
-00034780: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00034790: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-000347a0: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
-000347b0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-000347c0: 696e 7374 616e 6365 2864 325b 6b5d 2c20  instance(d2[k], 
-000347d0: 6469 6374 292c 2028 6b2c 2076 2c20 6432  dict), (k, v, d2
-000347e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000347f0: 2020 7365 6c66 2e5f 6973 5f64 6963 745f    self._is_dict_
-00034800: 7375 6273 6574 2876 2c20 6432 5b6b 5d29  subset(v, d2[k])
-00034810: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00034820: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-00034830: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
-00034840: 2020 2020 2020 6966 206b 203d 3d20 2761        if k == 'a
-00034850: 6363 656c 6572 6174 6f72 7327 3a0a 2020  ccelerators':.  
-00034860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034870: 2020 7265 736f 7572 6365 7320 3d20 736b    resources = sk
-00034880: 792e 5265 736f 7572 6365 7328 290a 2020  y.Resources().  
-00034890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000348a0: 2020 7265 736f 7572 6365 732e 5f73 6574    resources._set
-000348b0: 5f61 6363 656c 6572 6174 6f72 7328 762c  _accelerators(v,
-000348c0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+00032f90: 205b 2827 746d 705f 6177 7363 6c69 5f62   [('tmp_awscli_b
+00032fa0: 7563 6b65 7427 2c20 7374 6f72 6167 655f  ucket', storage_
+00032fb0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+00032fc0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00032fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032fe0: 2028 2774 6d70 5f67 7375 7469 6c5f 6275   ('tmp_gsutil_bu
+00032ff0: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00033000: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+00033010: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00033020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033030: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+00033040: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00033050: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+00033060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033080: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00033090: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+000330a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330c0: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+000330d0: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000330e0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000330f0: 7374 5f65 7874 6572 6e61 6c6c 795f 6372  st_externally_cr
+00033100: 6561 7465 645f 6275 636b 6574 5f6d 6f75  eated_bucket_mou
+00033110: 6e74 5f77 6974 686f 7574 5f73 6f75 7263  nt_without_sourc
+00033120: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+00033130: 656c 662c 2065 7874 5f62 7563 6b65 745f  elf, ext_bucket_
+00033140: 6669 7874 7572 652c 2072 6571 7565 7374  fixture, request
+00033150: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+00033160: 2020 2020 2020 2023 204e 6f6e 2d73 6b79         # Non-sky
+00033170: 206d 616e 6167 6564 2062 7563 6b65 7473   managed buckets
+00033180: 2862 7563 6b65 7473 2063 7265 6174 6564  (buckets created
+00033190: 206f 7574 7369 6465 206f 6620 536b 7970   outside of Skyp
+000331a0: 696c 6f74 2043 4c49 290a 2020 2020 2020  ilot CLI).      
+000331b0: 2020 2320 6172 6520 616c 6c6f 7765 6420    # are allowed 
+000331c0: 746f 2062 6520 4d4f 554e 5465 6420 6279  to be MOUNTed by
+000331d0: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
+000331e0: 5552 4920 6f66 2074 6865 2062 7563 6b65  URI of the bucke
+000331f0: 7420 746f 0a20 2020 2020 2020 2023 2073  t to.        # s
+00033200: 6f75 7263 6520 6669 656c 6420 6f6e 6c79  ource field only
+00033210: 2e20 5768 656e 2069 7420 6973 2061 7474  . When it is att
+00033220: 656d 7074 6564 2062 7920 7370 6563 6966  empted by specif
+00033230: 7969 6e67 2074 6865 206e 616d 6520 6f66  ying the name of
+00033240: 0a20 2020 2020 2020 2023 2074 6865 2062  .        # the b
+00033250: 7563 6b65 7420 6f6e 6c79 2c20 6974 2073  ucket only, it s
+00033260: 686f 756c 6420 6572 726f 7220 6f75 742e  hould error out.
+00033270: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00033280: 2020 2023 2054 4f44 4f28 646f 796f 756e     # TODO(doyoun
+00033290: 6729 3a20 4164 6420 7465 7374 2066 6f72  g): Add test for
+000332a0: 2049 424d 2043 4f53 2e20 4375 7272 656e   IBM COS. Curren
+000332b0: 746c 792c 2074 6869 7320 6973 2062 6c6f  tly, this is blo
+000332c0: 636b 6564 0a20 2020 2020 2020 2023 2061  cked.        # a
+000332d0: 7320 7263 6c6f 6e65 2075 7365 6420 746f  s rclone used to
+000332e0: 2069 6e74 6572 6163 7420 7769 7468 2049   interact with I
+000332f0: 424d 2043 4f53 2064 6f65 7320 6e6f 7420  BM COS does not 
+00033300: 7375 7070 6f72 7420 6665 6174 7572 6520  support feature 
+00033310: 746f 0a20 2020 2020 2020 2023 2063 7265  to.        # cre
+00033320: 6174 6520 6120 6275 636b 6574 2c20 616e  ate a bucket, an
+00033330: 6420 7468 6520 6962 6d63 6c6f 7564 2043  d the ibmcloud C
+00033340: 4c49 2069 7320 6e6f 7420 7375 7070 6f72  LI is not suppor
+00033350: 7465 6420 696e 2053 6b79 7069 6c6f 742e  ted in Skypilot.
+00033360: 0a20 2020 2020 2020 2023 2045 6974 6865  .        # Eithe
+00033370: 7220 6f66 2074 6865 2066 6561 7475 7265  r of the feature
+00033380: 2069 7320 6e65 6365 7373 6172 7920 746f   is necessary to
+00033390: 2073 696d 756c 6174 6520 616e 2065 7874   simulate an ext
+000333a0: 6572 6e61 6c20 6275 636b 6574 0a20 2020  ernal bucket.   
+000333b0: 2020 2020 2023 2063 7265 6174 696f 6e20       # creation 
+000333c0: 666f 7220 4942 4d20 434f 532e 0a20 2020  for IBM COS..   
+000333d0: 2020 2020 2023 2068 7474 7073 3a2f 2f67       # https://g
+000333e0: 6974 6875 622e 636f 6d2f 736b 7970 696c  ithub.com/skypil
+000333f0: 6f74 2d6f 7267 2f73 6b79 7069 6c6f 742f  ot-org/skypilot/
+00033400: 7075 6c6c 2f31 3936 362f 6669 6c65 7323  pull/1966/files#
+00033410: 7231 3235 3334 3339 3833 370a 0a20 2020  r1253439837..   
+00033420: 2020 2020 2065 7874 5f62 7563 6b65 745f       ext_bucket_
+00033430: 6e61 6d65 2c20 6578 745f 6275 636b 6574  name, ext_bucket
+00033440: 5f75 7269 203d 2072 6571 7565 7374 2e67  _uri = request.g
+00033450: 6574 6669 7874 7572 6576 616c 7565 280a  etfixturevalue(.
+00033460: 2020 2020 2020 2020 2020 2020 6578 745f              ext_
+00033470: 6275 636b 6574 5f66 6978 7475 7265 290a  bucket_fixture).
+00033480: 2020 2020 2020 2020 2320 696e 7661 6c69          # invali
+00033490: 6420 7370 6563 0a20 2020 2020 2020 2077  d spec.        w
+000334a0: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
+000334b0: 7328 736b 792e 6578 6365 7074 696f 6e73  s(sky.exceptions
+000334c0: 2e53 746f 7261 6765 5370 6563 4572 726f  .StorageSpecErro
+000334d0: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+000334e0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+000334f0: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
+00033500: 746f 7261 6765 280a 2020 2020 2020 2020  torage(.        
+00033510: 2020 2020 2020 2020 6e61 6d65 3d65 7874          name=ext
+00033520: 5f62 7563 6b65 745f 6e61 6d65 2c20 6d6f  _bucket_name, mo
+00033530: 6465 3d73 746f 7261 6765 5f6c 6962 2e53  de=storage_lib.S
+00033540: 746f 7261 6765 4d6f 6465 2e4d 4f55 4e54  torageMode.MOUNT
+00033550: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+00033560: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+00033570: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+00033580: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00033590: 2741 7474 656d 7074 6564 2074 6f20 6d6f  'Attempted to mo
+000335a0: 756e 7420 6120 6e6f 6e2d 736b 7920 6d61  unt a non-sky ma
+000335b0: 6e61 6765 6420 6275 636b 6574 2720 696e  naged bucket' in
+000335c0: 2073 7472 2865 290a 0a20 2020 2020 2020   str(e)..       
+000335d0: 2023 2076 616c 6964 2073 7065 630a 2020   # valid spec.  
+000335e0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+000335f0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+00033600: 5374 6f72 6167 6528 736f 7572 6365 3d65  Storage(source=e
+00033610: 7874 5f62 7563 6b65 745f 7572 692c 0a20  xt_bucket_uri,. 
+00033620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033640: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+00033650: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00033660: 654d 6f64 652e 4d4f 554e 5429 0a20 2020  eMode.MOUNT).   
+00033670: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+00033680: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00033690: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+000336a0: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+000336b0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+000336c0: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+000336d0: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+000336e0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000336f0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+00033700: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00033710: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+00033720: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00033730: 2e70 6172 616d 6574 7269 7a65 2827 7265  .parametrize('re
+00033740: 6769 6f6e 272c 205b 0a20 2020 2020 2020  gion', [.       
+00033750: 2027 6170 2d6e 6f72 7468 6561 7374 2d31   'ap-northeast-1
+00033760: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
+00033770: 2d32 272c 2027 6170 2d6e 6f72 7468 6561  -2', 'ap-northea
+00033780: 7374 2d33 272c 2027 6170 2d73 6f75 7468  st-3', 'ap-south
+00033790: 2d31 272c 0a20 2020 2020 2020 2027 6170  -1',.        'ap
+000337a0: 2d73 6f75 7468 6561 7374 2d31 272c 2027  -southeast-1', '
+000337b0: 6170 2d73 6f75 7468 6561 7374 2d32 272c  ap-southeast-2',
+000337c0: 2027 6575 2d63 656e 7472 616c 2d31 272c   'eu-central-1',
+000337d0: 2027 6575 2d6e 6f72 7468 2d31 272c 0a20   'eu-north-1',. 
+000337e0: 2020 2020 2020 2027 6575 2d77 6573 742d         'eu-west-
+000337f0: 3127 2c20 2765 752d 7765 7374 2d32 272c  1', 'eu-west-2',
+00033800: 2027 6575 2d77 6573 742d 3327 2c20 2773   'eu-west-3', 's
+00033810: 612d 6561 7374 2d31 272c 2027 7573 2d65  a-east-1', 'us-e
+00033820: 6173 742d 3127 2c0a 2020 2020 2020 2020  ast-1',.        
+00033830: 2775 732d 6561 7374 2d32 272c 2027 7573  'us-east-2', 'us
+00033840: 2d77 6573 742d 3127 2c20 2775 732d 7765  -west-1', 'us-we
+00033850: 7374 2d32 270a 2020 2020 5d29 0a20 2020  st-2'.    ]).   
+00033860: 2064 6566 2074 6573 745f 6177 735f 7265   def test_aws_re
+00033870: 6769 6f6e 7328 7365 6c66 2c20 746d 705f  gions(self, tmp_
+00033880: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+00033890: 6a2c 2072 6567 696f 6e29 3a0a 2020 2020  j, region):.    
+000338a0: 2020 2020 2320 5468 6973 2074 6573 7473      # This tests
+000338b0: 2063 7265 6174 696f 6e20 616e 6420 7570   creation and up
+000338c0: 6c6f 6164 2074 6f20 6275 636b 6574 2069  load to bucket i
+000338d0: 6e20 616c 6c20 4157 5320 7333 2072 6567  n all AWS s3 reg
+000338e0: 696f 6e73 0a20 2020 2020 2020 2023 2054  ions.        # T
+000338f0: 6f20 7465 7374 2066 756c 6c20 6675 6e63  o test full func
+00033900: 7469 6f6e 616c 6974 792c 2075 7365 2074  tionality, use t
+00033910: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+00033920: 5f73 746f 7261 6765 2061 626f 7665 2e0a  _storage above..
+00033930: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+00033940: 7065 203d 2073 746f 7261 6765 5f6c 6962  pe = storage_lib
+00033950: 2e53 746f 7265 5479 7065 2e53 330a 2020  .StoreType.S3.  
+00033960: 2020 2020 2020 746d 705f 6c6f 6361 6c5f        tmp_local_
+00033970: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+00033980: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+00033990: 2c20 7265 6769 6f6e 3d72 6567 696f 6e29  , region=region)
+000339a0: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+000339b0: 6e61 6d65 203d 2074 6d70 5f6c 6f63 616c  name = tmp_local
+000339c0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+000339d0: 650a 0a20 2020 2020 2020 2023 2043 6f6e  e..        # Con
+000339e0: 6669 726d 2074 6861 7420 7468 6520 6275  firm that the bu
+000339f0: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
+00033a00: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
+00033a10: 7265 6769 6f6e 0a20 2020 2020 2020 2072  region.        r
+00033a20: 6567 696f 6e5f 636d 6420 3d20 7365 6c66  egion_cmd = self
+00033a30: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+00033a40: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00033a50: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+00033a60: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00033a70: 732e 6368 6563 6b5f 6f75 7470 7574 2872  s.check_output(r
+00033a80: 6567 696f 6e5f 636d 642c 2073 6865 6c6c  egion_cmd, shell
+00033a90: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
+00033aa0: 7574 7075 7420 3d20 6f75 742e 6465 636f  utput = out.deco
+00033ab0: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+00033ac0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
+00033ad0: 7075 745f 7265 6769 6f6e 203d 2072 6567  put_region = reg
+00033ae0: 696f 6e0a 2020 2020 2020 2020 6966 2072  ion.        if r
+00033af0: 6567 696f 6e20 3d3d 2027 7573 2d65 6173  egion == 'us-eas
+00033b00: 742d 3127 3a0a 2020 2020 2020 2020 2020  t-1':.          
+00033b10: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
+00033b20: 745f 7265 6769 6f6e 203d 2027 4e6f 6e65  t_region = 'None
+00033b30: 2720 2023 2075 732d 6561 7374 2d31 2069  '  # us-east-1 i
+00033b40: 7320 7468 6520 6465 6661 756c 7420 7265  s the default re
+00033b50: 6769 6f6e 0a20 2020 2020 2020 2061 7373  gion.        ass
+00033b60: 6572 7420 6578 7065 6374 6564 5f6f 7574  ert expected_out
+00033b70: 7075 745f 7265 6769 6f6e 2069 6e20 6f75  put_region in ou
+00033b80: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00033b90: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+00033ba0: 2066 2742 7563 6b65 7420 7761 7320 6e6f   f'Bucket was no
+00033bb0: 7420 666f 756e 6420 696e 2072 6567 696f  t found in regio
+00033bc0: 6e20 7b72 6567 696f 6e7d 202d 2027 0a20  n {region} - '. 
+00033bd0: 2020 2020 2020 2020 2020 2066 276f 7574             f'out
+00033be0: 7075 7420 6f66 207b 7265 6769 6f6e 5f63  put of {region_c
+00033bf0: 6d64 7d20 7761 733a 207b 6f75 7470 7574  md} was: {output
+00033c00: 7d27 290a 0a20 2020 2020 2020 2023 2043  }')..        # C
+00033c10: 6865 636b 2069 6620 746d 705f 736f 7572  heck if tmp_sour
+00033c20: 6365 2f74 6d70 2d66 696c 6520 6578 6973  ce/tmp-file exis
+00033c30: 7473 2069 6e20 7468 6520 6275 636b 6574  ts in the bucket
+00033c40: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00033c50: 2020 206c 735f 636d 6420 3d20 7365 6c66     ls_cmd = self
+00033c60: 2e63 6c69 5f6c 735f 636d 6428 7374 6f72  .cli_ls_cmd(stor
+00033c70: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00033c80: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+00033c90: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+00033ca0: 6563 6b5f 6f75 7470 7574 286c 735f 636d  eck_output(ls_cm
+00033cb0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
+00033cc0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+00033cd0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00033ce0: 3827 290a 2020 2020 2020 2020 6173 7365  8').        asse
+00033cf0: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
+00033d00: 206f 7574 7075 742c 2028 0a20 2020 2020   output, (.     
+00033d10: 2020 2020 2020 2066 2774 6d70 2d66 696c         f'tmp-fil
+00033d20: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00033d30: 7563 6b65 7420 2d20 6f75 7470 7574 206f  ucket - output o
+00033d40: 6620 7b6c 735f 636d 647d 2077 6173 3a20  f {ls_cmd} was: 
+00033d50: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
+00033d60: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00033d70: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00033d80: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00033d90: 6d65 7472 697a 6528 2772 6567 696f 6e27  metrize('region'
+00033da0: 2c20 5b0a 2020 2020 2020 2020 276e 6f72  , [.        'nor
+00033db0: 7468 616d 6572 6963 612d 6e6f 7274 6865  thamerica-northe
+00033dc0: 6173 7431 272c 2027 6e6f 7274 6861 6d65  ast1', 'northame
+00033dd0: 7269 6361 2d6e 6f72 7468 6561 7374 3227  rica-northeast2'
+00033de0: 2c20 2775 732d 6365 6e74 7261 6c31 272c  , 'us-central1',
+00033df0: 0a20 2020 2020 2020 2027 7573 2d65 6173  .        'us-eas
+00033e00: 7431 272c 2027 7573 2d65 6173 7434 272c  t1', 'us-east4',
+00033e10: 2027 7573 2d65 6173 7435 272c 2027 7573   'us-east5', 'us
+00033e20: 2d73 6f75 7468 3127 2c20 2775 732d 7765  -south1', 'us-we
+00033e30: 7374 3127 2c20 2775 732d 7765 7374 3227  st1', 'us-west2'
+00033e40: 2c0a 2020 2020 2020 2020 2775 732d 7765  ,.        'us-we
+00033e50: 7374 3327 2c20 2775 732d 7765 7374 3427  st3', 'us-west4'
+00033e60: 2c20 2773 6f75 7468 616d 6572 6963 612d  , 'southamerica-
+00033e70: 6561 7374 3127 2c20 2773 6f75 7468 616d  east1', 'southam
+00033e80: 6572 6963 612d 7765 7374 3127 2c0a 2020  erica-west1',.  
+00033e90: 2020 2020 2020 2765 7572 6f70 652d 6365        'europe-ce
+00033ea0: 6e74 7261 6c32 272c 2027 6575 726f 7065  ntral2', 'europe
+00033eb0: 2d6e 6f72 7468 3127 2c20 2765 7572 6f70  -north1', 'europ
+00033ec0: 652d 736f 7574 6877 6573 7431 272c 2027  e-southwest1', '
+00033ed0: 6575 726f 7065 2d77 6573 7431 272c 0a20  europe-west1',. 
+00033ee0: 2020 2020 2020 2027 6575 726f 7065 2d77         'europe-w
+00033ef0: 6573 7432 272c 2027 6575 726f 7065 2d77  est2', 'europe-w
+00033f00: 6573 7433 272c 2027 6575 726f 7065 2d77  est3', 'europe-w
+00033f10: 6573 7434 272c 2027 6575 726f 7065 2d77  est4', 'europe-w
+00033f20: 6573 7436 272c 0a20 2020 2020 2020 2027  est6',.        '
+00033f30: 6575 726f 7065 2d77 6573 7438 272c 2027  europe-west8', '
+00033f40: 6575 726f 7065 2d77 6573 7439 272c 2027  europe-west9', '
+00033f50: 6575 726f 7065 2d77 6573 7431 3027 2c20  europe-west10', 
+00033f60: 2765 7572 6f70 652d 7765 7374 3132 272c  'europe-west12',
+00033f70: 0a20 2020 2020 2020 2027 6173 6961 2d65  .        'asia-e
+00033f80: 6173 7431 272c 2027 6173 6961 2d65 6173  ast1', 'asia-eas
+00033f90: 7432 272c 2027 6173 6961 2d6e 6f72 7468  t2', 'asia-north
+00033fa0: 6561 7374 3127 2c20 2761 7369 612d 6e6f  east1', 'asia-no
+00033fb0: 7274 6865 6173 7432 272c 0a20 2020 2020  rtheast2',.     
+00033fc0: 2020 2027 6173 6961 2d6e 6f72 7468 6561     'asia-northea
+00033fd0: 7374 3327 2c20 2761 7369 612d 736f 7574  st3', 'asia-sout
+00033fe0: 6865 6173 7431 272c 2027 6173 6961 2d73  heast1', 'asia-s
+00033ff0: 6f75 7468 3127 2c20 2761 7369 612d 736f  outh1', 'asia-so
+00034000: 7574 6832 272c 0a20 2020 2020 2020 2027  uth2',.        '
+00034010: 6173 6961 2d73 6f75 7468 6561 7374 3227  asia-southeast2'
+00034020: 2c20 276d 652d 6365 6e74 7261 6c31 272c  , 'me-central1',
+00034030: 2027 6d65 2d63 656e 7472 616c 3227 2c20   'me-central2', 
+00034040: 276d 652d 7765 7374 3127 2c0a 2020 2020  'me-west1',.    
+00034050: 2020 2020 2761 7573 7472 616c 6961 2d73      'australia-s
+00034060: 6f75 7468 6561 7374 3127 2c20 2761 7573  outheast1', 'aus
+00034070: 7472 616c 6961 2d73 6f75 7468 6561 7374  tralia-southeast
+00034080: 3227 2c20 2761 6672 6963 612d 736f 7574  2', 'africa-sout
+00034090: 6831 270a 2020 2020 5d29 0a20 2020 2064  h1'.    ]).    d
+000340a0: 6566 2074 6573 745f 6763 735f 7265 6769  ef test_gcs_regi
+000340b0: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
+000340c0: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
+000340d0: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
+000340e0: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
+000340f0: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
+00034100: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
+00034110: 616c 6c20 4743 5320 7265 6769 6f6e 730a  all GCS regions.
+00034120: 2020 2020 2020 2020 2320 546f 2074 6573          # To tes
+00034130: 7420 6675 6c6c 2066 756e 6374 696f 6e61  t full functiona
+00034140: 6c69 7479 2c20 7573 6520 7465 7374 5f6d  lity, use test_m
+00034150: 616e 6167 6564 5f6a 6f62 735f 7374 6f72  anaged_jobs_stor
+00034160: 6167 6520 6162 6f76 652e 0a20 2020 2020  age above..     
+00034170: 2020 2073 746f 7265 5f74 7970 6520 3d20     store_type = 
+00034180: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00034190: 6554 7970 652e 4743 530a 2020 2020 2020  eType.GCS.      
+000341a0: 2020 746d 705f 6c6f 6361 6c5f 7374 6f72    tmp_local_stor
+000341b0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+000341c0: 6528 7374 6f72 655f 7479 7065 2c20 7265  e(store_type, re
+000341d0: 6769 6f6e 3d72 6567 696f 6e29 0a20 2020  gion=region).   
+000341e0: 2020 2020 2062 7563 6b65 745f 6e61 6d65       bucket_name
+000341f0: 203d 2074 6d70 5f6c 6f63 616c 5f73 746f   = tmp_local_sto
+00034200: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
+00034210: 2020 2020 2020 2023 2043 6f6e 6669 726d         # Confirm
+00034220: 2074 6861 7420 7468 6520 6275 636b 6574   that the bucket
+00034230: 2077 6173 2063 7265 6174 6564 2069 6e20   was created in 
+00034240: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+00034250: 6f6e 0a20 2020 2020 2020 2072 6567 696f  on.        regio
+00034260: 6e5f 636d 6420 3d20 7365 6c66 2e63 6c69  n_cmd = self.cli
+00034270: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
+00034280: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00034290: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+000342a0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+000342b0: 6563 6b5f 6f75 7470 7574 2872 6567 696f  eck_output(regio
+000342c0: 6e5f 636d 642c 2073 6865 6c6c 3d54 7275  n_cmd, shell=Tru
+000342d0: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
+000342e0: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
+000342f0: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
+00034300: 6173 7365 7274 2072 6567 696f 6e20 696e  assert region in
+00034310: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00034320: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
+00034330: 2020 2020 6627 4275 636b 6574 2077 6173      f'Bucket was
+00034340: 206e 6f74 2066 6f75 6e64 2069 6e20 7265   not found in re
+00034350: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d20  gion {region} - 
+00034360: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00034370: 6f75 7470 7574 206f 6620 7b72 6567 696f  output of {regio
+00034380: 6e5f 636d 647d 2077 6173 3a20 7b6f 7574  n_cmd} was: {out
+00034390: 7075 747d 2729 0a0a 2020 2020 2020 2020  put}')..        
+000343a0: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
+000343b0: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
+000343c0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+000343d0: 6b65 7420 7573 696e 6720 636c 690a 2020  ket using cli.  
+000343e0: 2020 2020 2020 6c73 5f63 6d64 203d 2073        ls_cmd = s
+000343f0: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
+00034400: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+00034410: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+00034420: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+00034430: 2e63 6865 636b 5f6f 7574 7075 7428 6c73  .check_output(ls
+00034440: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00034450: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00034460: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
+00034470: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00034480: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+00034490: 2069 6e20 6f75 7470 7574 2c20 280a 2020   in output, (.  
+000344a0: 2020 2020 2020 2020 2020 6627 746d 702d            f'tmp-
+000344b0: 6669 6c65 206e 6f74 2066 6f75 6e64 2069  file not found i
+000344c0: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
+000344d0: 7420 6f66 207b 6c73 5f63 6d64 7d20 7761  t of {ls_cmd} wa
+000344e0: 733a 207b 6f75 7470 7574 7d27 290a 0a0a  s: {output}')...
+000344f0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00034500: 7469 6e67 2059 414d 4c20 5370 6563 7320  ting YAML Specs 
+00034510: 2d2d 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572  ----------.# Our
+00034520: 2073 6b79 2073 746f 7261 6765 2072 6571   sky storage req
+00034530: 7569 7265 7320 6372 6564 656e 7469 616c  uires credential
+00034540: 7320 746f 2063 6865 636b 2074 6865 2062  s to check the b
+00034550: 7563 6b65 7420 6578 6973 7461 6e63 6520  ucket existance 
+00034560: 7768 656e 0a23 206c 6f61 6469 6e67 2061  when.# loading a
+00034570: 2074 6173 6b20 6672 6f6d 2074 6865 2079   task from the y
+00034580: 616d 6c20 6669 6c65 2c20 736f 2077 6520  aml file, so we 
+00034590: 6361 6e6e 6f74 206d 616b 6520 6974 2061  cannot make it a
+000345a0: 2075 6e69 7420 7465 7374 2e0a 636c 6173   unit test..clas
+000345b0: 7320 5465 7374 5961 6d6c 5370 6563 733a  s TestYamlSpecs:
+000345c0: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
+000345d0: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
+000345e0: 6074 6f5f 7961 6d6c 5f63 6f6e 6669 6760  `to_yaml_config`
+000345f0: 2066 6f72 2074 6865 2053 746f 7261 6765   for the Storage
+00034600: 206f 626a 6563 742e 0a20 2020 2023 2020   object..    #  
+00034610: 5765 2073 686f 756c 6420 6e6f 7420 7573  We should not us
+00034620: 6520 6065 7861 6d70 6c65 732f 7374 6f72  e `examples/stor
+00034630: 6167 655f 6465 6d6f 2e79 616d 6c60 2068  age_demo.yaml` h
+00034640: 6572 652c 2073 696e 6365 2069 7420 7265  ere, since it re
+00034650: 7175 6972 6573 0a20 2020 2023 2020 7573  quires.    #  us
+00034660: 6572 7320 746f 2065 6e73 7572 6520 6275  ers to ensure bu
+00034670: 636b 6574 206e 616d 6573 2074 6f20 6e6f  cket names to no
+00034680: 7420 6578 6973 7420 616e 642f 6f72 2062  t exist and/or b
+00034690: 6520 756e 6971 7565 2e0a 2020 2020 5f54  e unique..    _T
+000346a0: 4553 545f 5941 4d4c 5f50 4154 4853 203d  EST_YAML_PATHS =
+000346b0: 205b 0a20 2020 2020 2020 2027 6578 616d   [.        'exam
+000346c0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000346d0: 6c27 2c20 2765 7861 6d70 6c65 732f 6d61  l', 'examples/ma
+000346e0: 6e61 6765 645f 6a6f 622e 7961 6d6c 272c  naged_job.yaml',
+000346f0: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+00034700: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
+00034710: 756e 7473 2e79 616d 6c27 2c20 2765 7861  unts.yaml', 'exa
+00034720: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+00034730: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00034740: 2765 7861 6d70 6c65 732f 6d75 6c74 695f  'examples/multi_
+00034750: 686f 7374 6e61 6d65 2e79 616d 6c27 0a20  hostname.yaml'. 
+00034760: 2020 205d 0a0a 2020 2020 6465 6620 5f69     ]..    def _i
+00034770: 735f 6469 6374 5f73 7562 7365 7428 7365  s_dict_subset(se
+00034780: 6c66 2c20 6431 2c20 6432 293a 0a20 2020  lf, d1, d2):.   
+00034790: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+000347a0: 2064 3120 6973 2074 6865 2073 7562 7365   d1 is the subse
+000347b0: 7420 6f66 2064 322e 2222 220a 2020 2020  t of d2.""".    
+000347c0: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+000347d0: 6431 2e69 7465 6d73 2829 3a0a 2020 2020  d1.items():.    
+000347e0: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+000347f0: 2069 6e20 6432 3a0a 2020 2020 2020 2020   in d2:.        
+00034800: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00034810: 7461 6e63 6528 762c 206c 6973 7429 206f  tance(v, list) o
+00034820: 7220 6973 696e 7374 616e 6365 2876 2c20  r isinstance(v, 
+00034830: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+00034840: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00034850: 7420 6c65 6e28 7629 203d 3d20 302c 2028  t len(v) == 0, (
+00034860: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
+00034870: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00034880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034890: 6173 7365 7274 2046 616c 7365 2c20 286b  assert False, (k
+000348a0: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
+000348b0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000348c0: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
 000348d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000348e0: 7420 7265 736f 7572 6365 732e 6163 6365  t resources.acce
-000348f0: 6c65 7261 746f 7273 203d 3d20 6432 5b6b  lerators == d2[k
-00034900: 5d2c 2028 6b2c 2076 2c20 6432 290a 2020  ], (k, v, d2).  
-00034910: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00034920: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00034930: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-00034940: 2e6c 6f77 6572 2829 203d 3d20 6432 5b6b  .lower() == d2[k
-00034950: 5d2e 6c6f 7765 7228 292c 2028 6b2c 2076  ].lower(), (k, v
-00034960: 2c20 6432 5b6b 5d29 0a20 2020 2020 2020  , d2[k]).       
-00034970: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00034980: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00034990: 7420 7620 3d3d 2064 325b 6b5d 2c20 286b  t v == d2[k], (k
-000349a0: 2c20 762c 2064 325b 6b5d 290a 0a20 2020  , v, d2[k])..   
-000349b0: 2064 6566 205f 6368 6563 6b5f 6571 7569   def _check_equi
-000349c0: 7661 6c65 6e74 2873 656c 662c 2079 616d  valent(self, yam
-000349d0: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
-000349e0: 2022 2222 4368 6563 6b20 6966 2074 6865   """Check if the
-000349f0: 2079 616d 6c20 6973 2065 7175 6976 616c   yaml is equival
-00034a00: 656e 7420 6166 7465 7220 6c6f 6164 2061  ent after load a
-00034a10: 6e64 2064 756d 7020 6167 6169 6e2e 2222  nd dump again.""
-00034a20: 220a 2020 2020 2020 2020 6f72 6967 696e  ".        origin
-00034a30: 5f74 6173 6b5f 636f 6e66 6967 203d 2063  _task_config = c
-00034a40: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
-00034a50: 5f79 616d 6c28 7961 6d6c 5f70 6174 6829  _yaml(yaml_path)
-00034a60: 0a0a 2020 2020 2020 2020 7461 736b 203d  ..        task =
-00034a70: 2073 6b79 2e54 6173 6b2e 6672 6f6d 5f79   sky.Task.from_y
-00034a80: 616d 6c28 7961 6d6c 5f70 6174 6829 0a20  aml(yaml_path). 
-00034a90: 2020 2020 2020 206e 6577 5f74 6173 6b5f         new_task_
-00034aa0: 636f 6e66 6967 203d 2074 6173 6b2e 746f  config = task.to
-00034ab0: 5f79 616d 6c5f 636f 6e66 6967 2829 0a20  _yaml_config(). 
-00034ac0: 2020 2020 2020 2023 2064 3120 3c3d 2064         # d1 <= d
-00034ad0: 320a 2020 2020 2020 2020 7072 696e 7428  2.        print(
-00034ae0: 6f72 6967 696e 5f74 6173 6b5f 636f 6e66  origin_task_conf
-00034af0: 6967 2c20 6e65 775f 7461 736b 5f63 6f6e  ig, new_task_con
-00034b00: 6669 6729 0a20 2020 2020 2020 2073 656c  fig).        sel
-00034b10: 662e 5f69 735f 6469 6374 5f73 7562 7365  f._is_dict_subse
-00034b20: 7428 6f72 6967 696e 5f74 6173 6b5f 636f  t(origin_task_co
-00034b30: 6e66 6967 2c20 6e65 775f 7461 736b 5f63  nfig, new_task_c
-00034b40: 6f6e 6669 6729 0a0a 2020 2020 6465 6620  onfig)..    def 
-00034b50: 7465 7374 5f6c 6f61 645f 6475 6d70 5f79  test_load_dump_y
-00034b60: 616d 6c5f 636f 6e66 6967 5f65 7175 6976  aml_config_equiv
-00034b70: 616c 656e 7428 7365 6c66 293a 0a20 2020  alent(self):.   
-00034b80: 2020 2020 2022 2222 5465 7374 2069 6620       """Test if 
-00034b90: 7468 6520 7961 6d6c 2063 6f6e 6669 6720  the yaml config 
-00034ba0: 6973 2065 7175 6976 616c 656e 7420 6166  is equivalent af
-00034bb0: 7465 7220 6c6f 6164 2061 6e64 2064 756d  ter load and dum
-00034bc0: 7020 6167 6169 6e2e 2222 220a 2020 2020  p again.""".    
-00034bd0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00034be0: 2827 7e2f 6461 7461 7365 7473 2729 2e65  ('~/datasets').e
-00034bf0: 7870 616e 6475 7365 7228 292e 6d6b 6469  xpanduser().mkdi
-00034c00: 7228 6578 6973 745f 6f6b 3d54 7275 6529  r(exist_ok=True)
-00034c10: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
-00034c20: 2e50 6174 6828 277e 2f74 6d70 6669 6c65  .Path('~/tmpfile
-00034c30: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00034c40: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
-00034c50: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
-00034c60: 2e73 7368 2729 2e65 7870 616e 6475 7365  .ssh').expanduse
-00034c70: 7228 292e 6d6b 6469 7228 6578 6973 745f  r().mkdir(exist_
-00034c80: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
-00034c90: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
-00034ca0: 2f2e 7373 682f 6964 5f72 7361 2e70 7562  /.ssh/id_rsa.pub
-00034cb0: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
-00034cc0: 746f 7563 6828 290a 2020 2020 2020 2020  touch().        
-00034cd0: 7061 7468 6c69 622e 5061 7468 2827 7e2f  pathlib.Path('~/
-00034ce0: 746d 702d 776f 726b 6469 7227 292e 6578  tmp-workdir').ex
-00034cf0: 7061 6e64 7573 6572 2829 2e6d 6b64 6972  panduser().mkdir
-00034d00: 2865 7869 7374 5f6f 6b3d 5472 7565 290a  (exist_ok=True).
-00034d10: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
-00034d20: 5061 7468 2827 7e2f 446f 776e 6c6f 6164  Path('~/Download
-00034d30: 732f 7470 7527 292e 6578 7061 6e64 7573  s/tpu').expandus
-00034d40: 6572 2829 2e6d 6b64 6972 2870 6172 656e  er().mkdir(paren
-00034d50: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
-00034d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d90: 2020 2020 6578 6973 745f 6f6b 3d54 7275      exist_ok=Tru
-00034da0: 6529 0a20 2020 2020 2020 2066 6f72 2079  e).        for y
-00034db0: 616d 6c5f 7061 7468 2069 6e20 7365 6c66  aml_path in self
-00034dc0: 2e5f 5445 5354 5f59 414d 4c5f 5041 5448  ._TEST_YAML_PATH
-00034dd0: 533a 0a20 2020 2020 2020 2020 2020 2073  S:.            s
-00034de0: 656c 662e 5f63 6865 636b 5f65 7175 6976  elf._check_equiv
-00034df0: 616c 656e 7428 7961 6d6c 5f70 6174 6829  alent(yaml_path)
-00034e00: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00034e10: 5465 7374 696e 6720 4d75 6c74 6970 6c65  Testing Multiple
-00034e20: 2041 6363 656c 6572 6174 6f72 7320 2d2d   Accelerators --
-00034e30: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00034e40: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-00034e50: 6163 6b20 2023 2046 6c75 6964 7374 6163  ack  # Fluidstac
-00034e60: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
-00034e70: 7274 204b 3830 2067 7075 7320 666f 7220  rt K80 gpus for 
-00034e80: 6e6f 770a 4070 7974 6573 742e 6d61 726b  now.@pytest.mark
-00034e90: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-00034ea0: 2320 5061 7065 7273 7061 6365 2064 6f65  # Paperspace doe
-00034eb0: 7320 6e6f 7420 7375 7070 6f72 7420 4b38  s not support K8
-00034ec0: 3020 6770 7573 0a64 6566 2074 6573 745f  0 gpus.def test_
-00034ed0: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
-00034ee0: 6174 6f72 735f 6f72 6465 7265 6428 293a  ators_ordered():
-00034ef0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00034f00: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00034f10: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00034f20: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
-00034f30: 6c65 2d61 6363 656c 6572 6174 6f72 732d  le-accelerators-
-00034f40: 6f72 6465 7265 6427 2c0a 2020 2020 2020  ordered',.      
-00034f50: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00034f60: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00034f70: 2d63 207b 6e61 6d65 7d20 7465 7374 732f  -c {name} tests/
-00034f80: 7465 7374 5f79 616d 6c73 2f74 6573 745f  test_yamls/test_
-00034f90: 6d75 6c74 6970 6c65 5f61 6363 656c 6572  multiple_acceler
-00034fa0: 6174 6f72 735f 6f72 6465 7265 642e 7961  ators_ordered.ya
-00034fb0: 6d6c 207c 2067 7265 7020 2255 7369 6e67  ml | grep "Using
-00034fc0: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
-00034fd0: 6163 6365 6c65 7261 746f 7273 206c 6973  accelerators lis
-00034fe0: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
-00034ff0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00035000: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00035010: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00035020: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00035030: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00035040: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00035050: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00035060: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00035070: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00035080: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00035090: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-000350a0: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
-000350b0: 6964 7374 6163 6b20 6861 7320 6c6f 7720  idstack has low 
-000350c0: 6176 6169 6c61 6269 6c69 7479 2066 6f72  availability for
-000350d0: 2054 3420 4750 5573 0a40 7079 7465 7374   T4 GPUs.@pytest
-000350e0: 2e6d 6172 6b2e 6e6f 5f70 6170 6572 7370  .mark.no_papersp
-000350f0: 6163 6520 2023 2050 6170 6572 7370 6163  ace  # Paperspac
-00035100: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
-00035110: 7274 2054 3420 4750 5573 0a64 6566 2074  rt T4 GPUs.def t
-00035120: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
-00035130: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
-00035140: 645f 7769 7468 5f64 6566 6175 6c74 2829  d_with_default()
-00035150: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00035160: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00035170: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00035180: 280a 2020 2020 2020 2020 276d 756c 7469  (.        'multi
-00035190: 706c 652d 6163 6365 6c65 7261 746f 7273  ple-accelerators
-000351a0: 2d6f 7264 6572 6564 272c 0a20 2020 2020  -ordered',.     
-000351b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000351c0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000351d0: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
-000351e0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-000351f0: 5f6d 756c 7469 706c 655f 6163 6365 6c65  _multiple_accele
-00035200: 7261 746f 7273 5f6f 7264 6572 6564 5f77  rators_ordered_w
-00035210: 6974 685f 6465 6661 756c 742e 7961 6d6c  ith_default.yaml
-00035220: 207c 2067 7265 7020 2255 7369 6e67 2075   | grep "Using u
-00035230: 7365 722d 7370 6563 6966 6965 6420 6163  ser-specified ac
-00035240: 6365 6c65 7261 746f 7273 206c 6973 7422  celerators list"
-00035250: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00035260: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00035270: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00035280: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00035290: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-000352a0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000352b0: 7475 7320 7b6e 616d 657d 207c 2067 7265  tus {name} | gre
-000352c0: 7020 5370 6f74 272c 0a20 2020 2020 2020  p Spot',.       
-000352d0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000352e0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000352f0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00035300: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00035310: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-00035320: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00035330: 466c 7569 6473 7461 636b 2068 6173 206c  Fluidstack has l
-00035340: 6f77 2061 7661 696c 6162 696c 6974 7920  ow availability 
-00035350: 666f 7220 5434 2047 5055 730a 4070 7974  for T4 GPUs.@pyt
-00035360: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
-00035370: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
-00035380: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
-00035390: 7070 6f72 7420 5434 2047 5055 730a 6465  pport T4 GPUs.de
-000353a0: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
-000353b0: 6163 6365 6c65 7261 746f 7273 5f75 6e6f  accelerators_uno
-000353c0: 7264 6572 6564 2829 3a0a 2020 2020 6e61  rdered():.    na
-000353d0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000353e0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000353f0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00035400: 2020 276d 756c 7469 706c 652d 6163 6365    'multiple-acce
-00035410: 6c65 7261 746f 7273 2d75 6e6f 7264 6572  lerators-unorder
-00035420: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
-00035430: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00035440: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00035450: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00035460: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
-00035470: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-00035480: 5f75 6e6f 7264 6572 6564 2e79 616d 6c27  _unordered.yaml'
-00035490: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000354a0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000354b0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-000354c0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-000354d0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-000354e0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000354f0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00035500: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00035510: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00035520: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00035530: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-00035540: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
-00035550: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
-00035560: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
-00035570: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
-00035580: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
-00035590: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
-000355a0: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
-000355b0: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
-000355c0: 5f61 6363 656c 6572 6174 6f72 735f 756e  _accelerators_un
-000355d0: 6f72 6465 7265 645f 7769 7468 5f64 6566  ordered_with_def
-000355e0: 6175 6c74 2829 3a0a 2020 2020 6e61 6d65  ault():.    name
-000355f0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00035600: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00035610: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00035620: 276d 756c 7469 706c 652d 6163 6365 6c65  'multiple-accele
-00035630: 7261 746f 7273 2d75 6e6f 7264 6572 6564  rators-unordered
-00035640: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00035650: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00035660: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00035670: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-00035680: 6d6c 732f 7465 7374 5f6d 756c 7469 706c  mls/test_multipl
-00035690: 655f 6163 6365 6c65 7261 746f 7273 5f75  e_accelerators_u
-000356a0: 6e6f 7264 6572 6564 5f77 6974 685f 6465  nordered_with_de
-000356b0: 6661 756c 742e 7961 6d6c 272c 0a20 2020  fault.yaml',.   
-000356c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000356d0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000356e0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-000356f0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00035700: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00035710: 2066 2773 6b79 2073 7461 7475 7320 7b6e   f'sky status {n
-00035720: 616d 657d 207c 2067 7265 7020 5370 6f74  ame} | grep Spot
-00035730: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00035740: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00035750: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00035760: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00035770: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00035780: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00035790: 6473 7461 636b 2020 2320 5265 7175 6972  dstack  # Requir
-000357a0: 6573 206f 7468 6572 2063 6c6f 7564 7320  es other clouds 
-000357b0: 746f 2062 6520 656e 6162 6c65 640a 6465  to be enabled.de
-000357c0: 6620 7465 7374 5f6d 756c 7469 706c 655f  f test_multiple_
-000357d0: 7265 736f 7572 6365 7328 293a 0a20 2020  resources():.   
-000357e0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000357f0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00035800: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00035810: 2020 2020 2027 6d75 6c74 6970 6c65 2d72       'multiple-r
-00035820: 6573 6f75 7263 6573 272c 0a20 2020 2020  esources',.     
-00035830: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00035840: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00035850: 202d 6320 7b6e 616d 657d 2074 6573 7473   -c {name} tests
-00035860: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-00035870: 5f6d 756c 7469 706c 655f 7265 736f 7572  _multiple_resour
-00035880: 6365 732e 7961 6d6c 272c 0a20 2020 2020  ces.yaml',.     
-00035890: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000358a0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-000358b0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000358c0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000358d0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-000358e0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000358f0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00035900: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00035910: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00035920: 2d2d 2d2d 2d2d 2d2d 2053 6b79 2042 656e  -------- Sky Ben
-00035930: 6368 6d61 726b 202d 2d2d 2d2d 2d2d 2d2d  chmark ---------
-00035940: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-00035950: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00035960: 5265 7175 6972 6573 206f 7468 6572 2063  Requires other c
-00035970: 6c6f 7564 7320 746f 2062 6520 656e 6162  louds to be enab
-00035980: 6c65 640a 4070 7974 6573 742e 6d61 726b  led.@pytest.mark
-00035990: 2e6e 6f5f 7061 7065 7273 7061 6365 2020  .no_paperspace  
-000359a0: 2320 5265 7175 6972 6573 206f 7468 6572  # Requires other
-000359b0: 2063 6c6f 7564 7320 746f 2062 6520 656e   clouds to be en
-000359c0: 6162 6c65 640a 4070 7974 6573 742e 6d61  abled.@pytest.ma
-000359d0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
-000359e0: 0a64 6566 2074 6573 745f 736b 795f 6265  .def test_sky_be
-000359f0: 6e63 6828 6765 6e65 7269 635f 636c 6f75  nch(generic_clou
-00035a00: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00035a10: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00035a20: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00035a30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00035a40: 2027 736b 792d 6265 6e63 6827 2c0a 2020   'sky-bench',.  
-00035a50: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00035a60: 2020 2020 6627 736b 7920 6265 6e63 6820      f'sky bench 
-00035a70: 6c61 756e 6368 202d 7920 2d62 207b 6e61  launch -y -b {na
-00035a80: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00035a90: 6572 6963 5f63 6c6f 7564 7d20 2d69 3020  eric_cloud} -i0 
-00035aa0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00035ab0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00035ac0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00035ad0: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-00035ae0: 2020 2020 2066 2773 6b79 2062 656e 6368       f'sky bench
-00035af0: 2073 686f 7720 7b6e 616d 657d 207c 2067   show {name} | g
-00035b00: 7265 7020 736b 792d 6265 6e63 682d 7b6e  rep sky-bench-{n
-00035b10: 616d 657d 207c 2067 7265 7020 4649 4e49  ame} | grep FINI
-00035b20: 5348 4544 272c 0a20 2020 2020 2020 205d  SHED',.        ]
-00035b30: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00035b40: 6265 6e63 6820 646f 776e 207b 6e61 6d65  bench down {name
-00035b50: 7d20 2d79 3b20 736b 7920 6265 6e63 6820  } -y; sky bench 
-00035b60: 6465 6c65 7465 207b 6e61 6d65 7d20 2d79  delete {name} -y
-00035b70: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-00035b80: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000348e0: 7420 6973 696e 7374 616e 6365 2864 325b  t isinstance(d2[
+000348f0: 6b5d 2c20 6469 6374 292c 2028 6b2c 2076  k], dict), (k, v
+00034900: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
+00034910: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
+00034920: 6963 745f 7375 6273 6574 2876 2c20 6432  ict_subset(v, d2
+00034930: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
+00034940: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00034950: 2876 2c20 7374 7229 3a0a 2020 2020 2020  (v, str):.      
+00034960: 2020 2020 2020 2020 2020 6966 206b 203d            if k =
+00034970: 3d20 2761 6363 656c 6572 6174 6f72 7327  = 'accelerators'
+00034980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034990: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
+000349a0: 3d20 736b 792e 5265 736f 7572 6365 7328  = sky.Resources(
+000349b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000349c0: 2020 2020 2020 7265 736f 7572 6365 732e        resources.
+000349d0: 5f73 6574 5f61 6363 656c 6572 6174 6f72  _set_accelerator
+000349e0: 7328 762c 204e 6f6e 6529 0a20 2020 2020  s(v, None).     
+000349f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00034a00: 7373 6572 7420 7265 736f 7572 6365 732e  ssert resources.
+00034a10: 6163 6365 6c65 7261 746f 7273 203d 3d20  accelerators == 
+00034a20: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
+00034a30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00034a40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00034a50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00034a60: 7274 2076 2e6c 6f77 6572 2829 203d 3d20  rt v.lower() == 
+00034a70: 6432 5b6b 5d2e 6c6f 7765 7228 292c 2028  d2[k].lower(), (
+00034a80: 6b2c 2076 2c20 6432 5b6b 5d29 0a20 2020  k, v, d2[k]).   
+00034a90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00034aa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00034ab0: 7373 6572 7420 7620 3d3d 2064 325b 6b5d  ssert v == d2[k]
+00034ac0: 2c20 286b 2c20 762c 2064 325b 6b5d 290a  , (k, v, d2[k]).
+00034ad0: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
+00034ae0: 6571 7569 7661 6c65 6e74 2873 656c 662c  equivalent(self,
+00034af0: 2079 616d 6c5f 7061 7468 293a 0a20 2020   yaml_path):.   
+00034b00: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+00034b10: 2074 6865 2079 616d 6c20 6973 2065 7175   the yaml is equ
+00034b20: 6976 616c 656e 7420 6166 7465 7220 6c6f  ivalent after lo
+00034b30: 6164 2061 6e64 2064 756d 7020 6167 6169  ad and dump agai
+00034b40: 6e2e 2222 220a 2020 2020 2020 2020 6f72  n.""".        or
+00034b50: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
+00034b60: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+00034b70: 7265 6164 5f79 616d 6c28 7961 6d6c 5f70  read_yaml(yaml_p
+00034b80: 6174 6829 0a0a 2020 2020 2020 2020 7461  ath)..        ta
+00034b90: 736b 203d 2073 6b79 2e54 6173 6b2e 6672  sk = sky.Task.fr
+00034ba0: 6f6d 5f79 616d 6c28 7961 6d6c 5f70 6174  om_yaml(yaml_pat
+00034bb0: 6829 0a20 2020 2020 2020 206e 6577 5f74  h).        new_t
+00034bc0: 6173 6b5f 636f 6e66 6967 203d 2074 6173  ask_config = tas
+00034bd0: 6b2e 746f 5f79 616d 6c5f 636f 6e66 6967  k.to_yaml_config
+00034be0: 2829 0a20 2020 2020 2020 2023 2064 3120  ().        # d1 
+00034bf0: 3c3d 2064 320a 2020 2020 2020 2020 7072  <= d2.        pr
+00034c00: 696e 7428 6f72 6967 696e 5f74 6173 6b5f  int(origin_task_
+00034c10: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
+00034c20: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+00034c30: 2073 656c 662e 5f69 735f 6469 6374 5f73   self._is_dict_s
+00034c40: 7562 7365 7428 6f72 6967 696e 5f74 6173  ubset(origin_tas
+00034c50: 6b5f 636f 6e66 6967 2c20 6e65 775f 7461  k_config, new_ta
+00034c60: 736b 5f63 6f6e 6669 6729 0a0a 2020 2020  sk_config)..    
+00034c70: 6465 6620 7465 7374 5f6c 6f61 645f 6475  def test_load_du
+00034c80: 6d70 5f79 616d 6c5f 636f 6e66 6967 5f65  mp_yaml_config_e
+00034c90: 7175 6976 616c 656e 7428 7365 6c66 293a  quivalent(self):
+00034ca0: 0a20 2020 2020 2020 2022 2222 5465 7374  .        """Test
+00034cb0: 2069 6620 7468 6520 7961 6d6c 2063 6f6e   if the yaml con
+00034cc0: 6669 6720 6973 2065 7175 6976 616c 656e  fig is equivalen
+00034cd0: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
+00034ce0: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
+00034cf0: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00034d00: 5061 7468 2827 7e2f 6461 7461 7365 7473  Path('~/datasets
+00034d10: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+00034d20: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
+00034d30: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
+00034d40: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+00034d50: 6669 6c65 2729 2e65 7870 616e 6475 7365  file').expanduse
+00034d60: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00034d70: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00034d80: 2827 7e2f 2e73 7368 2729 2e65 7870 616e  ('~/.ssh').expan
+00034d90: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+00034da0: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00034db0: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+00034dc0: 6828 277e 2f2e 7373 682f 6964 5f72 7361  h('~/.ssh/id_rsa
+00034dd0: 2e70 7562 2729 2e65 7870 616e 6475 7365  .pub').expanduse
+00034de0: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00034df0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00034e00: 2827 7e2f 746d 702d 776f 726b 6469 7227  ('~/tmp-workdir'
+00034e10: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+00034e20: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+00034e30: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
+00034e40: 6c69 622e 5061 7468 2827 7e2f 446f 776e  lib.Path('~/Down
+00034e50: 6c6f 6164 732f 7470 7527 292e 6578 7061  loads/tpu').expa
+00034e60: 6e64 7573 6572 2829 2e6d 6b64 6972 2870  nduser().mkdir(p
+00034e70: 6172 656e 7473 3d54 7275 652c 0a20 2020  arents=True,.   
+00034e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034eb0: 2020 2020 2020 2020 6578 6973 745f 6f6b          exist_ok
+00034ec0: 3d54 7275 6529 0a20 2020 2020 2020 2066  =True).        f
+00034ed0: 6f72 2079 616d 6c5f 7061 7468 2069 6e20  or yaml_path in 
+00034ee0: 7365 6c66 2e5f 5445 5354 5f59 414d 4c5f  self._TEST_YAML_
+00034ef0: 5041 5448 533a 0a20 2020 2020 2020 2020  PATHS:.         
+00034f00: 2020 2073 656c 662e 5f63 6865 636b 5f65     self._check_e
+00034f10: 7175 6976 616c 656e 7428 7961 6d6c 5f70  quivalent(yaml_p
+00034f20: 6174 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d  ath)...# -------
+00034f30: 2d2d 2d20 5465 7374 696e 6720 4d75 6c74  --- Testing Mult
+00034f40: 6970 6c65 2041 6363 656c 6572 6174 6f72  iple Accelerator
+00034f50: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
+00034f60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00034f70: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+00034f80: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+00034f90: 7570 706f 7274 204b 3830 2067 7075 7320  upport K80 gpus 
+00034fa0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+00034fb0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00034fc0: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
+00034fd0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00034fe0: 7420 4b38 3020 6770 7573 0a64 6566 2074  t K80 gpus.def t
+00034ff0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00035000: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00035010: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
+00035020: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00035030: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00035040: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00035050: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00035060: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
+00035070: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00035080: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00035090: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+000350a0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+000350b0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+000350c0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+000350d0: 642e 7961 6d6c 207c 2067 7265 7020 2255  d.yaml | grep "U
+000350e0: 7369 6e67 2075 7365 722d 7370 6563 6966  sing user-specif
+000350f0: 6965 6420 6163 6365 6c65 7261 746f 7273  ied accelerators
+00035100: 206c 6973 7422 272c 0a20 2020 2020 2020   list"',.       
+00035110: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00035120: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00035130: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00035140: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00035150: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00035160: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00035170: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00035180: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00035190: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+000351a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000351b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000351c0: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+000351d0: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
+000351e0: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+000351f0: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
+00035200: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00035210: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00035220: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00035230: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
+00035240: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00035250: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00035260: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
+00035270: 6c74 2829 3a0a 2020 2020 6e61 6d65 203d  lt():.    name =
+00035280: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00035290: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+000352a0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+000352b0: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
+000352c0: 746f 7273 2d6f 7264 6572 6564 272c 0a20  tors-ordered',. 
+000352d0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000352e0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000352f0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00035300: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00035310: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
+00035320: 6365 6c65 7261 746f 7273 5f6f 7264 6572  celerators_order
+00035330: 6564 5f77 6974 685f 6465 6661 756c 742e  ed_with_default.
+00035340: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
+00035350: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
+00035360: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
+00035370: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
+00035380: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00035390: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+000353a0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000353b0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000353c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000353d0: 2073 7461 7475 7320 7b6e 616d 657d 207c   status {name} |
+000353e0: 2067 7265 7020 5370 6f74 272c 0a20 2020   grep Spot',.   
+000353f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00035400: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00035410: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00035420: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00035430: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00035440: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00035450: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
+00035460: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+00035470: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
+00035480: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00035490: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+000354a0: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+000354b0: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
+000354c0: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
+000354d0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+000354e0: 5f75 6e6f 7264 6572 6564 2829 3a0a 2020  _unordered():.  
+000354f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00035500: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00035510: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00035520: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
+00035530: 6163 6365 6c65 7261 746f 7273 2d75 6e6f  accelerators-uno
+00035540: 7264 6572 6564 272c 0a20 2020 2020 2020  rdered',.       
+00035550: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00035560: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00035570: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00035580: 6573 745f 7961 6d6c 732f 7465 7374 5f6d  est_yamls/test_m
+00035590: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
+000355a0: 746f 7273 5f75 6e6f 7264 6572 6564 2e79  tors_unordered.y
+000355b0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000355c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000355d0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000355e0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+000355f0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00035600: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00035610: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00035620: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00035630: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00035640: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00035650: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00035660: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+00035670: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
+00035680: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
+00035690: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000356a0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+000356b0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+000356c0: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
+000356d0: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
+000356e0: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+000356f0: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
+00035700: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
+00035710: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00035720: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00035730: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00035740: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
+00035750: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
+00035760: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
+00035770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00035780: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00035790: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+000357a0: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
+000357b0: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+000357c0: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
+000357d0: 685f 6465 6661 756c 742e 7961 6d6c 272c  h_default.yaml',
+000357e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000357f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00035800: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00035810: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00035820: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00035830: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00035840: 7320 7b6e 616d 657d 207c 2067 7265 7020  s {name} | grep 
+00035850: 5370 6f74 272c 0a20 2020 2020 2020 205d  Spot',.        ]
+00035860: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00035870: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00035880: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00035890: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000358a0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000358b0: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+000358c0: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
+000358d0: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
+000358e0: 640a 6465 6620 7465 7374 5f6d 756c 7469  d.def test_multi
+000358f0: 706c 655f 7265 736f 7572 6365 7328 293a  ple_resources():
+00035900: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00035910: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00035920: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00035930: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
+00035940: 6c65 2d72 6573 6f75 7263 6573 272c 0a20  le-resources',. 
+00035950: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00035960: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00035970: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00035980: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00035990: 7465 7374 5f6d 756c 7469 706c 655f 7265  test_multiple_re
+000359a0: 736f 7572 6365 732e 7961 6d6c 272c 0a20  sources.yaml',. 
+000359b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000359c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000359d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000359e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000359f0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00035a00: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00035a10: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00035a20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00035a30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00035a40: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79  # ---------- Sky
+00035a50: 2042 656e 6368 6d61 726b 202d 2d2d 2d2d   Benchmark -----
+00035a60: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00035a70: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00035a80: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
+00035a90: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
+00035aa0: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
+00035ab0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00035ac0: 6365 2020 2320 5265 7175 6972 6573 206f  ce  # Requires o
+00035ad0: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
+00035ae0: 6520 656e 6162 6c65 640a 4070 7974 6573  e enabled.@pytes
+00035af0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00035b00: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00035b10: 795f 6265 6e63 6828 6765 6e65 7269 635f  y_bench(generic_
+00035b20: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00035b30: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00035b40: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00035b50: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00035b60: 2020 2020 2027 736b 792d 6265 6e63 6827       'sky-bench'
+00035b70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00035b80: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
+00035b90: 6e63 6820 6c61 756e 6368 202d 7920 2d62  nch launch -y -b
+00035ba0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00035bb0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00035bc0: 2d69 3020 7465 7374 732f 7465 7374 5f79  -i0 tests/test_y
+00035bd0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00035be0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00035bf0: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+00035c00: 2020 2020 2020 2020 2066 2773 6b79 2062           f'sky b
+00035c10: 656e 6368 2073 686f 7720 7b6e 616d 657d  ench show {name}
+00035c20: 207c 2067 7265 7020 736b 792d 6265 6e63   | grep sky-benc
+00035c30: 682d 7b6e 616d 657d 207c 2067 7265 7020  h-{name} | grep 
+00035c40: 4649 4e49 5348 4544 272c 0a20 2020 2020  FINISHED',.     
+00035c50: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00035c60: 736b 7920 6265 6e63 6820 646f 776e 207b  sky bench down {
+00035c70: 6e61 6d65 7d20 2d79 3b20 736b 7920 6265  name} -y; sky be
+00035c80: 6e63 6820 6465 6c65 7465 207b 6e61 6d65  nch delete {name
+00035c90: 7d20 2d79 272c 0a20 2020 2029 0a20 2020  } -y',.    ).   
+00035ca0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00035cb0: 7374 290a                                st).
```

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_storage.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_wheels.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot_nightly-1.0.0.dev20240527/tests/test_yaml_parser.py` & `skypilot_nightly-1.0.0.dev20240529/tests/test_yaml_parser.py`

 * *Files identical despite different names*

